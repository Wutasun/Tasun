<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>工程資料明細表 · Tasun</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#070809;
      --bg1:#0b0d10;
      --gold:#f6d37a;
      --gold2:rgba(246,211,122,.55);
      --border:rgba(246,211,122,.28);
      --border2:rgba(246,211,122,.40);
      --text:#ececec;
      --muted:rgba(236,236,236,.70);
      --shadow:0 18px 50px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family:"Noto Serif TC", serif;
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(246,211,122,.10), transparent 60%),
        radial-gradient(900px 520px at 85% 25%, rgba(246,211,122,.08), transparent 62%),
        radial-gradient(1100px 700px at 55% 85%, rgba(246,211,122,.06), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{max-width:1200px;margin:0 auto;padding:20px 16px 34px}

    /* ✅ 不用 fixed / sticky，避免遮擋 */
    .topbar{
      position:relative;
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:12px;
      align-items:center;
      padding:14px;
      border:1px solid var(--border);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
    }
    @media (max-width:920px){
      .topbar{grid-template-columns:1fr}
      .nav-left{order:0}
      .brand{order:1}
      .right{order:2; justify-content:flex-start}
    }

    .nav-left{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:flex-start;
    }
    .nav-desktop{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .nav-mobile{display:none; gap:10px; align-items:center; width:100%;}
    @media (max-width:600px){
      .nav-desktop{display:none}
      .nav-mobile{display:flex}
    }

    .brand{
      display:flex; flex-direction:column; gap:4px;
      align-items:center; justify-content:center;
      text-align:center;
    }
    .title{
      font-weight:800; letter-spacing:.08em;
      font-size:20px; color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.22);
    }
    .sub{display:none;}

    .right{
      display:flex; gap:10px; align-items:center;
      flex-wrap:wrap; justify-content:flex-end;
    }
    @media (max-width:920px){ .right{justify-content:flex-start;} }

    .pill{
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.05);
      font-size:13px; color:rgba(236,236,236,.85);
      display:flex; gap:8px; align-items:center; white-space:nowrap;
    }
    .pill b{color:var(--gold)}
    @media (max-width:700px){
      .pill{padding:6px 9px; font-size:11px; gap:6px;}
    }

    .btn{
      appearance:none;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(246,211,122,.18), rgba(246,211,122,.07));
      color:var(--gold);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-family:inherit;
      font-weight:800;
      letter-spacing:.05em;
      box-shadow:0 10px 22px rgba(0,0,0,.35);
      transition:transform .12s ease, filter .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.06)}
    .btn:active{transform:translateY(0); filter:brightness(.98)}
    .btn.ghost{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.18);
      color:rgba(236,236,236,.85);
      font-weight:600;
    }
    .btn.danger{
      border-color:rgba(255,120,120,.45);
      color:rgba(255,160,160,.95);
      background:rgba(255,120,120,.10);
    }
    .small{padding:8px 10px; font-size:12px; border-radius:999px; letter-spacing:.04em}

    /* 手機更多浮層 */
    .moreWrap{ position:relative; display:inline-flex; }
    .moreMenu{
      position:absolute;
      top:calc(100% + 8px);
      left:0;
      min-width: 220px;
      border-radius:16px;
      border:1px solid rgba(246,211,122,.30);
      background:linear-gradient(180deg, rgba(0,0,0,.72), rgba(0,0,0,.45));
      box-shadow:0 18px 50px rgba(0,0,0,.65);
      backdrop-filter:blur(10px);
      padding:8px;
      display:none;
      z-index:60;
    }
    .moreMenu.open{ display:block; }
    .menuItem{
      width:100%;
      text-align:left;
      border:none;
      background:rgba(255,255,255,.04);
      color:rgba(236,236,236,.92);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-family:inherit;
      letter-spacing:.04em;
    }
    .menuItem:hover{ background:rgba(246,211,122,.12); color:var(--gold); }
    .menuSep{ height:1px; margin:8px 6px; background:rgba(255,255,255,.10); }

    .panel{
      margin-top:16px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
    }

    .controls{
      display:grid;
      grid-template-columns: 1.2fr .9fr .9fr auto;
      gap:10px;
      align-items:end;
    }
    @media (max-width:920px){ .controls{grid-template-columns:1fr 1fr} }
    @media (max-width:520px){ .controls{grid-template-columns:1fr} }

    .field{display:flex; flex-direction:column; gap:6px}
    .label{font-size:12px; letter-spacing:.08em; color:var(--muted)}
    input,select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);
      color:var(--text);
      padding:10px 12px;
      font-family:inherit;
      outline:none;
      transition:border-color .12s ease, filter .12s ease;
    }
    input:focus,select:focus{border-color:rgba(246,211,122,.55); filter:brightness(1.05)}

    .tableWrap{
      margin-top:14px;
      overflow:auto;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
    }
    table{width:100%; border-collapse:collapse; min-width:980px; background:rgba(0,0,0,.18)}
    thead th{
      position:sticky; top:0; z-index:2;
      background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
      color:rgba(246,211,122,.95);
      font-size:13px; letter-spacing:.06em;
      text-align:left;
      padding:12px 12px;
      border-bottom:1px solid rgba(246,211,122,.25);
      white-space:nowrap;
    }
    tbody td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
      font-size:14px;
      color:rgba(236,236,236,.92);
    }
    tbody tr:hover td{background:rgba(255,255,255,.04)}
    .link{
      color:var(--gold);
      text-decoration:none;
      border-bottom:1px dashed rgba(246,211,122,.45);
      white-space:nowrap;
    }
    .link:hover{filter:brightness(1.1)}
    .muted{color:rgba(236,236,236,.55)}
    .rowBtns{display:flex; gap:8px; align-items:center}
    .hint{margin-top:10px; color:var(--muted); font-size:13px; line-height:1.6}

    .mask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.62);
      display:none;
      align-items:center; justify-content:center;
      padding:20px; z-index:100;
    }
    .modal{
      width:min(860px, 96vw);
      border-radius:22px;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      box-shadow:0 30px 90px rgba(0,0,0,.75);
      overflow:hidden;
      backdrop-filter:blur(10px);
    }
    .mHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .mTitle{
      font-weight:900; letter-spacing:.08em;
      color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.22);
    }
    .mBody{padding:14px 16px 16px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .span2{grid-column:span 2}
    @media (max-width:720px){
      .grid{grid-template-columns:1fr}
      .span2{grid-column:span 1}
      table{min-width:860px}
    }
    .inline2{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end}
    .miniHint{font-size:12px; color:rgba(236,236,236,.62); line-height:1.5}
    .mFoot{
      padding:14px 16px;
      display:flex; gap:10px; justify-content:flex-end;
      border-top:1px solid rgba(255,255,255,.10);
      flex-wrap:wrap;
    }

    .pMask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.65);
      display:none;
      align-items:center; justify-content:center;
      padding:20px; z-index:160;
    }
    .pModal{
      width:min(520px, 96vw);
      border-radius:20px;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      box-shadow:0 30px 90px rgba(0,0,0,.75);
      overflow:hidden;
      backdrop-filter:blur(10px);
    }
    .pHead{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .pTitle{
      font-weight:900; letter-spacing:.08em;
      color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.22);
      font-size:16px;
    }
    .pBody{padding:14px}
    .pFoot{
      padding:12px 14px;
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.55);
      color:rgba(236,236,236,.92);
      font-size:13px;
      box-shadow:var(--shadow);
      display:none;
      z-index:200;
      backdrop-filter:blur(10px);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- ✅ 左上：返回首頁 / 登錄 / 查詢（桌面）；手機：返回 + 更多 -->
    <div class="topbar">
      <div class="nav-left">
        <!-- 桌面 -->
        <div class="nav-desktop">
          <button class="btn ghost small" id="navHome">返回首頁</button>
          <button class="btn ghost small" id="navReg">工程資料登錄</button>
          <button class="btn ghost small" id="navQuery">工程資料查詢</button>
        </div>

        <!-- 手機 -->
        <div class="nav-mobile">
          <button class="btn ghost small" id="mBack">返回</button>
          <div class="moreWrap">
            <button class="btn ghost small" id="mMoreBtn" type="button">更多 ▾</button>
            <div class="moreMenu" id="mMoreMenu" role="menu" aria-label="更多選單">
              <button class="menuItem" data-href="index.html" type="button">返回首頁</button>
              <div class="menuSep"></div>
              <button class="menuItem" data-href="工程資料登錄.html" type="button">工程資料登錄</button>
              <button class="menuItem" data-href="工程資料查詢.html" type="button">工程資料查詢</button>
            </div>
          </div>
        </div>
      </div>

      <div class="brand">
        <div class="title">工程資料明細表</div>
        <div class="sub">編號 · 文件名稱 · 系統 · 類別 · 檔案連結 · 登錄日期</div>
      </div>

      <div class="right">
        <div class="pill">使用者：<b id="uName">—</b></div>
        <div class="pill">權限：<b id="uRole">—</b></div>
        <button class="btn" id="btnNew">新增資料</button>
      </div>
    </div>

    <div class="panel">
      <div class="controls">
        <div class="field">
          <div class="label">搜尋（文件名稱 / 系統 / 類別 / 連結）</div>
          <input id="q" placeholder="例如：施工圖、材料、機電、B2F..." />
        </div>
        <div class="field">
          <div class="label">系統</div>
          <select id="fSysFilter"><option value="">全部</option></select>
        </div>
        <div class="field">
          <div class="label">類別</div>
          <select id="fCatFilter"><option value="">全部</option></select>
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
          <button class="btn ghost" id="btnClear">清除條件</button>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:100px;">編號</th>
              <th style="width:280px;">文件名稱</th>
              <th style="width:160px;">系統</th>
              <th style="width:160px;">類別</th>
              <th>檔案連結</th>
              <th style="width:140px;">登錄日期</th>
              <th style="width:170px;">操作</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="hint" id="hint"></div>
    </div>
  </div>

  <!-- Modal：新增/查看/編輯 -->
  <div class="mask" id="mask">
    <div class="modal">
      <div class="mHead">
        <div class="mTitle" id="mTitle">新增資料</div>
        <button class="btn ghost small" id="btnClose">關閉</button>
      </div>

      <div class="mBody">
        <div class="grid">
          <div class="field">
            <div class="label">編號（自動產生）</div>
            <input id="mNo" disabled />
          </div>
          <div class="field">
            <div class="label">登錄日期（自動，必要時可改）</div>
            <input id="mDate" type="date" />
          </div>

          <div class="field span2">
            <div class="label">文件名稱</div>
            <input id="mName" placeholder="例如：空調系統施工圖（核准版）" />
          </div>

          <div class="field">
            <div class="label">系統（只能從選單選；新增請按右側按鈕）</div>
            <div class="inline2">
              <select id="mSysSel"></select>
              <button class="btn ghost small" id="btnAddSys" type="button">新增系統</button>
            </div>
            <div class="miniHint">選單來源：明細表資料不重複 + 系統字典。</div>
          </div>

          <div class="field">
            <div class="label">類別（只能從選單選；新增請按右側按鈕）</div>
            <div class="inline2">
              <select id="mCatSel"></select>
              <button class="btn ghost small" id="btnAddCat" type="button">新增類別</button>
            </div>
            <div class="miniHint">選單來源：明細表資料不重複 + 類別字典。</div>
          </div>

          <div class="field span2">
            <div class="label">檔案連結（Dropbox / 雲端 / 內網網址）</div>
            <input id="mUrl" type="url" placeholder="https://..." />
          </div>
        </div>
      </div>

      <div class="mFoot">
        <button class="btn danger" id="btnDelete" style="display:none;">刪除</button>
        <button class="btn ghost" id="btnCancel">取消</button>
        <button class="btn" id="btnSave">儲存</button>
      </div>
    </div>
  </div>

  <!-- Prompt：新增系統/類別 -->
  <div class="pMask" id="pMask">
    <div class="pModal">
      <div class="pHead">
        <div class="pTitle" id="pTitle">新增</div>
        <button class="btn ghost small" id="pClose" type="button">關閉</button>
      </div>
      <div class="pBody">
        <div class="field">
          <div class="label" id="pLabel">請輸入</div>
          <input id="pInput" placeholder="例如：消防 / 弱電 / 空調..." />
          <div class="miniHint">新增後會加入選單來源（字典），維持資料一致。</div>
        </div>
      </div>
      <div class="pFoot">
        <button class="btn ghost" id="pCancel" type="button">取消</button>
        <button class="btn" id="pOk" type="button">確定新增</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const CURRENT_KEY = "tasunCurrentUser_v1";
    const DB_KEY = "tasunEngineeringDetail_v1";
    const COUNTER_KEY = "tasunEngineeringDetail_counter_v1";
    const SYS_DICT_KEY = "tasunEngineeringDetail_systems_v1";
    const CAT_DICT_KEY = "tasunEngineeringDetail_categories_v1";

    let currentUser = null;
    let db = [];
    let editingId = null;
    let promptMode = null;

    const $ = (id) => document.getElementById(id);
    const norm = (s) => (s ?? "").toString().trim();

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.style.display = "none", 2200);
    }

    function loadCurrentUser(){
      try{
        const raw = localStorage.getItem(CURRENT_KEY);
        currentUser = raw ? JSON.parse(raw) : null;
      }catch(e){
        currentUser = null;
      }
    }

    // ✅ 統一權限讀取：優先 level（與 index/權限表一致），相容舊版 role
    function role(){
      return String(currentUser?.level || currentUser?.role || "read").toLowerCase();
    }
    function canWrite(){
      const r = role();
      return r === "admin" || r === "write";
    }
    function isAdmin(){ return role() === "admin"; }

    function gate(){
      if(!currentUser || !currentUser.username){
        alert("尚未登入，將返回首頁。");
        location.href = "index.html";
        return false;
      }
      $("uName").textContent = currentUser.username;
      $("uRole").textContent = role();
      return true;
    }

    function loadDB(){
      try{
        const raw = localStorage.getItem(DB_KEY);
        db = raw ? JSON.parse(raw) : [];
        if(!Array.isArray(db)) db = [];
      }catch(e){
        db = [];
      }
    }
    function saveDB(){
      localStorage.setItem(DB_KEY, JSON.stringify(db));
    }

    function getCounter(){
      const n = Number(localStorage.getItem(COUNTER_KEY) || "0");
      return Number.isFinite(n) ? n : 0;
    }
    function nextCounter(){
      const n = getCounter() + 1;
      localStorage.setItem(COUNTER_KEY, String(n));
      return n;
    }
    function padNo(n){
      const s = String(n);
      return s.length >= 4 ? s : ("0000".slice(s.length) + s);
    }
    function escHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function loadDict(key){
      try{
        const raw = localStorage.getItem(key);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr.map(norm).filter(Boolean) : [];
      }catch(e){
        return [];
      }
    }
    function saveDict(key, arr){
      localStorage.setItem(key, JSON.stringify(arr));
    }

    function uniqueFromDB(field){
      const set = new Set();
      for(const r of db){
        const v = norm(r[field]);
        if(v) set.add(v);
      }
      return set;
    }

    function unionOptions(field, dictKey){
      const set = uniqueFromDB(field);
      for(const v of loadDict(dictKey)) set.add(v);
      const arr = Array.from(set);
      arr.sort((a,b)=> a.localeCompare(b, "zh-Hant"));
      return arr;
    }

    function rebuildFilters(){
      const sys = unionOptions("system", SYS_DICT_KEY);
      const cat = unionOptions("category", CAT_DICT_KEY);

      const sSel = $("fSysFilter");
      const cSel = $("fCatFilter");

      const keepS = sSel.value;
      const keepC = cSel.value;

      sSel.innerHTML = `<option value="">全部</option>` + sys.map(v =>
        `<option value="${escHtml(v)}">${escHtml(v)}</option>`
      ).join("");

      cSel.innerHTML = `<option value="">全部</option>` + cat.map(v =>
        `<option value="${escHtml(v)}">${escHtml(v)}</option>`
      ).join("");

      if(sys.includes(keepS)) sSel.value = keepS;
      if(cat.includes(keepC)) cSel.value = keepC;
    }

    function filteredRows(){
      const q = norm($("q").value).toLowerCase();
      const sys = norm($("fSysFilter").value);
      const cat = norm($("fCatFilter").value);

      let rows = db.slice();

      if(sys) rows = rows.filter(r => norm(r.system) === sys);
      if(cat) rows = rows.filter(r => norm(r.category) === cat);

      if(q){
        rows = rows.filter(r => {
          const hay = [r.name, r.system, r.category, r.url, r.regDate, r.id]
            .map(x => (x ?? "").toString().toLowerCase())
            .join(" | ");
          return hay.includes(q);
        });
      }

      rows.sort((a,b)=> (norm(b.regDate)||"").localeCompare(norm(a.regDate)||""));
      return rows;
    }

    function render(){
      rebuildFilters();

      const rows = filteredRows();
      const writable = canWrite();

      $("tbody").innerHTML = rows.map(r => {
        const url = norm(r.url);
        const linkCell = url
          ? `<a class="link" href="${escHtml(url)}" target="_blank" rel="noopener">開啟</a>`
          : `<span class="muted">—</span>`;

        const sysCell = norm(r.system) ? escHtml(r.system) : `<span class="muted">—</span>`;
        const catCell = norm(r.category) ? escHtml(r.category) : `<span class="muted">—</span>`;
        const dateCell = norm(r.regDate) ? escHtml(r.regDate) : `<span class="muted">—</span>`;

        const editBtn = writable
          ? `<button class="btn small" data-act="edit" data-id="${r.id}">編輯</button>`
          : ``;

        return `
          <tr>
            <td>${escHtml(padNo(r.id))}</td>
            <td>${escHtml(r.name)}</td>
            <td>${sysCell}</td>
            <td>${catCell}</td>
            <td>${linkCell}</td>
            <td>${dateCell}</td>
            <td>
              <div class="rowBtns">
                <button class="btn ghost small" data-act="view" data-id="${r.id}">查看</button>
                ${editBtn}
              </div>
            </td>
          </tr>
        `;
      }).join("") || `
        <tr>
          <td colspan="7" class="muted" style="padding:18px;">
            尚無資料（可用「工程資料登錄」建立第一筆）
          </td>
        </tr>
      `;

      $("hint").innerHTML = `
        目前為 <b style="color:var(--gold)">${writable ? "可維護模式" : "唯讀模式"}</b>
        （role: ${escHtml(role())}）。筆數：<b style="color:var(--gold)">${rows.length}</b>。
      `;
    }

    function setModalEditable(editable){
      $("btnSave").style.display = editable ? "inline-block" : "none";
      $("btnDelete").style.display = (editable && isAdmin() && editingId != null) ? "inline-block" : "none";

      ["mDate","mName","mSysSel","mCatSel","mUrl","btnAddSys","btnAddCat"].forEach(id=>{
        if($(id)) $(id).disabled = !editable;
      });

      const allowAdd = editable && canWrite();
      $("btnAddSys").style.display = allowAdd ? "inline-block" : "none";
      $("btnAddCat").style.display = allowAdd ? "inline-block" : "none";
    }

    function fillDropdown(selectId, options, placeholder){
      const sel = $(selectId);
      if(options.length === 0){
        sel.innerHTML = `<option value="" disabled selected>${escHtml(placeholder)}</option>`;
      }else{
        sel.innerHTML = options.map(v=>`<option value="${escHtml(v)}">${escHtml(v)}</option>`).join("");
      }
    }

    function refreshModalDropdowns(){
      fillDropdown("mSysSel", unionOptions("system", SYS_DICT_KEY), "（請先新增系統）");
      fillDropdown("mCatSel", unionOptions("category", CAT_DICT_KEY), "（請先新增類別）");
    }

    function openModal(id, editable){
      const item = db.find(x => x.id === id) || null;
      editingId = item ? item.id : null;

      refreshModalDropdowns();

      $("mTitle").textContent = editable ? "編輯資料" : "查看資料";
      setModalEditable(editable);

      $("mNo").value = item ? padNo(item.id) : "(自動)";
      $("mDate").value = item?.regDate || new Date().toISOString().slice(0,10);
      $("mName").value = item?.name || "";
      $("mUrl").value = item?.url || "";

      if(item?.system){
        const ok = Array.from($("mSysSel").options).some(o => o.value === item.system);
        if(ok) $("mSysSel").value = item.system;
      }
      if(item?.category){
        const ok = Array.from($("mCatSel").options).some(o => o.value === item.category);
        if(ok) $("mCatSel").value = item.category;
      }

      $("mask").style.display = "flex";
    }

    function openNew(){
      editingId = null;
      refreshModalDropdowns();

      $("mTitle").textContent = "新增資料";
      setModalEditable(true);

      $("mNo").value = padNo(getCounter()+1);
      $("mDate").value = new Date().toISOString().slice(0,10);
      $("mName").value = "";
      $("mUrl").value = "";

      $("mask").style.display = "flex";
    }

    function closeModal(){ $("mask").style.display = "none"; }

    function saveItem(){
      if(!canWrite()){ toast("唯讀權限不可儲存"); return; }

      const name = norm($("mName").value);
      if(!name){ toast("文件名稱不可空白"); $("mName").focus(); return; }

      const system = norm($("mSysSel").value);
      const category = norm($("mCatSel").value);

      if(!system){ toast("系統尚未建立：請先按「新增系統」"); return; }
      if(!category){ toast("類別尚未建立：請先按「新增類別」"); return; }

      const url = norm($("mUrl").value);
      const regDate = norm($("mDate").value) || new Date().toISOString().slice(0,10);

      if(editingId != null){
        const idx = db.findIndex(x => x.id === editingId);
        if(idx >= 0) db[idx] = { id: editingId, name, system, category, url, regDate };
      }else{
        const id = nextCounter();
        db.unshift({ id, name, system, category, url, regDate });
      }

      saveDB();
      closeModal();
      render();
      toast("已儲存");
    }

    function deleteItem(){
      if(!isAdmin()){ toast("僅 admin 可刪除"); return; }
      if(editingId == null) return;
      if(!confirm("確定刪除這筆資料？")) return;

      db = db.filter(x => x.id !== editingId);
      saveDB();
      closeModal();
      render();
      toast("已刪除");
    }

    function openPrompt(mode){
      if(!canWrite()){ toast("read 權限不可新增"); return; }

      promptMode = mode;
      $("pInput").value = "";

      if(mode === "sys"){
        $("pTitle").textContent = "新增系統";
        $("pLabel").textContent = "請輸入新的系統名稱";
        $("pInput").placeholder = "例如：空調 / 消防 / 弱電 / 給排水...";
      }else{
        $("pTitle").textContent = "新增類別";
        $("pLabel").textContent = "請輸入新的類別名稱";
        $("pInput").placeholder = "例如：施工圖 / 材料審查 / 計劃書 / 會議...";
      }

      $("pMask").style.display = "flex";
      setTimeout(()=> $("pInput").focus(), 0);
    }

    function closePrompt(){
      $("pMask").style.display = "none";
      promptMode = null;
    }

    function addOption(){
      if(!canWrite()) return;

      const v = norm($("pInput").value);
      if(!v){ toast("不可空白"); $("pInput").focus(); return; }

      const key = (promptMode === "sys") ? SYS_DICT_KEY : CAT_DICT_KEY;
      const exists = unionOptions(promptMode === "sys" ? "system" : "category", key).map(x=>x.toLowerCase());
      if(exists.includes(v.toLowerCase())){ toast("已存在相同選項"); return; }

      const dict = loadDict(key);
      dict.push(v);
      dict.sort((a,b)=> a.localeCompare(b, "zh-Hant"));
      saveDict(key, dict);

      refreshModalDropdowns();
      rebuildFilters();

      if(promptMode === "sys") $("mSysSel").value = v;
      else $("mCatSel").value = v;

      closePrompt();
      render();
      toast("已新增選項");
    }

    function setupMoreMenu(backHref){
      const backBtn = $("mBack");
      const moreBtn = $("mMoreBtn");
      const menu = $("mMoreMenu");

      const close = ()=> menu.classList.remove("open");
      const toggle = (e)=>{
        e.preventDefault();
        e.stopPropagation();
        menu.classList.toggle("open");
      };

      backBtn.onclick = ()=> location.href = backHref;
      moreBtn.addEventListener("click", toggle);

      menu.addEventListener("click", (e)=>{
        e.stopPropagation();
        const item = e.target.closest("button.menuItem[data-href]");
        if(!item) return;
        const href = item.getAttribute("data-href");
        if(href) location.href = href;
      });

      document.addEventListener("click", close);
      window.addEventListener("keydown", (e)=>{ if(e.key === "Escape") close(); });
    }

    function init(){
      loadCurrentUser();
      if(!gate()) return;

      loadDB();

      // 左上（桌面）
      $("navHome").onclick = () => location.href = "index.html";
      $("navReg").onclick = () => location.href = "工程資料登錄.html";
      $("navQuery").onclick = () => location.href = "工程資料查詢.html";

      // 手機：返回=首頁
      setupMoreMenu("index.html");

      $("btnNew").style.display = canWrite() ? "inline-block" : "none";
      $("btnNew").onclick = openNew;

      $("q").addEventListener("input", render);
      $("fSysFilter").addEventListener("change", render);
      $("fCatFilter").addEventListener("change", render);

      $("btnClear").onclick = () => {
        $("q").value = "";
        $("fSysFilter").value = "";
        $("fCatFilter").value = "";
        render();
      };

      $("btnClose").onclick = closeModal;
      $("btnCancel").onclick = closeModal;
      $("mask").addEventListener("click", (e)=>{ if(e.target === $("mask")) closeModal(); });

      $("btnSave").onclick = saveItem;
      $("btnDelete").onclick = deleteItem;

      $("btnAddSys").onclick = () => openPrompt("sys");
      $("btnAddCat").onclick = () => openPrompt("cat");

      $("pClose").onclick = closePrompt;
      $("pCancel").onclick = closePrompt;
      $("pOk").onclick = addOption;
      $("pMask").addEventListener("click", (e)=>{ if(e.target === $("pMask")) closePrompt(); });

      $("tbody").addEventListener("click", (e)=>{
        const btn = e.target.closest("button[data-act]");
        if(!btn) return;
        const act = btn.getAttribute("data-act");
        const id = Number(btn.getAttribute("data-id"));
        if(!Number.isFinite(id)) return;

        if(act === "view") openModal(id, false);
        if(act === "edit"){
          if(!canWrite()){ toast("唯讀權限不可編輯"); return; }
          openModal(id, true);
        }
      });

      window.addEventListener("keydown", (e)=>{
        if(e.key === "Escape"){
          if($("pMask").style.display === "flex") closePrompt();
          else if($("mask").style.display === "flex") closeModal();
        }
        if(e.key === "Enter" && $("pMask").style.display === "flex") addOption();
      });

      render();
    }

    init();
  </script>
</body>
</html>
