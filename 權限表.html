<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tasun æ¬Šé™è¡¨</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --gold:#f6d37a;
      --gold-soft: rgba(246, 211, 122, 0.78);
      --panel-border: rgba(246, 211, 122, 0.35);
    }
    *{ box-sizing:border-box; margin:0; padding:0; }
    body{
      min-height:100vh;
      font-family:"Noto Serif TC","Microsoft JhengHei",serif;
      background: radial-gradient(circle at 50% 18%, rgba(255, 228, 170, 0.18), rgba(0,0,0,0.98));
      color:var(--gold);
      padding: 18px 16px 30px;
    }
    .wrap{
      max-width: 1400px;
      margin: 0 auto;
      border-radius: 22px;
      border: 1px solid rgba(246, 211, 122, 0.22);
      box-shadow: 0 0 26px rgba(0,0,0,0.65), 0 0 26px rgba(246, 211, 122, 0.12);
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(0,0,0,0.85));
      padding: 14px 14px 18px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .title{
      font-size: 1.2rem;
      letter-spacing: .18em;
      text-indent: .18em;
      text-shadow: 0 0 16px rgba(246,211,122,.45);
      white-space: nowrap;
    }
    .pill{
      padding: .32rem .9rem;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.55);
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,.16), rgba(0,0,0,.88));
      color: var(--gold-soft);
      font-size: .85rem;
      opacity: .92;
      white-space: nowrap;
    }
    .actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }
    .btn{
      border: 1px solid rgba(246,211,122,0.72);
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,0.22), rgba(0,0,0,0.92));
      color: var(--gold);
      border-radius: 999px;
      padding: 0.42rem 1.05rem;
      cursor: pointer;
      letter-spacing: 0.10em;
      text-indent: 0.10em;
      box-shadow: 0 8px 16px rgba(0,0,0,0.75);
      white-space: nowrap;
      user-select:none;
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .btn.ghost{
      background: transparent;
      border-color: rgba(246,211,122,.35);
      box-shadow:none;
    }
    .msg{
      margin-top: 10px;
      min-height: 1.1rem;
      font-size: .88rem;
      color: rgba(255, 220, 190, 0.95);
      white-space: pre-line;
    }

    .table-wrap{
      overflow:auto;
      border-radius: 18px;
      border: 1px solid rgba(246,211,122,0.18);
      background: rgba(0,0,0,0.55);
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width: 980px;
    }
    thead th{
      position: sticky;
      top: 0;
      background: rgba(246,211,122,0.12);
      border-bottom: 1px solid rgba(246,211,122,0.22);
      padding: 12px 10px;
      font-weight: 700;
      letter-spacing: .12em;
      white-space: nowrap;
    }
    tbody td{
      border-bottom: 1px solid rgba(246,211,122,0.10);
      padding: 10px 10px;
      vertical-align: middle;
    }
    tbody tr:hover td{ background: rgba(246,211,122,0.06); }

    .in{
      width: 100%;
      padding: .48rem .7rem;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,0.45);
      background: rgba(0,0,0,0.82);
      color: var(--gold);
      outline:none;
    }
    .in:focus{ border-color: rgba(255, 238, 190, 0.9); box-shadow: 0 0 12px rgba(246, 211, 122, 0.65); }
    .sel{ padding:.48rem .7rem; }
    .pwrow{ display:flex; gap:8px; align-items:center; }
    .eye{ padding:.35rem .7rem; }
    .danger{ border-color: rgba(255,160,160,0.55); color: rgba(255,210,210,0.95); }

    .warn{
      margin-top: 10px;
      color: rgba(246,211,122,0.78);
      font-size: .88rem;
      letter-spacing: .04em;
    }

    /* token overlay */
    .token-overlay{
      position: fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      padding: 18px;
      z-index: 2000;
      background: radial-gradient(circle at 50% 18%, rgba(255, 228, 170, 0.32), rgba(0, 0, 0, 0.98));
    }
    .token-box{
      width: min(720px, 94vw);
      padding: 1.35rem 1.35rem 1.1rem;
      border-radius: 18px;
      background: radial-gradient(circle at 0% 0%, rgba(246, 211, 122, 0.22), rgba(0, 0, 0, 0.95));
      border: 1px solid rgba(246, 211, 122, 0.35);
      box-shadow: 0 0 28px rgba(0,0,0,0.92), 0 0 26px rgba(246,211,122,0.18);
      color: var(--gold-soft);
    }
    .token-title{ text-align:center; font-size:1.12rem; letter-spacing:.18em; text-indent:.18em; margin-bottom:.6rem; }
    .token-row{ display:flex; gap:.5rem; align-items:center; margin-top:.55rem; flex-wrap:wrap; }
    .token-msg{ margin-top:.8rem; min-height:1.2rem; font-size:.86rem; white-space: pre-line; color: rgba(255,220,190,.95); }
    .muted{ opacity:.85; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <div class="title">Tasun æ¬Šé™è¡¨</div>
        <div class="pill" id="who">ç›®å‰ï¼šæœªç™»å…¥</div>
        <div class="pill" id="cloudState">é›²ç«¯ï¼šæœªåŒæ­¥</div>
      </div>

      <div class="actions">
        <button class="btn" id="btnBack"  type="button">è¿”å›é¦–é </button>
        <button class="btn" id="btnToken" type="button">è¨­å®š Token</button>
        <button class="btn ghost" id="btnApps" type="button">é–‹å•Ÿ /Apps ä½ç½®</button>
        <button class="btn" id="btnPull"  type="button">å¾é›²ç«¯ä¸‹è¼‰</button>
        <button class="btn" id="btnPush"  type="button">æ‰‹å‹•åŒæ­¥</button>
        <button class="btn" id="btnAdd"   type="button">ï¼‹ æ–°å¢ä¸€åˆ—å¸³è™Ÿ</button>
      </div>
    </div>

    <div class="table-wrap">
      <table id="tbl">
        <thead><tr id="hdrRow"></tr></thead>
        <tbody id="body"></tbody>
      </table>
    </div>

    <div class="msg" id="msg"></div>
    <div class="warn">âš  æé†’ï¼šToken å­˜åœ¨ç€è¦½å™¨ localStorageï¼ˆåŒä¸€å°é›»è…¦/åŒä¸€ç€è¦½å™¨æœƒä¿ç•™ï¼‰ï¼Œä¸æ˜¯å­˜åˆ° Dropbox æª”æ¡ˆæˆ–ç¶²å€å…§ã€‚</div>
  </div>

  <!-- Token overlay -->
  <div class="token-overlay" id="tokenOverlay" aria-hidden="true">
    <div class="token-box">
      <div class="token-title">Dropbox Token è¨­å®šï¼ˆApp folderï¼‰</div>

      <div style="font-size:.9rem; line-height:1.75; color:rgba(246,211,122,0.82);" class="muted">
        âœ… App folder Tokenï¼šæª”æ¡ˆæœƒå¯«å…¥ Dropboxã€ŒAppsã€å€åŸŸï¼ˆä¸æ˜¯ä¸€èˆ¬æ ¹ç›®éŒ„ï¼‰ã€‚<br>
        âœ… API å…§éƒ¨è·¯å¾‘å›ºå®šï¼š<b class="mono">/Tasun/æ¬Šé™</b>ï¼ˆä¸å­˜åœ¨æœƒè‡ªå‹•å»ºç«‹ï¼‰ã€‚<br>
        âœ… Dropbox ç¶²ç«™çœ‹åˆ°çš„ä½ç½®ï¼š<b class="mono">/Apps/&lt;Appå&gt;/Tasun/æ¬Šé™</b>ï¼ˆAppåç„¡æ³•ç”± API ç›´æ¥å–å¾—ï¼Œæ‰€ä»¥ä½ åœ¨ä¸‹æ–¹å¡«å…¥ï¼‰ã€‚<br>
        âœ… Dropbox å¸³è™Ÿæç¤ºï¼š<b>tasun_8@hotmail.com</b>
      </div>

      <div class="token-row">
        <input class="in" id="appNameInput" placeholder="Apps å…§ App åç¨±ï¼ˆä¾‹ï¼šwutasunï¼‰" />
        <button class="btn ghost" id="btnOpenAppsHere" type="button">é–‹å•Ÿæ­¤ Apps ä½ç½®</button>
      </div>

      <div class="token-row">
        <input class="in" id="tokenInput" type="password" placeholder="è²¼ä¸Š Access Tokenï¼ˆä»¥ sl. é–‹é ­ï¼‰" />
        <button class="btn eye" id="tokenEye" type="button">ğŸ‘</button>
      </div>

      <div class="token-msg" id="tokenMsg"></div>

      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:.9rem; flex-wrap:wrap;">
        <button class="btn ghost" id="btnGuide" type="button">ä¸€éµå¼•å°å» Console å‹¾æ¬Šé™</button>
        <button class="btn" id="tokenClose" type="button">é—œé–‰</button>
        <button class="btn" id="tokenSaveTest"  type="button">å„²å­˜ä¸¦æ¸¬è©¦</button>
      </div>
    </div>
  </div>

<script>
  // ==========================
  // Keysï¼ˆèˆ‡é¦–é ä¸€è‡´ï¼‰
  // ==========================
  const AUTH_KEY    = "tasunAuthTable_v1";
  const NAV_KEY     = "tasunNavButtons_v1";
  const CURRENT_KEY = "tasunCurrentUser_v1";

  const DBX_TOKEN_KEY   = "tasunDbxToken_v1";
  const DBX_APPNAME_KEY = "tasunDbxAppName_v1";
  const DEFAULT_APPNAME = "wutasun";

  const DEFAULT_DBX_FOLDER = "/Tasun/æ¬Šé™";
  const AUTO_PUSH_DEBOUNCE_MS = 1200;

  const EXPECT_EMAIL = "tasun_8@hotmail.com";

  function safeJsonParse(s, fallback){
    try{ return JSON.parse(s); }catch(e){ return fallback; }
  }

  function getDbxToken(){ return String(localStorage.getItem(DBX_TOKEN_KEY) || "").trim(); }
  function setDbxToken(t){ localStorage.setItem(DBX_TOKEN_KEY, String(t||"").trim()); }
  function dbxEnabled(){ const t = getDbxToken(); return !!(t && t.length > 20); }
  function dbxAuthHeader(){ return "Bearer " + getDbxToken(); }

  function getAppName(){
    return String(localStorage.getItem(DBX_APPNAME_KEY) || DEFAULT_APPNAME).trim() || DEFAULT_APPNAME;
  }
  function setAppName(x){
    localStorage.setItem(DBX_APPNAME_KEY, String(x||"").trim() || DEFAULT_APPNAME);
  }

  function getDbxFolder(){ return DEFAULT_DBX_FOLDER; }
  function dbxPathAuth(){ return `${getDbxFolder()}/tasunAuthTable_v1.json`; }
  function dbxPathNav(){  return `${getDbxFolder()}/tasunNavButtons_v1.json`; }
  function dbxPathMeta(){ return `${getDbxFolder()}/tasunCloudMeta_v1.json`; }

  function getAppsWebUrl(){
    const app = encodeURIComponent(getAppName());
    const path = "Tasun/%E6%AC%8A%E9%99%90";
    return `https://www.dropbox.com/home/Apps/${app}/${path}`;
  }

  // âœ… é‡è¦ï¼šDropbox-API-Arg header éœ€ ASCIIï¼ˆä¸­æ–‡è¦è½‰ \uXXXXï¼‰
  function jsonAscii(obj){
    return JSON.stringify(obj).replace(/[^\x00-\x7F]/g, (c)=>{
      const code = c.charCodeAt(0).toString(16).padStart(4,"0");
      return "\\u" + code;
    });
  }

  // âœ… timeoutï¼šé¿å…å¡ä½ã€ŒåŒæ­¥ä¸­â€¦ã€
  async function fetchWithTimeout(url, options={}, timeoutMs=15000){
    const ctrl = new AbortController();
    const id = setTimeout(()=> ctrl.abort(), timeoutMs);
    try{
      const res = await fetch(url, { ...options, signal: ctrl.signal });
      return res;
    } finally {
      clearTimeout(id);
    }
  }

  // ==========================
  // UI refs
  // ==========================
  const who = document.getElementById("who");
  const msg = document.getElementById("msg");
  const cloudState = document.getElementById("cloudState");
  const hdrRow = document.getElementById("hdrRow");
  const body = document.getElementById("body");
  const tbl = document.getElementById("tbl");

  const btnBack  = document.getElementById("btnBack");
  const btnAdd   = document.getElementById("btnAdd");
  const btnPull  = document.getElementById("btnPull");
  const btnPush  = document.getElementById("btnPush");
  const btnToken = document.getElementById("btnToken");
  const btnApps  = document.getElementById("btnApps");

  const tokenOverlay = document.getElementById("tokenOverlay");
  const tokenInput = document.getElementById("tokenInput");
  const tokenEye   = document.getElementById("tokenEye");
  const tokenMsg   = document.getElementById("tokenMsg");
  const tokenClose = document.getElementById("tokenClose");
  const tokenSaveTest  = document.getElementById("tokenSaveTest");
  const btnGuide = document.getElementById("btnGuide");
  const appNameInput = document.getElementById("appNameInput");
  const btnOpenAppsHere = document.getElementById("btnOpenAppsHere");

  function setMsg(t){ msg.textContent = t || ""; }
  function setCloudState(t){ cloudState.textContent = t || "é›²ç«¯ï¼šâ€”"; }

  // ==========================
  // session user
  // ==========================
  function getCurrentUser(){
    const cu = safeJsonParse(sessionStorage.getItem(CURRENT_KEY) || "null", null);
    return cu && cu.username ? cu : null;
  }
  function isAdmin(){
    const cu = getCurrentUser();
    const r = String((cu && (cu.level || cu.role)) || "").toLowerCase();
    return !!(cu && r === "admin");
  }

  // ==========================
  // local data
  // ==========================
  function loadNav(){
    const raw = localStorage.getItem(NAV_KEY);
    const arr = safeJsonParse(raw || "[]", []);
    if(Array.isArray(arr) && arr.length) return arr;

    const defaults = [
      { id:"btn1", label:"è‡»é¼æ™‚ä»£å¤§å»ˆç®¡ç†è¡¨", href:"è‡»é¼ç®¡ç†è¡¨.html", target:"", roles:["admin","write","read"] },
      { id:"btn2", label:"ç¼ºå¤± / å“è³ª", href:"ç”„é¼quality.html", target:"", roles:["admin","write","read"] },
      { id:"btn3", label:"é›²ç«¯æª”æ¡ˆ", href:"https://www.dropbox.com/", target:"_blank", roles:["admin","write","read"] },
      { id:"btn4", label:"å·¥ç¨‹è³‡æ–™åº«", href:"å·¥ç¨‹è³‡æ–™åº«.html", target:"", roles:["admin","write"] },
      { id:"btn5", label:"è³‡æ–™åº«", href:"#", target:"", roles:["admin","write","read"] }
    ];
    localStorage.setItem(NAV_KEY, JSON.stringify(defaults));
    return defaults;
  }

  function loadAuth(btnCount){
    const raw = localStorage.getItem(AUTH_KEY);
    let arr = safeJsonParse(raw || "null", null);
    if(!Array.isArray(arr)){
      arr = [
        { username:"alex",  password:"Tasun08040224", level:"admin", buttons: Array(btnCount).fill(true) },
        { username:"tasun", password:"tasun08040224", level:"write", buttons: Array(btnCount).fill(true) },
        { username:"wu",    password:"123456",        level:"read",  buttons: (()=>{ const a=Array(btnCount).fill(false); if(btnCount) a[btnCount-1]=true; return a; })() }
      ];
      localStorage.setItem(AUTH_KEY, JSON.stringify(arr));
    }

    return arr.map(r=>{
      const b = Array.isArray(r.buttons) ? r.buttons.slice() : [];
      const out = [];
      for(let i=0;i<btnCount;i++) out[i] = !!b[i];
      return {
        username: String(r.username||"").trim(),
        password: String(r.password||""),
        level: String(r.level||"read").toLowerCase().trim() || "read",
        buttons: out
      };
    });
  }

  // ==========================
  // Dropbox API helpers
  // ==========================
  async function dbxPostJson(url, bodyObj){
    // âœ… users/get_current_account å¿…é ˆ body: "null"
    let bodyText;
    if(bodyObj === null) bodyText = "null";
    else if(bodyObj === undefined) bodyText = "{}";
    else bodyText = JSON.stringify(bodyObj);

    const res = await fetchWithTimeout(url, {
      method: "POST",
      cache: "no-store",
      headers: {
        "Authorization": dbxAuthHeader(),
        "Content-Type": "application/json"
      },
      body: bodyText
    }, 15000);

    const text = await res.text();
    let json = null;
    try{ json = JSON.parse(text); }catch(e){ json = null; }
    return { ok: res.ok, status: res.status, json, text };
  }

  async function dbxDownloadJson(path){
    if(!dbxEnabled()) return null;
    try{
      const res = await fetchWithTimeout("https://content.dropboxapi.com/2/files/download", {
        method:"POST",
        cache:"no-store",
        headers:{
          "Authorization": dbxAuthHeader(),
          "Dropbox-API-Arg": jsonAscii({ path })  // âœ… ä¿®æ­£ï¼šASCII header
        }
      }, 15000);
      if(!res.ok) return null;
      const text = await res.text();
      try{ return JSON.parse(text); }catch(e){ return null; }
    }catch(e){
      return null;
    }
  }

  async function dbxUploadJson(path, obj){
    if(!dbxEnabled()) return { ok:false, status:0, msg:"Token æœªè¨­å®š" };

    const bodyText = JSON.stringify(obj ?? null);

    try{
      const res = await fetchWithTimeout("https://content.dropboxapi.com/2/files/upload", {
        method:"POST",
        cache:"no-store",
        headers:{
          "Authorization": dbxAuthHeader(),
          "Content-Type": "application/octet-stream",
          "Dropbox-API-Arg": jsonAscii({
            path,
            mode: "overwrite",
            autorename: false,
            mute: true,
            strict_conflict: false
          }) // âœ… ä¿®æ­£ï¼šASCII header
        },
        body: bodyText
      }, 15000);

      const t = await res.text();
      return { ok: res.ok, status: res.status, msg: res.ok ? "OK" : t };
    }catch(e){
      return { ok:false, status:0, msg: "TypeError/ç¶²è·¯/é€¾æ™‚ï¼šä¸Šå‚³å¤±æ•—ï¼ˆå¯èƒ½è¢«ç€è¦½å™¨é˜»æ“‹æˆ–é€£ç·šä¸ç©©ï¼‰" };
    }
  }

  async function ensureFolderExistsOnce(){
    if(ensureFolderExistsOnce.done) return true;
    if(!dbxEnabled()) return false;

    const folder = getDbxFolder();
    const r = await dbxPostJson("https://api.dropboxapi.com/2/files/create_folder_v2", {
      path: folder,
      autorename: false
    });

    if(r.ok){
      ensureFolderExistsOnce.done = true;
      return true;
    }

    if(r.status === 409 && (r.text || "").toLowerCase().includes("conflict")){
      ensureFolderExistsOnce.done = true;
      return true;
    }

    ensureFolderExistsOnce.done = true;
    return false;
  }
  ensureFolderExistsOnce.done = false;

  async function getCurrentAccount(){
    if(!dbxEnabled()) return { ok:false, msg:"âŒ Token æœªè¨­å®š" };

    // âœ… å¿…é ˆé€ null
    const acct = await dbxPostJson("https://api.dropboxapi.com/2/users/get_current_account", null);

    if(!acct.ok){
      return { ok:false, msg:`âŒ Token ç„¡æ•ˆæˆ–éæœŸï¼ˆHTTP ${acct.status}ï¼‰\n${acct.text}` };
    }
    const email = acct.json && acct.json.email ? String(acct.json.email) : "";
    const name = acct.json && acct.json.name && acct.json.name.display_name ? acct.json.name.display_name : "";
    return { ok:true, email, name, raw: acct.json, msg:`âœ… Token OK\nå¸³è™Ÿï¼š${email || "ï¼ˆAPI æœªå› emailï¼‰"}\nåç¨±ï¼š${name || "â€”"}` };
  }

  function detectScopeErrorText(t){
    const s = String(t || "");
    return (s.includes("missing_scope") || s.includes("does not have the required scope") || s.includes("files.content.write"));
  }

  // ==========================
  // å¼•å°ï¼šä¸€æ­¥ä¸€æ­¥å¸¶ä½ å» Console
  // ==========================
  function guideToConsole(){
    alert("æ¥ä¸‹ä¾†æœƒå¼•å°ä½ åˆ° Dropbox App Consoleï¼ˆä¸€æ­¥ä¸€æ­¥ï¼‰ã€‚\nç›®çš„ï¼šå‹¾é¸ scopes + Submitï¼Œç„¶å¾Œé‡æ–°ç”¢ç”Ÿ Access Tokenã€‚\næŒ‰ã€Œç¢ºå®šã€é–‹å§‹ã€‚");
    alert("æ­¥é©Ÿ 1ï¼šé–‹å•Ÿ Dropbox Console çš„ Apps åˆ—è¡¨ï¼ˆæœƒé–‹æ–°åˆ†é ï¼‰ã€‚");
    window.open("https://www.dropbox.com/developers/apps", "_blank", "noopener");
    alert("æ­¥é©Ÿ 2ï¼šåœ¨ Apps åˆ—è¡¨é»é€²ä½ çš„ Appï¼ˆä¾‹å¦‚ï¼šwutasunï¼‰ã€‚\næ‰¾åˆ°ã€ŒPermissionsã€åˆ†é ã€‚");
    alert("æ­¥é©Ÿ 3ï¼šPermissions å‹¾é¸ï¼ˆè‡³å°‘è¦æœ‰ï¼‰ï¼š\n- files.content.write\n- files.content.read\n- files.metadata.read\nï¼ˆå»ºè­°ä¹Ÿå‹¾ï¼šaccount_info.readï¼‰\nå‹¾å¥½æŒ‰ã€ŒSubmitã€ã€‚");
    alert("æ­¥é©Ÿ 4ï¼šåˆ°ã€ŒSettingsã€æ‰¾åˆ° Access Tokenã€‚\nâš ï¸ å¿…é ˆé‡æ–°ç”¢ç”Ÿæ–°çš„ tokenï¼ˆGenerateï¼‰ï¼ŒèˆŠ token ä¸æœƒè‡ªå‹•æœ‰æ–° scopeã€‚");
    alert("æ­¥é©Ÿ 5ï¼šæŠŠæ–° token è²¼å›æœ¬é ã€Œå„²å­˜ä¸¦æ¸¬è©¦ã€ã€‚");
  }

  // ==========================
  // render table
  // ==========================
  function render(){
    const cu = getCurrentUser();
    const r = String((cu && (cu.level || cu.role)) || "").toLowerCase();
    who.textContent = cu ? `ç›®å‰ï¼š${cu.username} (${r || cu.level || cu.role})` : "ç›®å‰ï¼šæœªç™»å…¥";

    const admin = isAdmin();
    const nav = loadNav();
    const auth = loadAuth(nav.length);

    hdrRow.innerHTML = "";
    const ths = ["ç”¨æˆ¶å","å¯†ç¢¼","é¡¯ç¤º","æ¬Šé™ç´šåˆ¥", ...nav.map(n=>n.label || n.id), "åˆªé™¤"];
    ths.forEach(t=>{
      const th = document.createElement("th");
      th.textContent = t;
      hdrRow.appendChild(th);
    });

    body.innerHTML = "";
    auth.forEach((row, idx)=>{
      const tr = document.createElement("tr");

      tr.appendChild(tdInput(row.username, !admin));
      tr.appendChild(tdPassword(row.password, !admin));

      const tdEye = document.createElement("td");
      tdEye.style.textAlign = "center";
      tdEye.textContent = "â€”";
      tr.appendChild(tdEye);

      tr.appendChild(tdSelect(row.level, !admin));

      nav.forEach((n, bIndex)=>{
        const td = document.createElement("td");
        td.style.textAlign = "center";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!row.buttons[bIndex];
        cb.disabled = !admin;
        td.appendChild(cb);
        tr.appendChild(td);
      });

      const tdDel = document.createElement("td");
      tdDel.style.textAlign = "center";
      const del = document.createElement("button");
      del.type = "button";
      del.className = "btn danger";
      del.textContent = "åˆªé™¤";
      del.disabled = !admin;
      del.addEventListener("click", ()=>{
        if(!isAdmin()) return;
        const nav = loadNav();
        const arr = loadAuth(nav.length);
        arr.splice(idx,1);
        localStorage.setItem(AUTH_KEY, JSON.stringify(arr));
        render();
        markDirty("å·²åˆªé™¤ä¸€åˆ—ï¼Œæº–å‚™è‡ªå‹•åŒæ­¥â€¦");
      });
      tdDel.appendChild(del);
      tr.appendChild(tdDel);

      body.appendChild(tr);
    });

    btnAdd.disabled  = !admin;
    btnPush.disabled = !admin;

    if(!admin){
      setCloudState("é›²ç«¯ï¼šåƒ… admin å¯åŒæ­¥");
    }else{
      setCloudState(dirty ? "é›²ç«¯ï¼šå¾…åŒæ­¥" : (dbxEnabled() ? "é›²ç«¯ï¼šâ€”" : "é›²ç«¯ï¼šæœªè¨­å®š Token"));
    }
  }

  function tdInput(value, disabled){
    const td = document.createElement("td");
    const input = document.createElement("input");
    input.className = "in";
    input.value = value || "";
    input.disabled = !!disabled;
    td.appendChild(input);
    return td;
  }

  function tdPassword(value, disabled){
    const td = document.createElement("td");
    const wrap = document.createElement("div");
    wrap.className = "pwrow";

    const input = document.createElement("input");
    input.className = "in";
    input.type = "password";
    input.value = value || "";
    input.disabled = !!disabled;

    const eye = document.createElement("button");
    eye.type = "button";
    eye.className = "btn eye";
    eye.textContent = "ğŸ‘";
    eye.disabled = !!disabled;
    eye.addEventListener("click", ()=>{ input.type = (input.type === "password") ? "text" : "password"; });

    wrap.appendChild(input);
    wrap.appendChild(eye);
    td.appendChild(wrap);
    return td;
  }

  function tdSelect(value, disabled){
    const td = document.createElement("td");
    const sel = document.createElement("select");
    sel.className = "in sel";
    ["admin","write","read"].forEach(k=>{
      const o = document.createElement("option");
      o.value = k; o.textContent = k;
      sel.appendChild(o);
    });
    sel.value = value || "read";
    sel.disabled = !!disabled;
    td.appendChild(sel);
    return td;
  }

  // ==========================
  // DOM â†’ localStorage
  // ==========================
  function saveTableToLocal(){
    const nav = loadNav();
    const rows = [];
    const trs = Array.from(body.querySelectorAll("tr"));
    trs.forEach(tr=>{
      const tds = Array.from(tr.querySelectorAll("td"));

      const username = (tds[0].querySelector("input")?.value || "").trim();
      const password = (tds[1].querySelector("input")?.value || "");
      const level    = (tds[3].querySelector("select")?.value || "read");

      const buttons  = [];
      for(let i=0;i<nav.length;i++){
        const cb = tds[4+i].querySelector("input[type=checkbox]");
        buttons[i] = !!(cb && cb.checked);
      }
      rows.push({ username, password, level, buttons });
    });

    localStorage.setItem(AUTH_KEY, JSON.stringify(rows));
  }

  // ==========================
  // Auto push
  // ==========================
  let autoPushTimer = null;
  let autoPushBusy = false;
  let autoPushPending = false;
  let dirty = false;

  function markDirty(hintText){
    if(!isAdmin()) return;
    dirty = true;
    setCloudState("é›²ç«¯ï¼šå¾…åŒæ­¥");
    if(hintText) setMsg(hintText);
    scheduleAutoPush();
  }

  function scheduleAutoPush(){
    if(!isAdmin()) return;

    if(!dbxEnabled()){
      setCloudState("é›²ç«¯ï¼šæœªè¨­å®š Token");
      return;
    }
    if(autoPushTimer) clearTimeout(autoPushTimer);
    autoPushTimer = setTimeout(()=> autoPushNow(), AUTO_PUSH_DEBOUNCE_MS);
  }

  async function autoPushNow(){
    if(!isAdmin()) return;

    if(!dbxEnabled()){
      setCloudState("é›²ç«¯ï¼šæœªè¨­å®š Token");
      return;
    }
    if(autoPushBusy){
      autoPushPending = true;
      return;
    }

    autoPushBusy = true;
    try{
      setCloudState("é›²ç«¯ï¼šåŒæ­¥ä¸­â€¦");
      setMsg("æ­£åœ¨è‡ªå‹•åŒæ­¥åˆ°é›²ç«¯â€¦");

      const okFolder = await ensureFolderExistsOnce();
      if(!okFolder){
        setCloudState("é›²ç«¯ï¼šToken ç„¡æ•ˆ/æ¬Šé™ä¸è¶³");
        setMsg("âŒ å»ºç«‹è³‡æ–™å¤¾å¤±æ•—ï¼ˆå¯èƒ½ç¼ºå°‘ scopesï¼šfiles.content.writeï¼‰ã€‚\nè«‹æŒ‰ã€Œè¨­å®š Tokenã€â†’ã€Œå„²å­˜ä¸¦æ¸¬è©¦ã€ï¼Œä¾æç¤ºå¼•å°å» Console å‹¾æ¬Šé™ä¸¦é‡æ–°ç”¢ç”Ÿ Tokenã€‚");
        return;
      }

      saveTableToLocal();

      const auth = safeJsonParse(localStorage.getItem(AUTH_KEY) || "[]", []);
      const nav  = safeJsonParse(localStorage.getItem(NAV_KEY)  || "[]", []);

      const up1 = await dbxUploadJson(dbxPathAuth(), auth);
      if(!up1.ok){
        setCloudState("é›²ç«¯ï¼šåŒæ­¥å¤±æ•—");
        setMsg(`âŒ è‡ªå‹•åŒæ­¥å¤±æ•—ï¼ˆauthï¼ŒHTTP ${up1.status}ï¼‰\n${up1.msg}`);
        return;
      }

      const up2 = await dbxUploadJson(dbxPathNav(), nav);
      if(!up2.ok){
        setCloudState("é›²ç«¯ï¼šåŒæ­¥å¤±æ•—");
        setMsg(`âŒ è‡ªå‹•åŒæ­¥å¤±æ•—ï¼ˆnavï¼ŒHTTP ${up2.status}ï¼‰\n${up2.msg}`);
        return;
      }

      const meta = { updatedAt: Date.now() };
      const up3 = await dbxUploadJson(dbxPathMeta(), meta);
      if(!up3.ok){
        setCloudState("é›²ç«¯ï¼šéƒ¨åˆ†æˆåŠŸ");
        setMsg(`âš ï¸ auth/nav å·²ä¸Šå‚³ï¼Œä½† meta å¤±æ•—ï¼ˆHTTP ${up3.status}ï¼‰\n${up3.msg}`);
        return;
      }

      dirty = false;
      const dt = new Date(meta.updatedAt);
      const hh = String(dt.getHours()).padStart(2,"0");
      const mm = String(dt.getMinutes()).padStart(2,"0");
      const ss = String(dt.getSeconds()).padStart(2,"0");
      setCloudState(`é›²ç«¯ï¼šå·²åŒæ­¥ âœ… ${hh}:${mm}:${ss}`);
      setMsg("âœ… å·²è‡ªå‹•åŒæ­¥åˆ°é›²ç«¯ã€‚\nä½ å¯ä»¥æŒ‰ã€Œé–‹å•Ÿ /Apps ä½ç½®ã€åˆ° Dropbox ç¶²ç«™ç¢ºèªæª”æ¡ˆæ˜¯å¦å‡ºç¾ã€‚");

    } finally {
      autoPushBusy = false;
      if(autoPushPending){
        autoPushPending = false;
        if(dirty) scheduleAutoPush();
      }
    }
  }

  async function ensureCloudSeedIfMissing(){
    if(!isAdmin()) return { ok:false, msg:"é adminï¼šä¸å¯å»ºç«‹é›²ç«¯åˆå§‹æª”" };
    if(!dbxEnabled()) return { ok:false, msg:"Token æœªè¨­å®šï¼šä¸å¯å»ºç«‹é›²ç«¯åˆå§‹æª”" };

    setCloudState("é›²ç«¯ï¼šæª¢æŸ¥ä¸­â€¦");

    const okFolder = await ensureFolderExistsOnce();
    if(!okFolder){
      return { ok:false, msg:"å»ºç«‹è³‡æ–™å¤¾å¤±æ•—ï¼ˆå¯èƒ½ç¼ºå°‘ files.content.write scopeï¼‰" };
    }

    const meta = await dbxDownloadJson(dbxPathMeta());
    const auth = await dbxDownloadJson(dbxPathAuth());
    const nav  = await dbxDownloadJson(dbxPathNav());

    const missing = (!meta) || (!auth) || (!nav);
    if(!missing) return { ok:true, msg:"é›²ç«¯å·²æœ‰æª”æ¡ˆï¼Œç„¡éœ€å»ºç«‹" };

    setCloudState("é›²ç«¯ï¼šå»ºç«‹åˆå§‹æª”â€¦");
    setMsg("âš ï¸ åµæ¸¬é›²ç«¯å°šæœªæœ‰æª”æ¡ˆï¼Œæ­£åœ¨è‡ªå‹•å»ºç«‹ä¸€ä»½â€¦");

    saveTableToLocal();
    const localAuth = safeJsonParse(localStorage.getItem(AUTH_KEY) || "[]", []);
    const localNav  = safeJsonParse(localStorage.getItem(NAV_KEY)  || "[]", []);

    const up1 = await dbxUploadJson(dbxPathAuth(), localAuth);
    if(!up1.ok) return { ok:false, msg:`å»ºç«‹å¤±æ•—ï¼ˆauthï¼ŒHTTP ${up1.status}ï¼‰\n${up1.msg}` };

    const up2 = await dbxUploadJson(dbxPathNav(), localNav);
    if(!up2.ok) return { ok:false, msg:`å»ºç«‹å¤±æ•—ï¼ˆnavï¼ŒHTTP ${up2.status}ï¼‰\n${up2.msg}` };

    const newMeta = { updatedAt: Date.now() };
    const up3 = await dbxUploadJson(dbxPathMeta(), newMeta);
    if(!up3.ok) return { ok:false, msg:`å»ºç«‹å¤±æ•—ï¼ˆmetaï¼ŒHTTP ${up3.status}ï¼‰\n${up3.msg}` };

    setCloudState("é›²ç«¯ï¼šå·²å»ºç«‹ âœ…");
    setMsg("âœ… å·²è‡ªå‹•å»ºç«‹é›²ç«¯åˆå§‹æª”æ¡ˆï¼ˆä¹‹å¾Œå…¶ä»–è£ç½®å³å¯ä¸‹è¼‰/åŒæ­¥ï¼‰ã€‚\nä½ å¯ä»¥æŒ‰ã€Œé–‹å•Ÿ /Apps ä½ç½®ã€åˆ° Dropbox ç¶²ç«™æŸ¥çœ‹ã€‚");
    return { ok:true, msg:"å·²å»ºç«‹é›²ç«¯åˆå§‹æª”æ¡ˆ" };
  }

  async function pullFromCloud(){
    if(!dbxEnabled()){
      setMsg("âŒ å°šæœªè¨­å®š Tokenï¼Œç„¡æ³•å¾é›²ç«¯ä¸‹è¼‰ã€‚");
      setCloudState("é›²ç«¯ï¼šæœªè¨­å®š Token");
      return false;
    }

    setCloudState("é›²ç«¯ï¼šä¸‹è¼‰ä¸­â€¦");
    setMsg("æ­£åœ¨å¾é›²ç«¯ä¸‹è¼‰â€¦");

    try{
      let auth = await dbxDownloadJson(dbxPathAuth());
      let nav  = await dbxDownloadJson(dbxPathNav());

      if((!auth || !nav)){
        const seed = await ensureCloudSeedIfMissing();
        if(seed.ok){
          auth = await dbxDownloadJson(dbxPathAuth());
          nav  = await dbxDownloadJson(dbxPathNav());
        }else{
          setCloudState("é›²ç«¯ï¼šç„¡è³‡æ–™/æ¬Šé™ä¸è¶³");
          setMsg(
`âš ï¸ é›²ç«¯å°šæœªæœ‰æª”æ¡ˆæˆ–ç„¡æ³•å»ºç«‹ï¼ˆå¯èƒ½ token æ¬Šé™ä¸è¶³/æˆ–è¢«ç€è¦½å™¨é˜»æ“‹ï¼‰
${seed.msg}

âœ… è§£æ³•ï¼š
1) æŒ‰ã€Œè¨­å®š Tokenã€â†’ã€Œå„²å­˜ä¸¦æ¸¬è©¦ã€
2) è‹¥æç¤º scope ä¸è¶³ï¼šæŒ‰ã€Œä¸€éµå¼•å°å» Console å‹¾æ¬Šé™ã€
3) é‡æ–°ç”¢ç”Ÿæ–° Token è²¼å›ä¾†
4) å†æŒ‰ä¸€æ¬¡ã€Œå¾é›²ç«¯ä¸‹è¼‰ã€`
          );
          return false;
        }
      }

      let changed = false;
      if(auth && Array.isArray(auth)){ localStorage.setItem(AUTH_KEY, JSON.stringify(auth)); changed = true; }
      if(nav && Array.isArray(nav)){  localStorage.setItem(NAV_KEY,  JSON.stringify(nav));  changed = true; }

      if(changed){
        dirty = false;
        setCloudState("é›²ç«¯ï¼šå·²åŒæ­¥ âœ…");
        setMsg("âœ… å·²ä¸‹è¼‰é›²ç«¯è³‡æ–™ä¸¦æ›´æ–°æœ¬æ©Ÿã€‚");
        render();
        return true;
      }else{
        setCloudState("é›²ç«¯ï¼šç„¡è³‡æ–™");
        setMsg("âš ï¸ ä»è®€ä¸åˆ°æª”æ¡ˆã€‚è«‹ç¢ºèª Token èˆ‡ scopesã€‚");
        return false;
      }
    } finally {
      // âœ… ä¸è¦å¡åœ¨ã€Œä¸‹è¼‰ä¸­â€¦ã€
      if(dirty) setCloudState("é›²ç«¯ï¼šå¾…åŒæ­¥");
    }
  }

  async function manualPush(){
    markDirty("æº–å‚™æ‰‹å‹•åŒæ­¥â€¦");
    await autoPushNow();
  }

  // ==========================
  // Token Save & Test
  // ==========================
  async function saveAndTestToken(){
    const appName = String(appNameInput.value || "").trim() || DEFAULT_APPNAME;
    setAppName(appName);

    const t = String(tokenInput.value||"").trim();
    if(!t){
      tokenMsg.textContent = "è«‹å…ˆè²¼ä¸Š Tokenã€‚";
      return;
    }

    setDbxToken(t);

    tokenMsg.textContent = "æ­£åœ¨æ¸¬è©¦ Tokenâ€¦";
    const acct = await getCurrentAccount();
    if(!acct.ok){
      tokenMsg.textContent =
        acct.msg +
        "\n\nâœ… è‹¥ä½ å‰›åœ¨ Console å‹¾æ¬Šé™ï¼Œè«‹æ³¨æ„ï¼šè¦é‡æ–°ç”¢ç”Ÿæ–°çš„ Access Tokenï¼ˆèˆŠ token å¯èƒ½æ²’æœ‰æ–°æ¬Šé™ï¼‰ã€‚";
      setCloudState("é›²ç«¯ï¼šToken ç„¡æ•ˆ");
      return;
    }

    let emailHint = "";
    if(acct.email && acct.email.toLowerCase() !== EXPECT_EMAIL.toLowerCase()){
      emailHint = `\nâš ï¸ é€™å€‹ token å°æ‡‰ emailï¼š${acct.email}\nä½ æœŸæœ›ï¼š${EXPECT_EMAIL}\nï¼ˆè‹¥ä¸ä¸€è‡´ï¼Œè¡¨ç¤ºä½ å¯èƒ½åœ¨å¦ä¸€å€‹ Dropbox å¸³è™Ÿç”¢ç”Ÿ tokenï¼‰`;
    }else if(acct.email){
      emailHint = `\nâœ… token å°æ‡‰ emailï¼š${acct.email}`;
    }else{
      emailHint = `\nâš ï¸ API æœªå› emailï¼ˆä»å¯ç”¨ï¼‰ã€‚`;
    }

    tokenMsg.textContent = acct.msg + emailHint + "\n\næ­£åœ¨æ¸¬è©¦å»ºç«‹è³‡æ–™å¤¾èˆ‡ä¸Šå‚³æ¬Šé™â€¦";
    setCloudState("é›²ç«¯ï¼šæ¸¬è©¦ä¸­â€¦");

    const r = await dbxPostJson("https://api.dropboxapi.com/2/files/create_folder_v2", {
      path: getDbxFolder(),
      autorename: false
    });

    if(!r.ok){
      const isScope = detectScopeErrorText(r.text);
      tokenMsg.textContent =
        acct.msg + emailHint +
        `\n\nâŒ å»ºç«‹è³‡æ–™å¤¾å¤±æ•—ï¼ˆHTTP ${r.status}ï¼‰\n` +
        (isScope
          ? "åŸå› ï¼šApp æ²’æœ‰ files.content.write scopeï¼Œæˆ–ä½ æ²’æœ‰é‡æ–°ç”¢ç”Ÿæ–° tokenã€‚\n\næŒ‰ã€Œä¸€éµå¼•å°å» Console å‹¾æ¬Šé™ã€ï¼Œå®Œæˆå¾Œå†å›ä¾†è²¼æ–° tokenã€‚"
          : "è«‹æª¢æŸ¥ Token æˆ– Dropbox å›æ‡‰ï¼š\n" + r.text);

      setCloudState("é›²ç«¯ï¼šæ¬Šé™ä¸è¶³/å¤±æ•—");

      const go = confirm("åµæ¸¬åˆ°å¯èƒ½æ˜¯ scopes ä¸è¶³ï¼ˆfiles.content.writeï¼‰ã€‚\n\nè¦ç¾åœ¨é–‹å§‹å¼•å°å» Dropbox Console å‹¾æ¬Šé™å—ï¼Ÿ");
      if(go) guideToConsole();
      return;
    }

    ensureFolderExistsOnce.done = true;

    const seed = await ensureCloudSeedIfMissing();

    tokenMsg.textContent =
      acct.msg + emailHint +
      "\n\nâœ… Token æ¸¬è©¦æˆåŠŸï¼\n" +
      `âœ… å·²å»ºç«‹/ç¢ºèªè³‡æ–™å¤¾ï¼š${getDbxFolder()}\n` +
      (seed.ok ? "âœ… å·²ç¢ºä¿é›²ç«¯æœ‰ 3 å€‹ JSON æª”ï¼ˆauth/nav/metaï¼‰ã€‚\n" : `âš ï¸ å»ºæª”æé†’ï¼š${seed.msg}\n`) +
      "\nDropbox ç¶²ç«™ä½ç½®ï¼ˆä½ ç™»å…¥å¾Œå¯çœ‹åˆ°ï¼‰ï¼š\n" + getAppsWebUrl();

    setCloudState("é›²ç«¯ï¼šToken OK âœ…");
  }

  // ==========================
  // events
  // ==========================
  btnBack.addEventListener("click", ()=> location.href = "index.html");

  btnApps.addEventListener("click", ()=>{
    const ok = confirm("å°‡é–‹å•Ÿ Dropbox ç¶²ç«™çš„ /Apps ä½ç½®ã€‚\n\næé†’ï¼šè«‹ä½¿ç”¨ " + EXPECT_EMAIL + " ç™»å…¥ã€‚\n\næ˜¯å¦é–‹å•Ÿï¼Ÿ");
    if(ok) window.open(getAppsWebUrl(), "_blank", "noopener");
  });

  btnOpenAppsHere.addEventListener("click", ()=>{
    const ok = confirm("å°‡é–‹å•Ÿï¼š\n" + getAppsWebUrl() + "\n\næé†’ï¼šè«‹ä½¿ç”¨ " + EXPECT_EMAIL + " ç™»å…¥ã€‚\n\næ˜¯å¦é–‹å•Ÿï¼Ÿ");
    if(ok) window.open(getAppsWebUrl(), "_blank", "noopener");
  });

  btnAdd.addEventListener("click", ()=>{
    if(!isAdmin()){
      setMsg("âŒ åªæœ‰ admin å¯ä»¥æ–°å¢ã€‚");
      return;
    }
    const nav = loadNav();
    const arr = loadAuth(nav.length);
    arr.push({ username:"", password:"", level:"read", buttons: Array(nav.length).fill(false) });
    localStorage.setItem(AUTH_KEY, JSON.stringify(arr));
    render();
    markDirty("å·²æ–°å¢ä¸€åˆ—ï¼Œæº–å‚™è‡ªå‹•åŒæ­¥â€¦");
  });

  btnPull.addEventListener("click", pullFromCloud);
  btnPush.addEventListener("click", manualPush);

  btnToken.addEventListener("click", ()=>{
    tokenOverlay.style.display = "flex";
    tokenOverlay.setAttribute("aria-hidden","false");

    appNameInput.value = getAppName();
    tokenInput.value = getDbxToken();

    tokenMsg.textContent = "æç¤ºï¼šè‹¥ä½ çœ‹åˆ° HTTP 400 / missing_scope / files.content.writeï¼Œä»£è¡¨ scopes ä¸è¶³æˆ– token æ²’é‡æ–°ç”¢ç”Ÿã€‚\næŒ‰ã€Œå„²å­˜ä¸¦æ¸¬è©¦ã€æœƒè‡ªå‹•åµæ¸¬ä¸¦å¼•å°ã€‚";
    setTimeout(()=> tokenInput.focus(), 40);
  });

  btnGuide.addEventListener("click", guideToConsole);

  tokenEye.addEventListener("click", ()=> tokenInput.type = (tokenInput.type==="password") ? "text" : "password");
  tokenClose.addEventListener("click", ()=>{
    tokenOverlay.style.display = "none";
    tokenOverlay.setAttribute("aria-hidden","true");
  });

  tokenSaveTest.addEventListener("click", saveAndTestToken);

  // âœ… ç›£è½ä»»ä½•æ¬„ä½è®Šæ›´ â†’ è‡ªå‹•åŒæ­¥
  function onAnyTableEdit(e){
    if(!isAdmin()) return;
    if(!e || !e.target) return;
    if(!e.target.closest("#tbl")) return;
    markDirty("å·²ä¿®æ”¹ï¼Œæº–å‚™è‡ªå‹•åŒæ­¥â€¦");
  }
  tbl.addEventListener("input",  onAnyTableEdit, true);
  tbl.addEventListener("change", onAnyTableEdit, true);

  // ==========================
  // boot
  // ==========================
  (function boot(){
    const cu = getCurrentUser();
    const r = String((cu && (cu.level || cu.role)) || "").toLowerCase();
    who.textContent = cu ? `ç›®å‰ï¼š${cu.username} (${r || cu.level || cu.role})` : "ç›®å‰ï¼šæœªç™»å…¥";

    if(!isAdmin()){
      setMsg("âš ï¸ åªæœ‰ admin å¯ä»¥ç·¨è¼¯èˆ‡åŒæ­¥ã€‚\nè«‹å…ˆå›é¦–é ç”¨ alex(admin) ç™»å…¥å¾Œå†é€²ä¾†ã€‚");
      setCloudState("é›²ç«¯ï¼šåƒ… admin å¯åŒæ­¥");
    }else{
      setCloudState(dbxEnabled() ? "é›²ç«¯ï¼šToken å·²è¨­å®š" : "é›²ç«¯ï¼šæœªè¨­å®š Token");
    }

    render();
  })();
</script>
</body>
</html>
