<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Tasun 權限表</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --gold:#f6d37a;
      --gold2:#e6c061;
      --bg:#050302;
      --stroke: rgba(246,211,122,.26);
      --panel: rgba(0,0,0,.38);
      --panel2: rgba(0,0,0,.22);
      --shadow: rgba(0,0,0,.60);
      --safe: clamp(14px, 2.2vw, 22px);
      --radius: 22px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:"Noto Serif TC", system-ui, -apple-system, "Microsoft JhengHei", sans-serif;
      color: var(--gold);
      background:
        radial-gradient(circle at 18% 10%, rgba(246,211,122,.14) 0, transparent 42%),
        radial-gradient(circle at 84% 88%, rgba(246,211,122,.12) 0, transparent 46%),
        linear-gradient(180deg, #070604 0%, #050302 55%, #040202 100%);
      overflow-x:hidden;
    }

    .frame{
      min-height:100vh;
      padding: var(--safe);
      display:flex;
      align-items:flex-start;
      justify-content:center;
    }

    .shell{
      width:min(1280px, 96vw);
      border-radius: 26px;
      background:
        radial-gradient(circle at 50% 0%, rgba(246,211,122,.14) 0, rgba(0,0,0,.10) 55%, rgba(0,0,0,.24) 100%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.18));
      box-shadow: 0 18px 60px rgba(0,0,0,.55), inset 0 0 0 1px rgba(246,211,122,.10);
      overflow:hidden;
      position:relative;
      padding-bottom: 16px;
    }

    .topbar{
      display:flex;
      gap: 10px;
      padding: 14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .leftGroup, .rightGroup{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(0,0,0,.40);
      border: 1px solid rgba(246,211,122,.22);
      box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.04);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      white-space:nowrap;
      gap:10px;
    }

    .btn{
      cursor:pointer;
      user-select:none;
      appearance:none;
      outline:none;
      font: inherit;
      color: var(--gold);
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.28);
      padding: 10px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.18));
      box-shadow: 0 10px 28px rgba(0,0,0,.38), inset 0 0 0 1px rgba(255,255,255,.04);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      white-space:nowrap;
      transition: filter .15s ease, transform .08s ease, opacity .15s ease;
    }
    .btn:hover{ filter: brightness(1.05); }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{
      opacity:.42;
      cursor:not-allowed;
      filter: none !important;
      transform:none !important;
    }

    .btn-token-link{
      border-color: rgba(255,244,208,.55);
      box-shadow: 0 10px 28px rgba(0,0,0,.40), 0 0 18px rgba(246,211,122,.20);
    }

    .header{
      padding: 10px 20px 8px;
      border-top: 1px solid rgba(246,211,122,.10);
      border-bottom: 1px solid rgba(246,211,122,.10);
      background: rgba(0,0,0,.18);
    }
    .header h1{
      margin: 0;
      font-size: clamp(36px, 4.3vw, 56px);
      letter-spacing: .20em;
      text-shadow: 0 8px 24px rgba(0,0,0,.62);
    }
    .header p{
      margin: 8px 0 0;
      opacity:.9;
      letter-spacing:.08em;
      line-height:1.7;
      font-size: 13px;
      color: rgba(246,211,122,.86);
    }

    .content{ padding: 14px 14px 8px; }

    /* ===== 入口網頁選擇 + 預覽 ===== */
    .entryBox{
      margin-top: 10px;
      border-radius: 18px;
      border: 1px solid rgba(246,211,122,.12);
      background: rgba(0,0,0,.18);
      box-shadow: 0 14px 40px rgba(0,0,0,.38), inset 0 0 0 1px rgba(255,255,255,.02);
      overflow:hidden;
    }
    .entryHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(246,211,122,.10);
      background: rgba(0,0,0,.14);
      flex-wrap:wrap;
    }
    .entryHead strong{
      letter-spacing:.12em;
    }
    .entryBody{
      padding: 12px 14px 14px;
      display:grid;
      grid-template-columns: 110px 1fr;
      gap:10px 12px;
      align-items:center;
    }
    .entryLabel{
      font-size: 12px;
      letter-spacing:.10em;
      opacity:.92;
      white-space:nowrap;
    }
    .entryRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .field{
      width: 100%;
      max-width: 320px;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.20);
      background: rgba(0,0,0,.34);
      color: var(--gold);
      padding: 10px 12px;
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
      font-family: inherit;
    }
    select.field{ max-width: 520px; }

    .entryHint{
      grid-column: 1 / -1;
      font-size: 12px;
      opacity:.92;
      letter-spacing:.06em;
      line-height:1.7;
      color: rgba(246,211,122,.86);
    }

    .previewStage{
      grid-column: 1 / -1;
      padding-top: 6px;
    }
    .previewTitle{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin: 6px 0 10px;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.20);
      background: rgba(0,0,0,.26);
      box-shadow: 0 10px 26px rgba(0,0,0,.30);
      white-space:nowrap;
      font-size: 12px;
      letter-spacing:.06em;
    }
    .tag b{ color: rgba(255,244,208,.95); }

    .previewGrid{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:stretch;
      justify-content:flex-start;
    }
    .navPill{
      flex: 1 1 240px;
      min-width: 240px;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.22);
      background:
        radial-gradient(120% 160% at 35% 0%, rgba(255,255,255,.06), transparent 58%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.18));
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      letter-spacing:.08em;
      font-weight:900;
      color: rgba(246,211,122,.96);
      text-shadow: 0 0 16px rgba(246,211,122,.14);
      user-select:none;
    }
    .navPill.dim{
      opacity:.38;
      filter: grayscale(.15);
    }
    .navPill small{
      font-weight:700;
      opacity:.85;
      letter-spacing:.06em;
    }

    .tableWrap{
      width:100%;
      overflow:auto;
      border-radius: 18px;
      border: 1px solid rgba(246,211,122,.10);
      background: rgba(0,0,0,.16);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
      margin-top: 12px;
    }
    table{
      width: 100%;
      border-collapse: collapse;
      min-width: 980px;
    }
    thead th{
      position:sticky;
      top:0;
      z-index:2;
      background: rgba(0,0,0,.42);
      border-bottom: 1px solid rgba(246,211,122,.12);
      padding: 12px 10px;
      font-size: 13px;
      letter-spacing:.12em;
      color: rgba(246,211,122,.92);
      text-align:center;
      white-space:nowrap;
    }
    tbody td{
      padding: 12px 10px;
      border-bottom: 1px solid rgba(246,211,122,.08);
      text-align:center;
      vertical-align:middle;
    }

    .chk{
      width: 18px;
      height: 18px;
      accent-color: var(--gold);
      cursor:pointer;
    }
    .delBtn{
      padding: 9px 14px;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.20);
      background: rgba(0,0,0,.32);
      color: var(--gold);
      cursor:pointer;
    }
    .delBtn[disabled]{ opacity:.42; cursor:not-allowed; }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      padding: 12px 6px 0;
    }
    .actions .left{ display:flex; gap:10px; flex-wrap:wrap; }
    .status{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      font-size: 13px;
      opacity:.92;
    }

    .msg{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(246,211,122,.12);
      background: rgba(0,0,0,.18);
      color: rgba(246,211,122,.88);
      white-space:pre-wrap;
      line-height:1.6;
      min-height: 44px;
    }

    /* ✅ 按鍵名稱設定面板 */
    .navPanel{
      margin-top: 10px;
      border-radius: 18px;
      border: 1px solid rgba(246,211,122,.12);
      background: rgba(0,0,0,.18);
      box-shadow: 0 14px 40px rgba(0,0,0,.38), inset 0 0 0 1px rgba(255,255,255,.02);
      overflow:hidden;
      display:none;
    }
    .navPanel.show{ display:block; }
    .navPanelHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(246,211,122,.10);
      background: rgba(0,0,0,.14);
    }
    .navPanelHead strong{
      letter-spacing:.12em;
    }
    .navGrid{
      padding: 12px 14px 14px;
      display:grid;
      grid-template-columns: 90px 1fr;
      gap:10px 12px;
      align-items:center;
    }
    .navHint{
      grid-column: 1 / -1;
      font-size: 12px;
      opacity:.9;
      letter-spacing:.06em;
      line-height:1.6;
      color: rgba(246,211,122,.86);
    }
    .navLabel{
      font-size: 12px;
      letter-spacing:.10em;
      opacity:.92;
      white-space:nowrap;
    }
    .navActions{
      padding: 0 14px 14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .topbarMobile{
      display:none;
      padding: 12px 14px;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(246,211,122,.10);
      background: rgba(0,0,0,.16);
    }
    .moreWrap{ position:relative; }
    .menu{
      position:absolute;
      right:0;
      top: calc(100% + 8px);
      min-width: 220px;
      border-radius: 16px;
      border: 1px solid rgba(246,211,122,.18);
      background: rgba(0,0,0,.66);
      box-shadow: 0 18px 50px rgba(0,0,0,.65);
      overflow:hidden;
      display:none;
      z-index: 10;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .menu.show{ display:block; }
    .menu button{
      width:100%;
      text-align:left;
      border:0;
      background:transparent;
      color: var(--gold);
      padding: 12px 14px;
      cursor:pointer;
      font: inherit;
      border-bottom: 1px solid rgba(246,211,122,.10);
    }
    .menu button:last-child{ border-bottom:0; }
    .menu button:hover{ background: rgba(255,255,255,.04); }
    .menu button[disabled]{ opacity:.45; cursor:not-allowed; }

    .cards{ display:none; margin-top: 10px; gap: 12px; }
    .card{
      border-radius: 18px;
      border: 1px solid rgba(246,211,122,.12);
      background: rgba(0,0,0,.18);
      box-shadow: 0 14px 40px rgba(0,0,0,.38), inset 0 0 0 1px rgba(255,255,255,.02);
      overflow:hidden;
    }
    .cardHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 14px;
      cursor:pointer;
    }
    .cardHead .who{ display:flex; flex-direction:column; gap:4px; }
    .cardHead .who strong{ letter-spacing:.10em; }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size: 12px;
      opacity:.92;
      border:1px solid rgba(246,211,122,.16);
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(0,0,0,.22);
      white-space:nowrap;
    }
    .chev{ opacity:.9; }
    .cardBody{
      display:none;
      padding: 0 14px 14px;
      border-top: 1px solid rgba(246,211,122,.10);
    }
    .card.open .cardBody{ display:block; }

    .grid2{ display:grid; grid-template-columns: 1fr; gap: 10px; margin-top: 12px; }
    .rowLabel{ font-size: 12px; opacity:.9; letter-spacing:.08em; margin-top: 8px; }

    .permScroll{ overflow-x:auto; padding: 10px 0 2px; }
    .permRow{ display:flex; gap:10px; min-width: max-content; align-items:center; }
    .permItem{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.14);
      background: rgba(0,0,0,.22);
      white-space:nowrap;
    }
    .permItem span{ font-size: 12px; opacity:.92; letter-spacing:.06em; }

    .cardActions{ margin-top: 12px; display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    @media (max-width: 980px){
      .topbar{ display:none; }
      .topbarMobile{ display:flex; }
      .tableWrap{ display:none; }
      .cards{ display:flex; flex-direction:column; }
      .navGrid{ grid-template-columns: 78px 1fr; }
      .entryBody{ grid-template-columns: 1fr; }
      .entryLabel{ display:none; }
      .navPill{ min-width: 100%; }
    }
  </style>
</head>

<body>
  <div class="frame">
    <div class="shell">

      <!-- Mobile topbar -->
      <div class="topbarMobile">
        <div class="pill" id="whoMobile">目前使用者：—</div>

        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn" id="backBtnM">返回</button>
          <div class="moreWrap">
            <button class="btn" id="moreBtn">更多</button>
            <div class="menu" id="moreMenu">
              <button id="switchBtnM">切換帳號</button>
              <button id="navNameBtnM">按鍵名稱設定</button>
              <button id="downloadTokenBtnM">下載Token（Dropbox）</button>
              <button id="tokenBtnM">設定 Token</button>
              <button id="downloadBtnM">雲端下載</button>
              <button id="uploadBtnM">儲存並上傳</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Desktop topbar -->
      <div class="topbar">
        <div class="leftGroup">
          <div class="pill" id="whoDesk">目前使用者：—</div>
          <button class="btn" id="switchBtnD">切換帳號</button>
          <button class="btn" id="navNameBtnD">按鍵名稱設定</button>
        </div>
        <div class="rightGroup">
          <button class="btn" id="backBtnD">返回首頁</button>
          <button class="btn btn-token-link" id="downloadTokenBtnD">下載Token（Dropbox）</button>
          <button class="btn" id="tokenBtnD">設定 Token</button>
          <button class="btn" id="downloadBtnD">雲端下載</button>
          <button class="btn" id="uploadBtnD">儲存並上傳</button>
        </div>
      </div>

      <div class="header">
        <h1>Tasun 權限表</h1>
        <p>
          只有 <b>admin</b> 可以編輯；其他權限只能查看。<br>
          ✅ 入口網頁下拉選單：依你提供的檔名清單建立。選擇入口網頁後，下方欄位與預覽會切換到該入口頁。<br>
          ✅ btn1～btn5 欄位標題仍會自動抓取首頁按鍵名稱（localStorage：<b>tasunNavButtons_v1</b>）。<br>
          ✅ admin 也可在本頁「按鍵名稱設定」直接改名，並同步到首頁。<br>
          雲端模式（App folder）：<b>/權限表.json</b>
        </p>
      </div>

      <div class="content">

        <!-- ✅ 入口網頁選擇 + 預覽 -->
        <div class="entryBox" id="entryBox">
          <div class="entryHead">
            <strong>入口網頁選擇（用來管控該入口頁的按鍵顯示）</strong>
            <button class="btn" id="entryResetBtn">回到預設入口</button>
          </div>

          <div class="entryBody">
            <div class="entryLabel">入口網頁</div>
            <div class="entryRow">
              <select class="field" id="entrySelect"></select>
              <input class="field" id="entryCustom" placeholder="（其他）請輸入檔名，例如：汐東工程管理表.html" style="display:none; max-width: 520px;">
            </div>

            <div class="entryHint">
              說明：先選擇「入口網頁」，下方會出現預覽方塊（沿用 index 的玻璃金色按鍵語感）顯示該入口頁按鍵。<br>
              勾選的權限會存到 localStorage：<b>tasunPermMatrix_v1</b>（不破壞原本 tasunAuthTable_v1）。
            </div>

            <div class="previewStage">
              <div class="previewTitle">
                <div class="tag">目前選擇入口：<b id="entryNameTag">—</b></div>
                <div class="tag">預覽依「目前使用者」：<b id="previewUserTag">—</b></div>
              </div>
              <div class="previewGrid" id="previewGrid"></div>
            </div>
          </div>
        </div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr id="theadRow">
                <th>使用者</th>
                <th>密碼</th>
                <th>權限</th>
                <th class="sysCol">系統/權限</th>
                <th>刪除</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="cards" id="cards"></div>

        <div class="actions">
          <div class="left">
            <button class="btn" id="addBtn">＋ 新增一列</button>
            <button class="btn" id="saveLocalBtn">只儲存本機</button>
          </div>
          <div class="status">
            <div class="pill" id="tokenState">狀態：未設定 Token</div>
            <div class="pill" id="localState">本機：未儲存</div>
          </div>
        </div>

        <!-- ✅ 按鍵名稱設定 -->
        <div class="navPanel" id="navPanel">
          <div class="navPanelHead">
            <strong>按鍵名稱設定（btn1～btn5）</strong>
            <button class="btn" id="navCloseBtn">關閉</button>
          </div>
          <div class="navGrid">
            <div class="navHint">
              說明：這裡修改的是「首頁按鍵名稱」。儲存後會寫入 localStorage：<b>tasunNavButtons_v1</b>（並更新 <b>tasunRoutes_v1</b>），首頁/其他分頁會自動同步。<br>
              提醒：<b>btn2</b> 連結固定為「汐東工程管理表.html」，不受名稱影響。
            </div>

            <div class="navLabel">btn1</div>
            <input class="field" id="navName1" placeholder="btn1 名稱">

            <div class="navLabel">btn2</div>
            <input class="field" id="navName2" placeholder="btn2 名稱">

            <div class="navLabel">btn3</div>
            <input class="field" id="navName3" placeholder="btn3 名稱">

            <div class="navLabel">btn4</div>
            <input class="field" id="navName4" placeholder="btn4 名稱">

            <div class="navLabel">btn5</div>
            <input class="field" id="navName5" placeholder="btn5 名稱">
          </div>

          <div class="navActions">
            <button class="btn" id="navReloadBtn">重新讀取目前名稱</button>
            <button class="btn" id="navSaveBtn">儲存並同步</button>
          </div>
        </div>

        <div class="msg" id="msg"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const AUTH_KEY     = 'tasunAuthTable_v1';
  const CURRENT_KEY  = 'tasunCurrentUser_v1';
  const TOKEN_KEY    = 'tasunDropboxToken_v1';

  const NAV_KEY      = 'tasunNavButtons_v1';
  const ROUTE_KEY    = 'tasunRoutes_v1';
  const BTN_META_KEY = 'tasunButtonMeta_v1';

  const ENTRY_SELECTED_KEY = 'tasunEntrySelected_v1';
  const PERM_MATRIX_KEY    = 'tasunPermMatrix_v1';

  const DROPBOX_PATH = '/權限表.json';
  const TOKEN_DOWNLOAD_URL = 'https://www.dropbox.com/developers/apps';

  const METRO_FIXED_HREF = '汐東工程管理表.html';
  const roleOptions = ['admin','write','read'];

  const el = (id) => document.getElementById(id);

  const whoDesk   = el('whoDesk');
  const whoMobile = el('whoMobile');

  const tbody     = el('tbody');
  const theadRow  = el('theadRow');
  const cards     = el('cards');

  const msg       = el('msg');
  const tokenState= el('tokenState');
  const localState= el('localState');

  const addBtn    = el('addBtn');
  const saveLocalBtn = el('saveLocalBtn');

  const backBtnD  = el('backBtnD');
  const backBtnM  = el('backBtnM');

  const switchBtnD= el('switchBtnD');
  const switchBtnM= el('switchBtnM');

  const tokenBtnD = el('tokenBtnD');
  const tokenBtnM = el('tokenBtnM');

  const downloadBtnD = el('downloadBtnD');
  const downloadBtnM = el('downloadBtnM');

  const uploadBtnD = el('uploadBtnD');
  const uploadBtnM = el('uploadBtnM');

  const moreBtn   = el('moreBtn');
  const moreMenu  = el('moreMenu');

  const downloadTokenBtnD = el('downloadTokenBtnD');
  const downloadTokenBtnM = el('downloadTokenBtnM');

  const navPanel   = el('navPanel');
  const navCloseBtn= el('navCloseBtn');
  const navReloadBtn=el('navReloadBtn');
  const navSaveBtn = el('navSaveBtn');
  const navNameBtnD= el('navNameBtnD');
  const navNameBtnM= el('navNameBtnM');
  const navName1   = el('navName1');
  const navName2   = el('navName2');
  const navName3   = el('navName3');
  const navName4   = el('navName4');
  const navName5   = el('navName5');

  const entrySelect   = el('entrySelect');
  const entryCustom   = el('entryCustom');
  const entryResetBtn = el('entryResetBtn');
  const entryNameTag  = el('entryNameTag');
  const previewUserTag= el('previewUserTag');
  const previewGrid   = el('previewGrid');

  let auth = [];
  let btnMeta = [];
  let current = null;
  let isAdmin = false;

  let currentEntry = 'index.html';
  let permMatrix = { users:{} };

  let tokenExpired = false;
  let tokenInvalid = false;

  // ✅✅✅ 入口網頁清單（完全依你提供順序）
  const ENTRY_FILES = [
    'index.html',
    '工程資料庫.html',
    '工程資料明細表.html',
    '工程資料查詢.html',
    '工程資料登錄.html',
    '捷運汐東線審查文件管制查詢表-水環組.html',
    '捷運汐東線審查文件管制登錄表-水環組.html',
    '捷運汐東線審查文件管制表-水環組.html',
    '捷運汐東線權責分工精簡版.html',
    '捷運汐東線記事.html',
    '捷運汐止東湖線統包工程-資料庫.html',
    '捷運汐止東湖線統包工程-資料明細表.html',
    '捷運汐止東湖線統包工程-資料明細表查詢.html',
    '捷運汐止東湖線統包工程-資料明細表登錄.html',
    '權限表.html',
    '汐東工程管理表.html',
    '甄鼎quality.html',
    '臻鼎工程審核明細查詢.html',
    '臻鼎工程審核明細登錄.html',
    '臻鼎工程審核明細表.html',
    '臻鼎管理表.html'
  ];

  // 入口頁 → 按鍵定義（沒有定義的入口頁，會用 btn1~btn5 通用欄位顯示）
  const ENTRY_BUTTONS = {
    '汐東工程管理表.html': [
      { key:'xidong_record', name:'捷運汐東線事項記錄' },
      { key:'xidong_db',     name:'工程資料庫' },
      { key:'xidong_auth',   name:'系統／權限' },
      { key:'xidong_cloud',  name:'雲端檔案' }
    ],
    '工程資料庫.html': [
      { key:'db_reg',   name:'工程資料登錄' },
      { key:'db_query', name:'工程資料查詢' },
      { key:'db_list',  name:'工程資料明細表' },
      { key:'db_cloud', name:'雲端資料庫入口' }
    ],
    '權限表.html': [
      { key:'auth_navname', name:'按鍵名稱設定' },
      { key:'auth_token',   name:'設定 Token' },
      { key:'auth_down',    name:'雲端下載' },
      { key:'auth_up',      name:'儲存並上傳' }
    ]
  };

  function safeJsonParse(s, fallback){
    try{ return JSON.parse(s); }catch(e){ return fallback; }
  }
  function stripInvisibles(s){
    return String(s ?? '')
      .replace(/\uFEFF/g, '')
      .replace(/[\u0000-\u001F\u007F]/g,'')
      .trim();
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function setMsg(text, isError=false){
    msg.style.color = isError ? 'rgba(255,170,170,.95)' : 'rgba(246,211,122,.88)';
    msg.textContent = text || '';
  }
  function userKey(name){ return String(name||'').trim().toLowerCase(); }

  function sanitizeToken(raw){
    let t = stripInvisibles(raw);
    t = t.replace(/^Bearer\s+/i, '');
    t = t.replace(/^Token\s*:\s*/i, '');
    t = t.replace(/^["'`]/, '').replace(/["'`]$/, '');
    t = t.replace(/[^\x21-\x7E]/g, '');
    return t.trim();
  }
  function isTokenLooksValid(token){
    const t = sanitizeToken(token);
    if(t.length < 20) return false;
    if(!/^[A-Za-z0-9._-]+$/.test(t)) return false;
    return true;
  }
  function getToken(){ return sanitizeToken(localStorage.getItem(TOKEN_KEY) || ''); }
  function clearTokenFlags(){ tokenExpired = false; tokenInvalid = false; }

  function markTokenExpired(reasonText){
    tokenExpired = true; tokenInvalid = false;
    setMsg(
      'Token 已過期（expired_access_token）。\n' +
      '請先點「下載Token（Dropbox）」產生新 Token，再按「設定 Token」貼上。\n' +
      (reasonText ? `（原因：${reasonText}）` : ''),
      true
    );
    updateStates();
  }
  function markTokenInvalid(reasonText){
    tokenInvalid = true; tokenExpired = false;
    setMsg(
      'Token 格式不正確（malformed_access_token）。\n' +
      '請點「下載Token（Dropbox）」重新產生 Token，再按「設定 Token」貼上。\n' +
      (reasonText ? `（原因：${reasonText}）` : ''),
      true
    );
    updateStates();
  }

  function askTokenIfNeeded(reasonText){
    const old = (localStorage.getItem(TOKEN_KEY) || '').trim();
    const tip = reasonText ? `\n\n（原因：${reasonText}）` : '';
    const t = prompt('請貼上 Dropbox Access Token（僅儲存在本機瀏覽器）' + tip, old);
    if(t === null) return null;

    const cleaned = sanitizeToken(t);
    localStorage.setItem(TOKEN_KEY, cleaned);

    clearTokenFlags();

    if(cleaned && !isTokenLooksValid(cleaned)){
      markTokenInvalid('貼上的內容不像 Dropbox Access Token');
      return cleaned;
    }
    updateStates('已更新 Token。');
    return cleaned;
  }

  function seedAuthIfMissing(){
    const a = safeJsonParse(localStorage.getItem(AUTH_KEY) || 'null', null);
    if(Array.isArray(a) && a.length) return;

    const seed = [
      { user:'alex',  pass:'Tasun08040224', role:'admin' },
      { user:'JOYCE', pass:'09220224',      role:'admin' },
      { user:'tasun', pass:'tasun08040224', role:'write' },
      { user:'wu',    pass:'123456',        role:'read'  },
    ];
    localStorage.setItem(AUTH_KEY, JSON.stringify(seed));
  }

  function normalizeAuth(){
    auth.forEach(u => {
      const r = String(u.role||'read').toLowerCase();
      u.role = roleOptions.includes(r) ? r : 'read';
      u.user = String(u.user||'').trim();
      u.pass = String(u.pass||'');
    });
    auth = auth.filter(u => (u.user||'').trim() !== '');
  }

  function getEffectiveRole(){
    const cu = String(current?.user || '').toLowerCase();
    const row = auth.find(a => String(a.user||'').toLowerCase() === cu);
    return String(row?.role || current?.role || 'read').toLowerCase();
  }

  function updateWho(){
    const t = `目前使用者：${current.user} (${current.role})`;
    whoDesk.textContent = t;
    whoMobile.textContent = t;
  }

  function loadPermMatrix(){
    const raw = safeJsonParse(localStorage.getItem(PERM_MATRIX_KEY) || 'null', null);
    if(raw && typeof raw === 'object'){
      permMatrix = raw;
      if(!permMatrix.users || typeof permMatrix.users !== 'object') permMatrix.users = {};
      return;
    }
    permMatrix = { users:{} };
  }
  function savePermMatrix(){
    localStorage.setItem(PERM_MATRIX_KEY, JSON.stringify(permMatrix));
  }
  function ensureUserEntry(uName){
    const k = userKey(uName);
    if(!k) return null;
    if(!permMatrix.users[k]) permMatrix.users[k] = {};
    return permMatrix.users[k];
  }
  function ensureEntryPerm(uName, entryFile){
    const u = ensureUserEntry(uName);
    if(!u) return null;
    const e = String(entryFile||'').trim() || 'index.html';
    if(!u[e] || typeof u[e] !== 'object') u[e] = {};
    return u[e];
  }
  function getPerm(uName, entryFile, btnKey){
    const e = ensureEntryPerm(uName, entryFile);
    if(!e) return false;
    return !!e[String(btnKey||'')];
  }
  function setPerm(uName, entryFile, btnKey, val){
    const e = ensureEntryPerm(uName, entryFile);
    if(!e) return;
    e[String(btnKey||'')] = !!val;
  }

  function loadSelectedEntry(){
    const s = stripInvisibles(localStorage.getItem(ENTRY_SELECTED_KEY) || '') || 'index.html';
    currentEntry = s;
  }
  function saveSelectedEntry(v){
    currentEntry = stripInvisibles(v) || 'index.html';
    localStorage.setItem(ENTRY_SELECTED_KEY, currentEntry);
  }

  function buildEntrySelect(){
    const opts = [];
    const uniq = Array.from(new Set(ENTRY_FILES.filter(Boolean)));
    uniq.forEach(f => {
      const vv = f.replace(/"/g,'&quot;');
      opts.push(`<option value="${vv}">${f}</option>`);
    });
    opts.push(`<option value="__custom__">（其他）手動輸入…</option>`);
    entrySelect.innerHTML = opts.join('');
  }

  function applyEntrySelectionUI(){
    const v = entrySelect.value;
    if(v === '__custom__'){
      entryCustom.style.display = '';
      entryCustom.focus();
    }else{
      entryCustom.style.display = 'none';
    }
  }

  function resolveEntryValue(){
    const v = entrySelect.value;
    if(v === '__custom__'){
      const c = stripInvisibles(entryCustom.value);
      return c || 'index.html';
    }
    return v || 'index.html';
  }

  function buildBtnMetaFromNavKey(){
    const arr = safeJsonParse(localStorage.getItem(NAV_KEY) || '[]', []);
    if(!Array.isArray(arr) || !arr.length) return null;

    const map = new Map(arr.map(x => [String(x.id||'').toLowerCase(), x]));
    const out = [];
    for(let i=1;i<=5;i++){
      const id = `btn${i}`;
      const hit = map.get(id);
      const name = String(hit?.label || id).trim() || id;
      out.push({ key:id, name });
    }
    return out;
  }

  function ensureBtnMetaByEntry(){
    const entry = resolveEntryValue();

    if(entry === 'index.html'){
      const fromNav = buildBtnMetaFromNavKey();
      if(fromNav && fromNav.length){
        btnMeta = fromNav;
        localStorage.setItem(BTN_META_KEY, JSON.stringify(btnMeta));
        return;
      }
      btnMeta = [
        { key:'btn1', name:'btn1' },
        { key:'btn2', name:'btn2' },
        { key:'btn3', name:'btn3' },
        { key:'btn4', name:'btn4' },
        { key:'btn5', name:'btn5' },
      ];
      return;
    }

    const list = ENTRY_BUTTONS[entry];
    if(Array.isArray(list) && list.length){
      btnMeta = list.map(x => ({ key:String(x.key||'').trim(), name:String(x.name||x.key||'').trim() }));
      return;
    }

    btnMeta = [
      { key:'btn1', name:'btn1' },
      { key:'btn2', name:'btn2' },
      { key:'btn3', name:'btn3' },
      { key:'btn4', name:'btn4' },
      { key:'btn5', name:'btn5' },
    ];
  }

  function renderEntryPreview(){
    const entry = resolveEntryValue();
    entryNameTag.textContent = entry;
    const uName = String(current?.user || '—');
    previewUserTag.textContent = uName;

    const items = (Array.isArray(btnMeta) ? btnMeta : []);
    if(!items.length){ previewGrid.innerHTML = ''; return; }

    previewGrid.innerHTML = items.map(b => {
      const allowed = getPerm(uName, entry, b.key);
      const cls = allowed ? '' : 'dim';
      return `<div class="navPill ${cls}"><span>${escapeHtml(b.name || b.key)}</span> <small>(${escapeHtml(b.key)})</small></div>`;
    }).join('');
  }

  function renderHeaders(){
    theadRow.innerHTML = `
      <th>使用者</th>
      <th>密碼</th>
      <th>權限</th>
      ${btnMeta.map(b => `<th>${escapeHtml(b.name || b.key)}</th>`).join('')}
      <th class="sysCol">系統/權限</th>
      <th>刪除</th>
    `;
  }

  function renderTable(){
    const entry = resolveEntryValue();

    tbody.innerHTML = auth.map((u, idx) => {
      const role = String(u.role||'read').toLowerCase();
      const sysCell = (role === 'admin') ? '✓' : '—';

      return `
      <tr data-idx="${idx}">
        <td><input class="field" data-k="user" value="${escapeHtml(u.user||'')}" ${isAdmin?'':'disabled'}></td>
        <td><input class="field" data-k="pass" value="${escapeHtml(u.pass||'')}" ${isAdmin?'':'disabled'}></td>
        <td>
          <select class="field" data-k="role" ${isAdmin?'':'disabled'}>
            ${roleOptions.map(r => `<option value="${r}" ${r===role?'selected':''}>${r}</option>`).join('')}
          </select>
        </td>

        ${btnMeta.map(b => {
          const checked = getPerm(u.user, entry, b.key) ? 'checked' : '';
          return `<td><input class="chk" type="checkbox" data-k="${escapeHtml(b.key)}" ${checked} ${isAdmin?'':'disabled'}></td>`;
        }).join('')}

        <td>${sysCell}</td>
        <td><button class="delBtn" data-act="del" ${isAdmin?'':'disabled'}>刪除</button></td>
      </tr>`;
    }).join('');
  }

  function renderCards(){
    const entry = resolveEntryValue();

    cards.innerHTML = auth.map((u, idx) => {
      const role = String(u.role||'read').toLowerCase();
      const sys = (role === 'admin') ? '✓' : '—';

      return `
      <div class="card" data-idx="${idx}">
        <div class="cardHead" data-act="toggle">
          <div class="who">
            <strong>${escapeHtml(u.user||'')}</strong>
            <span class="badge">role：${escapeHtml(role)}　｜　系統/權限：${sys}</span>
          </div>
          <div class="chev">▾</div>
        </div>

        <div class="cardBody">
          <div class="grid2">
            <div>
              <div class="rowLabel">使用者</div>
              <input class="field" data-k="user" value="${escapeHtml(u.user||'')}" ${isAdmin?'':'disabled'}>
            </div>
            <div>
              <div class="rowLabel">密碼</div>
              <input class="field" data-k="pass" value="${escapeHtml(u.pass||'')}" ${isAdmin?'':'disabled'}>
            </div>
            <div>
              <div class="rowLabel">權限</div>
              <select class="field" data-k="role" ${isAdmin?'':'disabled'}>
                ${roleOptions.map(r => `<option value="${r}" ${r===role?'selected':''}>${r}</option>`).join('')}
              </select>
            </div>

            <div class="rowLabel">按鍵顯示權限（入口：${escapeHtml(entry)}，可左右滑動）</div>
            <div class="permScroll">
              <div class="permRow">
                ${btnMeta.map(b => {
                  const checked = getPerm(u.user, entry, b.key) ? 'checked' : '';
                  return `
                  <label class="permItem">
                    <input class="chk" type="checkbox" data-k="${escapeHtml(b.key)}" ${checked} ${isAdmin?'':'disabled'}>
                    <span>${escapeHtml(b.name || b.key)}</span>
                  </label>`;
                }).join('')}
              </div>
            </div>

            <div class="cardActions">
              <button class="btn" data-act="del" ${isAdmin?'':'disabled'}>刪除此使用者</button>
            </div>
          </div>
        </div>
      </div>`;
    }).join('');
  }

  function saveLocal(){
    localStorage.setItem(AUTH_KEY, JSON.stringify(auth));
    savePermMatrix();
    localState.textContent = '本機：已儲存';
  }

  function updateStates(text){
    const token = getToken();
    if(tokenInvalid){
      tokenState.textContent = '狀態：Token 格式錯誤（請更新）';
    }else if(tokenExpired){
      tokenState.textContent = '狀態：Token 過期（請更新）';
    }else{
      tokenState.textContent = token ? '狀態：已設定 Token（可同步）' : '狀態：未設定 Token';
    }
    setCloudButtonsEnabled();
    if(text && !tokenExpired && !tokenInvalid) setMsg(text, false);
  }

  function setCloudButtonsEnabled(){
    const token = getToken();
    const tokenOk = !!token && !tokenExpired && !tokenInvalid && isTokenLooksValid(token);

    downloadBtnD.disabled = !tokenOk;
    downloadBtnM.disabled = !tokenOk;

    uploadBtnD.disabled = !(tokenOk && isAdmin);
    uploadBtnM.disabled = !(tokenOk && isAdmin);
  }

  function renderAll(){
    updateWho();
    ensureBtnMetaByEntry();
    renderHeaders();
    renderTable();
    renderCards();
    renderEntryPreview();

    addBtn.disabled = !isAdmin;
    navNameBtnD.disabled = !isAdmin;
    navNameBtnM.disabled = !isAdmin;

    setCloudButtonsEnabled();
    if(!isAdmin) setMsg('（僅可查看）你目前不是 admin，無法編輯。', false);
  }

  function addRow(){
    auth.push({ user:'', pass:'', role:'read' });
    renderAll();
    setMsg('已新增一列（請填寫使用者/密碼）。');
  }

  function removeRow(idx){
    if(idx < 0 || idx >= auth.length) return;
    const u = auth[idx];
    if(String(u.user||'').toLowerCase() === 'alex'){
      setMsg('保護：不可刪除 alex。', true);
      return;
    }
    const k = userKey(u.user);
    if(k && permMatrix.users && permMatrix.users[k]) delete permMatrix.users[k];

    auth.splice(idx, 1);
    renderAll();
    saveLocal();
    setMsg('已刪除一列並儲存本機。');
  }

  function onTableInput(e){
    const tr = e.target.closest('tr');
    if(!tr) return;
    const idx = Number(tr.dataset.idx);
    if(Number.isNaN(idx) || !auth[idx]) return;

    const k = e.target.dataset.k;
    if(!k) return;

    const entry = resolveEntryValue();

    if(e.target.type === 'checkbox'){
      setPerm(auth[idx].user, entry, k, !!e.target.checked);
    }else if(e.target.tagName === 'SELECT'){
      auth[idx][k] = e.target.value;
    }else{
      auth[idx][k] = e.target.value;
    }

    normalizeAuth();
    saveLocal();

    if(k === 'user'){ load(); return; }
    renderEntryPreview();
  }

  function onTableClick(e){
    const tr = e.target.closest('tr');
    if(!tr) return;
    const idx = Number(tr.dataset.idx);
    if(Number.isNaN(idx)) return;
    if(e.target.dataset.act === 'del') removeRow(idx);
  }

  function onCardClick(e){
    const card = e.target.closest('.card');
    if(!card) return;
    const idx = Number(card.dataset.idx);
    if(Number.isNaN(idx) || !auth[idx]) return;

    const act = e.target.dataset.act || (e.target.closest('[data-act]')?.dataset.act);
    if(act === 'toggle'){
      card.classList.toggle('open');
      const chev = card.querySelector('.chev');
      if(chev) chev.textContent = card.classList.contains('open') ? '▴' : '▾';
      return;
    }
    if(act === 'del'){ removeRow(idx); return; }
  }

  function onCardInput(e){
    const card = e.target.closest('.card');
    if(!card) return;
    const idx = Number(card.dataset.idx);
    if(Number.isNaN(idx) || !auth[idx]) return;

    const k = e.target.dataset.k;
    if(!k) return;

    const entry = resolveEntryValue();

    if(e.target.type === 'checkbox'){
      setPerm(auth[idx].user, entry, k, !!e.target.checked);
    }else if(e.target.tagName === 'SELECT'){
      auth[idx][k] = e.target.value;
    }else{
      auth[idx][k] = e.target.value;
    }

    normalizeAuth();
    saveLocal();

    if(k === 'user'){ load(); return; }
    renderEntryPreview();
  }

  function closeMoreMenu(){ moreMenu.classList.remove('show'); }

  moreBtn.addEventListener('click', () => { moreMenu.classList.toggle('show'); });
  document.addEventListener('click', (e) => {
    if(!e.target.closest('.moreWrap')) moreMenu.classList.remove('show');
  });

  function goHome(){ location.href = 'index.html'; }
  backBtnD.addEventListener('click', goHome);
  backBtnM.addEventListener('click', () => { closeMoreMenu(); goHome(); });

  function switchAccount(){
    localStorage.removeItem(CURRENT_KEY);
    location.href = 'index.html';
  }
  switchBtnD.addEventListener('click', switchAccount);
  switchBtnM.addEventListener('click', () => { closeMoreMenu(); switchAccount(); });

  function openTokenDownload(){
    window.open(TOKEN_DOWNLOAD_URL, '_blank', 'noopener');
  }
  downloadTokenBtnD.addEventListener('click', openTokenDownload);
  downloadTokenBtnM.addEventListener('click', () => { closeMoreMenu(); openTokenDownload(); });

  function setToken(){ askTokenIfNeeded(''); }
  tokenBtnD.addEventListener('click', setToken);
  tokenBtnM.addEventListener('click', () => { closeMoreMenu(); setToken(); });

  function guardTokenOrHint(){
    const token = getToken();
    if(!token){
      setMsg('尚未設定 Token。\n請按「設定 Token」貼上 Dropbox Access Token。', true);
      updateStates();
      return '';
    }
    if(!isTokenLooksValid(token)){
      markTokenInvalid('貼上的內容不像 Dropbox Access Token');
      return '';
    }
    if(tokenExpired){ markTokenExpired('expired_access_token'); return ''; }
    if(tokenInvalid){ markTokenInvalid('malformed_access_token'); return ''; }
    return token;
  }

  // Dropbox-API-Arg header 需要 ASCII
  function latin1Safe(s){
    s = stripInvisibles(s);
    let out = '';
    for (const ch of s){
      const cp = ch.codePointAt(0);
      if (cp <= 0xFF) out += ch;
      else if (cp <= 0xFFFF) out += '\\u' + cp.toString(16).padStart(4,'0');
      else {
        const x = cp - 0x10000;
        const hi = 0xD800 + (x >> 10);
        const lo = 0xDC00 + (x & 0x3FF);
        out += '\\u' + hi.toString(16).padStart(4,'0') + '\\u' + lo.toString(16).padStart(4,'0');
      }
    }
    return out;
  }
  function jsonToAsciiSafe(obj){ return latin1Safe(JSON.stringify(obj)); }

  downloadBtnD.addEventListener('click', () => { const t = guardTokenOrHint(); if(!t) return; cloudDownload(t); });
  downloadBtnM.addEventListener('click', () => { closeMoreMenu(); const t = guardTokenOrHint(); if(!t) return; cloudDownload(t); });

  uploadBtnD.addEventListener('click', () => { const t = guardTokenOrHint(); if(!t) return; saveAndUpload(t); });
  uploadBtnM.addEventListener('click', () => { closeMoreMenu(); const t = guardTokenOrHint(); if(!t) return; saveAndUpload(t); });

  saveLocalBtn.addEventListener('click', () => {
    normalizeAuth();
    saveLocal();
    updateStates('已儲存本機（localStorage）。');
  });

  addBtn.addEventListener('click', addRow);

  tbody.addEventListener('input', onTableInput);
  tbody.addEventListener('change', onTableInput);
  tbody.addEventListener('click', onTableClick);

  cards.addEventListener('click', onCardClick);
  cards.addEventListener('input', onCardInput);
  cards.addEventListener('change', onCardInput);

  // 入口頁切換
  function onEntryChanged(){
    applyEntrySelectionUI();
    const v = resolveEntryValue();
    saveSelectedEntry(v);
    renderAll();
    updateStates(`已切換入口網頁：${v}\n（下方欄位與預覽已同步切換）`);
  }
  entrySelect.addEventListener('change', onEntryChanged);
  entryCustom.addEventListener('input', () => { if(entrySelect.value === '__custom__') onEntryChanged(); });

  entryResetBtn.addEventListener('click', () => {
    entrySelect.value = 'index.html';
    entryCustom.value = '';
    applyEntrySelectionUI();
    onEntryChanged();
  });

  // Dropbox
  async function cloudDownload(token){
    try{
      setMsg('雲端下載中…');

      const arg = jsonToAsciiSafe({ path: DROPBOX_PATH });

      const headers = new Headers();
      headers.set('Authorization', 'Bearer ' + token);
      headers.set('Dropbox-API-Arg', arg);

      const res = await fetch('https://content.dropboxapi.com/2/files/download', { method:'POST', headers });

      if(!res.ok){
        const t = await res.text().catch(()=> '');
        if(res.status === 401 && /expired_access_token/i.test(t)){ markTokenExpired('expired_access_token'); return; }
        if((res.status === 400 || res.status === 401) && /malformed|OAuth 2 access token is malformed/i.test(t)){ markTokenInvalid('OAuth 2 access token is malformed'); return; }
        throw new Error(`下載失敗 HTTP ${res.status}\n${t}`);
      }

      const text = await res.text();
      const remote = safeJsonParse(text, null);

      if(Array.isArray(remote)){
        auth = remote;
      }else if(remote && typeof remote === 'object'){
        if(Array.isArray(remote.auth)) auth = remote.auth;
        if(remote.permMatrix && typeof remote.permMatrix === 'object') permMatrix = remote.permMatrix;
      }else{
        throw new Error('雲端檔案不是有效的 JSON。');
      }

      if(!permMatrix || typeof permMatrix !== 'object') permMatrix = { users:{} };
      if(!permMatrix.users || typeof permMatrix.users !== 'object') permMatrix.users = {};

      normalizeAuth();
      saveLocal();

      current.role = getEffectiveRole();
      isAdmin = (getEffectiveRole() === 'admin');

      renderAll();
      updateStates('雲端下載完成，已覆蓋本機並更新畫面。');
    }catch(err){
      setMsg('雲端下載失敗：' + (err?.message || err), true);
    }
  }

  async function saveAndUpload(token){
    if(!isAdmin){
      setMsg('你不是 admin，禁止上傳。', true);
      return;
    }
    normalizeAuth();
    saveLocal();

    try{
      setMsg('上傳中…');

      const bodyObj = { auth, permMatrix };
      const body = JSON.stringify(bodyObj, null, 2);

      const apiArg = jsonToAsciiSafe({
        path: DROPBOX_PATH,
        mode: 'overwrite',
        autorename: false,
        mute: true
      });

      const headers = new Headers();
      headers.set('Authorization', 'Bearer ' + token);
      headers.set('Content-Type', 'application/octet-stream');
      headers.set('Dropbox-API-Arg', apiArg);

      const res = await fetch('https://content.dropboxapi.com/2/files/upload', { method:'POST', headers, body });
      const text = await res.text().catch(()=>'');

      if(!res.ok){
        if(res.status === 401 && /expired_access_token/i.test(text)){ markTokenExpired('expired_access_token'); return; }
        if((res.status === 400 || res.status === 401) && /malformed|OAuth 2 access token is malformed/i.test(text)){ markTokenInvalid('OAuth 2 access token is malformed'); return; }
        if(/files\.content\.write/i.test(text)){
          setMsg('上傳失敗：可能 scopes 不足（需要 files.content.write）。\n' + text, true);
          return;
        }
        throw new Error(`上傳失敗 HTTP ${res.status}\n${text}`);
      }

      const info = safeJsonParse(text, null);
      let stamp = '';
      if(info && typeof info === 'object'){
        const sm = info.server_modified || info.client_modified || '';
        if(sm) stamp = `\n雲端時間：${sm}`;
      }
      updateStates('上傳成功。' + stamp);
    }catch(err){
      setMsg('上傳失敗：' + (err?.message || err), true);
    }
  }

  // 按鍵名稱設定（保留）
  function readNavButtons(){
    const arr = safeJsonParse(localStorage.getItem(NAV_KEY) || '[]', []);
    if(Array.isArray(arr) && arr.length){
      const map = new Map(arr.map(x => [String(x.id||'').toLowerCase(), x]));
      const out = [];
      for(let i=1;i<=5;i++){
        const id = `btn${i}`;
        const hit = map.get(id);
        out.push({
          id,
          label: String(hit?.label || id).trim() || id,
          href: String(hit?.href || '').trim(),
          target: String(hit?.target || '').trim(),
          roles: Array.isArray(hit?.roles) ? hit.roles : []
        });
      }
      return out;
    }
    return [
      { id:'btn1', label:'btn1', href:'', target:'', roles:[] },
      { id:'btn2', label:'btn2', href:'', target:'', roles:[] },
      { id:'btn3', label:'btn3', href:'', target:'', roles:[] },
      { id:'btn4', label:'btn4', href:'', target:'', roles:[] },
      { id:'btn5', label:'btn5', href:'', target:'', roles:[] },
    ];
  }

  function maybeUpdateHrefByRename(oldLabel, newLabel, oldHref){
    const oL = String(oldLabel||'').trim();
    const nL = String(newLabel||'').trim();
    const oH = String(oldHref||'').trim();
    if(oL && oH === METRO_FIXED_HREF) return METRO_FIXED_HREF;
    if(!oH) return `${nL}.html`;
    if(oL && oH === `${oL}.html`) return `${nL}.html`;
    return oH;
  }

  function writeNavButtons(updated){
    const currentArr = safeJsonParse(localStorage.getItem(NAV_KEY) || '[]', []);
    const curMap = new Map((Array.isArray(currentArr) ? currentArr : []).map(x => [String(x.id||'').toLowerCase(), x]));

    const out = [];
    for(let i=1;i<=5;i++){
      const id = `btn${i}`;
      const prev = curMap.get(id) || {};
      const oldLabel = String(prev.label || id).trim() || id;
      const newLabel = String(updated[i-1]?.label || oldLabel).trim() || oldLabel;

      let href = String(prev.href || '').trim();
      if(id === 'btn2') href = METRO_FIXED_HREF;
      else href = maybeUpdateHrefByRename(oldLabel, newLabel, href);

      out.push({
        id,
        label: newLabel,
        href,
        target: String(prev.target || '').trim(),
        roles: Array.isArray(prev.roles) ? prev.roles : []
      });
    }

    localStorage.setItem(NAV_KEY, JSON.stringify(out));

    const oldRoutes = safeJsonParse(localStorage.getItem(ROUTE_KEY) || '{}', {});
    const routes = (oldRoutes && typeof oldRoutes === 'object') ? { ...oldRoutes } : {};
    out.forEach(it => { if(it.label) routes[it.label] = it.href; });
    routes[out[1]?.label || 'btn2'] = METRO_FIXED_HREF;
    localStorage.setItem(ROUTE_KEY, JSON.stringify(routes));

    renderAll();
  }

  function openNavPanel(){
    if(!isAdmin){ setMsg('你不是 admin，不能修改按鍵名稱。', true); return; }
    navPanel.classList.add('show');
    loadNavNamesIntoInputs();
  }
  function closeNavPanel(){ navPanel.classList.remove('show'); }

  function loadNavNamesIntoInputs(){
    const nav = readNavButtons();
    navName1.value = nav[0]?.label || '';
    navName2.value = nav[1]?.label || '';
    navName3.value = nav[2]?.label || '';
    navName4.value = nav[3]?.label || '';
    navName5.value = nav[4]?.label || '';
  }

  function saveNavNamesFromInputs(){
    if(!isAdmin){ setMsg('你不是 admin，不能儲存按鍵名稱。', true); return; }
    const n1 = stripInvisibles(navName1.value) || 'btn1';
    const n2 = stripInvisibles(navName2.value) || 'btn2';
    const n3 = stripInvisibles(navName3.value) || 'btn3';
    const n4 = stripInvisibles(navName4.value) || 'btn4';
    const n5 = stripInvisibles(navName5.value) || 'btn5';

    writeNavButtons([
      { id:'btn1', label:n1 },
      { id:'btn2', label:n2 },
      { id:'btn3', label:n3 },
      { id:'btn4', label:n4 },
      { id:'btn5', label:n5 },
    ]);

    setMsg('✅ 已儲存按鍵名稱並同步（tasunNavButtons_v1 / tasunRoutes_v1）。\n其他分頁（例如首頁）會自動更新。');
  }

  navNameBtnD.addEventListener('click', openNavPanel);
  navNameBtnM.addEventListener('click', () => { closeMoreMenu(); openNavPanel(); });
  navCloseBtn.addEventListener('click', closeNavPanel);
  navReloadBtn.addEventListener('click', loadNavNamesIntoInputs);
  navSaveBtn.addEventListener('click', saveNavNamesFromInputs);

  // 初始化
  function load(){
    seedAuthIfMissing();

    auth = safeJsonParse(localStorage.getItem(AUTH_KEY) || '[]', []);
    if(!Array.isArray(auth)) auth = [];
    normalizeAuth();

    current = safeJsonParse(localStorage.getItem(CURRENT_KEY) || 'null', null);
    if(!current || typeof current !== 'object'){
      current = { user:'—', role:'read' };
    }else{
      current.user = String(current.user || '—');
      current.role = String(current.role || 'read');
    }

    loadPermMatrix();

    current.role = getEffectiveRole();
    isAdmin = (getEffectiveRole() === 'admin');

    clearTokenFlags();

    buildEntrySelect();
    loadSelectedEntry();

    const inList = ENTRY_FILES.includes(currentEntry);
    if(inList){
      entrySelect.value = currentEntry;
      entryCustom.value = '';
    }else{
      entrySelect.value = '__custom__';
      entryCustom.value = currentEntry;
    }
    applyEntrySelectionUI();

    renderAll();
    updateStates('已載入本機資料。');
  }

  window.addEventListener('storage', (e) => {
    if(e.key === NAV_KEY || e.key === BTN_META_KEY){
      renderAll();
      updateStates('已同步首頁按鍵名稱。');
      return;
    }
    if(e.key === AUTH_KEY || e.key === CURRENT_KEY || e.key === TOKEN_KEY || e.key === PERM_MATRIX_KEY || e.key === ENTRY_SELECTED_KEY){
      load();
    }
  });

  load();
})();
</script>
</body>
</html>
