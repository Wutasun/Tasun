<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tasun æ¬Šé™è¡¨</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --gold:#f6d37a;
      --gold-soft: rgba(246,211,122,.75);
      --panel-border: rgba(246,211,122,.35);
      --bg0:#050302;
      --bg1:#0b0a07;

      --radius: 22px;
      --shadow: 0 18px 42px rgba(0,0,0,.55);
      --shadow2: 0 10px 26px rgba(0,0,0,.55);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: "Noto Serif TC", system-ui, -apple-system, "Microsoft JhengHei", sans-serif;
      color: rgba(246,211,122,.92);
      background:
        radial-gradient(circle at 18% 0%, rgba(246,211,122,.12) 0, transparent 42%),
        radial-gradient(circle at 82% 18%, rgba(246,211,122,.08) 0, transparent 48%),
        radial-gradient(circle at 50% 92%, rgba(246,211,122,.10) 0, transparent 52%),
        linear-gradient(180deg, var(--bg1), var(--bg0) 55%, #000);
      overflow-x:hidden;
    }

    /* ç»ç’ƒè³ªæ„Ÿå®¹å™¨ */
    .wrap{
      width:min(1280px, calc(100% - 40px));
      margin: 92px auto 56px;
      border-radius: var(--radius);
      border: 1px solid rgba(246,211,122,.22);
      background:
        linear-gradient(90deg, rgba(246,211,122,.16), rgba(0,0,0,.50) 70%),
        radial-gradient(circle at 28% 30%, rgba(246,211,122,.12), transparent 55%);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    .head{
      padding: 26px 28px 18px;
      border-bottom: 1px solid rgba(246,211,122,.18);
      background:
        radial-gradient(circle at 25% 10%, rgba(246,211,122,.12), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,.0), rgba(0,0,0,.25));
    }

    .title{
      font-size: clamp(26px, 3.2vw, 40px);
      letter-spacing: .28em;
      text-shadow: 0 2px 10px rgba(0,0,0,.65);
      margin:0 0 8px;
    }

    .desc{
      margin:0;
      opacity:.9;
      line-height:1.6;
      font-size: 14px;
    }

    .desc .hint{
      display:inline-block;
      margin-top:8px;
      opacity:.85;
      font-size: 13px;
    }

    /* ====== TOP BARï¼ˆæ¡Œæ©Ÿ/æ‰‹æ©Ÿä¸€è‡´ï¼šæ‰‹æ©Ÿç”¨ è¿”å›/æ›´å¤šä¸‹æ‹‰ï¼‰ ====== */
    .topbar{
      position:fixed;
      top: 14px;
      left: 0;
      right:0;
      z-index: 999;
      pointer-events:none;
    }
    .topbar .bar{
      width:min(1280px, calc(100% - 40px));
      margin: 0 auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      pointer-events:auto;
    }
    .bar-left, .bar-right{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.25);
      background: linear-gradient(180deg, rgba(246,211,122,.10), rgba(0,0,0,.45));
      box-shadow: 0 10px 26px rgba(0,0,0,.45);
      font-size: 13px;
      white-space:nowrap;
    }
    .pill b{ font-weight:700; color: var(--gold); }

    .btn{
      appearance:none;
      border: 1px solid rgba(246,211,122,.30);
      background: linear-gradient(180deg, rgba(246,211,122,.18), rgba(0,0,0,.55));
      color: rgba(246,211,122,.95);
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 13px;
      letter-spacing:.12em;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,.42);
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
      white-space:nowrap;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.04); box-shadow: 0 12px 26px rgba(0,0,0,.55); }
    .btn:active{ transform: translateY(0px); filter: brightness(.98); }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; transform:none; }

    /* æ¡Œæ©Ÿ actions */
    .desktop-actions{ display:flex; gap:10px; align-items:center; }
    .mobile-actions{ display:none; gap:10px; align-items:center; }

    /* æ›´å¤šä¸‹æ‹‰ */
    .more{
      position:relative;
    }
    .menu{
      position:absolute;
      top: 46px;
      right: 0;
      min-width: 180px;
      border-radius: 16px;
      border:1px solid rgba(246,211,122,.22);
      background: linear-gradient(180deg, rgba(20,16,10,.96), rgba(0,0,0,.88));
      box-shadow: var(--shadow2);
      padding: 8px;
      display:none;
    }
    .menu.open{ display:block; }
    .menu button{
      width:100%;
      text-align:left;
      border:none;
      background: transparent;
      color: rgba(246,211,122,.95);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      letter-spacing:.08em;
      font-size: 13px;
    }
    .menu button:hover{
      background: rgba(246,211,122,.10);
    }

    /* ====== TABLEï¼ˆæ¡Œæ©Ÿï¼‰ ====== */
    .content{
      padding: 14px 18px 18px;
    }

    .table-wrap{
      overflow:auto;
      border-top: 1px solid rgba(246,211,122,.12);
      border-bottom: 1px solid rgba(246,211,122,.12);
    }

    table{
      width: max(980px, 100%);
      border-collapse: collapse;
    }
    thead th{
      position:sticky;
      top:0;
      z-index:2;
      background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
      border-bottom: 1px solid rgba(246,211,122,.12);
      font-size: 13px;
      letter-spacing:.14em;
      color: rgba(246,211,122,.88);
      padding: 12px 10px;
      white-space:nowrap;
    }
    tbody td{
      border-top: 1px solid rgba(246,211,122,.08);
      padding: 10px 10px;
      vertical-align:middle;
    }
    tbody tr:hover{
      background: rgba(246,211,122,.05);
    }

    .input, .select{
      width: 100%;
      min-width: 170px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.22);
      background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
      color: rgba(246,211,122,.95);
      padding: 0 12px;
      outline:none;
      font-size: 13px;
    }
    .select{ min-width: 100px; padding-right: 30px; }
    .input:disabled, .select:disabled{ opacity:.55; }

    .chk{
      width: 18px;
      height: 18px;
      accent-color: #f0d38a;
      cursor:pointer;
    }
    .chk:disabled{ cursor:not-allowed; }

    .td-center{ text-align:center; }
    .td-small{ width: 88px; }
    .td-del{ width: 92px; }

    .mini{
      font-size: 12px;
      opacity:.86;
      white-space:nowrap;
    }

    .footer{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 14px 18px 16px;
      flex-wrap:wrap;
    }
    .left-actions{ display:flex; gap:10px; flex-wrap:wrap; }
    .status{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .status .pill{ padding: 9px 12px; }

    .note{
      padding: 0 18px 16px;
      opacity:.8;
      font-size: 12px;
      letter-spacing:.08em;
    }

    /* ====== MOBILE å¡ç‰‡å¼ï¼ˆæ¯åˆ—æŠ˜ç–Š + æ¬„ä½æ©«å‘æ»‘å‹•ï¼‰ ====== */
    .cards{
      display:none;
      padding: 8px 0 0;
    }
    .card{
      border-top: 1px solid rgba(246,211,122,.10);
      padding: 10px 2px;
    }
    details.card{
      background: transparent;
    }
    details.card > summary{
      list-style:none;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border-radius: 16px;
      background: rgba(246,211,122,.06);
      border: 1px solid rgba(246,211,122,.14);
      box-shadow: 0 10px 20px rgba(0,0,0,.22);
    }
    details.card > summary::-webkit-details-marker{ display:none; }

    .summary-left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 0;
    }
    .u-name{
      font-weight:700;
      letter-spacing:.12em;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .u-role{
      font-size: 12px;
      opacity:.85;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 6px 10px;
      border-radius:999px;
      border:1px solid rgba(246,211,122,.22);
      background: rgba(0,0,0,.35);
      font-size: 12px;
      white-space:nowrap;
    }

    .card-body{
      padding: 10px 6px 6px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .field label{
      display:block;
      font-size: 12px;
      opacity:.85;
      margin: 0 0 6px 6px;
      letter-spacing:.10em;
    }
    .field .input, .field .select{
      min-width: 0;
      width:100%;
    }

    .perm-strip{
      border: 1px solid rgba(246,211,122,.14);
      background: rgba(0,0,0,.28);
      border-radius: 16px;
      padding: 10px 10px;
      overflow:hidden;
    }
    .perm-title{
      font-size: 12px;
      opacity:.86;
      margin-bottom: 8px;
      letter-spacing:.10em;
    }
    .perm-scroll{
      display:flex;
      gap:12px;
      overflow:auto;
      padding-bottom: 6px;
      -webkit-overflow-scrolling: touch;
    }
    .perm-item{
      flex: 0 0 auto;
      min-width: 150px;
      border: 1px solid rgba(246,211,122,.12);
      background: rgba(246,211,122,.06);
      border-radius: 14px;
      padding: 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .perm-item span{
      font-size: 12px;
      opacity:.92;
      letter-spacing:.08em;
    }

    .card-actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      padding: 4px 2px 6px;
    }

    /* ====== MODALS ====== */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 2000;
      padding: 18px;
    }
    .overlay.open{ display:flex; }

    .modal{
      width: min(560px, 100%);
      border-radius: 22px;
      border:1px solid rgba(246,211,122,.22);
      background:
        linear-gradient(90deg, rgba(246,211,122,.16), rgba(0,0,0,.62) 70%),
        radial-gradient(circle at 30% 22%, rgba(246,211,122,.12), transparent 55%);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-head{
      padding: 16px 18px;
      border-bottom: 1px solid rgba(246,211,122,.14);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modal-head h3{
      margin:0;
      font-size: 18px;
      letter-spacing:.18em;
    }
    .modal-body{
      padding: 16px 18px 18px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .modal-row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .modal-actions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      padding: 0 18px 18px;
    }
    .msg{
      font-size: 13px;
      line-height:1.6;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(246,211,122,.14);
      background: rgba(0,0,0,.32);
      color: rgba(246,211,122,.92);
      white-space:pre-wrap;
    }

    /* ====== Responsive ====== */
    @media (max-width: 920px){
      .desktop-actions{ display:none; }
      .mobile-actions{ display:flex; }

      .wrap{ width: calc(100% - 28px); margin-top: 112px; }
    }
    @media (max-width: 820px){
      .table-wrap{ display:none; }
      .cards{ display:block; }
      .row2{ grid-template-columns: 1fr; }
      .modal-row{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <!-- TOP BAR -->
  <div class="topbar">
    <div class="bar">
      <div class="bar-left">
        <div class="pill" id="pillUser">ç›®å‰ä½¿ç”¨è€…ï¼š<b id="curName">â€”</b> (<span id="curRole">read</span>)</div>
        <button class="btn" id="btnSwitch">åˆ‡æ›å¸³è™Ÿ</button>
      </div>

      <!-- Desktop actions -->
      <div class="bar-right desktop-actions">
        <button class="btn" id="btnHome">è¿”å›é¦–é </button>
        <button class="btn" id="btnToken">è¨­å®š Token</button>
        <button class="btn" id="btnCloudDown">é›²ç«¯ä¸‹è¼‰</button>
        <button class="btn" id="btnCloudUp">å„²å­˜ä¸¦ä¸Šå‚³</button>
      </div>

      <!-- Mobile actions -->
      <div class="bar-right mobile-actions">
        <button class="btn" id="btnHomeM">è¿”å›</button>
        <div class="more">
          <button class="btn" id="btnMore">æ›´å¤š â–¾</button>
          <div class="menu" id="moreMenu">
            <button type="button" data-act="switch">åˆ‡æ›å¸³è™Ÿ</button>
            <button type="button" data-act="token">è¨­å®š Token</button>
            <button type="button" data-act="down">é›²ç«¯ä¸‹è¼‰</button>
            <button type="button" data-act="up">å„²å­˜ä¸¦ä¸Šå‚³</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="wrap">
    <div class="head">
      <h1 class="title">Tasun æ¬Šé™è¡¨</h1>
      <p class="desc">
        åªæœ‰ <b>admin</b> å¯ä»¥ç·¨è¼¯ï¼›å…¶ä»–æ¬Šé™åªèƒ½æŸ¥çœ‹ã€‚
        <br>
        <span class="hint">æç¤ºï¼šæŒ‰éµæ¬„ä½æ¨™é¡Œæœƒè‡ªå‹•æ”¹ç‚ºã€Œé¦–é æŒ‰éµåç¨±ã€ï¼Œä¸¦æœƒéš¨é¦–é æŒ‰éµæ–°å¢/æ”¹ååŒæ­¥ã€‚</span>
      </p>
    </div>

    <div class="content">
      <!-- DESKTOP TABLE -->
      <div class="table-wrap" id="tableWrap">
        <table>
          <thead>
            <tr id="theadRow">
              <!-- JS å‹•æ…‹ç”¢ç”Ÿ -->
            </tr>
          </thead>
          <tbody id="tbody">
            <!-- JS å‹•æ…‹ç”¢ç”Ÿ -->
          </tbody>
        </table>
      </div>

      <!-- MOBILE CARDS -->
      <div class="cards" id="cards">
        <!-- JS å‹•æ…‹ç”¢ç”Ÿ -->
      </div>
    </div>

    <div class="footer">
      <div class="left-actions">
        <button class="btn" id="btnAdd">ï¼‹ æ–°å¢ä¸€åˆ—</button>
        <button class="btn" id="btnSaveLocal">åªå„²å­˜æœ¬æ©Ÿ</button>
      </div>
      <div class="status">
        <div class="pill" id="pillToken">ç‹€æ…‹ï¼š<b id="tokenState">æœªè¨­å®š Token</b></div>
        <div class="pill">æœ¬æ©Ÿï¼š<b id="localState">å°šæœªå„²å­˜</b></div>
      </div>
    </div>

    <div class="note" id="note">
      ï¼ˆå°šæœªé¡¯ç¤ºä»»ä½•éŒ¯èª¤ï¼‰
    </div>
  </div>

  <!-- ===== MODALS ===== -->
  <!-- Switch Account -->
  <div class="overlay" id="ovLogin">
    <div class="modal">
      <div class="modal-head">
        <h3>åˆ‡æ›å¸³è™Ÿ</h3>
        <button class="btn" id="btnCloseLogin">é—œé–‰</button>
      </div>
      <div class="modal-body">
        <div class="modal-row">
          <div class="field">
            <label>å¸³è™Ÿï¼ˆä¸‹æ‹‰é¸å–®ï¼‰</label>
            <select class="select" id="loginUser"></select>
          </div>
          <div class="field">
            <label>å¯†ç¢¼</label>
            <input class="input" id="loginPass" type="password" placeholder="è¼¸å…¥å¯†ç¢¼">
          </div>
        </div>
        <div class="msg" id="loginMsg">è«‹é¸æ“‡å¸³è™Ÿä¸¦è¼¸å…¥å¯†ç¢¼ã€‚</div>
      </div>
      <div class="modal-actions">
        <button class="btn" id="btnDoLogin">ç™»å…¥</button>
      </div>
    </div>
  </div>

  <!-- Token -->
  <div class="overlay" id="ovToken">
    <div class="modal">
      <div class="modal-head">
        <h3>è¨­å®š Dropbox Token</h3>
        <button class="btn" id="btnCloseToken">é—œé–‰</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <label>Access Token</label>
          <input class="input" id="tokenInput" placeholder="è²¼ä¸Š Dropbox Access Token">
        </div>
        <div class="msg" id="tokenMsg">
          æ³¨æ„ï¼šä¸Šå‚³éœ€è¦ scopes åŒ…å« files.content.writeã€‚
          è‹¥å‡ºç¾ expired_access_token / HTTP 401ï¼Œä»£è¡¨ Token éæœŸï¼Œè«‹é‡æ–°è¨­å®šã€‚
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn" id="btnSaveToken">å„²å­˜ Token</button>
      </div>
    </div>
  </div>

  <script>
    /******************************************************************
     * Tasun æ¬Šé™è¡¨ï¼ˆä¿®æ­£ç‰ˆé‡é»ï¼‰
     * 1) ä¿®æ­£ã€Œå¾é¦–é é€²ä¾†é¡¯ç¤º â€”(read) / æ²’è³‡æ–™ã€ï¼šåŠ å…¥ key ç›¸å®¹è®€å– + æœ¬æ©Ÿé è¨­è³‡æ–™ seed + ä¸å†è®“é›²ç«¯å¤±æ•—è¦†è“‹æœ¬æ©Ÿ
     * 2) admin å¯ç·¨è¼¯ï¼šä¾ç›®å‰ä½¿ç”¨è€… role åˆ¤æ–·ï¼Œä¸¦å…è¨± admin ä¿®æ”¹æ¬„ä½
     * 3) æ¬„ä½é¡¯ç¤º btn1..btn5 â†’ æ”¹ç‚ºé¦–é æŒ‰éµåç¨±ï¼ˆå¯å¾ localStorage åŒæ­¥ï¼‰
     * 4) æ‰‹æ©Ÿç‰ˆä¸€è‡´ UIï¼šè¿”å› / æ›´å¤šä¸‹æ‹‰
     * 5) æ‰‹æ©Ÿè¡¨æ ¼æ”¹å¡ç‰‡å¼ï¼šæ¯åˆ—æŠ˜ç–Š + æ¬„ä½æ©«å‘æ»‘å‹•
     ******************************************************************/

    // ====== LocalStorage Keysï¼ˆä¿ç•™ v1ï¼›ä¸¦åŠ å…¥èˆŠkeyç›¸å®¹ï¼‰ ======
    const AUTH_KEY = "tasunAuthTable_v1";
    const AUTH_KEY_ALIASES = ["tasunAuthTable", "tasunAuthTable_v0", "AUTH_TABLE"];

    const CURRENT_KEY = "tasunCurrentUser_v1";
    const CURRENT_KEY_ALIASES = ["tasunCurrentUser", "currentUser", "tasun_current_user"];

    const TOKEN_KEY = "tasunDropboxToken_v1";
    const TOKEN_KEY_ALIASES = ["tasunDropboxToken", "dropboxToken", "DROPBOX_TOKEN"];

    // é¦–é æŒ‰éµåç¨±åŒæ­¥ï¼ˆè‹¥ index æœ‰å¯«å…¥ï¼Œå°±æœƒè‡ªå‹•è®€åˆ°ï¼‰
    // æœŸå¾…æ ¼å¼ï¼š[{id:"btn1",label:"..."},...]
    const HOME_BTN_KEY = "tasunHomeButtons_v1";
    const HOME_BTN_KEY_ALIASES = ["tasunIndexButtons_v1", "tasunHomeBtns", "tasunNavButtons_v1"];

    // Dropbox æª”åï¼ˆæ”¾åœ¨ App folder æ ¹ç›®éŒ„ï¼‰
    const CLOUD_PATH = "/Tasun_æ¬Šé™è¡¨.json";

    // ====== Default seedï¼ˆç¢ºä¿å³ä½¿ storage å£æ‰ï¼Œä¹Ÿä¸€å®šæœƒé¡¯ç¤º 3~4 ç­†è³‡æ–™ï¼‰ ======
    const DEFAULT_AUTH = [
      { username:"alex",  password:"Tasun08040224", role:"admin", btn:{btn1:true, btn2:true, btn3:true, btn4:true, btn5:true} },
      { username:"tasun", password:"tasun08040224", role:"write", btn:{btn1:true, btn2:true, btn3:true, btn4:true, btn5:true} },
      { username:"wu",    password:"123456",       role:"read",  btn:{btn1:true, btn2:false,btn3:false,btn4:false,btn5:true} },
      { username:"JOYCE", password:"09220224",     role:"read",  btn:{btn1:true, btn2:true, btn3:true, btn4:true, btn5:false} },
    ];

    const DEFAULT_HOME_BTNS = [
      { id:"btn1", label:"è‡»é¼æ™‚ä»£å¤§å»ˆç®¡ç†è¡¨" },
      { id:"btn2", label:"ç¼ºå¤±ï¼å“è³ª" },
      { id:"btn3", label:"é›²ç«¯æª”æ¡ˆ" },
      { id:"btn4", label:"å·¥ç¨‹è³‡æ–™åº«" },
      { id:"btn5", label:"è³‡æ–™åº«" },
    ];

    // ====== State ======
    let auth = [];
    let homeBtns = [];
    let current = { username:"", role:"read" };
    let token = "";
    let lastHomeBtnSig = "";
    let lastAuthSig = "";

    // ====== DOM ======
    const elCurName = document.getElementById("curName");
    const elCurRole = document.getElementById("curRole");
    const elTokenState = document.getElementById("tokenState");
    const elLocalState = document.getElementById("localState");
    const elNote = document.getElementById("note");

    const btnSwitch = document.getElementById("btnSwitch");
    const btnHome = document.getElementById("btnHome");
    const btnHomeM = document.getElementById("btnHomeM");
    const btnToken = document.getElementById("btnToken");
    const btnCloudDown = document.getElementById("btnCloudDown");
    const btnCloudUp = document.getElementById("btnCloudUp");

    const btnAdd = document.getElementById("btnAdd");
    const btnSaveLocal = document.getElementById("btnSaveLocal");

    const theadRow = document.getElementById("theadRow");
    const tbody = document.getElementById("tbody");
    const cards = document.getElementById("cards");

    // Mobile menu
    const btnMore = document.getElementById("btnMore");
    const moreMenu = document.getElementById("moreMenu");

    // Login modal
    const ovLogin = document.getElementById("ovLogin");
    const btnCloseLogin = document.getElementById("btnCloseLogin");
    const loginUser = document.getElementById("loginUser");
    const loginPass = document.getElementById("loginPass");
    const loginMsg = document.getElementById("loginMsg");
    const btnDoLogin = document.getElementById("btnDoLogin");

    // Token modal
    const ovToken = document.getElementById("ovToken");
    const btnCloseToken = document.getElementById("btnCloseToken");
    const tokenInput = document.getElementById("tokenInput");
    const tokenMsg = document.getElementById("tokenMsg");
    const btnSaveToken = document.getElementById("btnSaveToken");

    // ====== Utils ======
    function safeParseJSON(s){
      try{ return JSON.parse(s); }catch(_){ return null; }
    }
    function readFirstKey(keys){
      for(const k of keys){
        const v = localStorage.getItem(k);
        if(v !== null && v !== undefined && String(v).trim() !== "") return { key:k, value:v };
      }
      return { key:null, value:null };
    }
    function writeJSON(key, obj){
      localStorage.setItem(key, JSON.stringify(obj));
    }
    function sig(obj){
      try{ return JSON.stringify(obj); }catch(_){ return String(Math.random()); }
    }
    function isAdmin(){
      return (current?.role || "read") === "admin";
    }
    function clampRole(role){
      return (role === "admin" || role === "write" || role === "read") ? role : "read";
    }
    function normalizeAuth(list){
      const out = Array.isArray(list) ? list : [];
      return out
        .filter(x => x && typeof x === "object")
        .map(x => ({
          username: String(x.username ?? x.user ?? "").trim(),
          password: String(x.password ?? x.pass ?? "").trim(),
          role: clampRole(x.role ?? x.permission ?? x.perm),
          btn: {
            btn1: !!(x.btn?.btn1 ?? x.btn1),
            btn2: !!(x.btn?.btn2 ?? x.btn2),
            btn3: !!(x.btn?.btn3 ?? x.btn3),
            btn4: !!(x.btn?.btn4 ?? x.btn4),
            btn5: !!(x.btn?.btn5 ?? x.btn5),
          }
        }))
        .filter(x => x.username.length > 0);
    }
    function normalizeHomeBtns(list){
      const arr = Array.isArray(list) ? list : [];
      const map = new Map();
      for(const it of arr){
        if(!it) continue;
        const id = String(it.id || it.key || "").trim();
        const label = String(it.label || it.name || it.text || "").trim();
        if(id && label) map.set(id, { id, label });
      }
      // åªå– btn1..btn5
      const fixed = ["btn1","btn2","btn3","btn4","btn5"].map(id => map.get(id) || null);
      const merged = fixed.map((x,i)=> x || { id:`btn${i+1}`, label: DEFAULT_HOME_BTNS[i].label });
      return merged;
    }
    function getBtnLabel(id){
      const f = homeBtns.find(b => b.id === id);
      return f ? f.label : id;
    }

    function setNote(text, isErr=false){
      elNote.textContent = text || "ï¼ˆå°šæœªé¡¯ç¤ºä»»ä½•éŒ¯èª¤ï¼‰";
      elNote.style.color = isErr ? "rgba(255,170,190,.95)" : "rgba(246,211,122,.82)";
    }

    // ====== Load / Save ======
    function loadAuth(){
      // è®€ v1 æˆ–èˆŠkey
      const got = readFirstKey([AUTH_KEY, ...AUTH_KEY_ALIASES]);
      const parsed = got.value ? safeParseJSON(got.value) : null;
      const normalized = normalizeAuth(parsed);

      if(normalized.length > 0){
        auth = normalized;
        // è½‰å­˜åˆ° v1ï¼ˆçµ±ä¸€ï¼‰
        writeJSON(AUTH_KEY, auth);
        return;
      }

      // è‹¥éƒ½æ²’æœ‰ï¼Œseed
      auth = normalizeAuth(DEFAULT_AUTH);
      writeJSON(AUTH_KEY, auth);
    }

    function loadCurrent(){
      const got = readFirstKey([CURRENT_KEY, ...CURRENT_KEY_ALIASES]);
      const parsed = got.value ? safeParseJSON(got.value) : null;

      // å…è¨±å…©ç¨®æ ¼å¼ï¼š{username,role} æˆ– {user,role}
      const u = parsed?.username ?? parsed?.user ?? "";
      const r = parsed?.role ?? parsed?.perm ?? parsed?.permission ?? "read";

      current = { username: String(u || "").trim(), role: clampRole(r) };

      // è‹¥ current æ‰¾ä¸åˆ°å°æ‡‰å¸³è™Ÿï¼Œå°±ä¿ç•™ readï¼Œä½†ä»é¡¯ç¤ºè¡¨æ ¼
      const found = auth.find(x => x.username === current.username);
      if(found){
        current.role = clampRole(found.role); // ä»¥æ¬Šé™è¡¨ç‚ºæº–
        writeJSON(CURRENT_KEY, current);
      }else{
        // æ²’ç™»å…¥ä¹Ÿä¸è¦è‡ªå‹•çµ¦ adminï¼Œé¿å…èª¤æˆæ¬Š
        current = { username:"", role:"read" };
        writeJSON(CURRENT_KEY, current);
      }
    }

    function loadToken(){
      const got = readFirstKey([TOKEN_KEY, ...TOKEN_KEY_ALIASES]);
      token = (got.value || "").trim();
      if(token) localStorage.setItem(TOKEN_KEY, token);
      refreshTokenUI();
    }

    function loadHomeBtns(){
      const got = readFirstKey([HOME_BTN_KEY, ...HOME_BTN_KEY_ALIASES]);
      const parsed = got.value ? safeParseJSON(got.value) : null;
      homeBtns = normalizeHomeBtns(parsed || DEFAULT_HOME_BTNS);
      lastHomeBtnSig = sig(homeBtns);
    }

    function saveLocal(){
      writeJSON(AUTH_KEY, auth);
      elLocalState.textContent = "å·²å„²å­˜";
      setNote("âœ… å·²å„²å­˜æœ¬æ©Ÿï¼ˆlocalStorageï¼‰ã€‚");
    }

    // ====== UI refresh ======
    function refreshTopUser(){
      elCurName.textContent = current.username || "â€”";
      elCurRole.textContent = current.role || "read";
    }

    function refreshTokenUI(){
      if(token){
        elTokenState.textContent = "å·²è¨­å®š Tokenï¼ˆå¯åŒæ­¥ï¼‰";
      }else{
        elTokenState.textContent = "æœªè¨­å®š Token";
      }
    }

    function buildThead(){
      const btnCols = ["btn1","btn2","btn3","btn4","btn5"].map(id => getBtnLabel(id));

      theadRow.innerHTML = `
        <th>ä½¿ç”¨è€…</th>
        <th>å¯†ç¢¼</th>
        <th>æ¬Šé™</th>
        <th class="td-center">${btnCols[0]}</th>
        <th class="td-center">${btnCols[1]}</th>
        <th class="td-center">${btnCols[2]}</th>
        <th class="td-center">${btnCols[3]}</th>
        <th class="td-center">${btnCols[4]}</th>
        <th class="td-center">ç³»çµ±/æ¬Šé™</th>
        <th class="td-center td-del">åˆªé™¤</th>
      `;
    }

    function renderDesktopTable(){
      if(!auth.length){
        tbody.innerHTML = `<tr><td colspan="10" class="td-center mini">ï¼ˆå°šç„¡è³‡æ–™ï¼‰</td></tr>`;
        return;
      }

      const admin = isAdmin();
      tbody.innerHTML = auth.map((u, idx) => {
        const sys = (u.role === "admin"); // å›ºå®šåªæœ‰ admin é¡¯ç¤ºç¬¬6é¡†ã€Œç³»çµ±/æ¬Šé™ã€
        return `
          <tr data-idx="${idx}">
            <td><input class="input" data-k="username" value="${escapeHtml(u.username)}" ${admin ? "" : "disabled"}></td>
            <td><input class="input" data-k="password" value="${escapeHtml(u.password)}" ${admin ? "" : "disabled"}></td>
            <td>
              <select class="select" data-k="role" ${admin ? "" : "disabled"}>
                <option value="admin" ${u.role==="admin"?"selected":""}>admin</option>
                <option value="write" ${u.role==="write"?"selected":""}>write</option>
                <option value="read"  ${u.role==="read" ?"selected":""}>read</option>
              </select>
            </td>

            ${["btn1","btn2","btn3","btn4","btn5"].map(bid => `
              <td class="td-center td-small">
                <input class="chk" type="checkbox" data-k="${bid}" ${u.btn[bid] ? "checked":""} ${admin ? "" : "disabled"}>
              </td>
            `).join("")}

            <td class="td-center td-small"><span class="mini">${sys ? "âœ“" : "â€”"}</span></td>
            <td class="td-center td-del">
              <button class="btn" data-act="del" ${admin ? "" : "disabled"}>åˆªé™¤</button>
            </td>
          </tr>
        `;
      }).join("");
    }

    function renderMobileCards(){
      if(!auth.length){
        cards.innerHTML = `<div class="card"><div class="mini" style="padding:10px 10px;">ï¼ˆå°šç„¡è³‡æ–™ï¼‰</div></div>`;
        return;
      }

      const admin = isAdmin();
      cards.innerHTML = auth.map((u, idx) => {
        const sys = (u.role === "admin");
        return `
          <details class="card" data-idx="${idx}" ${idx===0 ? "" : ""}>
            <summary>
              <div class="summary-left">
                <div class="u-name">${escapeHtml(u.username)}</div>
                <div class="u-role">æ¬Šé™ï¼š${escapeHtml(u.role)}ã€€ï½œã€€ç³»çµ±/æ¬Šé™ï¼š${sys ? "âœ“" : "â€”"}</div>
              </div>
              <div class="badge">${admin ? "å¯ç·¨è¼¯" : "åƒ…å¯æŸ¥çœ‹"}</div>
            </summary>

            <div class="card-body">
              <div class="row2">
                <div class="field">
                  <label>ä½¿ç”¨è€…</label>
                  <input class="input" data-k="username" value="${escapeHtml(u.username)}" ${admin ? "" : "disabled"}>
                </div>
                <div class="field">
                  <label>å¯†ç¢¼</label>
                  <input class="input" data-k="password" value="${escapeHtml(u.password)}" ${admin ? "" : "disabled"}>
                </div>
              </div>

              <div class="field">
                <label>æ¬Šé™</label>
                <select class="select" data-k="role" ${admin ? "" : "disabled"}>
                  <option value="admin" ${u.role==="admin"?"selected":""}>admin</option>
                  <option value="write" ${u.role==="write"?"selected":""}>write</option>
                  <option value="read"  ${u.role==="read" ?"selected":""}>read</option>
                </select>
              </div>

              <div class="perm-strip">
                <div class="perm-title">æŒ‰éµé¡¯ç¤ºï¼ˆæ©«å‘æ»‘å‹•ï¼‰</div>
                <div class="perm-scroll">
                  ${["btn1","btn2","btn3","btn4","btn5"].map(bid => `
                    <div class="perm-item">
                      <span>${escapeHtml(getBtnLabel(bid))}</span>
                      <input class="chk" type="checkbox" data-k="${bid}" ${u.btn[bid] ? "checked":""} ${admin ? "" : "disabled"}>
                    </div>
                  `).join("")}
                </div>
              </div>

              <div class="card-actions">
                <button class="btn" data-act="del" ${admin ? "" : "disabled"}>åˆªé™¤</button>
              </div>
            </div>
          </details>
        `;
      }).join("");
    }

    function renderAll(){
      buildThead();
      renderDesktopTable();
      renderMobileCards();
      refreshTopUser();

      btnAdd.disabled = !isAdmin();
      btnSaveLocal.disabled = !isAdmin(); // é admin æ²’æœ‰æ„ç¾©ï¼ˆä¸èƒ½æ”¹ï¼‰ï¼Œä¹Ÿé¿å…èª¤æœƒ
      btnCloudUp.disabled = !isAdmin();
    }

    // ====== Events: table/card changes ======
    function onChangeCommon(idx, key, value){
      if(!isAdmin()) return;

      const u = auth[idx];
      if(!u) return;

      if(key === "username"){
        u.username = String(value || "").trim();
      }else if(key === "password"){
        u.password = String(value || "").trim();
      }else if(key === "role"){
        u.role = clampRole(value);
        // role æ”¹è®Šæœƒå½±éŸ¿ã€Œç³»çµ±/æ¬Šé™ã€é¡¯ç¤º
      }else if(["btn1","btn2","btn3","btn4","btn5"].includes(key)){
        u.btn[key] = !!value;
      }

      // åŒæ­¥ï¼šè‹¥æ”¹åˆ°ç›®å‰ç™»å…¥çš„å¸³è™Ÿé‚£åˆ—ï¼Œæ›´æ–° current.roleï¼ˆè®“ admin ç·¨è¼¯ç«‹åˆ»ç”Ÿæ•ˆï¼‰
      if(current.username && u.username === current.username){
        current.role = u.role;
        writeJSON(CURRENT_KEY, current);
        refreshTopUser();
      }

      saveLocal();
      renderAll();
    }

    function hookDesktopEvents(){
      tbody.addEventListener("input", (e) => {
        const tr = e.target.closest("tr[data-idx]");
        if(!tr) return;
        const idx = Number(tr.dataset.idx);
        const k = e.target.getAttribute("data-k");
        if(!k) return;
        onChangeCommon(idx, k, e.target.value);
      });

      tbody.addEventListener("change", (e) => {
        const tr = e.target.closest("tr[data-idx]");
        if(!tr) return;
        const idx = Number(tr.dataset.idx);
        const k = e.target.getAttribute("data-k");
        if(!k) return;

        if(e.target.type === "checkbox"){
          onChangeCommon(idx, k, e.target.checked);
        }else if(e.target.tagName === "SELECT"){
          onChangeCommon(idx, k, e.target.value);
        }
      });

      tbody.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-act]");
        if(!btn) return;
        const tr = e.target.closest("tr[data-idx]");
        if(!tr) return;
        const idx = Number(tr.dataset.idx);

        if(btn.dataset.act === "del"){
          doDelete(idx);
        }
      });
    }

    function hookMobileEvents(){
      cards.addEventListener("input", (e) => {
        const card = e.target.closest("[data-idx]");
        if(!card) return;
        const idx = Number(card.dataset.idx);
        const k = e.target.getAttribute("data-k");
        if(!k) return;
        onChangeCommon(idx, k, e.target.value);
      });

      cards.addEventListener("change", (e) => {
        const card = e.target.closest("[data-idx]");
        if(!card) return;
        const idx = Number(card.dataset.idx);
        const k = e.target.getAttribute("data-k");
        if(!k) return;

        if(e.target.type === "checkbox"){
          onChangeCommon(idx, k, e.target.checked);
        }else if(e.target.tagName === "SELECT"){
          onChangeCommon(idx, k, e.target.value);
        }
      });

      cards.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-act]");
        if(!btn) return;
        const card = e.target.closest("[data-idx]");
        if(!card) return;
        const idx = Number(card.dataset.idx);

        if(btn.dataset.act === "del"){
          doDelete(idx);
        }
      });
    }

    function doDelete(idx){
      if(!isAdmin()) return;

      // ä¸å…è¨±åˆªé™¤æœ€å¾Œä¸€å€‹ adminï¼ˆé¿å…é–æ­»ï¼‰
      const adminCount = auth.filter(x => x.role === "admin").length;
      const target = auth[idx];
      if(target?.role === "admin" && adminCount <= 1){
        setNote("âŒ ä¸èƒ½åˆªé™¤æœ€å¾Œä¸€å€‹ adminï¼ˆé¿å…ç³»çµ±é–æ­»ï¼‰ã€‚", true);
        return;
      }

      auth.splice(idx, 1);
      saveLocal();
      renderAll();
      setNote("âœ… å·²åˆªé™¤ä¸€åˆ—ä¸¦å„²å­˜æœ¬æ©Ÿã€‚");
    }

    // ====== Login (switch) ======
    function openLogin(){
      // ä¸‹æ‹‰é¸å–®ï¼šç”¨ auth è¡¨çš„ username
      loginUser.innerHTML = auth.map(u => `<option value="${escapeHtml(u.username)}">${escapeHtml(u.username)}</option>`).join("");
      loginPass.value = "";
      loginMsg.textContent = "è«‹é¸æ“‡å¸³è™Ÿä¸¦è¼¸å…¥å¯†ç¢¼ã€‚";
      ovLogin.classList.add("open");
    }
    function closeLogin(){ ovLogin.classList.remove("open"); }

    function doLogin(){
      const u = String(loginUser.value || "").trim();
      const p = String(loginPass.value || "").trim();

      const row = auth.find(x => x.username === u);
      if(!row){
        loginMsg.textContent = "âŒ æ‰¾ä¸åˆ°æ­¤å¸³è™Ÿã€‚";
        return;
      }
      if(row.password !== p){
        loginMsg.textContent = "âŒ å¯†ç¢¼éŒ¯èª¤ã€‚";
        return;
      }

      current = { username: row.username, role: row.role };
      writeJSON(CURRENT_KEY, current);

      refreshTopUser();
      renderAll();
      closeLogin();

      setNote(`âœ… å·²ç™»å…¥ï¼š${current.username} (${current.role})`);
    }

    // ====== Token ======
    function openToken(){
      tokenInput.value = token || "";
      tokenMsg.textContent =
        "æ³¨æ„ï¼šä¸Šå‚³éœ€è¦ scopes åŒ…å« files.content.writeã€‚\n" +
        "è‹¥å‡ºç¾ expired_access_token / HTTP 401ï¼Œä»£è¡¨ Token éæœŸï¼Œè«‹é‡æ–°è¨­å®šã€‚\n" +
        "ï¼ˆä¸å½±éŸ¿æœ¬æ©Ÿå„²å­˜ï¼Œæœ¬æ©Ÿä»å¯æ­£å¸¸ä½¿ç”¨ã€‚ï¼‰";
      ovToken.classList.add("open");
    }
    function closeToken(){ ovToken.classList.remove("open"); }

    function saveToken(){
      token = String(tokenInput.value || "").trim();
      if(token){
        localStorage.setItem(TOKEN_KEY, token);
        refreshTokenUI();
        setNote("âœ… Token å·²å„²å­˜ã€‚");
        closeToken();
      }else{
        localStorage.removeItem(TOKEN_KEY);
        refreshTokenUI();
        setNote("âš ï¸ Token å·²æ¸…é™¤ã€‚");
        closeToken();
      }
    }

    // ====== Dropbox Cloud Sync ======
    async function cloudDownload(){
      if(!token){
        setNote("âš ï¸ å°šæœªè¨­å®š Tokenï¼Œç„¡æ³•é›²ç«¯ä¸‹è¼‰ã€‚", true);
        return;
      }
      try{
        setNote("â³ é›²ç«¯ä¸‹è¼‰ä¸­â€¦");
        const res = await fetch("https://content.dropboxapi.com/2/files/download", {
          method: "POST",
          headers:{
            "Authorization": "Bearer " + token,
            "Dropbox-API-Arg": JSON.stringify({ path: CLOUD_PATH })
          }
        });

        if(!res.ok){
          const text = await res.text();
          handleDropboxError(res.status, text, "ä¸‹è¼‰");
          return;
        }

        const text = await res.text();
        const parsed = safeParseJSON(text);
        const normalized = normalizeAuth(parsed);

        if(normalized.length === 0){
          setNote("âš ï¸ é›²ç«¯æª”æ¡ˆå…§å®¹æ ¼å¼ä¸æ­£ç¢ºæˆ–ç‚ºç©ºï¼Œå·²ä¿ç•™æœ¬æ©Ÿè³‡æ–™ä¸è¦†è“‹ã€‚", true);
          return;
        }

        auth = normalized;
        writeJSON(AUTH_KEY, auth);

        // ä¸‹è¼‰å¾Œï¼Œå¦‚æœ current å°æ‡‰ä¸åˆ°ï¼Œç¶­æŒ read
        loadCurrent();
        renderAll();

        elLocalState.textContent = "å·²å„²å­˜";
        setNote("âœ… é›²ç«¯ä¸‹è¼‰æˆåŠŸï¼Œå·²æ›´æ–°æœ¬æ©Ÿè³‡æ–™ã€‚");
      }catch(err){
        setNote("âŒ é›²ç«¯ä¸‹è¼‰å¤±æ•—ï¼š" + (err?.message || err), true);
      }
    }

    async function cloudUpload(){
      if(!isAdmin()){
        setNote("âš ï¸ åªæœ‰ admin æ‰èƒ½ä¸Šå‚³ã€‚", true);
        return;
      }
      if(!token){
        setNote("âš ï¸ å°šæœªè¨­å®š Tokenï¼Œç„¡æ³•é›²ç«¯ä¸Šå‚³ï¼ˆä½†æœ¬æ©Ÿå·²å¯å„²å­˜ï¼‰ã€‚", true);
        return;
      }

      // å…ˆæœ¬æ©Ÿå„²å­˜
      saveLocal();

      try{
        setNote("â³ é›²ç«¯ä¸Šå‚³ä¸­â€¦");

        const content = JSON.stringify(auth, null, 2);
        const res = await fetch("https://content.dropboxapi.com/2/files/upload", {
          method: "POST",
          headers:{
            "Authorization": "Bearer " + token,
            "Content-Type": "application/octet-stream",
            "Dropbox-API-Arg": JSON.stringify({
              path: CLOUD_PATH,
              mode: "overwrite",
              autorename: false,
              mute: true
            })
          },
          body: new TextEncoder().encode(content)
        });

        if(!res.ok){
          const text = await res.text();
          handleDropboxError(res.status, text, "ä¸Šå‚³");
          return;
        }

        setNote("âœ… ä¸Šå‚³æˆåŠŸï¼ˆå·²è¦†è“‹é›²ç«¯æª”æ¡ˆï¼‰ã€‚");
      }catch(err){
        setNote("âŒ é›²ç«¯ä¸Šå‚³å¤±æ•—ï¼š" + (err?.message || err), true);
      }
    }

    function handleDropboxError(status, text, actionName){
      // ä¸è¦è®“éŒ¯èª¤æ¸…ç©ºè¡¨æ ¼ï¼ˆé‡é»ä¿®æ­£ï¼‰
      let msg = `âŒ é›²ç«¯${actionName}å¤±æ•—ï¼šHTTP ${status}\n`;

      // Dropbox å¸¸è¦‹ JSON éŒ¯èª¤
      const j = safeParseJSON(text);
      const summary = j?.error_summary || j?.error?.error_summary;
      const tag = j?.error?.[".tag"] || j?.error?.tag;

      if(summary) msg += summary + "\n";
      if(tag) msg += `(${tag})\n`;

      // ç‰¹åˆ¥è™•ç† Token éæœŸ / æ¬Šé™ä¸è¶³
      if(String(text).includes("expired_access_token") || status === 401){
        msg += "\nâ¡ï¸ Token å¯èƒ½å·²éæœŸï¼Œè«‹æŒ‰ã€Œè¨­å®š Tokenã€é‡æ–°è²¼ä¸Šã€‚\n";
      }
      if(String(text).includes("files.content.write") || String(text).includes("missing_scope")){
        msg += "\nâ¡ï¸ Token scopes ä¸è¶³ï¼ˆéœ€è¦ files.content.writeï¼‰ï¼Œè«‹é‡æ–°ç”³è«‹å«å¯«å…¥æ¬Šé™çš„ Tokenã€‚\n";
      }

      // è‹¥æ˜¯æ‰¾ä¸åˆ°æª”æ¡ˆï¼ˆä¸‹è¼‰æ™‚ï¼‰
      if(String(text).includes("path/not_found")){
        msg += "\nâ¡ï¸ é›²ç«¯å°šæœªæœ‰æª”æ¡ˆï¼Œè«‹å…ˆç”¨ admin æŒ‰ã€Œå„²å­˜ä¸¦ä¸Šå‚³ã€å»ºç«‹ä¸€æ¬¡ã€‚\n";
      }

      setNote(msg.trim(), true);
    }

    // ====== Add row ======
    function addRow(){
      if(!isAdmin()) return;

      auth.push({
        username: "new_user",
        password: "",
        role: "read",
        btn: { btn1:false, btn2:false, btn3:false, btn4:false, btn5:false }
      });
      saveLocal();
      renderAll();
      setNote("âœ… å·²æ–°å¢ä¸€åˆ—ï¼ˆè«‹ä¿®æ”¹ä½¿ç”¨è€…/å¯†ç¢¼/æ¬Šé™ï¼‰ã€‚");
    }

    // ====== Navigation ======
    function goHome(){
      // è‹¥ä½ çš„é¦–é æª”åæ˜¯ index.htmlï¼Œé€™è£¡å°±å›å»
      location.href = "index.html";
    }

    // ====== Menuï¼ˆæ‰‹æ©Ÿæ›´å¤šï¼‰ ======
    function toggleMore(open){
      const willOpen = (typeof open === "boolean") ? open : !moreMenu.classList.contains("open");
      moreMenu.classList.toggle("open", willOpen);
    }

    document.addEventListener("click", (e) => {
      // é»å¤–é¢é—œé–‰æ›´å¤š
      if(!e.target.closest(".more")){
        toggleMore(false);
      }
    });

    btnMore.addEventListener("click", () => toggleMore());
    moreMenu.addEventListener("click", (e) => {
      const b = e.target.closest("button[data-act]");
      if(!b) return;
      toggleMore(false);
      const act = b.dataset.act;
      if(act === "switch") openLogin();
      if(act === "token") openToken();
      if(act === "down") cloudDownload();
      if(act === "up") cloudUpload();
    });

    // ====== Compatibility Watch (è‡ªå‹•åŒæ­¥æŒ‰éµåç¨± / æœ¬æ©Ÿè³‡æ–™) ======
    function startWatches(){
      // 1) ç›£çœ‹é¦–é æŒ‰éµåç¨±è®Šæ›´ï¼ˆè‹¥ index æœ‰æ›´æ–° localStorageï¼Œé€™è£¡æœƒè‡ªå‹•åˆ·æ–°æ¬„ä½æ¨™é¡Œï¼‰
      setInterval(() => {
        const got = readFirstKey([HOME_BTN_KEY, ...HOME_BTN_KEY_ALIASES]);
        const parsed = got.value ? safeParseJSON(got.value) : null;
        const nb = normalizeHomeBtns(parsed || DEFAULT_HOME_BTNS);
        const s = sig(nb);
        if(s !== lastHomeBtnSig){
          homeBtns = nb;
          lastHomeBtnSig = s;
          renderAll();
          setNote("ğŸ”„ å·²åŒæ­¥é¦–é æŒ‰éµåç¨±ï¼ˆæ¬„ä½æ¨™é¡Œå·²æ›´æ–°ï¼‰ã€‚");
        }
      }, 1200);

      // 2) ç›£çœ‹ auth è¡¨æ˜¯å¦è¢«å…¶ä»–åˆ†é æ”¹å‹•ï¼ˆé¿å…æ‰‹æ©Ÿ/æ¡Œæ©Ÿä¸åŒæ­¥ï¼‰
      window.addEventListener("storage", (ev) => {
        if(ev.key === AUTH_KEY || AUTH_KEY_ALIASES.includes(ev.key)){
          loadAuth();
          loadCurrent();
          renderAll();
        }
        if(ev.key === CURRENT_KEY || CURRENT_KEY_ALIASES.includes(ev.key)){
          loadCurrent();
          renderAll();
        }
        if(ev.key === TOKEN_KEY || TOKEN_KEY_ALIASES.includes(ev.key)){
          loadToken();
        }
      });

      // 3) å®¹éŒ¯ï¼šè‹¥ auth è¢«æ„å¤–æ¸…ç©ºï¼Œç«‹å³è£œ seedï¼ˆé¿å…ä½ çœ‹åˆ°ã€Œå°šç„¡è³‡æ–™ã€ï¼‰
      setInterval(() => {
        const s = sig(auth);
        if(!auth.length){
          loadAuth();
          loadCurrent();
          renderAll();
          setNote("âš ï¸ åµæ¸¬åˆ°è³‡æ–™ç‚ºç©ºï¼Œå·²è‡ªå‹•æ¢å¾©é è¨­æ¬Šé™è¡¨ï¼ˆé¿å…ç©ºç™½ï¼‰ã€‚", true);
        }else if(s !== lastAuthSig){
          lastAuthSig = s;
        }
      }, 2000);
    }

    // ====== Escape ======
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // ====== Init ======
    function init(){
      loadAuth();
      loadHomeBtns();
      loadCurrent();
      loadToken();

      refreshTopUser();
      renderAll();

      hookDesktopEvents();
      hookMobileEvents();
      startWatches();

      // Buttons
      btnSwitch.addEventListener("click", openLogin);
      btnHome.addEventListener("click", goHome);
      btnHomeM.addEventListener("click", goHome);

      btnToken.addEventListener("click", openToken);
      btnCloudDown.addEventListener("click", cloudDownload);
      btnCloudUp.addEventListener("click", cloudUpload);

      btnAdd.addEventListener("click", addRow);
      btnSaveLocal.addEventListener("click", () => {
        if(!isAdmin()){
          setNote("âš ï¸ åªæœ‰ admin æ‰èƒ½å„²å­˜ï¼ˆå…¶ä»–æ¬Šé™åƒ…å¯æŸ¥çœ‹ï¼‰ã€‚", true);
          return;
        }
        saveLocal();
      });

      // Login modal
      btnCloseLogin.addEventListener("click", closeLogin);
      ovLogin.addEventListener("click", (e) => { if(e.target === ovLogin) closeLogin(); });
      btnDoLogin.addEventListener("click", doLogin);
      loginPass.addEventListener("keydown", (e) => { if(e.key === "Enter") doLogin(); });

      // Token modal
      btnCloseToken.addEventListener("click", closeToken);
      ovToken.addEventListener("click", (e) => { if(e.target === ovToken) closeToken(); });
      btnSaveToken.addEventListener("click", saveToken);

      // åˆå§‹ç‹€æ…‹æç¤º
      if(!current.username){
        setNote("â„¹ï¸ ç›®å‰å°šæœªç™»å…¥ï¼ˆé¡¯ç¤ºç‚º readï¼‰ã€‚è«‹æŒ‰ã€Œåˆ‡æ›å¸³è™Ÿã€ç”¨ alex/admin ç™»å…¥å¾Œå³å¯ç·¨è¼¯ã€‚");
      }else{
        setNote(`âœ… å·²è¼‰å…¥è³‡æ–™ã€‚ç›®å‰ä½¿ç”¨è€…ï¼š${current.username} (${current.role})`);
      }
    }

    init();
  </script>
</body>
</html>
