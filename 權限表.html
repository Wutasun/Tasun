<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tasun 權限表</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#050302;
      --bg1:#0b0a08;
      --gold:#f6d37a;
      --gold2:#ffdca0;
      --gold-soft: rgba(246, 211, 122, .72);
      --border: rgba(246, 211, 122, .28);
      --panel: rgba(22, 20, 16, .62);
      --panel2: rgba(10, 9, 7, .56);
      --shadow: rgba(0,0,0,.55);
      --radius: 22px;
      --radius2: 16px;
      --btnH: 44px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:"Noto Serif TC","Microsoft JhengHei",system-ui,-apple-system,Segoe UI,sans-serif;
      color: var(--gold2);
      background:
        radial-gradient(circle at 18% 10%, rgba(246,211,122,.18), transparent 52%),
        radial-gradient(circle at 85% 90%, rgba(246,211,122,.14), transparent 55%),
        radial-gradient(circle at 45% 45%, rgba(255,220,160,.08), transparent 60%),
        linear-gradient(180deg, #060503 0%, #050302 40%, #060503 100%);
      overflow-x:hidden;
    }

    /* Glass card look */
    .glass{
      background: linear-gradient(135deg, rgba(246,211,122,.12), rgba(0,0,0,.35));
      border: 1px solid var(--border);
      box-shadow:
        0 22px 60px rgba(0,0,0,.55),
        0 8px 20px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: var(--radius);
    }

    /* Top bars */
    .topbar{
      width:min(1180px, calc(100% - 28px));
      margin: 14px auto 0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(246,211,122,.10), rgba(0,0,0,.40));
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      color: var(--gold2);
      white-space:nowrap;
      font-size: 14px;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }

    .btn{
      height: var(--btnH);
      padding: 0 16px;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.38);
      color: var(--gold2);
      cursor:pointer;
      background:
        radial-gradient(circle at 30% 20%, rgba(246,211,122,.20), transparent 40%),
        linear-gradient(180deg, rgba(246,211,122,.16), rgba(0,0,0,.55));
      box-shadow:
        0 12px 26px rgba(0,0,0,.42),
        inset 0 1px 0 rgba(255,255,255,.10);
      transition: transform .12s ease, filter .12s ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.03); }
    .btn:active{ transform: translateY(0px) scale(.995); }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none !important;
      filter:none !important;
    }

    .btn.primary{
      border-color: rgba(246,211,122,.55);
      background:
        radial-gradient(circle at 30% 20%, rgba(246,211,122,.28), transparent 45%),
        linear-gradient(180deg, rgba(246,211,122,.22), rgba(0,0,0,.60));
    }

    .btn.ghost{
      background: linear-gradient(180deg, rgba(246,211,122,.10), rgba(0,0,0,.35));
    }

    .statusPill{
      height: var(--btnH);
      padding: 0 14px;
      display:inline-flex;
      align-items:center;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.26);
      background: rgba(0,0,0,.35);
      color: rgba(246,211,122,.95);
      font-size: 13px;
      white-space:nowrap;
    }

    /* Main panel */
    .wrap{
      width:min(1180px, calc(100% - 28px));
      margin: 14px auto 40px;
      padding: 0;
    }

    .panelHeader{
      padding: 22px 24px 14px;
      border-bottom: 1px solid rgba(246,211,122,.20);
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .title{
      letter-spacing: .20em;
      font-weight: 700;
      font-size: clamp(26px, 3.2vw, 38px);
      text-shadow: 0 10px 24px rgba(0,0,0,.55);
      color: rgba(246,211,122,.95);
    }
    .subtitle{
      opacity:.92;
      line-height:1.6;
      font-size: 14px;
      color: rgba(246,211,122,.82);
    }
    .hint{
      margin-top: 6px;
      font-size: 13px;
      color: rgba(246,211,122,.68);
    }

    /* Desktop table */
    .tableWrap{
      padding: 10px 14px 18px;
    }

    table{
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    thead th{
      font-size: 13px;
      font-weight: 600;
      color: rgba(246,211,122,.85);
      padding: 10px 10px;
      border-bottom: 1px solid rgba(246,211,122,.18);
      text-align:center;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    tbody td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(246,211,122,.12);
      vertical-align: middle;
    }
    tbody tr:hover{
      background: rgba(246,211,122,.04);
    }

    .cellCenter{ text-align:center; }

    .input{
      width: 100%;
      height: 34px;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.26);
      background: rgba(0,0,0,.50);
      color: rgba(246,211,122,.95);
      outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .input:disabled{
      opacity:.65;
    }

    select.input{
      appearance:none;
      -webkit-appearance:none;
      background:
        linear-gradient(180deg, rgba(246,211,122,.06), rgba(0,0,0,.52));
    }

    .check{
      width: 18px; height: 18px;
      accent-color: #f6d37a;
      cursor:pointer;
      transform: translateY(1px);
    }
    .check:disabled{
      cursor:not-allowed;
      opacity:.65;
    }

    .delBtn{
      height: 34px;
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.30);
      background: rgba(0,0,0,.45);
      color: rgba(246,211,122,.90);
      cursor:pointer;
    }
    .delBtn:hover{ filter: brightness(1.06); }
    .delBtn:disabled{ opacity:.55; cursor:not-allowed; }

    .footbar{
      padding: 14px 18px 18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
      flex-wrap:wrap;
    }

    .msg{
      padding: 10px 16px;
      border-top: 1px solid rgba(246,211,122,.12);
      color: rgba(246,211,122,.80);
      font-size: 13px;
      white-space: pre-wrap;
      line-height:1.55;
      min-height: 44px;
    }

    /* Mobile: Return / More dropdown */
    .mobileTop{
      display:none;
      width:min(1180px, calc(100% - 28px));
      margin: 14px auto 0;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .mobileTop .left{
      display:flex;
      gap:10px;
      align-items:center;
      flex: 1;
      min-width: 0;
    }
    .mobileTop .right{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
    }

    .moreWrap{
      position:relative;
    }
    .morePanel{
      position:absolute;
      right:0;
      top: calc(var(--btnH) + 10px);
      width: min(320px, calc(100vw - 28px));
      padding: 10px;
      border-radius: 18px;
      border: 1px solid rgba(246,211,122,.24);
      background: rgba(0,0,0,.70);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 18px 50px rgba(0,0,0,.60);
      display:none;
      z-index: 50;
    }
    .morePanel .mBtn{
      width:100%;
      height: 46px;
      border-radius: 14px;
      border: 1px solid rgba(246,211,122,.22);
      background: linear-gradient(180deg, rgba(246,211,122,.12), rgba(0,0,0,.55));
      color: rgba(246,211,122,.92);
      cursor:pointer;
      margin: 6px 0;
      font-size: 15px;
    }
    .morePanel .mBtn:disabled{ opacity:.55; cursor:not-allowed; }
    .morePanel .sep{
      height:1px;
      background: rgba(246,211,122,.14);
      margin: 8px 0;
    }

    /* Mobile cards */
    .mobileCards{
      display:none;
      padding: 10px 14px 18px;
    }
    details.card{
      border: 1px solid rgba(246,211,122,.18);
      border-radius: 18px;
      background: rgba(0,0,0,.34);
      box-shadow: 0 16px 40px rgba(0,0,0,.45);
      margin: 10px 0;
      overflow:hidden;
    }
    details.card summary{
      list-style:none;
      cursor:pointer;
      padding: 14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: linear-gradient(180deg, rgba(246,211,122,.08), rgba(0,0,0,.40));
      user-select:none;
    }
    details.card summary::-webkit-details-marker{ display:none; }
    .cardTitle{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .uName{
      font-size: 16px;
      font-weight: 700;
      color: rgba(246,211,122,.95);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .rolePill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size: 12px;
      color: rgba(246,211,122,.82);
      opacity:.95;
    }
    .chev{
      opacity:.75;
      font-size: 14px;
      padding: 0 6px;
    }

    .cardBody{
      padding: 12px 14px 14px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .field label{
      display:block;
      font-size: 12px;
      color: rgba(246,211,122,.78);
      margin: 2px 2px 6px;
    }

    .btnScroller{
      border: 1px solid rgba(246,211,122,.14);
      border-radius: 16px;
      background: rgba(0,0,0,.26);
      padding: 10px 10px;
      overflow:auto hidden;   /* 橫向滑動 */
      -webkit-overflow-scrolling: touch;
      white-space:nowrap;
    }
    .btnChip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.16);
      background: rgba(0,0,0,.34);
      margin-right: 10px;
      margin-bottom: 10px;
      vertical-align:top;
    }
    .btnChip span{
      font-size: 13px;
      color: rgba(246,211,122,.92);
      max-width: 180px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .cardActions{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
      margin-top: 4px;
    }
    .cardActions .danger{
      border-color: rgba(246,211,122,.28);
      background: rgba(0,0,0,.38);
    }

    /* Overlays */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.68);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 100;
      padding: 18px;
    }
    .modal{
      width: min(520px, 96vw);
      border-radius: 22px;
      border: 1px solid rgba(246,211,122,.22);
      background: rgba(0,0,0,.72);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 22px 60px rgba(0,0,0,.65);
      padding: 16px 16px 14px;
      color: rgba(246,211,122,.92);
    }
    .modal h3{
      margin: 6px 6px 10px;
      font-size: 18px;
      letter-spacing:.12em;
    }
    .modal .row{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      padding: 6px;
    }
    .modal .row .grow{ flex:1; min-width: 200px; }
    .modal .actionsRow{
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      padding: 10px 6px 6px;
    }
    .smallNote{
      font-size: 12px;
      opacity:.8;
      margin: 0 6px 8px;
      line-height:1.55;
    }

    /* Responsive */
    @media (max-width: 900px){
      .topbar{ display:none; }
      .mobileTop{ display:flex; }
    }
    @media (max-width: 900px){
      .tableWrap{ display:none; }
      .mobileCards{ display:block; }
      .panelHeader{ padding: 18px 18px 12px; }
    }
  </style>
</head>

<body>
  <!-- Desktop Topbar -->
  <div class="topbar">
    <div class="pill" id="pillUser">目前使用者：—</div>

    <div class="actions">
      <button class="btn ghost" id="btnSwitch">切換帳號</button>
      <button class="btn ghost" id="btnHome">返回首頁</button>
      <button class="btn ghost" id="btnToken">設定 Token</button>
      <button class="btn ghost" id="btnCloudDown">雲端下載</button>
      <button class="btn primary" id="btnCloudUp">儲存並上傳</button>
    </div>
  </div>

  <!-- Mobile Topbar: 返回 / 更多 -->
  <div class="mobileTop">
    <div class="left">
      <div class="pill" id="pillUserM" style="min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">目前使用者：—</div>
    </div>
    <div class="right">
      <button class="btn ghost" id="mBtnHome">返回</button>
      <div class="moreWrap">
        <button class="btn ghost" id="mBtnMore">更多</button>
        <div class="morePanel" id="morePanel">
          <button class="mBtn" id="mBtnSwitch">切換帳號</button>
          <div class="sep"></div>
          <button class="mBtn" id="mBtnToken">設定 Token</button>
          <button class="mBtn" id="mBtnCloudDown">雲端下載</button>
          <button class="mBtn" id="mBtnCloudUp">儲存並上傳</button>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap glass">
    <div class="panelHeader">
      <div class="title">Tasun 權限表</div>
      <div class="subtitle">
        只有 <b>admin</b> 可以編輯；其他權限只能查看。<br>
        （按鍵欄位標題會自動改為「首頁按鍵名稱」，並會隨首頁按鍵新增/改名自動同步）
      </div>
      <div class="hint" id="editHint">（—）</div>
    </div>

    <!-- Desktop Table -->
    <div class="tableWrap">
      <div style="overflow:auto; -webkit-overflow-scrolling:touch;">
        <table>
          <thead>
            <tr id="theadRow">
              <!-- JS render -->
            </tr>
          </thead>
          <tbody id="tbody">
            <!-- JS render -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Mobile Cards -->
    <div class="mobileCards" id="cards">
      <!-- JS render -->
    </div>

    <div class="footbar">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <button class="btn ghost" id="btnAdd">＋ 新增一列</button>
        <button class="btn ghost" id="btnSaveLocal">只儲存本機</button>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <div class="statusPill" id="statusPill">狀態：—</div>
      </div>
    </div>

    <div class="msg" id="msg"></div>
  </div>

  <!-- Switch Account Overlay -->
  <div class="overlay" id="switchOverlay" aria-hidden="true">
    <div class="modal">
      <h3>切換帳號</h3>
      <div class="smallNote">
        若你已在本機儲存權限表，帳號清單會自動出現在下拉選單。<br>
        admin 才能修改資料。
      </div>
      <div class="row">
        <div class="grow">
          <label style="display:block; font-size:12px; opacity:.85; margin: 0 0 6px 6px;">帳號</label>
          <select class="input" id="swUser"></select>
        </div>
        <div class="grow">
          <label style="display:block; font-size:12px; opacity:.85; margin: 0 0 6px 6px;">密碼</label>
          <input class="input" id="swPass" type="password" placeholder="輸入密碼" />
        </div>
      </div>
      <div class="actionsRow">
        <button class="btn ghost" id="swCancel">取消</button>
        <button class="btn primary" id="swOk">登入</button>
      </div>
    </div>
  </div>

  <!-- Token Overlay -->
  <div class="overlay" id="tokenOverlay" aria-hidden="true">
    <div class="modal">
      <h3>設定 Dropbox Token</h3>
      <div class="smallNote">
        你目前使用的是「手動貼 Access Token」模式。若出現 <b>expired_access_token (HTTP 401)</b>，代表 Token 已過期，請到 Dropbox App Console 重新產生新的 Token 後貼上。<br>
        <b>Permissions / scopes</b> 建議至少勾選：<b>files.content.write</b>、<b>files.content.read</b>、<b>files.metadata.read</b>，且產生新 Token 後再貼上。
      </div>
      <div class="row">
        <div class="grow">
          <label style="display:block; font-size:12px; opacity:.85; margin: 0 0 6px 6px;">Access Token</label>
          <input class="input" id="tokInput" type="password" placeholder="貼上 Dropbox Access Token" />
        </div>
      </div>
      <div class="row">
        <div class="grow">
          <label style="display:block; font-size:12px; opacity:.85; margin: 0 0 6px 6px;">上傳檔案路徑（App folder 建議用 /auth_table.json）</label>
          <input class="input" id="pathInput" type="text" placeholder="/auth_table.json" />
        </div>
      </div>
      <div class="actionsRow">
        <button class="btn ghost" id="tokCancel">取消</button>
        <button class="btn primary" id="tokSave">儲存</button>
      </div>
    </div>
  </div>

  <script>
    /********************
     * Storage Keys
     ********************/
    const AUTH_KEY   = "tasunAuthTable_v1";
    const CURRENT_KEY= "tasunCurrentUser_v1";
    const HOME_BTNS_KEY = "tasunHomeButtons_v1"; // 由首頁（index.html）寫入：[{key:"btn1",label:"..."}...]
    const DBX_TOKEN_KEY = "tasunDbxToken_v1";
    const DBX_PATH_KEY  = "tasunDbxPath_v1";

    /********************
     * Default Data
     ********************/
    const DEFAULT_BUTTONS = [
      { key:"btn1", label:"臻鼎時代大廈管理表" },
      { key:"btn2", label:"缺失 / 品質" },
      { key:"btn3", label:"雲端檔案" },
      { key:"btn4", label:"工程資料庫" },
      { key:"btn5", label:"資料庫" }
    ];

    const DEFAULT_USERS = [
      { user:"alex",  pass:"Tasun08040224", role:"admin", perms:{btn1:true,btn2:true,btn3:true,btn4:true,btn5:true}, sys:true },
      { user:"tasun", pass:"tasun08040224", role:"write", perms:{btn1:true,btn2:true,btn3:true,btn4:true,btn5:true}, sys:false },
      { user:"wu",    pass:"123456",        role:"read",  perms:{btn1:true,btn2:false,btn3:false,btn4:false,btn5:true}, sys:false },
      { user:"JOYCE", pass:"09220224",       role:"admin", perms:{btn1:true,btn2:true,btn3:true,btn4:true,btn5:false}, sys:true }
    ];

    /********************
     * DOM
     ********************/
    const pillUser = document.getElementById("pillUser");
    const pillUserM= document.getElementById("pillUserM");
    const editHint = document.getElementById("editHint");
    const statusPill = document.getElementById("statusPill");
    const msg = document.getElementById("msg");

    const btnSwitch = document.getElementById("btnSwitch");
    const btnHome   = document.getElementById("btnHome");
    const btnToken  = document.getElementById("btnToken");
    const btnCloudDown = document.getElementById("btnCloudDown");
    const btnCloudUp   = document.getElementById("btnCloudUp");
    const btnAdd    = document.getElementById("btnAdd");
    const btnSaveLocal = document.getElementById("btnSaveLocal");

    const mBtnHome = document.getElementById("mBtnHome");
    const mBtnMore = document.getElementById("mBtnMore");
    const morePanel= document.getElementById("morePanel");
    const mBtnSwitch = document.getElementById("mBtnSwitch");
    const mBtnToken  = document.getElementById("mBtnToken");
    const mBtnCloudDown = document.getElementById("mBtnCloudDown");
    const mBtnCloudUp   = document.getElementById("mBtnCloudUp");

    const theadRow = document.getElementById("theadRow");
    const tbody = document.getElementById("tbody");
    const cards = document.getElementById("cards");

    const switchOverlay = document.getElementById("switchOverlay");
    const swUser = document.getElementById("swUser");
    const swPass = document.getElementById("swPass");
    const swCancel = document.getElementById("swCancel");
    const swOk = document.getElementById("swOk");

    const tokenOverlay = document.getElementById("tokenOverlay");
    const tokInput = document.getElementById("tokInput");
    const pathInput = document.getElementById("pathInput");
    const tokCancel = document.getElementById("tokCancel");
    const tokSave = document.getElementById("tokSave");

    /********************
     * State
     ********************/
    let data = null;          // {buttons:[], users:[], updatedAt}
    let buttons = [];         // normalized buttons array
    let current = null;       // {user, role}
    let isAdmin = false;
    let dirty = false;

    /********************
     * Utilities
     ********************/
    function nowISO(){ return new Date().toISOString(); }

    function safeJsonParse(s, fallback){
      try{ return JSON.parse(s); }catch(e){ return fallback; }
    }

    function setMsg(t){ msg.textContent = String(t || ""); }

    function setDirty(v=true){
      dirty = v;
      refreshStatusPill();
    }

    function refreshStatusPill(){
      const tok = getDbxToken();
      const canCloud = !!tok;
      const base = canCloud ? "已設定 Token（可同步）" : "尚未設定 Token（僅本機）";
      const d = dirty ? "｜本機有變更（未上傳）" : "｜本機已儲存";
      statusPill.textContent = "狀態：" + base + d;
    }

    function normalizeButtons(){
      // priority: localStorage from homepage, then data.buttons, then default
      const fromHome = safeJsonParse(localStorage.getItem(HOME_BTNS_KEY), null);
      if(Array.isArray(fromHome) && fromHome.length){
        return fromHome
          .filter(x => x && x.key && x.label)
          .map(x => ({ key:String(x.key), label:String(x.label) }));
      }
      if(data && Array.isArray(data.buttons) && data.buttons.length){
        return data.buttons
          .filter(x => x && x.key && x.label)
          .map(x => ({ key:String(x.key), label:String(x.label) }));
      }
      return DEFAULT_BUTTONS.slice();
    }

    function normalizeData(raw){
      // 支援舊版：直接存 users array
      if(Array.isArray(raw)){
        return { buttons: DEFAULT_BUTTONS.slice(), users: raw, updatedAt: nowISO() };
      }
      if(raw && typeof raw === "object"){
        const users = Array.isArray(raw.users) ? raw.users : DEFAULT_USERS.slice();
        const btns  = Array.isArray(raw.buttons) ? raw.buttons : DEFAULT_BUTTONS.slice();
        return { buttons: btns, users: users, updatedAt: raw.updatedAt || nowISO() };
      }
      return { buttons: DEFAULT_BUTTONS.slice(), users: DEFAULT_USERS.slice(), updatedAt: nowISO() };
    }

    function normalizeUserRow(u){
      const out = {
        user: String(u?.user || ""),
        pass: String(u?.pass || ""),
        role: String(u?.role || "read"),
        perms: {},
        sys: !!u?.sys
      };
      const p = u?.perms || u || {};
      // 把 btnX 都放到 perms
      for(const b of buttons){
        const k = b.key;
        out.perms[k] = !!(p.perms ? p.perms[k] : p[k]);
      }
      // sys：admin 一律 true
      if(out.role === "admin") out.sys = true;
      return out;
    }

    function sanitizeUsers(list){
      const arr = (Array.isArray(list) ? list : []).map(normalizeUserRow);
      // 移除空帳號
      return arr.filter(x => x.user.trim().length > 0);
    }

    function getCurrent(){
      const c = safeJsonParse(localStorage.getItem(CURRENT_KEY), null);
      if(c && c.user){
        const u = data.users.find(x => x.user === c.user);
        if(u) return { user: u.user, role: u.role };
      }
      // fallback：alex
      const u0 = data.users.find(x => x.user === "alex") || data.users[0];
      if(u0) return { user: u0.user, role: u0.role };
      return { user:"", role:"read" };
    }

    function setCurrent(user){
      const u = data.users.find(x => x.user === user);
      if(!u) return;
      localStorage.setItem(CURRENT_KEY, JSON.stringify({ user:u.user, role:u.role, at: nowISO() }));
      current = { user:u.user, role:u.role };
      isAdmin = (u.role === "admin");
      refreshTopUI();
      renderAll();
      setMsg(isAdmin ? "（可編輯）" : "（僅可查看）");
    }

    function refreshTopUI(){
      const t = `目前使用者：${current?.user || "—"} (${current?.role || "—"})`;
      pillUser.textContent = t;
      pillUserM.textContent = t;
      editHint.textContent = isAdmin ? "（可編輯）" : "（僅可查看）";

      // admin 才能操作
      btnAdd.disabled = !isAdmin;
      btnSaveLocal.disabled = !isAdmin;
      btnCloudUp.disabled = !isAdmin;
      btnCloudDown.disabled = !isAdmin && !getDbxToken(); // 非 admin 仍可雲端下載？（避免功能變動：保留 admin 才能動）
      // mobile
      mBtnCloudUp.disabled = !isAdmin;
      mBtnCloudDown.disabled = !isAdmin && !getDbxToken();
    }

    /********************
     * Local Save / Load
     ********************/
    function loadLocal(){
      const raw = safeJsonParse(localStorage.getItem(AUTH_KEY), null);
      data = normalizeData(raw);
      buttons = normalizeButtons();
      // users normalize after buttons ready
      data.users = sanitizeUsers(data.users);
      data.buttons = buttons.slice();
      localStorage.setItem(AUTH_KEY, JSON.stringify(data)); // ensure normalized format
      current = getCurrent();
      isAdmin = (current.role === "admin");
      refreshTopUI();
      refreshStatusPill();
      setDirty(false);
    }

    function saveLocal(){
      data.buttons = buttons.slice();
      data.users = sanitizeUsers(data.users);
      data.updatedAt = nowISO();
      localStorage.setItem(AUTH_KEY, JSON.stringify(data));
      setDirty(false);
      setMsg("✅ 已儲存本機");
    }

    /********************
     * Dropbox
     ********************/
    function getDbxToken(){ return (localStorage.getItem(DBX_TOKEN_KEY) || "").trim(); }
    function setDbxToken(v){ localStorage.setItem(DBX_TOKEN_KEY, String(v||"").trim()); }

    function getDbxPath(){
      const p = (localStorage.getItem(DBX_PATH_KEY) || "").trim();
      return p || "/auth_table.json";
    }
    function setDbxPath(v){
      const p = String(v||"").trim();
      localStorage.setItem(DBX_PATH_KEY, p || "/auth_table.json");
    }

    function dbxEnabled(){ return !!getDbxToken(); }
    function dbxAuthHeader(){ return "Bearer " + getDbxToken(); }

    function jsonAscii(obj){
      // Dropbox-API-Arg 必須是 ASCII-safe
      return JSON.stringify(obj).replace(/[^\x20-\x7E]/g, (ch) => {
        return "\\u" + ch.charCodeAt(0).toString(16).padStart(4, "0");
      });
    }

    async function fetchWithTimeout(url, options={}, timeout=15000){
      const c = new AbortController();
      const id = setTimeout(()=>c.abort(), timeout);
      try{
        return await fetch(url, { ...options, signal:c.signal });
      }finally{
        clearTimeout(id);
      }
    }

    function parseDbxErrorText(txt){
      const t = String(txt || "");
      const j = safeJsonParse(t, null);
      const summary = (j && (j.error_summary || j.error?.error_summary)) ? String(j.error_summary || j.error?.error_summary) : "";
      const tag = (j && j.error && j.error[".tag"]) ? String(j.error[".tag"]) : "";
      return { json: j, summary, tag, raw: t };
    }
    function makeDbxError(code, message, extra=""){
      const e = new Error(message + (extra ? ("\n" + extra) : ""));
      e.code = code;
      return e;
    }

    async function dbxUploadJson(path, dataObj){
      if(!dbxEnabled()) throw makeDbxError("NO_TOKEN", "Token 未設定");

      const body = JSON.stringify(dataObj, null, 2);
      const res = await fetchWithTimeout("https://content.dropboxapi.com/2/files/upload", {
        method:"POST",
        headers:{
          "Authorization": dbxAuthHeader(),
          "Content-Type":"application/octet-stream",
          "Dropbox-API-Arg": jsonAscii({
            path,
            mode:"overwrite",
            autorename:false,
            mute:true,
            strict_conflict:false
          })
        },
        body
      }, 20000);

      const txt = await res.text();
      if(res.ok) return true;

      if(res.status === 401){
        const info = parseDbxErrorText(txt);
        if(info.tag === "expired_access_token" || info.summary.includes("expired_access_token")){
          throw makeDbxError("TOKEN_EXPIRED", "❌ Token 已過期（expired_access_token）\n請按「設定 Token」重新產生並貼上新的 Access Token。", txt);
        }
        throw makeDbxError("TOKEN_INVALID", "❌ Token 無效或已被撤銷（HTTP 401）\n請重新設定 Token。", txt);
      }

      if(res.status === 403){
        throw makeDbxError("SCOPE", "❌ 權限不足（可能 scopes 不足）\n請到 Dropbox App Console → Permissions 勾選：\n- files.content.write\n- files.content.read\n- files.metadata.read\n並重新產生 Token。", txt);
      }

      throw makeDbxError("DBX", `❌ 上傳失敗 HTTP ${res.status}`, txt);
    }

    async function dbxDownloadJson(path){
      if(!dbxEnabled()) throw makeDbxError("NO_TOKEN", "Token 未設定");

      const res = await fetchWithTimeout("https://content.dropboxapi.com/2/files/download", {
        method:"POST",
        headers:{
          "Authorization": dbxAuthHeader(),
          "Dropbox-API-Arg": jsonAscii({ path })
        }
      }, 20000);

      const txt = await res.text();
      if(res.ok){
        const j = safeJsonParse(txt, null);
        if(!j) throw makeDbxError("DBX", "❌ 雲端檔案不是 JSON", txt);
        return j;
      }

      if(res.status === 409){
        throw makeDbxError("NOT_FOUND", "❌ 雲端找不到檔案（請先上傳一次）", txt);
      }

      if(res.status === 401){
        const info = parseDbxErrorText(txt);
        if(info.tag === "expired_access_token" || info.summary.includes("expired_access_token")){
          throw makeDbxError("TOKEN_EXPIRED", "❌ Token 已過期（expired_access_token）\n請按「設定 Token」重新產生並貼上新的 Access Token。", txt);
        }
        throw makeDbxError("TOKEN_INVALID", "❌ Token 無效或已被撤銷（HTTP 401）\n請重新設定 Token。", txt);
      }

      if(res.status === 403){
        throw makeDbxError("SCOPE", "❌ 權限不足（可能 scopes 不足）\n請到 Dropbox App Console → Permissions 勾選 scopes 後，重新產生 Token。", txt);
      }

      throw makeDbxError("DBX", `❌ 雲端下載失敗 HTTP ${res.status}`, txt);
    }

    async function cloudPushFromLocal(){
      // 上傳本機 data（包含 buttons + users）
      const path = getDbxPath();
      const payload = {
        buttons: buttons.slice(),
        users: sanitizeUsers(data.users),
        updatedAt: nowISO(),
        source: "權限表.html"
      };
      await dbxUploadJson(path, payload);
    }

    async function cloudPullToLocal(){
      const path = getDbxPath();
      const remote = await dbxDownloadJson(path);
      const norm = normalizeData(remote);
      // Buttons：優先使用 remote.buttons，但仍允許首頁 localStorage 覆蓋（標題同步）
      data = norm;
      buttons = normalizeButtons();
      data.buttons = buttons.slice();
      data.users = sanitizeUsers(data.users);
      localStorage.setItem(AUTH_KEY, JSON.stringify(data));
      setDirty(false);
      // 更新 current role
      current = getCurrent();
      isAdmin = (current.role === "admin");
      refreshTopUI();
      renderAll();
    }

    function handleTokenError(err){
      const code = err?.code || "";
      if(code === "TOKEN_EXPIRED" || code === "TOKEN_INVALID"){
        setDbxToken(""); // 清掉舊 token，避免一直 401
        refreshStatusPill();
        setMsg((err?.message || String(err)) + "\n\n我已打開 Token 設定視窗，請貼上新的 Access Token。");
        showTokenOverlay();
        return true;
      }
      return false;
    }

    /********************
     * Render
     ********************/
    function renderThead(){
      // 欄位：使用者、密碼、權限、(buttons...), 系統/權限、刪除
      const ths = [];
      ths.push(`<th style="width:160px;">使用者</th>`);
      ths.push(`<th style="width:180px;">密碼</th>`);
      ths.push(`<th style="width:110px;">權限</th>`);

      // buttons dynamic
      for(const b of buttons){
        ths.push(`<th title="${escapeHtml(b.label)}" style="width:110px;">${escapeHtml(b.label)}</th>`);
      }

      ths.push(`<th style="width:120px;">系統/權限</th>`);
      ths.push(`<th style="width:90px;">刪除</th>`);
      theadRow.innerHTML = ths.join("");
    }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function renderTbody(){
      const rows = sanitizeUsers(data.users);
      const html = rows.map((u, idx)=>{
        const canEditRow = isAdmin; // admin 可以編輯全部
        const sysMark = (u.role === "admin") ? "✓" : "—";

        const btnTds = buttons.map(b=>{
          const k = b.key;
          const checked = u.perms[k] ? "checked" : "";
          const dis = canEditRow ? "" : "disabled";
          return `<td class="cellCenter">
            <input class="check" type="checkbox" data-idx="${idx}" data-k="${escapeHtml(k)}" ${checked} ${dis}>
          </td>`;
        }).join("");

        return `
          <tr>
            <td>
              <input class="input" data-idx="${idx}" data-f="user" value="${escapeHtml(u.user)}" ${canEditRow ? "" : "disabled"}>
            </td>
            <td>
              <input class="input" data-idx="${idx}" data-f="pass" value="${escapeHtml(u.pass)}" ${canEditRow ? "" : "disabled"}>
            </td>
            <td class="cellCenter">
              <select class="input" data-idx="${idx}" data-f="role" ${canEditRow ? "" : "disabled"}>
                <option value="admin" ${u.role==="admin"?"selected":""}>admin</option>
                <option value="write" ${u.role==="write"?"selected":""}>write</option>
                <option value="read"  ${u.role==="read" ?"selected":""}>read</option>
              </select>
            </td>

            ${btnTds}

            <td class="cellCenter" style="color: rgba(246,211,122,.92);">
              ${sysMark}
            </td>
            <td class="cellCenter">
              <button class="delBtn" data-idx="${idx}" data-act="del" ${canEditRow ? "" : "disabled"}>刪除</button>
            </td>
          </tr>
        `;
      }).join("");
      tbody.innerHTML = html || `<tr><td colspan="${6+buttons.length}" style="text-align:center; padding:16px; opacity:.8;">（尚無資料）</td></tr>`;
    }

    function renderCards(){
      const rows = sanitizeUsers(data.users);
      const html = rows.map((u, idx)=>{
        const canEditRow = isAdmin;
        const sysMark = (u.role === "admin") ? "✓" : "—";
        const btnChips = buttons.map(b=>{
          const k = b.key;
          const checked = u.perms[k] ? "checked" : "";
          const dis = canEditRow ? "" : "disabled";
          return `
            <label class="btnChip">
              <input class="check" type="checkbox" data-idx="${idx}" data-k="${escapeHtml(k)}" ${checked} ${dis}>
              <span title="${escapeHtml(b.label)}">${escapeHtml(b.label)}</span>
            </label>
          `;
        }).join("");

        return `
          <details class="card">
            <summary>
              <div class="cardTitle">
                <div class="uName">${escapeHtml(u.user)}</div>
                <div class="rolePill">權限：${escapeHtml(u.role)}　｜　系統/權限：${sysMark}</div>
              </div>
              <div class="chev">▼</div>
            </summary>

            <div class="cardBody">
              <div class="row2">
                <div class="field">
                  <label>使用者</label>
                  <input class="input" data-idx="${idx}" data-f="user" value="${escapeHtml(u.user)}" ${canEditRow ? "" : "disabled"}>
                </div>
                <div class="field">
                  <label>密碼</label>
                  <input class="input" data-idx="${idx}" data-f="pass" value="${escapeHtml(u.pass)}" ${canEditRow ? "" : "disabled"}>
                </div>
              </div>

              <div class="field">
                <label>權限</label>
                <select class="input" data-idx="${idx}" data-f="role" ${canEditRow ? "" : "disabled"}>
                  <option value="admin" ${u.role==="admin"?"selected":""}>admin</option>
                  <option value="write" ${u.role==="write"?"selected":""}>write</option>
                  <option value="read"  ${u.role==="read" ?"selected":""}>read</option>
                </select>
              </div>

              <div class="field">
                <label>按鍵顯示（橫向滑動）</label>
                <div class="btnScroller">
                  ${btnChips}
                </div>
              </div>

              <div class="cardActions">
                <button class="btn ghost danger" data-idx="${idx}" data-act="del" ${canEditRow ? "" : "disabled"}>刪除此列</button>
                <div style="opacity:.78; font-size:12px;">提示：點開/收合每列更好操作</div>
              </div>
            </div>
          </details>
        `;
      }).join("");

      cards.innerHTML = html || `<div style="text-align:center; padding:16px; opacity:.8;">（尚無資料）</div>`;
    }

    function renderAll(){
      // buttons 可能被首頁更新 → 重算一次（但不覆蓋 data.users）
      buttons = normalizeButtons();
      data.buttons = buttons.slice();
      // users 依新 buttons 補齊 perms
      data.users = sanitizeUsers(data.users);
      renderThead();
      renderTbody();
      renderCards();
      refreshStatusPill();
    }

    /********************
     * Editing (Fix: admin can edit)
     ********************/
    function getUsersNormalized(){
      return sanitizeUsers(data.users);
    }

    function commitUsers(users){
      data.users = sanitizeUsers(users);
      // 若 current user 的 role 被改，更新 current
      const u = data.users.find(x => x.user === current.user);
      if(u){
        current.role = u.role;
        isAdmin = (u.role === "admin");
        localStorage.setItem(CURRENT_KEY, JSON.stringify({ user:u.user, role:u.role, at: nowISO() }));
      }
      refreshTopUI();
      setDirty(true);
    }

    function onInputChange(target){
      if(!isAdmin) return;

      const idx = Number(target.getAttribute("data-idx"));
      if(Number.isNaN(idx)) return;

      const users = getUsersNormalized();
      if(!users[idx]) return;

      // checkbox for btn perms
      const k = target.getAttribute("data-k");
      if(k){
        users[idx].perms[k] = !!target.checked;
        commitUsers(users);
        return;
      }

      const f = target.getAttribute("data-f");
      if(!f) return;

      if(f === "user"){
        users[idx].user = String(target.value || "").trim();
        commitUsers(users);
        return;
      }
      if(f === "pass"){
        users[idx].pass = String(target.value || "");
        commitUsers(users);
        return;
      }
      if(f === "role"){
        users[idx].role = String(target.value || "read");
        // admin 一律 sys true
        if(users[idx].role === "admin") users[idx].sys = true;
        commitUsers(users);
        // role 改變會影響 sys 顯示 → 重渲染
        renderAll();
        return;
      }
    }

    function onDelete(idx){
      if(!isAdmin) return;
      const users = getUsersNormalized();
      if(!users[idx]) return;

      // 避免把自己刪掉（降低風險）
      if(users[idx].user === current.user){
        setMsg("❌ 不能刪除正在登入的帳號。請先切換到其他 admin 再刪除。");
        return;
      }

      users.splice(idx, 1);
      commitUsers(users);
      renderAll();
      setMsg("✅ 已刪除一列（尚未上傳）");
    }

    /********************
     * Overlays
     ********************/
    function showSwitchOverlay(){
      // build dropdown
      const users = getUsersNormalized();
      swUser.innerHTML = users.map(u => `<option value="${escapeHtml(u.user)}">${escapeHtml(u.user)} (${escapeHtml(u.role)})</option>`).join("");
      swUser.value = current?.user || (users[0]?.user || "");
      swPass.value = "";
      switchOverlay.style.display = "flex";
      switchOverlay.setAttribute("aria-hidden","false");
      setTimeout(()=>swPass.focus(), 50);
    }

    function hideSwitchOverlay(){
      switchOverlay.style.display = "none";
      switchOverlay.setAttribute("aria-hidden","true");
    }

    function showTokenOverlay(){
      tokInput.value = getDbxToken();
      pathInput.value = getDbxPath();
      tokenOverlay.style.display = "flex";
      tokenOverlay.setAttribute("aria-hidden","false");
      setTimeout(()=>tokInput.focus(), 50);
    }

    function hideTokenOverlay(){
      tokenOverlay.style.display = "none";
      tokenOverlay.setAttribute("aria-hidden","true");
    }

    function closeMore(){
      morePanel.style.display = "none";
    }
    function toggleMore(){
      morePanel.style.display = (morePanel.style.display === "block") ? "none" : "block";
    }

    /********************
     * Events
     ********************/
    // Desktop buttons
    btnHome.addEventListener("click", ()=> location.href = "index.html");
    btnToken.addEventListener("click", ()=> showTokenOverlay());
    btnSwitch.addEventListener("click", ()=> showSwitchOverlay());

    btnAdd.addEventListener("click", ()=>{
      if(!isAdmin) return;
      const users = getUsersNormalized();
      // 新增預設 read
      const nu = normalizeUserRow({ user:"", pass:"", role:"read", sys:false });
      users.push(nu);
      commitUsers(users);
      renderAll();
      setMsg("✅ 已新增一列（尚未上傳）");
    });

    btnSaveLocal.addEventListener("click", ()=>{
      if(!isAdmin) return;
      saveLocal();
    });

    btnCloudUp.addEventListener("click", async ()=>{
      if(!isAdmin) return;
      setMsg("正在儲存並上傳…");
      try{
        saveLocal();
        if(!dbxEnabled()){
          setMsg("✅ 已儲存本機（尚未設定 Token，無法上傳）");
          return;
        }
        await cloudPushFromLocal();
        setDirty(false);
        setMsg("✅ 已上傳雲端並完成同步");
        refreshStatusPill();
      }catch(err){
        if(handleTokenError(err)) return;
        setMsg(err?.message || String(err));
      }
    });

    btnCloudDown.addEventListener("click", async ()=>{
      if(!isAdmin) return; // 保持原「只有 admin 控制」的行為（不改功能）
      setMsg("正在雲端下載並更新本機…");
      try{
        if(!dbxEnabled()){
          setMsg("❌ 尚未設定 Token，無法雲端下載");
          showTokenOverlay();
          return;
        }
        await cloudPullToLocal();
        setMsg("✅ 已從雲端更新到本機");
        refreshStatusPill();
      }catch(err){
        if(handleTokenError(err)) return;
        setMsg(err?.message || String(err));
      }
    });

    // Mobile buttons
    mBtnHome.addEventListener("click", ()=> location.href = "index.html");
    mBtnMore.addEventListener("click", (e)=>{ e.stopPropagation(); toggleMore(); });
    mBtnSwitch.addEventListener("click", ()=>{ closeMore(); showSwitchOverlay(); });
    mBtnToken.addEventListener("click", ()=>{ closeMore(); showTokenOverlay(); });
    mBtnCloudDown.addEventListener("click", async ()=>{ closeMore(); btnCloudDown.click(); });
    mBtnCloudUp.addEventListener("click", async ()=>{ closeMore(); btnCloudUp.click(); });

    // close more by click outside
    document.addEventListener("click", ()=>{
      if(morePanel.style.display === "block") closeMore();
    });
    morePanel.addEventListener("click", (e)=> e.stopPropagation());

    // Switch overlay
    swCancel.addEventListener("click", hideSwitchOverlay);
    switchOverlay.addEventListener("click", (e)=>{ if(e.target === switchOverlay) hideSwitchOverlay(); });

    swOk.addEventListener("click", ()=>{
      const user = swUser.value;
      const pass = swPass.value || "";
      const u = getUsersNormalized().find(x => x.user === user);
      if(!u){
        setMsg("❌ 找不到使用者");
        return;
      }
      if(u.pass !== pass){
        setMsg("❌ 密碼錯誤");
        return;
      }
      hideSwitchOverlay();
      setCurrent(user);
      setMsg(`✅ 已登入：${user} (${u.role})`);
    });

    // Token overlay
    tokCancel.addEventListener("click", hideTokenOverlay);
    tokenOverlay.addEventListener("click", (e)=>{ if(e.target === tokenOverlay) hideTokenOverlay(); });

    tokSave.addEventListener("click", ()=>{
      setDbxToken(tokInput.value || "");
      setDbxPath(pathInput.value || "/auth_table.json");
      hideTokenOverlay();
      refreshStatusPill();
      setMsg(getDbxToken() ? "✅ 已儲存 Token（可同步）" : "✅ 已清除 Token（僅本機）");
    });

    // Table / Cards input delegation
    document.addEventListener("input", (e)=>{
      const t = e.target;
      if(!(t instanceof HTMLElement)) return;
      if(t.classList.contains("input")){
        onInputChange(t);
      }
    });

    document.addEventListener("change", (e)=>{
      const t = e.target;
      if(!(t instanceof HTMLElement)) return;
      if(t.classList.contains("check")){
        onInputChange(t);
      }
      if(t.tagName === "SELECT" && t.classList.contains("input")){
        onInputChange(t);
      }
    });

    document.addEventListener("click", (e)=>{
      const t = e.target;
      if(!(t instanceof HTMLElement)) return;
      if(t.dataset && t.dataset.act === "del"){
        const idx = Number(t.dataset.idx);
        if(!Number.isNaN(idx)) onDelete(idx);
      }
    });

    // Prevent leaving with dirty changes (admin)
    window.addEventListener("beforeunload", (e)=>{
      if(isAdmin && dirty){
        e.preventDefault();
        e.returnValue = "";
      }
    });

    /********************
     * Init
     ********************/
    (function init(){
      loadLocal();
      // 讓切換帳號 dropdown 有資料
      const users = sanitizeUsers(data.users);
      if(!localStorage.getItem(CURRENT_KEY)){
        // 預設登入 alex（不改原行為：只做合理初始化）
        localStorage.setItem(CURRENT_KEY, JSON.stringify({ user: (users.find(x=>x.user==="alex")?.user || users[0]?.user || ""), role:(users.find(x=>x.user==="alex")?.role || users[0]?.role || "read"), at: nowISO() }));
      }
      current = getCurrent();
      isAdmin = (current.role === "admin");
      refreshTopUI();
      renderAll();
      setMsg(isAdmin ? "（可編輯）" : "（僅可查看）");

      // 每 2 秒檢查首頁按鍵名稱是否變動（標題同步）
      setInterval(()=>{
        const newBtns = normalizeButtons();
        // simple compare
        if(newBtns.length !== buttons.length || newBtns.some((b,i)=> b.key!==buttons[i]?.key || b.label!==buttons[i]?.label)){
          buttons = newBtns;
          data.buttons = buttons.slice();
          // users 也補齊 perms
          data.users = sanitizeUsers(data.users);
          renderAll();
          // 不強制 dirty（只是標題更新）
        }
      }, 2000);
    })();
  </script>
</body>
</html>
