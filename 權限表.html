<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Tasun æ¬Šé™è¡¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --gold: #f6d37a;
      --gold-soft: rgba(246, 211, 122, 0.75);
      --panel-border: rgba(246, 211, 122, 0.35);
      --bg: #050302;
    }

    *{ box-sizing:border-box; margin:0; padding:0; }

    body{
      min-height:100vh;
      font-family:"Noto Serif TC","æ¨™æ¥·é«”","Microsoft JhengHei",serif;
      background: radial-gradient(circle at 50% 10%, rgba(255,237,180,0.14), rgba(0,0,0,0.98));
      color: var(--gold);
      padding: clamp(14px, 2vw, 26px);
    }

    .wrap{
      max-width: 1400px;
      margin: 0 auto;
      border: 1px solid rgba(246,211,122,0.22);
      border-radius: 22px;
      box-shadow: 0 0 26px rgba(0,0,0,0.65), 0 0 18px rgba(246,211,122,0.10);
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.015));
      overflow: hidden;
    }

    header{
      padding: 18px 18px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(246,211,122,0.18);
      background: radial-gradient(circle at 50% 0%, rgba(246,211,122,0.14), rgba(0,0,0,0.0));
    }

    .title{
      font-size: clamp(1.2rem, 2.2vw, 1.6rem);
      letter-spacing: 0.2em;
      text-indent: 0.2em;
      text-shadow: 0 0 12px rgba(246,211,122,0.35);
    }

    .sub{
      font-size: 0.9rem;
      color: rgba(246,211,122,0.75);
      margin-top: 6px;
      letter-spacing: 0.08em;
    }

    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .pill{
      padding: 0.35rem 0.95rem;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,0.5);
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,0.18), rgba(0,0,0,0.88));
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .btn{
      border: 1px solid rgba(246,211,122,0.72);
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,0.22), rgba(0,0,0,0.92));
      color: var(--gold);
      border-radius: 999px;
      padding: 0.42rem 1.05rem;
      cursor: pointer;
      letter-spacing: 0.12em;
      text-indent: 0.12em;
      box-shadow: 0 8px 16px rgba(0,0,0,0.75);
      transition: transform .15s ease, box-shadow .2s ease, background .2s ease;
    }

    .btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(0,0,0,0.85);
      background: radial-gradient(circle at 0% 0%, rgba(255,244,208,0.28), rgba(0,0,0,0.92));
    }

    .content{
      padding: 18px;
    }

    h2{
      margin: 14px 0 10px;
      font-size: 1.1rem;
      letter-spacing: 0.18em;
      text-indent: 0.18em;
      color: rgba(246,211,122,0.92);
    }

    .hint{
      color: rgba(246,211,122,0.72);
      font-size: 0.9rem;
      line-height: 1.6;
      margin-bottom: 10px;
    }

    .panel{
      border: 1px solid rgba(246,211,122,0.18);
      border-radius: 18px;
      padding: 14px;
      background: radial-gradient(circle at 10% 0%, rgba(246,211,122,0.10), rgba(0,0,0,0.0));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04);
      overflow-x:auto;
    }

    table{
      width: 100%;
      border-collapse: collapse;
      min-width: 980px;
    }

    th, td{
      border-bottom: 1px solid rgba(246,211,122,0.10);
      padding: 10px 8px;
      text-align: center;
      vertical-align: middle;
      color: rgba(246,211,122,0.92);
      font-size: 0.92rem;
      white-space: nowrap;
    }

    th{
      background: rgba(246,211,122,0.10);
      color: rgba(246,211,122,0.95);
      letter-spacing: 0.12em;
      text-indent: 0.12em;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .cell-input{
      width: 100%;
      min-width: 140px;
      padding: 0.45rem 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,0.45);
      background: rgba(0,0,0,0.75);
      color: var(--gold);
      outline: none;
    }

    .cell-input:focus{
      border-color: rgba(255,238,190,0.9);
      box-shadow: 0 0 12px rgba(246,211,122,0.35);
    }

    .small{
      min-width: 110px;
    }

    .pwd-wrap{
      display:flex;
      align-items:center;
      gap: 8px;
      justify-content:center;
    }

    .eye{
      padding: 0.32rem 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,0.65);
      background: rgba(0,0,0,0.8);
      color: var(--gold);
      cursor:pointer;
    }

    .chk{
      width: 18px;
      height: 18px;
      accent-color: #2aa4ff;
      cursor:pointer;
    }

    .danger{
      border-color: rgba(255,180,180,0.55);
      color: rgba(255,210,210,0.95);
      background: radial-gradient(circle at 0% 0%, rgba(255,170,170,0.15), rgba(0,0,0,0.9));
    }

    .footer-actions{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 14px;
    }

    .note{
      color: rgba(246,211,122,0.65);
      font-size: 0.9rem;
      line-height:1.6;
    }

    /* é admin é®ç½© */
    .lock-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.86);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 20px;
      z-index: 9999;
    }
    .lock-box{
      width: min(520px, 92vw);
      border-radius: 18px;
      border: 1px solid rgba(246,211,122,0.25);
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,0.16), rgba(0,0,0,0.95));
      box-shadow: 0 0 24px rgba(0,0,0,0.85);
      padding: 22px;
      text-align:center;
    }
    .lock-box h3{
      font-size: 1.2rem;
      letter-spacing: 0.18em;
      text-indent: 0.18em;
      margin-bottom: 10px;
      color: rgba(246,211,122,0.92);
    }
    .lock-box p{
      color: rgba(246,211,122,0.72);
      line-height:1.8;
      margin-bottom: 14px;
    }

    /* âœ… Token è¨­å®šé®ç½©ï¼ˆæ–°å¢ï¼‰ */
    .token-overlay{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9998;
      background: radial-gradient(circle at 50% 18%, rgba(255, 228, 170, 0.28), rgba(0,0,0,0.98));
    }
    .token-box{
      width: min(560px, 92vw);
      border-radius: 18px;
      border: 1px solid rgba(246,211,122,0.25);
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,0.18), rgba(0,0,0,0.95));
      box-shadow: 0 0 26px rgba(0,0,0,0.92);
      padding: 20px;
      color: rgba(246,211,122,0.85);
    }
    .token-box h3{
      font-size: 1.15rem;
      letter-spacing: 0.18em;
      text-indent: 0.18em;
      margin-bottom: 10px;
      color: rgba(246,211,122,0.92);
      text-align:center;
    }
    .token-box p{
      color: rgba(246,211,122,0.72);
      line-height:1.7;
      margin-bottom: 12px;
      font-size: 0.92rem;
      text-align:center;
    }
    .token-row{
      display:flex;
      gap: 8px;
      align-items:center;
      justify-content:center;
      flex-wrap: wrap;
    }
    .token-input{
      flex: 1 1 320px;
      min-width: 260px;
      padding: 0.55rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.5);
      background: rgba(0, 0, 0, 0.82);
      color: var(--gold);
      outline: none;
    }
    .token-actions{
      margin-top: 12px;
      display:flex;
      gap: 10px;
      justify-content:center;
      flex-wrap: wrap;
    }
    .token-msg{
      margin-top: 8px;
      min-height: 1.2rem;
      text-align:center;
      color: rgba(255,180,180,0.95);
      font-size: 0.88rem;
    }

    @media (max-width: 900px){
      header{ flex-direction: column; align-items:flex-start; }
      .top-actions{ justify-content:flex-start; }
      table{ min-width: 1100px; }
    }
  </style>
</head>

<body>
  <div class="lock-overlay" id="lockOverlay">
    <div class="lock-box">
      <h3>æ¬Šé™ä¸è¶³</h3>
      <p>æ­¤é åƒ… <b>admin</b> å¯ä»¥ç·¨è¼¯ã€‚<br>è«‹å›é¦–é ä»¥ admin èº«ä»½ç™»å…¥å¾Œå†é€²å…¥ã€‚</p>
      <button class="btn" onclick="location.href='index.html'">è¿”å›é¦–é </button>
    </div>
  </div>

  <!-- âœ… Token è¨­å®šé®ç½©ï¼ˆæ–°å¢ï¼‰ -->
  <div class="token-overlay" id="tokenOverlay" aria-hidden="true">
    <div class="token-box">
      <h3>Dropbox Token è¨­å®š</h3>
      <p>æ­¤è£ç½®ç¬¬ä¸€æ¬¡ä½¿ç”¨è«‹è¼¸å…¥ Tokenï¼ˆå­˜åˆ° localStorageï¼‰ã€‚<br>æ¡Œæ©Ÿå„²å­˜å¾Œï¼Œæ‰‹æ©Ÿæ‰èƒ½è‡ªå‹•åŒæ­¥çœ‹åˆ°æ–°å¢ç”¨æˆ¶ï¼ˆä¾‹å¦‚ JOYCEï¼‰ã€‚</p>

      <div class="token-row">
        <input id="tokenInput" class="token-input" type="password" placeholder="è²¼ä¸Š Access Token" />
        <button class="btn" id="tokenEyeBtn" type="button">ğŸ‘</button>
      </div>

      <div class="token-msg" id="tokenMsg"></div>

      <div class="token-actions">
        <button class="btn" id="tokenSkipBtn" type="button">ç¨å¾Œï¼ˆåªç”¨æœ¬æ©Ÿï¼‰</button>
        <button class="btn" id="tokenSaveBtn" type="button">å„²å­˜</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <header>
      <div>
        <div class="title">Tasun æ¬Šé™è¡¨</div>
        <div class="sub">è³‡æ–™å„²å­˜ï¼šlocalStorage + Dropboxï¼ˆ/Tasun/æ¬Šé™/ï¼‰</div>
      </div>

      <div class="top-actions">
        <div class="pill" id="who">ç›®å‰ä½¿ç”¨è€…ï¼šæœªç™»å…¥</div>
        <button class="btn" id="btnPull">å¾é›²ç«¯åŒæ­¥</button>
        <button class="btn" id="btnSave">å„²å­˜è¨­å®š</button>
        <button class="btn" onclick="location.href='index.html'">è¿”å›é¦–é </button>
      </div>
    </header>

    <div class="content">

      <h2>é¦–é æŒ‰éˆ•è¨­å®š</h2>
      <div class="hint">å¯æ–°å¢/ä¿®æ”¹é¦–é æŒ‰éˆ•åç¨±èˆ‡é€£çµã€‚æ­¤è¨­å®šæœƒåŒæ­¥åˆ° index.html ä¸¦å½±éŸ¿å„å¸³è™Ÿå‹¾é¸æ¬Šé™ã€‚</div>
      <div class="panel">
        <table id="navTable">
          <thead>
            <tr>
              <th style="width:60px;">åº</th>
              <th>æŒ‰éˆ•åç¨±</th>
              <th>é€£çµï¼ˆhrefï¼‰</th>
              <th style="width:120px;">é–‹å•Ÿæ–¹å¼</th>
              <th style="width:120px;">åˆªé™¤</th>
            </tr>
          </thead>
          <tbody id="navTbody"></tbody>
        </table>

        <div class="footer-actions">
          <button class="btn" id="btnAddNav">ï¼‹ æ–°å¢ä¸€é¡†æŒ‰éˆ•</button>
          <div class="note">å»ºè­°ï¼šå¤–éƒ¨ç¶²å€å¯ç”¨ <b>_blank</b> æ–°é–‹è¦–çª—ï¼›ç«™å…§é é¢å¡«ç›¸å°è·¯å¾‘å³å¯ã€‚</div>
        </div>
      </div>

      <h2 style="margin-top:22px;">å¸³è™Ÿæ¬Šé™è¨­å®š</h2>
      <div class="hint">æ–°å¢å¸³è™Ÿå¾Œï¼Œæ¡Œæ©Ÿå„²å­˜â†’æ‰‹æ©Ÿç™»å…¥æœƒè‡ªå‹•åŒæ­¥é¡¯ç¤ºï¼ˆä¾‹å¦‚ JOYCEï¼‰ã€‚</div>

      <div class="panel">
        <table id="authTable">
          <thead id="authThead"></thead>
          <tbody id="authTbody"></tbody>
        </table>

        <div class="footer-actions">
          <button class="btn" id="btnAddUser">ï¼‹ æ–°å¢ä¸€åˆ—å¸³è™Ÿ</button>
          <div class="note">âš ï¸ æé†’ï¼šToken å­˜åœ¨ç€è¦½å™¨ localStorageï¼›è«‹å‹¿æŠŠæ­¤é å…¬é–‹çµ¦ä¸ä¿¡ä»»å°è±¡ã€‚</div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ==========================
    // âœ… Dropbox Tokenï¼šç¬¬ä¸€æ¬¡è¼¸å…¥å­˜ localStorageï¼ˆæ–°å¢ï¼‰
    // ==========================
    const DBX_TOKEN_KEY = "tasunDbxToken_v1";
    const DBX_FOLDER = "/Tasun/æ¬Šé™";

    const tokenOverlay = document.getElementById("tokenOverlay");
    const tokenInput   = document.getElementById("tokenInput");
    const tokenSaveBtn = document.getElementById("tokenSaveBtn");
    const tokenSkipBtn = document.getElementById("tokenSkipBtn");
    const tokenEyeBtn  = document.getElementById("tokenEyeBtn");
    const tokenMsg     = document.getElementById("tokenMsg");

    function getDbxToken(){
      return String(localStorage.getItem(DBX_TOKEN_KEY) || "").trim();
    }
    function setDbxToken(t){
      localStorage.setItem(DBX_TOKEN_KEY, String(t || "").trim());
    }
    function dbxEnabled(){
      const t = getDbxToken();
      return !!(t && t.length > 20);
    }
    function dbxAuthHeader(){
      return "Bearer " + getDbxToken();
    }
    function showTokenOverlay(){
      if(!tokenOverlay) return;
      tokenOverlay.style.display = "flex";
      tokenOverlay.setAttribute("aria-hidden","false");
      if(tokenInput){
        tokenInput.value = getDbxToken();
        setTimeout(()=> tokenInput.focus(), 40);
      }
    }
    function hideTokenOverlay(){
      if(!tokenOverlay) return;
      tokenOverlay.style.display = "none";
      tokenOverlay.setAttribute("aria-hidden","true");
      if(tokenMsg) tokenMsg.textContent = "";
    }

    tokenEyeBtn?.addEventListener("click", ()=>{
      if(!tokenInput) return;
      tokenInput.type = (tokenInput.type === "password") ? "text" : "password";
    });
    tokenSkipBtn?.addEventListener("click", ()=> hideTokenOverlay());
    tokenSaveBtn?.addEventListener("click", async ()=>{
      const t = String(tokenInput?.value || "").trim();
      if(!t){
        if(tokenMsg) tokenMsg.textContent = "è«‹å…ˆè²¼ä¸Š Access Tokenã€‚";
        return;
      }
      setDbxToken(t);
      hideTokenOverlay();
      // å„²å­˜å¾Œç«‹å³æ‹‰é›²ç«¯ä¸€æ¬¡ï¼Œé¿å…åˆæ¬¡ç©ºç™½
      await doPullSilent();
      renderAll();
    });

    // ==========================
    // âœ… Dropbox é›²ç«¯åŒæ­¥è¨­å®šï¼ˆå­˜åˆ° /Tasun/æ¬Šé™/ï¼‰
    // ==========================
    const DBX_PATH_AUTH = `${DBX_FOLDER}/tasunAuthTable_v1.json`;
    const DBX_PATH_NAV  = `${DBX_FOLDER}/tasunNavButtons_v1.json`;
    const DBX_PATH_META = `${DBX_FOLDER}/tasunCloudMeta_v1.json`;

    async function dbxUploadJson(path, obj){
      if(!dbxEnabled()) return false;
      try{
        const bodyStr = JSON.stringify(obj);
        const res = await fetch("https://content.dropboxapi.com/2/files/upload", {
          method: "POST",
          cache: "no-store",
          headers: {
            "Authorization": dbxAuthHeader(),
            "Content-Type": "application/octet-stream",
            "Dropbox-API-Arg": JSON.stringify({
              path,
              mode: "overwrite",
              autorename: false,
              mute: true,
              strict_conflict: false
            })
          },
          body: new TextEncoder().encode(bodyStr)
        });
        return !!res.ok;
      }catch(e){
        return false;
      }
    }

    async function dbxDownloadJson(path){
      if(!dbxEnabled()) return null;
      try{
        const res = await fetch("https://content.dropboxapi.com/2/files/download", {
          method: "POST",
          cache: "no-store",
          headers: {
            "Authorization": dbxAuthHeader(),
            "Dropbox-API-Arg": JSON.stringify({ path })
          }
        });
        if(!res.ok) return null;
        const text = await res.text();
        try { return JSON.parse(text); } catch(e){ return null; }
      }catch(e){
        return null;
      }
    }

    function getLocalUpdatedAt(){
      const v = Number(localStorage.getItem("tasunCloudUpdatedAt_v1") || "0");
      return isFinite(v) ? v : 0;
    }
    function setLocalUpdatedAt(ts){
      localStorage.setItem("tasunCloudUpdatedAt_v1", String(ts || 0));
    }

    async function cloudPushFromLocalStorage(){
      const AUTH_KEY = "tasunAuthTable_v1";
      const NAV_KEY  = "tasunNavButtons_v1";

      let auth = [];
      let nav = [];
      try{ auth = JSON.parse(localStorage.getItem(AUTH_KEY) || "[]"); }catch(e){ auth = []; }
      try{ nav  = JSON.parse(localStorage.getItem(NAV_KEY)  || "[]"); }catch(e){ nav  = []; }

      const updatedAt = Date.now();

      await dbxUploadJson(DBX_PATH_AUTH, auth || []);
      await dbxUploadJson(DBX_PATH_NAV,  nav  || []);
      await dbxUploadJson(DBX_PATH_META, { updatedAt });

      setLocalUpdatedAt(updatedAt);
      return true;
    }

    async function cloudPullToLocalStorage({ force=false } = {}){
      const AUTH_KEY = "tasunAuthTable_v1";
      const NAV_KEY  = "tasunNavButtons_v1";

      const meta = await dbxDownloadJson(DBX_PATH_META);
      const cloudTs = Number(meta && meta.updatedAt ? meta.updatedAt : 0);
      const localTs = getLocalUpdatedAt();

      if(!force && cloudTs && localTs && cloudTs <= localTs) return false;

      const auth = await dbxDownloadJson(DBX_PATH_AUTH);
      const nav  = await dbxDownloadJson(DBX_PATH_NAV);

      let changed = false;
      if(auth && Array.isArray(auth)){
        localStorage.setItem(AUTH_KEY, JSON.stringify(auth));
        changed = true;
      }
      if(nav && Array.isArray(nav)){
        localStorage.setItem(NAV_KEY, JSON.stringify(nav));
        changed = true;
      }
      if(cloudTs){
        setLocalUpdatedAt(cloudTs);
      }
      return changed;
    }

    // âœ… æä¾›ä¸€å€‹ä¸è·³ alert çš„æ‹‰é›²ç«¯ï¼ˆçµ¦ token å„²å­˜å¾Œç«‹å³ä½¿ç”¨ï¼‰
    async function doPullSilent(){
      await cloudPullToLocalStorage({ force:true });
      NAV_CONFIG = loadNavConfig();
      AUTH_TABLE = loadAuthTable(NAV_CONFIG.length);
      fixAuthButtonsLength();
    }

    // ==========================
    // localStorage Keyï¼ˆèˆ‡ index.html ç›¸åŒï¼‰
    // ==========================
    const AUTH_KEY    = "tasunAuthTable_v1";
    const CURRENT_KEY = "tasunCurrentUser_v1";
    const NAV_KEY     = "tasunNavButtons_v1";

    const DEFAULT_NAV = [
      { id: "btn1", label: "è‡»é¼æ™‚ä»£å¤§å»ˆç®¡ç†è¡¨", href: "è‡»é¼ç®¡ç†è¡¨.html", target: "", roles: ["admin","write","read"] },
      { id: "btn2", label: "ç¼ºå¤± / å“è³ª",       href: "ç”„é¼quality.html", target: "", roles: ["admin","write","read"] },
      { id: "btn3", label: "é›²ç«¯æª”æ¡ˆ",          href: "https://www.dropbox.com/", target: "_blank", roles: ["admin","write","read"] },
      { id: "btn4", label: "å·¥ç¨‹è³‡æ–™åº«",        href: "å·¥ç¨‹è³‡æ–™åº«.html", target: "", roles: ["admin","write"] },
      { id: "btn5", label: "è³‡æ–™åº«",            href: "#", target: "", roles: ["admin","write","read"] }
    ];

;

    const LEGACY_BUTTON_KEYS = ["btn1", "btn2", "btn3", "btn4", "btn5"];

    const navTbody  = document.getElementById("navTbody");
    const authThead = document.getElementById("authThead");
    const authTbody = document.getElementById("authTbody");

    const who = document.getElementById("who");
    const lockOverlay = document.getElementById("lockOverlay");

    const btnSave = document.getElementById("btnSave");
    const btnPull = document.getElementById("btnPull");
    const btnAddNav = document.getElementById("btnAddNav");
    const btnAddUser = document.getElementById("btnAddUser");

    let NAV_CONFIG = [];
    let AUTH_TABLE = [];

    function getCurrentUser(){
      try { return JSON.parse(localStorage.getItem(CURRENT_KEY) || "null"); } catch(e){ return null; }
    }

    function isAdmin(){
      const u = getCurrentUser();
      return !!(u && u.level === "admin");
    }

    function normalizeNavEntry(entry, index) {
      const base = DEFAULT_NAV[index] || {};
      const label = (entry && entry.label ? String(entry.label).trim() : "") || base.label || `æŒ‰éˆ•${index + 1}`;
      const href  = (entry && entry.href  ? String(entry.href).trim()  : "") || base.href  || "#";
      const target= (entry && entry.target? String(entry.target).trim(): "") || base.target|| "";
      const roles = Array.isArray(entry && entry.roles)
        ? entry.roles.slice()
        : (Array.isArray(base.roles) ? base.roles.slice() : ["admin","write","read"]);
      return { id: `btn${index + 1}`, label, href, target, roles };
    }

    function loadNavConfig() {
      const raw = localStorage.getItem(NAV_KEY);
      if (!raw) {
        const defaults = DEFAULT_NAV.slice();
        localStorage.setItem(NAV_KEY, JSON.stringify(defaults));
        return defaults;
      }
      try {
        const arr = JSON.parse(raw);
        if (Array.isArray(arr) && arr.length) return arr.map((item, idx) => normalizeNavEntry(item, idx));
      } catch (e) {}
      const defaults = DEFAULT_NAV.slice();
      localStorage.setItem(NAV_KEY, JSON.stringify(defaults));
      return defaults;
    }

    function makeButtonsAll(count) { return Array(count).fill(true); }
    function makeButtonsOnlyLast(count) {
      const arr = Array(count).fill(false);
      if (count > 0) arr[count - 1] = true;
      return arr;
    }

    function getDefaultAuthTable(btnCount) {
      return [
        { username: "alex",  password: "Tasun08040224", level: "admin", buttons: makeButtonsAll(btnCount) },
        { username: "tasun", password: "tasun08040224", level: "write", buttons: makeButtonsAll(btnCount) },
        { username: "wu",    password: "123456",        level: "read",  buttons: makeButtonsOnlyLast(btnCount) }
      ];
    }

    function normalizeRowFromStorage(row, btnCount) {
      const username = row.username || "";
      const password = row.password || "";
      const level    = row.level || "read";

      let buttons = [];
      if (Array.isArray(row.buttons)) {
        buttons = row.buttons.slice();
      } else {
        const legacy = [];
        LEGACY_BUTTON_KEYS.forEach(k => {
          if (Object.prototype.hasOwnProperty.call(row, k)) legacy.push(!!row[k]);
        });
        buttons = legacy;
      }

      const resultButtons = [];
      for (let i = 0; i < btnCount; i++) resultButtons[i] = !!buttons[i];
      return { username, password, level, buttons: resultButtons };
    }

    function loadAuthTable(btnCount) {
      const raw = localStorage.getItem(AUTH_KEY);
      if (!raw) {
        const defaults = getDefaultAuthTable(btnCount);
        localStorage.setItem(AUTH_KEY, JSON.stringify(defaults));
        return defaults;
      }
      try {
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) return arr.map(r => normalizeRowFromStorage(r, btnCount));
      } catch (e) {}
      const defaults = getDefaultAuthTable(btnCount);
      localStorage.setItem(AUTH_KEY, JSON.stringify(defaults));
      return defaults;
    }

    function saveNavToStorage(){
      localStorage.setItem(NAV_KEY, JSON.stringify(NAV_CONFIG));
    }

    function saveAuthToStorage(){
      localStorage.setItem(AUTH_KEY, JSON.stringify(AUTH_TABLE));
    }

    function fixAuthButtonsLength(){
      const n = NAV_CONFIG.length;
      AUTH_TABLE = (AUTH_TABLE || []).map(row => {
        const btns = Array.isArray(row.buttons) ? row.buttons.slice() : [];
        const out = [];
        for(let i=0;i<n;i++) out[i] = !!btns[i];
        return { ...row, buttons: out };
      });
    }

    function renderNavTable(){
      navTbody.innerHTML = "";

      NAV_CONFIG.forEach((cfg, idx) => {
        const tr = document.createElement("tr");

        const tdIdx = document.createElement("td");
        tdIdx.textContent = String(idx + 1);
        tr.appendChild(tdIdx);

        const tdLabel = document.createElement("td");
        const inLabel = document.createElement("input");
        inLabel.className = "cell-input";
        inLabel.value = cfg.label || "";
        inLabel.addEventListener("input", () => { cfg.label = inLabel.value; });
        tdLabel.appendChild(inLabel);
        tr.appendChild(tdLabel);

        const tdHref = document.createElement("td");
        const inHref = document.createElement("input");
        inHref.className = "cell-input";
        inHref.value = cfg.href || "";
        inHref.addEventListener("input", () => { cfg.href = inHref.value; });
        tdHref.appendChild(inHref);
        tr.appendChild(tdHref);

        const tdTarget = document.createElement("td");
        const sel = document.createElement("select");
        sel.className = "cell-input small";
        const opt1 = document.createElement("option"); opt1.value=""; opt1.textContent="åŒè¦–çª—";
        const opt2 = document.createElement("option"); opt2.value="_blank"; opt2.textContent="æ–°è¦–çª—";
        sel.appendChild(opt1); sel.appendChild(opt2);
        sel.value = cfg.target || "";
        sel.addEventListener("change", ()=> cfg.target = sel.value);
        tdTarget.appendChild(sel);
        tr.appendChild(tdTarget);

        const tdDel = document.createElement("td");
        const btnDel = document.createElement("button");
        btnDel.className = "btn danger";
        btnDel.textContent = "åˆªé™¤";
        btnDel.addEventListener("click", () => {
          NAV_CONFIG.splice(idx, 1);
          NAV_CONFIG = NAV_CONFIG.map((x, i) => ({ ...x, id: `btn${i+1}` }));
          fixAuthButtonsLength();
          renderAll();
        });
        tdDel.appendChild(btnDel);
        tr.appendChild(tdDel);

        navTbody.appendChild(tr);
      });
    }

    function renderAuthTable(){
      authThead.innerHTML = "";
      const trh = document.createElement("tr");

      const thUser = document.createElement("th"); thUser.textContent="ç”¨æˆ¶å"; trh.appendChild(thUser);
      const thPwd  = document.createElement("th"); thPwd.textContent="å¯†ç¢¼"; trh.appendChild(thPwd);
      const thLvl  = document.createElement("th"); thLvl.textContent="æ¬Šé™ç´šåˆ¥"; trh.appendChild(thLvl);

      NAV_CONFIG.forEach(cfg => {
        const th = document.createElement("th");
        th.textContent = cfg.label || cfg.id;
        trh.appendChild(th);
      });

      const thDel = document.createElement("th"); thDel.textContent="åˆªé™¤"; trh.appendChild(thDel);
      authThead.appendChild(trh);

      authTbody.innerHTML = "";

      AUTH_TABLE.forEach((row, ridx) => {
        const tr = document.createElement("tr");

        const tdU = document.createElement("td");
        const inU = document.createElement("input");
        inU.className = "cell-input";
        inU.value = row.username || "";
        inU.addEventListener("input", ()=> row.username = inU.value);
        tdU.appendChild(inU);
        tr.appendChild(tdU);

        const tdP = document.createElement("td");
        const wrap = document.createElement("div");
        wrap.className = "pwd-wrap";
        const inP = document.createElement("input");
        inP.className = "cell-input";
        inP.type = "password";
        inP.value = row.password || "";
        inP.addEventListener("input", ()=> row.password = inP.value);
        const eye = document.createElement("button");
        eye.type = "button";
        eye.className = "eye";
        eye.textContent = "ğŸ‘";
        eye.addEventListener("click", ()=> { inP.type = (inP.type === "password") ? "text" : "password"; });
        wrap.appendChild(inP);
        wrap.appendChild(eye);
        tdP.appendChild(wrap);
        tr.appendChild(tdP);

        const tdL = document.createElement("td");
        const sel = document.createElement("select");
        sel.className = "cell-input small";
        ["admin","write","read"].forEach(v=>{
          const o=document.createElement("option");
          o.value=v; o.textContent=v;
          sel.appendChild(o);
        });
        sel.value = row.level || "read";
        sel.addEventListener("change", ()=> row.level = sel.value);
        tdL.appendChild(sel);
        tr.appendChild(tdL);

        NAV_CONFIG.forEach((cfg, bidx) => {
          const td = document.createElement("td");
          const chk = document.createElement("input");
          chk.type = "checkbox";
          chk.className = "chk";
          chk.checked = !!(row.buttons && row.buttons[bidx]);
          chk.addEventListener("change", ()=> {
            if(!Array.isArray(row.buttons)) row.buttons = [];
            row.buttons[bidx] = chk.checked;
          });
          td.appendChild(chk);
          tr.appendChild(td);
        });

        const tdD = document.createElement("td");
        const del = document.createElement("button");
        del.className = "btn danger";
        del.textContent = "åˆªé™¤";
        del.addEventListener("click", ()=>{
          AUTH_TABLE.splice(ridx, 1);
          renderAuthTable();
        });
        tdD.appendChild(del);
        tr.appendChild(tdD);

        authTbody.appendChild(tr);
      });
    }

    function renderAll(){
      renderNavTable();
      renderAuthTable();
    }

    function validateBeforeSave(){
      const names = new Set();
      for(const r of AUTH_TABLE){
        const u = (r.username || "").trim();
        if(!u) return "ç”¨æˆ¶åä¸å¯ç©ºç™½ã€‚";
        const key = u.toLowerCase();
        if(names.has(key)) return `ç”¨æˆ¶åé‡è¤‡ï¼š${u}`;
        names.add(key);
      }
      return "";
    }

    async function doSave(){
      const msg = validateBeforeSave();
      if(msg){
        alert(msg);
        return;
      }

      NAV_CONFIG = NAV_CONFIG.map((x, i) => ({ ...x, id: `btn${i+1}` }));
      fixAuthButtonsLength();

      saveNavToStorage();
      saveAuthToStorage();

      if(!dbxEnabled()){
        // æ²’ tokenï¼šä»å¯å­˜æœ¬æ©Ÿ
        alert("å·²å„²å­˜ï¼ˆæœ¬æ©Ÿï¼‰ã€‚\nè‹¥è¦æ¡Œæ©Ÿå­˜â†’æ‰‹æ©Ÿè‡ªå‹•åŒæ­¥ï¼Œè«‹å…ˆè¨­å®š Dropbox Tokenã€‚");
        showTokenOverlay();
        return;
      }

      await cloudPushFromLocalStorage();
      alert("å·²å„²å­˜ï¼ˆæœ¬æ©Ÿ + é›²ç«¯ï¼‰ã€‚æ‰‹æ©Ÿç™»å…¥å°‡è‡ªå‹•åŒæ­¥ã€‚");
    }

    async function doPull(){
      if(!dbxEnabled()){
        alert("å°šæœªè¨­å®š Dropbox Tokenï¼Œç„¡æ³•å¾é›²ç«¯åŒæ­¥ã€‚\nè«‹å…ˆè¨­å®š Tokenã€‚");
        showTokenOverlay();
        return;
      }
      const changed = await cloudPullToLocalStorage({ force:true });
      NAV_CONFIG = loadNavConfig();
      AUTH_TABLE = loadAuthTable(NAV_CONFIG.length);
      fixAuthButtonsLength();
      renderAll();
      alert(changed ? "å·²å¾é›²ç«¯åŒæ­¥æœ€æ–°è³‡æ–™ã€‚" : "é›²ç«¯ç„¡è¼ƒæ–°è³‡æ–™ã€‚");
    }

    btnAddNav.addEventListener("click", ()=>{
      NAV_CONFIG.push({
        id: `btn${NAV_CONFIG.length+1}`,
        label: `æŒ‰éˆ•${NAV_CONFIG.length+1}`,
        href: "#",
        target: "",
        roles: ["admin","write","read"]
      });
      fixAuthButtonsLength();
      renderAll();
    });

    btnAddUser.addEventListener("click", ()=>{
      const n = NAV_CONFIG.length;
      AUTH_TABLE.push({
        username: "",
        password: "",
        level: "read",
        buttons: Array(n).fill(false)
      });
      renderAuthTable();
    });

    btnSave.addEventListener("click", doSave);
    btnPull.addEventListener("click", doPull);

    async function init(){
      const cu = getCurrentUser();
      who.textContent = cu ? `ç›®å‰ä½¿ç”¨è€…ï¼š${cu.username} (${cu.level})` : "ç›®å‰ä½¿ç”¨è€…ï¼šæœªç™»å…¥";

      if(!isAdmin()){
        lockOverlay.style.display = "flex";
        return;
      }

      // âœ… admin ç¬¬ä¸€æ¬¡é€²ä¾†è‹¥æ²’ tokenï¼Œå…ˆæç¤ºï¼ˆä¸å¼·è¿«ï¼‰
      if(!dbxEnabled()){
        showTokenOverlay();
      }else{
        await cloudPullToLocalStorage({ force:false });
      }

      NAV_CONFIG = loadNavConfig();
      AUTH_TABLE = loadAuthTable(NAV_CONFIG.length);
      fixAuthButtonsLength();

      renderAll();
    }

    init();

    // ESC é—œé–‰ token è¦–çª—
    document.addEventListener("keydown",(e)=>{
      if(e.key==="Escape" && tokenOverlay && tokenOverlay.style.display==="flex"){
        hideTokenOverlay();
      }
    });
  </script>
</body>
</html>
