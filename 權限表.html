<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tasun æ¬Šé™è¡¨</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --gold:#f6d37a;
      --gold-soft: rgba(246,211,122,.78);
      --panel-border: rgba(246,211,122,.28);
      --bg:#050302;
      --shadow: 0 18px 34px rgba(0,0,0,.86), 0 0 26px rgba(246,211,122,.18);
      --r: 18px;
    }
    *{ box-sizing:border-box; margin:0; padding:0; }
    body{
      min-height:100vh;
      font-family:"Noto Serif TC","Microsoft JhengHei",serif;
      background:
        radial-gradient(circle at 10% 0%, rgba(252, 211, 77, 0.16) 0, transparent 45%),
        radial-gradient(circle at 90% 90%, rgba(251, 191, 36, 0.22) 0, transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,.72), rgba(0,0,0,.94));
      color: var(--gold);
    }
    .topbar{
      position: sticky;
      top:0;
      z-index:50;
      padding: 14px 14px 10px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
      background: rgba(0,0,0,.40);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(246,211,122,.18);
    }
    .pill{
      padding: .35rem .9rem;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.45);
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,.18), rgba(0,0,0,.86));
      color: rgba(246,211,122,.86);
      box-shadow: 0 10px 18px rgba(0,0,0,.72);
      letter-spacing:.08em;
      white-space:nowrap;
      font-size: .9rem;
    }
    .btn{
      border:1px solid rgba(246,211,122,.65);
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.02)),
        radial-gradient(circle at 0% 0%, rgba(246,211,122,.22), rgba(0,0,0,.88));
      color: var(--gold);
      padding:.38rem .95rem;
      border-radius: 999px;
      cursor:pointer;
      letter-spacing:.10em;
      box-shadow: 0 10px 18px rgba(0,0,0,.72);
      transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease;
      white-space:nowrap;
      font-size:.9rem;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(255,244,208,.9); }
    .btn.ghost{ opacity:.86; border-color: rgba(246,211,122,.45); }
    .wrap{
      width: min(1400px, 96vw);
      margin: 16px auto 28px;
      padding: 14px;
    }
    .card{
      border-radius: 22px;
      border: 1px solid rgba(246,211,122,.18);
      background:
        radial-gradient(circle at 50% 18%, rgba(246,211,122,.22), rgba(0,0,0,.86)),
        linear-gradient(180deg, rgba(0,0,0,.32), rgba(0,0,0,.78));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .header{
      padding: 16px 16px 10px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex-wrap: wrap;
    }
    .title{
      font-size: clamp(22px, 2.6vw, 34px);
      letter-spacing: .22em;
      text-indent: .22em;
      text-shadow: 0 0 14px rgba(246,211,122,.35);
      user-select:none;
    }
    .sub{
      color: rgba(246,211,122,.72);
      font-size: .95rem;
      letter-spacing:.08em;
    }

    table{
      width:100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    thead th{
      position: sticky;
      top: 70px;
      z-index: 10;
      background: rgba(0,0,0,.72);
      border-bottom: 1px solid rgba(246,211,122,.22);
      padding: 10px 8px;
      text-align:center;
      color: rgba(246,211,122,.92);
      letter-spacing:.08em;
      white-space: nowrap;
    }
    tbody td{
      border-bottom: 1px solid rgba(246,211,122,.10);
      padding: 8px 8px;
      text-align:center;
      color: rgba(246,211,122,.86);
    }
    tbody tr:hover td{
      background: rgba(246,211,122,.06);
    }

    input[type="text"], input[type="password"], select{
      width: 100%;
      padding: .45rem .6rem;
      border-radius: 999px;
      border:1px solid rgba(246,211,122,.45);
      background: rgba(0,0,0,.72);
      color: rgba(246,211,122,.95);
      outline:none;
    }
    input:focus, select:focus{
      border-color: rgba(255,244,208,.9);
      box-shadow: 0 0 12px rgba(246,211,122,.35);
    }
    .tiny{
      width:auto !important;
      display:inline-block;
      padding:.3rem .7rem;
      font-size:.85rem;
    }

    .foot{
      padding: 12px 16px 16px;
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content: space-between;
      border-top: 1px solid rgba(246,211,122,.14);
    }
    .msg{
      min-height: 1.2rem;
      color: rgba(255,200,200,.95);
      white-space: pre-line;
      font-size: .92rem;
    }
    .ok{ color: rgba(190,255,210,.92); }

    /* Token overlay (åŒ index ä¿®æ³•) */
    .overlay{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 2000;
      background: radial-gradient(circle at 50% 18%, rgba(255, 228, 170, 0.30), rgba(0,0,0,0.96));
    }
    .box{
      width:min(680px, 94vw);
      border-radius: 20px;
      border:1px solid rgba(246,211,122,.28);
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,.18), rgba(0,0,0,.95));
      box-shadow: 0 0 28px rgba(0,0,0,.92), 0 0 26px rgba(246,211,122,.18);
      padding: 16px 16px 14px;
    }
    .box h3{
      text-align:center;
      letter-spacing:.18em;
      text-indent:.18em;
      margin-bottom: 10px;
      text-shadow: 0 0 14px rgba(246,211,122,.45);
    }
    .row{ margin: 10px 0; }
    label{ display:block; margin-bottom:6px; color: rgba(246,211,122,.80); letter-spacing:.08em; }
    .rowline{ display:flex; gap:8px; flex-wrap: wrap; align-items:center; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; color: rgba(255,240,200,.96); }
    .hint{ color: rgba(246,211,122,.72); line-height:1.65; white-space: pre-line; font-size:.92rem; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="pill" id="pillUser">ç›®å‰ä½¿ç”¨è€…ï¼šæœªç™»å…¥</div>
    <button class="btn ghost" id="btnBack">è¿”å›é¦–é </button>
    <button class="btn ghost" id="btnSwitch">åˆ‡æ›å¸³è™Ÿ</button>
    <button class="btn ghost" id="btnToken">è¨­å®š Token</button>
    <button class="btn ghost" id="btnPull">é›²ç«¯ä¸‹è¼‰</button>
    <button class="btn" id="btnPush">å„²å­˜ä¸¦ä¸Šå‚³</button>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="header">
        <div>
          <div class="title">Tasun æ¬Šé™è¡¨</div>
          <div class="sub">åªæœ‰ <b>admin</b> å¯ä»¥ç·¨è¼¯ï¼›å…¶ä»–æ¬Šé™åªèƒ½æŸ¥çœ‹ã€‚</div>
        </div>
        <div class="sub" id="subInfo"></div>
      </div>

      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="min-width:140px;">ä½¿ç”¨è€…</th>
              <th style="min-width:160px;">å¯†ç¢¼</th>
              <th style="min-width:120px;">æ¬Šé™</th>
              <th>btn1</th><th>btn2</th><th>btn3</th><th>btn4</th><th>btn5</th>
              <th style="min-width:90px;">åˆªé™¤</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="foot">
        <div class="msg" id="msg"></div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn ghost" id="btnAdd">ï¼‹ æ–°å¢ä¸€åˆ—</button>
          <button class="btn ghost" id="btnSaveLocal">åªå„²å­˜æœ¬æ©Ÿ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Token overlay -->
  <div class="overlay" id="ov">
    <div class="box">
      <h3>Dropbox Token è¨­å®šï¼ˆApp folderï¼‰</h3>
      <div class="hint">
â‘  æœ¬ç³»çµ±å¯«å…¥ï¼š<b class="mono">/Tasun/æ¬Šé™</b>ï¼ˆåœ¨ App folder å…§ï¼‰
â‘¡ Apps ç«™å°ä½ç½®ï¼š/Apps/&lt;Appå&gt;/Tasun/æ¬Šé™
â‘¢ App key ç”¨æ–¼ç›´é” Permissions / Settingsï¼ˆinfo/&lt;AppKey&gt;#settingsï¼‰
      </div>

      <div class="row">
        <label>App åï¼ˆApps å…§è³‡æ–™å¤¾åï¼‰</label>
        <input id="appName" type="text" placeholder="ä¾‹å¦‚ï¼šwutasun">
      </div>

      <div class="row">
        <label>App keyï¼ˆinfo/&lt;é€™ä¸²&gt;#settingsï¼‰</label>
        <div class="rowline">
          <input id="appKey" type="text" placeholder="ä¾‹å¦‚ï¼ša5pm08kyb0bybdt">
          <button class="btn ghost tiny" id="openPerm">é–‹ Permissions</button>
          <button class="btn ghost tiny" id="openSet">é–‹ Settings</button>
        </div>
      </div>

      <div class="row">
        <label>Access Tokenï¼ˆsl. é–‹é ­ï¼‰</label>
        <div class="rowline">
          <input id="tok" type="password" placeholder="è²¼ä¸Š Access Tokenï¼ˆsl.ï¼‰">
          <button class="btn ghost tiny" id="eye">ğŸ‘</button>
        </div>
      </div>

      <div class="rowline" style="justify-content:flex-end; margin-top:8px;">
        <button class="btn ghost" id="closeOv">é—œé–‰</button>
        <button class="btn" id="saveTok">å„²å­˜</button>
      </div>
      <div class="msg" id="ovMsg" style="margin-top:10px;"></div>
    </div>
  </div>

  <script>
    // ==========================
    // keys
    // ==========================
    const AUTH_KEY = "tasunAuthTable_v1";
    const NAV_KEY  = "tasunNavButtons_v1";
    const CURRENT_KEY = "tasunCurrentUser_v1"; // âœ… session only

    const DBX_TOKEN_KEY   = "tasunDbxToken_v1";
    const DBX_FOLDER_KEY  = "tasunDbxFolder_v1";
    const DBX_APPNAME_KEY = "tasunDbxAppName_v1";
    const DBX_APPKEY_KEY  = "tasunDbxAppKey_v1";
    const DEFAULT_DBX_FOLDER = "/Tasun/æ¬Šé™";
    const DEFAULT_APP_NAME = "wutasun";

    // BroadcastChannel
    const AUTH_BRIDGE_CH = "tasunAuthBridge_v1";
    const TAB_ID_KEY = "tasunTabId_v1";
    const TAB_ID = (() => {
      let v = sessionStorage.getItem(TAB_ID_KEY);
      if(!v){
        v = "tab_" + Date.now() + "_" + Math.random().toString(16).slice(2);
        sessionStorage.setItem(TAB_ID_KEY, v);
      }
      return v;
    })();
    let bc=null, bcReady=false;

    // ==========================
    // UI
    // ==========================
    const pillUser = document.getElementById("pillUser");
    const msg = document.getElementById("msg");
    const subInfo = document.getElementById("subInfo");
    const tbody = document.getElementById("tbody");

    const btnBack = document.getElementById("btnBack");
    const btnSwitch = document.getElementById("btnSwitch");
    const btnToken = document.getElementById("btnToken");
    const btnPull = document.getElementById("btnPull");
    const btnPush = document.getElementById("btnPush");
    const btnAdd = document.getElementById("btnAdd");
    const btnSaveLocal = document.getElementById("btnSaveLocal");

    const ov = document.getElementById("ov");
    const appName = document.getElementById("appName");
    const appKey = document.getElementById("appKey");
    const tok = document.getElementById("tok");
    const eye = document.getElementById("eye");
    const openPerm = document.getElementById("openPerm");
    const openSet = document.getElementById("openSet");
    const closeOv = document.getElementById("closeOv");
    const saveTok = document.getElementById("saveTok");
    const ovMsg = document.getElementById("ovMsg");

    // ==========================
    // helpers
    // ==========================
    function safeJsonParse(s, fallback){ try{ return JSON.parse(s); }catch(e){ return fallback; } }
    function mapRole(v){
      const s = String(v ?? "").trim().toLowerCase();
      if(!s) return "";
      if(s==="admin") return "admin";
      if(s==="write" || s==="edit") return "write";
      if(s==="read"  || s==="view") return "read";
      if(s==="0") return "admin";
      if(s==="1") return "write";
      if(s==="2") return "read";
      return s;
    }
    function makeButtonsAll(count){ return Array(count).fill(true); }
    function makeButtonsOnlyLast(count){
      const arr = Array(count).fill(false);
      if(count>0) arr[count-1]=true;
      return arr;
    }

    function normalizeRow(row, btnCount){
      const username = String(row?.username||"").trim();
      const password = String(row?.password||"");
      const level = mapRole(row?.level ?? row?.role) || "read";
      const buttons = Array.isArray(row?.buttons) ? row.buttons.slice() : [];
      const outButtons = [];
      for(let i=0;i<btnCount;i++) outButtons[i] = !!buttons[i];
      return { username, password, level, role: level, buttons: outButtons };
    }

    // ==========================
    // current user (session only) + legacy migrate
    // ==========================
    function getCurrentUser(){
      let cu = safeJsonParse(sessionStorage.getItem(CURRENT_KEY) || "null", null);
      if(!cu || !cu.username){
        const legacy = safeJsonParse(localStorage.getItem(CURRENT_KEY) || "null", null);
        if(legacy && legacy.username){
          try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}
          sessionStorage.setItem(CURRENT_KEY, JSON.stringify(legacy));
          cu = legacy;
        }
      }
      if(!cu || typeof cu !== "object") return null;
      const username = String(cu.username||"").trim();
      if(!username) return null;
      const role = mapRole(cu.role ?? cu.level) || "read";
      const out = { username, role, level: role };
      sessionStorage.setItem(CURRENT_KEY, JSON.stringify(out));
      return out;
    }
    function setCurrentUser(u){
      if(!u){ sessionStorage.removeItem(CURRENT_KEY); return; }
      const obj = { username: String(u.username||"").trim(), level: mapRole(u.level ?? u.role) || "read" };
      obj.role = obj.level;
      sessionStorage.setItem(CURRENT_KEY, JSON.stringify(obj));
      bcPost({ type:"login", user: obj });
    }
    function clearCurrentUser(){
      sessionStorage.removeItem(CURRENT_KEY);
      try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}
      bcPost({ type:"logout" });
    }

    // ==========================
    // auth table
    // ==========================
    function getBtnCount(){
      // å›ºå®š 5 é¡†ï¼ˆbtn1~btn5ï¼‰
      return 5;
    }
    function defaultAuth(){
      const n = getBtnCount();
      return [
        { username:"alex",  password:"Tasun08040224", level:"admin", buttons: makeButtonsAll(n) },
        { username:"tasun", password:"tasun08040224", level:"write", buttons: makeButtonsAll(n) },
        { username:"wu",    password:"123456",        level:"read",  buttons: makeButtonsOnlyLast(n) },
      ].map(r=> normalizeRow(r,n));
    }
    function loadAuth(){
      const n = getBtnCount();
      const raw = localStorage.getItem(AUTH_KEY);
      if(!raw){
        const d = defaultAuth();
        localStorage.setItem(AUTH_KEY, JSON.stringify(d));
        return d;
      }
      const arr = safeJsonParse(raw, null);
      if(!Array.isArray(arr) || !arr.length){
        const d = defaultAuth();
        localStorage.setItem(AUTH_KEY, JSON.stringify(d));
        return d;
      }
      const fixed = arr.map(r=> normalizeRow(r,n)).filter(r=>r.username);
      localStorage.setItem(AUTH_KEY, JSON.stringify(fixed));
      return fixed;
    }
    function saveAuthLocal(rows){
      localStorage.setItem(AUTH_KEY, JSON.stringify(rows));
    }

    // ==========================
    // Dropbox token / app keys
    // ==========================
    function getDbxToken(){ return String(localStorage.getItem(DBX_TOKEN_KEY)||"").trim(); }
    function setDbxToken(t){ localStorage.setItem(DBX_TOKEN_KEY, String(t||"").trim()); }
    function dbxEnabled(){ const t=getDbxToken(); return !!(t && t.length>20); }
    function dbxAuthHeader(){ return "Bearer " + getDbxToken(); }

    function getDbxFolder(){ return String(localStorage.getItem(DBX_FOLDER_KEY)||DEFAULT_DBX_FOLDER).trim() || DEFAULT_DBX_FOLDER; }
    function getAppName(){ return String(localStorage.getItem(DBX_APPNAME_KEY)||DEFAULT_APP_NAME).trim() || DEFAULT_APP_NAME; }
    function setAppName(v){ localStorage.setItem(DBX_APPNAME_KEY, String(v||"").trim() || DEFAULT_APP_NAME); }

    function getAppKey(){ return String(localStorage.getItem(DBX_APPKEY_KEY)||"").trim(); }
    function setAppKey(v){ localStorage.setItem(DBX_APPKEY_KEY, String(v||"").trim()); }

    // âœ… FIXï¼šè¼¸å…¥æ¡†å„ªå…ˆ + input å³å­˜ï¼ˆä¿®æ­£ã€Œå·²å¡«ä»é¡¯ç¤ºæœªå¡«ã€ï¼‰
    function syncAppKeyFromInput(){
      const v = String(appKey.value||"").trim();
      if(v) setAppKey(v);
      return v || getAppKey();
    }
    function syncAppNameFromInput(){
      const v = String(appName.value||"").trim();
      if(v) setAppName(v);
      return v || getAppName();
    }
    appKey.addEventListener("input", syncAppKeyFromInput);
    appKey.addEventListener("blur", syncAppKeyFromInput);
    appName.addEventListener("input", syncAppNameFromInput);
    appName.addEventListener("blur", syncAppNameFromInput);

    function dbxPathAuth(){ return `${getDbxFolder()}/tasunAuthTable_v1.json`; }
    function dbxPathNav(){  return `${getDbxFolder()}/tasunNavButtons_v1.json`; }
    function dbxPathMeta(){ return `${getDbxFolder()}/tasunCloudMeta_v1.json`; }

    function jsonAscii(obj){
      return JSON.stringify(obj).replace(/[^\x00-\x7F]/g, (c)=>{
        const code = c.charCodeAt(0).toString(16).padStart(4,"0");
        return "\\u" + code;
      });
    }
    async function fetchWithTimeout(url, options={}, timeoutMs=15000){
      const ctrl = new AbortController();
      const id = setTimeout(()=>ctrl.abort(), timeoutMs);
      try{ return await fetch(url, { ...options, signal: ctrl.signal }); }
      finally{ clearTimeout(id); }
    }
    async function ensureFolder(){
      const res = await fetchWithTimeout("https://api.dropboxapi.com/2/files/create_folder_v2", {
        method:"POST", cache:"no-store",
        headers:{ "Authorization": dbxAuthHeader(), "Content-Type":"application/json" },
        body: JSON.stringify({ path: getDbxFolder(), autorename:false })
      });
      if(res.ok) return true;
      const t = await res.text();
      if(res.status===409 && (t||"").toLowerCase().includes("conflict")) return true;
      return false;
    }
    async function dbxDownloadJson(path){
      if(!dbxEnabled()) return null;
      const res = await fetchWithTimeout("https://content.dropboxapi.com/2/files/download", {
        method:"POST", cache:"no-store",
        headers:{
          "Authorization": dbxAuthHeader(),
          "Dropbox-API-Arg": jsonAscii({ path })
        }
      });
      if(!res.ok) return null;
      const txt = await res.text();
      return safeJsonParse(txt, null);
    }
    async function dbxUploadJson(path, obj){
      if(!dbxEnabled()) return false;
      const res = await fetchWithTimeout("https://content.dropboxapi.com/2/files/upload", {
        method:"POST", cache:"no-store",
        headers:{
          "Authorization": dbxAuthHeader(),
          "Content-Type":"application/octet-stream",
          "Dropbox-API-Arg": jsonAscii({ path, mode:"overwrite", autorename:false, mute:true })
        },
        body: JSON.stringify(obj, null, 2)
      });
      return res.ok;
    }

    function getConsoleBaseUrl(){
      const k = syncAppKeyFromInput();
      return k ? `https://www.dropbox.com/developers/apps/info/${encodeURIComponent(k)}` : "";
    }
    function getConsolePermUrl(){ const b=getConsoleBaseUrl(); return b ? (b+"#permissions") : ""; }
    function getConsoleSetUrl(){  const b=getConsoleBaseUrl(); return b ? (b+"#settings") : ""; }
    function openConsole(url, label){
      syncAppKeyFromInput();
      if(!url){
        alert(`å°šæœªå¡« App keyï¼Œç„¡æ³•ç›´æ¥é–‹ ${label}ã€‚\nè«‹è²¼ä¸Š info/<App key>#settings é‚£ä¸²ã€‚`);
        return;
      }
      const w = window.open(url, "_blank", "noopener");
      if(!w) alert("ç€è¦½å™¨å°é–å½ˆå‡ºè¦–çª—ï¼Œè«‹å…è¨±æ­¤ç¶²ç«™é–‹æ–°åˆ†é ã€‚");
    }

    // ==========================
    // Broadcast bridge
    // ==========================
    function bcPost(msg){
      if(!bcReady || !bc) return;
      try{ bc.postMessage({ ...msg, _from:TAB_ID, _ts:Date.now() }); }catch(e){}
    }
    function initBridge(){
      if(typeof BroadcastChannel==="undefined") return;
      try{
        bc = new BroadcastChannel(AUTH_BRIDGE_CH);
        bcReady = true;
        bc.onmessage = (ev)=>{
          const m = ev && ev.data ? ev.data : null;
          if(!m || m._from === TAB_ID) return;
          if(m.type==="who"){
            const cu = getCurrentUser();
            if(cu && cu.username) bcPost({ type:"login", user:cu, _replyTo:m._from });
          }
        };
      }catch(e){ bcReady=false; bc=null; }
    }

    // ==========================
    // render
    // ==========================
    let AUTH = [];
    let CURRENT = null;
    let IS_ADMIN = false;

    function render(){
      AUTH = loadAuth();
      CURRENT = getCurrentUser();

      const role = mapRole(CURRENT?.level ?? CURRENT?.role) || "";
      IS_ADMIN = (role === "admin");

      pillUser.textContent = CURRENT?.username
        ? `ç›®å‰ä½¿ç”¨è€…ï¼š${CURRENT.username} (${role})`
        : "ç›®å‰ä½¿ç”¨è€…ï¼šæœªç™»å…¥";

      subInfo.textContent = IS_ADMIN
        ? "ï¼ˆå¯ç·¨è¼¯ï¼‰"
        : "ï¼ˆåªè®€ï¼‰";

      btnAdd.disabled = !IS_ADMIN;
      btnSaveLocal.disabled = !IS_ADMIN;
      btnPush.disabled = !IS_ADMIN;

      tbody.innerHTML = "";

      const n = getBtnCount();
      AUTH.forEach((row, idx)=>{
        const tr = document.createElement("tr");

        // username
        const tdU = document.createElement("td");
        const inpU = document.createElement("input");
        inpU.type="text";
        inpU.value=row.username;
        inpU.disabled = !IS_ADMIN;
        tdU.appendChild(inpU);

        // password
        const tdP = document.createElement("td");
        const inpP = document.createElement("input");
        inpP.type="text";
        inpP.value=row.password;
        inpP.disabled = !IS_ADMIN;
        tdP.appendChild(inpP);

        // level
        const tdL = document.createElement("td");
        const sel = document.createElement("select");
        ["admin","write","read"].forEach(v=>{
          const o=document.createElement("option");
          o.value=v; o.textContent=v;
          if(mapRole(row.level)===v) o.selected=true;
          sel.appendChild(o);
        });
        sel.disabled = !IS_ADMIN;
        tdL.appendChild(sel);

        // btn1..btn5
        const btnTds=[];
        for(let i=0;i<n;i++){
          const td=document.createElement("td");
          const cb=document.createElement("input");
          cb.type="checkbox";
          cb.checked=!!row.buttons[i];
          cb.disabled = !IS_ADMIN;
          td.appendChild(cb);
          btnTds.push({td, cb});
        }

        // delete
        const tdD=document.createElement("td");
        const bDel=document.createElement("button");
        bDel.className="btn ghost tiny";
        bDel.textContent="åˆªé™¤";
        bDel.disabled = !IS_ADMIN;
        bDel.addEventListener("click", ()=>{
          if(!IS_ADMIN) return;
          if(!confirm(`ç¢ºå®šåˆªé™¤ä½¿ç”¨è€…ï¼š${row.username} ï¼Ÿ`)) return;
          AUTH.splice(idx,1);
          saveAuthLocal(AUTH);
          msg.textContent="âœ… å·²åˆªé™¤ï¼ˆæœ¬æ©Ÿï¼‰";
          msg.className="msg ok";
          render();
        });
        tdD.appendChild(bDel);

        // append
        tr.appendChild(tdU);
        tr.appendChild(tdP);
        tr.appendChild(tdL);
        btnTds.forEach(x=> tr.appendChild(x.td));
        tr.appendChild(tdD);
        tbody.appendChild(tr);

        // onchange binding
        function commit(){
          if(!IS_ADMIN) return;
          const u = String(inpU.value||"").trim();
          const p = String(inpP.value||"");
          const lv = mapRole(sel.value) || "read";
          const bs = [];
          for(let i=0;i<n;i++) bs[i]=!!btnTds[i].cb.checked;

          AUTH[idx] = normalizeRow({ username:u, password:p, level:lv, buttons:bs }, n);
          saveAuthLocal(AUTH);

          msg.textContent="âœ… å·²æ›´æ–°ï¼ˆæœ¬æ©Ÿï¼‰";
          msg.className="msg ok";
        }
        [inpU, inpP, sel, ...btnTds.map(x=>x.cb)].forEach(el=>{
          el.addEventListener("change", commit);
          el.addEventListener("input", ()=>{ if(el===inpU||el===inpP) commit(); });
        });
      });
    }

    function addRow(){
      if(!IS_ADMIN) return;
      const n = getBtnCount();
      AUTH.push(normalizeRow({ username:"", password:"", level:"read", buttons:Array(n).fill(false) }, n));
      saveAuthLocal(AUTH);
      msg.textContent="âœ… å·²æ–°å¢ä¸€åˆ—ï¼ˆè«‹å¡«å¸³è™Ÿï¼‰";
      msg.className="msg ok";
      render();
    }

    // ==========================
    // Token overlay events
    // ==========================
    function openToken(){
      ov.style.display="flex";
      appName.value = getAppName();
      appKey.value = getAppKey();
      tok.value = getDbxToken();
      ovMsg.textContent = "";
    }
    function closeToken(){
      ov.style.display="none";
      ovMsg.textContent = "";
    }

    eye.addEventListener("click", ()=>{
      tok.type = (tok.type==="password") ? "text" : "password";
    });
    openPerm.addEventListener("click", ()=> openConsole(getConsolePermUrl(), "Permissions"));
    openSet.addEventListener("click", ()=> openConsole(getConsoleSetUrl(), "Settings"));
    closeOv.addEventListener("click", closeToken);

    saveTok.addEventListener("click", async ()=>{
      syncAppNameFromInput();
      syncAppKeyFromInput();
      const t = String(tok.value||"").trim();
      if(!t){
        ovMsg.textContent="âŒ è«‹å…ˆè²¼ä¸Š Access Token";
        return;
      }
      setDbxToken(t);
      ovMsg.textContent="âœ… å·²å„²å­˜ Token";
      ovMsg.className="msg ok";
      setTimeout(closeToken, 450);
    });

    // ==========================
    // cloud sync
    // ==========================
    async function cloudPull(){
      if(!dbxEnabled()){
        msg.textContent="âŒ å°šæœªè¨­å®š Token";
        return;
      }
      msg.textContent="é›²ç«¯ä¸‹è¼‰ä¸­â€¦";
      msg.className="msg";

      const auth = await dbxDownloadJson(dbxPathAuth());
      const nav  = await dbxDownloadJson(dbxPathNav());

      if(auth && Array.isArray(auth)){
        localStorage.setItem(AUTH_KEY, JSON.stringify(auth));
      }
      if(nav && Array.isArray(nav)){
        localStorage.setItem(NAV_KEY, JSON.stringify(nav));
      }
      msg.textContent="âœ… å·²å¾é›²ç«¯ä¸‹è¼‰ä¸¦å¥—ç”¨";
      msg.className="msg ok";
      render();
    }

    async function cloudPush(){
      if(!IS_ADMIN){
        msg.textContent="âŒ åªæœ‰ admin å¯ä»¥ä¸Šå‚³";
        return;
      }
      if(!dbxEnabled()){
        msg.textContent="âŒ å°šæœªè¨­å®š Token";
        return;
      }
      msg.textContent="ä¸Šå‚³ä¸­â€¦";
      msg.className="msg";

      const okFolder = await ensureFolder();
      if(!okFolder){
        msg.textContent="âŒ ç„¡æ³•å»ºç«‹/ç¢ºèªè³‡æ–™å¤¾ï¼ˆå¯èƒ½ scopes ä¸è¶³ï¼šfiles.content.writeï¼‰";
        return;
      }

      const auth = loadAuth();
      const navRaw = safeJsonParse(localStorage.getItem(NAV_KEY)||"null", null);
      const nav = Array.isArray(navRaw) ? navRaw : [];

      const ok1 = await dbxUploadJson(dbxPathAuth(), auth);
      const ok2 = await dbxUploadJson(dbxPathNav(), nav);
      const meta = { updatedAt: Date.now() };
      const ok3 = await dbxUploadJson(dbxPathMeta(), meta);

      if(ok1 && ok2 && ok3){
        localStorage.setItem("tasunCloudUpdatedAt_v1", String(meta.updatedAt));
        msg.textContent="âœ… å·²å„²å­˜ä¸¦ä¸Šå‚³é›²ç«¯";
        msg.className="msg ok";

        // é€šçŸ¥å…¶ä»–åˆ†é æ›´æ–°
        bcPost({ type:"authUpdated" });
      }else{
        msg.textContent="âŒ ä¸Šå‚³å¤±æ•—ï¼ˆè«‹ç¢ºèª token scopes èˆ‡ç¶²è·¯ï¼‰";
      }
    }

    // ==========================
    // actions
    // ==========================
    btnBack.addEventListener("click", ()=> location.href="index.html");
    btnSwitch.addEventListener("click", ()=>{
      clearCurrentUser();
      location.href="index.html";
    });
    btnToken.addEventListener("click", openToken);
    btnPull.addEventListener("click", cloudPull);
    btnPush.addEventListener("click", cloudPush);
    btnAdd.addEventListener("click", addRow);
    btnSaveLocal.addEventListener("click", ()=>{
      if(!IS_ADMIN){
        msg.textContent="âŒ åªæœ‰ admin å¯ä»¥å„²å­˜ä¿®æ”¹";
        return;
      }
      saveAuthLocal(loadAuth());
      msg.textContent="âœ… å·²å„²å­˜æœ¬æ©Ÿ";
      msg.className="msg ok";
      // é€šçŸ¥å…¶ä»–åˆ†é ç”¨ storage event æ›´æ–°
    });

    // ==========================
    // boot
    // ==========================
    (function boot(){
      initBridge();

      // é€™é å¿…é ˆæœ‰ç™»å…¥è€…ï¼ˆsessionï¼‰ï¼Œå¦å‰‡å›é¦–é ç™»å…¥
      const cu = getCurrentUser();
      if(!cu || !cu.username){
        alert("å°šæœªç™»å…¥ï¼Œå°‡è¿”å›é¦–é ã€‚");
        location.href="index.html";
        return;
      }

      render();
    })();
  </script>
</body>
</html>
