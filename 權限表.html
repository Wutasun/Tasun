<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Tasun 權限表</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --gold:#f6d37a;
      --gold2:#e6c061;
      --bg:#050302;
      --stroke: rgba(246,211,122,.26);
      --panel: rgba(0,0,0,.38);
      --panel2: rgba(0,0,0,.22);
      --shadow: rgba(0,0,0,.60);
      --safe: clamp(14px, 2.2vw, 22px);
      --radius: 22px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:"Noto Serif TC", system-ui, -apple-system, "Microsoft JhengHei", sans-serif;
      color: var(--gold);
      background:
        radial-gradient(circle at 18% 10%, rgba(246,211,122,.14) 0, transparent 42%),
        radial-gradient(circle at 84% 88%, rgba(246,211,122,.12) 0, transparent 46%),
        linear-gradient(180deg, #070604 0%, #050302 55%, #040202 100%);
      overflow-x:hidden;
    }

    .frame{
      min-height:100vh;
      padding: var(--safe);
      display:flex;
      align-items:flex-start;
      justify-content:center;
    }

    .shell{
      width:min(1280px, 96vw);
      border-radius: 26px;
      background:
        radial-gradient(circle at 50% 0%, rgba(246,211,122,.14) 0, rgba(0,0,0,.10) 55%, rgba(0,0,0,.24) 100%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.18));
      box-shadow: 0 18px 60px rgba(0,0,0,.55), inset 0 0 0 1px rgba(246,211,122,.10);
      overflow:hidden;
      position:relative;
      padding-bottom: 16px;
    }

    /* 頂列：桌機 */
    .topbar{
      display:flex;
      gap: 10px;
      padding: 14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .leftGroup, .rightGroup{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(0,0,0,.40);
      border: 1px solid rgba(246,211,122,.22);
      box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.04);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      white-space:nowrap;
    }

    .btn{
      cursor:pointer;
      user-select:none;
      appearance:none;
      outline:none;
      font: inherit;
      color: var(--gold);
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.28);
      padding: 10px 14px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.18));
      box-shadow: 0 10px 28px rgba(0,0,0,.38), inset 0 0 0 1px rgba(255,255,255,.04);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      white-space:nowrap;
    }
    .btn:hover{ filter: brightness(1.05); }
    .btn:active{ transform: translateY(1px); }

    .header{
      padding: 10px 20px 8px;
      border-top: 1px solid rgba(246,211,122,.10);
      border-bottom: 1px solid rgba(246,211,122,.10);
      background: rgba(0,0,0,.18);
    }
    .header h1{
      margin: 0;
      font-size: clamp(36px, 4.3vw, 56px);
      letter-spacing: .20em;
      text-shadow: 0 8px 24px rgba(0,0,0,.62);
    }
    .header p{
      margin: 8px 0 0;
      opacity:.9;
      letter-spacing:.08em;
      line-height:1.7;
      font-size: 13px;
      color: rgba(246,211,122,.86);
    }

    .content{
      padding: 14px 14px 8px;
    }

    /* 桌機表格 */
    .tableWrap{
      width:100%;
      overflow:auto;
      border-radius: 18px;
      border: 1px solid rgba(246,211,122,.10);
      background: rgba(0,0,0,.16);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }

    table{
      width: 100%;
      border-collapse: collapse;
      min-width: 980px;
    }
    thead th{
      position:sticky;
      top:0;
      z-index:2;
      background: rgba(0,0,0,.42);
      border-bottom: 1px solid rgba(246,211,122,.12);
      padding: 12px 10px;
      font-size: 13px;
      letter-spacing:.12em;
      color: rgba(246,211,122,.92);
      text-align:center;
      white-space:nowrap;
    }
    tbody td{
      padding: 12px 10px;
      border-bottom: 1px solid rgba(246,211,122,.08);
      text-align:center;
      vertical-align:middle;
    }

    .field{
      width: 100%;
      max-width: 220px;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.20);
      background: rgba(0,0,0,.34);
      color: var(--gold);
      padding: 10px 12px;
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
      font-family: inherit;
    }
    select.field{ max-width: 120px; }

    .chk{
      width: 18px;
      height: 18px;
      accent-color: var(--gold);
      cursor:pointer;
    }
    .delBtn{
      padding: 9px 14px;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.20);
      background: rgba(0,0,0,.32);
      color: var(--gold);
      cursor:pointer;
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      padding: 12px 6px 0;
    }
    .actions .left{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .status{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      font-size: 13px;
      opacity:.92;
    }

    .msg{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(246,211,122,.12);
      background: rgba(0,0,0,.18);
      color: rgba(246,211,122,.88);
      white-space:pre-wrap;
      line-height:1.6;
      min-height: 44px;
    }

    /* 手機：返回/更多 下拉一致 UI */
    .topbarMobile{
      display:none;
      padding: 12px 14px;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(246,211,122,.10);
      background: rgba(0,0,0,.16);
    }
    .moreWrap{ position:relative; }
    .menu{
      position:absolute;
      right:0;
      top: calc(100% + 8px);
      min-width: 210px;
      border-radius: 16px;
      border: 1px solid rgba(246,211,122,.18);
      background: rgba(0,0,0,.66);
      box-shadow: 0 18px 50px rgba(0,0,0,.65);
      overflow:hidden;
      display:none;
      z-index: 10;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .menu.show{ display:block; }
    .menu button{
      width:100%;
      text-align:left;
      border:0;
      background:transparent;
      color: var(--gold);
      padding: 12px 14px;
      cursor:pointer;
      font: inherit;
      border-bottom: 1px solid rgba(246,211,122,.10);
    }
    .menu button:last-child{ border-bottom:0; }
    .menu button:hover{ background: rgba(255,255,255,.04); }

    /* 手機卡片式（每列折疊 + 權限橫向滑動） */
    .cards{
      display:none;
      margin-top: 10px;
      gap: 12px;
    }
    .card{
      border-radius: 18px;
      border: 1px solid rgba(246,211,122,.12);
      background: rgba(0,0,0,.18);
      box-shadow: 0 14px 40px rgba(0,0,0,.38), inset 0 0 0 1px rgba(255,255,255,.02);
      overflow:hidden;
    }
    .cardHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 14px;
      cursor:pointer;
    }
    .cardHead .who{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .cardHead .who strong{
      letter-spacing:.10em;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size: 12px;
      opacity:.92;
      border:1px solid rgba(246,211,122,.16);
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(0,0,0,.22);
      white-space:nowrap;
    }
    .chev{ opacity:.9; }
    .cardBody{
      display:none;
      padding: 0 14px 14px;
      border-top: 1px solid rgba(246,211,122,.10);
    }
    .card.open .cardBody{ display:block; }

    .grid2{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .rowLabel{
      font-size: 12px;
      opacity:.9;
      letter-spacing:.08em;
      margin-top: 8px;
    }

    .permScroll{
      overflow-x:auto;
      padding: 10px 0 2px;
    }
    .permRow{
      display:flex;
      gap:10px;
      min-width: max-content;
      align-items:center;
    }
    .permItem{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.14);
      background: rgba(0,0,0,.22);
      white-space:nowrap;
    }
    .permItem span{ font-size: 12px; opacity:.92; letter-spacing:.06em; }

    .cardActions{
      margin-top: 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    @media (max-width: 980px){
      .topbar{ display:none; }
      .topbarMobile{ display:flex; }
      .tableWrap{ display:none; }
      .cards{ display:flex; flex-direction:column; }
      table{ min-width: 900px; }
    }
  </style>
</head>

<body>
  <div class="frame">
    <div class="shell">

      <!-- Mobile topbar -->
      <div class="topbarMobile">
        <div class="pill" id="whoMobile">目前使用者：—</div>

        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn" id="backBtnM">返回</button>
          <div class="moreWrap">
            <button class="btn" id="moreBtn">更多</button>
            <div class="menu" id="moreMenu">
              <button id="switchBtnM">切換帳號</button>
              <button id="tokenBtnM">設定 Token</button>
              <button id="downloadBtnM">雲端下載</button>
              <button id="uploadBtnM">儲存並上傳</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Desktop topbar -->
      <div class="topbar">
        <div class="leftGroup">
          <div class="pill" id="whoDesk">目前使用者：—</div>
          <button class="btn" id="switchBtnD">切換帳號</button>
        </div>
        <div class="rightGroup">
          <button class="btn" id="backBtnD">返回首頁</button>
          <button class="btn" id="tokenBtnD">設定 Token</button>
          <button class="btn" id="downloadBtnD">雲端下載</button>
          <button class="btn" id="uploadBtnD">儲存並上傳</button>
        </div>
      </div>

      <div class="header">
        <h1>Tasun 權限表</h1>
        <p>
          只有 <b>admin</b> 可以編輯；其他權限只能查看。<br>
          提示：按鍵欄位標題會自動改為「首頁按鍵名稱」，並會隨首頁按鍵新增/改名自動同步。
        </p>
      </div>

      <div class="content">

        <!-- Desktop table -->
        <div class="tableWrap">
          <table>
            <thead>
              <tr id="theadRow">
                <th>使用者</th>
                <th>密碼</th>
                <th>權限</th>
                <!-- 按鈕欄位：動態插入 -->
                <th class="sysCol">系統/權限</th>
                <th>刪除</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <!-- Mobile cards -->
        <div class="cards" id="cards"></div>

        <div class="actions">
          <div class="left">
            <button class="btn" id="addBtn">＋ 新增一列</button>
            <button class="btn" id="saveLocalBtn">只儲存本機</button>
          </div>
          <div class="status">
            <div class="pill" id="tokenState">狀態：未設定 Token</div>
            <div class="pill" id="localState">本機：未儲存</div>
          </div>
        </div>

        <div class="msg" id="msg"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const AUTH_KEY     = 'tasunAuthTable_v1';
  const CURRENT_KEY  = 'tasunCurrentUser_v1';
  const TOKEN_KEY    = 'tasunDropboxToken_v1';     // 你原本若不是這個 key，可自行改成你的
  const BTN_META_KEY = 'tasunButtonMeta_v1';

  // Dropbox：你若用 App folder，也可把路徑改成 '/權限表.json'
  const DROPBOX_PATH = '/Tasun/權限表.json';

  const roleOptions = ['admin','write','read'];

  const el = (id) => document.getElementById(id);

  const whoDesk   = el('whoDesk');
  const whoMobile = el('whoMobile');

  const tbody     = el('tbody');
  const theadRow  = el('theadRow');
  const cards     = el('cards');

  const msg       = el('msg');
  const tokenState= el('tokenState');
  const localState= el('localState');

  const addBtn    = el('addBtn');
  const saveLocalBtn = el('saveLocalBtn');

  const backBtnD  = el('backBtnD');
  const backBtnM  = el('backBtnM');

  const switchBtnD= el('switchBtnD');
  const switchBtnM= el('switchBtnM');

  const tokenBtnD = el('tokenBtnD');
  const tokenBtnM = el('tokenBtnM');

  const downloadBtnD = el('downloadBtnD');
  const downloadBtnM = el('downloadBtnM');

  const uploadBtnD = el('uploadBtnD');
  const uploadBtnM = el('uploadBtnM');

  const moreBtn   = el('moreBtn');
  const moreMenu  = el('moreMenu');

  let auth = [];
  let btnMeta = [];
  let current = null;
  let isAdmin = false;
  let lastLocalSnapshot = '';

  function safeJsonParse(s, fallback){
    try{ return JSON.parse(s); }catch(e){ return fallback; }
  }

  function seedAuthIfMissing(){
    const a = safeJsonParse(localStorage.getItem(AUTH_KEY) || 'null', null);
    if(Array.isArray(a) && a.length) return;

    const seed = [
      { user:'alex',  pass:'Tasun08040224', role:'admin', btn1:true, btn2:true, btn3:true, btn4:true, btn5:true },
      { user:'tasun', pass:'tasun08040224', role:'write', btn1:true, btn2:true, btn3:false, btn4:true, btn5:false },
      { user:'wu',    pass:'123456',        role:'read',  btn1:true, btn2:false,btn3:false, btn4:false,btn5:false },
      { user:'JOYCE', pass:'09220224',      role:'admin', btn1:true, btn2:true, btn3:true, btn4:true, btn5:true },
    ];
    localStorage.setItem(AUTH_KEY, JSON.stringify(seed));
  }

  function load(){
    seedAuthIfMissing();
    auth = safeJsonParse(localStorage.getItem(AUTH_KEY) || '[]', []);
    if(!Array.isArray(auth)) auth = [];

    current = safeJsonParse(localStorage.getItem(CURRENT_KEY) || 'null', null);
    if(!current || typeof current !== 'object'){
      // 若沒 current，視為 read（但仍可看）
      current = { user:'—', role:'read' };
    }
    isAdmin = String(current.role||'read').toLowerCase() === 'admin';

    // 同步按鈕名稱（若首頁尚未寫入 BTN_META_KEY，也給預設）
    btnMeta = safeJsonParse(localStorage.getItem(BTN_META_KEY) || '[]', []);
    if(!Array.isArray(btnMeta) || !btnMeta.length){
      btnMeta = [
        { key:'btn1', name:'btn1' },
        { key:'btn2', name:'btn2' },
        { key:'btn3', name:'btn3' },
        { key:'btn4', name:'btn4' },
        { key:'btn5', name:'btn5' },
      ];
    }else{
      // 僅取 btn1~btn5
      btnMeta = btnMeta.filter(x => /^btn[1-5]$/.test(String(x.key||'')));
      // 若少了就補
      for(let i=1;i<=5;i++){
        const k = 'btn'+i;
        if(!btnMeta.find(b => b.key === k)) btnMeta.push({ key:k, name:k });
      }
    }

    renderAll();
    updateStates('已載入本機資料。');
    startLocalWatch(); // 手機/桌機都能同步更新
  }

  function bool(v){
    return v === true || v === 1 || v === '1' || v === 'true';
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function setMsg(text, isError=false){
    msg.style.color = isError ? 'rgba(255,170,170,.95)' : 'rgba(246,211,122,.88)';
    msg.textContent = text || '';
  }

  function updateWho(){
    const t = `目前使用者：${current.user} (${current.role})`;
    whoDesk.textContent = t;
    whoMobile.textContent = t;
  }

  function renderHeaders(){
    // 清掉舊的 btn 欄位（保留前3欄與最後2欄）
    // theadRow 結構：使用者/密碼/權限/(btns...)/系統/權限/刪除
    // 我們重建整列更乾淨
    theadRow.innerHTML = `
      <th>使用者</th>
      <th>密碼</th>
      <th>權限</th>
      ${btnMeta.map(b => `<th>${escapeHtml(b.name || b.key)}</th>`).join('')}
      <th class="sysCol">系統/權限</th>
      <th>刪除</th>
    `;
  }

  function renderTable(){
    tbody.innerHTML = auth.map((u, idx) => {
      const role = String(u.role||'read').toLowerCase();
      const sysCell = (role === 'admin') ? '✓' : '—';

      return `
      <tr data-idx="${idx}">
        <td><input class="field" data-k="user" value="${escapeHtml(u.user||'')}" ${isAdmin?'':'disabled'}></td>
        <td><input class="field" data-k="pass" value="${escapeHtml(u.pass||'')}" ${isAdmin?'':'disabled'}></td>
        <td>
          <select class="field" data-k="role" ${isAdmin?'':'disabled'}>
            ${roleOptions.map(r => `<option value="${r}" ${r===role?'selected':''}>${r}</option>`).join('')}
          </select>
        </td>

        ${btnMeta.map(b => {
          const k = b.key;
          const checked = bool(u[k]) ? 'checked' : '';
          return `<td><input class="chk" type="checkbox" data-k="${k}" ${checked} ${isAdmin?'':'disabled'}></td>`;
        }).join('')}

        <td>${sysCell}</td>
        <td><button class="delBtn" data-act="del" ${isAdmin?'':'disabled'}>刪除</button></td>
      </tr>`;
    }).join('');
  }

  function renderCards(){
    cards.innerHTML = auth.map((u, idx) => {
      const role = String(u.role||'read').toLowerCase();
      const sys = (role === 'admin') ? '✓' : '—';

      return `
      <div class="card" data-idx="${idx}">
        <div class="cardHead" data-act="toggle">
          <div class="who">
            <strong>${escapeHtml(u.user||'')}</strong>
            <span class="badge">role：${escapeHtml(role)}　｜　系統/權限：${sys}</span>
          </div>
          <div class="chev">▾</div>
        </div>

        <div class="cardBody">
          <div class="grid2">
            <div>
              <div class="rowLabel">使用者</div>
              <input class="field" data-k="user" value="${escapeHtml(u.user||'')}" ${isAdmin?'':'disabled'}>
            </div>
            <div>
              <div class="rowLabel">密碼</div>
              <input class="field" data-k="pass" value="${escapeHtml(u.pass||'')}" ${isAdmin?'':'disabled'}>
            </div>
            <div>
              <div class="rowLabel">權限</div>
              <select class="field" data-k="role" ${isAdmin?'':'disabled'}>
                ${roleOptions.map(r => `<option value="${r}" ${r===role?'selected':''}>${r}</option>`).join('')}
              </select>
            </div>

            <div class="rowLabel">按鍵權限（可左右滑動）</div>
            <div class="permScroll">
              <div class="permRow">
                ${btnMeta.map(b => {
                  const k = b.key;
                  const checked = bool(u[k]) ? 'checked' : '';
                  return `
                  <label class="permItem">
                    <input class="chk" type="checkbox" data-k="${k}" ${checked} ${isAdmin?'':'disabled'}>
                    <span>${escapeHtml(b.name || k)}</span>
                  </label>`;
                }).join('')}
              </div>
            </div>

            <div class="cardActions">
              <button class="btn" data-act="del" ${isAdmin?'':'disabled'}>刪除此使用者</button>
            </div>
          </div>
        </div>
      </div>`;
    }).join('');
  }

  function renderAll(){
    updateWho();
    renderHeaders();
    renderTable();
    renderCards();

    // admin 才可用：新增、儲存並上傳
    addBtn.disabled = !isAdmin;
    uploadBtnD.disabled = !isAdmin;
    uploadBtnM.disabled = !isAdmin;

    // 非 admin：提示
    if(!isAdmin){
      setMsg('（僅可查看）你目前不是 admin，無法編輯。', false);
    }
  }

  function saveLocal(){
    localStorage.setItem(AUTH_KEY, JSON.stringify(auth));
    localState.textContent = '本機：已儲存';
    lastLocalSnapshot = localStorage.getItem(AUTH_KEY) || '';
  }

  function updateStates(text){
    const token = (localStorage.getItem(TOKEN_KEY) || '').trim();
    tokenState.textContent = token ? '狀態：已設定 Token（可同步）' : '狀態：未設定 Token';
    if(text) setMsg(text, false);
  }

  function normalizeAuth(){
    // 確保每列都有 btn1~btn5（boolean）
    auth.forEach(u => {
      for(let i=1;i<=5;i++){
        const k = 'btn'+i;
        u[k] = bool(u[k]);
      }
      // role
      const r = String(u.role||'read').toLowerCase();
      u.role = roleOptions.includes(r) ? r : 'read';
      u.user = String(u.user||'').trim();
      u.pass = String(u.pass||'');
    });

    // 去掉空 user
    auth = auth.filter(u => (u.user||'').trim() !== '');
  }

  function addRow(){
    auth.push({ user:'', pass:'', role:'read', btn1:false, btn2:false, btn3:false, btn4:false, btn5:false });
    renderAll();
    setMsg('已新增一列（請填寫使用者/密碼）。');
  }

  function removeRow(idx){
    if(idx < 0 || idx >= auth.length) return;
    const u = auth[idx];
    if(String(u.user||'').toLowerCase() === 'alex'){
      setMsg('保護：不可刪除 alex。', true);
      return;
    }
    auth.splice(idx, 1);
    renderAll();
    saveLocal();
    setMsg('已刪除一列並儲存本機。');
  }

  // ✅ 修正「勾選後不能取消」：用 change 事件正確更新，不重設 checked
  function onTableInput(e){
    const tr = e.target.closest('tr');
    if(!tr) return;
    const idx = Number(tr.dataset.idx);
    if(Number.isNaN(idx) || !auth[idx]) return;

    const k = e.target.dataset.k;
    if(!k) return;

    if(e.target.type === 'checkbox'){
      auth[idx][k] = e.target.checked; // 可反勾
    }else if(e.target.tagName === 'SELECT'){
      auth[idx][k] = e.target.value;
    }else{
      auth[idx][k] = e.target.value;
    }

    normalizeAuth();
    saveLocal();
  }

  function onTableClick(e){
    const tr = e.target.closest('tr');
    if(!tr) return;
    const idx = Number(tr.dataset.idx);
    if(Number.isNaN(idx)) return;

    if(e.target.dataset.act === 'del'){
      removeRow(idx);
    }
  }

  function onCardClick(e){
    const card = e.target.closest('.card');
    if(!card) return;
    const idx = Number(card.dataset.idx);
    if(Number.isNaN(idx) || !auth[idx]) return;

    const act = e.target.dataset.act || (e.target.closest('[data-act]')?.dataset.act);

    if(act === 'toggle'){
      card.classList.toggle('open');
      const chev = card.querySelector('.chev');
      if(chev) chev.textContent = card.classList.contains('open') ? '▴' : '▾';
      return;
    }
    if(act === 'del'){
      removeRow(idx);
      return;
    }
  }

  function onCardInput(e){
    const card = e.target.closest('.card');
    if(!card) return;
    const idx = Number(card.dataset.idx);
    if(Number.isNaN(idx) || !auth[idx]) return;

    const k = e.target.dataset.k;
    if(!k) return;

    if(e.target.type === 'checkbox'){
      auth[idx][k] = e.target.checked; // 可反勾
    }else if(e.target.tagName === 'SELECT'){
      auth[idx][k] = e.target.value;
    }else{
      auth[idx][k] = e.target.value;
    }

    normalizeAuth();
    saveLocal();
  }

  // Mobile menu
  moreBtn.addEventListener('click', () => {
    moreMenu.classList.toggle('show');
  });
  document.addEventListener('click', (e) => {
    if(!e.target.closest('.moreWrap')) moreMenu.classList.remove('show');
  });

  // navigation
  function goHome(){
    location.href = 'index.html';
  }
  backBtnD.addEventListener('click', goHome);
  backBtnM.addEventListener('click', goHome);

  function switchAccount(){
    // 直接回首頁切換（因你首頁已有登入遮罩）
    localStorage.removeItem(CURRENT_KEY);
    location.href = 'index.html';
  }
  switchBtnD.addEventListener('click', switchAccount);
  switchBtnM.addEventListener('click', switchAccount);

  // token UI
  function setToken(){
    const old = (localStorage.getItem(TOKEN_KEY) || '').trim();
    const t = prompt('請貼上 Dropbox Access Token（僅儲存在本機瀏覽器）', old);
    if(t === null) return;
    localStorage.setItem(TOKEN_KEY, (t||'').trim());
    updateStates('已更新 Token。');
  }
  tokenBtnD.addEventListener('click', setToken);
  tokenBtnM.addEventListener('click', setToken);

  // download / upload
  downloadBtnD.addEventListener('click', cloudDownload);
  downloadBtnM.addEventListener('click', cloudDownload);
  uploadBtnD.addEventListener('click', saveAndUpload);
  uploadBtnM.addEventListener('click', saveAndUpload);

  saveLocalBtn.addEventListener('click', () => {
    normalizeAuth();
    saveLocal();
    updateStates('已儲存本機（localStorage）。');
  });

  addBtn.addEventListener('click', addRow);

  tbody.addEventListener('input', onTableInput);
  tbody.addEventListener('change', onTableInput);
  tbody.addEventListener('click', onTableClick);

  cards.addEventListener('click', onCardClick);
  cards.addEventListener('input', onCardInput);
  cards.addEventListener('change', onCardInput);

  // === Dropbox helpers ===

  // ✅ 修正你紅線錯誤：header 不能含非 Latin1 字元
  // 將 JSON 字串中的非 ASCII 轉成 \uXXXX，確保 header 安全
  function jsonToAsciiSafe(obj){
    const s = JSON.stringify(obj);
    return s.replace(/[^\x00-\x7F]/g, (ch) => {
      const code = ch.charCodeAt(0).toString(16).padStart(4,'0');
      return '\\u' + code;
    });
  }

  function getToken(){
    return (localStorage.getItem(TOKEN_KEY) || '').trim();
  }

  async function cloudDownload(){
    const token = getToken();
    if(!token){
      setMsg('尚未設定 Token，無法雲端下載。', true);
      updateStates();
      return;
    }
    try{
      setMsg('雲端下載中…');
      const arg = jsonToAsciiSafe({ path: DROPBOX_PATH });
      const res = await fetch('https://content.dropboxapi.com/2/files/download', {
        method:'POST',
        headers:{
          'Authorization':'Bearer ' + token,
          'Dropbox-API-Arg': arg
        }
      });

      if(!res.ok){
        const t = await res.text().catch(()=> '');
        // 若 token 過期
        if(res.status === 401 && /expired_access_token/i.test(t)){
          setMsg('Token 似乎已過期（expired_access_token）。請重新設定 Token。', true);
          return;
        }
        throw new Error(`下載失敗 HTTP ${res.status}\n${t}`);
      }

      const text = await res.text();
      const remote = safeJsonParse(text, null);
      if(!remote || !Array.isArray(remote)){
        throw new Error('雲端檔案不是有效的 JSON 陣列。');
      }

      auth = remote;
      normalizeAuth();
      saveLocal();
      renderAll();
      setMsg('雲端下載完成，已覆蓋本機並更新畫面。');
    }catch(err){
      setMsg('雲端下載失敗：' + (err?.message || err), true);
    }
  }

  async function saveAndUpload(){
    if(!isAdmin){
      setMsg('你不是 admin，禁止上傳。', true);
      return;
    }
    normalizeAuth();
    saveLocal();

    const token = getToken();
    if(!token){
      setMsg('已儲存本機，但未設定 Token，無法上傳。', true);
      updateStates();
      return;
    }

    try{
      setMsg('上傳中…');
      const body = JSON.stringify(auth, null, 2);

      const apiArg = jsonToAsciiSafe({
        path: DROPBOX_PATH,
        mode: 'overwrite',
        autorename: false,
        mute: true
      });

      const res = await fetch('https://content.dropboxapi.com/2/files/upload', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/octet-stream',
          'Dropbox-API-Arg': apiArg
        },
        body
      });

      const text = await res.text().catch(()=>'');

      if(!res.ok){
        if(res.status === 401 && /expired_access_token/i.test(text)){
          setMsg('上傳失敗：Token 已過期（expired_access_token）。請重新設定 Token。', true);
          return;
        }
        // scopes 不足也提示
        if(/files\.content\.write/i.test(text)){
          setMsg('上傳失敗：可能 scopes 不足（需要 files.content.write）。\n' + text, true);
          return;
        }
        throw new Error(`上傳失敗 HTTP ${res.status}\n${text}`);
      }

      updateStates('上傳成功。');
    }catch(err){
      setMsg('上傳失敗：' + (err?.message || err), true);
    }
  }

  // ✅ 無論有無 Token，都定時檢查本機變更（避免手機版不同步）
  function startLocalWatch(){
    lastLocalSnapshot = localStorage.getItem(AUTH_KEY) || '';
    setInterval(() => {
      const now = localStorage.getItem(AUTH_KEY) || '';
      if(now !== lastLocalSnapshot){
        lastLocalSnapshot = now;
        auth = safeJsonParse(now || '[]', []);
        if(!Array.isArray(auth)) auth = [];
        normalizeAuth();
        renderAll();
        updateStates('已偵測本機更新並同步畫面。');
      }
    }, 1200);
  }

  // 若跨頁更新（首頁/其他頁改動 localStorage）
  window.addEventListener('storage', (e) => {
    if(e.key === AUTH_KEY || e.key === BTN_META_KEY || e.key === CURRENT_KEY){
      load();
    }
  });

  // init
  load();

})();
</script>
</body>
</html>
