<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tasun æ¬Šé™è¡¨</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --gold:#f6d37a;
      --gold-soft: rgba(246, 211, 122, 0.75);
      --panel: rgba(0,0,0,0.62);
      --panel2: rgba(0,0,0,0.78);
      --border: rgba(246, 211, 122, 0.28);
      --border-strong: rgba(246, 211, 122, 0.55);
      --shadow: rgba(0,0,0,0.85);
      --radius: 22px;
      --btn-radius: 999px;
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    body{
      min-height:100vh;
      font-family:"Noto Serif TC","æ¨™æ¥·é«”","Microsoft JhengHei",serif;
      color:var(--gold);
      background:
        radial-gradient(circle at 20% 0%, rgba(246,211,122,0.16) 0, transparent 46%),
        radial-gradient(circle at 85% 90%, rgba(246,211,122,0.18) 0, transparent 52%),
        linear-gradient(180deg, #050302 0%, #070809 100%);
      overflow-x:hidden;
    }

    .wrap{
      max-width: 1440px;
      margin: 0 auto;
      padding: 1.0rem 1.0rem 2.2rem;
    }

    /* ===== Topbar ===== */
    .topbar{
      display:flex;
      align-items:center;
      gap:.6rem;
      flex-wrap:wrap;
      padding:.2rem .1rem;
      margin-bottom: .9rem;
    }

    .pill{
      padding: .32rem 1.05rem;
      border-radius: var(--btn-radius);
      border: 1px solid rgba(246, 211, 122, 0.55);
      background: radial-gradient(circle at 0% 0%, rgba(246, 211, 122, 0.18), rgba(0, 0, 0, 0.88));
      font-size: .82rem;
      letter-spacing:.10em;
      text-indent:.10em;
      opacity: .92;
      box-shadow: 0 3px 8px rgba(0,0,0,0.75), 0 0 10px rgba(246,211,122,0.12);
      white-space:nowrap;
    }

    .btn{
      padding: .32rem 1.05rem;
      border-radius: var(--btn-radius);
      border: 1px solid rgba(246, 211, 122, 0.62);
      background: radial-gradient(circle at 0% 0%, rgba(246, 211, 122, 0.20), rgba(0, 0, 0, 0.92));
      color: var(--gold);
      cursor: pointer;
      font-size: .82rem;
      letter-spacing:.12em;
      text-indent:.12em;
      opacity:.92;
      box-shadow: 0 6px 12px rgba(0,0,0,0.78);
      transition: transform .15s ease, box-shadow .2s ease, background .2s ease, opacity .2s ease;
      white-space:nowrap;
    }
    .btn:hover{
      transform: translateY(-1px);
      opacity: .98;
      background: radial-gradient(circle at 0% 0%, rgba(255,244,208,0.26), rgba(0,0,0,0.92));
      box-shadow: 0 10px 18px rgba(0,0,0,0.85);
    }
    .btn.ghost{
      border-color: rgba(246, 211, 122, 0.38);
      opacity: .86;
    }

    /* ===== Mobile "è¿”å›/æ›´å¤š" ===== */
    .mbar{
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:.6rem;
      width:100%;
    }
    .btn-back{
      flex: 0 0 auto;
      padding: .34rem 1.1rem;
    }
    .btn-more{
      flex: 0 0 auto;
      padding: .34rem 1.1rem;
      position:relative;
    }
    .more-menu{
      position:absolute;
      right:0;
      top: calc(100% + 10px);
      width: min(240px, 62vw);
      border-radius: 16px;
      border: 1px solid rgba(246,211,122,0.35);
      background: rgba(0,0,0,0.92);
      box-shadow: 0 18px 30px rgba(0,0,0,0.88), 0 0 18px rgba(246,211,122,0.16);
      overflow:hidden;
      display:none;
      z-index: 50;
    }
    .more-menu button{
      width:100%;
      text-align:left;
      padding: .7rem .9rem;
      background: transparent;
      border: none;
      color: var(--gold);
      cursor:pointer;
      letter-spacing:.10em;
    }
    .more-menu button:hover{
      background: rgba(246,211,122,0.10);
    }

    @media (max-width: 820px){
      .topbar{ gap:.5rem; }
      .topbar > .pill,
      .topbar > .btn:not(.btn-back):not(.btn-more){ display:none; }
      .mbar{ display:flex; }
    }

    /* ===== Panel ===== */
    .panel{
      border-radius: var(--radius);
      border: 1px solid rgba(246, 211, 122, 0.22);
      background:
        radial-gradient(circle at 18% 0%, rgba(246,211,122,0.10), rgba(0,0,0,0.75) 55%),
        linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.012));
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,0.05),
        0 0 28px rgba(0,0,0,0.62);
      overflow:hidden;
    }
    .panel-head{
      padding: 1.15rem 1.25rem .9rem;
      border-bottom: 1px solid rgba(246, 211, 122, 0.18);
      background: rgba(0,0,0,0.30);
    }
    .title{
      font-family:"DFKai-SB","æ¨™æ¥·é«”","Noto Serif TC",serif;
      font-size: clamp(2.0rem, 3.2vw, 2.7rem);
      letter-spacing:.42em;
      text-indent:.42em;
      text-shadow: 0 0 18px rgba(246,211,122,0.45), 0 10px 22px rgba(0,0,0,0.85);
      margin-bottom:.35rem;
    }
    .subtitle{
      color: rgba(246,211,122,0.70);
      font-size:.95rem;
      line-height:1.7;
      letter-spacing:.10em;
      text-indent:.10em;
      white-space: pre-line;
    }

    .panel-body{
      padding: 1.0rem 1.0rem 1.1rem;
    }

    /* ===== Table ===== */
    .table-wrap{
      width:100%;
      overflow:auto;
      border-radius: 18px;
      border: 1px solid rgba(246,211,122,0.18);
      background: rgba(0,0,0,0.38);
    }

    table{
      width: max(960px, 100%);
      border-collapse: separate;
      border-spacing: 0;
      font-size: .92rem;
    }
    thead th{
      position: sticky;
      top: 0;
      z-index: 2;
      background: rgba(0,0,0,0.82);
      border-bottom: 1px solid rgba(246,211,122,0.20);
      padding: .65rem .6rem;
      color: rgba(246,211,122,0.92);
      letter-spacing:.10em;
      text-indent:.10em;
      white-space:nowrap;
    }

    tbody td{
      padding: .62rem .6rem;
      border-bottom: 1px solid rgba(246,211,122,0.12);
      color: rgba(246,211,122,0.86);
      vertical-align: middle;
      white-space:nowrap;
    }
    tbody tr:hover td{
      background: rgba(246,211,122,0.06);
    }

    .field{
      width: 100%;
      min-width: 160px;
      padding: .45rem .75rem;
      border-radius: var(--btn-radius);
      border: 1px solid rgba(246,211,122,0.35);
      background: rgba(0,0,0,0.72);
      color: var(--gold);
      outline:none;
    }
    .field:focus{
      border-color: rgba(255,238,190,0.85);
      box-shadow: 0 0 12px rgba(246,211,122,0.55);
    }

    .role{
      min-width: 110px;
    }

    .chk{
      width: 18px; height: 18px;
      accent-color: #f6d37a;
      cursor:pointer;
    }

    .muted{
      color: rgba(246,211,122,0.55);
    }

    .danger{
      color: rgba(255,180,180,0.92);
    }

    .btn-small{
      padding: .28rem .9rem;
      font-size: .82rem;
    }

    .footerbar{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: .8rem;
      flex-wrap: wrap;
      padding: 1.0rem 1.0rem 1.15rem;
      border-top: 1px solid rgba(246,211,122,0.18);
      background: rgba(0,0,0,0.30);
    }

    .status{
      padding: .34rem 1.05rem;
      border-radius: var(--btn-radius);
      border: 1px solid rgba(246,211,122,0.32);
      background: rgba(0,0,0,0.60);
      color: rgba(246,211,122,0.82);
      font-size: .82rem;
      letter-spacing:.10em;
      text-indent:.10em;
      white-space: pre-line;
    }

    /* ===== Token overlay (èˆ‡é¦–é ä¸€è‡´çš„æ ¸å¿ƒ) ===== */
    .token-overlay{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 1200;
      background: radial-gradient(circle at 50% 18%, rgba(255, 228, 170, 0.32), rgba(0, 0, 0, 0.98));
    }
    .token-box{
      width: min(640px, 94vw);
      padding: 1.6rem 1.6rem 1.2rem;
      border-radius: 18px;
      background: radial-gradient(circle at 0% 0%, rgba(246, 211, 122, 0.22), rgba(0, 0, 0, 0.95));
      border: 1px solid rgba(246, 211, 122, 0.35);
      box-shadow: 0 0 28px rgba(0,0,0,0.92), 0 0 26px rgba(246,211,122,0.18);
      color: rgba(246,211,122,0.78);
    }
    .token-title{
      text-align:center;
      font-size: 1.15rem;
      letter-spacing: 0.18em;
      text-indent: 0.18em;
      margin-bottom: 0.6rem;
      text-shadow: 0 0 14px rgba(246,211,122,0.55);
      color: rgba(246,211,122,0.92);
    }
    .token-hint{
      font-size: 0.9rem;
      line-height: 1.75;
      color: rgba(246,211,122,0.78);
      margin-bottom: 0.8rem;
      white-space: pre-line;
    }
    .token-row{ display:flex; align-items:center; gap: 0.5rem; margin-top: .5rem; flex-wrap: wrap; }
    .token-input{
      flex: 1 1 auto;
      width: 100%;
      padding: 0.55rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.5);
      background: rgba(0, 0, 0, 0.82);
      color: var(--gold);
      outline: none;
    }
    .token-input:focus{
      border-color: rgba(255, 238, 190, 0.9);
      box-shadow: 0 0 12px rgba(246, 211, 122, 0.65);
    }
    .token-eye{
      padding: 0.26rem 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.8);
      background: rgba(0,0,0,0.86);
      color: var(--gold);
      cursor: pointer;
      box-shadow: 0 0 8px rgba(0,0,0,0.65);
      white-space: nowrap;
    }
    .token-actions{
      margin-top: 0.95rem;
      display:flex;
      justify-content: flex-end;
      gap: 0.55rem;
      flex-wrap: wrap;
    }
    .token-btn{
      border: 1px solid rgba(246,211,122,0.72);
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,0.22), rgba(0,0,0,0.92));
      color: var(--gold);
      border-radius: 999px;
      padding: 0.42rem 1.05rem;
      cursor: pointer;
      letter-spacing: 0.12em;
      text-indent: 0.12em;
      box-shadow: 0 8px 16px rgba(0,0,0,0.75);
      transition: transform .15s ease, box-shadow .2s ease, background .2s ease;
      white-space: nowrap;
    }
    .token-btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(0,0,0,0.85);
      background: radial-gradient(circle at 0% 0%, rgba(255,244,208,0.28), rgba(0,0,0,0.92));
    }
    .token-btn.ghost{
      opacity: 0.85;
      border-color: rgba(246,211,122,0.45);
    }
    .token-msg{
      margin-top: 0.65rem;
      min-height: 1.2rem;
      font-size: 0.85rem;
      color: rgba(255, 200, 200, 0.95);
      text-align: left;
      white-space: pre-line;
    }
    .mini-pill{
      display:inline-block;
      padding: .2rem .6rem;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,0.35);
      background: rgba(0,0,0,0.55);
      color: rgba(246,211,122,0.85);
      font-size: .82rem;
      margin-left: .35rem;
      letter-spacing: .06em;
      text-indent: .06em;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      color: rgba(255, 240, 200, 0.96);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="pill" id="userPill">ç›®å‰ä½¿ç”¨è€…ï¼šæœªç™»å…¥</div>

      <!-- Desktop buttons -->
      <button class="btn ghost" id="btnSwitch">åˆ‡æ›å¸³è™Ÿ</button>
      <button class="btn ghost" id="btnHome">è¿”å›é¦–é </button>
      <button class="btn ghost" id="btnToken">è¨­å®š Token</button>
      <button class="btn ghost" id="btnDownload">é›²ç«¯ä¸‹è¼‰</button>
      <button class="btn" id="btnUpload">å„²å­˜ä¸¦ä¸Šå‚³</button>

      <!-- Mobile bar -->
      <div class="mbar">
        <button class="btn btn-back ghost" id="mBack">è¿”å›</button>

        <div style="position:relative;">
          <button class="btn btn-more ghost" id="mMore">æ›´å¤š â–¾</button>
          <div class="more-menu" id="mMenu" aria-hidden="true">
            <button type="button" id="mSwitch">åˆ‡æ›å¸³è™Ÿ</button>
            <button type="button" id="mToken">è¨­å®š Token</button>
            <button type="button" id="mDownload">é›²ç«¯ä¸‹è¼‰</button>
            <button type="button" id="mUpload">å„²å­˜ä¸¦ä¸Šå‚³</button>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-head">
        <div class="title">Tasun æ¬Šé™è¡¨</div>
        <div class="subtitle" id="subInfo">åªæœ‰ admin å¯ä»¥ç·¨è¼¯ï¼›å…¶ä»–æ¬Šé™åªèƒ½æŸ¥çœ‹ã€‚</div>
      </div>

      <div class="panel-body">
        <div class="table-wrap">
          <table id="authTable">
            <thead>
              <tr id="theadRow">
                <!-- JS å‹•æ…‹å»ºç«‹ -->
              </tr>
            </thead>
            <tbody id="tbody">
              <!-- JS å‹•æ…‹å»ºç«‹ -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="footerbar">
        <div style="display:flex; gap:.6rem; flex-wrap:wrap;">
          <button class="btn btn-small" id="btnAddRow">ï¼‹ æ–°å¢ä¸€åˆ—</button>
          <button class="btn btn-small ghost" id="btnSaveLocal">åªå„²å­˜æœ¬æ©Ÿ</button>
        </div>

        <div class="status" id="statusPill">ç‹€æ…‹ï¼šæœ¬æ©Ÿæ¨¡å¼ï¼ˆæœªè¨­å®š Tokenï¼‰</div>
      </div>
    </div>
  </div>

  <!-- Token overlay -->
  <div class="token-overlay" id="tokenOverlay" aria-hidden="true">
    <div class="token-box">
      <div class="token-title">Dropbox Token è¨­å®šï¼ˆApp folderï¼‰</div>
      <div class="token-hint">
â‘  ä½ çš„ Dropbox å¸³è™Ÿï¼š<b>tasun_8@hotmail.com</b>
â‘¡ ç”¢ç”Ÿ Tokenï¼šConsole â†’ Permissions å‹¾ scopes â†’ Submit â†’ Settings é‡æ–°ç”¢ç”Ÿ Access Token
â‘¢ æœ¬ç³»çµ±æœƒå¯«å…¥ï¼š<b class="mono">/Tasun/æ¬Šé™</b>ï¼ˆApp folder å…§ï¼‰ï¼Œç¶²ç«™çœ‹åˆ°ç‚ºï¼š/Apps/&lt;Appå&gt;/Tasun/æ¬Šé™
      </div>

      <div style="margin-top:.2rem;">
        <div style="font-size:.86rem; color:rgba(246,211,122,0.8); margin-bottom:.35rem;">
          Apps å…§ã€ŒApp è³‡æ–™å¤¾åã€<span class="mini-pill">ä¾‹å¦‚ï¼šwutasun</span>
        </div>
        <input class="token-input" id="appNameInput" type="text" placeholder="ä¾‹å¦‚ï¼šwutasun" />
      </div>

      <div style="margin-top:.65rem;">
        <div style="font-size:.86rem; color:rgba(246,211,122,0.8); margin-bottom:.35rem;">
          App keyï¼ˆç”¨ä¾†ç›´æ¥é–‹ Permissions / Settingsï¼‰<span class="mini-pill">ä¾‹å¦‚ï¼ša5pm08kyb0bybdt</span>
        </div>
        <div class="token-row">
          <input class="token-input" id="appKeyInput" type="text" placeholder="è²¼ä¸Š App keyï¼ˆinfo/&lt;é€™ä¸²&gt;#settingsï¼‰" />
          <button class="token-btn ghost" id="btnOpenPerm" type="button">é–‹ Permissions</button>
          <button class="token-btn ghost" id="btnOpenSet" type="button">é–‹ Settings</button>
        </div>
      </div>

      <div style="margin-top:.7rem; font-size:.86rem; color:rgba(246,211,122,0.8); margin-bottom:.35rem;">
        Access Tokenï¼ˆä»¥ sl. é–‹é ­ï¼‰
      </div>
      <div class="token-row">
        <input class="token-input" id="tokenInput" type="password" placeholder="è²¼ä¸Š Access Tokenï¼ˆsl. é–‹é ­ï¼‰" />
        <button class="token-eye" id="tokenEyeBtn" type="button">ğŸ‘</button>
      </div>

      <div class="token-msg" id="tokenMsg"></div>

      <div class="token-actions">
        <button class="token-btn ghost" id="tokenGuideBtn" type="button">ä¸€æ­¥ä¸€æ­¥å°è¦½ï¼ˆè‡ªå‹•é–‹é€£çµï¼‰</button>
        <button class="token-btn ghost" id="tokenCloseBtn" type="button">é—œé–‰</button>
        <button class="token-btn" id="tokenSaveBtn" type="button">å„²å­˜ä¸¦æ¸¬è©¦</button>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // keys (èˆ‡é¦–é ä¸€è‡´)
    // ==========================
    const AUTH_KEY    = "tasunAuthTable_v1";
    const NAV_KEY     = "tasunNavButtons_v1";
    const CURRENT_KEY = "tasunCurrentUser_v1";

    const DBX_TOKEN_KEY   = "tasunDbxToken_v1";
    const DBX_FOLDER_KEY  = "tasunDbxFolder_v1";
    const DBX_APPNAME_KEY = "tasunDbxAppName_v1";
    const DBX_APPKEY_KEY  = "tasunDbxAppKey_v1";

    const DEFAULT_DBX_FOLDER = "/Tasun/æ¬Šé™";
    const DEFAULT_APP_NAME   = "wutasun";
    const EXPECT_EMAIL = "tasun_8@hotmail.com";

    // Bridgeï¼ˆä¸æ”¹ session è¦å‰‡ï¼‰
    const AUTH_BRIDGE_CH = "tasunAuthBridge_v1";
    const AUTH_PING_KEY  = "tasunAuthPing_v1";
    const TAB_ID_KEY = "tasunTabId_v1";
    const TAB_ID = (() => {
      let v = sessionStorage.getItem(TAB_ID_KEY);
      if(!v){
        v = "tab_" + Date.now() + "_" + Math.random().toString(16).slice(2);
        sessionStorage.setItem(TAB_ID_KEY, v);
      }
      return v;
    })();
    let bc = null;
    let bcReady = false;

    // ==========================
    // UI refs
    // ==========================
    const userPill = document.getElementById("userPill");
    const subInfo  = document.getElementById("subInfo");
    const theadRow = document.getElementById("theadRow");
    const tbody    = document.getElementById("tbody");
    const statusPill = document.getElementById("statusPill");

    const btnSwitch = document.getElementById("btnSwitch");
    const btnHome   = document.getElementById("btnHome");
    const btnToken  = document.getElementById("btnToken");
    const btnDownload = document.getElementById("btnDownload");
    const btnUpload   = document.getElementById("btnUpload");
    const btnAddRow   = document.getElementById("btnAddRow");
    const btnSaveLocal= document.getElementById("btnSaveLocal");

    // Mobile menu
    const mBack = document.getElementById("mBack");
    const mMore = document.getElementById("mMore");
    const mMenu = document.getElementById("mMenu");
    const mSwitch = document.getElementById("mSwitch");
    const mToken  = document.getElementById("mToken");
    const mDownload = document.getElementById("mDownload");
    const mUpload   = document.getElementById("mUpload");

    // Token overlay
    const tokenOverlay = document.getElementById("tokenOverlay");
    const appNameInput = document.getElementById("appNameInput");
    const appKeyInput  = document.getElementById("appKeyInput");
    const tokenInput   = document.getElementById("tokenInput");
    const tokenEyeBtn  = document.getElementById("tokenEyeBtn");
    const tokenMsg     = document.getElementById("tokenMsg");
    const tokenGuideBtn= document.getElementById("tokenGuideBtn");
    const tokenCloseBtn= document.getElementById("tokenCloseBtn");
    const tokenSaveBtn = document.getElementById("tokenSaveBtn");
    const btnOpenPerm  = document.getElementById("btnOpenPerm");
    const btnOpenSet   = document.getElementById("btnOpenSet");

    // ==========================
    // helpers
    // ==========================
    function mapRole(v){
      const s = String(v ?? "").trim().toLowerCase();
      if(!s) return "";
      if(s==="admin") return "admin";
      if(s==="write" || s==="edit") return "write";
      if(s==="read"  || s==="view") return "read";
      if(s==="0") return "admin";
      if(s==="1") return "write";
      if(s==="2") return "read";
      return s;
    }
    function safeJsonParse(s, fallback){
      try{ return JSON.parse(s); }catch(e){ return fallback; }
    }
    function jsonAscii(obj){
      return JSON.stringify(obj).replace(/[^\x00-\x7F]/g, (c)=>{
        const code = c.charCodeAt(0).toString(16).padStart(4,"0");
        return "\\u" + code;
      });
    }
    async function fetchWithTimeout(url, options={}, timeoutMs=15000){
      const ctrl = new AbortController();
      const id = setTimeout(()=> ctrl.abort(), timeoutMs);
      try{
        return await fetch(url, { ...options, signal: ctrl.signal });
      } finally {
        clearTimeout(id);
      }
    }

    // ==========================
    // session user (ä¸æ”¹è¦å‰‡)
    // ==========================
    function getCurrentUser(){
      const cu = safeJsonParse(sessionStorage.getItem(CURRENT_KEY) || "null", null);
      if(!cu || typeof cu !== "object") return null;
      const username = String(cu.username ?? "").trim();
      if(!username) return null;
      const role = mapRole(cu.role ?? cu.level) || "read";
      const out = { username, role, level: role };
      sessionStorage.setItem(CURRENT_KEY, JSON.stringify(out));
      return out;
    }
    function writeSessionUserOnly(u){
      const username = String(u.username||"").trim();
      const role = mapRole(u.level ?? u.role) || "read";
      const obj = { username, role, level: role };
      sessionStorage.setItem(CURRENT_KEY, JSON.stringify(obj));
      return obj;
    }
    function pingPost(msg){
      try{
        const payload = JSON.stringify({ ...msg, _from: TAB_ID, _ts: Date.now() });
        localStorage.setItem(AUTH_PING_KEY, payload);
        setTimeout(()=>{ try{ localStorage.removeItem(AUTH_PING_KEY); }catch(e){} }, 80);
      }catch(e){}
    }
    function bcPost(msg){
      if(bcReady && bc){
        try{ bc.postMessage({ ...msg, _from: TAB_ID, _ts: Date.now() }); }catch(e){}
      }
      pingPost(msg);
    }

    function handleBridgeMessage(m){
      if(!m || m._from === TAB_ID) return;

      if(m.type === "who"){
        const cu = getCurrentUser();
        if(cu && cu.username){
          bcPost({ type:"login", user: cu, _replyTo: m._from });
        }
        return;
      }

      if(m.type === "login" && m.user && m.user.username){
        writeSessionUserOnly(m.user);
        syncNow({ force:true }).then(()=> applyCurrentUserUI());
        return;
      }

      if(m.type === "logout"){
        sessionStorage.removeItem(CURRENT_KEY);
        location.href = "index.html";
        return;
      }
    }

    function initAuthBridge(){
      if(typeof BroadcastChannel !== "undefined"){
        try{
          bc = new BroadcastChannel(AUTH_BRIDGE_CH);
          bcReady = true;
          bc.onmessage = (ev)=> handleBridgeMessage(ev && ev.data ? ev.data : null);
        }catch(e){
          bcReady = false;
          bc = null;
        }
      }
      window.addEventListener("storage", (e)=>{
        if(e && e.key === AUTH_PING_KEY && e.newValue){
          const m = safeJsonParse(e.newValue, null);
          if(m) handleBridgeMessage(m);
        }
      });
    }

    // ==========================
    // Dropbox token
    // ==========================
    function getDbxToken(){ return String(localStorage.getItem(DBX_TOKEN_KEY) || "").trim(); }
    function setDbxToken(t){ localStorage.setItem(DBX_TOKEN_KEY, String(t || "").trim()); }
    function dbxEnabled(){ const t = getDbxToken(); return !!(t && t.length > 20); }
    function dbxAuthHeader(){ return "Bearer " + getDbxToken(); }

    function getDbxFolder(){
      return String(localStorage.getItem(DBX_FOLDER_KEY) || DEFAULT_DBX_FOLDER).trim() || DEFAULT_DBX_FOLDER;
    }
    function getDbxAppName(){
      return String(localStorage.getItem(DBX_APPNAME_KEY) || DEFAULT_APP_NAME).trim() || DEFAULT_APP_NAME;
    }
    function setDbxAppName(n){
      const v = String(n||"").trim() || DEFAULT_APP_NAME;
      localStorage.setItem(DBX_APPNAME_KEY, v);
    }

    function getDbxAppKey(){ return String(localStorage.getItem(DBX_APPKEY_KEY) || "").trim(); }
    function setDbxAppKey(k){ localStorage.setItem(DBX_APPKEY_KEY, String(k||"").trim()); }

    function syncAppKeyFromInput(){
      const v = String(appKeyInput?.value || "").trim();
      if(v) setDbxAppKey(v);
      return v || getDbxAppKey();
    }

    function dbxPathAuth(){ return `${getDbxFolder()}/tasunAuthTable_v1.json`; }
    function dbxPathNav(){  return `${getDbxFolder()}/tasunNavButtons_v1.json`; }
    function dbxPathMeta(){ return `${getDbxFolder()}/tasunCloudMeta_v1.json`; }

    function dropboxWebFolderUrl(){
      const appName = encodeURIComponent(getDbxAppName());
      return `https://www.dropbox.com/home/Apps/${appName}${getDbxFolder()}`;
    }

    function getConsoleBaseUrl(){
      const k = syncAppKeyFromInput();
      return k ? `https://www.dropbox.com/developers/apps/info/${encodeURIComponent(k)}` : "";
    }
    function getConsolePermUrl(){ const b = getConsoleBaseUrl(); return b ? (b + "#permissions") : ""; }
    function getConsoleSetUrl(){  const b = getConsoleBaseUrl(); return b ? (b + "#settings") : ""; }

    function openConsoleTab(url, label){
      syncAppKeyFromInput();
      if(!url){
        alert(`å°šæœªå¡« App keyï¼Œç„¡æ³•ç›´æ¥é–‹ ${label}ã€‚\n\nè«‹åœ¨æœ¬è¦–çª—ã€ŒApp keyã€è²¼ä¸Šï¼šç¶²å€ info/<App key>#settings é‚£ä¸²ã€‚`);
        return false;
      }
      const w = window.open(url, "_blank", "noopener");
      if(!w){
        alert("ç€è¦½å™¨å°é–å½ˆå‡ºè¦–çª—ã€‚\nè«‹å…è¨±æ­¤ç¶²ç«™é–‹æ–°åˆ†é å¾Œå†è©¦ä¸€æ¬¡ã€‚");
        return false;
      }
      return true;
    }

    async function testTokenAndGetEmail(){
      if(!dbxEnabled()) return { ok:false, status:0, msg:"âŒ Token æœªè¨­å®š", email:"" };
      try{
        const res = await fetchWithTimeout("https://api.dropboxapi.com/2/users/get_current_account", {
          method:"POST",
          cache:"no-store",
          headers:{ "Authorization": dbxAuthHeader(), "Content-Type":"application/json" },
          body: "null" // âœ… å¿…é ˆæ˜¯ "null"
        }, 15000);

        const txt = await res.text();
        const json = safeJsonParse(txt, null);
        if(!res.ok){
          return { ok:false, status:res.status, msg:`âŒ Token ç„¡æ•ˆæˆ–éæœŸï¼ˆHTTP ${res.status}ï¼‰\n${txt}`, email:"" };
        }
        const email = String(json && json.email ? json.email : "");
        return { ok:true, status:200, msg:`âœ… Token OK\nå°æ‡‰å¸³è™Ÿï¼š${email || "(æœªå›å‚³ email)"}`, email };
      }catch(e){
        return { ok:false, status:0, msg:"âŒ Token æ¸¬è©¦å¤±æ•—ï¼ˆå¯èƒ½ç¶²è·¯/é€¾æ™‚ï¼‰", email:"" };
      }
    }

    async function ensureFolder(){
      try{
        const res = await fetchWithTimeout("https://api.dropboxapi.com/2/files/create_folder_v2", {
          method:"POST",
          cache:"no-store",
          headers:{ "Authorization": dbxAuthHeader(), "Content-Type":"application/json" },
          body: JSON.stringify({ path: getDbxFolder(), autorename:false })
        }, 15000);

        const txt = await res.text();
        if(res.ok) return { ok:true, msg:"âœ… è³‡æ–™å¤¾å·²å»ºç«‹/ç¢ºèª" };

        if(res.status === 409 && (txt || "").toLowerCase().includes("conflict")){
          return { ok:true, msg:"âœ… è³‡æ–™å¤¾å·²å­˜åœ¨" };
        }
        return { ok:false, msg:`âŒ ç„¡æ³•å»ºç«‹/ç¢ºèªè³‡æ–™å¤¾ï¼ˆHTTP ${res.status}ï¼‰\n${txt}` };
      }catch(e){
        return { ok:false, msg:"âŒ ç„¡æ³•å»ºç«‹/ç¢ºèªè³‡æ–™å¤¾ï¼ˆé€¾æ™‚/ç¶²è·¯ï¼‰" };
      }
    }

    async function dbxDownloadJson(path){
      if(!dbxEnabled()) return null;
      try{
        const res = await fetchWithTimeout("https://content.dropboxapi.com/2/files/download", {
          method:"POST",
          cache:"no-store",
          headers:{
            "Authorization": dbxAuthHeader(),
            "Dropbox-API-Arg": jsonAscii({ path }) // âœ… æ‰‹æ©Ÿ/iOS å¿…éœ€ ASCII
          }
        }, 15000);
        if(!res.ok) return null;
        const txt = await res.text();
        return safeJsonParse(txt, null);
      }catch(e){
        return null;
      }
    }

    async function dbxUploadJson(path, obj){
      if(!dbxEnabled()) return { ok:false, msg:"âŒ Token æœªè¨­å®š" };
      try{
        const res = await fetchWithTimeout("https://content.dropboxapi.com/2/files/upload", {
          method:"POST",
          cache:"no-store",
          headers:{
            "Authorization": dbxAuthHeader(),
            "Content-Type": "application/octet-stream",
            "Dropbox-API-Arg": jsonAscii({
              path,
              mode: "overwrite",
              autorename: false,
              mute: true,
              strict_conflict: false
            })
          },
          body: new TextEncoder().encode(JSON.stringify(obj, null, 2))
        }, 20000);

        const txt = await res.text();
        if(!res.ok){
          return { ok:false, msg:`âŒ ä¸Šå‚³å¤±æ•—ï¼ˆHTTP ${res.status}ï¼‰\n${txt}` };
        }
        return { ok:true, msg:"âœ… å·²ä¸Šå‚³" };
      }catch(e){
        return { ok:false, msg:"âŒ ä¸Šå‚³å¤±æ•—ï¼ˆé€¾æ™‚/ç¶²è·¯ï¼‰" };
      }
    }

    function getLocalUpdatedAt(){
      const v = Number(localStorage.getItem("tasunCloudUpdatedAt_v1") || "0");
      return isFinite(v) ? v : 0;
    }
    function setLocalUpdatedAt(ts){
      localStorage.setItem("tasunCloudUpdatedAt_v1", String(ts || 0));
    }

    async function cloudPullToLocalStorage({ force=false } = {}){
      if(!dbxEnabled()) return false;

      const meta = await dbxDownloadJson(dbxPathMeta());
      const cloudTs = Number(meta && meta.updatedAt ? meta.updatedAt : 0);
      const localTs = getLocalUpdatedAt();
      if(!force && cloudTs && localTs && cloudTs <= localTs) return false;

      const auth = await dbxDownloadJson(dbxPathAuth());
      const nav  = await dbxDownloadJson(dbxPathNav());

      let changed = false;
      if(auth && Array.isArray(auth) && auth.length){
        const fixed = auth.map(r=>{
          const level = mapRole(r?.level ?? r?.role) || "read";
          return { ...r, level, role: level };
        });
        localStorage.setItem(AUTH_KEY, JSON.stringify(fixed));
        changed = true;
      }
      if(nav && Array.isArray(nav) && nav.length){
        localStorage.setItem(NAV_KEY, JSON.stringify(nav));
        changed = true;
      }
      if(cloudTs) setLocalUpdatedAt(cloudTs);
      return changed;
    }

    // ==========================
    // Local data normalize
    // ==========================
    const DEFAULT_NAV = [
      { id:"btn1", label:"è‡»é¼æ™‚ä»£å¤§å»ˆç®¡ç†è¡¨", href:"è‡»é¼ç®¡ç†è¡¨.html", target:"", roles:["admin","write","read"] },
      { id:"btn2", label:"ç¼ºå¤± / å“è³ª", href:"ç”„é¼quality.html", target:"", roles:["admin","write","read"] },
      { id:"btn3", label:"é›²ç«¯æª”æ¡ˆ", href:"https://www.dropbox.com/", target:"_blank", roles:["admin","write","read"] },
      { id:"btn4", label:"å·¥ç¨‹è³‡æ–™åº«", href:"å·¥ç¨‹è³‡æ–™åº«.html", target:"", roles:["admin","write"] },
      { id:"btn5", label:"è³‡æ–™åº«", href:"#", target:"", roles:["admin","write","read"] }
    ];

    function normalizeNavEntry(entry, index){
      const base = DEFAULT_NAV[index] || {};
      const label = (entry && entry.label ? String(entry.label).trim() : "") || base.label || `æŒ‰éˆ•${index+1}`;
      const href  = (entry && entry.href ? String(entry.href).trim() : "") || base.href || "#";
      const target= (entry && entry.target ? String(entry.target).trim() : "") || base.target || "";
      const roles = Array.isArray(entry && entry.roles) ? entry.roles.slice()
        : (Array.isArray(base.roles) ? base.roles.slice() : ["admin","write","read"]);
      return { id:`btn${index+1}`, label, href, target, roles };
    }

    function loadNavConfig(){
      const raw = localStorage.getItem(NAV_KEY);
      if(!raw){
        localStorage.setItem(NAV_KEY, JSON.stringify(DEFAULT_NAV.slice()));
        return DEFAULT_NAV.slice();
      }
      const arr = safeJsonParse(raw, null);
      if(!Array.isArray(arr) || !arr.length){
        localStorage.setItem(NAV_KEY, JSON.stringify(DEFAULT_NAV.slice()));
        return DEFAULT_NAV.slice();
      }
      const fixed = arr.map((it, idx)=> normalizeNavEntry(it, idx));
      localStorage.setItem(NAV_KEY, JSON.stringify(fixed));
      return fixed;
    }

    function makeButtonsAll(count){ return Array(count).fill(true); }
    function makeButtonsOnlyLast(count){
      const a = Array(count).fill(false);
      if(count>0) a[count-1]=true;
      return a;
    }
    function getDefaultAuthTable(btnCount){
      return [
        { username:"alex",  password:"Tasun08040224", level:"admin", role:"admin", buttons: makeButtonsAll(btnCount) },
        { username:"tasun", password:"tasun08040224", level:"write", role:"write", buttons: makeButtonsAll(btnCount) },
        { username:"wu",    password:"123456", level:"read", role:"read", buttons: makeButtonsOnlyLast(btnCount) }
      ];
    }
    function normalizeRow(row, btnCount){
      const username = String(row.username||"").trim();
      const password = String(row.password||"");
      const level = mapRole(row.level ?? row.role) || "read";
      const btns = Array.isArray(row.buttons) ? row.buttons.slice() : [];
      const out = [];
      for(let i=0;i<btnCount;i++) out[i] = !!btns[i];
      return { username, password, level, role: level, buttons: out };
    }
    function loadAuthTable(btnCount){
      const raw = localStorage.getItem(AUTH_KEY);
      if(!raw){
        const d = getDefaultAuthTable(btnCount);
        localStorage.setItem(AUTH_KEY, JSON.stringify(d));
        return d.map(r=> normalizeRow(r, btnCount));
      }
      const arr = safeJsonParse(raw, null);
      if(Array.isArray(arr) && arr.length){
        const fixed = arr.map(r=> normalizeRow(r, btnCount));
        localStorage.setItem(AUTH_KEY, JSON.stringify(fixed));
        return fixed;
      }
      const d = getDefaultAuthTable(btnCount);
      localStorage.setItem(AUTH_KEY, JSON.stringify(d));
      return d.map(r=> normalizeRow(r, btnCount));
    }

    function saveAuthTableLocal(arr){
      localStorage.setItem(AUTH_KEY, JSON.stringify(arr));
    }

    // ==========================
    // Render table (è¡¨é ­ï¼šé¡¯ç¤ºæŒ‰éµåç¨±)
    // ==========================
    let NAV_CONFIG = [];
    let AUTH_TABLE = [];
    let isAdmin = false;
    let currentUser = null;

    function applyCurrentUserUI(){
      currentUser = getCurrentUser();
      if(!currentUser || !currentUser.username){
        userPill.textContent = "ç›®å‰ä½¿ç”¨è€…ï¼šæœªç™»å…¥";
        isAdmin = false;
        subInfo.textContent = "å°šæœªç™»å…¥ï¼Œè«‹å›é¦–é ç™»å…¥å¾Œå†é€²å…¥ã€‚";
        disableAllEditing(true);
        return;
      }
      const lvl = mapRole(currentUser.level ?? currentUser.role) || "read";
      userPill.textContent = `ç›®å‰ä½¿ç”¨è€…ï¼š${currentUser.username} (${lvl})`;
      isAdmin = (lvl === "admin");
      subInfo.textContent = isAdmin
        ? "åªæœ‰ admin å¯ä»¥ç·¨è¼¯ï¼›å…¶ä»–æ¬Šé™åªèƒ½æŸ¥çœ‹ã€‚\nï¼ˆå¯ç·¨è¼¯ï¼‰"
        : "åªæœ‰ admin å¯ä»¥ç·¨è¼¯ï¼›å…¶ä»–æ¬Šé™åªèƒ½æŸ¥çœ‹ã€‚";
      disableAllEditing(!isAdmin);
    }

    function disableAllEditing(disabled){
      // å…ˆæŠŠ UI ä¸Šçš„æŒ‰éˆ•ç‹€æ…‹èª¿æ•´
      btnAddRow.disabled = disabled;
      btnUpload.disabled = disabled;
      btnSaveLocal.disabled = false; // åªå­˜æœ¬æ©Ÿä»å…è¨±ï¼ˆä½†å…§å®¹è‹¥ä¸èƒ½æ”¹ä¹Ÿæ²’å·®ï¼‰
    }

    function renderTable(){
      NAV_CONFIG = loadNavConfig();
      AUTH_TABLE = loadAuthTable(NAV_CONFIG.length);

      // --- thead ---
      theadRow.innerHTML = "";

      const thUser = document.createElement("th"); thUser.textContent = "ä½¿ç”¨è€…"; theadRow.appendChild(thUser);
      const thPwd  = document.createElement("th"); thPwd.textContent  = "å¯†ç¢¼"; theadRow.appendChild(thPwd);
      const thRole = document.createElement("th"); thRole.textContent = "æ¬Šé™"; theadRow.appendChild(thRole);

      // âœ… å‹•æ…‹æŒ‰éµæ¬„ä½ï¼šç›´æ¥ç”¨ NAV çš„ label
      NAV_CONFIG.forEach((cfg, i)=>{
        const th = document.createElement("th");
        th.textContent = cfg.label;             // â† ä¸å†é¡¯ç¤ºã€Œé¡¯ç¤º btn1ã€
        th.title = `btn${i+1}ï¼š${cfg.label}`;
        theadRow.appendChild(th);
      });

      const thSys = document.createElement("th");
      thSys.textContent = "ç³»çµ±/æ¬Šé™";
      theadRow.appendChild(thSys);

      const thDel = document.createElement("th");
      thDel.textContent = "åˆªé™¤";
      theadRow.appendChild(thDel);

      // --- tbody ---
      tbody.innerHTML = "";

      AUTH_TABLE.forEach((row, rIdx)=>{
        const tr = document.createElement("tr");

        // user
        const tdU = document.createElement("td");
        const inpU = document.createElement("input");
        inpU.className = "field";
        inpU.value = row.username;
        inpU.disabled = !isAdmin;
        inpU.addEventListener("input", ()=>{
          AUTH_TABLE[rIdx].username = String(inpU.value||"").trim();
        });
        tdU.appendChild(inpU);
        tr.appendChild(tdU);

        // pwd
        const tdP = document.createElement("td");
        const inpP = document.createElement("input");
        inpP.className = "field";
        inpP.value = row.password;
        inpP.disabled = !isAdmin;
        inpP.addEventListener("input", ()=>{
          AUTH_TABLE[rIdx].password = String(inpP.value||"");
        });
        tdP.appendChild(inpP);
        tr.appendChild(tdP);

        // role
        const tdR = document.createElement("td");
        const sel = document.createElement("select");
        sel.className = "field role";
        ["admin","write","read"].forEach(v=>{
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          sel.appendChild(opt);
        });
        sel.value = mapRole(row.level ?? row.role) || "read";
        sel.disabled = !isAdmin;
        sel.addEventListener("change", ()=>{
          const v = mapRole(sel.value) || "read";
          AUTH_TABLE[rIdx].level = v;
          AUTH_TABLE[rIdx].role  = v;
          // ç³»çµ±/æ¬Šé™æ¬„å³æ™‚æ›´æ–°
          renderTable();
        });
        tdR.appendChild(sel);
        tr.appendChild(tdR);

        // buttons
        NAV_CONFIG.forEach((cfg, i)=>{
          const td = document.createElement("td");
          td.style.textAlign = "center";
          const ck = document.createElement("input");
          ck.type = "checkbox";
          ck.className = "chk";
          ck.checked = !!(row.buttons && row.buttons[i]);
          ck.disabled = !isAdmin;
          ck.addEventListener("change", ()=>{
            if(!Array.isArray(AUTH_TABLE[rIdx].buttons)) AUTH_TABLE[rIdx].buttons = [];
            AUTH_TABLE[rIdx].buttons[i] = !!ck.checked;
          });
          td.appendChild(ck);
          tr.appendChild(td);
        });

        // system/æ¬Šé™ï¼ˆç¬¬6é¡†å›ºå®šåªæœ‰ admin é¡¯ç¤ºï¼‰
        const tdSys = document.createElement("td");
        tdSys.style.textAlign = "center";
        const lvl = mapRole(row.level ?? row.role) || "read";
        tdSys.textContent = (lvl === "admin") ? "âœ“" : "â€”";
        tdSys.className = (lvl === "admin") ? "" : "muted";
        tr.appendChild(tdSys);

        // delete
        const tdD = document.createElement("td");
        tdD.style.textAlign = "center";
        const bd = document.createElement("button");
        bd.className = "btn btn-small ghost";
        bd.textContent = "åˆªé™¤";
        bd.disabled = !isAdmin;
        bd.addEventListener("click", ()=>{
          if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ä¸€åˆ—ï¼Ÿ")) return;
          AUTH_TABLE.splice(rIdx, 1);
          saveAuthTableLocal(AUTH_TABLE);
          renderTable();
        });
        tdD.appendChild(bd);
        tr.appendChild(tdD);

        tbody.appendChild(tr);
      });
    }

    // ==========================
    // Token overlay
    // ==========================
    function showTokenOverlay(){
      tokenOverlay.style.display = "flex";
      tokenOverlay.setAttribute("aria-hidden","false");
      appNameInput.value = getDbxAppName();
      appKeyInput.value = getDbxAppKey();
      tokenInput.value = getDbxToken();
      tokenMsg.textContent = `Dropbox ç¶²ç«™ä½ç½®ï¼ˆApp folderï¼‰ï¼š\n${dropboxWebFolderUrl()}`;
      setTimeout(()=> (appNameInput || tokenInput).focus(), 60);
    }
    function hideTokenOverlay(){
      tokenOverlay.style.display = "none";
      tokenOverlay.setAttribute("aria-hidden","true");
      tokenMsg.textContent = "";
    }

    tokenEyeBtn.addEventListener("click", ()=>{
      tokenInput.type = (tokenInput.type === "password") ? "text" : "password";
    });

    btnOpenPerm.addEventListener("click", ()=>{
      syncAppKeyFromInput();
      openConsoleTab(getConsolePermUrl(), "Permissions");
    });
    btnOpenSet.addEventListener("click", ()=>{
      syncAppKeyFromInput();
      openConsoleTab(getConsoleSetUrl(), "Settings");
    });

    function guideToConsoleStrong(){
      const kNow = syncAppKeyFromInput();
      alert("æ¥ä¸‹ä¾†é€²å…¥ã€Œä¸€æ­¥ä¸€æ­¥å°è¦½ã€ã€‚\næœƒå˜—è©¦è‡ªå‹•é–‹ Permissions / Settingsã€‚\næŒ‰ã€Œç¢ºå®šã€é–‹å§‹ã€‚");

      if(!kNow){
        alert("ä½ ç›®å‰é‚„æ²’å¡« App keyï¼Œå› æ­¤ç„¡æ³•ç›´é” Permissions/Settingsã€‚\næˆ‘å…ˆå¹«ä½ é–‹ Apps åˆ—è¡¨ï¼Œä½ é»é€² App å¾Œï¼Œçœ‹ç¶²å€ info/<é€™ä¸²>#settingsï¼ŒæŠŠ <é€™ä¸²> è²¼å›ä¾†ã€‚");
        window.open("https://www.dropbox.com/developers/apps", "_blank", "noopener");
        alert("æ­¥é©Ÿï¼š\n1) Apps åˆ—è¡¨ â†’ é»ä½ çš„ App\n2) ç¶²å€åƒï¼š.../apps/info/ã€a5pm08...ã€#settings\n3) è¤‡è£½ã€a5pm08...ã€è²¼å›æœ¬è¦–çª— App key\n4) å†æŒ‰ä¸€æ¬¡ã€Œä¸€æ­¥ä¸€æ­¥å°è¦½ï¼ˆè‡ªå‹•é–‹é€£çµï¼‰ã€");
        return;
      }

      const okPerm = openConsoleTab(getConsolePermUrl(), "Permissions");
      if(okPerm){
        alert("æ­¥é©Ÿ 1ï¼ˆPermissionsï¼‰ï¼šè«‹å‹¾ scopesï¼ˆè‡³å°‘ï¼‰ï¼š\n- files.content.write\n- files.content.read\n- files.metadata.read\nï¼ˆå»ºè­°ä¹Ÿå‹¾ï¼šaccount_info.readï¼‰\nå‹¾å¥½å¾ŒæŒ‰ Submitã€‚");
      }

      const okSet = openConsoleTab(getConsoleSetUrl(), "Settings");
      if(okSet){
        alert("æ­¥é©Ÿ 2ï¼ˆSettingsï¼‰ï¼šè«‹é‡æ–°ç”¢ç”Ÿ Access Tokenï¼ˆGenerateï¼‰ã€‚\nâš ï¸ å‹¾å®Œ scope ä¸€å®šè¦æ–° token æ‰æœƒç”Ÿæ•ˆã€‚\nè¤‡è£½æ–° token â†’ å›æœ¬é  â†’ æŒ‰ã€Œå„²å­˜ä¸¦æ¸¬è©¦ã€ã€‚");
      }
    }
    tokenGuideBtn.addEventListener("click", guideToConsoleStrong);
    tokenCloseBtn.addEventListener("click", hideTokenOverlay);

    tokenSaveBtn.addEventListener("click", async ()=>{
      const appName = String(appNameInput.value||"").trim() || DEFAULT_APP_NAME;
      setDbxAppName(appName);
      syncAppKeyFromInput();

      const t = String(tokenInput.value||"").trim();
      if(!t){
        tokenMsg.textContent = "è«‹å…ˆè²¼ä¸Š Access Tokenã€‚";
        return;
      }
      setDbxToken(t);

      tokenMsg.textContent = "æ­£åœ¨æ¸¬è©¦ Tokenâ€¦";
      const chk = await testTokenAndGetEmail();
      if(!chk.ok){
        tokenMsg.textContent = chk.msg + "\n\nè‹¥æ˜¯ scopes ä¸è¶³ï¼ŒæŒ‰ã€Œä¸€æ­¥ä¸€æ­¥å°è¦½ï¼ˆè‡ªå‹•é–‹é€£çµï¼‰ã€ã€‚";
        return;
      }

      let emailHint = "";
      if(chk.email && chk.email.toLowerCase() !== EXPECT_EMAIL.toLowerCase()){
        emailHint = `\nâš ï¸ é€™å€‹ token å°æ‡‰ emailï¼š${chk.email}\nä½ æœŸæœ›ï¼š${EXPECT_EMAIL}\nï¼ˆå¯èƒ½åœ¨ä¸åŒ Dropbox å¸³è™Ÿç”¢ç”Ÿ tokenï¼‰`;
      }else if(chk.email){
        emailHint = `\nâœ… token å°æ‡‰ emailï¼š${chk.email}`;
      }

      tokenMsg.textContent = chk.msg + emailHint + "\n\næ­£åœ¨ç¢ºèªè³‡æ–™å¤¾â€¦";
      const folderChk = await ensureFolder();
      if(!folderChk.ok){
        tokenMsg.textContent =
          chk.msg + emailHint +
          "\n\n" + folderChk.msg +
          "\n\nâœ… è‹¥è¨Šæ¯ä¸­åŒ…å« files.content.write / missing_scopeï¼Œè«‹åˆ° Console å‹¾æ¬Šé™ä¸¦é‡æ–°ç”¢ç”Ÿæ–° tokenã€‚";
        const go = confirm("å¯èƒ½æ˜¯ scopes ä¸è¶³ï¼ˆfiles.content.writeï¼‰ã€‚\n\nè¦ç¾åœ¨é–‹å§‹å°è¦½å» Console å—ï¼Ÿ");
        if(go) guideToConsoleStrong();
        return;
      }

      tokenMsg.textContent =
`${chk.msg}${emailHint}
${folderChk.msg}

Dropbox ç¶²ç«™ä½ç½®ï¼ˆApp folderï¼‰ï¼š
${dropboxWebFolderUrl()}

âœ… Token OKï¼Œå·²å¯åŒæ­¥ã€‚`;
      setTimeout(()=> hideTokenOverlay(), 650);

      // ç«‹å³åˆ·æ–°ç‹€æ…‹
      syncNow({ force:true });
    });

    // ==========================
    // Actions
    // ==========================
    function openHome(){
      location.href = "index.html";
    }

    function toggleMobileMenu(){
      const opened = mMenu.style.display === "block";
      mMenu.style.display = opened ? "none" : "block";
      mMenu.setAttribute("aria-hidden", opened ? "true" : "false");
    }
    document.addEventListener("click", (e)=>{
      const inside = e.target === mMore || mMore.contains(e.target) || e.target === mMenu || mMenu.contains(e.target);
      if(!inside) { mMenu.style.display="none"; mMenu.setAttribute("aria-hidden","true"); }
    });

    btnHome.addEventListener("click", openHome);
    mBack.addEventListener("click", openHome);

    mMore.addEventListener("click", toggleMobileMenu);

    // åˆ‡æ›å¸³è™Ÿï¼šå›é¦–é ä¸¦æ¸… sessionï¼ˆä¸å¯« localï¼‰
    function doSwitch(){
      sessionStorage.removeItem(CURRENT_KEY);
      bcPost({ type:"logout" });
      location.href = "index.html";
    }
    btnSwitch.addEventListener("click", doSwitch);
    mSwitch.addEventListener("click", doSwitch);

    btnToken.addEventListener("click", showTokenOverlay);
    mToken.addEventListener("click", showTokenOverlay);

    btnAddRow.addEventListener("click", ()=>{
      if(!isAdmin){
        alert("åªæœ‰ admin å¯ä»¥æ–°å¢/ç·¨è¼¯ã€‚");
        return;
      }
      NAV_CONFIG = loadNavConfig();
      const btnCount = NAV_CONFIG.length;
      AUTH_TABLE = loadAuthTable(btnCount);
      AUTH_TABLE.push({ username:"", password:"", level:"read", role:"read", buttons: Array(btnCount).fill(true) });
      saveAuthTableLocal(AUTH_TABLE);
      renderTable();
    });

    btnSaveLocal.addEventListener("click", ()=>{
      saveAuthTableLocal(AUTH_TABLE);
      statusPill.textContent = dbxEnabled()
        ? "ç‹€æ…‹ï¼šå·²å„²å­˜æœ¬æ©Ÿï¼ˆToken å·²è¨­å®šï¼Œå¯åŒæ­¥ï¼‰"
        : "ç‹€æ…‹ï¼šå·²å„²å­˜æœ¬æ©Ÿï¼ˆæœªè¨­å®š Tokenï¼‰";
    });

    async function doDownload(){
      if(!dbxEnabled()){
        alert("å°šæœªè¨­å®š Tokenï¼Œç„¡æ³•é›²ç«¯ä¸‹è¼‰ã€‚\nè«‹å…ˆæŒ‰ã€Œè¨­å®š Tokenã€ã€‚");
        return;
      }
      statusPill.textContent = "ç‹€æ…‹ï¼šé›²ç«¯ä¸‹è¼‰ä¸­â€¦";
      await cloudPullToLocalStorage({ force:true });
      await syncNow({ force:true });
      statusPill.textContent = "ç‹€æ…‹ï¼šå·²é›²ç«¯ä¸‹è¼‰ä¸¦åˆ·æ–°";
    }
    btnDownload.addEventListener("click", doDownload);
    mDownload.addEventListener("click", doDownload);

    async function doUpload(){
      if(!isAdmin){
        alert("åªæœ‰ admin å¯ä»¥å„²å­˜ä¸¦ä¸Šå‚³ã€‚");
        return;
      }
      saveAuthTableLocal(AUTH_TABLE);

      if(!dbxEnabled()){
        alert("ç›®å‰æœªè¨­å®š Tokenï¼Œåªèƒ½å„²å­˜æœ¬æ©Ÿã€‚\nè‹¥è¦åŒæ­¥ï¼Œè«‹å…ˆè¨­å®š Tokenã€‚");
        statusPill.textContent = "ç‹€æ…‹ï¼šå·²å„²å­˜æœ¬æ©Ÿï¼ˆæœªè¨­å®š Tokenï¼‰";
        return;
      }

      statusPill.textContent = "ç‹€æ…‹ï¼šç¢ºèªè³‡æ–™å¤¾/ä¸Šå‚³ä¸­â€¦";
      const folderChk = await ensureFolder();
      if(!folderChk.ok){
        statusPill.textContent = "ç‹€æ…‹ï¼šâŒ ç„¡æ³•å»ºç«‹/ç¢ºèªè³‡æ–™å¤¾\n" + folderChk.msg;
        alert(folderChk.msg);
        return;
      }

      // ä¸Šå‚³ AUTHï¼ˆå¯é¸ï¼šä¹Ÿä¸Šå‚³ NAVï¼Œä¿è­‰æ¬„ä½åç¨±åŒæ­¥ï¼‰
      const authObj = AUTH_TABLE.map(r=>{
        const lvl = mapRole(r.level ?? r.role) || "read";
        return { username:String(r.username||"").trim(), password:String(r.password||""), level:lvl, role:lvl, buttons:Array.isArray(r.buttons)? r.buttons.slice():[] };
      });
      const navObj = loadNavConfig();

      const up1 = await dbxUploadJson(dbxPathAuth(), authObj);
      const up2 = await dbxUploadJson(dbxPathNav(),  navObj);

      const meta = { updatedAt: Date.now() };
      const up3 = await dbxUploadJson(dbxPathMeta(), meta);

      if(!up1.ok || !up2.ok || !up3.ok){
        const msg = [up1.ok?null:up1.msg, up2.ok?null:up2.msg, up3.ok?null:up3.msg].filter(Boolean).join("\n\n");
        statusPill.textContent = "ç‹€æ…‹ï¼šâŒ ä¸Šå‚³å¤±æ•—\n" + msg;
        alert(msg);
        return;
      }

      setLocalUpdatedAt(meta.updatedAt);
      statusPill.textContent = "ç‹€æ…‹ï¼šâœ… å·²å„²å­˜ä¸¦ä¸Šå‚³ï¼ˆåŒæ­¥å®Œæˆï¼‰";
      // ç«‹åˆ»åˆ·æ–°
      await syncNow({ force:true });
    }
    btnUpload.addEventListener("click", doUpload);
    mUpload.addEventListener("click", doUpload);

    // ==========================
    // Watch (cloud + local) â€”â€” æ²’ token ä¹Ÿç›£çœ‹æœ¬æ©Ÿ
    // ==========================
    const WATCH_MS = 2500;
    let watchTimer = null;
    let watchBusy = false;

    let lastAuthRaw = "";
    let lastNavRaw  = "";

    function localChanged(){
      const a = localStorage.getItem(AUTH_KEY) || "";
      const n = localStorage.getItem(NAV_KEY)  || "";
      const changed = (a !== lastAuthRaw) || (n !== lastNavRaw);
      lastAuthRaw = a; lastNavRaw = n;
      return changed;
    }

    async function syncNow({ force=false } = {}){
      if(watchBusy) return;
      watchBusy = true;
      try{
        if(dbxEnabled()){
          await cloudPullToLocalStorage({ force });
        }

        const need = force || localChanged();
        if(need){
          applyCurrentUserUI();
          renderTable();
          refreshStatus();
        }
      } finally {
        watchBusy = false;
      }
    }

    function refreshStatus(){
      if(dbxEnabled()){
        statusPill.textContent = "ç‹€æ…‹ï¼šå·²è¨­å®š Tokenï¼ˆå¯åŒæ­¥ï¼‰";
      }else{
        statusPill.textContent = "ç‹€æ…‹ï¼šæœ¬æ©Ÿæ¨¡å¼ï¼ˆæœªè¨­å®š Tokenï¼‰";
      }
    }

    function startWatch(){
      lastAuthRaw = localStorage.getItem(AUTH_KEY) || "";
      lastNavRaw  = localStorage.getItem(NAV_KEY)  || "";
      if(watchTimer) clearInterval(watchTimer);
      watchTimer = setInterval(()=> syncNow({ force:false }), WATCH_MS);

      document.addEventListener("visibilitychange", ()=>{
        if(!document.hidden) syncNow({ force:false });
      });

      window.addEventListener("storage", (e)=>{
        if(!e) return;
        if(e.key === AUTH_KEY || e.key === NAV_KEY){
          syncNow({ force:true });
        }
      });
    }

    // ==========================
    // boot
    // ==========================
    (async function boot(){
      initAuthBridge();

      // è‹¥æœ¬é æ˜¯æ–°åˆ†é ï¼Œå…ˆå•å…¶ä»–åˆ†é æ˜¯å¦å·²ç™»å…¥
      const cu = getCurrentUser();
      if(!cu || !cu.username){
        bcPost({ type:"who" });
      }

      applyCurrentUserUI();
      renderTable();
      refreshStatus();

      startWatch();
    })();
  </script>
</body>
</html>
