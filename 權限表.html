<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Tasun æ¬Šé™è¡¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --gold: #f6d37a;
      --gold-soft: rgba(246, 211, 122, 0.8);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      font-family: "Noto Serif TC","æ¨™æ¥·é«”","Microsoft JhengHei",serif;
      background: radial-gradient(circle at 50% 10%, #2b1a05, #050302 60%);
      color: var(--gold);
      padding: 20px;
    }

    /* è¿”å›é¦–é  */
    .back-home {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.3rem 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.7);
      background: rgba(0,0,0,0.85);
      color: var(--gold-soft);
      text-decoration: none;
      font-size: 0.8rem;
      box-shadow: 0 8px 16px rgba(0,0,0,0.8);
    }

    .back-home:hover {
      background: rgba(0,0,0,0.95);
    }

    .page-title {
      text-align: center;
      margin: 10px 0 20px;
      font-size: 1.7rem;
      letter-spacing: 0.35em;
      text-indent: 0.35em;
      text-shadow:
        0 0 12px rgba(246, 211, 122, 0.9),
        0 0 26px rgba(246, 211, 122, 0.6);
    }

    .panel {
      max-width: 1100px;
      margin: 0 auto;
      padding: 1.5rem 1.8rem;
      border-radius: 1.4rem;
      background: rgba(0,0,0,0.9);
      border: 1px solid rgba(246, 211, 122, 0.45);
      box-shadow:
        0 18px 32px rgba(0,0,0,0.9),
        0 0 30px rgba(246, 211, 122, 0.35);
    }

    .panel p {
      font-size: 0.85rem;
      color: var(--gold-soft);
      margin-bottom: 0.8rem;
      line-height: 1.5;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }

    thead {
      background: rgba(246, 211, 122, 0.18);
    }

    th, td {
      border-bottom: 1px solid rgba(246, 211, 122, 0.2);
      padding: 0.35rem 0.4rem;
      text-align: center;
      vertical-align: middle;
    }

    th {
      letter-spacing: 0.14em;
      text-indent: 0.14em;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    input[type="text"],
    input[type="password"],
    select {
      width: 100%;
      padding: 0.25rem 0.35rem;
      border-radius: 0.4rem;
      border: 1px solid rgba(246, 211, 122, 0.5);
      background: rgba(0,0,0,0.9);
      color: var(--gold);
      font-size: 0.8rem;
    }

    input::placeholder {
      color: rgba(246, 211, 122, 0.4);
    }

    input[type="checkbox"] {
      transform: scale(1.2);
    }

    .btn-small {
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.7);
      background: rgba(0,0,0,0.9);
      color: var(--gold);
      font-size: 0.75rem;
      cursor: pointer;
    }

    .btn-small:hover {
      background: rgba(246, 211, 122, 0.15);
    }

    .btn-eye {
      padding: 0.15rem 0.4rem;
      min-width: 2.3rem;
    }

    .panel-footer {
      margin-top: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      color: var(--gold-soft);
    }

    .btn-main {
      padding: 0.4rem 1.2rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.9);
      background: radial-gradient(circle at 0% 0%, rgba(246, 211, 122, 0.4), rgba(0,0,0,0.95));
      color: var(--gold);
      font-size: 0.85rem;
      letter-spacing: 0.18em;
      text-indent: 0.18em;
      cursor: pointer;
      box-shadow:
        0 10px 20px rgba(0,0,0,0.9),
        0 0 18px rgba(246, 211, 122, 0.4);
    }

    .btn-main:hover {
      background: radial-gradient(circle at 0% 0%, rgba(255,240,200,0.5), rgba(0,0,0,0.98));
      box-shadow:
        0 14px 26px rgba(0,0,0,0.95),
        0 0 24px rgba(246, 211, 122, 0.6);
    }

    .warn {
      color: #ffb3b3;
    }

    .pwd-wrapper {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .pwd-input {
      flex: 1 1 auto;
    }

    .nav-config-title {
      margin-top: 0.3rem;
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.16em;
      text-indent: 0.16em;
      color: var(--gold-soft);
    }

    .nav-table {
      margin-top: 0.4rem;
      margin-bottom: 0.8rem;
      font-size: 0.8rem;
    }

    .nav-table th {
      letter-spacing: 0.12em;
      text-indent: 0.12em;
    }

    .nav-table input[type="text"] {
      font-size: 0.8rem;
    }

    @media (max-width: 900px) {
      .panel {
        padding: 1rem;
      }
      th, td {
        font-size: 0.75rem;
        padding: 0.25rem;
      }
      .page-title {
        font-size: 1.3rem;
      }
    }
  </style>
</head>
<body>
  <a class="back-home" href="index.html">â† è¿”å›é¦–é </a>

  <h1 class="page-title">Tasun æ¬Šé™è¡¨</h1>

  <div class="panel">
    <p>
      åªæœ‰ <strong>admin</strong> ç™»å…¥è€…å¯ä»¥ç·¨è¼¯æ­¤è¡¨ã€‚<br>
      æœ¬é é›†ä¸­ç®¡ç†ï¼š<strong>å¸³è™Ÿå¯†ç¢¼ï¼‹æ¬Šé™ç´šåˆ¥ï¼‹é¦–é æŒ‰éˆ•åç¨±èˆ‡é€£çµ</strong>ã€‚<br>
      é¦–é  <code>index.html</code> åªæœƒè®€å– localStorageï¼Œä¸å†å¯«æ­»æŒ‰éˆ•åç¨±èˆ‡ç¶²å€ã€‚<br>
      ç³»çµ± / æ¬Šé™ï¼ˆé€£åˆ°æœ¬é ï¼‰å›ºå®šåªæœ‰ admin é¡¯ç¤ºï¼Œä¸åˆ—å…¥ä¸‹åˆ—è¡¨æ ¼ã€‚
    </p>

    <!-- é¦–é æŒ‰éˆ•è¨­å®šï¼šåç¨± + é€£çµ -->
    <div class="nav-config-title">é¦–é æŒ‰éˆ•è¨­å®šï¼ˆå›ºå®š 5 é¡†ï¼Œå·¦ä¸Š â†’ å³ä¸Š â†’ å·¦ä¸­ â†’ å³ä¸­ â†’ å·¦ä¸‹ï¼‰</div>
    <table class="nav-table">
      <thead>
        <tr>
          <th style="width: 8%;">åºè™Ÿ</th>
          <th style="width: 30%;">æŒ‰éˆ•åç¨±</th>
          <th>é€£çµç¶²å€ï¼ˆhrefï¼‰</th>
        </tr>
      </thead>
      <tbody id="navConfigBody"></tbody>
    </table>

    <!-- ä½¿ç”¨è€…æ¬Šé™è¨­å®š -->
    <table>
      <thead>
        <tr id="headerRow"></tr>
      </thead>
      <tbody id="authBody"></tbody>
    </table>

    <div class="panel-footer">
      <div>
        <button type="button" class="btn-small" id="addRowBtn">ï¼‹ æ–°å¢ä¸€åˆ—å¸³è™Ÿ</button>
      </div>
      <div>
        <button type="button" class="btn-main" id="saveBtn">å„²å­˜è¨­å®š</button>
      </div>
    </div>

    <p class="warn" id="statusMsg"></p>
  </div>

  <script>
    (function () {
      const AUTH_KEY    = "tasunAuthTable_v1";
      const CURRENT_KEY = "tasunCurrentUser_v1";
      const NAV_KEY     = "tasunNavButtons_v1";

      const LEGACY_BUTTON_KEYS = ["btn1", "btn2", "btn3", "btn4", "btn5"];

      // é è¨­ 5 é¡†é¦–é æŒ‰éˆ•ï¼ˆèˆ‡ index.html çš„ DEFAULT_NAV åŒæ­¥ï¼‰
      const DEFAULT_NAV = [
        {
          id: "btn1",
          label: "è‡»é¼æ™‚ä»£å¤§å»ˆç®¡ç†è¡¨",
          href: "è‡»é¼ç®¡ç†è¡¨.html",
          target: "",
          roles: ["admin", "write", "read"]
        },
        {
          id: "btn2",
          label: "ç¼ºå¤± / å“è³ª",
          href: "ç”„é¼quality.html",
          target: "",
          roles: ["admin", "write", "read"]
        },
        {
          id: "btn3",
          label: "é›²ç«¯æª”æ¡ˆ",
          href: "https://www.dropbox.com/",
          target: "_blank",
          roles: ["admin", "write", "read"]
        },
        {
          id: "btn4",
          label: "å·¥ç¨‹è³‡æ–™åº«",
          href: "å·¥ç¨‹è³‡æ–™åº«.html",
          target: "",
          roles: ["admin", "write"]
        },
        {
          id: "btn5",
          label: "è³‡æ–™åº«",
          href: "#",
          target: "",
          roles: ["admin", "write", "read"]
        }
      ];

      const navConfigBody = document.getElementById("navConfigBody");
      const headerRow     = document.getElementById("headerRow");
      const authBody      = document.getElementById("authBody");
      const addRowBtn     = document.getElementById("addRowBtn");
      const saveBtn       = document.getElementById("saveBtn");
      const statusMsg     = document.getElementById("statusMsg");

      /* ---------------------------
         åƒ… admin å¯é€²å…¥æ­¤é 
         --------------------------- */
      function ensureAdmin() {
        const saved = localStorage.getItem(CURRENT_KEY);
        if (!saved) {
          alert("è«‹å…ˆåœ¨é¦–é ç™»å…¥å¾Œå†é€²å…¥æ¬Šé™è¡¨ã€‚");
          location.href = "index.html";
          return null;
        }
        try {
          const user = JSON.parse(saved);
          if (!user || user.level !== "admin") {
            alert("åªæœ‰ admin å¯ä»¥ç·¨è¼¯æ¬Šé™è¡¨ã€‚");
            location.href = "index.html";
            return null;
          }
          return user;
        } catch (e) {
          alert("ç™»å…¥è³‡è¨ŠéŒ¯èª¤ï¼Œè«‹é‡æ–°ç™»å…¥ã€‚");
          location.href = "index.html";
          return null;
        }
      }

      /* ---------------------------
         é¦–é æŒ‰éˆ•è¨­å®šï¼šè®€ / å¯« NAV_KEY
         --------------------------- */
      function loadNavConfig() {
        const base = DEFAULT_NAV.map(btn => ({ ...btn }));
        const raw = localStorage.getItem(NAV_KEY);
        if (!raw) return base;
        try {
          const arr = JSON.parse(raw);
          if (!Array.isArray(arr)) return base;

          for (let i = 0; i < base.length; i++) {
            const src = arr[i];
            if (!src || typeof src !== "object") continue;

            if (typeof src.label === "string" && src.label.trim()) {
              base[i].label = src.label.trim();
            }
            if (typeof src.href === "string" && src.href.trim()) {
              base[i].href = src.href.trim();
            }
            if (typeof src.target === "string" && src.target.trim()) {
              base[i].target = src.target.trim();
            }
          }
          return base;
        } catch (e) {
          return base;
        }
      }

      function saveNavConfig(navArr) {
        // åªå­˜ label + href + targetï¼Œå…¶ä»–ï¼ˆid, rolesï¼‰ç”± DEFAULT_NAV ç®¡ç†
        const compact = navArr.map(item => ({
          label: item.label || "",
          href:  item.href  || "",
          target: item.target || ""
        }));
        localStorage.setItem(NAV_KEY, JSON.stringify(compact));
      }

      function renderNavConfig(navArr) {
        navConfigBody.innerHTML = "";
        navArr.forEach((item, index) => {
          const tr = document.createElement("tr");

          const tdIdx = document.createElement("td");
          tdIdx.textContent = index + 1;
          tr.appendChild(tdIdx);

          const tdLabel = document.createElement("td");
          const inLabel = document.createElement("input");
          inLabel.type = "text";
          inLabel.value = item.label || "";
          inLabel.placeholder = "æŒ‰éˆ•åç¨±";
          inLabel.dataset.navIndex = String(index);
          inLabel.dataset.field = "label";
          tdLabel.appendChild(inLabel);
          tr.appendChild(tdLabel);

          const tdHref = document.createElement("td");
          const inHref = document.createElement("input");
          inHref.type = "text";
          inHref.value = item.href || "";
          inHref.placeholder = "ä¾‹å¦‚ï¼šè‡»é¼ç®¡ç†è¡¨.html æˆ– https://...";
          inHref.dataset.navIndex = String(index);
          inHref.dataset.field = "href";
          tdHref.appendChild(inHref);
          tr.appendChild(tdHref);

          navConfigBody.appendChild(tr);
        });
      }

      function collectNavConfigFromUI(currentNavArr) {
        const result = currentNavArr.map(item => ({ ...item }));
        const inputs = navConfigBody.querySelectorAll("input[type='text']");
        inputs.forEach(inp => {
          const idx = parseInt(inp.dataset.navIndex || "0", 10);
          const field = inp.dataset.field;
          if (!Number.isFinite(idx) || idx < 0 || idx >= result.length) return;
          if (field === "label") {
            result[idx].label = inp.value.trim() || DEFAULT_NAV[idx].label;
          } else if (field === "href") {
            result[idx].href = inp.value.trim() || DEFAULT_NAV[idx].href;
          }
        });
        return result;
      }

      /* ---------------------------
         æ¬Šé™è¡¨ï¼šå¸³è™Ÿ / å¯†ç¢¼ / æŒ‰éˆ•å‹¾é¸
         --------------------------- */
      function makeButtonsAll(count) {
        return Array(count).fill(true);
      }

      function makeButtonsOnlyLast(count) {
        const arr = Array(count).fill(false);
        if (count > 0) arr[count - 1] = true;
        return arr;
      }

      function getDefaultAuthTable(btnCount) {
        return [
          {
            username: "alex",
            password: "Tasun08040224",
            level: "admin",
            buttons: makeButtonsAll(btnCount)
          },
          {
            username: "tasun",
            password: "tasun08040224",
            level: "write",
            buttons: makeButtonsAll(btnCount)
          },
          {
            username: "wu",
            password: "123456",
            level: "read",
            buttons: makeButtonsOnlyLast(btnCount)
          }
        ];
      }

      function normalizeRowFromStorage(row, btnCount) {
        const username = row.username || "";
        const password = row.password || "";
        const level    = row.level || "read";

        let buttons = [];

        if (Array.isArray(row.buttons)) {
          buttons = row.buttons.slice();
        } else {
          const legacy = [];
          LEGACY_BUTTON_KEYS.forEach(k => {
            if (Object.prototype.hasOwnProperty.call(row, k)) {
              legacy.push(!!row[k]);
            }
          });
          buttons = legacy;
        }

        const resultButtons = [];
        for (let i = 0; i < btnCount; i++) {
          resultButtons[i] = !!buttons[i];
        }

        return { username, password, level, buttons: resultButtons };
      }

      function loadAuthTable(btnCount) {
        const raw = localStorage.getItem(AUTH_KEY);
        if (!raw) {
          const defaults = getDefaultAuthTable(btnCount);
          localStorage.setItem(AUTH_KEY, JSON.stringify(defaults));
          return defaults;
        }
        try {
          const arr = JSON.parse(raw);
          if (Array.isArray(arr)) {
            return arr.map(r => normalizeRowFromStorage(r, btnCount));
          }
        } catch (e) {}
        const defaults = getDefaultAuthTable(btnCount);
        localStorage.setItem(AUTH_KEY, JSON.stringify(defaults));
        return defaults;
      }

      function saveAuthTable(arr) {
        localStorage.setItem(AUTH_KEY, JSON.stringify(arr));
      }

      /* ---------------------------
         ç•«é¢ï¼šè¡¨é ­èˆ‡ä½¿ç”¨è€…åˆ—
         --------------------------- */
      function renderHeader(navArr) {
        headerRow.innerHTML = "";

        const thUser = document.createElement("th");
        thUser.textContent = "ç”¨æˆ¶å";
        headerRow.appendChild(thUser);

        const thPwd = document.createElement("th");
        thPwd.textContent = "å¯†ç¢¼";
        headerRow.appendChild(thPwd);

        const thLevel = document.createElement("th");
        thLevel.textContent = "æ¬Šé™ç´šåˆ¥";
        headerRow.appendChild(thLevel);

        navArr.forEach((btn, idx) => {
          const th = document.createElement("th");
          th.textContent = btn.label || ("æŒ‰éˆ•" + (idx + 1));
          headerRow.appendChild(th);
        });

        const thDel = document.createElement("th");
        thDel.textContent = "åˆªé™¤";
        headerRow.appendChild(thDel);
      }

      function renderAuthTable(data, btnCount) {
        authBody.innerHTML = "";

        data.forEach(row => {
          const tr = document.createElement("tr");

          const tdUser = document.createElement("td");
          const inUser = document.createElement("input");
          inUser.type = "text";
          inUser.value = row.username || "";
          inUser.placeholder = "å¸³è™Ÿ";
          tdUser.appendChild(inUser);
          tr.appendChild(tdUser);

          const tdPwd = document.createElement("td");
          const pwdWrapper = document.createElement("div");
          pwdWrapper.className = "pwd-wrapper";

          const inPwd = document.createElement("input");
          inPwd.type = "password";
          inPwd.value = row.password || "";
          inPwd.placeholder = "å¯†ç¢¼";
          inPwd.className = "pwd-input";

          const eyeBtn = document.createElement("button");
          eyeBtn.type = "button";
          eyeBtn.className = "btn-small btn-eye";
          eyeBtn.textContent = "ğŸ‘";

          pwdWrapper.appendChild(inPwd);
          pwdWrapper.appendChild(eyeBtn);
          tdPwd.appendChild(pwdWrapper);
          tr.appendChild(tdPwd);

          const tdLevel = document.createElement("td");
          const sel = document.createElement("select");
          ["admin", "write", "read"].forEach(lv => {
            const opt = document.createElement("option");
            opt.value = lv;
            opt.textContent = lv;
            if (row.level === lv) opt.selected = true;
            sel.appendChild(opt);
          });
          tdLevel.appendChild(sel);
          tr.appendChild(tdLevel);

          for (let i = 0; i < btnCount; i++) {
            const td = document.createElement("td");
            const chk = document.createElement("input");
            chk.type = "checkbox";
            chk.checked = !!row.buttons[i];
            td.appendChild(chk);
            tr.appendChild(td);
          }

          const tdDel = document.createElement("td");
          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "btn-small btn-del";
          delBtn.textContent = "åˆªé™¤";
          tdDel.appendChild(delBtn);
          tr.appendChild(tdDel);

          authBody.appendChild(tr);
        });
      }

      function collectAuthTable(btnCount) {
        const rows = Array.from(authBody.querySelectorAll("tr"));
        const result = [];

        rows.forEach(tr => {
          const tds = tr.querySelectorAll("td");

          const usernameInput = tds[0].querySelector("input");
          const pwdInput      = tds[1].querySelector(".pwd-input");
          const levelSelect   = tds[2].querySelector("select");

          const username = usernameInput ? usernameInput.value.trim() : "";
          const password = pwdInput ? pwdInput.value.trim() : "";
          const level    = levelSelect ? levelSelect.value : "read";

          if (!username || !password) {
            return;
          }

          const buttons = [];
          for (let i = 0; i < btnCount; i++) {
            const tdIndex = 3 + i;
            const chk = tds[tdIndex].querySelector("input[type='checkbox']");
            buttons.push(chk ? chk.checked : false);
          }

          result.push({ username, password, level, buttons });
        });

        return result;
      }

      /* ---------------------------
         åˆå§‹åŒ–
         --------------------------- */
      document.addEventListener("DOMContentLoaded", function () {
        const user = ensureAdmin();
        if (!user) return;

        const navArr   = loadNavConfig();
        const btnCount = navArr.length;

        renderNavConfig(navArr);
        renderHeader(navArr);

        const authData = loadAuthTable(btnCount);
        renderAuthTable(authData, btnCount);

        addRowBtn.addEventListener("click", function () {
          const current = collectAuthTable(btnCount);
          current.push({
            username: "",
            password: "",
            level: "read",
            buttons: Array(btnCount).fill(false)
          });
          renderAuthTable(current, btnCount);
        });

        authBody.addEventListener("click", function (e) {
          const target = e.target;
          if (target.classList.contains("btn-del")) {
            const tr = target.closest("tr");
            if (tr) tr.remove();
            return;
          }
          if (target.classList.contains("btn-eye")) {
            const td = target.closest("td");
            if (!td) return;
            const input = td.querySelector(".pwd-input");
            if (!input) return;
            input.type = input.type === "password" ? "text" : "password";
          }
        });

        saveBtn.addEventListener("click", function () {
          statusMsg.textContent = "";

          const newNavArr   = collectNavConfigFromUI(navArr);
          const newAuthData = collectAuthTable(btnCount);

          if (!newAuthData.length) {
            statusMsg.textContent = "è‡³å°‘éœ€è¦ä¸€ç­†å¸³è™Ÿè³‡æ–™ã€‚";
            return;
          }

          saveNavConfig(newNavArr);
          saveAuthTable(newAuthData);

          statusMsg.textContent = "å·²å„²å­˜ã€Œé¦–é æŒ‰éˆ•è¨­å®šã€èˆ‡ã€Œå¸³è™Ÿæ¬Šé™ã€ã€‚è«‹å›é¦–é é‡æ–°ç™»å…¥æŸ¥çœ‹æ•ˆæœã€‚";
        });
      });
    })();
  </script>
</body>
</html>
