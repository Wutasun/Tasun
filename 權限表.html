<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Tasun æ¬Šé™è¡¨</title>

  <style>
    :root{
      --gold:#f6d37a;
      --gold2:rgba(246,211,122,.78);
      --gold3:rgba(246,211,122,.45);
      --bg:#050302;
      --panel: rgba(0,0,0,.78);
      --panel2: rgba(0,0,0,.88);
      --line: rgba(246,211,122,.22);
      --shadow: 0 18px 34px rgba(0,0,0,.88), 0 0 26px rgba(246,211,122,.18);
      --r: 18px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      background:
        radial-gradient(circle at 10% 0%, rgba(252, 211, 77, 0.14) 0, transparent 45%),
        radial-gradient(circle at 90% 90%, rgba(251, 191, 36, 0.20) 0, transparent 50%),
        radial-gradient(circle at 50% 20%, rgba(255, 244, 208, 0.10) 0, transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,.82), rgba(0,0,0,.92));
      color: var(--gold);
      font-family: system-ui, -apple-system, "Segoe UI", "Microsoft JhengHei", sans-serif;
      overflow-x:hidden;
    }

    .wrap{
      max-width: 1280px;
      margin: 0 auto;
      padding: 18px 14px 42px;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 20;
      padding: 12px 0 10px;
      background: linear-gradient(180deg, rgba(0,0,0,.82), rgba(0,0,0,.35));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content: space-between;
    }
    .title{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .title h1{
      font-size: clamp(1.2rem, 2.2vw, 1.8rem);
      letter-spacing:.18em;
      text-indent:.18em;
      text-shadow: 0 0 14px rgba(246,211,122,.45);
    }
    .pills{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{
      padding:.32rem .9rem;
      border-radius: 999px;
      border:1px solid var(--gold3);
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,.18), rgba(0,0,0,.86));
      color: var(--gold2);
      font-size:.86rem;
      letter-spacing:.10em;
      text-indent:.10em;
      box-shadow: 0 8px 16px rgba(0,0,0,.55);
      white-space:nowrap;
    }

    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .btn{
      border:1px solid rgba(246,211,122,.65);
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.03)),
        radial-gradient(circle at 0% 0%, rgba(246,211,122,.22), rgba(0,0,0,.86));
      color: var(--gold);
      padding:.42rem 1rem;
      border-radius: 999px;
      cursor:pointer;
      letter-spacing:.12em;
      text-indent:.12em;
      box-shadow: 0 10px 18px rgba(0,0,0,.72);
      transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease;
      white-space:nowrap;
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(255,244,208,.9);
      box-shadow: 0 14px 24px rgba(0,0,0,.82), 0 0 22px rgba(246,211,122,.25);
    }
    .btn.ghost{
      opacity:.86;
      border-color: rgba(246,211,122,.45);
    }
    .btn.danger{
      border-color: rgba(255,170,170,.55);
      color: rgba(255,220,220,.95);
      background:
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02)),
        radial-gradient(circle at 0% 0%, rgba(255,120,120,.16), rgba(0,0,0,.86));
    }
    .btn:disabled{
      opacity:.35;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }

    .panel{
      margin-top: 12px;
      border-radius: var(--r);
      border:1px solid var(--line);
      background:
        radial-gradient(circle at 0% 0%, rgba(246,211,122,.10), rgba(0,0,0,.82));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 14px 14px 10px;
      gap:10px;
      flex-wrap:wrap;
      border-bottom: 1px solid rgba(246,211,122,.16);
    }
    .hint{
      font-size:.9rem;
      color: rgba(246,211,122,.70);
      line-height:1.7;
      white-space:pre-line;
    }
    .status{
      font-size:.86rem;
      color: rgba(200,255,200,.9);
      min-height: 1.2rem;
      white-space:pre-line;
      text-align:right;
    }
    .status.warn{ color: rgba(255,220,180,.95); }
    .status.err{ color: rgba(255,180,180,.95); }

    .table-wrap{
      overflow:auto;
      padding: 10px 10px 14px;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width: 980px;
    }
    thead th{
      position: sticky;
      top: 74px; /* header sticky + spacing */
      z-index: 5;
      background: rgba(0,0,0,.86);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(246,211,122,.22);
      padding: 10px 10px;
      font-size:.86rem;
      color: rgba(246,211,122,.85);
      letter-spacing:.10em;
      text-indent:.10em;
      white-space:nowrap;
    }
    tbody td{
      border-bottom: 1px solid rgba(246,211,122,.12);
      padding: 10px 10px;
      vertical-align: middle;
    }
    tbody tr:hover td{
      background: rgba(246,211,122,.05);
    }

    .in{
      width: 100%;
      padding: .45rem .65rem;
      border-radius: 999px;
      border:1px solid rgba(246,211,122,.45);
      background: rgba(0,0,0,.72);
      color: var(--gold);
      outline:none;
    }
    .in:focus{
      border-color: rgba(255,244,208,.90);
      box-shadow: 0 0 12px rgba(246,211,122,.50);
    }
    .sel{
      width: 100%;
      padding: .45rem .65rem;
      border-radius: 999px;
      border:1px solid rgba(246,211,122,.45);
      background: rgba(0,0,0,.72);
      color: var(--gold);
      outline:none;
    }
    .chk{
      width: 18px;
      height: 18px;
      accent-color: #f6d37a;
      cursor: pointer;
    }
    .cell-center{ text-align:center; }

    .badge-admin{
      display:inline-block;
      padding:.18rem .55rem;
      border-radius:999px;
      border:1px solid rgba(246,211,122,.55);
      background: rgba(246,211,122,.12);
      color: rgba(255,244,208,.92);
      font-size:.78rem;
      letter-spacing:.08em;
      text-indent:.08em;
      margin-left:.35rem;
    }

    /* ===== Token overlay ===== */
    .token-overlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:2000;
      background: radial-gradient(circle at 50% 18%, rgba(255, 228, 170, 0.32), rgba(0, 0, 0, 0.98));
    }
    .token-box{
      width:min(680px, 95vw);
      border-radius: 18px;
      border: 1px solid rgba(246,211,122,.35);
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,.22), rgba(0,0,0,.95));
      box-shadow: 0 0 28px rgba(0,0,0,.92), 0 0 26px rgba(246,211,122,.18);
      padding: 1.35rem 1.35rem 1.1rem;
      color: rgba(246,211,122,.78);
    }
    .token-title{
      text-align:center;
      letter-spacing:.18em;
      text-indent:.18em;
      font-size:1.12rem;
      color: rgba(246,211,122,.92);
      text-shadow: 0 0 14px rgba(246,211,122,.55);
      margin-bottom:.6rem;
    }
    .token-hint{
      font-size:.9rem;
      line-height:1.75;
      white-space:pre-line;
      margin-bottom:.7rem;
    }
    .token-row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin:.45rem 0;}
    .token-input{
      flex:1 1 auto;
      width:100%;
      padding:.55rem .7rem;
      border-radius:999px;
      border:1px solid rgba(246,211,122,.5);
      background: rgba(0,0,0,.82);
      color: var(--gold);
      outline:none;
    }
    .token-input:focus{
      border-color: rgba(255,244,208,.9);
      box-shadow: 0 0 12px rgba(246,211,122,.55);
    }
    .token-eye{
      padding:.26rem .75rem;
      border-radius:999px;
      border:1px solid rgba(246,211,122,.8);
      background: rgba(0,0,0,.86);
      color: var(--gold);
      cursor:pointer;
      white-space:nowrap;
    }
    .token-msg{
      margin-top:.6rem;
      min-height:1.2rem;
      font-size:.86rem;
      color: rgba(255,200,200,.95);
      white-space:pre-line;
    }
    .token-actions{
      display:flex;
      gap:.55rem;
      justify-content:flex-end;
      flex-wrap:wrap;
      margin-top:.8rem;
    }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      color: rgba(255,240,200,.96);
    }

    /* ===== Readonly banner ===== */
    .readonly{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(246,211,122,.20);
      background: rgba(0,0,0,.55);
      color: rgba(246,211,122,.78);
      line-height: 1.7;
      white-space: pre-line;
    }

    @media (max-width: 900px){
      thead th{ top: 110px; }
      table{ min-width: 1080px; }
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="title">
          <h1>Tasun æ¬Šé™è¡¨</h1>
          <div class="pills">
            <div class="pill" id="pillUser">ç›®å‰ï¼šæœªç™»å…¥</div>
            <div class="pill">é›²ç«¯ï¼š<span id="pillCloud">æœªè¨­å®š</span></div>
          </div>
        </div>

        <div class="actions">
          <button class="btn ghost" id="btnBack">è¿”å›é¦–é </button>
          <button class="btn ghost" id="btnToken">è¨­å®š Token</button>
          <button class="btn ghost" id="btnOpenApps">é–‹å•Ÿ /Apps ä½ç½®</button>
          <button class="btn ghost" id="btnCloudPull">å¾é›²ç«¯ä¸‹è¼‰</button>
          <button class="btn ghost" id="btnCloudPush">æ‰‹å‹•åŒæ­¥</button>
          <button class="btn" id="btnAddRow">ï¼‹æ–°å¢ä¸€åˆ—å¸³è™Ÿ</button>
        </div>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="panel">
      <div class="panel-head">
        <div class="hint" id="hintBox">
- åªæœ‰ <b>admin</b> å¯ä»¥ç·¨è¼¯ï¼ˆæ–°å¢/åˆªé™¤/ä¿®æ”¹å‹¾é¸ï¼‰ã€‚
- æ¬Šé™æ§åˆ¶ï¼šbtn1ï½btn5 å°æ‡‰é¦–é  1ï½5 é¡†æŒ‰éˆ•æ˜¯å¦é¡¯ç¤ºï¼ˆç¬¬ 6 é¡†ã€Œç³»çµ±/æ¬Šé™ã€å›ºå®šåªæœ‰ admin é¡¯ç¤ºï¼‰ã€‚
- è‹¥ä½ åœ¨æ–°åˆ†é æ‰“é–‹æ­¤é ï¼Œç³»çµ±æœƒè‡ªå‹•å‘å·²ç™»å…¥åˆ†é ã€Œè©¢å•ç™»å…¥è€…ã€ä¸¦åŒæ­¥ï¼ˆä¸æ”¹ session è¦å‰‡ï¼‰ã€‚
        </div>
        <div class="status" id="statusBox"></div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:160px">ç”¨æˆ¶å</th>
              <th style="width:180px">å¯†ç¢¼</th>
              <th style="width:120px">æ¬Šé™ç´šåˆ¥</th>
              <th class="cell-center" style="width:90px">è‡»é¼ç®¡ç†</th>
              <th class="cell-center" style="width:90px">ç¼ºå¤±/å“è³ª</th>
              <th class="cell-center" style="width:90px">é›²ç«¯æª”æ¡ˆ</th>
              <th class="cell-center" style="width:90px">å·¥ç¨‹è³‡æ–™åº«</th>
              <th class="cell-center" style="width:90px">è³‡æ–™åº«</th>
              <th class="cell-center" style="width:110px">åˆªé™¤</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>

        <div class="readonly" id="readonlyBanner" style="display:none;"></div>
      </div>
    </div>
  </div>

  <!-- Token overlay -->
  <div class="token-overlay" id="tokenOverlay" aria-hidden="true">
    <div class="token-box">
      <div class="token-title">Dropbox Token è¨­å®šï¼ˆApp folderï¼‰</div>
      <div class="token-hint" id="tokenHint">
â‘  ä½ çš„ Dropbox å¸³è™Ÿï¼š<b>tasun_8@hotmail.com</b>
â‘¡ å»ºè­° scopes è‡³å°‘ï¼š
- files.content.write
- files.content.read
- files.metadata.read
â‘¢ App folder å¯«å…¥ä½ç½®ï¼š<b class="mono">/Tasun/æ¬Šé™</b>
ï¼ˆDropbox ç¶²ç«™ä¸Šçœ‹åˆ°ï¼š/Apps/&lt;Appå&gt;/Tasun/æ¬Šé™ï¼‰
      </div>

      <div style="margin-top:.15rem">
        <div style="font-size:.86rem; margin-bottom:.35rem; color: rgba(246,211,122,.80);">
          Apps å…§ã€ŒApp è³‡æ–™å¤¾åã€ï¼ˆ/Apps/é€™è£¡ï¼‰
        </div>
        <input class="token-input" id="appNameInput" type="text" placeholder="ä¾‹å¦‚ï¼šwutasun" />
      </div>

      <div style="margin-top:.65rem">
        <div style="font-size:.86rem; margin-bottom:.35rem; color: rgba(246,211,122,.80);">
          App keyï¼ˆç”¨ä¾†ç›´é” Permissions / Settingsï¼‰
        </div>
        <div class="token-row">
          <input class="token-input" id="appKeyInput" type="text" placeholder="è²¼ä¸Šï¼šç¶²å€ info/<é€™ä¸²>#settings çš„ <é€™ä¸²>" />
          <button class="btn ghost" id="btnOpenPerm" type="button">é–‹ Permissions</button>
          <button class="btn ghost" id="btnOpenSet" type="button">é–‹ Settings</button>
        </div>
      </div>

      <div style="margin-top:.65rem; font-size:.86rem; color: rgba(246,211,122,.80); margin-bottom:.35rem;">
        Access Tokenï¼ˆsl. é–‹é ­ï¼‰
      </div>
      <div class="token-row">
        <input class="token-input" id="tokenInput" type="password" placeholder="è²¼ä¸Š Access Tokenï¼ˆsl. é–‹é ­ï¼‰" />
        <button class="token-eye" id="tokenEyeBtn" type="button">ğŸ‘</button>
      </div>

      <div class="token-msg" id="tokenMsg"></div>

      <div class="token-actions">
        <button class="btn ghost" id="btnGuide" type="button">ä¸€æ­¥ä¸€æ­¥å°è¦½ï¼ˆè‡ªå‹•é–‹é€£çµï¼‰</button>
        <button class="btn ghost" id="btnCloseToken" type="button">é—œé–‰</button>
        <button class="btn" id="btnSaveToken" type="button">å„²å­˜ä¸¦æ¸¬è©¦</button>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // Keys & constants
    // ==========================
    const AUTH_KEY    = "tasunAuthTable_v1";
    const CURRENT_KEY = "tasunCurrentUser_v1"; // âœ… session è¦å‰‡ï¼šä½¿ç”¨ sessionStorage ç‚ºä¸»ï¼ˆç›¸å®¹èˆŠç‰ˆ localStorageï¼‰
    const EXPECT_EMAIL = "tasun_8@hotmail.com";

    // Dropbox localStorage keys
    const DBX_TOKEN_KEY   = "tasunDbxToken_v1";
    const DBX_FOLDER_KEY  = "tasunDbxFolder_v1";
    const DBX_APPNAME_KEY = "tasunDbxAppName_v1";
    const DBX_APPKEY_KEY  = "tasunDbxAppKey_v1";
    const CLOUD_META_KEY  = "tasunCloudUpdatedAt_v1";

    const DEFAULT_DBX_FOLDER = "/Tasun/æ¬Šé™";
    const DEFAULT_APP_NAME   = "wutasun";

    // Cross-tab bridge (session sync only)
    const AUTH_BRIDGE_CH = "tasunAuthBridge_v1";
    const TAB_ID_KEY = "tasunTabId_v1";
    const TAB_ID = (() => {
      let v = sessionStorage.getItem(TAB_ID_KEY);
      if(!v){
        v = "tab_" + Date.now() + "_" + Math.random().toString(16).slice(2);
        sessionStorage.setItem(TAB_ID_KEY, v);
      }
      return v;
    })();
    let bc = null, bcReady = false;

    // ==========================
    // UI refs
    // ==========================
    const tbody = document.getElementById("tbody");
    const statusBox = document.getElementById("statusBox");
    const pillUser = document.getElementById("pillUser");
    const pillCloud = document.getElementById("pillCloud");
    const readonlyBanner = document.getElementById("readonlyBanner");

    const btnBack = document.getElementById("btnBack");
    const btnToken = document.getElementById("btnToken");
    const btnOpenApps = document.getElementById("btnOpenApps");
    const btnCloudPull = document.getElementById("btnCloudPull");
    const btnCloudPush = document.getElementById("btnCloudPush");
    const btnAddRow = document.getElementById("btnAddRow");

    // Token overlay refs
    const tokenOverlay = document.getElementById("tokenOverlay");
    const appNameInput = document.getElementById("appNameInput");
    const appKeyInput  = document.getElementById("appKeyInput");
    const tokenInput   = document.getElementById("tokenInput");
    const tokenEyeBtn  = document.getElementById("tokenEyeBtn");
    const tokenMsg     = document.getElementById("tokenMsg");
    const btnOpenPerm  = document.getElementById("btnOpenPerm");
    const btnOpenSet   = document.getElementById("btnOpenSet");
    const btnGuide     = document.getElementById("btnGuide");
    const btnCloseToken= document.getElementById("btnCloseToken");
    const btnSaveToken = document.getElementById("btnSaveToken");

    // ==========================
    // helpers
    // ==========================
    function mapRole(v){
      const s = String(v ?? "").trim().toLowerCase();
      if(!s) return "";
      if(s==="admin") return "admin";
      if(s==="write" || s==="edit") return "write";
      if(s==="read"  || s==="view") return "read";
      if(s==="0") return "admin";
      if(s==="1") return "write";
      if(s==="2") return "read";
      return s;
    }
    function safeJsonParse(s, fallback){
      try{ return JSON.parse(s); }catch(e){ return fallback; }
    }
    function setStatus(msg, type=""){
      statusBox.className = "status" + (type ? (" " + type) : "");
      statusBox.textContent = msg || "";
    }

    // ==========================
    // session current user (compatible)
    // ==========================
    function getCurrentUser(){
      // âœ… sessionStorage first
      let cu = safeJsonParse(sessionStorage.getItem(CURRENT_KEY) || "null", null);
      if(!cu || typeof cu !== "object" || !String(cu.username||"").trim()){
        // âœ… compatibility: old version may store in localStorage (ç§»å…¥ sessionStorage å¾Œåˆªé™¤)
        const legacy = safeJsonParse(localStorage.getItem(CURRENT_KEY) || "null", null);
        if(legacy && typeof legacy==="object" && String(legacy.username||"").trim()){
          const fixed = {
            username: String(legacy.username||"").trim(),
            level: mapRole(legacy.level ?? legacy.role) || "read",
            role:  mapRole(legacy.level ?? legacy.role) || "read"
          };
          sessionStorage.setItem(CURRENT_KEY, JSON.stringify(fixed));
          try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}
          cu = fixed;
        }
      }
      if(!cu || typeof cu !== "object") return null;
      const username = String(cu.username||"").trim();
      if(!username) return null;
      const level = mapRole(cu.level ?? cu.role) || "read";
      const out = { username, level, role: level };
      sessionStorage.setItem(CURRENT_KEY, JSON.stringify(out));
      return out;
    }
    function bcPost(msg){
      if(!bcReady || !bc) return;
      try{ bc.postMessage({ ...msg, _from: TAB_ID, _ts: Date.now() }); }catch(e){}
    }
    function initAuthBridge(){
      if(typeof BroadcastChannel === "undefined") return;
      try{
        bc = new BroadcastChannel(AUTH_BRIDGE_CH);
        bcReady = true;
        bc.onmessage = async (ev)=>{
          const m = ev && ev.data ? ev.data : null;
          if(!m || m._from === TAB_ID) return;

          if(m.type === "who"){
            const cu = getCurrentUser();
            if(cu && cu.username){
              bcPost({ type:"login", user: cu, _replyTo: m._from });
            }
            return;
          }
          if(m.type === "login" && m.user && m.user.username){
            const u = m.user;
            sessionStorage.setItem(CURRENT_KEY, JSON.stringify({
              username: String(u.username||"").trim(),
              level: mapRole(u.level ?? u.role) || "read",
              role:  mapRole(u.level ?? u.role) || "read"
            }));
            // refresh UI
            await bootLoadAndRender();
            return;
          }
          if(m.type === "logout"){
            sessionStorage.removeItem(CURRENT_KEY);
            await bootLoadAndRender();
            return;
          }
        };
      }catch(e){
        bcReady = false; bc = null;
      }
    }

    // ==========================
    // auth table local
    // ==========================
    const BTN_COUNT = 5; // btn1~btn5
    function normalizeRow(row){
      const username = String(row?.username || "").trim();
      const password = String(row?.password || "");
      const level = mapRole(row?.level ?? row?.role) || "read";
      let buttons = [];
      if(Array.isArray(row?.buttons)) buttons = row.buttons.slice();
      else{
        // legacy btn1..btn5
        for(let i=1;i<=BTN_COUNT;i++){
          const k = "btn"+i;
          buttons.push(!!row?.[k]);
        }
      }
      const outButtons = [];
      for(let i=0;i<BTN_COUNT;i++) outButtons[i] = !!buttons[i];
      return { username, password, level, role: level, buttons: outButtons };
    }

    function defaultAuth(){
      return [
        { username:"alex",  password:"Tasun08040224", level:"admin", buttons:[true,true,true,true,true] },
        { username:"tasun", password:"tasun08040224", level:"write", buttons:[true,true,true,true,true] },
        { username:"wu",    password:"123456",        level:"read",  buttons:[false,false,false,false,true] }
      ].map(normalizeRow);
    }

    function loadAuth(){
      const raw = localStorage.getItem(AUTH_KEY);
      if(!raw){
        const d = defaultAuth();
        localStorage.setItem(AUTH_KEY, JSON.stringify(d));
        return d;
      }
      const arr = safeJsonParse(raw, null);
      if(!Array.isArray(arr) || !arr.length){
        const d = defaultAuth();
        localStorage.setItem(AUTH_KEY, JSON.stringify(d));
        return d;
      }
      const fixed = arr.map(normalizeRow).filter(r=>r.username);
      if(!fixed.length){
        const d = defaultAuth();
        localStorage.setItem(AUTH_KEY, JSON.stringify(d));
        return d;
      }
      localStorage.setItem(AUTH_KEY, JSON.stringify(fixed));
      return fixed;
    }

    function saveAuth(arr){
      localStorage.setItem(AUTH_KEY, JSON.stringify(arr.map(normalizeRow)));
    }

    // ==========================
    // Dropbox helpers
    // ==========================
    function getDbxToken(){ return String(localStorage.getItem(DBX_TOKEN_KEY)||"").trim(); }
    function setDbxToken(t){ localStorage.setItem(DBX_TOKEN_KEY, String(t||"").trim()); }
    function dbxEnabled(){ const t=getDbxToken(); return !!(t && t.length>20); }
    function dbxAuthHeader(){ return "Bearer " + getDbxToken(); }

    function getDbxFolder(){
      return String(localStorage.getItem(DBX_FOLDER_KEY) || DEFAULT_DBX_FOLDER).trim() || DEFAULT_DBX_FOLDER;
    }
    function getDbxAppName(){
      return String(localStorage.getItem(DBX_APPNAME_KEY) || DEFAULT_APP_NAME).trim() || DEFAULT_APP_NAME;
    }
    function setDbxAppName(v){
      localStorage.setItem(DBX_APPNAME_KEY, String(v||"").trim() || DEFAULT_APP_NAME);
    }
    function getDbxAppKey(){
      return String(localStorage.getItem(DBX_APPKEY_KEY) || "").trim();
    }
    function setDbxAppKey(v){
      localStorage.setItem(DBX_APPKEY_KEY, String(v||"").trim());
    }

    // âœ… FIXï¼šå…ˆç”¨è¼¸å…¥æ¡†çš„å€¼å¯«å…¥ï¼Œå†åˆ¤æ–·
    function syncAppKeyFromInput(){
      const v = String(appKeyInput?.value || "").trim();
      if(v) setDbxAppKey(v);
      return v || getDbxAppKey();
    }
    function jsonAscii(obj){
      return JSON.stringify(obj).replace(/[^\x00-\x7F]/g, (c)=>{
        const code = c.charCodeAt(0).toString(16).padStart(4,"0");
        return "\\u" + code;
      });
    }
    async function fetchWithTimeout(url, options={}, timeoutMs=15000){
      const ctrl = new AbortController();
      const id = setTimeout(()=> ctrl.abort(), timeoutMs);
      try{ return await fetch(url, { ...options, signal: ctrl.signal }); }
      finally{ clearTimeout(id); }
    }

    function dbxPathAuth(){ return `${getDbxFolder()}/tasunAuthTable_v1.json`; }
    function dbxPathMeta(){ return `${getDbxFolder()}/tasunCloudMeta_v1.json`; }

    function dropboxWebFolderUrl(){
      const appName = encodeURIComponent(getDbxAppName());
      // show in Dropbox web UI
      return `https://www.dropbox.com/home/Apps/${appName}${getDbxFolder()}`;
    }

    function getConsoleBaseUrl(){
      const k = syncAppKeyFromInput(); // âœ… FIX
      return k ? `https://www.dropbox.com/developers/apps/info/${encodeURIComponent(k)}` : "";
    }
    function getConsolePermUrl(){ const b=getConsoleBaseUrl(); return b ? (b + "#permissions") : ""; }
    function getConsoleSetUrl(){  const b=getConsoleBaseUrl(); return b ? (b + "#settings") : ""; }

    function openConsoleTab(url, label){
      syncAppKeyFromInput(); // âœ… FIXï¼šæŒ‰å‰åŒæ­¥ä¸€æ¬¡
      if(!url){
        alert(`ä½ ç›®å‰é‚„æ²’å¡« App keyï¼Œç„¡æ³•ç›´é” ${label}ã€‚\n\nè«‹åœ¨æœ¬è¦–çª—ã€ŒApp keyã€è²¼ä¸Šï¼šç¶²å€ info/<App key>#settings é‚£ä¸²ã€‚`);
        return false;
      }
      const w = window.open(url, "_blank", "noopener");
      if(!w){
        alert("ç€è¦½å™¨å°é–å½ˆå‡ºè¦–çª—ã€‚\nè«‹å…è¨±æ­¤ç¶²ç«™é–‹æ–°åˆ†é å¾Œå†è©¦ä¸€æ¬¡ã€‚");
        return false;
      }
      return true;
    }

    async function testTokenAndGetEmail(){
      if(!dbxEnabled()) return { ok:false, status:0, msg:"âŒ Token æœªè¨­å®š", email:"" };
      try{
        const res = await fetchWithTimeout("https://api.dropboxapi.com/2/users/get_current_account", {
          method:"POST",
          cache:"no-store",
          headers:{ "Authorization": dbxAuthHeader(), "Content-Type":"application/json" },
          body: "null"
        }, 15000);

        const txt = await res.text();
        const json = safeJsonParse(txt, null);
        if(!res.ok){
          return { ok:false, status:res.status, msg:`âŒ Token ç„¡æ•ˆæˆ–éæœŸï¼ˆHTTP ${res.status}ï¼‰\n${txt}`, email:"" };
        }
        const email = String(json && json.email ? json.email : "");
        return { ok:true, status:200, msg:`âœ… Token OK\nå°æ‡‰å¸³è™Ÿï¼š${email || "(æœªå›å‚³ email)"}`, email };
      }catch(e){
        return { ok:false, status:0, msg:"âŒ Token æ¸¬è©¦å¤±æ•—ï¼ˆå¯èƒ½ç¶²è·¯/é€¾æ™‚/è¢«é˜»æ“‹ï¼‰", email:"" };
      }
    }

    async function ensureFolder(){
      try{
        const res = await fetchWithTimeout("https://api.dropboxapi.com/2/files/create_folder_v2", {
          method:"POST",
          cache:"no-store",
          headers:{ "Authorization": dbxAuthHeader(), "Content-Type":"application/json" },
          body: JSON.stringify({ path: getDbxFolder(), autorename:false })
        }, 15000);

        const txt = await res.text();
        if(res.ok) return { ok:true, msg:"âœ… è³‡æ–™å¤¾å·²å»ºç«‹/ç¢ºèª" };

        if(res.status === 409 && (txt || "").toLowerCase().includes("conflict")){
          return { ok:true, msg:"âœ… è³‡æ–™å¤¾å·²å­˜åœ¨" };
        }
        return { ok:false, msg:`âŒ å»ºç«‹è³‡æ–™å¤¾å¤±æ•—ï¼ˆHTTP ${res.status}ï¼‰\n${txt}` };
      }catch(e){
        return { ok:false, msg:"âŒ å»ºç«‹è³‡æ–™å¤¾å¤±æ•—ï¼ˆé€¾æ™‚/ç¶²è·¯ï¼‰" };
      }
    }

    async function dbxDownloadJson(path){
      if(!dbxEnabled()) return null;
      try{
        const res = await fetchWithTimeout("https://content.dropboxapi.com/2/files/download", {
          method:"POST",
          cache:"no-store",
          headers:{
            "Authorization": dbxAuthHeader(),
            "Dropbox-API-Arg": jsonAscii({ path })
          }
        }, 15000);
        if(!res.ok) return null;
        const text = await res.text();
        return safeJsonParse(text, null);
      }catch(e){ return null; }
    }

    async function dbxUploadJson(path, dataObj){
      const content = JSON.stringify(dataObj, null, 2);
      const arg = {
        path,
        mode:"overwrite",
        autorename:false,
        mute:true,
        strict_conflict:false
      };
      const res = await fetchWithTimeout("https://content.dropboxapi.com/2/files/upload", {
        method:"POST",
        cache:"no-store",
        headers:{
          "Authorization": dbxAuthHeader(),
          "Content-Type":"application/octet-stream",
          "Dropbox-API-Arg": jsonAscii(arg)
        },
        body: content
      }, 20000);
      const txt = await res.text();
      if(!res.ok){
        return { ok:false, msg:`âŒ ä¸Šå‚³å¤±æ•—ï¼ˆHTTP ${res.status}ï¼‰\n${txt}` };
      }
      return { ok:true, msg:"âœ… ä¸Šå‚³æˆåŠŸ" };
    }

    function getLocalUpdatedAt(){
      const v = Number(localStorage.getItem(CLOUD_META_KEY) || "0");
      return isFinite(v) ? v : 0;
    }
    function setLocalUpdatedAt(ts){
      localStorage.setItem(CLOUD_META_KEY, String(ts || 0));
    }

    // ==========================
    // UI render
    // ==========================
    let AUTH = [];
    let CURRENT = null;
    let IS_ADMIN = false;

    function render(){
      tbody.innerHTML = "";
      readonlyBanner.style.display = "none";

      // pills
      if(CURRENT && CURRENT.username){
        pillUser.textContent = `ç›®å‰ï¼š${CURRENT.username} (${CURRENT.level})`;
        if(CURRENT.level === "admin"){
          pillUser.innerHTML = `ç›®å‰ï¼š${CURRENT.username} (${CURRENT.level}) <span class="badge-admin">admin</span>`;
        }
      }else{
        pillUser.textContent = "ç›®å‰ï¼šæœªç™»å…¥";
      }

      pillCloud.textContent = dbxEnabled() ? "å·²è¨­å®š" : "æœªè¨­å®š";

      // controls
      btnAddRow.disabled   = !IS_ADMIN;
      btnCloudPush.disabled= !IS_ADMIN;
      btnCloudPull.disabled= false;

      if(!CURRENT || !CURRENT.username){
        readonlyBanner.style.display = "block";
        readonlyBanner.textContent =
`ä½ å°šæœªç™»å…¥ï¼ˆæˆ–æ­¤åˆ†é é‚„æ²’åŒæ­¥åˆ° sessionï¼‰ã€‚
è«‹å›é¦–é ç™»å…¥ï¼Œæˆ–åœ¨å¦ä¸€å€‹å·²ç™»å…¥åˆ†é æ‰“é–‹æœ¬é ï¼ˆæœƒè‡ªå‹•åŒæ­¥ç™»å…¥ï¼‰ã€‚`;
      }else if(!IS_ADMIN){
        readonlyBanner.style.display = "block";
        readonlyBanner.textContent =
`ä½ ç›®å‰æ˜¯ ${CURRENT.username}ï¼ˆ${CURRENT.level}ï¼‰ï¼Œåƒ…å¯æŸ¥çœ‹ã€‚\nåªæœ‰ admin å¯ä»¥æ–°å¢/åˆªé™¤/ä¿®æ”¹æ¬Šé™ã€‚`;
      }

      AUTH.forEach((row, idx)=>{
        const tr = document.createElement("tr");

        const tdU = document.createElement("td");
        const inU = document.createElement("input");
        inU.className="in";
        inU.value = row.username;
        inU.placeholder="username";
        inU.disabled = !IS_ADMIN;
        inU.addEventListener("input", ()=>{
          row.username = String(inU.value||"").trim();
          autosave("å·²å„²å­˜ï¼ˆç”¨æˆ¶åï¼‰");
        });
        tdU.appendChild(inU);

        const tdP = document.createElement("td");
        const inP = document.createElement("input");
        inP.className="in";
        inP.type="password";
        inP.value = row.password;
        inP.placeholder="password";
        inP.disabled = !IS_ADMIN;
        inP.addEventListener("input", ()=>{
          row.password = String(inP.value||"");
          autosave("å·²å„²å­˜ï¼ˆå¯†ç¢¼ï¼‰");
        });
        tdP.appendChild(inP);

        const tdL = document.createElement("td");
        const sel = document.createElement("select");
        sel.className="sel";
        ["admin","write","read"].forEach(v=>{
          const o=document.createElement("option");
          o.value=v; o.textContent=v;
          sel.appendChild(o);
        });
        sel.value = mapRole(row.level) || "read";
        sel.disabled = !IS_ADMIN;
        sel.addEventListener("change", ()=>{
          row.level = mapRole(sel.value) || "read";
          row.role  = row.level;
          autosave("å·²å„²å­˜ï¼ˆæ¬Šé™ï¼‰");
        });
        tdL.appendChild(sel);

        function tdBtn(i){
          const td = document.createElement("td");
          td.className="cell-center";
          const ck = document.createElement("input");
          ck.type="checkbox";
          ck.className="chk";
          ck.checked = !!row.buttons[i];
          ck.disabled = !IS_ADMIN;
          ck.addEventListener("change", ()=>{
            row.buttons[i] = !!ck.checked;
            autosave("å·²å„²å­˜ï¼ˆå‹¾é¸ï¼‰");
          });
          td.appendChild(ck);
          return td;
        }

        const tdDel = document.createElement("td");
        tdDel.className="cell-center";
        const bDel = document.createElement("button");
        bDel.className="btn danger";
        bDel.textContent="åˆªé™¤";
        bDel.disabled = !IS_ADMIN;
        bDel.addEventListener("click", ()=>{
          if(!IS_ADMIN) return;
          if(!confirm(`ç¢ºå®šåˆªé™¤å¸³è™Ÿï¼š${row.username || "(ç©ºç™½)"} ï¼Ÿ`)) return;
          AUTH.splice(idx, 1);
          saveAuth(AUTH);
          render();
          setStatus("å·²åˆªé™¤ä¸¦å„²å­˜", "");
        });
        tdDel.appendChild(bDel);

        tr.appendChild(tdU);
        tr.appendChild(tdP);
        tr.appendChild(tdL);
        tr.appendChild(tdBtn(0));
        tr.appendChild(tdBtn(1));
        tr.appendChild(tdBtn(2));
        tr.appendChild(tdBtn(3));
        tr.appendChild(tdBtn(4));
        tr.appendChild(tdDel);

        tbody.appendChild(tr);
      });
    }

    let saveTimer = null;
    function autosave(msg){
      if(!IS_ADMIN) return;
      if(saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(()=>{
        // clean empty usernames
        AUTH = AUTH.map(normalizeRow).filter(r=>r.username);
        saveAuth(AUTH);
        setStatus(msg || "å·²å„²å­˜", "");
        render(); // refresh indexes
      }, 280);
    }

    // ==========================
    // Token overlay
    // ==========================
    function showToken(){
      tokenOverlay.style.display="flex";
      tokenOverlay.setAttribute("aria-hidden","false");
      appNameInput.value = getDbxAppName();
      appKeyInput.value = getDbxAppKey();
      tokenInput.value  = getDbxToken();
      tokenMsg.textContent = `Dropbox ç¶²ç«™ä½ç½®ï¼ˆApp folderï¼‰ï¼š\n${dropboxWebFolderUrl()}`;
      setTimeout(()=> appNameInput?.focus(), 60);
    }
    function hideToken(){
      tokenOverlay.style.display="none";
      tokenOverlay.setAttribute("aria-hidden","true");
      tokenMsg.textContent="";
    }

    tokenEyeBtn.addEventListener("click", ()=>{
      tokenInput.type = (tokenInput.type==="password") ? "text" : "password";
    });

    btnOpenPerm.addEventListener("click", ()=>{
      syncAppKeyFromInput(); // âœ… FIX
      openConsoleTab(getConsolePermUrl(), "Permissions");
    });
    btnOpenSet.addEventListener("click", ()=>{
      syncAppKeyFromInput(); // âœ… FIX
      openConsoleTab(getConsoleSetUrl(), "Settings");
    });

    function guideToConsole(){
      // âœ… FIXï¼šæŒ‰ä¸‹å°è¦½æ™‚ï¼Œå…ˆæŠŠè¼¸å…¥æ¡† App key å­˜èµ·ä¾†
      const kNow = syncAppKeyFromInput();

      alert("æ¥ä¸‹ä¾†é€²å…¥ã€Œä¸€æ­¥ä¸€æ­¥å°è¦½ã€ã€‚\næœƒå˜—è©¦è‡ªå‹•é–‹ Permissions / Settingsã€‚\næŒ‰ã€Œç¢ºå®šã€é–‹å§‹ã€‚");

      if(!kNow){
        alert("ä½ ç›®å‰é‚„æ²’å¡« App keyï¼Œå› æ­¤ç„¡æ³•ç›´é” Permissions/Settingsã€‚\næˆ‘å…ˆå¹«ä½ é–‹ Apps åˆ—è¡¨ï¼šä½ é»é€² App å¾Œï¼Œçœ‹ç¶²å€ info/<é€™ä¸²>#settingsï¼ŒæŠŠ <é€™ä¸²> è²¼å›ä¾†ã€‚");
        window.open("https://www.dropbox.com/developers/apps", "_blank", "noopener");
        alert("æ­¥é©Ÿï¼š\n1) Apps åˆ—è¡¨ â†’ é»ä½ çš„ App\n2) ç¶²å€åƒï¼š.../apps/info/ã€a5pm08...ã€#settings\n3) è¤‡è£½ã€a5pm08...ã€è²¼å›æœ¬è¦–çª— App key\n4) å†æŒ‰ä¸€æ¬¡ã€Œä¸€æ­¥ä¸€æ­¥å°è¦½ã€ã€‚");
        return;
      }

      const okPerm = openConsoleTab(getConsolePermUrl(), "Permissions");
      if(okPerm){
        alert("æ­¥é©Ÿ 1ï¼ˆPermissionsï¼‰ï¼šè«‹å‹¾ scopesï¼ˆè‡³å°‘ï¼‰ï¼š\n- files.content.write\n- files.content.read\n- files.metadata.read\nï¼ˆå»ºè­°ä¹Ÿå‹¾ï¼šaccount_info.readï¼‰\nå‹¾å¥½å¾ŒæŒ‰ Submitã€‚");
      }

      const okSet = openConsoleTab(getConsoleSetUrl(), "Settings");
      if(okSet){
        alert("æ­¥é©Ÿ 2ï¼ˆSettingsï¼‰ï¼šè«‹é‡æ–°ç”¢ç”Ÿ Access Tokenï¼ˆGenerateï¼‰ã€‚\nâš ï¸ å‹¾å®Œ scope ä¸€å®šè¦æ–° token æ‰æœƒç”Ÿæ•ˆã€‚\nè¤‡è£½æ–° token â†’ å›æœ¬é  â†’ æŒ‰ã€Œå„²å­˜ä¸¦æ¸¬è©¦ã€ã€‚");
      }
    }
    btnGuide.addEventListener("click", guideToConsole);

    btnCloseToken.addEventListener("click", hideToken);

    btnSaveToken.addEventListener("click", async ()=>{
      const appName = String(appNameInput.value||"").trim() || DEFAULT_APP_NAME;
      setDbxAppName(appName);

      // âœ… FIXï¼šæŒ‰å„²å­˜ä¹ŸåŒæ­¥ App keyï¼ˆä»¥è¼¸å…¥æ¡†ç‚ºæº–ï¼‰
      syncAppKeyFromInput();

      const t = String(tokenInput.value||"").trim();
      if(!t){
        tokenMsg.textContent = "è«‹å…ˆè²¼ä¸Š Access Tokenã€‚";
        return;
      }
      setDbxToken(t);
      pillCloud.textContent = "æ¸¬è©¦ä¸­â€¦";

      tokenMsg.textContent = "æ­£åœ¨æ¸¬è©¦ Tokenâ€¦";
      const chk = await testTokenAndGetEmail();
      if(!chk.ok){
        tokenMsg.textContent = chk.msg + "\n\nè‹¥ scopes ä¸è¶³ï¼ŒæŒ‰ã€Œä¸€æ­¥ä¸€æ­¥å°è¦½ã€ã€‚";
        pillCloud.textContent = "æœªè¨­å®š";
        return;
      }

      let emailHint = "";
      if(chk.email && chk.email.toLowerCase() !== EXPECT_EMAIL.toLowerCase()){
        emailHint = `\nâš ï¸ é€™å€‹ token å°æ‡‰ emailï¼š${chk.email}\nä½ æœŸæœ›ï¼š${EXPECT_EMAIL}\nï¼ˆå¯èƒ½ç”¨ä¸åŒ Dropbox å¸³è™Ÿç”¢ç”Ÿ tokenï¼‰`;
      }else if(chk.email){
        emailHint = `\nâœ… token å°æ‡‰ emailï¼š${chk.email}`;
      }

      tokenMsg.textContent = chk.msg + emailHint + "\n\næ­£åœ¨æ¸¬è©¦å»ºç«‹è³‡æ–™å¤¾â€¦";
      const folderChk = await ensureFolder();
      if(!folderChk.ok){
        tokenMsg.textContent =
          chk.msg + emailHint + "\n\n" + folderChk.msg +
          "\n\nâœ… è‹¥è¨Šæ¯åŒ…å« missing_scope / files.content.writeï¼Œè«‹åˆ° Console å‹¾æ¬Šé™ä¸¦é‡æ–°ç”¢ç”Ÿæ–° tokenã€‚";
        pillCloud.textContent = "æœªè¨­å®š";
        return;
      }

      tokenMsg.textContent =
`${chk.msg}${emailHint}
${folderChk.msg}

Dropbox ç¶²ç«™ä½ç½®ï¼ˆApp folderï¼‰ï¼š
${dropboxWebFolderUrl()}

âœ… Token OKï¼Œå·²å¯åŒæ­¥ã€‚`;

      pillCloud.textContent = "å·²è¨­å®š";
      setTimeout(()=> hideToken(), 650);
    });

    // ==========================
    // Cloud sync
    // ==========================
    async function cloudPull(force=false){
      if(!dbxEnabled()){
        setStatus("å°šæœªè¨­å®š Dropbox Tokenï¼ˆå…ˆæŒ‰ï¼šè¨­å®š Tokenï¼‰", "warn");
        showToken();
        return false;
      }
      setStatus("å¾é›²ç«¯ä¸‹è¼‰ä¸­â€¦", "");
      const meta = await dbxDownloadJson(dbxPathMeta());
      const cloudTs = Number(meta && meta.updatedAt ? meta.updatedAt : 0);
      const localTs = getLocalUpdatedAt();
      if(!force && cloudTs && localTs && cloudTs <= localTs){
        setStatus("é›²ç«¯æ²’æœ‰æ›´æ–°ï¼ˆå·²æ˜¯æœ€æ–°ï¼‰", "");
        return true;
      }

      const auth = await dbxDownloadJson(dbxPathAuth());
      if(auth && Array.isArray(auth) && auth.length){
        const fixed = auth.map(normalizeRow).filter(r=>r.username);
        localStorage.setItem(AUTH_KEY, JSON.stringify(fixed));
        AUTH = fixed;
        if(cloudTs) setLocalUpdatedAt(cloudTs);
        setStatus("âœ… å·²å¾é›²ç«¯ä¸‹è¼‰ä¸¦å¥—ç”¨", "");
        render();
        return true;
      }

      setStatus("âš ï¸ é›²ç«¯æ²’æœ‰æ‰¾åˆ°æ¬Šé™æª”ï¼ˆæˆ–å°šæœªä¸Šå‚³éï¼‰", "warn");
      return false;
    }

    async function cloudPush(){
      if(!IS_ADMIN){
        setStatus("åªæœ‰ admin å¯ä»¥æ‰‹å‹•åŒæ­¥ä¸Šå‚³", "warn");
        return false;
      }
      if(!dbxEnabled()){
        setStatus("å°šæœªè¨­å®š Dropbox Tokenï¼ˆå…ˆæŒ‰ï¼šè¨­å®š Tokenï¼‰", "warn");
        showToken();
        return false;
      }
      setStatus("åŒæ­¥ä¸Šå‚³ä¸­â€¦", "");
      const chk = await testTokenAndGetEmail();
      if(!chk.ok){
        setStatus(chk.msg, "err");
        return false;
      }
      const folderChk = await ensureFolder();
      if(!folderChk.ok){
        setStatus(folderChk.msg, "err");
        return false;
      }

      // save local first
      AUTH = AUTH.map(normalizeRow).filter(r=>r.username);
      saveAuth(AUTH);

      const ts = Date.now();
      const up1 = await dbxUploadJson(dbxPathAuth(), AUTH);
      if(!up1.ok){
        setStatus(up1.msg, "err");
        return false;
      }
      const up2 = await dbxUploadJson(dbxPathMeta(), { updatedAt: ts, by: CURRENT?.username || "" });
      if(!up2.ok){
        setStatus(up2.msg, "err");
        return false;
      }

      setLocalUpdatedAt(ts);
      setStatus("âœ… åŒæ­¥å®Œæˆï¼ˆå·²ä¸Šå‚³é›²ç«¯ï¼‰", "");
      return true;
    }

    // ==========================
    // Boot & permission check
    // ==========================
    async function bootLoadAndRender(){
      AUTH = loadAuth();

      CURRENT = getCurrentUser();
      IS_ADMIN = !!(CURRENT && mapRole(CURRENT.level) === "admin");

      render();

      // admin-only buttons
      btnAddRow.disabled = !IS_ADMIN;
      btnCloudPush.disabled = !IS_ADMIN;

      if(!CURRENT){
        setStatus("æœªç™»å…¥ï¼ˆæ­£åœ¨å‘å…¶ä»–åˆ†é è©¢å•ç™»å…¥è€…â€¦ï¼‰", "warn");
        bcPost({ type:"who" }); // ask other tabs
      }else{
        setStatus(IS_ADMIN ? "å·²ç™»å…¥ï¼ˆadmin å¯ç·¨è¼¯ï¼‰" : "å·²ç™»å…¥ï¼ˆåƒ…å¯æŸ¥çœ‹ï¼‰", "");
      }
    }

    // ==========================
    // Event bindings
    // ==========================
    btnBack.addEventListener("click", ()=> location.href = "index.html");
    btnToken.addEventListener("click", showToken);

    btnOpenApps.addEventListener("click", ()=>{
      // open Dropbox web folder
      const url = dropboxWebFolderUrl();
      const w = window.open(url, "_blank", "noopener");
      if(!w) alert("ç€è¦½å™¨å°é–å½ˆå‡ºè¦–çª—ã€‚\nè«‹å…è¨±æ­¤ç¶²ç«™é–‹æ–°åˆ†é å¾Œå†è©¦ä¸€æ¬¡ã€‚");
    });

    btnCloudPull.addEventListener("click", ()=> cloudPull(true));
    btnCloudPush.addEventListener("click", ()=> cloudPush());

    btnAddRow.addEventListener("click", ()=>{
      if(!IS_ADMIN){
        setStatus("åªæœ‰ admin å¯ä»¥æ–°å¢", "warn");
        return;
      }
      AUTH.push(normalizeRow({
        username: "JOYCE",
        password: "123456",
        level: "read",
        buttons: [false,false,false,false,true]
      }));
      saveAuth(AUTH);
      render();
      setStatus("å·²æ–°å¢ä¸€åˆ—ï¼ˆè«‹ä¿®æ”¹å¾Œè‡ªå‹•å„²å­˜ï¼‰", "");
    });

    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        if(tokenOverlay.style.display==="flex") hideToken();
      }
    });

    // ==========================
    // start
    // ==========================
    (async function start(){
      // âœ… æ¸…æ‰èˆŠç‰ˆ localStorage çš„ CURRENT_KEYï¼ˆé¿å…ç ´å£ session è¦å‰‡ï¼‰
      try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}

      initAuthBridge();
      await bootLoadAndRender();

      // cloud status pill
      pillCloud.textContent = dbxEnabled() ? "å·²è¨­å®š" : "æœªè¨­å®š";
    })();
  </script>
</body>
</html>
