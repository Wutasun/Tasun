<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tasun æ¬Šé™è¡¨</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --gold:#f6d37a;
      --gold-soft:rgba(246,211,122,.78);
      --panel-border:rgba(246,211,122,.35);
      --bg:#050302;

      --frame-inset:clamp(.6rem, 1.2vw, 1.2rem);
      --shadow:0 14px 26px rgba(0,0,0,.92);

      --btn-h:40px;
      --btn-pad:0 .95rem;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      font-family:"Noto Serif TC","Microsoft JhengHei",serif;
      background:
        radial-gradient(circle at 10% 0%, rgba(252,211,77,0.12) 0, transparent 45%),
        radial-gradient(circle at 90% 90%, rgba(251,191,36,0.14) 0, transparent 52%),
        linear-gradient(to bottom, rgba(0,0,0,.92), rgba(0,0,0,.78) 45%, rgba(0,0,0,.92));
      color:var(--gold);
      overflow-x:hidden;
    }

    /* âœ… æ•´é èå…¥åº•åœ– */
    .page{
      position:relative;
      width:min(1400px, 100%);
      margin:0 auto;
      padding:calc(var(--frame-inset) + 52px) var(--frame-inset) 1.2rem;
      isolation:isolate;
    }
    .page::before{
      content:"";
      position:fixed;inset:0;
      pointer-events:none;
      background:
        radial-gradient(circle at 50% 16%, rgba(255,244,210,.12), rgba(255,244,210,0) 60%),
        radial-gradient(ellipse at 50% 85%, rgba(255,255,255,.06), rgba(255,255,255,0) 70%);
      z-index:-5;
    }

    /* ======= Top bar (desktop) ======= */
    .topbar{
      position:fixed;
      left:0; right:0; top:0;
      z-index:50;
      display:flex;
      justify-content:center;
      pointer-events:none;
    }
    .topbar-inner{
      width:min(1400px, 100%);
      padding:.55rem var(--frame-inset);
      display:flex;
      align-items:center;
      gap:.6rem;
      pointer-events:auto;
    }

    .pill, .btn{
      border-radius:999px;
      border:1px solid rgba(246,211,122,.55);
      background:radial-gradient(circle at 0% 0%, rgba(246,211,122,.18), rgba(0,0,0,.88));
      box-shadow:0 4px 10px rgba(0,0,0,.75), 0 0 10px rgba(246,211,122,.16);
      color:var(--gold);
      height:var(--btn-h);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:var(--btn-pad);
      font-size:.86rem;
      letter-spacing:.10em;
      text-indent:.10em;
      white-space:nowrap;
    }
    .pill{opacity:.90}
    .btn{
      cursor:pointer;
      border-color:rgba(246,211,122,.68);
      background:radial-gradient(circle at 0% 0%, rgba(246,211,122,.22), rgba(0,0,0,.92));
      transition:transform .15s ease, box-shadow .2s ease, background .2s ease, opacity .2s ease;
      opacity:.92;
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 10px 18px rgba(0,0,0,.86), 0 0 14px rgba(246,211,122,.25);
      background:radial-gradient(circle at 0% 0%, rgba(255,244,208,.28), rgba(0,0,0,.92));
      opacity:.98;
    }
    .btn:active{transform:translateY(0)}

    .spacer{flex:1}
    .cluster{display:flex; gap:.55rem; flex-wrap:wrap}

    /* ======= Mobile bar (è¿”å› / æ›´å¤š) ======= */
    .mbar{
      display:none;
      position:fixed;
      left:0; right:0; top:0;
      z-index:60;
      padding:.55rem var(--frame-inset);
    }
    .mbar-row{
      display:flex; gap:.6rem; align-items:center;
    }
    .mbar .pill{flex:1}
    .mbar .btn{flex:0 0 auto}

    .more-wrap{position:relative}
    .more-menu{
      position:absolute;
      right:0; top:calc(100% + 10px);
      width:min(280px, 80vw);
      border-radius:16px;
      border:1px solid rgba(246,211,122,.35);
      background:rgba(0,0,0,.92);
      box-shadow:0 16px 28px rgba(0,0,0,.88), 0 0 18px rgba(246,211,122,.14);
      overflow:hidden;
      display:none;
    }
    .more-menu button{
      width:100%;
      background:transparent;
      border:none;
      color:var(--gold);
      padding:.75rem .95rem;
      text-align:left;
      cursor:pointer;
      font-size:.92rem;
      letter-spacing:.08em;
    }
    .more-menu button:hover{
      background:rgba(246,211,122,.10);
    }

    @media (max-width: 900px){
      .topbar{display:none}
      .mbar{display:block}
      .page{padding-top:calc(var(--frame-inset) + 92px)}
    }

    /* ======= Card ======= */
    .card{
      margin-top:.9rem;
      border-radius:22px;
      border:1px solid rgba(246,211,122,.22);
      background:
        radial-gradient(circle at 0% 0%, rgba(246,211,122,.18), rgba(0,0,0,.92));
      box-shadow:var(--shadow), 0 0 26px rgba(246,211,122,.10);
      overflow:hidden;
    }
    .card-head{
      padding:1.25rem 1.25rem .9rem;
      border-bottom:1px solid rgba(246,211,122,.22);
    }
    .card-title{
      font-size:2.0rem;
      letter-spacing:.26em;
      text-indent:.26em;
      color:rgba(246,211,122,.92);
      text-shadow:0 0 16px rgba(246,211,122,.55), 0 10px 20px rgba(0,0,0,.85);
    }
    .card-sub{
      margin-top:.45rem;
      color:rgba(246,211,122,.72);
      line-height:1.8;
      font-size:1.02rem;
    }
    .card-sub b{color:rgba(255,244,210,.92)}
    .hint{
      margin-top:.25rem;
      color:rgba(246,211,122,.68);
      font-size:.95rem;
    }

    .status-row{
      padding:.85rem 1.25rem;
      display:flex;
      gap:.75rem;
      align-items:center;
      flex-wrap:wrap;
      border-top:1px solid rgba(246,211,122,.18);
      background:rgba(0,0,0,.10);
    }
    .status-pill{
      margin-left:auto;
      border-radius:999px;
      border:1px solid rgba(246,211,122,.35);
      background:rgba(0,0,0,.45);
      padding:.35rem .85rem;
      color:rgba(246,211,122,.85);
      font-size:.86rem;
      letter-spacing:.08em;
      text-indent:.08em;
    }

    /* ======= Desktop Table ======= */
    .table-wrap{
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      display:block;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:980px;
    }
    thead th{
      position:sticky;
      top:0;
      z-index:3;
      background:rgba(0,0,0,.72);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(246,211,122,.22);
      color:rgba(246,211,122,.86);
      font-weight:600;
      font-size:.95rem;
      letter-spacing:.08em;
      padding:.85rem .75rem;
      white-space:nowrap;
      text-align:center;
    }
    thead th:first-child{border-top-left-radius:18px}
    thead th:last-child{border-top-right-radius:18px}

    tbody td{
      border-bottom:1px solid rgba(246,211,122,.12);
      padding:.85rem .65rem;
      text-align:center;
      vertical-align:middle;
      background:rgba(0,0,0,.18);
    }
    tbody tr:hover td{background:rgba(246,211,122,.06)}

    /* input look */
    .in{
      width:100%;
      max-width:260px;
      padding:.42rem .7rem;
      border-radius:999px;
      border:1px solid rgba(246,211,122,.35);
      background:rgba(0,0,0,.74);
      color:var(--gold);
      outline:none;
      font-size:.92rem;
    }
    .in:focus{
      border-color:rgba(255,244,210,.85);
      box-shadow:0 0 12px rgba(246,211,122,.55);
    }

    .sel{
      width:100%;
      max-width:180px;
      padding:.42rem .7rem;
      border-radius:999px;
      border:1px solid rgba(246,211,122,.35);
      background:rgba(0,0,0,.78);
      color:var(--gold);
      outline:none;
      font-size:.92rem;
      cursor:pointer;
    }

    .chk{
      width:18px;height:18px;
      accent-color: var(--gold);
      cursor:pointer;
    }

    .td-del .btn-del{
      height:34px;
      padding:0 1.0rem;
      border-radius:999px;
      border:1px solid rgba(246,211,122,.55);
      background:rgba(0,0,0,.78);
      color:rgba(246,211,122,.88);
      cursor:pointer;
      box-shadow:0 6px 12px rgba(0,0,0,.75);
    }
    .td-del .btn-del:hover{ background:rgba(246,211,122,.12); }

    .muted{opacity:.55}

    /* Bottom actions */
    .actions{
      display:flex;
      gap:.75rem;
      align-items:center;
      flex-wrap:wrap;
      padding:1.0rem 1.25rem;
    }

    .msg{
      padding:0 1.25rem 1.0rem;
      color:rgba(255,200,200,.92);
      white-space:pre-line;
      min-height:1.4rem;
    }

    /* ======= âœ… Mobile Cards ======= */
    .cards-wrap{ display:none; padding:1rem 1rem .6rem; }
    @media (max-width: 900px){
      .table-wrap{ display:none; }
      .cards-wrap{ display:block; }
      .actions{ padding:1.0rem 1rem; }
      .msg{ padding:0 1rem 1.0rem; }
      .card-head{ padding:1.1rem 1rem .85rem; }
    }

    .mcard{
      border-radius:18px;
      border:1px solid rgba(246,211,122,.22);
      background:rgba(0,0,0,.22);
      box-shadow:0 10px 20px rgba(0,0,0,.72);
      overflow:hidden;
      margin-bottom:.85rem;
    }
    .mcard summary{
      list-style:none;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.6rem;
      padding:.85rem .9rem;
      background:
        radial-gradient(circle at 0% 0%, rgba(246,211,122,.14), rgba(0,0,0,.70));
      border-bottom:1px solid rgba(246,211,122,.14);
    }
    .mcard summary::-webkit-details-marker{ display:none; }

    .mcard-title{
      display:flex;
      flex-direction:column;
      gap:.25rem;
      min-width:0;
    }
    .mcard-title .u{
      font-size:1.05rem;
      letter-spacing:.08em;
      text-indent:.08em;
      color:rgba(255,244,210,.92);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:52vw;
    }
    .mcard-title .sub{
      font-size:.86rem;
      color:rgba(246,211,122,.72);
      letter-spacing:.06em;
      text-indent:.06em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:52vw;
    }
    .role-chip{
      border-radius:999px;
      border:1px solid rgba(246,211,122,.35);
      background:rgba(0,0,0,.55);
      padding:.25rem .65rem;
      font-size:.82rem;
      letter-spacing:.10em;
      text-indent:.10em;
      white-space:nowrap;
      color:rgba(246,211,122,.86);
      flex:0 0 auto;
    }
    .chev{
      width:34px;height:34px;
      border-radius:999px;
      border:1px solid rgba(246,211,122,.35);
      background:rgba(0,0,0,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      color:rgba(246,211,122,.9);
      flex:0 0 auto;
    }
    details[open] .chev{ transform:rotate(180deg); }

    .mcard-body{
      padding:.85rem .9rem .95rem;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:.35rem;
      margin-bottom:.75rem;
    }
    .label{
      font-size:.86rem;
      color:rgba(246,211,122,.75);
      letter-spacing:.08em;
      text-indent:.08em;
    }
    .row2{
      display:flex;
      gap:.6rem;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top:.2rem;
    }
    .mini{
      font-size:.82rem;
      color:rgba(246,211,122,.68);
      letter-spacing:.06em;
      text-indent:.06em;
    }

    /* âœ… æŒ‰éµæ¬„ä½æ©«å‘æ»‘å‹• */
    .btn-strip{
      display:flex;
      gap:.55rem;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding:.25rem .1rem .55rem;
      scrollbar-width:thin;
    }
    .btn-pill{
      flex:0 0 auto;
      display:flex;
      align-items:center;
      gap:.45rem;
      padding:.38rem .65rem;
      border-radius:999px;
      border:1px solid rgba(246,211,122,.28);
      background:rgba(0,0,0,.55);
      box-shadow:0 8px 14px rgba(0,0,0,.65);
    }
    .btn-pill .t{
      font-size:.86rem;
      letter-spacing:.06em;
      color:rgba(246,211,122,.88);
      max-width:40vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .btn-pill input{
      width:18px;height:18px;
      accent-color: var(--gold);
    }

    .danger-row{
      display:flex;
      gap:.6rem;
      align-items:center;
      justify-content:flex-end;
      margin-top:.6rem;
      flex-wrap:wrap;
    }
    .btn-del-m{
      height:36px;
      padding:0 1rem;
      border-radius:999px;
      border:1px solid rgba(246,211,122,.55);
      background:rgba(0,0,0,.78);
      color:rgba(246,211,122,.88);
      cursor:pointer;
      box-shadow:0 6px 12px rgba(0,0,0,.75);
    }
    .btn-del-m:hover{ background:rgba(246,211,122,.12); }

    /* Token overlay */
    .token-overlay{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      padding:18px;z-index:2000;
      background:radial-gradient(circle at 50% 18%, rgba(255,228,170,.32), rgba(0,0,0,.98));
    }
    .token-box{
      width:min(640px,94vw);
      padding:1.6rem 1.6rem 1.2rem;
      border-radius:18px;
      background:radial-gradient(circle at 0% 0%, rgba(246,211,122,.22), rgba(0,0,0,.95));
      border:1px solid rgba(246,211,122,.35);
      box-shadow:0 0 28px rgba(0,0,0,.92), 0 0 26px rgba(246,211,122,.18);
      color:var(--gold-soft);
    }
    .token-title{
      text-align:center;font-size:1.15rem;letter-spacing:.18em;text-indent:.18em;
      margin-bottom:.6rem;text-shadow:0 0 14px rgba(246,211,122,.55);
      color:rgba(246,211,122,.92);
    }
    .token-hint{
      font-size:.9rem;line-height:1.75;color:rgba(246,211,122,.78);
      margin-bottom:.8rem;white-space:pre-line;
    }
    .token-input{
      width:100%;
      padding:.55rem .7rem;border-radius:999px;
      border:1px solid rgba(246,211,122,.5);
      background:rgba(0,0,0,.82);color:var(--gold);outline:none;
    }
    .token-row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;margin-top:.55rem}
    .token-eye{
      padding:.26rem .75rem;border-radius:999px;
      border:1px solid rgba(246,211,122,.8);
      background:rgba(0,0,0,.86);color:var(--gold);
      cursor:pointer;box-shadow:0 0 8px rgba(0,0,0,.65);
      white-space:nowrap;
    }
    .token-actions{
      margin-top:.95rem;display:flex;justify-content:flex-end;gap:.55rem;flex-wrap:wrap;
    }
    .token-msg{
      margin-top:.65rem;min-height:1.2rem;font-size:.85rem;
      color:rgba(255,200,200,.95);text-align:left;white-space:pre-line;
    }
    .mini-pill{
      display:inline-block;padding:.2rem .6rem;border-radius:999px;
      border:1px solid rgba(246,211,122,.35);
      background:rgba(0,0,0,.55);
      color:rgba(246,211,122,.85);
      font-size:.82rem;margin-left:.35rem;
      letter-spacing:.06em;text-indent:.06em;
    }
    .mono{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      color:rgba(255,240,200,.96);
    }
  </style>
</head>

<body>
  <!-- Desktop topbar -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="pill" id="pillUser">ç›®å‰ä½¿ç”¨è€…ï¼šæœªç™»å…¥</div>
      <button class="btn" id="btnSwitch">åˆ‡æ›å¸³è™Ÿ</button>

      <div class="spacer"></div>

      <div class="cluster">
        <button class="btn" id="btnBack">è¿”å›é¦–é </button>
        <button class="btn" id="btnToken">è¨­å®š Token</button>
        <button class="btn" id="btnCloudDown">é›²ç«¯ä¸‹è¼‰</button>
        <button class="btn" id="btnCloudUp">å„²å­˜ä¸¦ä¸Šå‚³</button>
      </div>
    </div>
  </div>

  <!-- Mobile bar (è¿”å› / æ›´å¤š) -->
  <div class="mbar">
    <div class="mbar-row">
      <div class="pill" id="pillUserM">ç›®å‰ä½¿ç”¨è€…ï¼šæœªç™»å…¥</div>
      <button class="btn" id="btnBackM">è¿”å›</button>
      <div class="more-wrap">
        <button class="btn" id="btnMore">æ›´å¤š</button>
        <div class="more-menu" id="moreMenu" aria-hidden="true">
          <button type="button" id="mSwitch">åˆ‡æ›å¸³è™Ÿ</button>
          <button type="button" id="mToken">è¨­å®š Token</button>
          <button type="button" id="mDown">é›²ç«¯ä¸‹è¼‰</button>
          <button type="button" id="mUp">å„²å­˜ä¸¦ä¸Šå‚³</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Token overlay -->
  <div class="token-overlay" id="tokenOverlay" aria-hidden="true">
    <div class="token-box">
      <div class="token-title">Dropbox Token è¨­å®šï¼ˆApp folderï¼‰</div>
      <div class="token-hint" id="tokenHint">
â‘  ä½ çš„ Dropbox å¸³è™Ÿï¼š<b>tasun_8@hotmail.com</b>
â‘¡ ç”¢ç”Ÿ Tokenï¼šConsole â†’ Permissions å‹¾ scopes â†’ Submit â†’ Settings é‡æ–°ç”¢ç”Ÿ Access Token
â‘¢ æœ¬ç³»çµ±æœƒå¯«å…¥ï¼š<b class="mono">/Tasun/æ¬Šé™</b>ï¼ˆApp folder å…§ï¼‰ï¼Œç¶²ç«™çœ‹åˆ°ç‚ºï¼š/Apps/&lt;Appå&gt;/Tasun/æ¬Šé™
      </div>

      <div style="margin-top:.2rem;">
        <div style="font-size:.86rem; color:rgba(246,211,122,0.8); margin-bottom:.35rem;">
          Apps å…§ã€ŒApp è³‡æ–™å¤¾åã€<span class="mini-pill">ä¾‹å¦‚ï¼šwutasun</span>
        </div>
        <input class="token-input" id="appNameInput" type="text" placeholder="ä¾‹å¦‚ï¼šwutasun" />
      </div>

      <div style="margin-top:.65rem;">
        <div style="font-size:.86rem; color:rgba(246,211,122,0.8); margin-bottom:.35rem;">
          App keyï¼ˆç”¨ä¾†ç›´æ¥é–‹ Permissions / Settingsï¼‰<span class="mini-pill">ä¾‹å¦‚ï¼ša5pm08kyb0bybdt</span>
        </div>
        <div class="token-row">
          <input class="token-input" id="appKeyInput" type="text" placeholder="è²¼ä¸Š App keyï¼ˆinfo/<é€™ä¸²>#settingsï¼‰" />
          <button class="btn" id="btnOpenPerm" type="button">é–‹ Permissions</button>
          <button class="btn" id="btnOpenSet" type="button">é–‹ Settings</button>
        </div>
      </div>

      <div style="margin-top:.7rem; font-size:.86rem; color:rgba(246,211,122,0.8); margin-bottom:.35rem;">
        Access Tokenï¼ˆä»¥ sl. é–‹é ­ï¼‰
      </div>
      <div class="token-row">
        <input class="token-input" id="tokenInput" type="password" placeholder="è²¼ä¸Š Access Tokenï¼ˆsl. é–‹é ­ï¼‰" />
        <button class="token-eye" id="tokenEyeBtn" type="button">ğŸ‘</button>
      </div>

      <div class="token-msg" id="tokenMsg"></div>

      <div class="token-actions">
        <button class="btn" id="tokenGuideBtn" type="button">ä¸€æ­¥ä¸€æ­¥å°è¦½ï¼ˆè‡ªå‹•é–‹é€£çµï¼‰</button>
        <button class="btn" id="tokenSkipBtn" type="button">ç¨å¾Œï¼ˆåªç”¨æœ¬æ©Ÿï¼‰</button>
        <button class="btn" id="tokenSaveBtn" type="button">å„²å­˜ä¸¦æ¸¬è©¦</button>
      </div>
    </div>
  </div>

  <div class="page">
    <div class="card">
      <div class="card-head">
        <div class="card-title">Tasun æ¬Šé™è¡¨</div>
        <div class="card-sub">åªæœ‰ <b>admin</b> å¯ä»¥ç·¨è¼¯ï¼›å…¶ä»–æ¬Šé™åªèƒ½æŸ¥çœ‹ã€‚</div>
        <div class="hint" id="hintEdit">(å¯ç·¨è¼¯)</div>
      </div>

      <!-- Desktop table -->
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr id="theadRow"></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <!-- âœ… Mobile cards -->
      <div class="cards-wrap" id="cardsWrap"></div>

      <div class="actions">
        <button class="btn" id="btnAdd">ï¼‹ æ–°å¢ä¸€åˆ—</button>
        <button class="btn" id="btnSaveLocal">åªå„²å­˜æœ¬æ©Ÿ</button>
        <div class="status-pill" id="statusPill">ç‹€æ…‹ï¼šæœ¬æ©Ÿ</div>
      </div>

      <div class="msg" id="msg"></div>

      <div class="status-row">
        <span style="color:rgba(246,211,122,.75)">æç¤ºï¼šæŒ‰éµæ¬„ä½æ¨™é¡Œæœƒè‡ªå‹•æ”¹ç‚ºã€Œé¦–é æŒ‰éµåç¨±ã€ï¼Œä¸¦æœƒéš¨æŒ‰éµæ–°å¢/æ”¹åè‡ªå‹•åŒæ­¥ã€‚</span>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // keys (å›ºå®šæ²¿ç”¨ä½ çš„ç‰ˆæœ¬)
    // ==========================
    const AUTH_KEY    = "tasunAuthTable_v1";
    const CURRENT_KEY = "tasunCurrentUser_v1";
    const NAV_KEY     = "tasunNavButtons_v1";

    const DBX_TOKEN_KEY   = "tasunDbxToken_v1";
    const DBX_FOLDER_KEY  = "tasunDbxFolder_v1";
    const DBX_APPNAME_KEY = "tasunDbxAppName_v1";
    const DBX_APPKEY_KEY  = "tasunDbxAppKey_v1";

    const DEFAULT_DBX_FOLDER = "/Tasun/æ¬Šé™";
    const DEFAULT_APP_NAME = "wutasun";
    const EXPECT_EMAIL = "tasun_8@hotmail.com";

    // ==========================
    // refs
    // ==========================
    const pillUser   = document.getElementById("pillUser");
    const pillUserM  = document.getElementById("pillUserM");
    const hintEdit   = document.getElementById("hintEdit");
    const statusPill = document.getElementById("statusPill");
    const msg        = document.getElementById("msg");

    const btnBack    = document.getElementById("btnBack");
    const btnBackM   = document.getElementById("btnBackM");
    const btnSwitch  = document.getElementById("btnSwitch");

    const btnToken   = document.getElementById("btnToken");
    const btnCloudDown = document.getElementById("btnCloudDown");
    const btnCloudUp   = document.getElementById("btnCloudUp");

    const btnAdd     = document.getElementById("btnAdd");
    const btnSaveLocal = document.getElementById("btnSaveLocal");

    const theadRow   = document.getElementById("theadRow");
    const tbody      = document.getElementById("tbody");
    const cardsWrap  = document.getElementById("cardsWrap");

    // mobile menu
    const btnMore  = document.getElementById("btnMore");
    const moreMenu = document.getElementById("moreMenu");
    const mSwitch  = document.getElementById("mSwitch");
    const mToken   = document.getElementById("mToken");
    const mDown    = document.getElementById("mDown");
    const mUp      = document.getElementById("mUp");

    // token overlay
    const tokenOverlay = document.getElementById("tokenOverlay");
    const appNameInput = document.getElementById("appNameInput");
    const appKeyInput  = document.getElementById("appKeyInput");
    const tokenInput   = document.getElementById("tokenInput");
    const tokenMsg     = document.getElementById("tokenMsg");

    const tokenEyeBtn  = document.getElementById("tokenEyeBtn");
    const tokenSaveBtn = document.getElementById("tokenSaveBtn");
    const tokenSkipBtn = document.getElementById("tokenSkipBtn");
    const tokenGuideBtn= document.getElementById("tokenGuideBtn");
    const btnOpenPerm  = document.getElementById("btnOpenPerm");
    const btnOpenSet   = document.getElementById("btnOpenSet");

    // ==========================
    // helpers
    // ==========================
    function safeJsonParse(s, fallback){
      try{ return JSON.parse(s); }catch(e){ return fallback; }
    }
    function mapRole(v){
      const s = String(v ?? "").trim().toLowerCase();
      if(!s) return "";
      if(s==="admin") return "admin";
      if(s==="write" || s==="edit") return "write";
      if(s==="read"  || s==="view") return "read";
      if(s==="0") return "admin";
      if(s==="1") return "write";
      if(s==="2") return "read";
      return s;
    }

    // ==========================
    // current user / permission
    // ==========================
    function getCurrentUser(){
      const cu = safeJsonParse(sessionStorage.getItem(CURRENT_KEY) || "null", null);
      if(!cu || typeof cu !== "object") return null;
      const username = String(cu.username ?? "").trim();
      if(!username) return null;
      const role = mapRole(cu.role ?? cu.level) || "read";
      return { username, role, level: role };
    }

    function requireLogin(){
      const cu = getCurrentUser();
      if(!cu){
        alert("å°šæœªç™»å…¥ï¼Œå°‡è¿”å›é¦–é ç™»å…¥ã€‚");
        location.href = "index.html";
        return null;
      }
      pillUser.textContent  = `ç›®å‰ä½¿ç”¨è€…ï¼š${cu.username} (${cu.level})`;
      pillUserM.textContent = `ç›®å‰ä½¿ç”¨è€…ï¼š${cu.username} (${cu.level})`;
      return cu;
    }

    // ==========================
    // nav config (btn1/2/3 æ¨™é¡Œ = æŒ‰éµåç¨±)
    // ==========================
    const DEFAULT_NAV = [
      { id:"btn1", label:"è‡»é¼æ™‚ä»£å¤§å»ˆç®¡ç†è¡¨", href:"è‡»é¼ç®¡ç†è¡¨.html", target:"", roles:["admin","write","read"] },
      { id:"btn2", label:"ç¼ºå¤± / å“è³ª",       href:"ç”„é¼quality.html", target:"", roles:["admin","write","read"] },
      { id:"btn3", label:"é›²ç«¯æª”æ¡ˆ",          href:"https://www.dropbox.com/", target:"_blank", roles:["admin","write","read"] },
      { id:"btn4", label:"å·¥ç¨‹è³‡æ–™åº«",        href:"å·¥ç¨‹è³‡æ–™åº«.html", target:"", roles:["admin","write"] },
      { id:"btn5", label:"è³‡æ–™åº«",            href:"#", target:"", roles:["admin","write","read"] }
    ];

    function normalizeNavEntry(entry, idx){
      const base = DEFAULT_NAV[idx] || {};
      const label = (entry && entry.label ? String(entry.label).trim() : "") || base.label || `æŒ‰éµ${idx+1}`;
      const href  = (entry && entry.href  ? String(entry.href).trim()  : "") || base.href  || "#";
      const target= (entry && entry.target? String(entry.target).trim(): "") || base.target|| "";
      const roles = Array.isArray(entry && entry.roles) ? entry.roles.slice()
        : (Array.isArray(base.roles) ? base.roles.slice() : ["admin","write","read"]);
      return { id:`btn${idx+1}`, label, href, target, roles };
    }

    function loadNavConfig(){
      const raw = localStorage.getItem(NAV_KEY);
      if(!raw){
        localStorage.setItem(NAV_KEY, JSON.stringify(DEFAULT_NAV.slice()));
        return DEFAULT_NAV.slice();
      }
      const arr = safeJsonParse(raw, null);
      if(!Array.isArray(arr) || arr.length === 0){
        localStorage.setItem(NAV_KEY, JSON.stringify(DEFAULT_NAV.slice()));
        return DEFAULT_NAV.slice();
      }
      const fixed = arr.map((it, idx)=> normalizeNavEntry(it, idx));
      localStorage.setItem(NAV_KEY, JSON.stringify(fixed));
      return fixed;
    }

    // ==========================
    // auth table (æ”¯æ´èˆŠç‰ˆ btn1~btn5 â†’ buttons[])
    // ==========================
    const LEGACY_BUTTON_KEYS = ["btn1","btn2","btn3","btn4","btn5"];

    function makeButtonsAll(count){ return Array(count).fill(true); }
    function makeButtonsOnlyLast(count){
      const a = Array(count).fill(false);
      if(count>0) a[count-1]=true;
      return a;
    }
    function getDefaultAuthTable(btnCount){
      return [
        { username:"alex",  password:"Tasun08040224", level:"admin", role:"admin", buttons:makeButtonsAll(btnCount) },
        { username:"tasun", password:"tasun08040224", level:"write", role:"write", buttons:makeButtonsAll(btnCount) },
        { username:"wu",    password:"123456",        level:"read",  role:"read",  buttons:makeButtonsOnlyLast(btnCount) }
      ];
    }

    function normalizeRowFromStorage(row, btnCount){
      const username = String(row.username || "").trim();
      const password = String(row.password || "");
      const level = mapRole(row.level ?? row.role) || "read";

      let buttons = [];
      if(Array.isArray(row.buttons)) buttons = row.buttons.slice();
      else{
        const legacy = [];
        LEGACY_BUTTON_KEYS.forEach(k=>{
          if(Object.prototype.hasOwnProperty.call(row, k)) legacy.push(!!row[k]);
        });
        buttons = legacy;
      }

      const outButtons = [];
      for(let i=0;i<btnCount;i++) outButtons[i] = !!buttons[i];
      return { username, password, level, role: level, buttons: outButtons };
    }

    function loadAuthTable(btnCount){
      const raw = localStorage.getItem(AUTH_KEY);
      if(!raw){
        const defaults = getDefaultAuthTable(btnCount);
        localStorage.setItem(AUTH_KEY, JSON.stringify(defaults));
        return defaults.map(r=> normalizeRowFromStorage(r, btnCount));
      }
      const arr = safeJsonParse(raw, null);
      if(Array.isArray(arr) && arr.length){
        const fixed = arr.map(r => normalizeRowFromStorage(r, btnCount));
        localStorage.setItem(AUTH_KEY, JSON.stringify(fixed));
        return fixed;
      }
      const defaults = getDefaultAuthTable(btnCount);
      localStorage.setItem(AUTH_KEY, JSON.stringify(defaults));
      return defaults.map(r=> normalizeRowFromStorage(r, btnCount));
    }

    // ==========================
    // Dropbox helpersï¼ˆèˆ‡é¦–é ä¸€è‡´ï¼‰
    // ==========================
    function getDbxToken(){ return String(localStorage.getItem(DBX_TOKEN_KEY) || "").trim(); }
    function setDbxToken(t){ localStorage.setItem(DBX_TOKEN_KEY, String(t || "").trim()); }
    function dbxEnabled(){ const t=getDbxToken(); return !!(t && t.length>20); }
    function dbxAuthHeader(){ return "Bearer " + getDbxToken(); }

    function getDbxFolder(){
      return String(localStorage.getItem(DBX_FOLDER_KEY) || DEFAULT_DBX_FOLDER).trim() || DEFAULT_DBX_FOLDER;
    }
    function getDbxAppName(){
      return String(localStorage.getItem(DBX_APPNAME_KEY) || DEFAULT_APP_NAME).trim() || DEFAULT_APP_NAME;
    }
    function setDbxAppName(n){
      const v = String(n||"").trim() || DEFAULT_APP_NAME;
      localStorage.setItem(DBX_APPNAME_KEY, v);
    }
    function getDbxAppKey(){ return String(localStorage.getItem(DBX_APPKEY_KEY) || "").trim(); }
    function setDbxAppKey(k){ localStorage.setItem(DBX_APPKEY_KEY, String(k||"").trim()); }

    function dbxPathAuth(){ return `${getDbxFolder()}/tasunAuthTable_v1.json`; }
    function dbxPathNav(){  return `${getDbxFolder()}/tasunNavButtons_v1.json`; }
    function dbxPathMeta(){ return `${getDbxFolder()}/tasunCloudMeta_v1.json`; }

    function dropboxWebFolderUrl(){
      const appName = encodeURIComponent(getDbxAppName());
      return `https://www.dropbox.com/home/Apps/${appName}${getDbxFolder()}`;
    }

    function jsonAscii(obj){
      return JSON.stringify(obj).replace(/[^\x00-\x7F]/g, (c)=>{
        const code = c.charCodeAt(0).toString(16).padStart(4,"0");
        return "\\u" + code;
      });
    }

    async function fetchWithTimeout(url, options={}, timeoutMs=15000){
      const ctrl = new AbortController();
      const id = setTimeout(()=> ctrl.abort(), timeoutMs);
      try{
        return await fetch(url, { ...options, signal: ctrl.signal, cache:"no-store" });
      } finally {
        clearTimeout(id);
      }
    }

    async function dbxDownloadJson(path){
      if(!dbxEnabled()) return null;
      try{
        const res = await fetchWithTimeout("https://content.dropboxapi.com/2/files/download", {
          method:"POST",
          headers:{
            "Authorization": dbxAuthHeader(),
            "Dropbox-API-Arg": jsonAscii({ path })
          }
        }, 15000);
        if(!res.ok) return null;
        const text = await res.text();
        return safeJsonParse(text, null);
      }catch(e){
        return null;
      }
    }

    async function dbxUploadJson(path, dataObj){
      if(!dbxEnabled()) throw new Error("Token æœªè¨­å®š");
      const body = JSON.stringify(dataObj, null, 2);
      const res = await fetchWithTimeout("https://content.dropboxapi.com/2/files/upload", {
        method:"POST",
        headers:{
          "Authorization": dbxAuthHeader(),
          "Content-Type":"application/octet-stream",
          "Dropbox-API-Arg": jsonAscii({
            path,
            mode:"overwrite",
            autorename:false,
            mute:true,
            strict_conflict:false
          })
        },
        body
      }, 20000);
      const txt = await res.text();
      if(!res.ok) throw new Error(`ä¸Šå‚³å¤±æ•— HTTP ${res.status}\n${txt}`);
      return true;
    }

    async function ensureFolder(){
      const res = await fetchWithTimeout("https://api.dropboxapi.com/2/files/create_folder_v2", {
        method:"POST",
        headers:{
          "Authorization": dbxAuthHeader(),
          "Content-Type":"application/json"
        },
        body: JSON.stringify({ path: getDbxFolder(), autorename:false })
      }, 15000);

      const txt = await res.text();
      if(res.ok) return true;
      if(res.status===409 && (txt||"").toLowerCase().includes("conflict")) return true;
      throw new Error(`ç„¡æ³•å»ºç«‹/ç¢ºèªè³‡æ–™å¤¾ï¼ˆå¯èƒ½ scopes ä¸è¶³ï¼šfiles.content.writeï¼‰\nHTTP ${res.status}\n${txt}`);
    }

    function getLocalUpdatedAt(){
      const v = Number(localStorage.getItem("tasunCloudUpdatedAt_v1") || "0");
      return isFinite(v) ? v : 0;
    }
    function setLocalUpdatedAt(ts){
      localStorage.setItem("tasunCloudUpdatedAt_v1", String(ts||0));
    }

    async function cloudPullToLocal({ force=false }={}){
      if(!dbxEnabled()) return false;

      const meta = await dbxDownloadJson(dbxPathMeta());
      const cloudTs = Number(meta && meta.updatedAt ? meta.updatedAt : 0);
      const localTs = getLocalUpdatedAt();
      if(!force && cloudTs && localTs && cloudTs <= localTs) return false;

      const auth = await dbxDownloadJson(dbxPathAuth());
      const nav  = await dbxDownloadJson(dbxPathNav());

      let changed = false;

      if(nav && Array.isArray(nav) && nav.length){
        localStorage.setItem(NAV_KEY, JSON.stringify(nav));
        changed = true;
      }
      if(auth && Array.isArray(auth) && auth.length){
        const fixed = auth.map(r=>{
          const lv = mapRole(r?.level ?? r?.role) || "read";
          return { ...r, level: lv, role: lv };
        });
        localStorage.setItem(AUTH_KEY, JSON.stringify(fixed));
        changed = true;
      }

      if(cloudTs) setLocalUpdatedAt(cloudTs);
      return changed;
    }

    async function cloudPushFromLocal(){
      if(!dbxEnabled()) throw new Error("Token æœªè¨­å®š");
      await ensureFolder();

      const nav = safeJsonParse(localStorage.getItem(NAV_KEY) || "null", null) || loadNavConfig();
      const authRaw = safeJsonParse(localStorage.getItem(AUTH_KEY) || "null", null) || [];

      await dbxUploadJson(dbxPathNav(), nav);
      await dbxUploadJson(dbxPathAuth(), authRaw);

      const ts = Date.now();
      await dbxUploadJson(dbxPathMeta(), { updatedAt: ts, by: (getCurrentUser()?.username || "") });

      setLocalUpdatedAt(ts);
      return true;
    }

    // ==========================
    // Token overlay UI
    // ==========================
    function showTokenOverlay(){
      tokenOverlay.style.display = "flex";
      tokenOverlay.setAttribute("aria-hidden","false");
      appNameInput.value = getDbxAppName();
      appKeyInput.value  = getDbxAppKey();
      tokenInput.value   = getDbxToken();
      tokenMsg.textContent = `Dropbox ç¶²ç«™ä½ç½®ï¼ˆApp folderï¼‰ï¼š\n${dropboxWebFolderUrl()}`;
      setTimeout(()=> appNameInput.focus(), 60);
    }
    function hideTokenOverlay(){
      tokenOverlay.style.display = "none";
      tokenOverlay.setAttribute("aria-hidden","true");
      tokenMsg.textContent = "";
    }
    tokenEyeBtn.addEventListener("click", ()=>{
      tokenInput.type = (tokenInput.type==="password") ? "text" : "password";
    });
    tokenSkipBtn.addEventListener("click", hideTokenOverlay);

    function syncAppKeyFromInput(){
      const v = String(appKeyInput.value||"").trim();
      if(v) setDbxAppKey(v);
      return v || getDbxAppKey();
    }
    function getConsoleBaseUrl(){
      const k = syncAppKeyFromInput();
      return k ? `https://www.dropbox.com/developers/apps/info/${encodeURIComponent(k)}` : "";
    }
    function openConsole(url, label){
      if(!url){
        alert(`å°šæœªå¡« App keyï¼Œç„¡æ³•ç›´æ¥é–‹ ${label}ã€‚\n\nè«‹åœ¨æœ¬è¦–çª—ã€ŒApp keyã€è²¼ä¸Šï¼šç¶²å€ info/<App key>#settings é‚£ä¸²ã€‚`);
        return false;
      }
      const w = window.open(url, "_blank", "noopener");
      if(!w){
        alert("ç€è¦½å™¨å°é–å½ˆå‡ºè¦–çª—ã€‚\nè«‹å…è¨±æ­¤ç¶²ç«™é–‹æ–°åˆ†é å¾Œå†è©¦ä¸€æ¬¡ã€‚");
        return false;
      }
      return true;
    }
    btnOpenPerm.addEventListener("click", ()=>{
      const b = getConsoleBaseUrl();
      openConsole(b ? (b+"#permissions") : "", "Permissions");
    });
    btnOpenSet.addEventListener("click", ()=>{
      const b = getConsoleBaseUrl();
      openConsole(b ? (b+"#settings") : "", "Settings");
    });

    async function testTokenAndGetEmail(){
      if(!dbxEnabled()) return { ok:false, msg:"âŒ Token æœªè¨­å®š", email:"" };
      try{
        const res = await fetchWithTimeout("https://api.dropboxapi.com/2/users/get_current_account", {
          method:"POST",
          headers:{
            "Authorization": dbxAuthHeader(),
            "Content-Type":"application/json"
          },
          body:"null"
        }, 15000);

        const txt = await res.text();
        const json = safeJsonParse(txt, null);

        if(!res.ok){
          return { ok:false, msg:`âŒ Token ç„¡æ•ˆæˆ–éæœŸï¼ˆHTTP ${res.status}ï¼‰\n${txt}`, email:"" };
        }
        const email = String(json && json.email ? json.email : "");
        return { ok:true, msg:`âœ… Token OK\nå°æ‡‰å¸³è™Ÿï¼š${email || "(æœªå›å‚³ email)"}`, email };
      }catch(e){
        return { ok:false, msg:"âŒ Token æ¸¬è©¦å¤±æ•—ï¼ˆé€¾æ™‚/ç¶²è·¯ï¼‰", email:"" };
      }
    }

    function guideToConsole(){
      const kNow = syncAppKeyFromInput();
      alert("æœƒå˜—è©¦è‡ªå‹•é–‹ Permissions / Settingsã€‚\næŒ‰ã€Œç¢ºå®šã€é–‹å§‹ã€‚");
      if(!kNow){
        alert("ä½ é‚„æ²’å¡« App keyã€‚\næˆ‘å…ˆå¹«ä½ é–‹ Apps åˆ—è¡¨ï¼Œä½ é»é€² App å¾Œï¼ŒæŠŠç¶²å€ info/<é€™ä¸²>#settings çš„ <é€™ä¸²> è²¼å›ä¾†ã€‚");
        window.open("https://www.dropbox.com/developers/apps", "_blank", "noopener");
        return;
      }
      const base = getConsoleBaseUrl();
      if(openConsole(base+"#permissions","Permissions")){
        alert("è«‹å‹¾ scopesï¼ˆè‡³å°‘ï¼‰ï¼š\n- files.content.write\n- files.content.read\n- files.metadata.read\nå‹¾å¥½æŒ‰ Submitã€‚");
      }
      if(openConsole(base+"#settings","Settings")){
        alert("è«‹é‡æ–°ç”¢ç”Ÿ Access Tokenï¼ˆGenerateï¼‰ã€‚\nâš ï¸ å‹¾å®Œ scope ä¸€å®šè¦æ–° token æ‰æœƒç”Ÿæ•ˆã€‚");
      }
    }
    tokenGuideBtn.addEventListener("click", guideToConsole);

    tokenSaveBtn.addEventListener("click", async ()=>{
      const appName = String(appNameInput.value||"").trim() || DEFAULT_APP_NAME;
      setDbxAppName(appName);
      syncAppKeyFromInput();

      const t = String(tokenInput.value||"").trim();
      if(!t){
        tokenMsg.textContent = "è«‹å…ˆè²¼ä¸Š Access Tokenã€‚";
        return;
      }
      setDbxToken(t);

      tokenMsg.textContent = "æ­£åœ¨æ¸¬è©¦ Tokenâ€¦";
      const chk = await testTokenAndGetEmail();
      if(!chk.ok){
        tokenMsg.textContent = chk.msg + "\n\nè‹¥æ˜¯ scopes ä¸è¶³ï¼ŒæŒ‰ã€Œä¸€æ­¥ä¸€æ­¥å°è¦½ã€ã€‚";
        return;
      }

      let emailHint = "";
      if(chk.email && chk.email.toLowerCase() !== EXPECT_EMAIL.toLowerCase()){
        emailHint = `\nâš ï¸ é€™å€‹ token å°æ‡‰ emailï¼š${chk.email}\nä½ æœŸæœ›ï¼š${EXPECT_EMAIL}\nï¼ˆå¯èƒ½åœ¨ä¸åŒ Dropbox å¸³è™Ÿç”¢ç”Ÿ tokenï¼‰`;
      }else if(chk.email){
        emailHint = `\nâœ… token å°æ‡‰ emailï¼š${chk.email}`;
      }

      tokenMsg.textContent = chk.msg + emailHint + "\n\næ­£åœ¨æ¸¬è©¦å»ºç«‹è³‡æ–™å¤¾â€¦";
      try{
        await ensureFolder();
        tokenMsg.textContent =
`${chk.msg}${emailHint}

âœ… è³‡æ–™å¤¾å·²å»ºç«‹/ç¢ºèª
Dropbox ç¶²ç«™ä½ç½®ï¼ˆApp folderï¼‰ï¼š
${dropboxWebFolderUrl()}

âœ… Token OKï¼Œå·²å¯åŒæ­¥ã€‚`;
        setTimeout(hideTokenOverlay, 600);
        setStatusPill();
      }catch(err){
        tokenMsg.textContent = chk.msg + emailHint + "\n\n" + (err?.message || String(err));
      }
    });

    // ==========================
    // render (desktop table + mobile cards)
    // ==========================
    let NAV = [];
    let AUTH = [];
    let isAdmin = false;

    function setStatusPill(){
      statusPill.textContent = dbxEnabled() ? "ç‹€æ…‹ï¼šå·²è¨­å®š Tokenï¼ˆå¯åŒæ­¥ï¼‰" : "ç‹€æ…‹ï¼šæœªè¨­å®š Tokenï¼ˆåƒ…æœ¬æ©Ÿï¼‰";
    }

    function setEditableUI(){
      if(isAdmin){
        hintEdit.textContent = "(å¯ç·¨è¼¯)";
        hintEdit.style.color = "rgba(246,211,122,.78)";
      }else{
        hintEdit.textContent = "(åƒ…å¯æŸ¥çœ‹)";
        hintEdit.style.color = "rgba(246,211,122,.55)";
      }
    }

    function makeRoleSelect(value){
      const sel = document.createElement("select");
      sel.className = "sel";
      ["admin","write","read"].forEach(v=>{
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        sel.appendChild(opt);
      });
      sel.value = mapRole(value) || "read";
      return sel;
    }

    // --- desktop headers
    function renderHeaders(){
      theadRow.innerHTML = "";

      const thUser = document.createElement("th"); thUser.textContent = "ä½¿ç”¨è€…";
      const thPwd  = document.createElement("th"); thPwd.textContent  = "å¯†ç¢¼";
      const thRole = document.createElement("th"); thRole.textContent = "æ¬Šé™";
      theadRow.appendChild(thUser);
      theadRow.appendChild(thPwd);
      theadRow.appendChild(thRole);

      NAV.forEach((b)=>{
        const th = document.createElement("th");
        th.textContent = b.label || "æŒ‰éµ";
        th.title = b.label || "";
        theadRow.appendChild(th);
      });

      const thSys = document.createElement("th");
      thSys.textContent = "ç³»çµ±/æ¬Šé™";
      theadRow.appendChild(thSys);

      const thDel = document.createElement("th");
      thDel.textContent = "åˆªé™¤";
      theadRow.appendChild(thDel);
    }

    // --- desktop body
    function renderTableBody(){
      tbody.innerHTML = "";

      AUTH.forEach((row, rIdx)=>{
        const tr = document.createElement("tr");

        const tdU = document.createElement("td");
        const inU = document.createElement("input");
        inU.className = "in";
        inU.value = row.username || "";
        inU.placeholder = "username";
        tdU.appendChild(inU);
        tr.appendChild(tdU);

        const tdP = document.createElement("td");
        const inP = document.createElement("input");
        inP.className = "in";
        inP.value = row.password || "";
        inP.placeholder = "password";
        tdP.appendChild(inP);
        tr.appendChild(tdP);

        const tdR = document.createElement("td");
        const sel = makeRoleSelect(row.level);
        tdR.appendChild(sel);
        tr.appendChild(tdR);

        NAV.forEach((b, i)=>{
          const td = document.createElement("td");
          const ck = document.createElement("input");
          ck.type = "checkbox";
          ck.className = "chk";
          ck.checked = !!(row.buttons && row.buttons[i]);
          td.appendChild(ck);
          tr.appendChild(td);
        });

        const tdSys = document.createElement("td");
        const lv = mapRole(sel.value) || "read";
        tdSys.textContent = (lv === "admin") ? "âœ“" : "â€”";
        tdSys.className = (lv === "admin") ? "" : "muted";
        tr.appendChild(tdSys);

        sel.addEventListener("change", ()=>{
          const lv2 = mapRole(sel.value) || "read";
          tdSys.textContent = (lv2 === "admin") ? "âœ“" : "â€”";
          tdSys.className = (lv2 === "admin") ? "" : "muted";
        });

        const tdD = document.createElement("td");
        tdD.className = "td-del";
        const del = document.createElement("button");
        del.type = "button";
        del.className = "btn-del";
        del.textContent = "åˆªé™¤";
        del.addEventListener("click", ()=>{
          if(!isAdmin) return;
          if(confirm("ç¢ºå®šåˆªé™¤æ­¤åˆ—ï¼Ÿ")){
            AUTH.splice(rIdx,1);
            renderAll();
          }
        });
        tdD.appendChild(del);
        tr.appendChild(tdD);

        if(!isAdmin){
          inU.disabled = true;
          inP.disabled = true;
          sel.disabled = true;
          tr.querySelectorAll(".chk").forEach(x=> x.disabled = true);
          del.disabled = true;
          del.classList.add("muted");
        }

        function syncRow(){
          row.username = String(inU.value||"").trim();
          row.password = String(inP.value||"");
          row.level = mapRole(sel.value) || "read";
          row.role  = row.level;
          row.buttons = row.buttons || [];
          const cks = Array.from(tr.querySelectorAll("input.chk"));
          for(let i=0;i<NAV.length;i++){
            row.buttons[i] = !!(cks[i] && cks[i].checked);
          }
        }

        [inU,inP,sel].forEach(el=> el.addEventListener("input", syncRow));
        tr.querySelectorAll(".chk").forEach(el=> el.addEventListener("change", syncRow));

        tbody.appendChild(tr);
      });
    }

    // --- âœ… mobile cards
    function renderCards(){
      cardsWrap.innerHTML = "";

      AUTH.forEach((row, rIdx)=>{
        const details = document.createElement("details");
        details.className = "mcard";
        // é è¨­æ”¶åˆï¼ˆæ›´å¥½æ»‘ï¼‰
        details.open = false;

        const summary = document.createElement("summary");

        const left = document.createElement("div");
        left.className = "mcard-title";

        const u = document.createElement("div");
        u.className = "u";
        u.textContent = row.username ? row.username : "(æœªå‘½åä½¿ç”¨è€…)";
        left.appendChild(u);

        const sub = document.createElement("div");
        sub.className = "sub";
        sub.textContent = "é»é–‹å¯ç·¨è¼¯ / å‹¾é¸é¡¯ç¤ºæŒ‰éµ";
        left.appendChild(sub);

        const chip = document.createElement("div");
        chip.className = "role-chip";
        chip.textContent = mapRole(row.level) || "read";

        const chev = document.createElement("div");
        chev.className = "chev";
        chev.textContent = "âŒ„";

        summary.appendChild(left);
        summary.appendChild(chip);
        summary.appendChild(chev);

        const body = document.createElement("div");
        body.className = "mcard-body";

        // ä½¿ç”¨è€…
        const fU = document.createElement("div");
        fU.className = "field";
        fU.innerHTML = `<div class="label">ä½¿ç”¨è€…</div>`;
        const inU = document.createElement("input");
        inU.className = "in";
        inU.value = row.username || "";
        inU.placeholder = "username";
        fU.appendChild(inU);
        body.appendChild(fU);

        // å¯†ç¢¼
        const fP = document.createElement("div");
        fP.className = "field";
        fP.innerHTML = `<div class="label">å¯†ç¢¼</div>`;
        const inP = document.createElement("input");
        inP.className = "in";
        inP.value = row.password || "";
        inP.placeholder = "password";
        fP.appendChild(inP);
        body.appendChild(fP);

        // æ¬Šé™ + ç³»çµ±
        const fR = document.createElement("div");
        fR.className = "field";
        const labelR = document.createElement("div");
        labelR.className = "label";
        labelR.textContent = "æ¬Šé™";
        fR.appendChild(labelR);

        const row2 = document.createElement("div");
        row2.className = "row2";
        const sel = makeRoleSelect(row.level);
        sel.style.maxWidth = "220px";

        const sys = document.createElement("div");
        sys.className = "mini";
        const refreshSys = ()=>{
          const lv = mapRole(sel.value) || "read";
          chip.textContent = lv;
          sys.textContent = (lv === "admin") ? "ç³»çµ±/æ¬Šé™ï¼šâœ“ï¼ˆadminï¼‰" : "ç³»çµ±/æ¬Šé™ï¼šâ€”";
        };
        refreshSys();

        row2.appendChild(sel);
        row2.appendChild(sys);
        fR.appendChild(row2);
        body.appendChild(fR);

        sel.addEventListener("change", refreshSys);

        // âœ… æŒ‰éµæ©«å‘æ»‘å‹•
        const fB = document.createElement("div");
        fB.className = "field";
        fB.innerHTML = `<div class="label">é¦–é æŒ‰éµé¡¯ç¤ºï¼ˆå·¦å³æ»‘å‹•ï¼‰</div>`;
        const strip = document.createElement("div");
        strip.className = "btn-strip";

        const cks = [];
        NAV.forEach((b, i)=>{
          const pill = document.createElement("label");
          pill.className = "btn-pill";

          const ck = document.createElement("input");
          ck.type = "checkbox";
          ck.checked = !!(row.buttons && row.buttons[i]);

          const t = document.createElement("div");
          t.className = "t";
          t.textContent = b.label || `æŒ‰éµ${i+1}`;
          pill.title = t.textContent;

          pill.appendChild(ck);
          pill.appendChild(t);
          strip.appendChild(pill);
          cks.push(ck);

          ck.addEventListener("change", ()=> syncRow());
        });

        fB.appendChild(strip);
        body.appendChild(fB);

        // åˆªé™¤
        const danger = document.createElement("div");
        danger.className = "danger-row";
        const del = document.createElement("button");
        del.type = "button";
        del.className = "btn-del-m";
        del.textContent = "åˆªé™¤æ­¤åˆ—";
        del.addEventListener("click", ()=>{
          if(!isAdmin) return;
          if(confirm("ç¢ºå®šåˆªé™¤æ­¤åˆ—ï¼Ÿ")){
            AUTH.splice(rIdx,1);
            renderAll();
          }
        });
        danger.appendChild(del);
        body.appendChild(danger);

        // admin lock
        if(!isAdmin){
          inU.disabled = true;
          inP.disabled = true;
          sel.disabled = true;
          cks.forEach(x=> x.disabled = true);
          del.disabled = true;
          del.classList.add("muted");
          sub.textContent = "ï¼ˆä½ ç›®å‰ç‚ºé adminï¼šåƒ…å¯æŸ¥çœ‹ï¼‰";
        }

        // sync row data
        function syncRow(){
          row.username = String(inU.value||"").trim();
          row.password = String(inP.value||"");
          row.level = mapRole(sel.value) || "read";
          row.role  = row.level;
          row.buttons = row.buttons || [];
          for(let i=0;i<NAV.length;i++){
            row.buttons[i] = !!(cks[i] && cks[i].checked);
          }
          // æ›´æ–° summary é¡¯ç¤º
          u.textContent = row.username ? row.username : "(æœªå‘½åä½¿ç”¨è€…)";
          chip.textContent = row.level;
        }

        [inU,inP,sel].forEach(el=> el.addEventListener("input", syncRow));
        [inU,inP,sel].forEach(el=> el.addEventListener("change", syncRow));

        details.appendChild(summary);
        details.appendChild(body);
        cardsWrap.appendChild(details);
      });
    }

    function renderAll(){
      renderHeaders();
      renderTableBody();
      renderCards();
    }

    // âœ… æŒ‰éµæ•¸é‡/åç¨±è®Šå‹•æ™‚ï¼Œè‡ªå‹•åŒæ­¥
    function syncToNavShape(){
      NAV = loadNavConfig();
      const btnCount = NAV.length;
      AUTH = loadAuthTable(btnCount);

      AUTH = AUTH.map(r=> normalizeRowFromStorage(r, btnCount));
      localStorage.setItem(AUTH_KEY, JSON.stringify(AUTH));

      renderAll();
    }

    // ==========================
    // save / load
    // ==========================
    function saveLocal(){
      AUTH = AUTH.filter(r => String(r.username||"").trim().length > 0);
      localStorage.setItem(AUTH_KEY, JSON.stringify(AUTH));
      msg.textContent = "âœ… å·²å„²å­˜æœ¬æ©Ÿ";
    }

    // ==========================
    // cloud watchï¼ˆæ‰‹æ©Ÿ/æ¡Œæ©Ÿéƒ½æœƒåŒæ­¥åˆ·æ–°ï¼‰
    // ==========================
    const CLOUD_WATCH_MS = 4000;
    let cloudWatchTimer = null;
    let busy = false;

    async function syncNow({force=false}={}){
      if(busy) return;
      busy = true;
      try{
        if(dbxEnabled()){
          const changed = await cloudPullToLocal({ force });
          if(changed) msg.textContent = "âœ… å·²å¾é›²ç«¯æ›´æ–°åˆ°æœ¬æ©Ÿ";
        }
        syncToNavShape();
        setStatusPill();
      } finally {
        busy = false;
      }
    }

    function startCloudWatch(){
      if(cloudWatchTimer) clearInterval(cloudWatchTimer);
      cloudWatchTimer = setInterval(()=> syncNow({force:false}), CLOUD_WATCH_MS);

      document.addEventListener("visibilitychange", ()=>{
        if(!document.hidden) syncNow({force:false});
      });
    }

    // ==========================
    // events
    // ==========================
    btnBack.addEventListener("click", ()=> location.href="index.html");
    btnBackM.addEventListener("click", ()=> location.href="index.html");

    btnSwitch.addEventListener("click", ()=>{
      sessionStorage.removeItem(CURRENT_KEY);
      alert("å·²åˆ‡æ›å¸³è™Ÿï¼Œè¿”å›é¦–é é‡æ–°ç™»å…¥ã€‚");
      location.href="index.html";
    });

    btnToken.addEventListener("click", showTokenOverlay);

    btnCloudDown.addEventListener("click", async ()=>{
      if(!isAdmin) return;
      msg.textContent = "æ­£åœ¨é›²ç«¯ä¸‹è¼‰â€¦";
      await syncNow({force:true});
    });

    btnCloudUp.addEventListener("click", async ()=>{
      if(!isAdmin) return;
      msg.textContent = "æ­£åœ¨å„²å­˜ä¸¦ä¸Šå‚³â€¦";
      try{
        saveLocal();
        if(!dbxEnabled()){
          msg.textContent = "âœ… å·²å„²å­˜æœ¬æ©Ÿï¼ˆå°šæœªè¨­å®š Tokenï¼Œç„¡æ³•ä¸Šå‚³ï¼‰";
          return;
        }
        await cloudPushFromLocal();
        msg.textContent = "âœ… å·²ä¸Šå‚³é›²ç«¯ä¸¦å®ŒæˆåŒæ­¥";
        setStatusPill();
      }catch(err){
        msg.textContent = "âŒ ä¸Šå‚³å¤±æ•—ï¼ˆå¯èƒ½ scopes ä¸è¶³ï¼šfiles.content.writeï¼‰\n" + (err?.message || String(err));
      }
    });

    btnAdd.addEventListener("click", ()=>{
      if(!isAdmin) return;
      AUTH.push({
        username:"",
        password:"",
        level:"read",
        role:"read",
        buttons: Array(NAV.length).fill(false)
      });
      renderAll();
    });

    btnSaveLocal.addEventListener("click", ()=>{
      if(!isAdmin) return;
      saveLocal();
    });

    // mobile menu
    btnMore.addEventListener("click", ()=>{
      const open = moreMenu.style.display === "block";
      moreMenu.style.display = open ? "none" : "block";
      moreMenu.setAttribute("aria-hidden", open ? "true" : "false");
    });
    document.addEventListener("click", (e)=>{
      const inside = btnMore.contains(e.target) || moreMenu.contains(e.target);
      if(!inside){
        moreMenu.style.display = "none";
        moreMenu.setAttribute("aria-hidden","true");
      }
    });

    mSwitch.addEventListener("click", ()=> btnSwitch.click());
    mToken.addEventListener("click", ()=> btnToken.click());
    mDown.addEventListener("click", ()=> btnCloudDown.click());
    mUp.addEventListener("click", ()=> btnCloudUp.click());

    document.addEventListener("keydown", (e)=>{
      if(e.key==="Escape"){
        hideTokenOverlay();
        moreMenu.style.display="none";
        moreMenu.setAttribute("aria-hidden","true");
      }
    });

    // æ—‹è½‰/æ”¹è¦–çª—æ™‚é‡ç•«ï¼ˆé¿å…æ‰‹æ©Ÿâ†’æ¡Œæ©Ÿé¡¯ç¤ºä¸åŒæ­¥ï¼‰
    window.addEventListener("resize", ()=>{
      // ä¸åšé›²ç«¯ï¼Œåªé‡ç•« UI
      renderAll();
    });

    // ==========================
    // boot
    // ==========================
    (async function boot(){
      const cu = requireLogin();
      if(!cu) return;

      isAdmin = (cu.level === "admin");
      setEditableUI();

      syncToNavShape();
      setStatusPill();

      startCloudWatch();

      if(dbxEnabled()){
        msg.textContent = "æ­£åœ¨åŒæ­¥é›²ç«¯â€¦";
        await syncNow({force:false});
        msg.textContent = "";
      }else{
        msg.textContent = "";
      }

      if(!isAdmin){
        msg.textContent = "ï¼ˆä½ ç›®å‰ç‚ºé admin æ¬Šé™ï¼šåƒ…å¯æŸ¥çœ‹ï¼‰";
      }
    })();
  </script>
</body>
</html>
