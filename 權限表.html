<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Tasun æ¬Šé™è¡¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --gold: #f6d37a;
      --gold-soft: rgba(246, 211, 122, 0.8);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      font-family: "Noto Serif TC","æ¨™æ¥·é«”","Microsoft JhengHei",serif;
      background: radial-gradient(circle at 50% 10%, #2b1a05, #050302 60%);
      color: var(--gold);
      padding: 20px;
    }

    /* è¿”å›é¦–é  */
    .back-home {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.3rem 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.7);
      background: rgba(0,0,0,0.85);
      color: var(--gold-soft);
      text-decoration: none;
      font-size: 0.8rem;
      box-shadow: 0 8px 16px rgba(0,0,0,0.8);
    }

    .back-home:hover {
      background: rgba(0,0,0,0.95);
    }

    .page-title {
      text-align: center;
      margin: 10px 0 20px;
      font-size: 1.7rem;
      letter-spacing: 0.35em;
      text-indent: 0.35em;
      text-shadow:
        0 0 12px rgba(246, 211, 122, 0.9),
        0 0 26px rgba(246, 211, 122, 0.6);
    }

    .panel {
      max-width: 1100px;
      margin: 0 auto;
      padding: 1.5rem 1.8rem;
      border-radius: 1.4rem;
      background: rgba(0,0,0,0.9);
      border: 1px solid rgba(246, 211, 122, 0.45);
      box-shadow:
        0 18px 32px rgba(0,0,0,0.9),
        0 0 30px rgba(246, 211, 122, 0.35);
    }

    .panel p {
      font-size: 0.85rem;
      color: var(--gold-soft);
      margin-bottom: 0.8rem;
      line-height: 1.5;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }

    thead {
      background: rgba(246, 211, 122, 0.18);
    }

    th, td {
      border-bottom: 1px solid rgba(246, 211, 122, 0.2);
      padding: 0.35rem 0.4rem;
      text-align: center;
      vertical-align: middle;
    }

    th {
      letter-spacing: 0.14em;
      text-indent: 0.14em;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    input[type="text"],
    input[type="password"],
    select {
      width: 100%;
      padding: 0.25rem 0.35rem;
      border-radius: 0.4rem;
      border: 1px solid rgba(246, 211, 122, 0.5);
      background: rgba(0,0,0,0.9);
      color: var(--gold);
      font-size: 0.8rem;
    }

    input::placeholder {
      color: rgba(246, 211, 122, 0.4);
    }

    input[type="checkbox"] {
      transform: scale(1.2);
    }

    .btn-small {
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.7);
      background: rgba(0,0,0,0.9);
      color: var(--gold);
      font-size: 0.75rem;
      cursor: pointer;
    }

    .btn-small:hover {
      background: rgba(246, 211, 122, 0.15);
    }

    .btn-eye {
      padding: 0.15rem 0.4rem;
      min-width: 2.3rem;
    }

    .panel-footer {
      margin-top: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      color: var(--gold-soft);
    }

    .btn-main {
      padding: 0.4rem 1.2rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.9);
      background: radial-gradient(circle at 0% 0%, rgba(246, 211, 122, 0.4), rgba(0,0,0,0.95));
      color: var(--gold);
      font-size: 0.85rem;
      letter-spacing: 0.18em;
      text-indent: 0.18em;
      cursor: pointer;
      box-shadow:
        0 10px 20px rgba(0,0,0,0.9),
        0 0 18px rgba(246, 211, 122, 0.4);
    }

    .btn-main:hover {
      background: radial-gradient(circle at 0% 0%, rgba(255,240,200,0.5), rgba(0,0,0,0.98));
      box-shadow:
        0 14px 26px rgba(0,0,0,0.95),
        0 0 24px rgba(246, 211, 122, 0.6);
    }

    .warn {
      color: #ffb3b3;
    }

    .btn-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.15rem;
    }

    .btn-header-title {
      font-size: 0.72rem;
      letter-spacing: 0.1em;
    }

    .btn-header select {
      font-size: 0.75rem;
    }

    .pwd-wrapper {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .pwd-input {
      flex: 1 1 auto;
    }

    @media (max-width: 900px) {
      .panel {
        padding: 1rem;
      }
      th, td {
        font-size: 0.75rem;
        padding: 0.25rem;
      }
      .page-title {
        font-size: 1.3rem;
      }
    }
  </style>
</head>
<body>
  <a class="back-home" href="index.html">â† è¿”å›é¦–é </a>

  <h1 class="page-title">Tasun æ¬Šé™è¡¨</h1>

  <div class="panel">
    <p>
      åªæœ‰ <strong>admin</strong> ç™»å…¥è€…å¯ä»¥ç·¨è¼¯æ­¤è¡¨ã€‚<br>
      æ¬„ä½èªªæ˜ï¼šç”¨æˆ¶åã€å¯†ç¢¼ã€æ¬Šé™ç´šåˆ¥ï¼ˆadmin / write / readï¼‰ï¼Œä»¥åŠé¦–é æŒ‰éˆ•æ˜¯å¦é¡¯ç¤ºã€‚<br>
      é¦–é æŒ‰éˆ•çš„ã€Œæ•¸é‡ã€èˆ‡ã€Œåç¨±ã€çš†è‡ªå‹•è®€å– <strong>index.html</strong> çš„æŒ‰éˆ•è¨­å®šï¼›<br>
      è¡¨é ­çš„ä¸‹æ‹‰é¸å–®å¯èª¿æ•´é¡¯ç¤ºåç¨±ï¼›ç³»çµ± / æ¬Šé™ï¼ˆé€£åˆ°æœ¬é ï¼‰å›ºå®šåªæœ‰ admin é¡¯ç¤ºï¼Œä¸åˆ—å…¥æœ¬è¡¨ã€‚
    </p>

    <table>
      <thead>
        <tr id="headerRow"></tr>
      </thead>
      <tbody id="authBody"></tbody>
    </table>

    <div class="panel-footer">
      <div>
        <button type="button" class="btn-small" id="addRowBtn">ï¼‹ æ–°å¢ä¸€åˆ—</button>
      </div>
      <div>
        <button type="button" class="btn-main" id="saveBtn">å„²å­˜æ¬Šé™è¡¨</button>
      </div>
    </div>

    <p class="warn" id="statusMsg"></p>
  </div>

  <script>
    (function () {
      const AUTH_KEY = "tasunAuthTable_v1";
      const CURRENT_KEY = "tasunCurrentUser_v1";
      const BTN_LABEL_KEY = "tasunButtonLabels_v1";

      const LEGACY_BUTTON_KEYS = ["btn1", "btn2", "btn3", "btn4", "btn5"];

      const bodyEl    = document.getElementById("authBody");
      const headerRow = document.getElementById("headerRow");
      const addRowBtn = document.getElementById("addRowBtn");
      const saveBtn   = document.getElementById("saveBtn");
      const statusMsg = document.getElementById("statusMsg");

      /* ---------------------------
         å¾ index.html æŠ“æŒ‰éˆ•åç¨±
         --------------------------- */

      function getFallbackButtonNames() {
        // æŠ“ä¸åˆ° index.html æ™‚çš„å‚™ç”¨ï¼šç›®å‰é¦–é äº”é¡†
        return [
          "è‡»é¼æ™‚ä»£å¤§å»ˆç®¡ç†è¡¨",
          "ç¼ºå¤± / å“è³ª",
          "é›²ç«¯æª”æ¡ˆ",
          "å·¥ç¨‹è³‡æ–™åº«",
          "è³‡æ–™åº«"
        ];
      }

      function extractButtonsFromIndex(htmlText) {
        try {
          const parser = new DOMParser();
          const doc = parser.parseFromString(htmlText, "text/html");

          const allBtns = Array.from(doc.querySelectorAll("a.nav-btn[data-roles]"));
          const names = [];
          const nameSet = new Set();

          allBtns.forEach(a => {
            const href = (a.getAttribute("href") || "").trim();
            if (href && href.indexOf("æ¬Šé™è¡¨") !== -1) return;

            let text = a.textContent || "";
            text = text.replace(/\s+/g, " ").trim();
            if (!text) return;

            if (!nameSet.has(text)) {
              nameSet.add(text);
              names.push(text);
            }
          });

          if (!names.length) {
            return getFallbackButtonNames();
          }
          return names;
        } catch (e) {
          return getFallbackButtonNames();
        }
      }

      function loadButtonNamesFromIndex() {
        return fetch("index.html", { cache: "no-store" })
          .then(resp => {
            if (!resp.ok) throw new Error("fetch index failed");
            return resp.text();
          })
          .then(html => extractButtonsFromIndex(html))
          .catch(() => getFallbackButtonNames());
      }

      /* ---------------------------
         æŒ‰éˆ•åç¨±è¨­å®šï¼ˆè¡¨é ­ä¸‹æ‹‰é¸å–®ï¼‰
         --------------------------- */

      function loadButtonLabels(buttonNames) {
        const raw = localStorage.getItem(BTN_LABEL_KEY);
        const n = buttonNames.length;
        let stored = [];

        if (raw) {
          try {
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) {
              stored = parsed;
            } else if (parsed && typeof parsed === "object") {
              stored = LEGACY_BUTTON_KEYS.map(k => parsed[k]);
            }
          } catch (e) {}
        }

        const result = [];
        for (let i = 0; i < n; i++) {
          const val = stored[i];
          if (typeof val === "string" && val && buttonNames.includes(val)) {
            result[i] = val;
          } else {
            result[i] = buttonNames[i];
          }
        }
        return result;
      }

      function saveButtonLabels(labels) {
        localStorage.setItem(BTN_LABEL_KEY, JSON.stringify(labels));
      }

      function getButtonLabelsFromUI() {
        const selects = headerRow.querySelectorAll(".btn-label-select");
        const labels = [];
        selects.forEach((sel, idx) => {
          labels[idx] = sel.value;
        });
        return labels;
      }

      /* ---------------------------
         æ¬Šé™è³‡æ–™ï¼ˆä½¿ç”¨è€…åˆ—ï¼‰
         --------------------------- */

      function makeButtonsAll(count) {
        return Array(count).fill(true);
      }

      function makeButtonsOnlyLast(count) {
        const arr = Array(count).fill(false);
        if (count > 0) arr[count - 1] = true;
        return arr;
      }

      function getDefaultAuthTable(btnCount) {
        return [
          {
            username: "alex",
            password: "Tasun08040224",
            level: "admin",
            buttons: makeButtonsAll(btnCount)
          },
          {
            username: "tasun",
            password: "tasun08040224",
            level: "write",
            buttons: makeButtonsAll(btnCount)
          },
          {
            username: "wu",
            password: "123456",
            level: "read",
            buttons: makeButtonsOnlyLast(btnCount)
          }
        ];
      }

      function normalizeRowFromStorage(row, btnCount) {
        const username = row.username || "";
        const password = row.password || "";
        const level = row.level || "read";

        let buttons = [];

        if (Array.isArray(row.buttons)) {
          buttons = row.buttons.slice();
        } else {
          const legacy = [];
          LEGACY_BUTTON_KEYS.forEach(k => {
            if (Object.prototype.hasOwnProperty.call(row, k)) {
              legacy.push(!!row[k]);
            }
          });
          buttons = legacy;
        }

        const resultButtons = [];
        for (let i = 0; i < btnCount; i++) {
          resultButtons[i] = !!buttons[i];
        }

        return { username, password, level, buttons: resultButtons };
      }

      function loadAuthTable(btnCount) {
        const raw = localStorage.getItem(AUTH_KEY);
        if (!raw) {
          const defaults = getDefaultAuthTable(btnCount);
          localStorage.setItem(AUTH_KEY, JSON.stringify(defaults));
          return defaults;
        }
        try {
          const arr = JSON.parse(raw);
          if (Array.isArray(arr)) {
            return arr.map(r => normalizeRowFromStorage(r, btnCount));
          }
        } catch (e) {}
        const defaults = getDefaultAuthTable(btnCount);
        localStorage.setItem(AUTH_KEY, JSON.stringify(defaults));
        return defaults;
      }

      function saveAuthTable(arr) {
        localStorage.setItem(AUTH_KEY, JSON.stringify(arr));
      }

      /* ---------------------------
         æ¬Šé™æª¢æŸ¥ï¼šåªæœ‰ admin å¯é€²
         --------------------------- */

      function ensureAdmin() {
        const saved = localStorage.getItem(CURRENT_KEY);
        if (!saved) {
          alert("è«‹å…ˆåœ¨é¦–é ç™»å…¥å¾Œå†é€²å…¥æ¬Šé™è¡¨ã€‚");
          location.href = "index.html";
          return null;
        }
        try {
          const user = JSON.parse(saved);
          if (!user || user.level !== "admin") {
            alert("åªæœ‰ admin å¯ä»¥ç·¨è¼¯æ¬Šé™è¡¨ã€‚");
            location.href = "index.html";
            return null;
          }
          return user;
        } catch (e) {
          alert("ç™»å…¥è³‡è¨ŠéŒ¯èª¤ï¼Œè«‹é‡æ–°ç™»å…¥ã€‚");
          location.href = "index.html";
          return null;
        }
      }

      /* ---------------------------
         ç•«é¢ï¼šè¡¨é ­èˆ‡ä½¿ç”¨è€…åˆ—
         --------------------------- */

      function renderHeader(buttonNames, labelConfig) {
        headerRow.innerHTML = "";

        const thUser = document.createElement("th");
        thUser.textContent = "ç”¨æˆ¶å";
        headerRow.appendChild(thUser);

        const thPwd = document.createElement("th");
        thPwd.textContent = "å¯†ç¢¼";
        headerRow.appendChild(thPwd);

        const thLevel = document.createElement("th");
        thLevel.textContent = "æ¬Šé™ç´šåˆ¥";
        headerRow.appendChild(thLevel);

        buttonNames.forEach((btnName, idx) => {
          const th = document.createElement("th");
          const wrapper = document.createElement("div");
          wrapper.className = "btn-header";

          const title = document.createElement("div");
          title.className = "btn-header-title";
          title.textContent = "æŒ‰éˆ•" + (idx + 1);

          const select = document.createElement("select");
          select.className = "btn-label-select";
          select.dataset.index = String(idx);

          buttonNames.forEach(name => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            select.appendChild(opt);
          });

          const labelName = labelConfig[idx] || btnName;
          if (buttonNames.includes(labelName)) {
            select.value = labelName;
          } else {
            select.value = btnName;
          }

          wrapper.appendChild(title);
          wrapper.appendChild(select);
          th.appendChild(wrapper);
          headerRow.appendChild(th);
        });

        const thDel = document.createElement("th");
        thDel.textContent = "åˆªé™¤";
        headerRow.appendChild(thDel);
      }

      function renderTable(data, btnCount) {
        bodyEl.innerHTML = "";

        data.forEach(row => {
          const tr = document.createElement("tr");

          const tdUser = document.createElement("td");
          const inUser = document.createElement("input");
          inUser.type = "text";
          inUser.value = row.username || "";
          inUser.placeholder = "å¸³è™Ÿ";
          tdUser.appendChild(inUser);
          tr.appendChild(tdUser);

          const tdPwd = document.createElement("td");
          const pwdWrapper = document.createElement("div");
          pwdWrapper.className = "pwd-wrapper";

          const inPwd = document.createElement("input");
          inPwd.type = "password";
          inPwd.value = row.password || "";
          inPwd.placeholder = "å¯†ç¢¼";
          inPwd.className = "pwd-input";

          const eyeBtn = document.createElement("button");
          eyeBtn.type = "button";
          eyeBtn.className = "btn-small btn-eye";
          eyeBtn.textContent = "ğŸ‘";

          pwdWrapper.appendChild(inPwd);
          pwdWrapper.appendChild(eyeBtn);
          tdPwd.appendChild(pwdWrapper);
          tr.appendChild(tdPwd);

          const tdLevel = document.createElement("td");
          const sel = document.createElement("select");
          ["admin", "write", "read"].forEach(lv => {
            const opt = document.createElement("option");
            opt.value = lv;
            opt.textContent = lv;
            if (row.level === lv) opt.selected = true;
            sel.appendChild(opt);
          });
          tdLevel.appendChild(sel);
          tr.appendChild(tdLevel);

          for (let i = 0; i < btnCount; i++) {
            const td = document.createElement("td");
            const chk = document.createElement("input");
            chk.type = "checkbox";
            chk.checked = !!row.buttons[i];
            td.appendChild(chk);
            tr.appendChild(td);
          }

          const tdDel = document.createElement("td");
          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "btn-small btn-del";
          delBtn.textContent = "åˆªé™¤";
          tdDel.appendChild(delBtn);
          tr.appendChild(tdDel);

          bodyEl.appendChild(tr);
        });
      }

      function collectTable(btnCount) {
        const rows = Array.from(bodyEl.querySelectorAll("tr"));
        const result = [];

        rows.forEach(tr => {
          const tds = tr.querySelectorAll("td");

          const usernameInput = tds[0].querySelector("input");
          const pwdInput = tds[1].querySelector(".pwd-input");
          const levelSelect = tds[2].querySelector("select");

          const username = usernameInput ? usernameInput.value.trim() : "";
          const password = pwdInput ? pwdInput.value.trim() : "";
          const level = levelSelect ? levelSelect.value : "read";

          if (!username || !password) {
            return;
          }

          const buttons = [];
          for (let i = 0; i < btnCount; i++) {
            const tdIndex = 3 + i;
            const chk = tds[tdIndex].querySelector("input[type='checkbox']");
            buttons.push(chk ? chk.checked : false);
          }

          result.push({ username, password, level, buttons });
        });

        return result;
      }

      /* ---------------------------
         åˆå§‹åŒ–
         --------------------------- */

      function initWithButtonNames(buttonNames) {
        const btnCount = buttonNames.length;

        const labelConfig = loadButtonLabels(buttonNames);
        renderHeader(buttonNames, labelConfig);

        const tableData = loadAuthTable(btnCount);
        renderTable(tableData, btnCount);

        addRowBtn.addEventListener("click", function () {
          const newRow = {
            username: "",
            password: "",
            level: "read",
            buttons: Array(btnCount).fill(false)
          };
          const data = collectTable(btnCount);
          data.push(newRow);
          renderTable(data, btnCount);
        });

        bodyEl.addEventListener("click", function (e) {
          const target = e.target;

          if (target.classList.contains("btn-del")) {
            const tr = target.closest("tr");
            if (tr) tr.remove();
            return;
          }

          if (target.classList.contains("btn-eye")) {
            const td = target.closest("td");
            if (!td) return;
            const input = td.querySelector(".pwd-input");
            if (!input) return;
            input.type = input.type === "password" ? "text" : "password";
          }
        });

        saveBtn.addEventListener("click", function () {
          const data = collectTable(btnCount);
          if (!data.length) {
            statusMsg.textContent = "è‡³å°‘éœ€è¦ä¸€ç­†å¸³è™Ÿè³‡æ–™ã€‚";
            return;
          }

          const labels = getButtonLabelsFromUI();
          saveAuthTable(data);
          saveButtonLabels(labels);

          statusMsg.textContent = "å·²å„²å­˜æ¬Šé™è¡¨èˆ‡æŒ‰éˆ•åç¨±ã€‚å›åˆ°é¦–é é‡æ–°ç™»å…¥å³å¯å¥—ç”¨ã€‚";
        });
      }

      document.addEventListener("DOMContentLoaded", function () {
        const user = ensureAdmin();
        if (!user) return;

        loadButtonNamesFromIndex().then(buttonNames => {
          initWithButtonNames(buttonNames);
        });
      });
    })();
  </script>
</body>
</html>
