<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Tasun 權限表</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --gold:#f6d37a;
      --gold2:#e6c061;
      --bg:#050302;
      --stroke: rgba(246,211,122,.26);
      --panel: rgba(0,0,0,.38);
      --panel2: rgba(0,0,0,.22);
      --shadow: rgba(0,0,0,.60);
      --safe: clamp(14px, 2.2vw, 22px);
      --radius: 22px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:"Noto Serif TC", system-ui, -apple-system, "Microsoft JhengHei", sans-serif;
      color: var(--gold);
      background:
        radial-gradient(circle at 18% 10%, rgba(246,211,122,.14) 0, transparent 42%),
        radial-gradient(circle at 84% 88%, rgba(246,211,122,.12) 0, transparent 46%),
        linear-gradient(180deg, #070604 0%, #050302 55%, #040202 100%);
      overflow-x:hidden;
    }

    .frame{
      min-height:100vh;
      padding: var(--safe);
      display:flex;
      align-items:flex-start;
      justify-content:center;
    }

    .shell{
      width:min(1280px, 96vw);
      border-radius: 26px;
      background:
        radial-gradient(circle at 50% 0%, rgba(246,211,122,.14) 0, rgba(0,0,0,.10) 55%, rgba(0,0,0,.24) 100%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.18));
      box-shadow: 0 18px 60px rgba(0,0,0,.55), inset 0 0 0 1px rgba(246,211,122,.10);
      overflow:hidden;
      position:relative;
      padding-bottom: 16px;
    }

    .topbar{
      display:flex;
      gap: 10px;
      padding: 14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .leftGroup, .rightGroup{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(0,0,0,.40);
      border: 1px solid rgba(246,211,122,.22);
      box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.04);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      white-space:nowrap;
    }

    .btn{
      cursor:pointer;
      user-select:none;
      appearance:none;
      outline:none;
      font: inherit;
      color: var(--gold);
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.28);
      padding: 10px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.18));
      box-shadow: 0 10px 28px rgba(0,0,0,.38), inset 0 0 0 1px rgba(255,255,255,.04);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      white-space:nowrap;
      transition: filter .15s ease, transform .08s ease, opacity .15s ease;
    }
    .btn:hover{ filter: brightness(1.05); }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{
      opacity:.42;
      cursor:not-allowed;
      filter: none !important;
      transform:none !important;
    }

    .btn-token-link{
      border-color: rgba(255,244,208,.55);
      box-shadow: 0 10px 28px rgba(0,0,0,.40), 0 0 18px rgba(246,211,122,.20);
    }

    .header{
      padding: 10px 20px 8px;
      border-top: 1px solid rgba(246,211,122,.10);
      border-bottom: 1px solid rgba(246,211,122,.10);
      background: rgba(0,0,0,.18);
    }
    .header h1{
      margin: 0;
      font-size: clamp(36px, 4.3vw, 56px);
      letter-spacing: .20em;
      text-shadow: 0 8px 24px rgba(0,0,0,.62);
    }
    .header p{
      margin: 8px 0 0;
      opacity:.9;
      letter-spacing:.08em;
      line-height:1.7;
      font-size: 13px;
      color: rgba(246,211,122,.86);
    }

    .content{ padding: 14px 14px 8px; }

    .tableWrap{
      width:100%;
      overflow:auto;
      border-radius: 18px;
      border: 1px solid rgba(246,211,122,.10);
      background: rgba(0,0,0,.16);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }
    table{
      width: 100%;
      border-collapse: collapse;
      min-width: 980px;
    }
    thead th{
      position:sticky;
      top:0;
      z-index:2;
      background: rgba(0,0,0,.42);
      border-bottom: 1px solid rgba(246,211,122,.12);
      padding: 12px 10px;
      font-size: 13px;
      letter-spacing:.12em;
      color: rgba(246,211,122,.92);
      text-align:center;
      white-space:nowrap;
    }
    tbody td{
      padding: 12px 10px;
      border-bottom: 1px solid rgba(246,211,122,.08);
      text-align:center;
      vertical-align:middle;
    }

    .field{
      width: 100%;
      max-width: 220px;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.20);
      background: rgba(0,0,0,.34);
      color: var(--gold);
      padding: 10px 12px;
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
      font-family: inherit;
    }
    select.field{ max-width: 120px; }

    .chk{
      width: 18px;
      height: 18px;
      accent-color: var(--gold);
      cursor:pointer;
    }
    .delBtn{
      padding: 9px 14px;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.20);
      background: rgba(0,0,0,.32);
      color: var(--gold);
      cursor:pointer;
    }
    .delBtn[disabled]{ opacity:.42; cursor:not-allowed; }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      padding: 12px 6px 0;
    }
    .actions .left{ display:flex; gap:10px; flex-wrap:wrap; }
    .status{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      font-size: 13px;
      opacity:.92;
    }

    .msg{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(246,211,122,.12);
      background: rgba(0,0,0,.18);
      color: rgba(246,211,122,.88);
      white-space:pre-wrap;
      line-height:1.6;
      min-height: 44px;
    }

    /* ✅ 按鍵名稱設定面板 */
    .navPanel{
      margin-top: 10px;
      border-radius: 18px;
      border: 1px solid rgba(246,211,122,.12);
      background: rgba(0,0,0,.18);
      box-shadow: 0 14px 40px rgba(0,0,0,.38), inset 0 0 0 1px rgba(255,255,255,.02);
      overflow:hidden;
      display:none;
    }
    .navPanel.show{ display:block; }
    .navPanelHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(246,211,122,.10);
      background: rgba(0,0,0,.14);
    }
    .navPanelHead strong{
      letter-spacing:.12em;
    }
    .navGrid{
      padding: 12px 14px 14px;
      display:grid;
      grid-template-columns: 90px 1fr;
      gap:10px 12px;
      align-items:center;
    }
    .navHint{
      grid-column: 1 / -1;
      font-size: 12px;
      opacity:.9;
      letter-spacing:.06em;
      line-height:1.6;
      color: rgba(246,211,122,.86);
    }
    .navLabel{
      font-size: 12px;
      letter-spacing:.10em;
      opacity:.92;
      white-space:nowrap;
    }
    .navActions{
      padding: 0 14px 14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .topbarMobile{
      display:none;
      padding: 12px 14px;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(246,211,122,.10);
      background: rgba(0,0,0,.16);
    }
    .moreWrap{ position:relative; }
    .menu{
      position:absolute;
      right:0;
      top: calc(100% + 8px);
      min-width: 220px;
      border-radius: 16px;
      border: 1px solid rgba(246,211,122,.18);
      background: rgba(0,0,0,.66);
      box-shadow: 0 18px 50px rgba(0,0,0,.65);
      overflow:hidden;
      display:none;
      z-index: 10;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .menu.show{ display:block; }
    .menu button{
      width:100%;
      text-align:left;
      border:0;
      background:transparent;
      color: var(--gold);
      padding: 12px 14px;
      cursor:pointer;
      font: inherit;
      border-bottom: 1px solid rgba(246,211,122,.10);
    }
    .menu button:last-child{ border-bottom:0; }
    .menu button:hover{ background: rgba(255,255,255,.04); }
    .menu button[disabled]{ opacity:.45; cursor:not-allowed; }

    .cards{ display:none; margin-top: 10px; gap: 12px; }
    .card{
      border-radius: 18px;
      border: 1px solid rgba(246,211,122,.12);
      background: rgba(0,0,0,.18);
      box-shadow: 0 14px 40px rgba(0,0,0,.38), inset 0 0 0 1px rgba(255,255,255,.02);
      overflow:hidden;
    }
    .cardHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 14px;
      cursor:pointer;
    }
    .cardHead .who{ display:flex; flex-direction:column; gap:4px; }
    .cardHead .who strong{ letter-spacing:.10em; }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size: 12px;
      opacity:.92;
      border:1px solid rgba(246,211,122,.16);
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(0,0,0,.22);
      white-space:nowrap;
    }
    .chev{ opacity:.9; }
    .cardBody{
      display:none;
      padding: 0 14px 14px;
      border-top: 1px solid rgba(246,211,122,.10);
    }
    .card.open .cardBody{ display:block; }

    .grid2{ display:grid; grid-template-columns: 1fr; gap: 10px; margin-top: 12px; }
    .rowLabel{ font-size: 12px; opacity:.9; letter-spacing:.08em; margin-top: 8px; }

    .permScroll{ overflow-x:auto; padding: 10px 0 2px; }
    .permRow{ display:flex; gap:10px; min-width: max-content; align-items:center; }
    .permItem{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.14);
      background: rgba(0,0,0,.22);
      white-space:nowrap;
    }
    .permItem span{ font-size: 12px; opacity:.92; letter-spacing:.06em; }

    .cardActions{ margin-top: 12px; display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    @media (max-width: 980px){
      .topbar{ display:none; }
      .topbarMobile{ display:flex; }
      .tableWrap{ display:none; }
      .cards{ display:flex; flex-direction:column; }
      .navGrid{ grid-template-columns: 78px 1fr; }
    }
  </style>
</head>

<body>
  <div class="frame">
    <div class="shell">

      <!-- Mobile topbar -->
      <div class="topbarMobile">
        <div class="pill" id="whoMobile">目前使用者：—</div>

        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn" id="backBtnM">返回</button>
          <div class="moreWrap">
            <button class="btn" id="moreBtn">更多</button>
            <div class="menu" id="moreMenu">
              <button id="switchBtnM">切換帳號</button>
              <button id="navNameBtnM">按鍵名稱設定</button>
              <button id="downloadTokenBtnM">下載Token（Dropbox）</button>
              <button id="tokenBtnM">設定 Token</button>
              <button id="downloadBtnM">雲端下載</button>
              <button id="uploadBtnM">儲存並上傳</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Desktop topbar -->
      <div class="topbar">
        <div class="leftGroup">
          <div class="pill" id="whoDesk">目前使用者：—</div>
          <button class="btn" id="switchBtnD">切換帳號</button>
          <button class="btn" id="navNameBtnD">按鍵名稱設定</button>
        </div>
        <div class="rightGroup">
          <button class="btn" id="backBtnD">返回首頁</button>
          <button class="btn btn-token-link" id="downloadTokenBtnD">下載Token（Dropbox）</button>
          <button class="btn" id="tokenBtnD">設定 Token</button>
          <button class="btn" id="downloadBtnD">雲端下載</button>
          <button class="btn" id="uploadBtnD">儲存並上傳</button>
        </div>
      </div>

      <div class="header">
        <h1>Tasun 權限表</h1>
        <p>
          只有 <b>admin</b> 可以編輯；其他權限只能查看。<br>
          ✅ btn1～btn5 欄位標題會自動抓取首頁按鍵名稱（localStorage：<b>tasunNavButtons_v1</b>）。<br>
          ✅ admin 也可在本頁「按鍵名稱設定」直接改名，並同步到首頁。<br>
          雲端模式（App folder）：<b>/權限表.json</b>
        </p>
      </div>

      <div class="content">
        <div class="tableWrap">
          <table>
            <thead>
              <tr id="theadRow">
                <th>使用者</th>
                <th>密碼</th>
                <th>權限</th>
                <th class="sysCol">系統/權限</th>
                <th>刪除</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="cards" id="cards"></div>

        <div class="actions">
          <div class="left">
            <button class="btn" id="addBtn">＋ 新增一列</button>
            <button class="btn" id="saveLocalBtn">只儲存本機</button>
          </div>
          <div class="status">
            <div class="pill" id="tokenState">狀態：未設定 Token</div>
            <div class="pill" id="localState">本機：未儲存</div>
          </div>
        </div>

        <!-- ✅ 按鍵名稱設定 -->
        <div class="navPanel" id="navPanel">
          <div class="navPanelHead">
            <strong>按鍵名稱設定（btn1～btn5）</strong>
            <button class="btn" id="navCloseBtn">關閉</button>
          </div>
          <div class="navGrid">
            <div class="navHint">
              說明：這裡修改的是「首頁按鍵名稱」。儲存後會寫入 localStorage：<b>tasunNavButtons_v1</b>（並更新 <b>tasunRoutes_v1</b>），首頁/其他分頁會自動同步。<br>
              提醒：<b>btn2</b> 連結固定為「汐東工程管理表.html」，不受名稱影響。
            </div>

            <div class="navLabel">btn1</div>
            <input class="field" id="navName1" placeholder="btn1 名稱">

            <div class="navLabel">btn2</div>
            <input class="field" id="navName2" placeholder="btn2 名稱">

            <div class="navLabel">btn3</div>
            <input class="field" id="navName3" placeholder="btn3 名稱">

            <div class="navLabel">btn4</div>
            <input class="field" id="navName4" placeholder="btn4 名稱">

            <div class="navLabel">btn5</div>
            <input class="field" id="navName5" placeholder="btn5 名稱">
          </div>

          <div class="navActions">
            <button class="btn" id="navReloadBtn">重新讀取目前名稱</button>
            <button class="btn" id="navSaveBtn">儲存並同步</button>
          </div>
        </div>

        <div class="msg" id="msg"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const AUTH_KEY     = 'tasunAuthTable_v1';
  const CURRENT_KEY  = 'tasunCurrentUser_v1';
  const TOKEN_KEY    = 'tasunDropboxToken_v1';

  // ✅ 永遠同步（和 index.html 共用）
  const NAV_KEY      = 'tasunNavButtons_v1'; // btn1~btn5 名稱/連結等
  const ROUTE_KEY    = 'tasunRoutes_v1';     // label -> href 快取

  // 權限表顯示欄名快取（仍保留，方便沒開過 index 的情況）
  const BTN_META_KEY = 'tasunButtonMeta_v1';

  const DROPBOX_PATH = '/權限表.json';
  const TOKEN_DOWNLOAD_URL = 'https://www.dropbox.com/developers/apps';

  // ✅ btn2 固定連結（保持與 index 一致）
  const METRO_FIXED_HREF = '汐東工程管理表.html';

  const roleOptions = ['admin','write','read'];

  const el = (id) => document.getElementById(id);

  const whoDesk   = el('whoDesk');
  const whoMobile = el('whoMobile');

  const tbody     = el('tbody');
  const theadRow  = el('theadRow');
  const cards     = el('cards');

  const msg       = el('msg');
  const tokenState= el('tokenState');
  const localState= el('localState');

  const addBtn    = el('addBtn');
  const saveLocalBtn = el('saveLocalBtn');

  const backBtnD  = el('backBtnD');
  const backBtnM  = el('backBtnM');

  const switchBtnD= el('switchBtnD');
  const switchBtnM= el('switchBtnM');

  const tokenBtnD = el('tokenBtnD');
  const tokenBtnM = el('tokenBtnM');

  const downloadBtnD = el('downloadBtnD');
  const downloadBtnM = el('downloadBtnM');

  const uploadBtnD = el('uploadBtnD');
  const uploadBtnM = el('uploadBtnM');

  const moreBtn   = el('moreBtn');
  const moreMenu  = el('moreMenu');

  const downloadTokenBtnD = el('downloadTokenBtnD');
  const downloadTokenBtnM = el('downloadTokenBtnM');

  // ✅ 按鍵名稱設定
  const navPanel   = el('navPanel');
  const navCloseBtn= el('navCloseBtn');
  const navReloadBtn=el('navReloadBtn');
  const navSaveBtn = el('navSaveBtn');
  const navNameBtnD= el('navNameBtnD');
  const navNameBtnM= el('navNameBtnM');
  const navName1   = el('navName1');
  const navName2   = el('navName2');
  const navName3   = el('navName3');
  const navName4   = el('navName4');
  const navName5   = el('navName5');

  let auth = [];
  let btnMeta = [];
  let current = null;
  let isAdmin = false;

  // Token 狀態旗標
  let tokenExpired = false;
  let tokenInvalid = false;

  function safeJsonParse(s, fallback){
    try{ return JSON.parse(s); }catch(e){ return fallback; }
  }

  function bool(v){
    return v === true || v === 1 || v === '1' || v === 'true';
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function setMsg(text, isError=false){
    msg.style.color = isError ? 'rgba(255,170,170,.95)' : 'rgba(246,211,122,.88)';
    msg.textContent = text || '';
  }

  function stripInvisibles(s){
    return String(s ?? '')
      .replace(/\uFEFF/g, '')
      .replace(/[\u0000-\u001F\u007F]/g,'')
      .trim();
  }

  // ✅ Dropbox-API-Arg header 需要 ASCII：把非 ASCII 轉成 \uXXXX
  function latin1Safe(s){
    s = stripInvisibles(s);
    let out = '';
    for (const ch of s){
      const cp = ch.codePointAt(0);
      if (cp <= 0xFF) out += ch;
      else if (cp <= 0xFFFF) out += '\\u' + cp.toString(16).padStart(4,'0');
      else {
        const x = cp - 0x10000;
        const hi = 0xD800 + (x >> 10);
        const lo = 0xDC00 + (x & 0x3FF);
        out += '\\u' + hi.toString(16).padStart(4,'0') + '\\u' + lo.toString(16).padStart(4,'0');
      }
    }
    return out;
  }
  function jsonToAsciiSafe(obj){
    return latin1Safe(JSON.stringify(obj));
  }

  // ✅ Token 清理（修正 malformed 常見原因：前後空白、不可見字、貼到 Bearer、引號）
  function sanitizeToken(raw){
    let t = stripInvisibles(raw);
    t = t.replace(/^Bearer\s+/i, '');
    t = t.replace(/^Token\s*:\s*/i, '');
    t = t.replace(/^["'`]/, '').replace(/["'`]$/, '');
    t = t.replace(/[^\x21-\x7E]/g, '');
    return t.trim();
  }

  function isTokenLooksValid(token){
    const t = sanitizeToken(token);
    if(t.length < 20) return false;
    if(!/^[A-Za-z0-9._-]+$/.test(t)) return false;
    return true;
  }

  function getToken(){
    return sanitizeToken(localStorage.getItem(TOKEN_KEY) || '');
  }

  function clearTokenFlags(){
    tokenExpired = false;
    tokenInvalid = false;
  }

  function markTokenExpired(reasonText){
    tokenExpired = true;
    tokenInvalid = false;
    setMsg(
      'Token 已過期（expired_access_token）。\n' +
      '請先點「下載Token（Dropbox）」產生新 Token，再按「設定 Token」貼上。\n' +
      (reasonText ? `（原因：${reasonText}）` : ''),
      true
    );
    updateStates();
  }

  function markTokenInvalid(reasonText){
    tokenInvalid = true;
    tokenExpired = false;
    setMsg(
      'Token 格式不正確（malformed_access_token）。\n' +
      '請點「下載Token（Dropbox）」重新產生 Token，再按「設定 Token」貼上。\n' +
      (reasonText ? `（原因：${reasonText}）` : ''),
      true
    );
    updateStates();
  }

  function askTokenIfNeeded(reasonText){
    const old = (localStorage.getItem(TOKEN_KEY) || '').trim();
    const tip = reasonText ? `\n\n（原因：${reasonText}）` : '';
    const t = prompt('請貼上 Dropbox Access Token（僅儲存在本機瀏覽器）' + tip, old);
    if(t === null) return null;

    const cleaned = sanitizeToken(t);
    localStorage.setItem(TOKEN_KEY, cleaned);

    clearTokenFlags();

    if(cleaned && !isTokenLooksValid(cleaned)){
      markTokenInvalid('貼上的內容不像 Dropbox Access Token');
      return cleaned;
    }

    updateStates('已更新 Token。');
    return cleaned;
  }

  function seedAuthIfMissing(){
    const a = safeJsonParse(localStorage.getItem(AUTH_KEY) || 'null', null);
    if(Array.isArray(a) && a.length) return;

    const seed = [
      { user:'alex',  pass:'Tasun08040224', role:'admin', btn1:true, btn2:true, btn3:true, btn4:true, btn5:true },
      { user:'JOYCE', pass:'09220224',      role:'admin', btn1:true, btn2:true, btn3:true, btn4:true, btn5:true },
      { user:'tasun', pass:'tasun08040224', role:'write', btn1:true, btn2:true, btn3:false,btn4:true, btn5:false },
      { user:'wu',    pass:'123456',        role:'read',  btn1:true, btn2:false,btn3:false,btn4:false,btn5:false },
    ];
    localStorage.setItem(AUTH_KEY, JSON.stringify(seed));
  }

  function normalizeAuth(){
    auth.forEach(u => {
      for(let i=1;i<=5;i++){
        const k = 'btn'+i;
        u[k] = bool(u[k]);
      }
      const r = String(u.role||'read').toLowerCase();
      u.role = roleOptions.includes(r) ? r : 'read';
      u.user = String(u.user||'').trim();
      u.pass = String(u.pass||'');
    });
    auth = auth.filter(u => (u.user||'').trim() !== '');
  }

  function getEffectiveRole(){
    const cu = String(current?.user || '').toLowerCase();
    const row = auth.find(a => String(a.user||'').toLowerCase() === cu);
    return String(row?.role || current?.role || 'read').toLowerCase();
  }

  function updateWho(){
    const t = `目前使用者：${current.user} (${current.role})`;
    whoDesk.textContent = t;
    whoMobile.textContent = t;
  }

  // ✅ 從 NAV_KEY 取得 btn1~btn5 名稱（最準）
  function buildBtnMetaFromNavKey(){
    const arr = safeJsonParse(localStorage.getItem(NAV_KEY) || '[]', []);
    if(!Array.isArray(arr) || !arr.length) return null;

    const map = new Map(arr.map(x => [String(x.id||'').toLowerCase(), x]));
    const out = [];
    for(let i=1;i<=5;i++){
      const id = `btn${i}`;
      const hit = map.get(id);
      const name = String(hit?.label || id).trim() || id;
      out.push({ key:id, name });
    }
    return out;
  }

  function ensureBtnMeta(){
    // 1) NAV_KEY 優先
    const fromNav = buildBtnMetaFromNavKey();
    if(fromNav && fromNav.length){
      btnMeta = fromNav;
      localStorage.setItem(BTN_META_KEY, JSON.stringify(btnMeta));
      return;
    }

    // 2) 快取
    const cached = safeJsonParse(localStorage.getItem(BTN_META_KEY) || '[]', []);
    if(Array.isArray(cached) && cached.length){
      btnMeta = cached.filter(x => /^btn[1-5]$/.test(String(x.key||'')));
    }

    // 3) fallback
    if(!Array.isArray(btnMeta) || !btnMeta.length){
      btnMeta = [
        { key:'btn1', name:'btn1' },
        { key:'btn2', name:'btn2' },
        { key:'btn3', name:'btn3' },
        { key:'btn4', name:'btn4' },
        { key:'btn5', name:'btn5' },
      ];
    }

    for(let i=1;i<=5;i++){
      const k = 'btn'+i;
      if(!btnMeta.find(b => b.key === k)) btnMeta.push({ key:k, name:k });
    }
  }

  function renderHeaders(){
    theadRow.innerHTML = `
      <th>使用者</th>
      <th>密碼</th>
      <th>權限</th>
      ${btnMeta.map(b => `<th>${escapeHtml(b.name || b.key)}</th>`).join('')}
      <th class="sysCol">系統/權限</th>
      <th>刪除</th>
    `;
  }

  function renderTable(){
    tbody.innerHTML = auth.map((u, idx) => {
      const role = String(u.role||'read').toLowerCase();
      const sysCell = (role === 'admin') ? '✓' : '—';

      return `
      <tr data-idx="${idx}">
        <td><input class="field" data-k="user" value="${escapeHtml(u.user||'')}" ${isAdmin?'':'disabled'}></td>
        <td><input class="field" data-k="pass" value="${escapeHtml(u.pass||'')}" ${isAdmin?'':'disabled'}></td>
        <td>
          <select class="field" data-k="role" ${isAdmin?'':'disabled'}>
            ${roleOptions.map(r => `<option value="${r}" ${r===role?'selected':''}>${r}</option>`).join('')}
          </select>
        </td>

        ${btnMeta.map(b => {
          const k = b.key;
          const checked = bool(u[k]) ? 'checked' : '';
          return `<td><input class="chk" type="checkbox" data-k="${k}" ${checked} ${isAdmin?'':'disabled'}></td>`;
        }).join('')}

        <td>${sysCell}</td>
        <td><button class="delBtn" data-act="del" ${isAdmin?'':'disabled'}>刪除</button></td>
      </tr>`;
    }).join('');
  }

  function renderCards(){
    cards.innerHTML = auth.map((u, idx) => {
      const role = String(u.role||'read').toLowerCase();
      const sys = (role === 'admin') ? '✓' : '—';

      return `
      <div class="card" data-idx="${idx}">
        <div class="cardHead" data-act="toggle">
          <div class="who">
            <strong>${escapeHtml(u.user||'')}</strong>
            <span class="badge">role：${escapeHtml(role)}　｜　系統/權限：${sys}</span>
          </div>
          <div class="chev">▾</div>
        </div>

        <div class="cardBody">
          <div class="grid2">
            <div>
              <div class="rowLabel">使用者</div>
              <input class="field" data-k="user" value="${escapeHtml(u.user||'')}" ${isAdmin?'':'disabled'}>
            </div>
            <div>
              <div class="rowLabel">密碼</div>
              <input class="field" data-k="pass" value="${escapeHtml(u.pass||'')}" ${isAdmin?'':'disabled'}>
            </div>
            <div>
              <div class="rowLabel">權限</div>
              <select class="field" data-k="role" ${isAdmin?'':'disabled'}>
                ${roleOptions.map(r => `<option value="${r}" ${r===role?'selected':''}>${r}</option>`).join('')}
              </select>
            </div>

            <div class="rowLabel">按鍵權限（可左右滑動）</div>
            <div class="permScroll">
              <div class="permRow">
                ${btnMeta.map(b => {
                  const k = b.key;
                  const checked = bool(u[k]) ? 'checked' : '';
                  return `
                  <label class="permItem">
                    <input class="chk" type="checkbox" data-k="${k}" ${checked} ${isAdmin?'':'disabled'}>
                    <span>${escapeHtml(b.name || k)}</span>
                  </label>`;
                }).join('')}
              </div>
            </div>

            <div class="cardActions">
              <button class="btn" data-act="del" ${isAdmin?'':'disabled'}>刪除此使用者</button>
            </div>
          </div>
        </div>
      </div>`;
    }).join('');
  }

  function saveLocal(){
    localStorage.setItem(AUTH_KEY, JSON.stringify(auth));
    localState.textContent = '本機：已儲存';
  }

  function closeMoreMenu(){ moreMenu.classList.remove('show'); }

  function setCloudButtonsEnabled(){
    const token = getToken();
    const tokenOk = !!token && !tokenExpired && !tokenInvalid && isTokenLooksValid(token);

    downloadBtnD.disabled = !tokenOk;
    downloadBtnM.disabled = !tokenOk;

    uploadBtnD.disabled = !(tokenOk && isAdmin);
    uploadBtnM.disabled = !(tokenOk && isAdmin);

    const hint = !token ? '尚未設定 Token'
      : (tokenInvalid ? 'Token 格式錯誤，請更新'
      : (tokenExpired ? 'Token 過期，請更新'
      : (!isTokenLooksValid(token) ? 'Token 看起來不正確，請更新' : '')));

    downloadBtnD.title = tokenOk ? '' : hint;
    downloadBtnM.title = tokenOk ? '' : hint;

    if(!isAdmin){
      uploadBtnD.title = '需 admin 且已設定 Token';
      uploadBtnM.title = '需 admin 且已設定 Token';
    }else{
      uploadBtnD.title = tokenOk ? '' : hint;
      uploadBtnM.title = tokenOk ? '' : hint;
    }
  }

  function updateStates(text){
    const token = getToken();

    if(tokenInvalid){
      tokenState.textContent = '狀態：Token 格式錯誤（請更新）';
    }else if(tokenExpired){
      tokenState.textContent = '狀態：Token 過期（請更新）';
    }else{
      tokenState.textContent = token ? '狀態：已設定 Token（可同步）' : '狀態：未設定 Token';
    }

    setCloudButtonsEnabled();

    if(text && !tokenExpired && !tokenInvalid){
      setMsg(text, false);
    }
  }

  function renderAll(){
    updateWho();
    ensureBtnMeta();
    renderHeaders();
    renderTable();
    renderCards();

    addBtn.disabled = !isAdmin;

    // ✅ 按鍵名稱設定只給 admin
    navNameBtnD.disabled = !isAdmin;
    navNameBtnM.disabled = !isAdmin;

    setCloudButtonsEnabled();

    if(!isAdmin){
      setMsg('（僅可查看）你目前不是 admin，無法編輯。', false);
    }
  }

  function addRow(){
    auth.push({ user:'', pass:'', role:'read', btn1:false, btn2:false, btn3:false, btn4:false, btn5:false });
    renderAll();
    setMsg('已新增一列（請填寫使用者/密碼）。');
  }

  function removeRow(idx){
    if(idx < 0 || idx >= auth.length) return;
    const u = auth[idx];
    if(String(u.user||'').toLowerCase() === 'alex'){
      setMsg('保護：不可刪除 alex。', true);
      return;
    }
    auth.splice(idx, 1);
    renderAll();
    saveLocal();
    setMsg('已刪除一列並儲存本機。');
  }

  function onTableInput(e){
    const tr = e.target.closest('tr');
    if(!tr) return;
    const idx = Number(tr.dataset.idx);
    if(Number.isNaN(idx) || !auth[idx]) return;

    const k = e.target.dataset.k;
    if(!k) return;

    if(e.target.type === 'checkbox'){
      auth[idx][k] = !!e.target.checked;
    }else if(e.target.tagName === 'SELECT'){
      auth[idx][k] = e.target.value;
    }else{
      auth[idx][k] = e.target.value;
    }

    normalizeAuth();
    saveLocal();
  }

  function onTableClick(e){
    const tr = e.target.closest('tr');
    if(!tr) return;
    const idx = Number(tr.dataset.idx);
    if(Number.isNaN(idx)) return;
    if(e.target.dataset.act === 'del') removeRow(idx);
  }

  function onCardClick(e){
    const card = e.target.closest('.card');
    if(!card) return;
    const idx = Number(card.dataset.idx);
    if(Number.isNaN(idx) || !auth[idx]) return;

    const act = e.target.dataset.act || (e.target.closest('[data-act]')?.dataset.act);
    if(act === 'toggle'){
      card.classList.toggle('open');
      const chev = card.querySelector('.chev');
      if(chev) chev.textContent = card.classList.contains('open') ? '▴' : '▾';
      return;
    }
    if(act === 'del'){
      removeRow(idx);
      return;
    }
  }

  function onCardInput(e){
    const card = e.target.closest('.card');
    if(!card) return;
    const idx = Number(card.dataset.idx);
    if(Number.isNaN(idx) || !auth[idx]) return;

    const k = e.target.dataset.k;
    if(!k) return;

    if(e.target.type === 'checkbox'){
      auth[idx][k] = !!e.target.checked;
    }else if(e.target.tagName === 'SELECT'){
      auth[idx][k] = e.target.value;
    }else{
      auth[idx][k] = e.target.value;
    }

    normalizeAuth();
    saveLocal();
  }

  moreBtn.addEventListener('click', () => {
    moreMenu.classList.toggle('show');
  });
  document.addEventListener('click', (e) => {
    if(!e.target.closest('.moreWrap')) moreMenu.classList.remove('show');
  });

  function goHome(){ location.href = 'index.html'; }
  backBtnD.addEventListener('click', goHome);
  backBtnM.addEventListener('click', () => { closeMoreMenu(); goHome(); });

  function switchAccount(){
    localStorage.removeItem(CURRENT_KEY);
    location.href = 'index.html';
  }
  switchBtnD.addEventListener('click', switchAccount);
  switchBtnM.addEventListener('click', () => { closeMoreMenu(); switchAccount(); });

  function openTokenDownload(){
    window.open(TOKEN_DOWNLOAD_URL, '_blank', 'noopener');
  }
  downloadTokenBtnD.addEventListener('click', openTokenDownload);
  downloadTokenBtnM.addEventListener('click', () => { closeMoreMenu(); openTokenDownload(); });

  function setToken(){
    askTokenIfNeeded('');
  }
  tokenBtnD.addEventListener('click', setToken);
  tokenBtnM.addEventListener('click', () => { closeMoreMenu(); setToken(); });

  function guardTokenOrHint(){
    const token = getToken();
    if(!token){
      setMsg('尚未設定 Token。\n請按「設定 Token」貼上 Dropbox Access Token。', true);
      updateStates();
      return '';
    }
    if(!isTokenLooksValid(token)){
      markTokenInvalid('貼上的內容不像 Dropbox Access Token');
      return '';
    }
    if(tokenExpired){
      markTokenExpired('expired_access_token');
      return '';
    }
    if(tokenInvalid){
      markTokenInvalid('malformed_access_token');
      return '';
    }
    return token;
  }

  downloadBtnD.addEventListener('click', () => {
    const t = guardTokenOrHint(); if(!t) return;
    cloudDownload(t);
  });
  downloadBtnM.addEventListener('click', () => {
    closeMoreMenu();
    const t = guardTokenOrHint(); if(!t) return;
    cloudDownload(t);
  });

  uploadBtnD.addEventListener('click', () => {
    const t = guardTokenOrHint(); if(!t) return;
    saveAndUpload(t);
  });
  uploadBtnM.addEventListener('click', () => {
    closeMoreMenu();
    const t = guardTokenOrHint(); if(!t) return;
    saveAndUpload(t);
  });

  saveLocalBtn.addEventListener('click', () => {
    normalizeAuth();
    saveLocal();
    updateStates('已儲存本機（localStorage）。');
  });

  addBtn.addEventListener('click', addRow);

  tbody.addEventListener('input', onTableInput);
  tbody.addEventListener('change', onTableInput);
  tbody.addEventListener('click', onTableClick);

  cards.addEventListener('click', onCardClick);
  cards.addEventListener('input', onCardInput);
  cards.addEventListener('change', onCardInput);

  // ✅ Token 進入頁面驗證（避免按上傳才知道 expired/malformed）
  async function verifyTokenAutoMessage(){
    try{
      if(!isAdmin) return;
      const token = getToken();
      if(!token) return;

      if(!isTokenLooksValid(token)){
        markTokenInvalid('貼上的內容不像 Dropbox Access Token');
        return;
      }

      const headers = new Headers();
      headers.set('Authorization', 'Bearer ' + token);

      const res = await fetch('https://api.dropboxapi.com/2/users/get_current_account', {
        method:'POST',
        headers
      });

      if(!res.ok){
        const t = await res.text().catch(()=> '');
        if(res.status === 401 && /expired_access_token/i.test(t)){
          markTokenExpired('expired_access_token');
          return;
        }
        if(res.status === 400 && /malformed|OAuth 2 access token is malformed/i.test(t)){
          markTokenInvalid('OAuth 2 access token is malformed');
          return;
        }
        return;
      }

      if(tokenExpired || tokenInvalid){
        clearTokenFlags();
        updateStates();
      }
    }catch(_){}
  }

  // === Dropbox ===
  async function cloudDownload(token){
    try{
      setMsg('雲端下載中…');

      const arg = jsonToAsciiSafe({ path: DROPBOX_PATH });

      const headers = new Headers();
      headers.set('Authorization', 'Bearer ' + token);
      headers.set('Dropbox-API-Arg', arg);

      const res = await fetch('https://content.dropboxapi.com/2/files/download', {
        method:'POST',
        headers
      });

      if(!res.ok){
        const t = await res.text().catch(()=> '');
        if(res.status === 401 && /expired_access_token/i.test(t)){
          markTokenExpired('expired_access_token');
          return;
        }
        if((res.status === 400 || res.status === 401) && /malformed|OAuth 2 access token is malformed/i.test(t)){
          markTokenInvalid('OAuth 2 access token is malformed');
          return;
        }
        throw new Error(`下載失敗 HTTP ${res.status}\n${t}`);
      }

      const text = await res.text();
      const remote = safeJsonParse(text, null);
      if(!remote || !Array.isArray(remote)){
        throw new Error('雲端檔案不是有效的 JSON 陣列。');
      }

      auth = remote;
      normalizeAuth();
      saveLocal();

      current.role = getEffectiveRole();
      isAdmin = (getEffectiveRole() === 'admin');

      renderAll();
      updateStates('雲端下載完成，已覆蓋本機並更新畫面。');
    }catch(err){
      setMsg('雲端下載失敗：' + (err?.message || err), true);
    }
  }

  async function saveAndUpload(token){
    if(!isAdmin){
      setMsg('你不是 admin，禁止上傳。', true);
      return;
    }
    normalizeAuth();
    saveLocal();

    try{
      setMsg('上傳中…');

      const body = JSON.stringify(auth, null, 2);

      const apiArg = jsonToAsciiSafe({
        path: DROPBOX_PATH,
        mode: 'overwrite',
        autorename: false,
        mute: true
      });

      const headers = new Headers();
      headers.set('Authorization', 'Bearer ' + token);
      headers.set('Content-Type', 'application/octet-stream');
      headers.set('Dropbox-API-Arg', apiArg);

      const res = await fetch('https://content.dropboxapi.com/2/files/upload', {
        method: 'POST',
        headers,
        body
      });

      const text = await res.text().catch(()=>'');

      if(!res.ok){
        if(res.status === 401 && /expired_access_token/i.test(text)){
          markTokenExpired('expired_access_token');
          return;
        }
        if((res.status === 400 || res.status === 401) && /malformed|OAuth 2 access token is malformed/i.test(text)){
          markTokenInvalid('OAuth 2 access token is malformed');
          return;
        }
        if(/files\.content\.write/i.test(text)){
          setMsg('上傳失敗：可能 scopes 不足（需要 files.content.write）。\n' + text, true);
          return;
        }
        throw new Error(`上傳失敗 HTTP ${res.status}\n${text}`);
      }

      const info = safeJsonParse(text, null);
      let stamp = '';
      if(info && typeof info === 'object'){
        const sm = info.server_modified || info.client_modified || '';
        if(sm) stamp = `\n雲端時間：${sm}`;
      }

      updateStates('上傳成功。' + stamp);
    }catch(err){
      setMsg('上傳失敗：' + (err?.message || err), true);
    }
  }

  // ===== ✅ 按鍵名稱設定：讀/寫 NAV_KEY + ROUTE_KEY =====
  function readNavButtons(){
    const arr = safeJsonParse(localStorage.getItem(NAV_KEY) || '[]', []);
    if(Array.isArray(arr) && arr.length){
      const map = new Map(arr.map(x => [String(x.id||'').toLowerCase(), x]));
      const out = [];
      for(let i=1;i<=5;i++){
        const id = `btn${i}`;
        const hit = map.get(id);
        out.push({
          id,
          label: String(hit?.label || id).trim() || id,
          href: String(hit?.href || '').trim(),
          target: String(hit?.target || '').trim(),
          roles: Array.isArray(hit?.roles) ? hit.roles : []
        });
      }
      return out;
    }
    // fallback：用 btnMeta 或預設
    ensureBtnMeta();
    return btnMeta.map(b => ({ id:b.key, label:b.name || b.key, href:'', target:'', roles:[] }));
  }

  // ✅ 連結「跟著名稱」：若原 href 看起來是自動（= oldLabel.html），則改名後一起更新 href
  function maybeUpdateHrefByRename(oldLabel, newLabel, oldHref){
    const oL = String(oldLabel||'').trim();
    const nL = String(newLabel||'').trim();
    const oH = String(oldHref||'').trim();

    // btn2 固定
    if(oL && oH === METRO_FIXED_HREF) return METRO_FIXED_HREF;

    // 若沒 href：用新名.html
    if(!oH) return `${nL}.html`;

    // 若原 href 正好是「舊名.html」則視為自動生成 → 隨新名改
    if(oL && oH === `${oL}.html`) return `${nL}.html`;

    // 否則保留原 href（代表你手動指定過/或是固定網址）
    return oH;
  }

  function writeNavButtons(updated){
    // 1) 先讀現有（保留 target/roles/原 href）
    const currentArr = safeJsonParse(localStorage.getItem(NAV_KEY) || '[]', []);
    const curMap = new Map(
      (Array.isArray(currentArr) ? currentArr : []).map(x => [String(x.id||'').toLowerCase(), x])
    );

    const out = [];
    for(let i=1;i<=5;i++){
      const id = `btn${i}`;
      const prev = curMap.get(id) || {};
      const oldLabel = String(prev.label || id).trim() || id;
      const newLabel = String(updated[i-1]?.label || oldLabel).trim() || oldLabel;

      let href = String(prev.href || '').trim();
      // btn2 固定 href
      if(id === 'btn2'){
        href = METRO_FIXED_HREF;
      }else{
        href = maybeUpdateHrefByRename(oldLabel, newLabel, href);
      }

      out.push({
        id,
        label: newLabel,
        href,
        target: String(prev.target || '').trim(),
        roles: Array.isArray(prev.roles) ? prev.roles : []
      });
    }

    // 2) 寫入 NAV_KEY
    const newRaw = JSON.stringify(out);
    const oldRaw = localStorage.getItem(NAV_KEY) || '';
    if(oldRaw !== newRaw){
      localStorage.setItem(NAV_KEY, newRaw);
    }

    // 3) 更新 ROUTE_KEY（label->href）
    const oldRoutes = safeJsonParse(localStorage.getItem(ROUTE_KEY) || '{}', {});
    const routes = (oldRoutes && typeof oldRoutes === 'object') ? { ...oldRoutes } : {};
    out.forEach(it => { if(it.label) routes[it.label] = it.href; });
    // 加一道保險：btn2 固定
    routes[out[1]?.label || 'btn2'] = METRO_FIXED_HREF;

    const routesNew = JSON.stringify(routes);
    const routesOld = localStorage.getItem(ROUTE_KEY) || '';
    if(routesOld !== routesNew){
      localStorage.setItem(ROUTE_KEY, routesNew);
    }

    // 4) 權限表本頁立即刷新（同頁不會收到 storage event，所以主動更新）
    ensureBtnMeta();
    renderAll();
  }

  function openNavPanel(){
    if(!isAdmin){
      setMsg('你不是 admin，不能修改按鍵名稱。', true);
      return;
    }
    navPanel.classList.add('show');
    loadNavNamesIntoInputs();
  }
  function closeNavPanel(){
    navPanel.classList.remove('show');
  }

  function loadNavNamesIntoInputs(){
    const nav = readNavButtons();
    navName1.value = nav[0]?.label || '';
    navName2.value = nav[1]?.label || '';
    navName3.value = nav[2]?.label || '';
    navName4.value = nav[3]?.label || '';
    navName5.value = nav[4]?.label || '';
  }

  function saveNavNamesFromInputs(){
    if(!isAdmin){
      setMsg('你不是 admin，不能儲存按鍵名稱。', true);
      return;
    }
    const n1 = stripInvisibles(navName1.value) || 'btn1';
    const n2 = stripInvisibles(navName2.value) || 'btn2';
    const n3 = stripInvisibles(navName3.value) || 'btn3';
    const n4 = stripInvisibles(navName4.value) || 'btn4';
    const n5 = stripInvisibles(navName5.value) || 'btn5';

    // 不允許空字
    const list = [n1,n2,n3,n4,n5].map(s => s.trim()).filter(Boolean);
    if(list.length !== 5){
      setMsg('按鍵名稱不可空白。', true);
      return;
    }

    writeNavButtons([
      { id:'btn1', label:n1 },
      { id:'btn2', label:n2 }, // 名稱可改，但 href 仍固定
      { id:'btn3', label:n3 },
      { id:'btn4', label:n4 },
      { id:'btn5', label:n5 },
    ]);

    setMsg('✅ 已儲存按鍵名稱並同步（tasunNavButtons_v1 / tasunRoutes_v1）。\n其他分頁（例如首頁）會自動更新。');
  }

  navNameBtnD.addEventListener('click', openNavPanel);
  navNameBtnM.addEventListener('click', () => { closeMoreMenu(); openNavPanel(); });
  navCloseBtn.addEventListener('click', closeNavPanel);
  navReloadBtn.addEventListener('click', loadNavNamesIntoInputs);
  navSaveBtn.addEventListener('click', saveNavNamesFromInputs);

  // ===== 初始化 & storage 同步 =====
  function load(){
    seedAuthIfMissing();

    auth = safeJsonParse(localStorage.getItem(AUTH_KEY) || '[]', []);
    if(!Array.isArray(auth)) auth = [];
    normalizeAuth();

    current = safeJsonParse(localStorage.getItem(CURRENT_KEY) || 'null', null);
    if(!current || typeof current !== 'object'){
      current = { user:'—', role:'read' };
    }else{
      current.user = String(current.user || '—');
      current.role = String(current.role || 'read');
    }

    ensureBtnMeta();

    current.role = getEffectiveRole();
    isAdmin = (getEffectiveRole() === 'admin');

    clearTokenFlags();

    renderAll();
    updateStates('已載入本機資料。');

    verifyTokenAutoMessage();
  }

  // ✅ 監聽 NAV_KEY：別的分頁（例如首頁或另一個權限表分頁）改名 → 這裡自動刷新欄名
  window.addEventListener('storage', (e) => {
    if(e.key === NAV_KEY || e.key === BTN_META_KEY){
      ensureBtnMeta();
      renderAll();
      updateStates('已同步首頁按鍵名稱。');
      return;
    }
    if(e.key === AUTH_KEY || e.key === CURRENT_KEY || e.key === TOKEN_KEY){
      load();
    }
  });

  load();

  // Mobile menu 的 disabled 狀態補強（非 admin 時）
  function refreshMenuState(){
    navNameBtnM.disabled = !isAdmin;
    navNameBtnD.disabled = !isAdmin;
  }
  refreshMenuState();
})();
</script>
</body>
</html>
