<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Tasun æ¬Šé™è¡¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --gold: #f6d37a;
      --gold-soft: rgba(246, 211, 122, 0.75);
      --panel-border: rgba(246, 211, 122, 0.35);
      --bg: #050302;
      --card: rgba(0,0,0,0.72);
      --shadow: rgba(0,0,0,0.88);
      --radius: 22px;
    }
    *{ box-sizing:border-box; margin:0; padding:0; }
    body{
      min-height:100vh;
      background: radial-gradient(circle at 50% 10%, rgba(255, 237, 180, 0.18), rgba(0,0,0,0.96) 60%),
                  radial-gradient(circle at 20% 80%, rgba(246,211,122,0.10), rgba(0,0,0,0.0) 55%),
                  var(--bg);
      color: var(--gold);
      font-family:"Noto Serif TC","Microsoft JhengHei",serif;
      overflow-x:hidden;
    }

    /* ======= Top Bar (Desktop) ======= */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      padding: .65rem .8rem;
      display:flex;
      gap:.55rem;
      align-items:center;
      flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(0,0,0,0.74), rgba(0,0,0,0.30));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(246,211,122,0.12);
    }
    .pill{
      padding: .32rem 1.0rem;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,0.55);
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,0.16), rgba(0,0,0,0.85));
      box-shadow: 0 6px 14px rgba(0,0,0,0.65);
      font-size: .82rem;
      letter-spacing: .10em;
      text-indent: .10em;
      opacity:.92;
    }
    .btn{
      padding: .34rem 1.0rem;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,0.62);
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,0.20), rgba(0,0,0,0.92));
      color: var(--gold);
      cursor:pointer;
      font-size:.82rem;
      letter-spacing:.10em;
      text-indent:.10em;
      box-shadow: 0 10px 18px rgba(0,0,0,0.72);
      transition: transform .15s ease, box-shadow .2s ease, opacity .2s ease;
      opacity:.90;
      white-space: nowrap;
    }
    .btn:hover{ transform: translateY(-1px); opacity:1; box-shadow: 0 14px 24px rgba(0,0,0,0.85); }
    .btn:active{ transform: translateY(0px); }

    /* ======= Mobile Top UI: è¿”å› / æ›´å¤š ======= */
    .mbar{
      display:none;
      width:100%;
      gap:.55rem;
      align-items:center;
    }
    .mbar .btn{ flex: 1 1 auto; }
    .menu{
      position: relative;
      flex: 1 1 auto;
    }
    .menu-panel{
      position:absolute;
      right:0;
      top: calc(100% + 10px);
      width: min(320px, 92vw);
      border-radius: 16px;
      border: 1px solid rgba(246,211,122,0.30);
      background: rgba(0,0,0,0.92);
      box-shadow: 0 18px 32px rgba(0,0,0,0.86), 0 0 22px rgba(246,211,122,0.12);
      padding: .4rem;
      display:none;
      z-index: 99;
    }
    .menu-panel button{
      width:100%;
      text-align:left;
      padding: .6rem .8rem;
      border-radius: 12px;
      border:none;
      background: transparent;
      color: var(--gold);
      cursor:pointer;
      letter-spacing:.08em;
    }
    .menu-panel button:hover{ background: rgba(246,211,122,0.10); }

    @media (max-width: 740px){
      .topbar{ gap:.5rem; }
      .topbar .desktop-only{ display:none; }
      .mbar{ display:flex; }
    }

    /* ======= Main Card ======= */
    .wrap{
      width: min(1180px, 94vw);
      margin: 1.2rem auto 2rem;
    }
    .card{
      border-radius: var(--radius);
      border: 1px solid rgba(246,211,122,0.20);
      background: radial-gradient(circle at 15% 0%, rgba(246,211,122,0.10), rgba(0,0,0,0.78));
      box-shadow: 0 24px 64px rgba(0,0,0,0.70);
      overflow:hidden;
    }
    .card-head{
      padding: 1.15rem 1.25rem 0.9rem;
      border-bottom: 1px solid rgba(246,211,122,0.14);
    }
    .title{
      font-size: 2.0rem;
      letter-spacing: .28em;
      text-indent: .28em;
      text-shadow: 0 0 18px rgba(246,211,122,0.35);
      font-family: "DFKai-SB","æ¨™æ¥·é«”","Noto Serif TC",serif;
    }
    .sub{
      margin-top:.55rem;
      color: rgba(246,211,122,0.75);
      letter-spacing:.08em;
      line-height: 1.65;
      font-size: .92rem;
    }
    .sub .hint{
      display:inline-block;
      margin-top:.2rem;
      color: rgba(246,211,122,0.65);
      font-size:.86rem;
    }

    /* ======= Table ======= */
    .table-wrap{
      padding: 1.0rem 1.0rem 0.6rem;
      overflow:auto;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing: 0 .55rem;
      min-width: 960px;
    }
    thead th{
      font-size: .86rem;
      color: rgba(246,211,122,0.80);
      letter-spacing: .10em;
      text-indent: .10em;
      font-weight: 600;
      padding: .25rem .35rem;
      white-space: nowrap;
    }
    tbody tr{
      background: rgba(0,0,0,0.40);
    }
    tbody td{
      padding: .3rem .35rem;
      vertical-align: middle;
    }

    .cell-input, .cell-select{
      width: 100%;
      padding: .45rem .7rem;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,0.35);
      background: rgba(0,0,0,0.78);
      color: var(--gold);
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.35);
    }
    .cell-input:focus, .cell-select:focus{
      border-color: rgba(255,238,190,0.85);
      box-shadow: 0 0 12px rgba(246,211,122,0.45);
    }
    .chk{
      width: 18px;
      height: 18px;
      accent-color: #f6d37a;
      cursor:pointer;
    }
    .muted{
      color: rgba(246,211,122,0.45);
      font-size: .85rem;
      letter-spacing:.08em;
    }

    .row-actions{
      display:flex;
      justify-content:flex-end;
      gap:.5rem;
    }
    .btn-danger{
      border-color: rgba(255,160,160,0.35);
      color: rgba(255,200,200,0.95);
      background: radial-gradient(circle at 0% 0%, rgba(255,170,170,0.12), rgba(0,0,0,0.92));
    }

    /* ======= Footer Actions ======= */
    .card-foot{
      padding: 1.0rem 1.0rem 1.1rem;
      border-top: 1px solid rgba(246,211,122,0.12);
      display:flex;
      gap:.7rem;
      flex-wrap:wrap;
      align-items:center;
      justify-content: space-between;
    }
    .left-actions{
      display:flex;
      gap:.6rem;
      flex-wrap:wrap;
      align-items:center;
    }
    .status{
      padding:.34rem 1rem;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,0.25);
      background: rgba(0,0,0,0.35);
      color: rgba(246,211,122,0.72);
      font-size:.82rem;
      letter-spacing:.08em;
    }
    .err{
      margin-top:.65rem;
      padding: .75rem 1rem;
      border-radius: 16px;
      background: rgba(0,0,0,0.65);
      border: 1px solid rgba(255,120,120,0.22);
      color: rgba(255,200,200,0.92);
      white-space: pre-line;
      box-shadow: 0 14px 28px rgba(0,0,0,0.75);
    }

    /* ======= Token Overlay (reuse look) ======= */
    .token-overlay{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 1200;
      background: radial-gradient(circle at 50% 18%, rgba(255, 228, 170, 0.32), rgba(0, 0, 0, 0.98));
    }
    .token-box{
      width: min(620px, 94vw);
      padding: 1.6rem 1.6rem 1.2rem;
      border-radius: 18px;
      background: radial-gradient(circle at 0% 0%, rgba(246, 211, 122, 0.22), rgba(0, 0, 0, 0.95));
      border: 1px solid rgba(246, 211, 122, 0.35);
      box-shadow: 0 0 28px rgba(0,0,0,0.92), 0 0 26px rgba(246,211,122,0.18);
      color: var(--gold-soft);
    }
    .token-title{
      text-align:center;
      font-size: 1.15rem;
      letter-spacing: 0.18em;
      text-indent: 0.18em;
      margin-bottom: 0.6rem;
      text-shadow: 0 0 14px rgba(246,211,122,0.55);
      color: rgba(246,211,122,0.92);
    }
    .token-hint{
      font-size: 0.9rem;
      line-height: 1.75;
      color: rgba(246,211,122,0.78);
      margin-bottom: 0.8rem;
      white-space: pre-line;
    }
    .token-row{ display:flex; align-items:center; gap: 0.5rem; margin-top: .5rem; flex-wrap: wrap; }
    .token-input{
      flex: 1 1 auto;
      width: 100%;
      padding: 0.55rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.5);
      background: rgba(0, 0, 0, 0.82);
      color: var(--gold);
      outline: none;
    }
    .token-eye{
      padding: 0.26rem 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.8);
      background: rgba(0,0,0,0.86);
      color: var(--gold);
      cursor: pointer;
      white-space: nowrap;
    }
    .token-btn{
      border: 1px solid rgba(246,211,122,0.72);
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,0.22), rgba(0,0,0,0.92));
      color: var(--gold);
      border-radius: 999px;
      padding: 0.42rem 1.05rem;
      cursor: pointer;
      letter-spacing: 0.12em;
      text-indent: 0.12em;
      white-space: nowrap;
    }
    .token-btn.ghost{ opacity:.85; border-color: rgba(246,211,122,0.45); }
    .token-actions{
      margin-top: .95rem;
      display:flex;
      justify-content:flex-end;
      gap:.55rem;
      flex-wrap:wrap;
    }
    .token-msg{
      margin-top:.65rem;
      min-height: 1.2rem;
      font-size:.85rem;
      color: rgba(255,200,200,0.95);
      white-space: pre-line;
    }
    .mini-pill{
      display:inline-block;
      padding: .2rem .6rem;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,0.35);
      background: rgba(0,0,0,0.55);
      color: rgba(246,211,122,0.85);
      font-size: .82rem;
      margin-left: .35rem;
      letter-spacing: .06em;
      text-indent: .06em;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; color: rgba(255,240,200,0.96); }
  </style>
</head>

<body>
  <!-- ======= Topbar ======= -->
  <div class="topbar">
    <div class="pill" id="userPill">ç›®å‰ä½¿ç”¨è€…ï¼šæœªç™»å…¥</div>

    <!-- Desktop buttons -->
    <button class="btn desktop-only" id="btnSwitch">åˆ‡æ›å¸³è™Ÿ</button>
    <button class="btn desktop-only" id="btnHome">è¿”å›é¦–é </button>
    <button class="btn desktop-only" id="btnToken">è¨­å®š Token</button>
    <button class="btn desktop-only" id="btnCloudPull">é›²ç«¯ä¸‹è¼‰</button>
    <button class="btn desktop-only" id="btnCloudPush">å„²å­˜ä¸¦ä¸Šå‚³</button>

    <!-- Mobile: è¿”å› / æ›´å¤š -->
    <div class="mbar">
      <button class="btn" id="mBtnBack">è¿”å›</button>
      <div class="menu">
        <button class="btn" id="mBtnMore">æ›´å¤š</button>
        <div class="menu-panel" id="mMenuPanel" aria-hidden="true">
          <button type="button" id="mItemSwitch">åˆ‡æ›å¸³è™Ÿ</button>
          <button type="button" id="mItemToken">è¨­å®š Token</button>
          <button type="button" id="mItemPull">é›²ç«¯ä¸‹è¼‰</button>
          <button type="button" id="mItemPush">å„²å­˜ä¸¦ä¸Šå‚³</button>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="card-head">
        <div class="title">Tasun æ¬Šé™è¡¨</div>
        <div class="sub">
          åªæœ‰ <b>admin</b> å¯ä»¥ç·¨è¼¯ï¼›å…¶ä»–æ¬Šé™åªèƒ½æŸ¥çœ‹ã€‚<br>
          <span class="hint" id="editHint">(å¯ç·¨è¼¯)</span>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>

        <div class="err" id="errBox" style="display:none;"></div>
      </div>

      <div class="card-foot">
        <div class="left-actions">
          <button class="btn" id="btnAddRow">ï¼‹ æ–°å¢ä¸€åˆ—</button>
          <button class="btn" id="btnSaveLocal">åªå„²å­˜æœ¬æ©Ÿ</button>
        </div>
        <div class="status" id="statusPill">ç‹€æ…‹ï¼šæœ¬æ©Ÿæ¨¡å¼</div>
      </div>
    </div>
  </div>

  <!-- ======= Token Overlay ======= -->
  <div class="token-overlay" id="tokenOverlay" aria-hidden="true">
    <div class="token-box">
      <div class="token-title">Dropbox Token è¨­å®šï¼ˆApp folderï¼‰</div>
      <div class="token-hint">
â‘  ä½ çš„ Dropbox å¸³è™Ÿï¼š<b>tasun_8@hotmail.com</b>
â‘¡ ç”¢ç”Ÿ Tokenï¼šConsole â†’ Permissions å‹¾ scopes â†’ Submit â†’ Settings é‡æ–°ç”¢ç”Ÿ Access Token
â‘¢ æœ¬ç³»çµ±æœƒå¯«å…¥ï¼š<b class="mono">/Tasun/æ¬Šé™</b>ï¼ˆApp folder å…§ï¼‰
      </div>

      <div style="margin-top:.2rem;">
        <div style="font-size:.86rem; color:rgba(246,211,122,0.8); margin-bottom:.35rem;">
          Apps å…§ã€ŒApp è³‡æ–™å¤¾åã€<span class="mini-pill">ä¾‹å¦‚ï¼šwutasun</span>
        </div>
        <input class="token-input" id="appNameInput" type="text" placeholder="ä¾‹å¦‚ï¼šwutasun" />
      </div>

      <div style="margin-top:.65rem;">
        <div style="font-size:.86rem; color:rgba(246,211,122,0.8); margin-bottom:.35rem;">
          App keyï¼ˆç”¨ä¾†ç›´æ¥é–‹ Permissions / Settingsï¼‰<span class="mini-pill">ä¾‹å¦‚ï¼ša5pm08kyb0bybdt</span>
        </div>
        <div class="token-row">
          <input class="token-input" id="appKeyInput" type="text" placeholder="è²¼ä¸Š App keyï¼ˆinfo/<é€™ä¸²>#settingsï¼‰" />
          <button class="token-btn ghost" id="btnOpenPerm" type="button">é–‹ Permissions</button>
          <button class="token-btn ghost" id="btnOpenSet" type="button">é–‹ Settings</button>
        </div>
      </div>

      <div style="margin-top:.7rem; font-size:.86rem; color:rgba(246,211,122,0.8); margin-bottom:.35rem;">
        Access Tokenï¼ˆä»¥ sl. é–‹é ­ï¼‰
      </div>
      <div class="token-row">
        <input class="token-input" id="tokenInput" type="password" placeholder="è²¼ä¸Š Access Tokenï¼ˆsl. é–‹é ­ï¼‰" />
        <button class="token-eye" id="tokenEyeBtn" type="button">ğŸ‘</button>
      </div>

      <div class="token-msg" id="tokenMsg"></div>

      <div class="token-actions">
        <button class="token-btn ghost" id="tokenGuideBtn" type="button">ä¸€æ­¥ä¸€æ­¥å°è¦½ï¼ˆè‡ªå‹•é–‹é€£çµï¼‰</button>
        <button class="token-btn ghost" id="tokenCloseBtn" type="button">é—œé–‰</button>
        <button class="token-btn" id="tokenSaveBtn" type="button">å„²å­˜ä¸¦æ¸¬è©¦</button>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // keys & constants
    // ==========================
    const AUTH_KEY    = "tasunAuthTable_v1";
    const NAV_KEY     = "tasunNavButtons_v1";
    const CURRENT_KEY = "tasunCurrentUser_v1";

    const DBX_TOKEN_KEY   = "tasunDbxToken_v1";
    const DBX_FOLDER_KEY  = "tasunDbxFolder_v1";
    const DBX_APPNAME_KEY = "tasunDbxAppName_v1";
    const DBX_APPKEY_KEY  = "tasunDbxAppKey_v1";

    const DEFAULT_DBX_FOLDER = "/Tasun/æ¬Šé™";
    const DEFAULT_APP_NAME = "wutasun";
    const EXPECT_EMAIL = "tasun_8@hotmail.com";

    const AUTH_BRIDGE_CH = "tasunAuthBridge_v1";
    const TAB_ID_KEY = "tasunTabId_v1";
    const TAB_ID = (() => {
      let v = sessionStorage.getItem(TAB_ID_KEY);
      if(!v){
        v = "tab_" + Date.now() + "_" + Math.random().toString(16).slice(2);
        sessionStorage.setItem(TAB_ID_KEY, v);
      }
      return v;
    })();
    let bc = null, bcReady = false;

    // ==========================
    // UI refs
    // ==========================
    const userPill = document.getElementById("userPill");
    const editHint = document.getElementById("editHint");
    const statusPill = document.getElementById("statusPill");
    const errBox = document.getElementById("errBox");

    const btnSwitch = document.getElementById("btnSwitch");
    const btnHome = document.getElementById("btnHome");
    const btnToken = document.getElementById("btnToken");
    const btnCloudPull = document.getElementById("btnCloudPull");
    const btnCloudPush = document.getElementById("btnCloudPush");

    const mBtnBack = document.getElementById("mBtnBack");
    const mBtnMore = document.getElementById("mBtnMore");
    const mMenuPanel = document.getElementById("mMenuPanel");
    const mItemSwitch = document.getElementById("mItemSwitch");
    const mItemToken  = document.getElementById("mItemToken");
    const mItemPull   = document.getElementById("mItemPull");
    const mItemPush   = document.getElementById("mItemPush");

    const thead = document.getElementById("thead");
    const tbody = document.getElementById("tbody");

    const btnAddRow = document.getElementById("btnAddRow");
    const btnSaveLocal = document.getElementById("btnSaveLocal");

    // Token overlay
    const tokenOverlay = document.getElementById("tokenOverlay");
    const appNameInput = document.getElementById("appNameInput");
    const appKeyInput  = document.getElementById("appKeyInput");
    const tokenInput   = document.getElementById("tokenInput");
    const tokenEyeBtn  = document.getElementById("tokenEyeBtn");
    const tokenMsg     = document.getElementById("tokenMsg");
    const tokenGuideBtn= document.getElementById("tokenGuideBtn");
    const tokenCloseBtn= document.getElementById("tokenCloseBtn");
    const tokenSaveBtn = document.getElementById("tokenSaveBtn");
    const btnOpenPerm  = document.getElementById("btnOpenPerm");
    const btnOpenSet   = document.getElementById("btnOpenSet");

    // ==========================
    // helpers
    // ==========================
    function safeJsonParse(s, fallback){ try{ return JSON.parse(s); }catch(e){ return fallback; } }
    function mapRole(v){
      const s = String(v ?? "").trim().toLowerCase();
      if(!s) return "";
      if(s==="admin") return "admin";
      if(s==="write" || s==="edit") return "write";
      if(s==="read"  || s==="view") return "read";
      if(s==="0") return "admin";
      if(s==="1") return "write";
      if(s==="2") return "read";
      return s;
    }
    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    // âœ… Dropbox-API-Arg è½‰ ASCIIï¼šé¿å… iOS/Safari header TypeError
    function jsonAscii(obj){
      return JSON.stringify(obj).replace(/[^\x00-\x7F]/g, (c)=>{
        const code = c.charCodeAt(0).toString(16).padStart(4,"0");
        return "\\u" + code;
      });
    }

    async function fetchWithTimeout(url, options={}, timeoutMs=15000){
      const ctrl = new AbortController();
      const id = setTimeout(()=> ctrl.abort(), timeoutMs);
      try{ return await fetch(url, { ...options, signal: ctrl.signal }); }
      finally{ clearTimeout(id); }
    }

    // ==========================
    // session user (ä¸æ”¹è¦å‰‡)
    // ==========================
    function getCurrentUser(){
      const cu = safeJsonParse(sessionStorage.getItem(CURRENT_KEY) || "null", null);
      if(!cu || typeof cu !== "object") return null;
      const username = String(cu.username ?? "").trim();
      if(!username) return null;
      const role = mapRole(cu.role ?? cu.level) || "read";
      const out = { username, role, level: role };
      sessionStorage.setItem(CURRENT_KEY, JSON.stringify(out));
      return out;
    }

    // ==========================
    // BroadcastChannel bridge
    // ==========================
    function bcPost(msg){
      if(!bcReady || !bc) return;
      try{ bc.postMessage({ ...msg, _from: TAB_ID, _ts: Date.now() }); }catch(e){}
    }
    function initAuthBridge(){
      if(typeof BroadcastChannel === "undefined") return;
      try{
        bc = new BroadcastChannel(AUTH_BRIDGE_CH);
        bcReady = true;
        bc.onmessage = async (ev)=>{
          const m = ev && ev.data ? ev.data : null;
          if(!m || m._from === TAB_ID) return;

          if(m.type === "who"){
            const cu = getCurrentUser();
            if(cu && cu.username) bcPost({ type:"login", user: cu, _replyTo: m._from });
            return;
          }
          if(m.type === "login" && m.user && m.user.username){
            const u = m.user;
            sessionStorage.setItem(CURRENT_KEY, JSON.stringify({
              username: String(u.username||"").trim(),
              role: mapRole(u.role ?? u.level) || "read",
              level: mapRole(u.role ?? u.level) || "read"
            }));
            bootRender();
            return;
          }
          if(m.type === "logout"){
            sessionStorage.removeItem(CURRENT_KEY);
            location.href = "index.html";
            return;
          }
          if(m.type === "navChanged" || m.type === "authChanged"){
            bootRender();
            return;
          }
        };
      }catch(e){
        bcReady = false;
        bc = null;
      }
    }

    // ==========================
    // Dropbox helpers
    // ==========================
    function getDbxToken(){ return String(localStorage.getItem(DBX_TOKEN_KEY) || "").trim(); }
    function setDbxToken(t){ localStorage.setItem(DBX_TOKEN_KEY, String(t||"").trim()); }
    function dbxEnabled(){ const t = getDbxToken(); return !!(t && t.length > 20); }
    function dbxAuthHeader(){ return "Bearer " + getDbxToken(); }

    function getDbxFolder(){ return String(localStorage.getItem(DBX_FOLDER_KEY) || DEFAULT_DBX_FOLDER).trim() || DEFAULT_DBX_FOLDER; }
    function getDbxAppName(){ return String(localStorage.getItem(DBX_APPNAME_KEY) || DEFAULT_APP_NAME).trim() || DEFAULT_APP_NAME; }
    function setDbxAppName(n){ localStorage.setItem(DBX_APPNAME_KEY, String(n||"").trim() || DEFAULT_APP_NAME); }

    function getDbxAppKey(){ return String(localStorage.getItem(DBX_APPKEY_KEY) || "").trim(); }
    function setDbxAppKey(k){ localStorage.setItem(DBX_APPKEY_KEY, String(k||"").trim()); }
    function syncAppKeyFromInput(){
      const v = String(appKeyInput?.value || "").trim();
      if(v) setDbxAppKey(v);
      return v || getDbxAppKey();
    }

    function dbxPathAuth(){ return `${getDbxFolder()}/tasunAuthTable_v1.json`; }
    function dbxPathNav(){  return `${getDbxFolder()}/tasunNavButtons_v1.json`; }
    function dbxPathMeta(){ return `${getDbxFolder()}/tasunCloudMeta_v1.json`; }

    function dropboxWebFolderUrl(){
      const appName = encodeURIComponent(getDbxAppName());
      return `https://www.dropbox.com/home/Apps/${appName}${getDbxFolder()}`;
    }

    async function ensureFolder(){
      const res = await fetchWithTimeout("https://api.dropboxapi.com/2/files/create_folder_v2", {
        method:"POST",
        cache:"no-store",
        headers:{ "Authorization": dbxAuthHeader(), "Content-Type":"application/json" },
        body: JSON.stringify({ path: getDbxFolder(), autorename:false })
      }, 15000);
      const txt = await res.text();
      if(res.ok) return { ok:true, msg:"âœ… è³‡æ–™å¤¾å·²å»ºç«‹/ç¢ºèª" };
      if(res.status === 409 && (txt||"").toLowerCase().includes("conflict")) return { ok:true, msg:"âœ… è³‡æ–™å¤¾å·²å­˜åœ¨" };
      return { ok:false, msg:`âŒ ç„¡æ³•å»ºç«‹/ç¢ºèªè³‡æ–™å¤¾ï¼ˆHTTP ${res.status}ï¼‰\n${txt}` };
    }

    async function testTokenAndGetEmail(){
      if(!dbxEnabled()) return { ok:false, msg:"âŒ Token æœªè¨­å®š", email:"" };
      try{
        const res = await fetchWithTimeout("https://api.dropboxapi.com/2/users/get_current_account", {
          method:"POST",
          cache:"no-store",
          headers:{ "Authorization": dbxAuthHeader(), "Content-Type":"application/json" },
          body:"null"
        }, 15000);
        const txt = await res.text();
        const json = safeJsonParse(txt, null);
        if(!res.ok) return { ok:false, msg:`âŒ Token ç„¡æ•ˆæˆ–éæœŸï¼ˆHTTP ${res.status}ï¼‰\n${txt}`, email:"" };
        return { ok:true, msg:`âœ… Token OK\nå°æ‡‰å¸³è™Ÿï¼š${json?.email || "(æœªå›å‚³ email)"}`, email: String(json?.email||"") };
      }catch(e){
        return { ok:false, msg:"âŒ Token æ¸¬è©¦å¤±æ•—ï¼ˆé€¾æ™‚/ç¶²è·¯ï¼‰", email:"" };
      }
    }

    async function dbxDownloadJson(path){
      if(!dbxEnabled()) return null;
      try{
        const res = await fetchWithTimeout("https://content.dropboxapi.com/2/files/download", {
          method:"POST",
          cache:"no-store",
          headers:{
            "Authorization": dbxAuthHeader(),
            "Dropbox-API-Arg": jsonAscii({ path })
          }
        }, 15000);
        if(!res.ok) return null;
        const text = await res.text();
        return safeJsonParse(text, null);
      }catch(e){
        return null;
      }
    }

    async function dbxUploadJson(path, obj){
      if(!dbxEnabled()) return { ok:false, msg:"âŒ Token æœªè¨­å®š" };

      const body = JSON.stringify(obj, null, 2);
      const res = await fetchWithTimeout("https://content.dropboxapi.com/2/files/upload", {
        method:"POST",
        cache:"no-store",
        headers:{
          "Authorization": dbxAuthHeader(),
          "Content-Type": "application/octet-stream",
          "Dropbox-API-Arg": jsonAscii({
            path,
            mode: "overwrite",
            autorename: false,
            mute: true
          })
        },
        body
      }, 20000);

      const txt = await res.text();
      if(!res.ok) return { ok:false, msg:`âŒ ä¸Šå‚³å¤±æ•—ï¼ˆHTTP ${res.status}ï¼‰\n${txt}` };
      return { ok:true, msg:"âœ… å·²ä¸Šå‚³é›²ç«¯" };
    }

    function getLocalUpdatedAt(){
      const v = Number(localStorage.getItem("tasunCloudUpdatedAt_v1") || "0");
      return isFinite(v) ? v : 0;
    }
    function setLocalUpdatedAt(ts){
      localStorage.setItem("tasunCloudUpdatedAt_v1", String(ts || 0));
    }

    async function cloudPull({ force=false } = {}){
      if(!dbxEnabled()) return { ok:false, msg:"âŒ Token æœªè¨­å®š" };

      const meta = await dbxDownloadJson(dbxPathMeta());
      const cloudTs = Number(meta?.updatedAt || 0);
      const localTs = getLocalUpdatedAt();
      if(!force && cloudTs && localTs && cloudTs <= localTs){
        return { ok:true, msg:"âœ… é›²ç«¯ç„¡æ–°è®Šæ›´" };
      }

      const auth = await dbxDownloadJson(dbxPathAuth());
      const nav  = await dbxDownloadJson(dbxPathNav());
      if(auth && Array.isArray(auth)) localStorage.setItem(AUTH_KEY, JSON.stringify(auth));
      if(nav  && Array.isArray(nav))  localStorage.setItem(NAV_KEY,  JSON.stringify(nav));
      if(cloudTs) setLocalUpdatedAt(cloudTs);

      bcPost({ type:"authChanged" });
      bcPost({ type:"navChanged" });

      return { ok:true, msg:"âœ… å·²å¾é›²ç«¯ä¸‹è¼‰æ›´æ–°" };
    }

    async function cloudPush(){
      if(!dbxEnabled()) return { ok:false, msg:"âŒ Token æœªè¨­å®š" };

      const folderChk = await ensureFolder();
      if(!folderChk.ok) return folderChk;

      const auth = safeJsonParse(localStorage.getItem(AUTH_KEY) || "[]", []);
      const nav  = safeJsonParse(localStorage.getItem(NAV_KEY)  || "[]", []);

      const ts = Date.now();
      const up1 = await dbxUploadJson(dbxPathAuth(), auth);
      if(!up1.ok) return up1;

      const up2 = await dbxUploadJson(dbxPathNav(), nav);
      if(!up2.ok) return up2;

      const up3 = await dbxUploadJson(dbxPathMeta(), { updatedAt: ts });
      if(!up3.ok) return up3;

      setLocalUpdatedAt(ts);

      bcPost({ type:"authChanged" });
      bcPost({ type:"navChanged" });

      return { ok:true, msg:"âœ… å·²å„²å­˜ä¸¦ä¸Šå‚³ï¼ˆé›²ç«¯åŒæ­¥å®Œæˆï¼‰" };
    }

    // ==========================
    // NAV & AUTH load/normalize
    // ==========================
    const DEFAULT_NAV = [
      { id: "btn1", label: "è‡»é¼æ™‚ä»£å¤§å»ˆç®¡ç†è¡¨", href: "è‡»é¼ç®¡ç†è¡¨.html", target: "", roles: ["admin","write","read"] },
      { id: "btn2", label: "ç¼ºå¤± / å“è³ª",       href: "ç”„é¼quality.html", target: "", roles: ["admin","write","read"] },
      { id: "btn3", label: "é›²ç«¯æª”æ¡ˆ",          href: "https://www.dropbox.com/", target: "_blank", roles: ["admin","write","read"] },
      { id: "btn4", label: "å·¥ç¨‹è³‡æ–™åº«",        href: "å·¥ç¨‹è³‡æ–™åº«.html", target: "", roles: ["admin","write"] },
      { id: "btn5", label: "è³‡æ–™åº«",            href: "#", target: "", roles: ["admin","write","read"] }
    ];
    function normalizeNavEntry(entry, index){
      const base = DEFAULT_NAV[index] || {};
      const label = (entry?.label ? String(entry.label).trim() : "") || base.label || `æŒ‰éˆ•${index+1}`;
      const href  = (entry?.href  ? String(entry.href).trim()  : "") || base.href  || "#";
      const target= (entry?.target? String(entry.target).trim(): "") || base.target|| "";
      const roles = Array.isArray(entry?.roles) ? entry.roles.slice()
        : (Array.isArray(base.roles) ? base.roles.slice() : ["admin","write","read"]);
      return { id:`btn${index+1}`, label, href, target, roles };
    }
    function loadNavConfig(){
      const raw = localStorage.getItem(NAV_KEY);
      if(!raw){
        localStorage.setItem(NAV_KEY, JSON.stringify(DEFAULT_NAV.slice()));
        return DEFAULT_NAV.slice();
      }
      const arr = safeJsonParse(raw, null);
      if(!Array.isArray(arr) || !arr.length){
        localStorage.setItem(NAV_KEY, JSON.stringify(DEFAULT_NAV.slice()));
        return DEFAULT_NAV.slice();
      }
      const fixed = arr.map((it, idx)=> normalizeNavEntry(it, idx));
      localStorage.setItem(NAV_KEY, JSON.stringify(fixed));
      return fixed;
    }

    function makeDefaultButtons(count, role){
      const r = mapRole(role)||"read";
      if(r==="admin" || r==="write") return Array(count).fill(true);
      // readï¼šç¶­æŒä½ åŸæœ¬é‚è¼¯ã€Œåªé–‹æœ€å¾Œä¸€é¡†ã€
      const a = Array(count).fill(false);
      if(count>0) a[count-1]=true;
      return a;
    }

    function loadAuthTable(btnCount){
      const raw = localStorage.getItem(AUTH_KEY);
      let arr = safeJsonParse(raw || "null", null);
      if(!Array.isArray(arr) || !arr.length){
        arr = [
          { username:"alex",  password:"Tasun08040224", level:"admin", buttons: makeDefaultButtons(btnCount,"admin") },
          { username:"tasun", password:"tasun08040224", level:"write", buttons: makeDefaultButtons(btnCount,"write") },
          { username:"wu",    password:"123456",        level:"read",  buttons: makeDefaultButtons(btnCount,"read")  },
        ];
        localStorage.setItem(AUTH_KEY, JSON.stringify(arr));
      }

      // normalize to new btnCount
      const fixed = arr.map(r=>{
        const username = String(r?.username||"").trim();
        const password = String(r?.password||"");
        const level = mapRole(r?.level ?? r?.role) || "read";
        let buttons = Array.isArray(r?.buttons) ? r.buttons.slice() : [];
        const out = [];
        for(let i=0;i<btnCount;i++){
          if(i < buttons.length) out[i] = !!buttons[i];
          else out[i] = (level==="admin" || level==="write"); // âœ… æ–°å¢æ¬„ä½é è¨­ï¼šadmin/write trueã€read false
        }
        return { username, password, level, role: level, buttons: out };
      });

      localStorage.setItem(AUTH_KEY, JSON.stringify(fixed));
      return fixed;
    }

    // ==========================
    // page state
    // ==========================
    let NAV = [];
    let AUTH = [];
    let me = null;
    let isAdmin = false;

    function setErr(msg){
      if(!msg){
        errBox.style.display = "none";
        errBox.textContent = "";
        return;
      }
      errBox.style.display = "block";
      errBox.textContent = msg;
    }

    // ==========================
    // render
    // ==========================
    function render(){
      NAV = loadNavConfig();
      AUTH = loadAuthTable(NAV.length);

      me = getCurrentUser();
      if(!me || !me.username){
        // æ¬Šé™è¡¨å»ºè­°ç”±é¦–é é€²ä¾†ï¼Œè‹¥æ²’æœ‰ session å°±å›é¦–é 
        location.href = "index.html";
        return;
      }

      const myRow = AUTH.find(r => r.username === me.username);
      const myLevel = mapRole(myRow?.level ?? me.level) || "read";
      isAdmin = (myLevel === "admin");

      userPill.textContent = `ç›®å‰ä½¿ç”¨è€…ï¼š${me.username} (${myLevel})`;
      editHint.textContent = isAdmin ? "(å¯ç·¨è¼¯)" : "(åƒ…æŸ¥çœ‹)";
      statusPill.textContent = dbxEnabled() ? "ç‹€æ…‹ï¼šå·²è¨­å®š Tokenï¼ˆå¯åŒæ­¥ï¼‰" : "ç‹€æ…‹ï¼šæœ¬æ©Ÿæ¨¡å¼";

      // header
      const navHeaders = NAV.map(n => n.label || n.id);
      let ths = `
        <tr>
          <th>ä½¿ç”¨è€…</th>
          <th>å¯†ç¢¼</th>
          <th>æ¬Šé™</th>
          ${navHeaders.map(h => `<th>${escapeHtml(h)}</th>`).join("")}
          <th>ç³»çµ±/æ¬Šé™</th>
          <th>åˆªé™¤</th>
        </tr>
      `;
      thead.innerHTML = ths;

      // body
      tbody.innerHTML = "";
      AUTH.forEach((row, rowIndex)=>{
        const tr = document.createElement("tr");

        // user
        const tdUser = document.createElement("td");
        tdUser.innerHTML = `<input class="cell-input" data-k="username" value="${escapeHtml(row.username)}" ${isAdmin ? "" : "disabled"} />`;
        tr.appendChild(tdUser);

        // pwd
        const tdPwd = document.createElement("td");
        tdPwd.innerHTML = `<input class="cell-input" data-k="password" value="${escapeHtml(row.password)}" ${isAdmin ? "" : "disabled"} />`;
        tr.appendChild(tdPwd);

        // role
        const tdRole = document.createElement("td");
        tdRole.innerHTML = `
          <select class="cell-select" data-k="level" ${isAdmin ? "" : "disabled"}>
            <option value="admin" ${row.level==="admin"?"selected":""}>admin</option>
            <option value="write" ${row.level==="write"?"selected":""}>write</option>
            <option value="read"  ${row.level==="read" ?"selected":""}>read</option>
          </select>
        `;
        tr.appendChild(tdRole);

        // nav buttons
        for(let i=0;i<NAV.length;i++){
          const td = document.createElement("td");
          td.style.textAlign = "center";
          td.innerHTML = `<input type="checkbox" class="chk" data-k="btn" data-i="${i}" ${row.buttons[i] ? "checked":""} ${isAdmin ? "" : "disabled"} />`;
          tr.appendChild(td);
        }

        // system/permission (fixed admin-only)
        const tdSys = document.createElement("td");
        tdSys.style.textAlign = "center";
        tdSys.innerHTML = (row.level === "admin") ? "âœ“" : `<span class="muted">â€”</span>`;
        tr.appendChild(tdSys);

        // delete
        const tdDel = document.createElement("td");
        tdDel.innerHTML = `
          <div class="row-actions">
            <button class="btn btn-danger" data-act="del" ${isAdmin ? "" : "disabled"}>åˆªé™¤</button>
          </div>
        `;
        tr.appendChild(tdDel);

        // events for inputs
        tr.addEventListener("input", (e)=>{
          if(!isAdmin) return;
          const el = e.target;
          if(!(el instanceof HTMLElement)) return;

          if(el.matches('input[data-k="username"]')){
            AUTH[rowIndex].username = String(el.value||"").trim();
          }else if(el.matches('input[data-k="password"]')){
            AUTH[rowIndex].password = String(el.value||"");
          }else if(el.matches('select[data-k="level"]')){
            const v = mapRole(el.value) || "read";
            AUTH[rowIndex].level = v;
            AUTH[rowIndex].role = v;

            // âœ… è‹¥æ”¹æˆ read/admin/writeï¼Œå°ã€Œæ–°å¢æ¬„ä½ã€æ²’å€¼æ™‚å·²è™•ç†ï¼›é€™è£¡åªåˆ·æ–° system column
            render(); // é‡æ–°æ¸²æŸ“ä¸€æ¬¡ï¼ˆä¿æŒç°¡å–®ä¸”ä¸€è‡´ï¼‰
          }else if(el.matches('input[data-k="btn"]')){
            const idx = Number(el.getAttribute("data-i") || "0");
            AUTH[rowIndex].buttons[idx] = !!el.checked;
          }
        });

        tr.addEventListener("click", (e)=>{
          const el = e.target;
          if(!(el instanceof HTMLElement)) return;
          if(el.matches('button[data-act="del"]')){
            if(!isAdmin) return;
            const ok = confirm(`ç¢ºå®šåˆªé™¤ä½¿ç”¨è€…ï¼š${AUTH[rowIndex].username} ?`);
            if(!ok) return;
            AUTH.splice(rowIndex, 1);
            saveLocal({ silent:true });
            render();
          }
        });

        tbody.appendChild(tr);
      });

      setErr("");
    }

    function saveLocal({ silent=false } = {}){
      // basic sanitize: remove empty usernames
      const cleaned = (AUTH||[]).map(r=>{
        const u = String(r.username||"").trim();
        const p = String(r.password||"");
        const lvl = mapRole(r.level)||"read";
        const btns = Array.isArray(r.buttons) ? r.buttons.slice(0, NAV.length) : Array(NAV.length).fill(false);
        return { username:u, password:p, level:lvl, role:lvl, buttons:btns };
      }).filter(r=> r.username);

      localStorage.setItem(AUTH_KEY, JSON.stringify(cleaned));

      // âœ… é€šçŸ¥é¦–é /å…¶ä»–åˆ†é ç«‹åˆ»æ›´æ–°
      bcPost({ type:"authChanged" });

      if(!silent) setErr("âœ… å·²å„²å­˜åˆ°æœ¬æ©Ÿ localStorage");
    }

    // ==========================
    // Token overlay controls
    // ==========================
    function showTokenOverlay(){
      tokenOverlay.style.display = "flex";
      tokenOverlay.setAttribute("aria-hidden","false");
      appNameInput.value = getDbxAppName();
      appKeyInput.value  = getDbxAppKey();
      tokenInput.value   = getDbxToken();
      tokenMsg.textContent = `Dropbox ç¶²ç«™ä½ç½®ï¼ˆApp folderï¼‰ï¼š\n${dropboxWebFolderUrl()}`;
      setTimeout(()=> (appNameInput||tokenInput).focus(), 60);
    }
    function hideTokenOverlay(){
      tokenOverlay.style.display = "none";
      tokenOverlay.setAttribute("aria-hidden","true");
      tokenMsg.textContent = "";
    }

    function getConsoleBaseUrl(){
      const k = syncAppKeyFromInput();
      return k ? `https://www.dropbox.com/developers/apps/info/${encodeURIComponent(k)}` : "";
    }
    function getConsolePermUrl(){ const b = getConsoleBaseUrl(); return b ? (b + "#permissions") : ""; }
    function getConsoleSetUrl(){  const b = getConsoleBaseUrl(); return b ? (b + "#settings") : ""; }
    function openConsoleTab(url, label){
      syncAppKeyFromInput();
      if(!url){
        alert(`å°šæœªå¡« App keyï¼Œç„¡æ³•ç›´æ¥é–‹ ${label}ã€‚\n\nè«‹è²¼ä¸Šï¼šç¶²å€ info/<App key>#settings é‚£ä¸²ã€‚`);
        return false;
      }
      const w = window.open(url, "_blank", "noopener");
      if(!w) alert("ç€è¦½å™¨å°é–å½ˆå‡ºè¦–çª—ï¼Œè«‹å…è¨±æ­¤ç¶²ç«™é–‹æ–°åˆ†é ã€‚");
      return !!w;
    }

    function guideToConsoleStrong(){
      const kNow = syncAppKeyFromInput();
      alert("æ¥ä¸‹ä¾†é€²å…¥å°è¦½ï¼Œæœƒå˜—è©¦è‡ªå‹•é–‹ Permissions / Settingsã€‚æŒ‰ç¢ºå®šé–‹å§‹ã€‚");

      if(!kNow){
        alert("ä½ å°šæœªå¡« App keyï¼Œå› æ­¤ç„¡æ³•ç›´é”ã€‚\næˆ‘å…ˆé–‹ Apps åˆ—è¡¨ï¼šé» App â†’ è¤‡è£½ç¶²å€ info/<é€™ä¸²>#settings çš„ <é€™ä¸²> è²¼å›ä¾†ã€‚");
        window.open("https://www.dropbox.com/developers/apps", "_blank", "noopener");
        return;
      }

      const okPerm = openConsoleTab(getConsolePermUrl(), "Permissions");
      if(okPerm){
        alert("è«‹å‹¾ scopesï¼ˆè‡³å°‘ï¼‰ï¼š\n- files.content.write\n- files.content.read\n- files.metadata.read\nå†æŒ‰ Submitã€‚");
      }
      const okSet = openConsoleTab(getConsoleSetUrl(), "Settings");
      if(okSet){
        alert("å› Settings é‡æ–° Generate æ–° Tokenï¼ˆå‹¾å®Œ scope è¦æ–° token æ‰æœƒç”Ÿæ•ˆï¼‰ã€‚\nè¤‡è£½å¾Œå›æœ¬é æŒ‰ã€Œå„²å­˜ä¸¦æ¸¬è©¦ã€ã€‚");
      }
    }

    tokenEyeBtn.addEventListener("click", ()=> tokenInput.type = (tokenInput.type==="password" ? "text":"password"));
    tokenCloseBtn.addEventListener("click", hideTokenOverlay);
    tokenGuideBtn.addEventListener("click", guideToConsoleStrong);

    // âœ… AppName/AppKey å³æ™‚å­˜ï¼Œé¿å…ã€Œå·²å¡«å»èªªæœªå¡«ã€
    appNameInput.addEventListener("input", ()=> setDbxAppName(String(appNameInput.value||"").trim() || DEFAULT_APP_NAME));
    appKeyInput.addEventListener("input", ()=> setDbxAppKey(String(appKeyInput.value||"").trim()));
    btnOpenPerm.addEventListener("click", ()=> openConsoleTab(getConsolePermUrl(), "Permissions"));
    btnOpenSet.addEventListener("click", ()=> openConsoleTab(getConsoleSetUrl(), "Settings"));

    tokenSaveBtn.addEventListener("click", async ()=>{
      setDbxAppName(String(appNameInput.value||"").trim() || DEFAULT_APP_NAME);
      syncAppKeyFromInput();

      const t = String(tokenInput.value||"").trim();
      if(!t){ tokenMsg.textContent = "è«‹å…ˆè²¼ä¸Š Access Tokenã€‚"; return; }
      setDbxToken(t);

      tokenMsg.textContent = "æ­£åœ¨æ¸¬è©¦ Tokenâ€¦";
      const chk = await testTokenAndGetEmail();
      if(!chk.ok){ tokenMsg.textContent = chk.msg; return; }

      let emailHint = "";
      if(chk.email && chk.email.toLowerCase() !== EXPECT_EMAIL.toLowerCase()){
        emailHint = `\nâš ï¸ token emailï¼š${chk.email}\nä½ æœŸæœ›ï¼š${EXPECT_EMAIL}`;
      }

      tokenMsg.textContent = chk.msg + emailHint + "\n\næ­£åœ¨å»ºç«‹/ç¢ºèªè³‡æ–™å¤¾â€¦";
      const folderChk = await ensureFolder();
      if(!folderChk.ok){
        tokenMsg.textContent =
          chk.msg + emailHint +
          "\n\n" + folderChk.msg +
          "\n\nè‹¥çœ‹åˆ° missing_scope/files.content.writeï¼Œè«‹åˆ° Console å‹¾æ¬Šé™ä¸¦é‡æ–°ç”¢ç”Ÿæ–° tokenã€‚";
        const go = confirm("å¯èƒ½ scopes ä¸è¶³ï¼ˆfiles.content.writeï¼‰ã€‚\nè¦ç¾åœ¨é–‹å°è¦½å» Console å—ï¼Ÿ");
        if(go) guideToConsoleStrong();
        return;
      }

      tokenMsg.textContent =
`${chk.msg}${emailHint}
${folderChk.msg}

Dropbox ç¶²ç«™ä½ç½®ï¼ˆApp folderï¼‰ï¼š
${dropboxWebFolderUrl()}

âœ… Token OK`;
      statusPill.textContent = "ç‹€æ…‹ï¼šå·²è¨­å®š Tokenï¼ˆå¯åŒæ­¥ï¼‰";
      setTimeout(()=> hideTokenOverlay(), 650);
    });

    // ==========================
    // Mobile menu
    // ==========================
    function toggleMenu(){
      const opened = mMenuPanel.style.display === "block";
      mMenuPanel.style.display = opened ? "none" : "block";
      mMenuPanel.setAttribute("aria-hidden", opened ? "true":"false");
    }

    mBtnMore.addEventListener("click", toggleMenu);
    document.addEventListener("click", (e)=>{
      const inside = mMenuPanel.contains(e.target) || e.target === mBtnMore;
      if(!inside){
        mMenuPanel.style.display = "none";
        mMenuPanel.setAttribute("aria-hidden","true");
      }
    });

    // ==========================
    // actions
    // ==========================
    btnHome.addEventListener("click", ()=> location.href = "index.html");
    mBtnBack.addEventListener("click", ()=> location.href = "index.html");

    btnToken.addEventListener("click", showTokenOverlay);
    mItemToken.addEventListener("click", ()=>{ toggleMenu(); showTokenOverlay(); });

    btnSwitch.addEventListener("click", ()=>{ sessionStorage.removeItem(CURRENT_KEY); location.href="index.html"; });
    mItemSwitch.addEventListener("click", ()=>{ toggleMenu(); sessionStorage.removeItem(CURRENT_KEY); location.href="index.html"; });

    btnAddRow.addEventListener("click", ()=>{
      if(!isAdmin){ setErr("åƒ… admin å¯æ–°å¢ã€‚"); return; }
      AUTH.push({
        username: "",
        password: "",
        level: "read",
        role: "read",
        buttons: makeDefaultButtons(NAV.length, "read")
      });
      render();
    });

    btnSaveLocal.addEventListener("click", ()=>{
      if(!isAdmin){ setErr("åƒ… admin å¯å„²å­˜ã€‚"); return; }
      saveLocal({ silent:false });
      render();
    });

    btnCloudPull.addEventListener("click", async ()=>{
      if(!isAdmin){ setErr("åƒ… admin å¯é›²ç«¯ä¸‹è¼‰ã€‚"); return; }
      if(!dbxEnabled()){ setErr("âŒ å°šæœªè¨­å®š Token"); showTokenOverlay(); return; }
      setErr("æ­£åœ¨é›²ç«¯ä¸‹è¼‰â€¦");
      const r = await cloudPull({ force:true });
      setErr(r.msg);
      render();
    });
    mItemPull.addEventListener("click", async ()=>{
      toggleMenu();
      btnCloudPull.click();
    });

    btnCloudPush.addEventListener("click", async ()=>{
      if(!isAdmin){ setErr("åƒ… admin å¯å„²å­˜ä¸¦ä¸Šå‚³ã€‚"); return; }
      saveLocal({ silent:true });
      if(!dbxEnabled()){ setErr("âŒ å°šæœªè¨­å®š Token"); showTokenOverlay(); return; }
      setErr("æ­£åœ¨å„²å­˜ä¸¦ä¸Šå‚³â€¦");
      const r = await cloudPush();
      setErr(r.msg);
      render();
    });
    mItemPush.addEventListener("click", async ()=>{
      toggleMenu();
      btnCloudPush.click();
    });

    // ==========================
    // boot
    // ==========================
    function bootRender(){
      try{
        initAuthBridge();
        bcPost({ type:"who" });
      }catch(e){}
      render();
    }

    // æœ¬æ©Ÿè®Šæ›´ï¼šé¦–é /å…¶ä»–é æ”¹å®Œ NAV/AUTHï¼Œæ¬Šé™è¡¨ç«‹å³é‡ç¹ª
    window.addEventListener("storage", (e)=>{
      const k = e?.key || "";
      if(k === AUTH_KEY || k === NAV_KEY || k === "tasunCloudUpdatedAt_v1"){
        bootRender();
      }
    });

    // ESC close token/menu
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        hideTokenOverlay();
        mMenuPanel.style.display = "none";
        mMenuPanel.setAttribute("aria-hidden","true");
      }
    });

    bootRender();
  </script>
</body>
</html>
