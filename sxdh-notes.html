<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>捷運汐東線事項記錄 · Tasun</title>

  <link rel="icon" href="data:,">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- ✅ 全站版本：要與 tasun-version.json 一致 -->
  <script>window.TASUN_APP_VER="20260127_05";</script>

  <!-- ✅ 進站必鎖定最新版 ?v=APP_VER（避免不同裝置卡舊版） -->
  <script>
  (function(){
    try{
      var APP = (window.TASUN_APP_VER||"").toString().trim();
      if(!APP) return;
      var u = new URL(location.href);
      var cur = (u.searchParams.get("v")||"").toString().trim();
      var KEY = "tasun_force_v_once__sxdh_notes__" + (cur||"none") + "_to_" + APP;
      if(cur !== APP && !sessionStorage.getItem(KEY)){
        sessionStorage.setItem(KEY, "1");
        u.searchParams.set("v", APP);
        location.replace(u.toString());
        return;
      }
    }catch(e){}
  })();
  </script>

  <!-- ✅ 等待 tasun-core / tasun-boot：可 __TASUN_WAIT__.push(fn) -->
  <script>
  (function(){
    var APP = (window.TASUN_APP_VER||"").toString().trim();
    if(!APP) return;

    var WAIT = window.__TASUN_READY__;
    if(!WAIT || typeof WAIT !== "object"){
      var _q = [], _ready = false, _resolve = null;
      var _p = new Promise(function(res){ _resolve = res; });
      WAIT = {
        get ready(){ return _ready; },
        push: function(fn){ if(typeof fn!=="function") return; _ready ? fn() : _q.push(fn); },
        then: function(a,b){ return _p.then(a,b); },
        flush: function(){
          if(_ready) return;
          _ready = true;
          try{ _resolve(true); }catch(e){}
          var list = _q.splice(0);
          for(var i=0;i<list.length;i++){ try{ list[i](); }catch(e){} }
        }
      };
      window.__TASUN_READY__ = WAIT;
    }
    window.__TASUN_WAIT__ = WAIT;

    function addV(src){ return src + (src.indexOf("?")>=0 ? "&" : "?") + "v=" + encodeURIComponent(APP); }
    function hasScript(id){ return !!document.querySelector('script[data-tasun-id="'+id+'"]'); }
    function loadOnce(id, src){
      return new Promise(function(resolve){
        if(hasScript(id)) return resolve(true);
        var s = document.createElement("script");
        s.src = src; s.async = false; s.setAttribute("data-tasun-id", id);
        s.onload = function(){ resolve(true); };
        s.onerror = function(){ resolve(false); };
        document.head.appendChild(s);
      });
    }

    (async function(){
      try{
        if(!window.TasunCore) await loadOnce("tasun-core", addV("tasun-core.js"));
        await loadOnce("tasun-boot", addV("tasun-boot.js"));
      }catch(e){}
      try{ if(!WAIT.ready) WAIT.flush(); }catch(e){}
    })();
  })();
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700;800;900&family=Noto+Serif+TC:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#dbe3e1; --bg1:#c7d4d1;
      --ink:#111;
      --paper: rgba(255,255,255,.96);
      --paper2: rgba(255,255,255,.92);
      --border: rgba(0,0,0,.18);
      --border2: rgba(0,0,0,.28);
      --r:18px;
      --shadow: 0 16px 44px rgba(0,0,0,.10);
      --shadow2: 0 10px 26px rgba(0,0,0,.08);

      --goldHi: rgba(255,254,246,.98);
      --goldText: rgba(246,214,150,.98);
      --goldDeep: rgba(170,110,18,.98);

      --strokeBlack: rgba(0,0,0,.58);
      --strokeBlackStrong: rgba(0,0,0,.72);
      --olPx: .78px;

      --titleSize: clamp(28px, 2.6vw, 42px);
      --subSize:   clamp(12.5px, 1.05vw, 15.5px);
      --labelSize: clamp(13.5px, 1.00vw, 15.5px);
      --ctrlSize:  clamp(13.5px, 1.05vw, 16px);
      --thSize:    clamp(15px, 1.10vw, 17px);
      --tdSize:    clamp(14.5px, 1.06vw, 16.5px);

      --readBody:  clamp(14.5px, 1.10vw, 17.5px);

      --btnFont: clamp(14.5px, 1.12vw, 17px);
      --btnFontSmall: clamp(13.5px, 1.06vw, 16px);

      --stageSide: clamp(16px, 3.2vw, 1.6cm);

      --tableWrapBg: rgba(255,252,244,.94);
      --tableBg: rgba(255,252,244,.92);
      --tableHeadBg: rgba(252,240,218,.96);
      --tableStripe: rgba(40,120,90,.035);
      --tableHover: rgba(170,110,18,.060);
      --tableSel: rgba(170,110,18,.120);
      --tableLine: rgba(90,60,20,.180);
      --tableText: rgba(22,18,14,.92);
      --tableMuted: rgba(90,60,20,.55);

      --btnBg1: rgba(255,255,255,.70);
      --btnBg2: rgba(255,255,255,.54);
      --btnBgGhost1: rgba(255,255,255,.62);
      --btnBgGhost2: rgba(255,255,255,.46);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    html{
      background:
        radial-gradient(1000px 560px at 50% 120px, rgba(255,255,255,.55), transparent 64%),
        radial-gradient(1200px 900px at 32% 36%, rgba(255,255,255,.40), transparent 68%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    body{
      margin:0; color:var(--ink);
      font-family:"Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      background: inherit;
      overflow:hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }

    :where(.sub,.label,.pill,.hint,.miniHint,.loginErr,.loginHint,.toast, thead th, tbody td, .noteTag,.noteNo,.noteBody){
      text-shadow:none !important; filter:none !important;
    }

    .goldCrystal{
      display:inline-block;
      --_ol: var(--strokeBlack); --_olpx: var(--olPx);
      background: linear-gradient(180deg, var(--goldHi) 0%, rgba(255,246,224,.98) 18%, var(--goldText) 46%, rgba(226,156,54,.98) 78%, var(--goldHi) 100%);
      -webkit-background-clip:text; background-clip:text;
      color: var(--goldDeep);
      text-shadow:
        var(--_olpx) 0 0 var(--_ol), calc(var(--_olpx)*-1) 0 0 var(--_ol),
        0 var(--_olpx) 0 var(--_ol), 0 calc(var(--_olpx)*-1) 0 var(--_ol),
        var(--_olpx) var(--_olpx) 0 var(--_ol), var(--_olpx) calc(var(--_olpx)*-1) 0 var(--_ol),
        calc(var(--_olpx)*-1) var(--_olpx) 0 var(--_ol), calc(var(--_olpx)*-1) calc(var(--_olpx)*-1) 0 var(--_ol);
    }
    @supports (-webkit-background-clip:text) or (background-clip:text){
      .goldCrystal{ color: transparent; -webkit-text-fill-color: transparent; }
    }

    .wrap{
      width:min(1720px, calc(100vw - (2*var(--stageSide))));
      margin:0 auto;
      padding: 18px 16px 18px;
      height:100vh;
      display:flex; flex-direction:column; gap:16px;
    }

    .topbar{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      gap:12px; align-items:center;
      padding:14px 14px;
      border:1px solid var(--border2);
      border-radius:var(--r);
      background: linear-gradient(180deg, var(--paper), var(--paper2));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    @media (max-width:920px){
      .topbar{grid-template-columns:1fr}
      .nav-left{order:0} .brand{order:1} .right{order:2; justify-content:flex-start}
    }

    .nav-left{display:flex; gap:10px; flex-wrap:wrap; align-items:center; min-width:220px;}
    .nav-desktop{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .nav-mobile{display:none; gap:10px; align-items:center; width:100%;}
    @media (max-width:600px){ .nav-desktop{display:none;} .nav-mobile{display:flex;} }

    .brand{display:flex; flex-direction:column; gap:6px; align-items:center; justify-content:center; text-align:center;}
    .title{font-family:"Noto Serif TC","Noto Sans TC",serif; font-weight:820; letter-spacing:.10em; font-size:var(--titleSize); line-height:1.12;}
    .sub{font-size:var(--subSize); color:rgba(0,0,0,.55); letter-spacing:.10em; font-weight:700;}

    .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; min-width:220px;}
    .pill{
      padding:9px 12px; border-radius:999px; border:1px solid var(--border);
      background: rgba(255,255,255,.90); font-size:14px; color: rgba(0,0,0,.78);
      display:flex; gap:8px; align-items:center; white-space:nowrap;
      box-shadow: var(--shadow2); font-weight:800; letter-spacing:.03em;
    }
    .pill b{font-weight:900; color: rgba(0,0,0,.86);}

    .btn{
      position:relative; appearance:none;
      border:1px solid var(--border2);
      background: linear-gradient(180deg, var(--btnBg1), var(--btnBg2));
      padding:11px 16px; border-radius:999px;
      cursor:pointer; font-family:inherit;
      font-weight:720; letter-spacing:.05em;
      font-size: var(--btnFont);
      box-shadow: 0 12px 22px rgba(0,0,0,.10);
      transition:transform .12s ease, border-color .12s ease, box-shadow .12s ease;
      user-select:none; white-space:nowrap;
      color: rgba(0,0,0,.82); overflow:hidden;
    }
    .btn::before{
      content:""; position:absolute; inset:0; pointer-events:none;
      background: radial-gradient(240px 110px at 26% 20%, rgba(255,255,255,.12), transparent 66%);
      opacity:.28; z-index:0;
    }
    .btn:hover{transform:translateY(-1px); border-color: rgba(0,0,0,.40); box-shadow: 0 14px 26px rgba(0,0,0,.12);}
    .btn:active{transform:none}
    .btn.ghost{ background: linear-gradient(180deg, var(--btnBgGhost1), var(--btnBgGhost2)); border:1px solid var(--border); }
    .btn.danger{ border-color: rgba(0,0,0,.42); }
    .small{ padding:10px 14px; font-size: var(--btnFontSmall); }
    .btn[disabled]{opacity:.45; cursor:not-allowed; transform:none !important;}
    .btn .t{
      position:relative; z-index:1; display:inline-block;
      color: rgba(120,64,6,.98);
      font-weight:700; letter-spacing:.04em; line-height:1.12;
      text-shadow:none !important;
    }

    .panel{
      border:1px solid var(--border2);
      border-radius:var(--r);
      background: linear-gradient(180deg, var(--paper), var(--paper2));
      box-shadow: var(--shadow);
      padding:14px;
      flex:1; min-height:0;
      display:flex; flex-direction:column;
      overflow:hidden;
    }

    .panelHead{display:flex; flex-direction:column; gap:10px; flex:0 0 auto;}
    .controls{display:grid; grid-template-columns: 1.3fr .9fr .9fr auto; gap:10px; align-items:end;}
    @media (max-width:920px){ .controls{grid-template-columns:1fr 1fr} }
    @media (max-width:520px){ .controls{grid-template-columns:1fr} }

    .field{display:flex; flex-direction:column; gap:6px;}
    .label{font-size:var(--labelSize); letter-spacing:.08em; font-weight:700; color: rgba(0,0,0,.70); text-align:center;}
    input,select,textarea{
      width:100%;
      border-radius:14px; border:1px solid var(--border2);
      background: rgba(255,255,255,.96); color: rgba(0,0,0,.86);
      padding:11px 12px; font-family:inherit;
      font-size:var(--ctrlSize); font-weight:700;
      outline:none; transition:border-color .12s ease, box-shadow .12s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
    }
    input:focus,select:focus,textarea:focus{ border-color: rgba(0,0,0,.46); box-shadow: 0 0 0 3px rgba(0,0,0,.08), 0 12px 26px rgba(0,0,0,.10); }
    textarea{min-height:92px; resize:vertical;}
    select{ text-align:center; text-align-last:center; font-weight:800; }
    select option{ background:#fff; color: rgba(0,0,0,.88); }

    .hint{
      display:flex; flex-wrap:wrap; gap:8px;
      align-items:center; justify-content:center;
      padding:9px 10px;
      border-radius:14px; border:1px solid var(--border);
      background: rgba(255,255,255,.92);
      box-shadow: 0 12px 26px rgba(0,0,0,.08);
      color: rgba(0,0,0,.78);
      font-size:14px; line-height:1.55;
      font-weight:900; letter-spacing:.04em;
    }
    .hint .hb{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(0,0,0,.14); background: rgba(255,255,255,.86); white-space:nowrap; }
    .hint .hb .k{ color: rgba(0,0,0,.62); font-weight:900; }
    .hint .hb .v{ color: rgba(0,0,0,.84); font-weight:900; }
    .hint .hb.bad .v{ color: rgba(170,60,60,.92); }

    .panelBody{flex:1; min-height:0; display:flex; flex-direction:column;}
    .tableWrap{
      margin-top:4px;
      overflow:auto;
      border-radius:16px;
      border:1px solid var(--border2);
      background: var(--tableWrapBg);
      box-shadow: var(--shadow2);
      flex:1; min-height:0;
      -webkit-overflow-scrolling: touch;
    }

    table{width:100%; border-collapse:collapse; min-width:1460px; background: var(--tableBg);}
    thead th{
      position:sticky; top:0; z-index:3;
      padding:13px 10px;
      border-bottom:1px solid var(--tableLine);
      white-space:nowrap; text-align:center;
      letter-spacing:.06em;
      font-size: var(--thSize);
      font-weight:900;
      color: rgba(30,22,16,.92);
      background: var(--tableHeadBg);
    }
    tbody td{
      padding:13px 10px;
      border-bottom:1px solid var(--tableLine);
      vertical-align:top;
      font-size: var(--tdSize);
      color: var(--tableText);
      line-height:1.75;
      font-weight:700;
      background: transparent;
    }
    tbody tr:nth-child(even) td{ background: var(--tableStripe); }
    tbody tr:hover td{ background: var(--tableHover); }
    tbody tr.sel td{ background: var(--tableSel); }
    .muted{ color: var(--tableMuted); }

    .attBtn{
      display:inline-flex; align-items:center; justify-content:center; gap:6px;
      padding:9px 12px; border-radius:999px;
      border:1px solid var(--border2); background: rgba(255,255,255,.88);
      cursor:pointer; white-space:nowrap;
      box-shadow: 0 10px 20px rgba(0,0,0,.08);
      font-weight:900;
    }
    .attBtn .t{ color: rgba(0,0,0,.82); letter-spacing:.04em; font-weight:900; }

    .mask,.pMask,.loginMask{
      position:fixed; inset:0;
      display:none; align-items:center; justify-content:center;
      padding:20px; z-index:100;
      background: rgba(0,0,0,.45);
    }
    .modal,.pModal,.loginModal{
      width:min(980px, 96vw);
      border-radius:22px; border:1px solid var(--border2);
      background: rgba(255,255,255,.98);
      box-shadow:0 32px 110px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .pModal,.loginModal{ width:min(560px, 96vw); }
    .mHead,.pHead,.loginHead{
      padding:14px 16px;
      display:grid; grid-template-columns: 1fr auto 1fr;
      align-items:center; gap:10px;
      border-bottom:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.98);
      min-height:56px;
    }
    .mTitle,.pTitle,.loginTitle{
      grid-column:2; justify-self:center;
      letter-spacing:.14em;
      font-family:"Noto Serif TC","Noto Sans TC",serif;
      font-size: clamp(16px, 1.6vw, 22px);
      font-weight:900; white-space:nowrap;
    }
    .mHead .btn,.pHead .btn,.loginHead .btn{ grid-column:3; justify-self:end; }
    .mBody,.pBody,.loginBody{ padding:14px 16px 10px; color: rgba(0,0,0,.86); }
    .mFoot,.pFoot,.loginFoot{
      padding:12px 16px;
      display:flex; gap:10px;
      justify-content:flex-end; flex-wrap:wrap;
      border-top:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.98);
    }

    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .span2{grid-column:span 2}
    @media (max-width:720px){
      .grid{grid-template-columns:1fr}
      .span2{grid-column:span 1}
      table{min-width:1240px}
    }
    .inline2{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end}
    @media (max-width:520px){
      .inline2{ grid-template-columns: 1fr; }
      .mHead,.pHead,.loginHead{ grid-template-columns: 1fr auto; }
      .mTitle,.pTitle,.loginTitle{ grid-column:1; justify-self:start; }
      .mHead .btn,.pHead .btn,.loginHead .btn{ grid-column:2; }
    }

    .miniHint{font-size:12px; line-height:1.6; font-weight:700; color: rgba(0,0,0,.55); text-align:center;}
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px; padding:10px 14px;
      border-radius:999px; border:1px solid var(--border2);
      background: rgba(255,255,255,.96); color: rgba(0,0,0,.84);
      font-size:14px; box-shadow: 0 18px 50px rgba(0,0,0,.20);
      display:none; z-index:200; font-weight:800; letter-spacing:.06em;
    }
    .loginErr{
      margin-top:10px; color:rgba(170,60,60,.95);
      font-size:14px; line-height:1.6; display:none; white-space:pre-wrap;
      font-weight:900; text-align:center;
    }
    .loginHint{ margin-top:10px; color: rgba(0,0,0,.60); font-size:12.5px; line-height:1.7; font-weight:700; text-align:center; }

    body.readMode #tbl{ display:none; }
    body.readMode #cards{ display:block !important; padding:10px 6px; }
    body:not(.readMode) #tbl{ display:table; }
    body:not(.readMode) #cards{ display:none !important; }

    #cards{display:none; overflow:auto; max-height:100%; -webkit-overflow-scrolling: touch;}
    .noteCard{
      border-radius:16px; border:1px solid var(--border2);
      background: rgba(255,255,255,.96);
      box-shadow: 0 14px 26px rgba(0,0,0,.10);
      padding:12px; margin:10px 4px;
      color: rgba(0,0,0,.86); cursor:pointer;
    }
    .noteCard.sel{ outline: 2px solid rgba(0,0,0,.18); box-shadow: 0 18px 34px rgba(0,0,0,.12); }
    .noteHead{ display:flex; gap:10px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
    .noteMeta{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; font-weight:900; letter-spacing:.04em; }
    .noteTag{
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(0,0,0,.14);
      background: rgba(0,0,0,.03);
      color: rgba(0,0,0,.78);
      font-size:13px; white-space:nowrap;
    }
    .noteNo{ font-family:"Noto Serif TC","Noto Sans TC",serif; font-weight:900; letter-spacing:.06em; color: rgba(0,0,0,.88); white-space:nowrap; }
    .noteBody{
      margin-top:10px; line-height:1.85;
      font-size: var(--readBody);
      white-space:pre-wrap; word-break:break-word;
      color: rgba(0,0,0,.86);
    }
    .noteCard:not(.open) .noteBody{
      display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;
    }
    .noteMore{ margin-top:10px; display:none; opacity:.92; }
    .noteCard.open .noteMore{ display:block; }

    @media (max-width:720px){
      :root{ --stageSide: 10px; --titleSize: clamp(20px, 5.0vw, 28px); --subSize: clamp(11px, 3.2vw, 13px); --btnFont: 14px; --btnFontSmall: 13px; }
      .wrap{ height:100dvh; padding:10px 10px 12px; gap:10px; }
      .topbar{ padding:10px; gap:10px; }
      .brand{ gap:4px; }
      .pill{ padding:6px 9px; font-size:12.5px; box-shadow: 0 10px 18px rgba(0,0,0,.08); }
      .right{ gap:8px; }
      .btn{ padding:9px 12px; box-shadow: 0 10px 16px rgba(0,0,0,.10); }
      .small{ padding:8px 10px; }
      .panel{ padding:10px; }
      .panelHead{ gap:8px; position:sticky; top:0; z-index:6; background: transparent; }
      .controls{ gap:8px; }
      input,select,textarea{ padding:10px 11px; border-radius:12px; }
      .hint{ justify-content:flex-start; flex-wrap:nowrap; overflow:auto; -webkit-overflow-scrolling: touch; padding:7px 8px; gap:7px; }
      .hint .hb{ flex:0 0 auto; padding:5px 9px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="nav-left">
        <div class="nav-desktop">
          <button class="btn ghost small" id="navBack"><span class="t">返回汐東工程管理表</span></button>
        </div>

        <div class="nav-mobile">
          <button class="btn ghost small" id="mBack"><span class="t">返回</span></button>
          <div style="position:relative; display:inline-flex;">
            <button class="btn ghost small" id="mMoreBtn" type="button"><span class="t">更多 ▾</span></button>
            <div id="mMoreMenu" style="display:none; position:absolute; top:calc(100% + 8px); right:0; min-width:220px; border-radius:16px; border:1px solid rgba(0,0,0,.20); background:rgba(255,255,255,.98); box-shadow:0 18px 50px rgba(0,0,0,.20); padding:8px; z-index:60;">
              <button class="menuItem" data-href="汐東工程管理表.html" type="button" style="width:100%; text-align:left; border:none; background:rgba(0,0,0,.03); color:rgba(0,0,0,.86); padding:10px 12px; border-radius:12px; cursor:pointer; font-family:inherit; letter-spacing:.04em; font-weight:800;">汐東工程管理表</button>
              <div style="height:1px; margin:8px 6px; background:rgba(0,0,0,.10);"></div>
              <button class="menuItem" data-href="index.html" type="button" style="width:100%; text-align:left; border:none; background:rgba(0,0,0,.03); color:rgba(0,0,0,.86); padding:10px 12px; border-radius:12px; cursor:pointer; font-family:inherit; letter-spacing:.04em; font-weight:800;">返回首頁</button>
            </div>
          </div>
        </div>
      </div>

      <div class="brand">
        <div class="title goldCrystal">捷運汐東線事項記錄</div>
        <div class="sub">記事內容 · 工種 · 系統 · 出處 · 附件 · 登錄日期</div>
      </div>

      <div class="right">
        <div class="pill">使用者：<b id="uName">—</b></div>
        <div class="pill">權限：<b id="uRole">—</b></div>

        <button class="btn small" id="btnView"><span class="t">檢視</span></button>
        <button class="btn small" id="btnAdd" style="display:none;"><span class="t">新增</span></button>
        <button class="btn small" id="btnEdit" style="display:none;"><span class="t">編輯</span></button>
        <button class="btn small" id="btnToken" style="display:none;"><span class="t">雲端設定</span></button>
      </div>
    </div>

    <div class="panel">
      <div class="panelHead">
        <div class="controls">
          <div class="field">
            <div class="label">搜尋（記事內容）</div>
            <input id="qText" placeholder="可輸入關鍵字，例如：送審、會議、現勘..." />
          </div>

          <div class="field">
            <div class="label">工種</div>
            <select id="fTrade"><option value="">全部</option></select>
          </div>

          <div class="field">
            <div class="label">系統</div>
            <select id="fSys"><option value="">全部</option></select>
          </div>

          <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
            <button class="btn ghost" id="btnCloud" type="button"><span class="t">雲端檔案</span></button>
            <button class="btn ghost" id="btnExport" type="button"><span class="t">匯出備份</span></button>
            <button class="btn ghost" id="btnRead" type="button"><span class="t">閱讀模式：關</span></button>
            <button class="btn ghost" id="btnClear" type="button"><span class="t">清除條件</span></button>
          </div>
        </div>

        <div class="hint" id="hint"></div>
      </div>

      <div class="panelBody">
        <div class="tableWrap">
          <div id="cards" style="display:none; position:relative; z-index:2;"></div>

          <table id="tbl">
            <thead>
              <tr>
                <th style="width:90px;">項次</th>
                <th>記事內容</th>
                <th style="width:150px;">工種</th>
                <th style="width:150px;">系統</th>
                <th style="width:150px;">出處</th>
                <th style="width:160px;">附件</th>
                <th style="width:220px;">備註</th>
                <th style="width:140px;">登錄日期</th>
                <th style="width:160px;">操作</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit/View Modal -->
  <div class="mask" id="mask">
    <div class="modal">
      <div class="mHead">
        <div></div>
        <div class="mTitle goldCrystal" id="mTitle">查看</div>
        <button class="btn ghost small" id="btnClose" type="button"><span class="t">關閉</span></button>
      </div>

      <div class="mBody">
        <div class="grid">
          <div class="field span2">
            <div class="label">記事內容</div>
            <textarea id="mText" placeholder="請輸入記事內容（可多行）..."></textarea>
          </div>

          <div class="field">
            <div class="label">工種（下拉；可新增選項）</div>
            <div class="inline2">
              <select id="mTradeSel"></select>
              <button class="btn ghost small" id="btnAddTrade" type="button"><span class="t">新增工種</span></button>
            </div>
            <div class="miniHint">選單來源：本頁資料不重複 + 工種字典。</div>
          </div>

          <div class="field">
            <div class="label">系統（下拉；可新增選項）</div>
            <div class="inline2">
              <select id="mSysSel"></select>
              <button class="btn ghost small" id="btnAddSys" type="button"><span class="t">新增系統</span></button>
            </div>
            <div class="miniHint">✅ 系統會依「工種」篩選；可輸入既有系統名稱來「綁定」到目前工種。</div>
          </div>

          <div class="field span2">
            <div class="label">出處（下拉；可新增）</div>
            <div class="inline2">
              <select id="mSourceSel"></select>
              <button class="btn ghost small" id="btnAddSource" type="button"><span class="t">新增出處</span></button>
            </div>
            <div class="miniHint">選單來源：本頁資料「出處」不重複 + 出處字典。</div>
          </div>

          <div class="field span2">
            <div class="label">附件（超連結）</div>
            <div class="inline2">
              <input id="mAttach" placeholder="貼上連結，例如：https://... / Dropbox 連結 / file:///..." />
              <button class="btn ghost small" id="btnNetDisk" type="button"><span class="t">網路硬碟</span></button>
            </div>
            <div class="miniHint">可留空；相對網址會自動帶 v。</div>
          </div>

          <div class="field span2">
            <div class="label">備註</div>
            <textarea id="mRemark" placeholder="可輸入備註（可多行）..."></textarea>
          </div>

          <div class="field">
            <div class="label">登錄日期（可改）</div>
            <input id="mDate" type="date" />
            <div class="miniHint">預設為今日；可用日曆修改。</div>
          </div>

          <div class="field">
            <div class="label">項次</div>
            <input id="mNo" disabled />
          </div>
        </div>
      </div>

      <div class="mFoot">
        <button class="btn danger" id="btnDelete" style="display:none;" type="button"><span class="t">刪除</span></button>
        <button class="btn ghost" id="btnCancel" type="button"><span class="t">取消</span></button>
        <button class="btn" id="btnSave" type="button"><span class="t">儲存</span></button>
      </div>
    </div>
  </div>

  <!-- Prompt：新增 工種/系統/出處 -->
  <div class="pMask" id="pMask">
    <div class="pModal">
      <div class="pHead">
        <div></div>
        <div class="pTitle goldCrystal" id="pTitle">新增</div>
        <button class="btn ghost small" id="pClose" type="button"><span class="t">關閉</span></button>
      </div>
      <div class="pBody">
        <div class="field">
          <div class="label" id="pLabel">請輸入</div>
          <input id="pInput" placeholder="例如：機電 / 土建 / ..."/>
          <div class="miniHint" id="pHint">新增後會加入「選單字典」，且系統會綁到目前工種。</div>
        </div>
      </div>
      <div class="pFoot">
        <button class="btn ghost" id="pCancel" type="button"><span class="t">取消</span></button>
        <button class="btn" id="pOk" type="button"><span class="t">確定新增</span></button>
      </div>
    </div>
  </div>

  <!-- ✅ 雲端設定（D1 + Access） -->
  <div class="loginMask" id="tokenMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="雲端設定">
      <div class="loginHead">
        <div></div>
        <div class="loginTitle goldCrystal" id="cloudCfgTitle">雲端設定（D1 / Access）</div>
        <button class="btn ghost small" id="tokenClose" type="button"><span class="t">關閉</span></button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label" id="cloudCfgLabel">貼上（可擇一）</div>
          <input id="tokenInput" type="password" placeholder="① https://API_BASE ② CLIENT_ID ③ CLIENT_SECRET（用空白或 | 分隔）" autocomplete="off" />
        </div>
        <div class="loginErr" id="tokenErr"></div>
        <div class="loginHint" id="tokenHint">目前狀態：—</div>
        <div class="loginHint">
          ✅ 可貼：<b>API_BASE|CLIENT_ID|CLIENT_SECRET</b>（或空白/逗號分隔）。也可只貼 <b>CLIENT_ID|CLIENT_SECRET</b>。<br>
          若使用「互動登入 Access（cookie）」：可不填 token，只要按「雲端檔案」觸發 Access 登入一次即可。
        </div>
      </div>
      <div class="loginFoot">
        <button class="btn danger" id="tokenClear" type="button"><span class="t">清除</span></button>
        <button class="btn ghost" id="tokenToggle" type="button"><span class="t">顯示/隱藏</span></button>
        <button class="btn ghost" id="tokenNetDisk" type="button"><span class="t">網路硬碟</span></button>
        <button class="btn" id="tokenSave" type="button"><span class="t">儲存</span></button>
      </div>
    </div>
  </div>

  <!-- Login Modal（DOM 保留；登入邏輯由 tasun-core.js 的 TasunCore.Auth 接管） -->
  <div class="loginMask" id="loginMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="登入">
      <div class="loginHead">
        <div></div>
        <div class="loginTitle goldCrystal">登入</div>
        <button class="btn ghost small" id="loginClose" type="button"><span class="t">關閉</span></button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label">帳號</div>
          <select id="loginUser" autocomplete="username"><option value="">請選擇帳號</option></select>
        </div>
        <div class="field" style="margin-top:10px;">
          <div class="label">密碼</div>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="請輸入密碼" />
        </div>
        <div class="loginErr" id="loginErr"></div>
        <div class="loginHint">登入帳密以「權限表.html」(localStorage: <b>tasunAuthTable_v1</b>) 為準。</div>
      </div>
      <div class="loginFoot">
        <button class="btn ghost" id="loginToAuth" type="button"><span class="t">前往權限表</span></button>
        <button class="btn" id="loginBtn" type="button"><span class="t">登入</span></button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
  (function(){
    "use strict";

    function run(){
      var Core = window.TasunCore;
      if(!Core || !Core.Auth){
        console.error("TasunCore/Auth not ready.");
        return;
      }

      var PAGE_KEY = "sxdh-notes";
      Core.init({ pageKey: PAGE_KEY, forceUrlV:true, forceVersionSync:true, patchResources:true, networkToast:false, appHeightVar:false });

      var Auth = Core.Auth;
      var withV = Core.withV || function(h){ return h; };

      // ===== Local keys =====
      var DB_KEY = "tasunSxdhNotes_v1";
      var COUNTER_KEY = "tasunSxdhNotes_counter_v1";
      var READ_MODE_KEY  = "tasunSxdhNotes_readMode_v1";

      var TRADE_DICT_KEY = "tasunSxdhNotes_tradeDict_v1";
      var SYS_DICT_KEY   = "tasunSxdhNotes_sysDict_v1";
      var SOURCE_DICT_KEY = "tasunSxdhNotes_sourceDict_v1";
      var TRADE_SYS_MAP_KEY = "tasunSxdhNotes_tradeSysMap_v1";

      // ===== Cloud keys =====
      var D1_API_BASE_KEY = "tasunD1ApiBase_v1";
      var ACCESS_ST_KEY   = "tasunAccessServiceToken_v1";
      var PROTECT_EMPTY_REMOTE_KEY = "tasun_protect_empty_remote__" + DB_KEY;

      // ===== API paths =====
      var CLOUD_RESOURCE_KEY = PAGE_KEY;
      var CLOUD_PK = "id";  // ✅ 修正：全站統一 pk="id"（禁止 pk="k"）

      var D1_PING_PATH  = "/api/tasun/ping";
      var D1_PULL_PATH  = "/api/tasun/pull";
      var D1_MERGE_PATH = "/api/tasun/merge";

      var NET_DISK_URL = "https://www.dropbox.com/scl/fo/glb4s65934h195bxuyuqm/AH5ClZ2u4MtPMvmgtfOUAa4?rlkey=tfxkpbpw8k9bctshx5xvuge8h&st=9deaoqpw&dl=0";
      var CLOUD_NETDISK_URL = "https://www.dropbox.com/developers/apps";

      var $ = function(id){ return document.getElementById(id); };
      var norm = function(s){ return (s===undefined||s===null) ? "" : String(s).trim(); };
      function pad2(n){ return String(n).padStart(2,"0"); }
      function fmtClock(ts){ if(!ts) return ""; var d = new Date(ts); return pad2(d.getHours())+":"+pad2(d.getMinutes())+":"+pad2(d.getSeconds()); }

      function toast(msg){
        var t = $("toast");
        t.textContent = msg;
        t.style.display = "block";
        clearTimeout(toast._tm);
        toast._tm = setTimeout(function(){ t.style.display="none"; }, 2600);
      }
      function escHtml(s){
        return (s ?? "").toString()
          .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
          .replaceAll('"',"&quot;").replaceAll("'","&#39;");
      }
      function todayISO(){ return new Date().toISOString().slice(0,10); }
      function uuid(){ return "u" + Date.now().toString(16) + "_" + Math.random().toString(16).slice(2); }

      // ===== Data =====
      var db = [];
      var counter = 0;
      var selectedUid = null;
      var editingUid = null; // null => add
      var promptMode = null;
      var cloud = null;
      var lastSyncAt = 0;
      var cloudState = "offline"; // offline | ok | deny | neterr | noapi
      var apiLastStatus = 0;

      // ===== Cloud helpers =====
      function safeJSON(raw){ if(!raw) return null; try{ return JSON.parse(raw); }catch(e){ return null; } }
      function getApiBase(){
        var b = norm(window.TASUN_D1_API_BASE);
        if(b) return b.replace(/\/+$/,"");
        try{ b = norm(sessionStorage.getItem(D1_API_BASE_KEY)); if(b) return b.replace(/\/+$/,""); }catch(e){}
        try{ b = norm(localStorage.getItem(D1_API_BASE_KEY)); if(b) return b.replace(/\/+$/,""); }catch(e){}
        return "";
      }
      function setApiBase(v){
        v = norm(v).replace(/\/+$/,"");
        try{ window.TASUN_D1_API_BASE = v; }catch(e){}
        try{ v ? sessionStorage.setItem(D1_API_BASE_KEY, v) : sessionStorage.removeItem(D1_API_BASE_KEY); }catch(e){}
        try{ v ? localStorage.setItem(D1_API_BASE_KEY, v) : localStorage.removeItem(D1_API_BASE_KEY); }catch(e){}
      }
      function parseStoredToken(raw){
        raw = norm(raw);
        if(!raw) return null;
        var obj = safeJSON(raw);
        if(obj && typeof obj==="object"){
          var id = norm(obj.clientId || obj.id || obj.client_id || "");
          var sec = norm(obj.clientSecret || obj.secret || obj.client_secret || "");
          if(id && sec) return { clientId:id, clientSecret:sec };
        }
        var parts = raw.split(/[\s|,;]+/).map(norm).filter(Boolean);
        if(parts.length>=2) return { clientId:parts[0], clientSecret:parts[1] };
        return null;
      }
      function getAccessToken(){
        try{
          var w = window.TASUN_ACCESS_SERVICE_TOKEN;
          if(w && typeof w==="object"){
            var idw = norm(w.clientId||w.client_id||"");
            var secw = norm(w.clientSecret||w.client_secret||"");
            if(idw && secw) return { clientId:idw, clientSecret:secw };
          }
          if(typeof w==="string"){
            var partsW = w.split(/[\s|,;]+/).map(norm).filter(Boolean);
            if(partsW.length>=2) return { clientId:partsW[0], clientSecret:partsW[1] };
          }
        }catch(e){}
        try{ var s1 = parseStoredToken(sessionStorage.getItem(ACCESS_ST_KEY)); if(s1) return s1; }catch(e){}
        try{ var s2 = parseStoredToken(localStorage.getItem(ACCESS_ST_KEY)); if(s2) return s2; }catch(e){}
        return null;
      }
      function hasAccessToken(){ var t = getAccessToken(); return !!(t && t.clientId && t.clientSecret); }
      function setAccessToken(obj){
        try{ window.TASUN_ACCESS_SERVICE_TOKEN = obj || null; }catch(e){}
        try{ obj ? sessionStorage.setItem(ACCESS_ST_KEY, JSON.stringify(obj)) : sessionStorage.removeItem(ACCESS_ST_KEY); }catch(e){}
        try{ obj ? localStorage.setItem(ACCESS_ST_KEY, JSON.stringify(obj)) : localStorage.removeItem(ACCESS_ST_KEY); }catch(e){}
      }
      function accessHeaders(){
        var t = getAccessToken();
        if(!t) return {};
        return { "CF-Access-Client-Id": t.clientId, "CF-Access-Client-Secret": t.clientSecret };
      }
      function buildUrl(path){
        var base = getApiBase();
        if(/^https?:\/\//i.test(path)) return path;
        if(!path) path = "/";
        if(path[0] !== "/") path = "/" + path;
        return base ? (base + path) : path;
      }
      function portalUrl(){ return buildUrl(D1_PING_PATH); }

      async function httpJSON(url, opt){
        opt = opt || {};
        opt.mode = "cors";
        opt.cache = "no-store";
        opt.credentials = hasAccessToken() ? "omit" : "include";
        opt.headers = Object.assign(
          { "Accept":"application/json" },
          opt.headers||{},
          accessHeaders(),
          {
            "X-Tasun-AppVer": String(window.TASUN_APP_VER||""),
            "X-Tasun-Page": PAGE_KEY,
            "X-Tasun-User": (Auth.current() && Auth.current().username) ? String(Auth.current().username) : "",
            "X-Tasun-Role": String(Auth.role()||"")
          }
        );
        var res;
        try{ res = await fetch(url, opt); }
        catch(err){
          var e2 = new Error(err && err.message ? err.message : "Failed to fetch");
          e2.status = 0; e2.code = "FETCH_FAIL";
          throw e2;
        }
        if(!res.ok){
          var body = "";
          try{ body = await res.text(); }catch(e){}
          var err2 = new Error("HTTP "+res.status+" "+res.statusText);
          err2.status = res.status;
          err2.body = body;
          if(res.status===401 || res.status===403) err2.code = "ACCESS_DENY";
          throw err2;
        }
        apiLastStatus = res.status;
        var ct = (res.headers.get("content-type")||"").toLowerCase();
        if(ct.includes("application/json")) return await res.json();
        var txt = await res.text();
        try{ return JSON.parse(txt); }catch(e){ return { ok:true, raw:txt }; }
      }

      function unwrap(resp){
        var info = (resp && typeof resp==="object") ? (resp.info || resp.meta || {}) : {};
        var p = resp;
        if(p && typeof p==="object"){
          if("payload" in p) p = p.payload;
          else if("data" in p) p = p.data;
          else if("result" in p) p = p.result;
        }
        var out = (p && typeof p==="object") ? p : {};
        if(!Array.isArray(out.db)) out.db = [];
        var c = Number(out.counter||0); if(!Number.isFinite(c) || c<0) c=0;
        out.counter = c;
        return { payload: out, info: info };
      }

      async function apiPull(){
        if(!getApiBase()){
          var e0 = new Error("NO_API_BASE"); e0.status = 0; e0.code = "NO_API_BASE"; throw e0;
        }
        var url = buildUrl(D1_PULL_PATH) + "?key=" + encodeURIComponent(CLOUD_RESOURCE_KEY) + "&_=" + Date.now();
        return await httpJSON(url, { method:"GET" });
      }
      async function apiMerge(localPayload){
        if(!getApiBase()){
          var e0 = new Error("NO_API_BASE"); e0.status = 0; e0.code = "NO_API_BASE"; throw e0;
        }
        var url = buildUrl(D1_MERGE_PATH);
        var body = {
          key: CLOUD_RESOURCE_KEY,
          pk: CLOUD_PK,
          idField: "id",
          counterField: "counter",
          local: localPayload,
          client: { ts: Date.now(), page: PAGE_KEY, user: (Auth.current()&&Auth.current().username)||"", role: String(Auth.role()||""), ua: navigator.userAgent },
          merge: { conflictPolicy: "stash-remote" }
        };
        return await httpJSON(url, { method:"POST", headers: { "Content-Type":"application/json" }, body: JSON.stringify(body) });
      }

      function CloudCtrl(){
        this._timer = 0;
        this._saving = false;
        this._pending = false;
      }
      CloudCtrl.prototype._err = function(e){
        if(!e) return;
        if(e.code==="NO_API_BASE"){ cloudState="noapi"; toast("⚠️ 尚未設定 API_BASE：請按右上「雲端設定」。"); return; }
        if(e.code==="FETCH_FAIL" || e.status===0){ cloudState="neterr"; toast("⚠️ 雲端連線失敗：請確認 API_BASE / CORS / 網路。"); return; }
        if(e.code==="ACCESS_DENY" || e.status===401 || e.status===403){ cloudState="deny"; toast("⚠️ 雲端驗證未通過：請按「雲端檔案」先登入，或在「雲端設定」貼 Service Token。"); return; }
        toast("雲端錯誤：" + (e.message ? e.message : String(e)));
      };
      CloudCtrl.prototype.apply = function(payload, info){
        payload = payload || {};
        var rdb = Array.isArray(payload.db) ? payload.db : [];
        var rc = Number(payload.counter||0); if(!Number.isFinite(rc) || rc<0) rc=0;

        // ✅ protect: remote 空但 local 有 → 先保護一次
        var protectOnce = false;
        try{ protectOnce = !sessionStorage.getItem(PROTECT_EMPTY_REMOTE_KEY); }catch(e){}
        if(rdb.length===0 && db.length>0 && protectOnce){
          try{ sessionStorage.setItem(PROTECT_EMPTY_REMOTE_KEY, "1"); }catch(e){}
          toast("⚠️ 雲端回傳空資料：已先保護本機資料（避免誤覆蓋）。");
          cloudState = "ok";
          lastSyncAt = Date.now();
          renderHint();
          return;
        }

        db = rdb.map(normalizeRow).filter(Boolean);
        counter = Math.max(counter, rc);
        saveLocal();
        lastSyncAt = Date.now();
        cloudState = "ok";
        renderAll();
        if(info && info.merged) toast("雲端合併完成");
      };
      CloudCtrl.prototype.pullNow = function(){
        var self = this;
        return apiPull().then(function(resp){
          cloudState="ok";
          var u = unwrap(resp);
          self.apply(u.payload, u.info||{});
          return true;
        }).catch(function(e){ self._err(e); return false; });
      };
      CloudCtrl.prototype.saveMerged = function(){
        var self = this;
        if(self._saving){ self._pending = true; return Promise.resolve(false); }
        self._saving = true; self._pending = false;
        var localPayload = { db: db, counter: counter };
        return apiMerge(localPayload).then(function(resp){
          var u = unwrap(resp);
          self.apply(u.payload, Object.assign({ merged:true }, u.info||{}));
          return true;
        }).catch(function(e){ self._err(e); return false; })
          .finally(function(){
            self._saving = false;
            if(self._pending){ self._pending=false; setTimeout(function(){ self.saveMerged(); }, 0); }
          });
      };
      CloudCtrl.prototype.startWatch = function(sec){
        var self=this;
        sec = Number(sec||0); if(!Number.isFinite(sec) || sec<=0) sec = 10;
        clearInterval(self._timer);
        self._timer = setInterval(function(){ self.pullNow(); }, sec*1000);
      };
      CloudCtrl.prototype.destroy = function(){ clearInterval(this._timer); };

      // ===== Local load/save =====
      function normalizeRow(x){
        if(!x || typeof x!=="object") return null;
        var uid = norm(x.uid ?? x._uid ?? x.pk ?? x.k ?? x.key ?? "");
        var id = Number(x.id ?? x.no ?? x.idx ?? "");
        if(!Number.isFinite(id) || id<=0) id = null;
        var text   = (x.text ?? x.content ?? x.note ?? "").toString();
        var trade  = norm(x.trade ?? x.kind ?? "");
        var system = norm(x.system ?? x.sys ?? "");
        var source = norm(x.source ?? x.origin ?? "");
        var attach = norm(x.attach ?? x.attachment ?? x.link ?? "");
        var remark = (x.remark ?? x.note2 ?? "").toString();
        var date   = norm(x.date ?? x.day ?? x.created ?? "");
        if(date && !/^\d{4}-\d{2}-\d{2}$/.test(date)){
          var d = new Date(date);
          date = isNaN(d.getTime()) ? "" : d.toISOString().slice(0,10);
        }
        if(!uid) uid = id ? ("legacy_"+String(id)) : uuid();
        return { uid:uid, id:id, text:text, trade:trade, system:system, source:source, attach:attach, remark:remark, date:date };
      }
      function loadLocal(){
        db = [];
        counter = 0;
        try{
          var raw = localStorage.getItem(DB_KEY);
          var arr = safeJSON(raw);
          if(Array.isArray(arr)) db = arr.map(normalizeRow).filter(Boolean);
        }catch(e){}
        try{
          var c = Number(localStorage.getItem(COUNTER_KEY)||0);
          if(Number.isFinite(c) && c>0) counter = c;
        }catch(e){}
        counter = Math.max(counter, maxId(db));
        if(db.length>0){
          saveLocal(); // normalize persist
        }
      }
      function saveLocal(){
        try{ localStorage.setItem(DB_KEY, JSON.stringify(db)); }catch(e){}
        try{ localStorage.setItem(COUNTER_KEY, String(counter||0)); }catch(e){}
      }
      function maxId(arr){
        var m=0;
        for(var i=0;i<(arr?arr.length:0);i++){
          var id = Number(arr[i] && arr[i].id);
          if(Number.isFinite(id) && id>m) m=id;
        }
        return m;
      }

      // ===== Dictionaries =====
      function loadDict(key, fallback){
        try{
          var obj = safeJSON(localStorage.getItem(key));
          if(obj && typeof obj==="object") return obj;
        }catch(e){}
        return fallback || {};
      }
      function saveDict(key, obj){ try{ localStorage.setItem(key, JSON.stringify(obj||{})); }catch(e){} }
      function dictToList(obj){
        var out = [];
        for(var k in (obj||{})){
          if(Object.prototype.hasOwnProperty.call(obj,k)){
            var v = norm(obj[k]);
            if(v) out.push(v);
          }
        }
        return out;
      }
      function uniqSorted(list){
        var set = new Set();
        for(var i=0;i<list.length;i++){ var v = norm(list[i]); if(v) set.add(v); }
        return Array.from(set).sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });
      }

      var tradeDict = loadDict(TRADE_DICT_KEY, {});
      var sysDict = loadDict(SYS_DICT_KEY, {});
      var sourceDict = loadDict(SOURCE_DICT_KEY, {});
      var tradeSysMap = loadDict(TRADE_SYS_MAP_KEY, {});

      function ensureDictFromDb(){
        var trades = [], systems = [], sources = [];
        for(var i=0;i<db.length;i++){
          if(db[i].trade) trades.push(db[i].trade);
          if(db[i].system) systems.push(db[i].system);
          if(db[i].source) sources.push(db[i].source);
        }
        var tU = uniqSorted(trades), sU = uniqSorted(systems), soU = uniqSorted(sources);
        for(i=0;i<tU.length;i++) tradeDict[tU[i]] = tU[i];
        for(i=0;i<sU.length;i++) sysDict[sU[i]] = sU[i];
        for(i=0;i<soU.length;i++) sourceDict[soU[i]] = soU[i];
        saveDict(TRADE_DICT_KEY, tradeDict);
        saveDict(SYS_DICT_KEY, sysDict);
        saveDict(SOURCE_DICT_KEY, sourceDict);
      }

      function bindSystemToTrade(trade, system){
        trade = norm(trade); system = norm(system);
        if(!trade || !system) return;
        var arr = Array.isArray(tradeSysMap[trade]) ? tradeSysMap[trade] : [];
        if(arr.indexOf(system)<0) arr.push(system);
        tradeSysMap[trade] = uniqSorted(arr);
        saveDict(TRADE_SYS_MAP_KEY, tradeSysMap);
      }

      // ===== UI =====
      function setReadMode(on){
        on = !!on;
        document.body.classList.toggle("readMode", on);
        try{ localStorage.setItem(READ_MODE_KEY, on ? "1" : "0"); }catch(e){}
        $("btnRead").querySelector(".t").textContent = "閱讀模式：" + (on ? "開" : "關");
      }
      function getReadMode(){
        try{ return (localStorage.getItem(READ_MODE_KEY)||"") === "1"; }catch(e){}
        return false;
      }

      function currentUser(){
        return Auth.current ? Auth.current() : null;
      }

      function updateTopbar(){
        var u = currentUser();
        $("uName").textContent = u && u.username ? u.username : "—";
        $("uRole").textContent = Auth.role ? (Auth.role() || "—") : "—";

        var canWrite = Auth.canWrite ? Auth.canWrite() : (Auth.role && /^(admin|write)$/i.test(Auth.role()||""));
        $("btnAdd").style.display = canWrite ? "inline-block" : "none";
        $("btnEdit").style.display = canWrite ? "inline-block" : "none";
        $("btnToken").style.display = (Auth.isAdmin && Auth.isAdmin()) ? "inline-block" : "none";
      }

      function rowMatches(r){
        var qt = norm($("qText").value).toLowerCase();
        var ft = norm($("fTrade").value);
        var fs = norm($("fSys").value);

        if(ft && r.trade !== ft) return false;
        if(fs && r.system !== fs) return false;

        if(qt){
          var blob = ((r.text||"") + " " + (r.remark||"") + " " + (r.source||"")).toLowerCase();
          if(blob.indexOf(qt) < 0) return false;
        }
        return true;
      }

      function filteredRows(){
        var out = [];
        for(var i=0;i<db.length;i++){
          var r = db[i];
          if(rowMatches(r)) out.push(r);
        }
        out.sort(function(a,b){ return (a.id||0) - (b.id||0); });
        return out;
      }

      function renderFilters(){
        // trade options
        var trades = uniqSorted(dictToList(tradeDict).concat(db.map(function(r){return r.trade;})));
        var tradeSel = $("fTrade");
        var curT = tradeSel.value;
        tradeSel.innerHTML = '<option value="">全部</option>' + trades.map(function(t){ return '<option value="'+escHtml(t)+'">'+escHtml(t)+'</option>'; }).join("");
        tradeSel.value = trades.indexOf(curT)>=0 ? curT : "";

        // sys options (global, but if trade selected -> only those bound)
        var curTrade = norm(tradeSel.value);
        var sysList = [];
        if(curTrade && Array.isArray(tradeSysMap[curTrade]) && tradeSysMap[curTrade].length){
          sysList = tradeSysMap[curTrade].slice();
        }else{
          sysList = uniqSorted(dictToList(sysDict).concat(db.map(function(r){return r.system;})));
        }
        var sysSel = $("fSys");
        var curS = sysSel.value;
        sysSel.innerHTML = '<option value="">全部</option>' + sysList.map(function(s){ return '<option value="'+escHtml(s)+'">'+escHtml(s)+'</option>'; }).join("");
        sysSel.value = sysList.indexOf(curS)>=0 ? curS : "";
      }

      function renderTable(rows){
        var canWrite = Auth.canWrite ? Auth.canWrite() : false;
        var tbody = $("tbody");
        var html = "";
        for(var i=0;i<rows.length;i++){
          var r = rows[i];
          var sel = (r.uid === selectedUid) ? ' class="sel"' : "";
          var att = r.attach ? ('<button class="attBtn" type="button" data-att="'+escHtml(r.attach)+'"><span class="t">開啟</span></button>') : '<span class="muted">—</span>';
          var ops = '<button class="btn ghost small" type="button" data-op="view" data-uid="'+escHtml(r.uid)+'"><span class="t">查看</span></button>';
          if(canWrite){
            ops += ' <button class="btn small" type="button" data-op="edit" data-uid="'+escHtml(r.uid)+'"><span class="t">編輯</span></button>';
          }
          html += '<tr'+sel+' data-uid="'+escHtml(r.uid)+'">'
            + '<td style="text-align:center; font-weight:900;">'+escHtml(String(r.id||""))+'</td>'
            + '<td>'+escHtml(r.text||"")+'</td>'
            + '<td style="text-align:center;">'+escHtml(r.trade||"")+'</td>'
            + '<td style="text-align:center;">'+escHtml(r.system||"")+'</td>'
            + '<td style="text-align:center;">'+escHtml(r.source||"")+'</td>'
            + '<td style="text-align:center;">'+att+'</td>'
            + '<td>'+escHtml(r.remark||"")+'</td>'
            + '<td style="text-align:center;">'+escHtml(r.date||"")+'</td>'
            + '<td style="text-align:center; white-space:nowrap;">'+ops+'</td>'
            + '</tr>';
        }
        tbody.innerHTML = html || '<tr><td colspan="9" style="text-align:center; padding:18px; color:rgba(0,0,0,.55); font-weight:900;">（目前沒有資料）</td></tr>';

        // wire attachments
        var btns = tbody.querySelectorAll('button[data-att]');
        for(i=0;i<btns.length;i++){
          btns[i].addEventListener("click", function(ev){
            ev.stopPropagation();
            var href = this.getAttribute("data-att") || "";
            openAttachment(href);
          });
        }
        var opsBtn = tbody.querySelectorAll('button[data-op]');
        for(i=0;i<opsBtn.length;i++){
          opsBtn[i].addEventListener("click", function(ev){
            ev.stopPropagation();
            var uid = this.getAttribute("data-uid");
            var op = this.getAttribute("data-op");
            if(uid) selectUid(uid);
            if(op==="view") openModal("view", uid);
            if(op==="edit") openModal("edit", uid);
          });
        }
        var trs = tbody.querySelectorAll("tr[data-uid]");
        for(i=0;i<trs.length;i++){
          trs[i].addEventListener("click", function(){
            var uid = this.getAttribute("data-uid");
            if(uid) selectUid(uid);
          });
        }
      }

      function renderCards(rows){
        var canWrite = Auth.canWrite ? Auth.canWrite() : false;
        var wrap = $("cards");
        if(!rows.length){
          wrap.innerHTML = '<div class="noteCard" style="text-align:center; cursor:default;"><div class="noteBody">（目前沒有資料）</div></div>';
          return;
        }
        var html = "";
        for(var i=0;i<rows.length;i++){
          var r = rows[i];
          var sel = (r.uid === selectedUid) ? " sel" : "";
          html += '<div class="noteCard'+sel+'" data-uid="'+escHtml(r.uid)+'">'
            + '<div class="noteHead">'
              + '<div class="noteMeta">'
                + '<span class="noteTag">'+escHtml(r.trade||"")+'</span>'
                + '<span class="noteTag">'+escHtml(r.system||"")+'</span>'
                + '<span class="noteTag">'+escHtml(r.source||"")+'</span>'
              + '</div>'
              + '<div class="noteNo">#'+escHtml(String(r.id||""))+' · '+escHtml(r.date||"")+'</div>'
            + '</div>'
            + '<div class="noteBody">'+escHtml(r.text||"")+'</div>'
            + '<div class="noteMore">'
              + (r.attach ? '<div style="margin-top:10px;"><button class="attBtn" type="button" data-att="'+escHtml(r.attach)+'"><span class="t">附件</span></button></div>' : '')
              + (r.remark ? '<div class="noteBody" style="opacity:.86; margin-top:10px;"><b>備註：</b>'+escHtml(r.remark)+'</div>' : '')
              + '<div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">'
                + '<button class="btn ghost small" type="button" data-op="view" data-uid="'+escHtml(r.uid)+'"><span class="t">查看</span></button>'
                + (canWrite ? '<button class="btn small" type="button" data-op="edit" data-uid="'+escHtml(r.uid)+'"><span class="t">編輯</span></button>' : '')
              + '</div>'
            + '</div>'
          + '</div>';
        }
        wrap.innerHTML = html;

        var cards = wrap.querySelectorAll(".noteCard");
        for(i=0;i<cards.length;i++){
          cards[i].addEventListener("click", function(){
            var uid = this.getAttribute("data-uid");
            if(uid) selectUid(uid);
            this.classList.toggle("open");
          });
        }
        var btnAtt = wrap.querySelectorAll('button[data-att]');
        for(i=0;i<btnAtt.length;i++){
          btnAtt[i].addEventListener("click", function(ev){
            ev.stopPropagation();
            openAttachment(this.getAttribute("data-att")||"");
          });
        }
        var btnOp = wrap.querySelectorAll('button[data-op]');
        for(i=0;i<btnOp.length;i++){
          btnOp[i].addEventListener("click", function(ev){
            ev.stopPropagation();
            var uid = this.getAttribute("data-uid");
            var op = this.getAttribute("data-op");
            if(uid) selectUid(uid);
            if(op==="view") openModal("view", uid);
            if(op==="edit") openModal("edit", uid);
          });
        }
      }

      function renderHint(){
        var rows = filteredRows();
        var total = db.length;
        var shown = rows.length;
        var u = currentUser();
        var name = u && u.username ? u.username : "—";
        var role = Auth.role ? (Auth.role() || "—") : "—";

        var cloudTxt = "離線";
        if(cloudState==="ok") cloudTxt = "OK";
        if(cloudState==="deny") cloudTxt = "驗證未通過";
        if(cloudState==="neterr") cloudTxt = "連線失敗";
        if(cloudState==="noapi") cloudTxt = "未設定";
        var syncTxt = lastSyncAt ? fmtClock(lastSyncAt) : "—";

        $("hint").innerHTML =
          '<span class="hb"><span class="k">使用者</span><span class="v">'+escHtml(name)+'</span></span>'
          +'<span class="hb"><span class="k">權限</span><span class="v">'+escHtml(role)+'</span></span>'
          +'<span class="hb"><span class="k">顯示</span><span class="v">'+escHtml(String(shown))+'</span></span>'
          +'<span class="hb"><span class="k">總筆數</span><span class="v">'+escHtml(String(total))+'</span></span>'
          +'<span class="hb '+((cloudState==="ok")?"":"bad")+'"><span class="k">雲端</span><span class="v">'+escHtml(cloudTxt)+'</span></span>'
          +'<span class="hb"><span class="k">同步</span><span class="v">'+escHtml(syncTxt)+'</span></span>';
      }

      function renderAll(){
        renderFilters();
        var rows = filteredRows();
        renderTable(rows);
        renderCards(rows);
        renderHint();
      }

      function selectUid(uid){
        selectedUid = uid;
        renderAll();
      }

      function openAttachment(href){
        var h = (href ?? "").toString().trim();
        if(!h) return;
        if(/^https?:\/\//i.test(h) || /^mailto:/i.test(h) || /^file:/i.test(h)){
          window.open(h, "_blank", "noopener");
          return;
        }
        location.href = withV(h);
      }

      // ===== Modal =====
      function setModalVisible(on){ $("mask").style.display = on ? "flex" : "none"; }
      function setModalEditable(editable){
        editable = !!editable;
        $("mText").disabled = !editable;
        $("mTradeSel").disabled = !editable;
        $("mSysSel").disabled = !editable;
        $("mSourceSel").disabled = !editable;
        $("mAttach").disabled = !editable;
        $("mRemark").disabled = !editable;
        $("mDate").disabled = !editable;

        $("btnAddTrade").disabled = !editable;
        $("btnAddSys").disabled = !editable;
        $("btnAddSource").disabled = !editable;
        $("btnSave").style.display = editable ? "inline-block" : "none";
        $("btnCancel").style.display = editable ? "inline-block" : "none";

        // ✅ delete：write/admin 都可刪（read 不可）
        var canWrite = Auth.canWrite ? Auth.canWrite() : false;
        $("btnDelete").style.display = (editable && canWrite && editingUid != null) ? "inline-block" : "none";
      }

      function fillModalFromRow(r){
        $("mText").value = r ? (r.text||"") : "";
        $("mAttach").value = r ? (r.attach||"") : "";
        $("mRemark").value = r ? (r.remark||"") : "";
        $("mDate").value = r ? (r.date||"") : todayISO();
        $("mNo").value = r ? String(r.id||"") : String(counter + 1);
      }

      function renderModalSelects(curTrade, curSys, curSource){
        curTrade = norm(curTrade); curSys = norm(curSys); curSource = norm(curSource);
        var trades = uniqSorted(dictToList(tradeDict).concat(db.map(function(r){return r.trade;})));
        var sources = uniqSorted(dictToList(sourceDict).concat(db.map(function(r){return r.source;})));

        var tSel = $("mTradeSel");
        tSel.innerHTML = trades.map(function(t){ return '<option value="'+escHtml(t)+'">'+escHtml(t)+'</option>'; }).join("");
        if(!tSel.innerHTML) tSel.innerHTML = '<option value=""></option>';
        if(trades.indexOf(curTrade)>=0) tSel.value = curTrade;

        // systems filtered by trade
        var sysList = [];
        if(curTrade && Array.isArray(tradeSysMap[curTrade]) && tradeSysMap[curTrade].length){
          sysList = tradeSysMap[curTrade].slice();
        }else{
          sysList = uniqSorted(dictToList(sysDict).concat(db.map(function(r){return r.system;})));
        }
        var sSel = $("mSysSel");
        sSel.innerHTML = sysList.map(function(s){ return '<option value="'+escHtml(s)+'">'+escHtml(s)+'</option>'; }).join("");
        if(!sSel.innerHTML) sSel.innerHTML = '<option value=""></option>';
        if(sysList.indexOf(curSys)>=0) sSel.value = curSys;

        var soSel = $("mSourceSel");
        soSel.innerHTML = sources.map(function(s){ return '<option value="'+escHtml(s)+'">'+escHtml(s)+'</option>'; }).join("");
        if(!soSel.innerHTML) soSel.innerHTML = '<option value=""></option>';
        if(sources.indexOf(curSource)>=0) soSel.value = curSource;
      }

      function openModal(mode, uid){
        var canWrite = Auth.canWrite ? Auth.canWrite() : false;
        mode = mode || "view";
        if((mode==="edit" || mode==="add") && !canWrite){
          toast("唯讀模式不可編輯");
          mode = "view";
        }

        var r = null;
        editingUid = null;
        if(mode==="add"){
          editingUid = null;
          counter = Math.max(counter, maxId(db));
          $("mTitle").textContent = "新增";
          renderModalSelects("", "", "");
          fillModalFromRow(null);
          setModalEditable(true);
        }else{
          r = db.find(function(x){ return x.uid === uid; }) || null;
          if(!r){ toast("找不到資料"); return; }
          editingUid = r.uid;
          $("mTitle").textContent = (mode==="edit") ? "編輯" : "查看";
          renderModalSelects(r.trade, r.system, r.source);
          fillModalFromRow(r);
          setModalEditable(mode==="edit");
        }

        setModalVisible(true);
      }

      function closeModal(){ setModalVisible(false); }

      function saveModal(){
        var canWrite = Auth.canWrite ? Auth.canWrite() : false;
        if(!canWrite){ toast("唯讀模式不可儲存"); return; }

        var text = $("mText").value.trim();
        if(!text){ toast("請輸入記事內容"); return; }

        var trade = norm($("mTradeSel").value);
        var system = norm($("mSysSel").value);
        var source = norm($("mSourceSel").value);
        var attach = norm($("mAttach").value);
        var remark = $("mRemark").value || "";
        var date = norm($("mDate").value) || todayISO();

        if(trade) tradeDict[trade] = trade;
        if(system) sysDict[system] = system;
        if(source) sourceDict[source] = source;
        saveDict(TRADE_DICT_KEY, tradeDict);
        saveDict(SYS_DICT_KEY, sysDict);
        saveDict(SOURCE_DICT_KEY, sourceDict);
        if(trade && system) bindSystemToTrade(trade, system);

        if(editingUid==null){
          counter = Math.max(counter, maxId(db));
          var id = counter + 1;
          counter = id;
          var row = { uid: uuid(), id:id, text:text, trade:trade, system:system, source:source, attach:attach, remark:remark, date:date };
          db.push(row);
          selectedUid = row.uid;
        }else{
          var r = db.find(function(x){ return x.uid === editingUid; });
          if(!r){ toast("找不到資料"); return; }
          r.text = text; r.trade = trade; r.system = system; r.source = source; r.attach = attach; r.remark = remark; r.date = date;
          selectedUid = r.uid;
        }

        db.sort(function(a,b){ return (a.id||0)-(b.id||0); });
        counter = Math.max(counter, maxId(db));
        saveLocal();
        ensureDictFromDb();
        renderAll();
        closeModal();

        if(cloud) cloud.saveMerged();
        toast("已儲存");
      }

      function deleteItem(){
        var canWrite = Auth.canWrite ? Auth.canWrite() : false;
        if(!canWrite){ toast("唯讀不可刪除"); return; }
        if(editingUid==null){ toast("這筆尚未存在"); return; }
        if(!confirm("確定要刪除這筆資料嗎？")) return;

        var idx = db.findIndex(function(x){ return x.uid === editingUid; });
        if(idx<0){ toast("找不到資料"); return; }

        db.splice(idx,1);
        saveLocal();
        ensureDictFromDb();
        selectedUid = db.length ? db[Math.max(0, Math.min(db.length-1, idx))].uid : null;
        closeModal();
        renderAll();
        toast("已刪除");

        if(cloud) cloud.saveMerged();
      }

      // ===== Prompt add dict =====
      function openPrompt(mode){
        promptMode = mode; // trade | sys | source
        $("pMask").style.display = "flex";
        $("pInput").value = "";
        $("pInput").type = "text";
        if(mode==="trade"){
          $("pTitle").textContent = "新增工種";
          $("pLabel").textContent = "請輸入工種";
          $("pHint").textContent = "新增後會加入「工種字典」。";
        }else if(mode==="sys"){
          $("pTitle").textContent = "新增系統";
          $("pLabel").textContent = "請輸入系統";
          $("pHint").textContent = "新增後會加入「系統字典」，並綁定到目前工種。";
        }else if(mode==="source"){
          $("pTitle").textContent = "新增出處";
          $("pLabel").textContent = "請輸入出處";
          $("pHint").textContent = "新增後會加入「出處字典」。";
        }
        setTimeout(function(){ $("pInput").focus(); }, 0);
      }
      function closePrompt(){ $("pMask").style.display = "none"; promptMode = null; }
      function confirmPrompt(){
        var v = norm($("pInput").value);
        if(!v){ toast("請輸入內容"); return; }
        if(promptMode==="trade"){
          tradeDict[v]=v; saveDict(TRADE_DICT_KEY, tradeDict);
          $("mTradeSel").value = v;
          renderModalSelects(v, $("mSysSel").value, $("mSourceSel").value);
        }else if(promptMode==="sys"){
          sysDict[v]=v; saveDict(SYS_DICT_KEY, sysDict);
          var trade = norm($("mTradeSel").value);
          if(trade) bindSystemToTrade(trade, v);
          renderModalSelects(trade, v, $("mSourceSel").value);
          $("mSysSel").value = v;
        }else if(promptMode==="source"){
          sourceDict[v]=v; saveDict(SOURCE_DICT_KEY, sourceDict);
          renderModalSelects($("mTradeSel").value, $("mSysSel").value, v);
          $("mSourceSel").value = v;
        }
        closePrompt();
        toast("已新增");
      }

      // ===== Export =====
      function exportBackup(){
        var payload = { ts: Date.now(), page: PAGE_KEY, db: db, counter: counter };
        var blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json;charset=utf-8" });
        var a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "sxdh-notes-backup_" + todayISO().replaceAll("-","") + ".json";
        document.body.appendChild(a);
        a.click();
        setTimeout(function(){ URL.revokeObjectURL(a.href); a.remove(); }, 0);
        toast("已匯出備份");
      }

      // ===== Cloud settings modal =====
      function parseCloudCfgInput(raw){
        raw = norm(raw);
        if(!raw) return null;
        var obj = safeJSON(raw);
        if(obj && typeof obj==="object"){
          return {
            apiBase: norm(obj.apiBase || obj.base || obj.url || ""),
            clientId: norm(obj.clientId || obj.id || obj.client_id || ""),
            clientSecret: norm(obj.clientSecret || obj.secret || obj.client_secret || "")
          };
        }
        var apiBase = "";
        var m = raw.match(/https?:\/\/[^\s|,;]+/i);
        if(m) apiBase = norm(m[0]);
        var parts = raw
          .replace(/[\u2460-\u2469]/g," ")
          .replace(/[①②③④⑤⑥⑦⑧⑨]/g," ")
          .replace(/(API_BASE|CLIENT_ID|CLIENT_SECRET)/gi," ")
          .replace(/(CF-Access-Client-Id|CF-Access-Client-Secret)/gi," ")
          .replace(/[=：:]/g," ")
          .replace(/\s+/g," ")
          .trim()
          .split(/[\s|,;]+/).map(norm).filter(Boolean);
        // remove URL if captured
        if(!apiBase){
          for(var i=0;i<parts.length;i++){
            if(/^https?:\/\//i.test(parts[i])){ apiBase = parts[i]; parts.splice(i,1); break; }
          }
        }else{
          for(var j=0;j<parts.length;j++){
            if(parts[j]===apiBase){ parts.splice(j,1); break; }
          }
        }
        return { apiBase: apiBase, clientId: parts[0]||"", clientSecret: parts[1]||"" };
      }

      function openTokenMask(){
        if(!(Auth.isAdmin && Auth.isAdmin())){ toast("僅 admin 可設定雲端"); return; }
        $("tokenMask").style.display = "flex";
        var base = getApiBase();
        $("tokenHint").textContent = "目前狀態：API_BASE=" + (base ? base : "未設定") + "，Service Token=" + (hasAccessToken() ? "已設定" : "未設定");
        $("tokenErr").style.display = "none";
        $("tokenErr").textContent = "";
        $("tokenInput").value = "";
        setTimeout(function(){ $("tokenInput").focus(); }, 0);
      }
      function closeTokenMask(){ $("tokenMask").style.display = "none"; }
      function saveTokenMask(){
        var cfg = parseCloudCfgInput($("tokenInput").value);
        if(!cfg){ toast("請貼上內容"); return; }
        if(cfg.apiBase && /^https?:\/\//i.test(cfg.apiBase)) setApiBase(cfg.apiBase);
        if(cfg.clientId && cfg.clientSecret){
          setAccessToken({ clientId: cfg.clientId, clientSecret: cfg.clientSecret });
        }
        toast("已儲存雲端設定");
        closeTokenMask();
        startCloud(true);
      }
      function clearTokenMask(){
        if(!confirm("確定要清除雲端設定（API_BASE / Service Token）？")) return;
        setApiBase("");
        setAccessToken(null);
        toast("已清除");
        closeTokenMask();
        cloudState = "offline";
        renderHint();
      }
      function toggleTokenInput(){
        var el = $("tokenInput");
        el.type = (el.type==="password") ? "text" : "password";
      }

      function openCloudPortal(){
        var u = portalUrl();
        if(!u || u===D1_PING_PATH){ toast("尚未設定 API_BASE"); return; }
        window.open(u, "_blank", "noopener");
      }

      function startCloud(forceNow){
        if(!cloud) cloud = new CloudCtrl();
        var base = getApiBase();
        if(!base){
          cloudState = "noapi";
          renderHint();
          return;
        }
        cloud.startWatch(10);
        if(forceNow) cloud.pullNow();
      }

      // ===== Auth integration =====
      function wireLoginUI(){
        $("btnView").addEventListener("click", function(){ Auth.openLogin && Auth.openLogin(); });
        $("loginClose").addEventListener("click", function(){ Auth.closeLogin && Auth.closeLogin(); });
        $("loginToAuth").addEventListener("click", function(){ location.href = withV("權限表.html"); });
        $("loginBtn").addEventListener("click", function(){
          var u = $("loginUser").value;
          var p = $("loginPass").value;
          var ok = Auth.login ? Auth.login(u,p) : false;
          if(!ok){
            $("loginErr").style.display="block";
            $("loginErr").textContent="帳號或密碼錯誤";
          }
        });
      }

      // ===== Events =====
      function wireEvents(){
        $("navBack").addEventListener("click", function(){ location.href = withV("汐東工程管理表.html"); });
        $("mBack").addEventListener("click", function(){ location.href = withV("汐東工程管理表.html"); });
        $("mMoreBtn").addEventListener("click", function(){
          var m = $("mMoreMenu");
          m.style.display = (m.style.display==="none" || !m.style.display) ? "block" : "none";
        });
        document.addEventListener("click", function(ev){
          var menu = $("mMoreMenu");
          var btn = $("mMoreBtn");
          if(!menu || menu.style.display!=="block") return;
          if(ev.target===btn || btn.contains(ev.target)) return;
          if(menu.contains(ev.target)) return;
          menu.style.display = "none";
        });
        var items = document.querySelectorAll(".menuItem[data-href]");
        for(var i=0;i<items.length;i++){
          items[i].addEventListener("click", function(){
            var href = this.getAttribute("data-href");
            if(href) location.href = withV(href);
          });
        }

        $("btnAdd").addEventListener("click", function(){ openModal("add"); });
        $("btnEdit").addEventListener("click", function(){
          if(!selectedUid){ toast("請先點選一筆資料"); return; }
          openModal("edit", selectedUid);
        });

        $("btnToken").addEventListener("click", openTokenMask);

        $("btnCloud").addEventListener("click", function(){
          openCloudPortal();
          if(cloud) cloud.pullNow();
        });

        $("btnExport").addEventListener("click", exportBackup);

        $("btnClear").addEventListener("click", function(){
          $("qText").value = "";
          $("fTrade").value = "";
          $("fSys").value = "";
          renderAll();
        });

        $("btnRead").addEventListener("click", function(){
          setReadMode(!document.body.classList.contains("readMode"));
        });

        $("qText").addEventListener("input", function(){ renderAll(); });
        $("fTrade").addEventListener("change", function(){
          renderFilters();
          renderAll();
        });
        $("fSys").addEventListener("change", function(){ renderAll(); });

        $("btnClose").addEventListener("click", closeModal);
        $("btnCancel").addEventListener("click", closeModal);
        $("btnSave").addEventListener("click", saveModal);
        $("btnDelete").addEventListener("click", deleteItem);

        $("btnAddTrade").addEventListener("click", function(){ openPrompt("trade"); });
        $("btnAddSys").addEventListener("click", function(){ openPrompt("sys"); });
        $("btnAddSource").addEventListener("click", function(){ openPrompt("source"); });

        $("pClose").addEventListener("click", closePrompt);
        $("pCancel").addEventListener("click", closePrompt);
        $("pOk").addEventListener("click", confirmPrompt);
        $("pInput").addEventListener("keydown", function(ev){ if(ev.key==="Enter"){ ev.preventDefault(); confirmPrompt(); } });

        $("btnNetDisk").addEventListener("click", function(){ window.open(NET_DISK_URL, "_blank", "noopener"); });

        $("tokenClose").addEventListener("click", closeTokenMask);
        $("tokenSave").addEventListener("click", saveTokenMask);
        $("tokenClear").addEventListener("click", clearTokenMask);
        $("tokenToggle").addEventListener("click", toggleTokenInput);
        $("tokenNetDisk").addEventListener("click", function(){ window.open(CLOUD_NETDISK_URL, "_blank", "noopener"); });

        $("mTradeSel").addEventListener("change", function(){
          var trade = norm($("mTradeSel").value);
          renderModalSelects(trade, "", $("mSourceSel").value);
        });
      }

      // ===== Boot =====
      loadLocal();
      ensureDictFromDb();

      wireLoginUI();
      wireEvents();

      setReadMode(getReadMode());

      renderAll();

      Auth.onChange && Auth.onChange(function(){
        updateTopbar();
        renderAll();
        startCloud(true);
      });
      updateTopbar();

      startCloud(true);
    }

    if(window.__TASUN_WAIT__ && typeof window.__TASUN_WAIT__.push === "function"){
      window.__TASUN_WAIT__.push(run);
    }else{
      document.addEventListener("DOMContentLoaded", run);
    }
  })();
  </script>
</body>
</html>
