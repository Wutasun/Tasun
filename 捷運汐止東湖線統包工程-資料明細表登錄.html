<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>捷運汐止東湖線統包工程-資料明細表登錄 · Tasun</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- ✅✅✅ 企業標準 v1：全站版本鎖定（以 tasun-version.json 為準） -->
  <script>
  (function(){
    const VER_KEY = "tasun_app_ver_v1";
    function pickVer(j){
      try{
        return String(
          (j && (j.appVer ?? j.version ?? j.ver ?? j.APP_VER ?? j.TASUN_APP_VER ?? j.tasunAppVer ?? j.build)) || ""
        ).trim();
      }catch(e){ return ""; }
    }
    function withV(url){
      const vv = (window.__CACHE_V || "").trim();
      if(!vv) return url;
      try{
        const uu = new URL(url, document.baseURI);
        if(uu.origin === location.origin){
          uu.searchParams.set("v", vv);
          return uu.toString();
        }
      }catch(e){}
      return url;
    }
    function syncTo(ver){
      try{ sessionStorage.setItem(VER_KEY, ver); }catch(e){}
      try{ localStorage.setItem(VER_KEY, ver); }catch(e){}
      window.__CACHE_V = ver;
      window.__withV = withV;
    }

    (async function(){
      try{
        const u = new URL(location.href);
        const cur = String(u.searchParams.get("v") || "").trim();
        const saved = String((sessionStorage.getItem(VER_KEY) || localStorage.getItem(VER_KEY) || "")).trim();

        let target = "";
        try{
          const r = await fetch("tasun-version.json", { cache: "no-store" });
          if(r && r.ok){
            const j = await r.json();
            target = pickVer(j);
          }
        }catch(e){}

        target = String(target || cur || saved || "").trim();
        if(!target) return;

        syncTo(target);

        // 強制跳轉到最新版（避免多人多設備版本不一致）
        if(cur !== target){
          u.searchParams.set("v", target);
          location.replace(u.toString());
          return;
        }
      }catch(e){}
    })();
  })();
  </script>

  <style>
    :root{
      --bg0:#070809;
      --bg1:#0b0d10;
      --gold:#f6d37a;
      --border:rgba(246,211,122,.28);
      --border2:rgba(246,211,122,.40);
      --text:#ececec;
      --muted:rgba(236,236,236,.70);
      --shadow:0 18px 50px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family:"Noto Serif TC", serif;
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(246,211,122,.10), transparent 60%),
        radial-gradient(900px 520px at 85% 25%, rgba(246,211,122,.08), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{max-width:980px;margin:0 auto;padding:20px 16px 34px}

    .topbar{
      position:relative;
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:12px;
      align-items:center;
      padding:14px;
      border:1px solid var(--border);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
    }
    @media (max-width:920px){
      .topbar{grid-template-columns:1fr}
      .nav-left{order:0}
      .brand{order:1}
      .right{order:2; justify-content:flex-start}
    }

    .nav-left{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-start;}
    .nav-desktop{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .nav-mobile{display:none; gap:10px; align-items:center; width:100%;}
    @media (max-width:600px){
      .nav-desktop{display:none}
      .nav-mobile{display:flex}
    }

    .brand{display:flex; flex-direction:column}
    .title{
      font-weight:900; letter-spacing:.06em;
      font-size: clamp(16px, 1.5vw, 20px);
      color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.22);
      line-height:1.25;
    }
    .sub{font-size:12px; color:var(--muted); letter-spacing:.08em; margin-top:4px}

    .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    @media (max-width:920px){ .right{justify-content:flex-start;} }

    .pill{
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.05);
      font-size:13px; color:rgba(236,236,236,.85);
      display:flex; gap:8px; align-items:center; white-space:nowrap;
    }
    .pill b{color:var(--gold)}

    .btn{
      appearance:none;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(246,211,122,.18), rgba(246,211,122,.07));
      color:var(--gold);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-family:inherit;
      font-weight:900;
      letter-spacing:.05em;
      box-shadow:0 10px 22px rgba(0,0,0,.35);
      transition:transform .12s ease, filter .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.06)}
    .btn:active{transform:translateY(0); filter:brightness(.98)}
    .btn.ghost{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.18);
      color:rgba(236,236,236,.85);
      font-weight:600;
    }
    .small{padding:8px 10px; font-size:12px; border-radius:999px; letter-spacing:.04em}

    .moreWrap{ position:relative; display:inline-flex; }
    .moreMenu{
      position:absolute;
      top:calc(100% + 8px);
      left:0;
      min-width: 230px;
      border-radius:16px;
      border:1px solid rgba(246,211,122,.30);
      background:linear-gradient(180deg, rgba(0,0,0,.72), rgba(0,0,0,.45));
      box-shadow:0 18px 50px rgba(0,0,0,.65);
      backdrop-filter:blur(10px);
      padding:8px;
      display:none;
      z-index:60;
    }
    .moreMenu.open{ display:block; }
    .menuItem{
      width:100%;
      text-align:left;
      border:none;
      background:rgba(255,255,255,.04);
      color:rgba(236,236,236,.92);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-family:inherit;
      letter-spacing:.04em;
    }
    .menuItem:hover{ background:rgba(246,211,122,.12); color:var(--gold); }
    .menuSep{ height:1px; margin:8px 6px; background:rgba(255,255,255,.10); }

    .panel{
      margin-top:16px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
    }

    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    .span2{grid-column:span 2}
    @media (max-width:720px){
      .grid{grid-template-columns:1fr}
      .span2{grid-column:span 1}
    }

    .field{display:flex; flex-direction:column; gap:6px}
    .label{font-size:12px; letter-spacing:.08em; color:var(--muted)}

    input,select,textarea{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);
      color:var(--text);
      padding:10px 12px;
      font-family:inherit;
      outline:none;
      transition:border-color .12s ease, filter .12s ease;
    }
    textarea{min-height:92px; resize:vertical;}
    input:focus,select:focus,textarea:focus{border-color:rgba(246,211,122,.55); filter:brightness(1.05)}
    input:disabled,select:disabled,textarea:disabled{
      opacity:.55;
      cursor:not-allowed;
      filter:saturate(.85);
    }

    .miniHint{font-size:12px; color:rgba(236,236,236,.62); line-height:1.5}
    .warn{color:rgba(255,190,190,.95)}

    .row{
      display:flex;
      gap:10px;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-top:10px
    }
    .rowLeft{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-start;}
    .rowRight{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    @media (max-width:520px){
      .rowLeft, .rowRight{width:100%;}
      .rowRight{justify-content:flex-end;}
    }

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.55);
      color:rgba(236,236,236,.92);
      font-size:13px;
      box-shadow:var(--shadow);
      display:none;
      z-index:200;
      backdrop-filter:blur(10px);
    }

    .loginMask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.68);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:999;
    }
    .loginMask.show{display:flex;}
    .loginModal{
      width:min(520px, 96vw);
      border-radius:22px;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow:0 30px 90px rgba(0,0,0,.78);
      overflow:hidden;
      backdrop-filter:blur(12px);
    }
    .loginHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .loginTitle{
      font-weight:900; letter-spacing:.08em;
      color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.22);
    }
    .loginBody{padding:14px 16px 10px;}
    .loginFoot{
      padding:12px 16px;
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .loginErr{
      margin-top:10px;
      color:rgba(255,190,190,.95);
      font-size:13px;
      line-height:1.5;
      display:none;
      white-space: pre-wrap;
    }
    .loginHint{
      margin-top:10px;
      color:rgba(236,236,236,.65);
      font-size:12px;
      line-height:1.6;
    }

    .selPlus{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .selPlus select{flex:1}
    .plusBtn{
      appearance:none;
      width:44px;
      height:44px;
      border-radius:14px;
      border:1px solid rgba(246,211,122,.40);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:0 10px 22px rgba(0,0,0,.35);
      color:var(--gold);
      cursor:pointer;
      font-family:inherit;
      font-weight:900;
      font-size:18px;
      line-height:1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition:transform .12s ease, filter .12s ease;
      user-select:none;
    }
    .plusBtn:hover{transform:translateY(-1px); filter:brightness(1.06)}
    .plusBtn:active{transform:translateY(0); filter:brightness(.98)}
    .plusBtn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
      filter:none;
    }

    .addBox{
      display:none;
      margin-top:8px;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(246,211,122,.32);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:0 14px 35px rgba(0,0,0,.45);
      backdrop-filter:blur(10px);
    }
    .addRow{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .addRow input{
      flex:1;
      min-width: 180px;
      padding:9px 10px;
      border-radius:12px;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.18);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="nav-left">
        <div class="nav-desktop">
          <button class="btn ghost small" id="navBackList">返回資料明細表</button>
        </div>

        <div class="nav-mobile">
          <button class="btn ghost small" id="mBack">返回</button>
          <div class="moreWrap">
            <button class="btn ghost small" id="mMoreBtn" type="button">更多 ▾</button>
            <div class="moreMenu" id="mMoreMenu" role="menu" aria-label="更多選單">
              <button class="menuItem" data-href="捷運汐止東湖線統包工程-資料明細表.html" type="button">資料明細表</button>
              <button class="menuItem" data-href="捷運汐止東湖線統包工程-資料明細表查詢.html" type="button">資料明細表查詢</button>
              <div class="menuSep"></div>
              <button class="menuItem" data-href="index.html" type="button">返回首頁</button>
            </div>
          </div>
        </div>
      </div>

      <div class="brand">
        <div class="title">捷運汐止東湖線統包工程-資料明細表登錄</div>
        <div class="sub">登錄日期用日曆選擇；電子檔填網址可直接開啟</div>
      </div>

      <div class="right">
        <div class="pill">使用者：<b id="uName">—</b></div>
        <div class="pill">權限：<b id="uRole">—</b></div>

        <button class="btn ghost" id="btnBackXidong" type="button">返回汐東工程管理表</button>
        <button class="btn ghost" id="btnHome" type="button">返回首頁</button>
      </div>
    </div>

    <div class="panel">
      <div id="noPerm" class="miniHint warn" style="display:none;margin-bottom:10px;">
        你目前是 read 權限，不能登錄資料（請用 admin/write 登入）。
      </div>

      <div class="grid">
        <div class="field">
          <div class="label">項次（自動）</div>
          <input id="no" disabled />
        </div>
        <div class="field">
          <div class="label">登錄日期</div>
          <input id="date" type="date" />
        </div>

        <div class="field span2">
          <div class="label">文件名稱</div>
          <input id="name" placeholder="例如：電氣系統施工圖（核准版）" />
        </div>

        <div class="field">
          <div class="label">工種（下拉項目＝明細表不重複項目；可按「＋」新增自訂值）</div>
          <div class="selPlus">
            <select id="trade"></select>
            <button class="plusBtn" id="tradePlus" type="button" title="新增工種">＋</button>
          </div>

          <div class="addBox" id="addTradeBox" aria-hidden="true">
            <div class="addRow">
              <input id="addTradeInput" placeholder="輸入新工種…" />
              <button class="btn ghost small" id="addTradeCancel" type="button">取消</button>
              <button class="btn small" id="addTradeOk" type="button">加入</button>
            </div>
          </div>
        </div>

        <div class="field">
          <div class="label">系統（會依工種篩選；可按「＋」新增自訂值）</div>
          <div class="selPlus">
            <select id="sys"></select>
            <button class="plusBtn" id="sysPlus" type="button" title="新增系統">＋</button>
          </div>

          <div class="addBox" id="addSysBox" aria-hidden="true">
            <div class="addRow">
              <input id="addSysInput" placeholder="輸入新系統…" />
              <button class="btn ghost small" id="addSysCancel" type="button">取消</button>
              <button class="btn small" id="addSysOk" type="button">加入</button>
            </div>
          </div>
        </div>

        <div class="field span2">
          <div class="label">電子檔（網址，可在網頁開啟）</div>
          <input id="url" type="url" placeholder="https://..." />
          <div class="miniHint">可貼 Dropbox / OneDrive / 內網網址；列表頁可直接按「開啟」。</div>
        </div>

        <div class="field span2">
          <div class="label">備註</div>
          <textarea id="note" placeholder="可輸入文字備註..."></textarea>
        </div>
      </div>

      <div class="row">
        <div class="rowLeft">
          <button class="btn ghost" id="btnCloudDB" type="button">雲端資料庫入口</button>
        </div>
        <div class="rowRight">
          <button class="btn ghost" id="btnReset" type="button">清空</button>
          <button class="btn" id="btnSave" type="button">新增</button>
        </div>
      </div>
    </div>
  </div>

  <div class="loginMask" id="loginMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="登入">
      <div class="loginHead">
        <div class="loginTitle">登入</div>
        <button class="btn ghost small" id="loginClose" type="button">關閉</button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label">帳號</div>
          <select id="loginUser" autocomplete="username">
            <option value="">請選擇帳號</option>
          </select>
        </div>
        <div class="field" style="margin-top:10px;">
          <div class="label">密碼</div>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="請輸入密碼" />
        </div>
        <div class="loginErr" id="loginErr"></div>
        <div class="loginHint">
          登入帳密完全以「權限表.html」的權限表（localStorage: <b>tasunAuthTable_v1</b>）為準。
        </div>
      </div>
      <div class="loginFoot">
        <button class="btn ghost" id="loginToAuth" type="button">前往權限表</button>
        <button class="btn" id="loginBtn" type="button">登入</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const CURRENT_KEY = "tasunCurrentUser_v1";
    const AUTH_KEY = "tasunAuthTable_v1";

    // ✅ 企業標準 v1：每頁唯一 pageKey（resourceKey=pageKey）
    const pageKey = "sxdh-detail-entry";
    const DB_KEY = `tasun_db_v1__${pageKey}`;

    const CLOUD_DB_URL = "https://www.dropbox.com/home/%E6%8D%B7%E9%81%8B%E6%B1%90%E6%AD%A2%E6%9D%B1%E6%B9%96%E7%B7%9A%E7%9B%A3%E9%80%A0%E5%B0%88%E6%A1%88";

    const ADD_VALUE = "__add__";

    let currentUser=null;
    let env = null;      // { items:[], counter:number, rev:string, updatedAt:string }
    let db  = [];        // items (已過濾 deleted=false)
    let _watchStarted=false;

    const $=(id)=>document.getElementById(id);
    const norm=(s)=>(s??"").toString().trim();

    function toast(msg){
      const t=$("toast");
      t.textContent=msg;
      t.style.display="block";
      clearTimeout(toast._tm);
      toast._tm=setTimeout(()=>t.style.display="none",2200);
    }
    function escHtml(s){
      return (s??"").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // ✅ 站內導頁：自動附加 ?v（全站同版）
    function go(href){
      const h = (typeof window.__withV === "function") ? window.__withV(href) : href;
      location.href = h;
    }

    // ===== Auth =====
    function mapRole(v){
      const s=(v??"").toString().trim().toLowerCase();
      if(!s) return "read";
      if(s==="admin") return "admin";
      if(s==="write"||s==="edit") return "write";
      if(s==="read"||s==="view") return "read";
      if(s==="0") return "admin";
      if(s==="1") return "write";
      if(s==="2") return "read";
      return s;
    }

    function loadAuthTable(){
      try{
        const raw=localStorage.getItem(AUTH_KEY);
        if(!raw) return [];
        const parsed=JSON.parse(raw);
        if(Array.isArray(parsed)) return parsed;
        if(parsed && Array.isArray(parsed.users)) return parsed.users;
        return [];
      }catch(e){ return []; }
    }

    function pickUsername(row){ return norm(row?.user ?? row?.username ?? row?.account ?? row?.name); }
    function pickPassword(row){ return (row?.pass ?? row?.password ?? row?.pwd ?? "").toString(); }
    function pickRole(row){ return mapRole(row?.role ?? row?.level ?? row?.perm ?? row?.permission); }

    function findAuthUser(username){
      const u=norm(username).toLowerCase();
      if(!u) return null;
      const rows=loadAuthTable();
      for(const r of rows){
        const ru=pickUsername(r).toLowerCase();
        if(ru && ru===u){
          return { user: pickUsername(r), pass: pickPassword(r), role: pickRole(r) || "read" };
        }
      }
      return null;
    }

    function loadCurrentUser(){
      try{ currentUser = JSON.parse(localStorage.getItem(CURRENT_KEY) || "null"); }
      catch(e){ currentUser=null; }
      if(currentUser && typeof currentUser==="object"){
        const uname = norm(currentUser.user ?? currentUser.username ?? currentUser.name ?? currentUser.account);
        if(uname){
          currentUser.user = uname;
          currentUser.username = uname;
        }
        currentUser.role = mapRole(currentUser.role ?? currentUser.level ?? "read");
        currentUser.level = currentUser.role;
        currentUser.authStamp = (currentUser.authStamp ?? "").toString();
      }
    }

    function setCurrentUser(user, role, authStamp){
      const u = { user, username:user, role: mapRole(role), level: mapRole(role), authStamp: (authStamp||"").toString() };
      localStorage.setItem(CURRENT_KEY, JSON.stringify(u));
      currentUser=u;
    }

    function role(){ return mapRole(currentUser?.role ?? currentUser?.level ?? "read"); }
    function canWrite(){ const r=role(); return r==="admin" || r==="write"; }

    const SESSION_WATCH_MS = 3000;

    function fnv1a(str){
      let h = 0x811c9dc5;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 0x01000193);
      }
      return (h >>> 0).toString(16).padStart(8, "0");
    }
    function authStampFromAuth(auth){
      return fnv1a(`${auth.user}|${auth.pass ?? ""}`);
    }

    function rebuildUserDropdown(preselectUser){
      const sel = $("loginUser");
      const rows = loadAuthTable();
      const users = rows.map(r => pickUsername(r)).filter(Boolean);

      const seen = new Set();
      const uniq = [];
      for(const u of users){
        const k = u.toLowerCase();
        if(seen.has(k)) continue;
        seen.add(k);
        uniq.push(u);
      }

      sel.innerHTML = `<option value="">請選擇帳號</option>` + uniq.map(u=>{
        const s = (preselectUser && u.toLowerCase() === preselectUser.toLowerCase()) ? "selected" : "";
        return `<option value="${escHtml(u)}" ${s}>${escHtml(u)}</option>`;
      }).join("");
    }

    function openLoginModal(msg){
      $("loginErr").style.display="none";
      if(msg){
        $("loginErr").textContent = msg;
        $("loginErr").style.display="block";
      }
      loadCurrentUser();
      rebuildUserDropdown(currentUser?.user || "");
      $("loginPass").value="";
      $("loginMask").classList.add("show");
      $("loginMask").setAttribute("aria-hidden","false");
      setTimeout(()=>{
        if($("loginUser").value) $("loginPass").focus();
        else $("loginUser").focus();
      },0);
    }
    function closeLoginModal(){
      $("loginMask").classList.remove("show");
      $("loginMask").setAttribute("aria-hidden","true");
    }

    function forceReLogin(msg){
      try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}
      currentUser=null;
      toast(msg || "權限表已更新，請重新登入");
      openLoginModal(msg || "權限表已更新，請重新登入");
      $("uName").textContent="—";
      $("uRole").textContent="—";
      applyPermissionUI();
    }

    function validateSession(){
      const lm = $("loginMask");
      if(lm && lm.classList.contains("show")) return;

      loadCurrentUser();
      if(!currentUser || !currentUser.user) return;

      const auth = findAuthUser(currentUser.user);
      if(!auth){ forceReLogin("帳號已被移除，請重新登入"); return; }

      const stampNow = authStampFromAuth(auth);

      if(!currentUser.authStamp){
        setCurrentUser(auth.user, auth.role || "read", stampNow);
        $("uName").textContent = auth.user;
        $("uRole").textContent = role();
        applyPermissionUI();
        return;
      }

      if(currentUser.authStamp !== stampNow){
        forceReLogin("密碼已更新，請重新登入");
        return;
      }

      const r = auth.role || "read";
      if(mapRole(currentUser.role) !== r){
        setCurrentUser(auth.user, r, stampNow);
        $("uRole").textContent = r;
        applyPermissionUI();
      }
    }

    function startSessionWatch(){
      if(_watchStarted) return;
      _watchStarted=true;

      window.addEventListener("storage",(e)=>{
        if(e.key === AUTH_KEY || e.key === CURRENT_KEY) validateSession();

        // ✅ 多人即時更新：任一人新增資料後，本頁下拉立即刷新
        if(e.key === DB_KEY){
          loadDB();
          rebuildSelects(true);
          rebuildNo();
        }
      });
      setInterval(validateSession, SESSION_WATCH_MS);
    }

    function ensureLoggedIn(){
      loadCurrentUser();
      const rows = loadAuthTable();
      if(!Array.isArray(rows) || rows.length === 0){
        openLoginModal("尚未建立權限表：請先到「權限表.html」建立帳號。");
        return false;
      }
      if(!currentUser || !currentUser.user){
        openLoginModal();
        return false;
      }

      const auth = findAuthUser(currentUser.user);
      if(!auth){ forceReLogin("帳號已被移除，請重新登入"); return false; }

      const stampNow = authStampFromAuth(auth);
      if(currentUser.authStamp && currentUser.authStamp !== stampNow){
        forceReLogin("密碼已更新，請重新登入");
        return false;
      }

      setCurrentUser(auth.user, auth.role || "read", stampNow);
      $("uName").textContent = auth.user;
      $("uRole").textContent = role();
      return true;
    }

    function doLogin(){
      const u = norm($("loginUser").value);
      const p = ($("loginPass").value ?? "").toString();
      const rows = loadAuthTable();

      if(!Array.isArray(rows) || rows.length === 0){
        $("loginErr").textContent = "尚未建立權限表：請先到「權限表.html」建立帳號。";
        $("loginErr").style.display = "block";
        return;
      }
      if(!u){
        $("loginErr").textContent = "請先選擇帳號。";
        $("loginErr").style.display = "block";
        return;
      }
      if(!p){
        $("loginErr").textContent = "請輸入密碼。";
        $("loginErr").style.display = "block";
        return;
      }

      const auth = findAuthUser(u);
      if(!auth){
        $("loginErr").textContent = "帳號不存在（以權限表為準）。";
        $("loginErr").style.display = "block";
        return;
      }
      if((auth.pass ?? "") !== p){
        $("loginErr").textContent = "密碼錯誤（以權限表為準）。";
        $("loginErr").style.display = "block";
        return;
      }

      const stampNow = authStampFromAuth(auth);
      setCurrentUser(auth.user, auth.role || "read", stampNow);

      closeLoginModal();
      toast("登入成功");
      start();
    }

    // ===== 企業標準 v1：資料封包 / items =====
    function nowIso(){ return new Date().toISOString(); }
    function newRev(){
      return (Date.now().toString(36) + "-" + Math.random().toString(36).slice(2,10)).toLowerCase();
    }
    function newUid(){
      try{
        if(window.crypto && typeof crypto.randomUUID === "function") return crypto.randomUUID();
      }catch(e){}
      // fallback
      const s = () => Math.floor((1 + Math.random()) * 0x10000).toString(16).slice(1);
      return `${s()}${s()}-${s()}-${s()}-${s()}-${s()}${s()}${s()}`;
    }

    function normalizeItem(it){
      if(!it || typeof it !== "object") return null;
      const uid = String(it.uid || "").trim() || newUid();
      const updatedAt = String(it.updatedAt || "").trim() || nowIso();
      const rev = String(it.rev || "").trim() || newRev();
      const deleted = !!it.deleted;
      const id = (it.id == null) ? "" : it.id;
      return {
        ...it,
        uid, rev, updatedAt, deleted,
        id
      };
    }

    function loadEnv(){
      try{
        const raw = localStorage.getItem(DB_KEY);
        if(!raw) return { items:[], counter:0, rev:"", updatedAt:"" };
        const p = JSON.parse(raw);
        if(p && typeof p === "object"){
          const items = Array.isArray(p.items) ? p.items : [];
          const counter = Number(p.counter || 0);
          const rev = String(p.rev || "").trim();
          const updatedAt = String(p.updatedAt || "").trim();
          return {
            items: items.map(normalizeItem).filter(Boolean),
            counter: Number.isFinite(counter) ? counter : 0,
            rev,
            updatedAt
          };
        }
      }catch(e){}
      return { items:[], counter:0, rev:"", updatedAt:"" };
    }

    function saveEnv(next){
      try{
        localStorage.setItem(DB_KEY, JSON.stringify(next));
      }catch(e){
        console.error("saveEnv failed", e);
      }
    }

    function loadDB(){
      env = loadEnv();

      // 舊格式相容（若偵測到舊 DB_key 仍是 array，轉成封包一次）
      //（這段只針對歷史資料：不改 UI，不影響新規格）
      try{
        const raw = localStorage.getItem(DB_KEY);
        if(raw && raw.trim().startsWith("[")){
          const arr = JSON.parse(raw);
          if(Array.isArray(arr)){
            const migrated = {
              items: arr.map(r=>{
                const it = normalizeItem({
                  uid: r.uid, rev: r.rev, updatedAt: r.updatedAt, deleted: !!r.deleted,
                  id: r.id,
                  docName: r.docName ?? r.name ?? "",
                  system: r.system ?? "",
                  trade: r.trade ?? "",
                  regDate: r.regDate ?? r.date ?? "",
                  fileUrl: r.fileUrl ?? r.url ?? "",
                  note: r.note ?? ""
                });
                return it;
              }).filter(Boolean),
              counter: arr.reduce((m,r)=>Math.max(m, Number(r?.id||0)||0), 0),
              rev: newRev(),
              updatedAt: nowIso()
            };
            saveEnv(migrated);
            env = migrated;
          }
        }
      }catch(e){}

      db = (env.items || []).filter(it => it && !it.deleted);
    }

    function bumpEnvAndSave(){
      if(!env) env = { items:[], counter:0, rev:"", updatedAt:"" };
      env.rev = newRev();
      env.updatedAt = nowIso();
      saveEnv(env);
      // 同頁觸發「storage」讓其他監聽點可重建（同分頁不會自動觸發）
      try{
        window.dispatchEvent(new StorageEvent("storage", { key: DB_KEY, storageArea: localStorage }));
      }catch(e){
        try{ window.dispatchEvent(new Event("storage")); }catch(_){}
      }
    }

    function getCounter(){ return Number(env?.counter || 0) || 0; }
    function nextCounter(){
      env.counter = getCounter() + 1;
      bumpEnvAndSave();
      return env.counter;
    }

    function rebuildNo(){
      $("no").value = String(getCounter() + 1);
      $("date").value = new Date().toISOString().slice(0,10);
    }

    function uniqueOptions(field, filterFn){
      const set = new Set();
      for(const r of db){
        if(filterFn && !filterFn(r)) continue;
        const v = norm(r?.[field]);
        if(v) set.add(v);
      }
      const arr = Array.from(set);
      arr.sort((a,b)=>a.localeCompare(b,"zh-Hant"));
      return arr;
    }

    function fillSelect(sel, opts, keep, firstLabel, withAdd){
      const first = `<option value="">${escHtml(firstLabel || "請選擇")}</option>`;
      const addOpt = withAdd ? `<option value="${ADD_VALUE}">新增…</option>` : "";
      sel.innerHTML =
        first +
        opts.map(v=>`<option value="${escHtml(v)}">${escHtml(v)}</option>`).join("") +
        addOpt;

      if(keep && opts.includes(keep)){
        sel.value = keep;
      }else if(keep && !opts.includes(keep) && keep !== ADD_VALUE){
        const op = document.createElement("option");
        op.value = keep;
        op.textContent = keep;
        const addNode = Array.from(sel.options).find(op => op.value === ADD_VALUE);
        if(addNode) sel.insertBefore(op, addNode);
        else sel.appendChild(op);
        sel.value = keep;
      }else{
        sel.value = "";
      }
    }

    function rebuildSysSelectByTrade(keep){
      const t = norm($("trade").value);
      const sys = t
        ? uniqueOptions("system", (r)=>norm(r?.trade) === t)
        : uniqueOptions("system");
      fillSelect($("sys"), sys, keep, "請選擇系統", true);
    }

    function rebuildSelects(keepCurrent){
      const keepT = keepCurrent ? norm($("trade").value) : "";
      const keepS = keepCurrent ? norm($("sys").value) : "";

      const tr = uniqueOptions("trade");
      fillSelect($("trade"), tr, keepT, "請選擇工種", true);
      rebuildSysSelectByTrade(keepS);
    }

    function applyPermissionUI(){
      const writable = canWrite();

      $("noPerm").style.display = writable ? "none" : "block";
      $("btnSave").disabled = !writable;

      ["name","trade","sys","url","date","note","tradePlus","sysPlus",
       "addTradeInput","addTradeOk","addTradeCancel","addSysInput","addSysOk","addSysCancel"
      ].forEach(id=>{
        if($(id)) $(id).disabled = !writable;
      });
    }

    function resetForm(){
      $("name").value="";
      $("trade").value="";
      $("sys").value="";
      $("url").value="";
      $("note").value="";

      hideAddBox("trade");
      hideAddBox("sys");

      rebuildNo();
      rebuildSelects(false);
      applyPermissionUI();
      if(canWrite()) $("name").focus();
    }

    function save(){
      validateSession();
      if(!currentUser || !currentUser.user){
        openLoginModal();
        return;
      }
      if(!canWrite()){ toast("read 權限不可登錄"); return; }

      const docName = norm($("name").value);
      if(!docName){ toast("文件名稱不可空白"); $("name").focus(); return; }

      const trade  = norm($("trade").value);
      const system = norm($("sys").value);

      if(trade === ADD_VALUE){ toast("請先完成新增工種或改選其他工種"); $("trade").focus(); return; }
      if(system === ADD_VALUE){ toast("請先完成新增系統或改選其他系統"); $("sys").focus(); return; }

      if(!trade){ toast("工種不可空白"); $("trade").focus(); return; }
      if(!system){ toast("系統不可空白"); $("sys").focus(); return; }

      const fileUrl = norm($("url").value);
      const regDate = norm($("date").value) || new Date().toISOString().slice(0,10);
      const note    = norm($("note").value);

      const id = nextCounter(); // ✅ id 只作顯示用（可重排/補號），不可當主鍵
      const uid = newUid();
      const updatedAt = nowIso();
      const rev = newRev();

      const item = normalizeItem({ uid, rev, updatedAt, deleted:false, id, docName, system, trade, regDate, fileUrl, note });

      if(!env) env = { items:[], counter:0, rev:"", updatedAt:"" };
      env.items = Array.isArray(env.items) ? env.items : [];
      env.items.unshift(item);
      // 更新封包 meta
      env.rev = rev;
      env.updatedAt = updatedAt;

      saveEnv(env);

      toast("登錄成功");
      resetForm();
    }

    function setupMoreMenu(backHref){
      const backBtn=$("mBack");
      const moreBtn=$("mMoreBtn");
      const menu=$("mMoreMenu");

      const close=()=>menu.classList.remove("open");
      const toggle=(e)=>{
        e.preventDefault();
        e.stopPropagation();
        menu.classList.toggle("open");
      };

      backBtn.onclick=()=>go(backHref);
      moreBtn.addEventListener("click", toggle);

      menu.addEventListener("click",(e)=>{
        e.stopPropagation();
        const item=e.target.closest("button.menuItem[data-href]");
        if(!item) return;
        const href=item.getAttribute("data-href");
        if(href) go(href);
      });

      document.addEventListener("click", close);
      window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") close(); });
    }

    function refreshOptionsNow(){
      loadDB();
      rebuildSelects(true);
    }
    function bindSelectAutoRefresh(){
      const ids = ["trade","sys"];
      const evs = ["pointerdown","mousedown","focus"];
      ids.forEach(id=>{
        const el = $(id);
        if(!el) return;
        evs.forEach(ev=>{
          el.addEventListener(ev, ()=>{
            el.dataset.prev = (el.value ?? "").toString();
            try{ refreshOptionsNow(); }catch(e){}
          }, { passive:true });
        });
      });
    }

    function hideAddBox(kind){
      if(kind==="trade"){
        $("addTradeBox").style.display = "none";
        $("addTradeBox").setAttribute("aria-hidden","true");
        $("addTradeInput").value = "";
      }else{
        $("addSysBox").style.display = "none";
        $("addSysBox").setAttribute("aria-hidden","true");
        $("addSysInput").value = "";
      }
    }
    function showAddBox(kind){
      if(kind==="trade"){
        $("addTradeBox").style.display = "block";
        $("addTradeBox").setAttribute("aria-hidden","false");
        $("addTradeInput").value = "";
        setTimeout(()=> $("addTradeInput").focus(), 0);
      }else{
        $("addSysBox").style.display = "block";
        $("addSysBox").setAttribute("aria-hidden","false");
        $("addSysInput").value = "";
        setTimeout(()=> $("addSysInput").focus(), 0);
      }
    }

    function addOptionToSelect(sel, value){
      const v = norm(value);
      if(!v) return false;

      const exists = Array.from(sel.options).some(op => norm(op.value) === v);
      if(!exists){
        const op = document.createElement("option");
        op.value = v;
        op.textContent = v;

        const addNode = Array.from(sel.options).find(op => op.value === ADD_VALUE);
        if(addNode) sel.insertBefore(op, addNode);
        else sel.appendChild(op);
      }
      sel.value = v;
      sel.dataset.prev = v;
      return true;
    }

    function bindAddUI(){
      const tradeSel = $("trade");
      const sysSel   = $("sys");

      $("tradePlus").onclick = ()=>{
        if(tradeSel.disabled) return;
        tradeSel.dataset.prev = (tradeSel.value ?? "").toString();
        showAddBox("trade");
      };
      $("sysPlus").onclick = ()=>{
        if(sysSel.disabled) return;
        sysSel.dataset.prev = (sysSel.value ?? "").toString();
        showAddBox("sys");
      };

      tradeSel.addEventListener("change", ()=>{
        if(tradeSel.value === ADD_VALUE){
          showAddBox("trade");
        }else{
          hideAddBox("trade");
          tradeSel.dataset.prev = (tradeSel.value ?? "").toString();
        }
        const keepS = norm(sysSel.value);
        rebuildSysSelectByTrade(keepS);
        hideAddBox("sys");
      });

      sysSel.addEventListener("change", ()=>{
        if(sysSel.value === ADD_VALUE){
          showAddBox("sys");
        }else{
          hideAddBox("sys");
          sysSel.dataset.prev = (sysSel.value ?? "").toString();
        }
      });

      $("addTradeCancel").onclick = ()=>{
        const prev = (tradeSel.dataset.prev ?? "").toString();
        hideAddBox("trade");
        tradeSel.value = prev;
      };
      $("addSysCancel").onclick = ()=>{
        const prev = (sysSel.dataset.prev ?? "").toString();
        hideAddBox("sys");
        sysSel.value = prev;
      };

      $("addTradeOk").onclick = ()=>{
        const v = norm($("addTradeInput").value);
        if(!v){ toast("工種不可空白"); $("addTradeInput").focus(); return; }
        if(addOptionToSelect(tradeSel, v)){
          hideAddBox("trade");
          toast("已加入工種");
          rebuildSysSelectByTrade(norm(sysSel.value));
        }
      };
      $("addSysOk").onclick = ()=>{
        const v = norm($("addSysInput").value);
        if(!v){ toast("系統不可空白"); $("addSysInput").focus(); return; }
        if(addOptionToSelect(sysSel, v)){
          hideAddBox("sys");
          toast("已加入系統");
        }
      };

      $("addTradeInput").addEventListener("keydown",(e)=>{
        if(e.key==="Enter"){ e.preventDefault(); $("addTradeOk").click(); }
        if(e.key==="Escape"){ e.preventDefault(); $("addTradeCancel").click(); }
      });
      $("addSysInput").addEventListener("keydown",(e)=>{
        if(e.key==="Enter"){ e.preventDefault(); $("addSysOk").click(); }
        if(e.key==="Escape"){ e.preventDefault(); $("addSysCancel").click(); }
      });
    }

    function start(){
      if(!ensureLoggedIn()) return;

      loadDB();
      rebuildNo();
      rebuildSelects(false);
      applyPermissionUI();

      $("navBackList").onclick = ()=>go("捷運汐止東湖線統包工程-資料明細表.html");
      setupMoreMenu("捷運汐止東湖線統包工程-資料明細表.html");

      $("btnBackXidong").onclick = ()=>go("汐東工程管理表.html");
      $("btnHome").onclick = ()=>go("index.html");

      $("btnCloudDB").onclick = ()=>{
        window.open(CLOUD_DB_URL, "_blank", "noopener,noreferrer");
      };

      $("btnReset").onclick = resetForm;
      $("btnSave").onclick = save;

      bindSelectAutoRefresh();
      bindAddUI();

      window.addEventListener("keydown",(e)=>{
        if(e.key === "Enter"){
          const tag = (document.activeElement?.tagName || "").toLowerCase();
          if(tag !== "textarea" && !($("loginMask").classList.contains("show"))) save();
        }
      });
    }

    (function bindLogin(){
      $("loginClose").onclick = closeLoginModal;
      $("loginToAuth").onclick = ()=> go("權限表.html");
      $("loginBtn").onclick = doLogin;

      $("loginUser").addEventListener("change", ()=>{
        if($("loginUser").value) $("loginPass").focus();
      });

      $("loginMask").addEventListener("click",(e)=>{
        if(e.target === $("loginMask")) closeLoginModal();
      });

      window.addEventListener("keydown",(e)=>{
        if(e.key === "Escape" && $("loginMask").classList.contains("show")) closeLoginModal();
        if(e.key === "Enter" && $("loginMask").classList.contains("show")) doLogin();
      });
    })();

    startSessionWatch();
    start();

    // =========================
    // ✅ 雲端同步接入（企業標準 v1）
    // resourceKey = pageKey、pk = uid
    // =========================
    (function(){
      function getLocal(){
        // 送出單一封包（items / counter / rev / updatedAt）
        const e = loadEnv();
        return {
          items: Array.isArray(e.items) ? e.items : [],
          counter: Number(e.counter || 0) || 0,
          rev: String(e.rev || "").trim(),
          updatedAt: String(e.updatedAt || "").trim()
        };
      }

      function apply(payload){
        // 相容：payload.items 或 payload.db
        const p = (payload && typeof payload === "object") ? payload : {};
        const base = (p.items && typeof p.items === "object") ? p : (p.db && typeof p.db === "object" ? p.db : p);

        const next = {
          items: Array.isArray(base.items) ? base.items.map(normalizeItem).filter(Boolean) : [],
          counter: Number(base.counter || 0) || 0,
          rev: String(base.rev || "").trim(),
          updatedAt: String(base.updatedAt || "").trim()
        };
        saveEnv(next);

        // 即時刷新 UI（同頁）
        try{
          loadDB();
          rebuildSelects(true);
          rebuildNo();
          applyPermissionUI();
        }catch(e){}

        // 觸發同頁監聽
        try{
          window.dispatchEvent(new StorageEvent("storage", { key: DB_KEY, storageArea: localStorage }));
        }catch(e){
          try{ window.dispatchEvent(new Event("storage")); }catch(_){}
        }
      }

      // 若 TasunCloudKit 尚未載入，靜默跳過（不影響 UI/功能）
      if(!window.TasunCloudKit || !window.TasunCloudKit.init || !window.TasunCloudKit.mount){
        console.warn("[enterprise v1] TasunCloudKit not found.");
        return;
      }

      const APP_VER = (window.__CACHE_V || (new URL(location.href)).searchParams.get("v") || "").trim();

      window.TasunCloudKit.init({
        appVer: APP_VER,
        resourcesUrl: "tasun-resources.json",
        resourceKey: pageKey,
        pk: "uid",
        ui: { enabled:false },
        lock: { enabled:false },
        getLocal,
        apply
      });

      let ctrl = null;
      try{
        ctrl = window.TasunCloudKit.mount({
          resourceKey: pageKey,
          resourcesUrl: "tasun-resources.json",
          pk: "uid",
          getLocal,
          apply
        });
      }catch(e){
        console.error("[enterprise v1] mount failed", e);
        return;
      }

      // 初次拉取（讓多設備立即一致）
      try{ ctrl && ctrl.pullNow && setTimeout(()=>{ try{ ctrl.pullNow(); }catch(_){ } }, 250); }catch(_){}

      // 偵測本機封包變化 → 雲端同步（穩定且不侵入 UI）
      let lastHash = "";
      function hashEnv(){
        try{
          const raw = localStorage.getItem(DB_KEY) || "";
          return String(raw.length) + "|" + fnv1a(raw);
        }catch(e){ return String(Date.now()); }
      }
      try{ lastHash = hashEnv(); }catch(_){}

      setInterval(()=>{
        const h = hashEnv();
        if(h !== lastHash){
          lastHash = h;
          try{ ctrl && ctrl.saveMerged && ctrl.saveMerged(); }catch(e){}
        }
      }, 10000);
    })();
  </script>

  <!-- ✅ 企業版：雲端同步核心（必須與全站同版號，由 tasun-version.json + ?v 控制快取） -->
  <script src="tasun-cloud-kit.js"></script>
</body>
</html>
