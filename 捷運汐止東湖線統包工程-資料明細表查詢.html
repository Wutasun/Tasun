<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />

  <!-- ✅✅✅ APP_VER 強制同步（全站共用） -->
  <script>
  (function(){
    const KEY = "tasun_app_ver_v1";
    const BUILTIN_VER = "2026.01.26.1";
    const norm = (s)=>(s??"").toString().trim();
    function withV(url, v){
      if(!url) return url;
      try{
        const uu = new URL(url, document.baseURI);
        if(uu.origin !== location.origin) return url;
        if(v) uu.searchParams.set("v", v);
        return uu.pathname + (uu.search || "") + (uu.hash || "");
      }catch(e){ return url; }
    }
    let stored = "";
    try{ stored = norm(localStorage.getItem(KEY)); }catch(e){}
    const ver = stored || BUILTIN_VER;
    try{ localStorage.setItem(KEY, ver); }catch(e){}
    window.APP_VER = ver;
    window.__withAPPVER = function(url){ return withV(url, window.APP_VER); };
    try{
      const onceKey = "tasun_app_ver_sync_once:" + location.pathname;
      const u = new URL(location.href);
      const cur = norm(u.searchParams.get("v"));
      if(!sessionStorage.getItem(onceKey) && ver && cur !== ver){
        sessionStorage.setItem(onceKey, "1");
        u.searchParams.set("v", ver);
        location.replace(u.toString());
      }
    }catch(e){}
  })();
  </script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>捷運汐止東湖線統包工程-資料明細表查詢 · Tasun</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#070809; --bg1:#0b0d10; --gold:#f6d37a;
      --border:rgba(246,211,122,.28); --border2:rgba(246,211,122,.40);
      --text:#ececec; --muted:rgba(236,236,236,.70);
      --shadow:0 18px 50px rgba(0,0,0,.55); --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text); font-family:"Noto Serif TC", serif;
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(246,211,122,.10), transparent 60%),
        radial-gradient(900px 520px at 85% 25%, rgba(246,211,122,.08), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    .wrap{max-width:1400px;margin:0 auto;padding:20px 16px 34px}

    .topbar{
      position:relative; z-index:20;
      display:grid; grid-template-columns: 1fr auto 1fr;
      gap:12px; align-items:center;
      padding:14px; border:1px solid var(--border); border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow); backdrop-filter:blur(10px);
    }
    @media (max-width:920px){
      .topbar{ grid-template-columns: 1fr; }
      .nav-left{ order:0; }
      .brand{ order:1; }
      .right{ order:2; justify-content:flex-start; }
    }
    .nav-left{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-start; min-width:220px; }
    .nav-desktop{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .nav-mobile{ display:none; gap:10px; align-items:center; width:100%; }
    @media (max-width:650px){ .nav-desktop{display:none} .nav-mobile{display:flex} }

    .brand{display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:0 6px;}
    .title{font-weight:900; letter-spacing:.06em; font-size: clamp(16px, 1.5vw, 20px); color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.22); line-height:1.25;}
    .sub{font-size:12px; color:var(--muted); letter-spacing:.08em; margin-top:4px}

    .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; min-width:220px;}
    @media (max-width:920px){ .right{justify-content:flex-start;} }

    .pill{
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.05);
      font-size:13px; color:rgba(236,236,236,.85);
      display:flex; gap:8px; align-items:center; white-space:nowrap;
    }
    .pill b{color:var(--gold)}

    .btn{
      appearance:none; border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(246,211,122,.18), rgba(246,211,122,.07));
      color:var(--gold); padding:9px 12px; border-radius:999px; cursor:pointer;
      font-family:inherit; font-weight:900; letter-spacing:.05em;
      box-shadow:0 10px 22px rgba(0,0,0,.35);
      transition:transform .12s ease, filter .12s ease;
      user-select:none; white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.06)}
    .btn:active{transform:translateY(0); filter:brightness(.98)}
    .btn.ghost{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.18);
      color:rgba(236,236,236,.85);
      font-weight:600;
    }
    .small{padding:8px 10px; font-size:12px; border-radius:999px; letter-spacing:.04em}

    .moreWrap{ position:relative; display:inline-flex; }
    .moreMenu{
      position:absolute; top:calc(100% + 8px); right:0;
      min-width: 250px;
      border-radius:16px;
      border:1px solid rgba(246,211,122,.30);
      background:linear-gradient(180deg, rgba(0,0,0,.72), rgba(0,0,0,.45));
      box-shadow:0 18px 50px rgba(0,0,0,.65);
      backdrop-filter:blur(10px);
      padding:8px;
      display:none;
      z-index:60;
    }
    .moreMenu.open{ display:block; }
    .menuItem{
      width:100%;
      text-align:left;
      border:none;
      background:rgba(255,255,255,.04);
      color:rgba(236,236,236,.92);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-family:inherit;
      letter-spacing:.04em;
    }
    .menuItem:hover{ background:rgba(246,211,122,.12); color:var(--gold); }
    .menuSep{ height:1px; margin:8px 6px; background:rgba(255,255,255,.10); }

    .panel{
      margin-top:16px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
    }

    .controls{
      display:grid;
      grid-template-columns: 1.3fr 1fr 1fr 1fr 1fr auto;
      gap:10px;
      align-items:end;
    }
    @media (max-width:1100px){ .controls{grid-template-columns:1fr 1fr 1fr} }
    @media (max-width:720px){ .controls{grid-template-columns:1fr} }

    .field{display:flex; flex-direction:column; gap:6px}
    .label{font-size:12px; letter-spacing:.08em; color:var(--muted)}
    input,select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);
      color:var(--text);
      padding:10px 12px;
      font-family:inherit;
      outline:none;
      transition:border-color .12s ease, filter .12s ease;
    }
    input:focus,select:focus{border-color:rgba(246,211,122,.55); filter:brightness(1.05)}

    .tableWrap{margin-top:14px; overflow:auto; border-radius:16px; border:1px solid rgba(255,255,255,.12)}
    table{width:100%; border-collapse:collapse; min-width:1200px; background:rgba(0,0,0,.18)}
    thead th{
      position:sticky; top:0; z-index:2;
      background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
      color:rgba(246,211,122,.95);
      font-size:13px; letter-spacing:.06em;
      text-align:left;
      padding:12px 12px;
      border-bottom:1px solid rgba(246,211,122,.25);
      white-space:nowrap;
    }
    tbody td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
      font-size:14px;
      color:rgba(236,236,236,.92);
    }
    tbody tr:hover td{background:rgba(255,255,255,.04)}
    .muted{color:rgba(236,236,236,.55)}
    .hint{margin-top:10px; color:var(--muted); font-size:13px; line-height:1.6}
    a.link{ color:rgba(246,211,122,.95); text-decoration:none; }
    a.link:hover{ text-decoration:underline; }

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.55);
      color:rgba(236,236,236,.92);
      font-size:13px;
      box-shadow:var(--shadow);
      display:none;
      z-index:200;
      backdrop-filter:blur(10px);
    }

    /* ===== Login Modal（共用）===== */
    .loginMask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.68);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:999;
    }
    .loginMask.show{display:flex;}
    .loginModal{
      width:min(520px, 96vw);
      border-radius:22px;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow:0 30px 90px rgba(0,0,0,.78);
      overflow:hidden;
      backdrop-filter:blur(12px);
    }
    .loginHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .loginTitle{
      font-weight:900; letter-spacing:.08em;
      color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.22);
    }
    .loginBody{padding:14px 16px 10px;}
    .loginFoot{
      padding:12px 16px;
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .loginErr{
      margin-top:10px;
      color:rgba(255,190,190,.95);
      font-size:13px;
      line-height:1.5;
      display:none;
      white-space:pre-wrap;
    }
    .loginHint{
      margin-top:10px;
      color:rgba(236,236,236,.65);
      font-size:12px;
      line-height:1.6;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="nav-left">
        <div class="nav-desktop">
          <button class="btn ghost small" id="navToEntry">前往登錄表</button>
          <button class="btn ghost small" id="navBackDB">返回資料庫</button>
          <button class="btn ghost small" id="navBackXidong">返回汐東工程管理表</button>
        </div>

        <div class="nav-mobile">
          <button class="btn ghost small" id="mBack">返回</button>
          <div class="moreWrap">
            <button class="btn ghost small" id="mMoreBtn" type="button">更多 ▾</button>
            <div class="moreMenu" id="mMoreMenu" role="menu" aria-label="更多選單">
              <button class="menuItem" data-href="捷運汐止東湖線統包工程-資料明細表登錄.html" type="button">前往登錄表</button>
              <button class="menuItem" data-href="捷運汐止東湖線統包工程-資料庫.html" type="button">返回資料庫</button>
              <button class="menuItem" data-href="汐東工程管理表.html" type="button">返回汐東工程管理表</button>
              <div class="menuSep"></div>
              <button class="menuItem" data-href="index.html" type="button">返回首頁</button>
            </div>
          </div>
        </div>
      </div>

      <div class="brand">
        <div class="title">捷運汐止東湖線統包工程-資料明細表查詢</div>
        <div class="sub">Standard v1 · resourceKey：tasun-sxdh-detail · pk=uid(uuid)</div>
      </div>

      <div class="right">
        <div class="pill">使用者：<b id="uName">—</b></div>
        <div class="pill">權限：<b id="uRole">—</b></div>
        <button class="btn ghost" id="btnHome">返回首頁</button>
        <button class="btn" id="btnReLogin">切換帳號</button>
      </div>
    </div>

    <div class="panel">
      <div class="controls">
        <div class="field">
          <div class="label">搜尋（文件名稱/工種/系統/備註/網址...）</div>
          <input id="q" placeholder="例如：電氣、排水、Dropbox..." />
        </div>
        <div class="field">
          <div class="label">工種</div>
          <select id="trade"><option value="">全部</option></select>
        </div>
        <div class="field">
          <div class="label">系統</div>
          <select id="system"><option value="">全部</option></select>
        </div>
        <div class="field">
          <div class="label">登錄日期（起）</div>
          <input id="from" type="date" />
        </div>
        <div class="field">
          <div class="label">登錄日期（迄）</div>
          <input id="to" type="date" />
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
          <button class="btn ghost" id="btnSync">同步</button>
          <button class="btn ghost" id="btnClear">清除條件</button>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:80px;">項次</th>
              <th style="width:140px;">登錄日期</th>
              <th style="width:360px;">文件名稱</th>
              <th style="width:160px;">工種</th>
              <th style="width:160px;">系統</th>
              <th style="width:220px;">電子檔</th>
              <th style="width:420px;">備註</th>
              <th style="width:180px;">更新時間</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="hint" id="hint"></div>
    </div>
  </div>

  <!-- Login Modal（共用） -->
  <div class="loginMask" id="loginMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="登入">
      <div class="loginHead">
        <div class="loginTitle">登入</div>
        <button class="btn ghost small" id="loginClose" type="button">關閉</button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label">帳號</div>
          <select id="loginUser" autocomplete="username">
            <option value="">請選擇帳號</option>
          </select>
        </div>
        <div class="field" style="margin-top:10px;">
          <div class="label">密碼</div>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="請輸入密碼" />
        </div>
        <div class="loginErr" id="loginErr"></div>
        <div class="loginHint">
          登入帳密完全以「權限表.html」的權限表（localStorage: <b>tasunAuthTable_v1</b>）為準。
        </div>
      </div>
      <div class="loginFoot">
        <button class="btn ghost" id="loginToAuth" type="button">前往權限表</button>
        <button class="btn" id="loginBtn" type="button">登入</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
/* ===========================
   TasunAuth 共用登入模組 v1
   =========================== */
window.TasunAuth = (function(){
  const CURRENT_KEY = "tasunCurrentUser_v1";
  const AUTH_KEY    = "tasunAuthTable_v1";
  const SESSION_WATCH_MS = 3000;

  let currentUser = null;
  let _watchStarted = false;

  const $ = (id)=>document.getElementById(id);
  const norm = (s)=>(s??"").toString().trim();

  function mapRole(v){
    const s=(v??"").toString().trim().toLowerCase();
    if(!s) return "read";
    if(s==="admin") return "admin";
    if(s==="write"||s==="edit") return "write";
    if(s==="read"||s==="view") return "read";
    if(s==="0") return "admin";
    if(s==="1") return "write";
    if(s==="2") return "read";
    return s;
  }
  function loadAuthTable(){
    try{
      const raw=localStorage.getItem(AUTH_KEY);
      if(!raw) return [];
      const parsed=JSON.parse(raw);
      if(Array.isArray(parsed)) return parsed;
      if(parsed && Array.isArray(parsed.users)) return parsed.users;
      return [];
    }catch(e){ return []; }
  }
  function pickUsername(row){ return norm(row?.username ?? row?.user ?? row?.account ?? row?.name); }
  function pickPassword(row){ return (row?.password ?? row?.pass ?? row?.pwd ?? "").toString(); }
  function pickRole(row){ return mapRole(row?.role ?? row?.level ?? row?.perm ?? row?.permission); }

  function findAuthUser(username){
    const u=norm(username).toLowerCase();
    if(!u) return null;
    const rows=loadAuthTable();
    for(const r of rows){
      const ru=pickUsername(r).toLowerCase();
      if(ru && ru===u){
        return { user: pickUsername(r), pass: pickPassword(r), role: pickRole(r) || "read" };
      }
    }
    return null;
  }

  function loadCurrentUser(){
    try{ currentUser = JSON.parse(localStorage.getItem(CURRENT_KEY) || "null"); }
    catch(e){ currentUser=null; }
    if(currentUser && typeof currentUser==="object"){
      const uname = norm(currentUser.user ?? currentUser.username ?? currentUser.name ?? currentUser.account);
      if(uname){ currentUser.user = uname; currentUser.username = uname; }
      currentUser.role = mapRole(currentUser.role ?? currentUser.level ?? "read");
      currentUser.level = currentUser.role;
      currentUser.authStamp = (currentUser.authStamp ?? "").toString();
    }
  }

  function setCurrentUser(user, role, authStamp){
    const u = { user, username:user, role: mapRole(role), level: mapRole(role), authStamp: (authStamp||"").toString() };
    localStorage.setItem(CURRENT_KEY, JSON.stringify(u));
    currentUser=u;
  }

  function role(){ return mapRole(currentUser?.role ?? currentUser?.level ?? "read"); }

  function fnv1a(str){
    let h = 0x811c9dc5;
    for(let i=0;i<str.length;i++){ h ^= str.charCodeAt(i); h = Math.imul(h, 0x01000193); }
    return (h >>> 0).toString(16).padStart(8, "0");
  }
  function authStampFromAuth(auth){ return fnv1a(`${auth.user}|${auth.pass ?? ""}`); }

  function rebuildUserDropdown(preselectUser){
    const sel = $("loginUser");
    const rows = loadAuthTable();
    const users = rows.map(r => pickUsername(r)).filter(Boolean);

    const seen = new Set();
    const uniq = [];
    for(const u of users){
      const k = u.toLowerCase();
      if(seen.has(k)) continue;
      seen.add(k);
      uniq.push(u);
    }

    sel.innerHTML = `<option value="">請選擇帳號</option>` + uniq.map(u=>{
      const s = (preselectUser && u.toLowerCase() === preselectUser.toLowerCase()) ? "selected" : "";
      return `<option value="${u.replace(/"/g,"&quot;")}" ${s}>${u}</option>`;
    }).join("");
  }

  function openLoginModal(msg){
    $("loginErr").style.display="none";
    if(msg){
      $("loginErr").textContent = msg;
      $("loginErr").style.display="block";
    }
    loadCurrentUser();
    rebuildUserDropdown(currentUser?.user || "");
    $("loginPass").value="";
    $("loginMask").classList.add("show");
    $("loginMask").setAttribute("aria-hidden","false");
    setTimeout(()=>{ if($("loginUser").value) $("loginPass").focus(); else $("loginUser").focus(); },0);
  }
  function closeLoginModal(){
    $("loginMask").classList.remove("show");
    $("loginMask").setAttribute("aria-hidden","true");
  }

  function ensureLoggedIn(){
    loadCurrentUser();
    const rows = loadAuthTable();
    if(!Array.isArray(rows) || rows.length === 0){
      openLoginModal("尚未建立權限表：請先到「權限表.html」建立帳號。");
      return false;
    }
    if(!currentUser || !currentUser.user){
      openLoginModal();
      return false;
    }
    const auth = findAuthUser(currentUser.user);
    if(!auth){ openLoginModal("帳號已被移除，請重新登入"); return false; }
    const stampNow = authStampFromAuth(auth);
    if(currentUser.authStamp && currentUser.authStamp !== stampNow){
      openLoginModal("密碼已更新，請重新登入");
      return false;
    }
    setCurrentUser(auth.user, auth.role || "read", stampNow);
    return true;
  }

  function doLogin(){
    const u = norm($("loginUser").value);
    const p = ($("loginPass").value ?? "").toString();
    const rows = loadAuthTable();

    if(!Array.isArray(rows) || rows.length === 0){
      $("loginErr").textContent = "尚未建立權限表：請先到「權限表.html」建立帳號。";
      $("loginErr").style.display = "block";
      return;
    }
    if(!u){
      $("loginErr").textContent = "請先選擇帳號。";
      $("loginErr").style.display = "block";
      return;
    }
    if(!p){
      $("loginErr").textContent = "請輸入密碼。";
      $("loginErr").style.display = "block";
      return;
    }

    const auth = findAuthUser(u);
    if(!auth){
      $("loginErr").textContent = "帳號不存在（以權限表為準）。";
      $("loginErr").style.display = "block";
      return;
    }
    if((auth.pass ?? "") !== p){
      $("loginErr").textContent = "密碼錯誤（以權限表為準）。";
      $("loginErr").style.display = "block";
      return;
    }

    const stampNow = authStampFromAuth(auth);
    setCurrentUser(auth.user, auth.role || "read", stampNow);

    closeLoginModal();
    if(typeof window.__onAuthed === "function") window.__onAuthed();
  }

  function validateSession(){
    const lm = $("loginMask");
    if(lm && lm.classList.contains("show")) return;

    loadCurrentUser();
    if(!currentUser || !currentUser.user) return;

    const auth = findAuthUser(currentUser.user);
    if(!auth){ openLoginModal("帳號已被移除，請重新登入"); return; }

    const stampNow = authStampFromAuth(auth);
    if(!currentUser.authStamp){
      setCurrentUser(auth.user, auth.role || "read", stampNow);
      return;
    }
    if(currentUser.authStamp !== stampNow){
      openLoginModal("密碼已更新，請重新登入");
      return;
    }
    const r = auth.role || "read";
    if(mapRole(currentUser.role) !== r){
      setCurrentUser(auth.user, r, stampNow);
    }
  }

  function startWatch(){
    if(_watchStarted) return;
    _watchStarted=true;
    window.addEventListener("storage",(e)=>{
      if(e.key === AUTH_KEY || e.key === CURRENT_KEY) validateSession();
    });
    setInterval(validateSession, SESSION_WATCH_MS);
  }

  function bindLogin(){
    $("loginClose").onclick = closeLoginModal;
    $("loginToAuth").onclick = ()=> location.href = (window.__withAPPVER ? window.__withAPPVER("權限表.html") : "權限表.html");
    $("loginBtn").onclick = doLogin;

    $("loginMask").addEventListener("click",(e)=>{
      if(e.target === $("loginMask")) closeLoginModal();
    });

    window.addEventListener("keydown",(e)=>{
      if(e.key === "Escape" && $("loginMask").classList.contains("show")) closeLoginModal();
      if(e.key === "Enter" && $("loginMask").classList.contains("show")) doLogin();
    });

    $("loginUser").addEventListener("change", ()=>{
      if($("loginUser").value) $("loginPass").focus();
    });
  }

  function init(){ bindLogin(); startWatch(); }
  function current(){ loadCurrentUser(); return currentUser; }

  return { init, ensureLoggedIn, validateSession, open: openLoginModal, current, role: ()=>{ loadCurrentUser(); return role(); } };
})();

/* ===========================
   Standard v1 · sxdh-detail
   =========================== */
const PAGE_KEY = "sxdh-detail-query";
const RESOURCE_KEY = "tasun-sxdh-detail";
const CACHE_KEY = "tasun_cloud_cache_v1:" + RESOURCE_KEY;

const $ = (id)=>document.getElementById(id);
const norm = (s)=>(s??"").toString().trim();
let db = [];

function go(url){ location.href = (window.__withAPPVER ? window.__withAPPVER(url) : url); }

function toast(msg){
  const t=$("toast");
  t.textContent=msg;
  t.style.display="block";
  clearTimeout(toast._tm);
  toast._tm=setTimeout(()=>t.style.display="none",2200);
}
function escHtml(s){
  return (s??"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#39;");
}
function normalizeRec(r){
  if(!r || typeof r!=="object") return null;
  const uid = (r.uid ?? "").toString();
  if(!uid) return null;
  return {
    uid,
    rev: Number(r.rev||0)||0,
    updatedAt: (r.updatedAt ?? "").toString(),
    deleted: !!r.deleted,
    id: r.id ?? "",
    docName: (r.docName ?? "").toString(),
    trade: (r.trade ?? "").toString(),
    system: (r.system ?? "").toString(),
    regDate: (r.regDate ?? "").toString(),
    fileUrl: (r.fileUrl ?? "").toString(),
    note: (r.note ?? "").toString(),
  };
}

function loadDB(){
  try{
    const raw = localStorage.getItem(CACHE_KEY) || "[]";
    const arr = JSON.parse(raw);
    db = Array.isArray(arr) ? arr.map(normalizeRec).filter(Boolean).filter(r=>!r.deleted) : [];
    db.sort((a,b)=>(b.updatedAt||"").localeCompare(a.updatedAt||"zh-Hant"));
  }catch(e){ db=[]; }
}
async function cloudPull(){
  const ck = window.TasunCloudKit;
  if(!ck || typeof ck.pull !== "function") return;
  try{
    const res = await ck.pull(RESOURCE_KEY);
    const items = Array.isArray(res) ? res : (res && Array.isArray(res.items) ? res.items : []);
    if(!items.length) return;

    const cur = new Map(db.map(x=>[x.uid, x]));
    items.map(normalizeRec).filter(Boolean).forEach(nr=>{
      const old = cur.get(nr.uid);
      if(!old){ cur.set(nr.uid, nr); return; }
      const a = (old.updatedAt||""); const b = (nr.updatedAt||"");
      if(b > a || (b===a && (nr.rev||0) >= (old.rev||0))) cur.set(nr.uid, nr);
    });
    const out = Array.from(cur.values()).filter(r=>!r.deleted);
    out.sort((a,b)=>(b.updatedAt||"").localeCompare(a.updatedAt||"zh-Hant"));
    localStorage.setItem(CACHE_KEY, JSON.stringify(out));
  }catch(e){}
}

function rebuildSelects(){
  const tradeSel = $("trade");
  const sysSel = $("system");
  const keepT = norm(tradeSel.value);
  const keepS = norm(sysSel.value);

  const trades = Array.from(new Set(db.map(r=>norm(r.trade)).filter(Boolean))).sort((a,b)=>a.localeCompare(b,"zh-Hant"));
  const systems = Array.from(new Set(db.map(r=>norm(r.system)).filter(Boolean))).sort((a,b)=>a.localeCompare(b,"zh-Hant"));

  tradeSel.innerHTML = '<option value="">全部</option>' + trades.map(v=>`<option value="${escHtml(v)}">${escHtml(v)}</option>`).join("");
  sysSel.innerHTML   = '<option value="">全部</option>' + systems.map(v=>`<option value="${escHtml(v)}">${escHtml(v)}</option>`).join("");

  if(keepT) tradeSel.value = keepT;
  if(keepS) sysSel.value = keepS;
}

function filtered(){
  const q = norm($("q").value).toLowerCase();
  const trade = norm($("trade").value);
  const system = norm($("system").value);
  const from = norm($("from").value);
  const to = norm($("to").value);

  let rows = db.slice();

  if(trade) rows = rows.filter(r=>norm(r.trade)===trade);
  if(system) rows = rows.filter(r=>norm(r.system)===system);

  if(from || to){
    rows = rows.filter(r=>{
      const d = norm(r.regDate);
      if(!d) return false;
      if(from && d < from) return false;
      if(to && d > to) return false;
      return true;
    });
  }

  if(q){
    rows = rows.filter(r=>{
      const hay = [r.docName, r.trade, r.system, r.regDate, r.fileUrl, r.note].map(x=>(x??"").toString().toLowerCase()).join(" | ");
      return hay.includes(q);
    });
  }

  rows.sort((a,b)=>(b.updatedAt||"").localeCompare(a.updatedAt||"zh-Hant"));
  return rows;
}

function render(){
  const rows = filtered();

  $("tbody").innerHTML = rows.map((r, idx)=>{
    const url = norm(r.fileUrl);
    const link = url ? `<a class="link" href="${escHtml(url)}" target="_blank" rel="noopener noreferrer">開啟</a>` : `<span class="muted">—</span>`;
    const upd = (r.updatedAt||"").replace("T"," ").replace("Z","");
    return `
      <tr>
        <td>${idx+1}</td>
        <td>${escHtml(r.regDate) || `<span class="muted">—</span>`}</td>
        <td>${escHtml(r.docName) || `<span class="muted">—</span>`}</td>
        <td>${escHtml(r.trade) || `<span class="muted">—</span>`}</td>
        <td>${escHtml(r.system) || `<span class="muted">—</span>`}</td>
        <td>${link}</td>
        <td>${escHtml(r.note) || `<span class="muted">—</span>`}</td>
        <td>${escHtml(upd) || `<span class="muted">—</span>`}</td>
      </tr>
    `;
  }).join("") || `<tr><td colspan="8" class="muted" style="padding:18px;">尚無符合資料</td></tr>`;

  $("hint").innerHTML = `筆數：<b style="color:var(--gold)">${rows.length}</b>。resourceKey：<b style="color:var(--gold)">${RESOURCE_KEY}</b>`;
}

function setupMoreMenu(backHref){
  const backBtn = $("mBack");
  const moreBtn = $("mMoreBtn");
  const menu = $("mMoreMenu");
  if(!backBtn || !moreBtn || !menu) return;

  const close = ()=> menu.classList.remove("open");
  const toggle = (e)=>{ e.preventDefault(); e.stopPropagation(); menu.classList.toggle("open"); };

  backBtn.onclick = ()=> go(backHref);
  moreBtn.addEventListener("click", toggle);

  menu.addEventListener("click", (e)=>{
    e.stopPropagation();
    const item = e.target.closest("button.menuItem[data-href]");
    if(!item) return;
    const href = item.getAttribute("data-href");
    if(href) go(href);
  });

  document.addEventListener("click", close);
  window.addEventListener("keydown", (e)=>{ if(e.key === "Escape") close(); });
}

function syncUserUI(){
  const u = TasunAuth.current();
  $("uName").textContent = u?.user || u?.username || "—";
  $("uRole").textContent = TasunAuth.role();
}

const WATCH_MS = 1500;
function startWatch(){
  let last = null;
  setInterval(()=>{
    const raw = localStorage.getItem(CACHE_KEY) || "";
    if(raw !== last){
      last = raw;
      loadDB();
      rebuildSelects();
      render();
    }
  }, WATCH_MS);

  window.addEventListener("storage",(e)=>{
    if(e.key === CACHE_KEY){
      loadDB(); rebuildSelects(); render();
    }
  });
}

function start(){
  if(!TasunAuth.ensureLoggedIn()) return;
  syncUserUI();

  $("navToEntry").onclick = ()=>go("捷運汐止東湖線統包工程-資料明細表登錄.html");
  $("navBackDB").onclick = ()=>go("捷運汐止東湖線統包工程-資料庫.html");
  $("navBackXidong").onclick = ()=>go("汐東工程管理表.html");
  setupMoreMenu("捷運汐止東湖線統包工程-資料庫.html");

  $("btnHome").onclick = ()=>go("index.html");
  $("btnReLogin").onclick = ()=> TasunAuth.open("請重新登入或切換帳號");

  $("btnClear").onclick = ()=>{
    $("q").value=""; $("trade").value=""; $("system").value=""; $("from").value=""; $("to").value="";
    render();
  };

  $("btnSync").onclick = ()=>{ toast("同步中…"); cloudPull().then(()=>{ loadDB(); rebuildSelects(); render(); toast("同步完成"); }); };

  loadDB();
  rebuildSelects();
  render();

  ["q","trade","system","from","to"].forEach(id=>{
    $(id).addEventListener("input", render);
    $(id).addEventListener("change", render);
  });

  cloudPull().then(()=>{ loadDB(); rebuildSelects(); render(); }).catch(()=>{});
  startWatch();
}

window.__onAuthed = ()=>{ toast("登入成功"); start(); };

TasunAuth.init();
start();
  </script>
</body>
</html>
