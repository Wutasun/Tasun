<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>工程審核明細表 · Tasun</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#070809;
      --bg1:#0b0d10;
      --gold:#f6d37a;
      --gold2:rgba(246,211,122,.55);
      --border:rgba(246,211,122,.28);
      --border2:rgba(246,211,122,.40);
      --text:#ececec;
      --muted:rgba(236,236,236,.70);
      --shadow:0 18px 50px rgba(0,0,0,.55);
      --r:18px;
      --stageSide: clamp(14px, 3.2vw, 80px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family:"Noto Serif TC", serif;
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(246,211,122,.10), transparent 60%),
        radial-gradient(900px 520px at 85% 25%, rgba(246,211,122,.08), transparent 62%),
        radial-gradient(1100px 700px at 55% 85%, rgba(246,211,122,.06), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{
      width: min(1720px, calc(100vw - (2 * var(--stageSide))));
      max-width:none;
      margin:0 auto;
      padding:20px 16px 34px;
    }

    .topbar{
      position:relative;
      z-index:20;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      gap:12px;
      align-items:center;
      padding:14px;
      border:1px solid var(--border);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
    }
    @media (max-width:920px){
      .topbar{ grid-template-columns: 1fr; }
      .nav-left{ order:0; }
      .brand{ order:1; }
      .right{ order:2; justify-content:flex-start; }
    }

    .nav-left{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:flex-start;
      min-width: 220px;
    }
    .nav-desktop{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .nav-mobile{ display:none; gap:10px; align-items:center; width:100%; }
    @media (max-width:600px){
      .nav-desktop{ display:none; }
      .nav-mobile{ display:flex; }
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:center;
      justify-content:center;
      text-align:center;
    }
    .title{
      font-weight:800;
      letter-spacing:.08em;
      font-size:20px;
      color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.22);
    }
    .sub{display:none;}

    .right{
      display:flex; gap:10px;
      align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
      min-width: 220px;
    }
    @media (max-width:920px){ .right{ justify-content:flex-start; } }

    .pill{
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.05);
      font-size:13px; color:rgba(236,236,236,.85);
      display:flex; gap:8px; align-items:center; white-space:nowrap;
    }
    .pill b{color:var(--gold)}
    @media (max-width:1100px){ .pill{ padding:7px 10px; font-size:12px; } }
    @media (max-width:700px){ .pill{ padding:6px 9px; font-size:11px; gap:6px; } }

    .btn{
      appearance:none;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(246,211,122,.18), rgba(246,211,122,.07));
      color:var(--gold);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-family:inherit;
      font-weight:800;
      letter-spacing:.05em;
      box-shadow:0 10px 22px rgba(0,0,0,.35);
      transition:transform .12s ease, filter .12s ease;
      user-select:none;
      white-space:nowrap;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.06)}
    .btn:active{transform:translateY(0); filter:brightness(.98)}
    .btn.ghost{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.18);
      color:rgba(236,236,236,.85);
      font-weight:600;
    }
    .btn.danger{
      border-color:rgba(255,120,120,.45);
      color:rgba(255,160,160,.95);
      background:rgba(255,120,120,.10);
    }
    .small{padding:8px 10px; font-size:12px; border-radius:999px; letter-spacing:.04em}

    .moreWrap{ position:relative; display:inline-flex; margin-left:auto; }
    .moreMenu{
      position:absolute;
      top:calc(100% + 8px);
      right:0;
      width:min(260px, calc(100vw - 28px));
      max-width:calc(100vw - 28px);
      border-radius:16px;
      border:1px solid rgba(246,211,122,.30);
      background:linear-gradient(180deg, rgba(0,0,0,.72), rgba(0,0,0,.45));
      box-shadow:0 18px 50px rgba(0,0,0,.65);
      backdrop-filter:blur(10px);
      padding:8px;
      display:none;
      z-index:60;
      overflow:hidden;
    }
    .moreMenu.open{ display:block; }
    .menuItem{
      width:100%;
      text-align:left;
      border:none;
      background:rgba(255,255,255,.04);
      color:rgba(236,236,236,.92);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-family:inherit;
      letter-spacing:.04em;
      text-decoration:none;
      display:block;
    }
    .menuItem:hover{ background:rgba(246,211,122,.12); color:var(--gold); }
    .menuSep{ height:1px; margin:8px 6px; background:rgba(255,255,255,.10); }

    .panel{
      margin-top:16px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
    }

    .controls{
      display:grid;
      grid-template-columns: 1.2fr .8fr .8fr .8fr .8fr auto;
      gap:10px;
      align-items:end;
    }
    @media (max-width:1200px){ .controls{grid-template-columns:1fr 1fr 1fr} }
    @media (max-width:820px){ .controls{grid-template-columns:1fr 1fr} }
    @media (max-width:520px){ .controls{grid-template-columns:1fr} }

    .field{display:flex; flex-direction:column; gap:6px}
    .label{font-size:12px; letter-spacing:.08em; color:var(--muted)}
    input,select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);
      color:var(--text);
      padding:10px 12px;
      font-family:inherit;
      outline:none;
      transition:border-color .12s ease, filter .12s ease;
    }
    input:focus,select:focus{border-color:rgba(246,211,122,.55); filter:brightness(1.05)}

    .tableWrap{
      margin-top:14px;
      overflow:auto;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
    }
    table{width:100%; border-collapse:collapse; min-width:1680px; background:rgba(0,0,0,.18)}
    thead th{
      position:sticky; top:0; z-index:2;
      background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
      color:rgba(246,211,122,.95);
      font-size:13px; letter-spacing:.06em;
      text-align:left;
      padding:12px 12px;
      border-bottom:1px solid rgba(246,211,122,.25);
      white-space:nowrap;
    }
    tbody td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
      font-size:14px;
      color:rgba(236,236,236,.92);
    }
    tbody tr:hover td{background:rgba(255,255,255,.04)}
    .link{ color:var(--gold); text-decoration:none; border-bottom:1px dashed rgba(246,211,122,.45); white-space:nowrap; }
    .link:hover{filter:brightness(1.1)}
    .muted{color:rgba(236,236,236,.55)}
    .rowBtns{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .hint{margin-top:10px; color:var(--muted); font-size:13px; line-height:1.6}

    .mask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:100;
    }
    .modal{
      width:min(980px, 96vw);
      border-radius:22px;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      box-shadow:0 30px 90px rgba(0,0,0,.75);
      overflow:hidden;
      backdrop-filter:blur(10px);
    }
    .mHead{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .mTitle{
      font-weight:900;
      letter-spacing:.08em;
      color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.22);
    }
    .mBody{padding:14px 16px 16px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .span2{grid-column:span 2}
    @media (max-width:860px){
      .grid{grid-template-columns:1fr}
      .span2{grid-column:span 1}
      table{min-width:1400px}
    }
    textarea{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);
      color:var(--text);
      padding:10px 12px;
      font-family:inherit;
      outline:none;
      min-height:88px;
      resize:vertical;
    }
    textarea:focus{border-color:rgba(246,211,122,.55); filter:brightness(1.05)}
    textarea:disabled{opacity:.55; cursor:not-allowed; filter:saturate(.85);}

    .inline2{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end}
    .miniHint{font-size:12px; color:rgba(236,236,236,.62); line-height:1.5}
    .mFoot{
      padding:14px 16px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      border-top:1px solid rgba(255,255,255,.10);
      flex-wrap:wrap;
    }

    .pMask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.65);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:160;
    }
    .pModal{
      width:min(520px, 96vw);
      border-radius:20px;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      box-shadow:0 30px 90px rgba(0,0,0,.75);
      overflow:hidden;
      backdrop-filter:blur(10px);
    }
    .pHead{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .pTitle{
      font-weight:900;
      letter-spacing:.08em;
      color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.22);
      font-size:16px;
    }
    .pBody{padding:14px}
    .pFoot{
      padding:12px 14px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.10);
    }

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.55);
      color:rgba(236,236,236,.92);
      font-size:13px;
      box-shadow:var(--shadow);
      display:none;
      z-index:200;
      backdrop-filter:blur(10px);
    }

    /* ===== Login Modal（共用）===== */
    .loginMask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.68);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:999;
    }
    .loginMask.show{display:flex;}
    .loginModal{
      width:min(520px, 96vw);
      border-radius:22px;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow:0 30px 90px rgba(0,0,0,.78);
      overflow:hidden;
      backdrop-filter:blur(12px);
    }
    .loginHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .loginTitle{
      font-weight:900; letter-spacing:.08em;
      color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.22);
    }
    .loginBody{padding:14px 16px 10px;}
    .loginFoot{
      padding:12px 16px;
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .loginErr{
      margin-top:10px;
      color:rgba(255,190,190,.95);
      font-size:13px;
      line-height:1.5;
      display:none;
      white-space:pre-wrap;
    }
    .loginHint{
      margin-top:10px;
      color:rgba(236,236,236,.65);
      font-size:12px;
      line-height:1.6;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="nav-left">
        <div class="nav-desktop">
          <!-- ✅ 全部改成 <a> 連結 -->
          <a class="btn ghost small" href="甄鼎quality.html">返回品質管理表</a>
          <a class="btn ghost small" href="index.html">返回首頁</a>

          <!-- ✅ 修正：改為「臻鼎工程審核明細登錄.html / 臻鼎工程審核明細查詢.html」 -->
          <a class="btn ghost small" href="臻鼎工程審核明細登錄.html">工程審核明細登錄</a>
          <a class="btn ghost small" href="臻鼎工程審核明細查詢.html">工程審核明細查詢</a>
        </div>

        <div class="nav-mobile">
          <a class="btn ghost small" id="mBack" href="index.html">返回</a>
          <div class="moreWrap">
            <button class="btn ghost small" id="mMoreBtn" type="button">更多 ▾</button>
            <div class="moreMenu" id="mMoreMenu" role="menu" aria-label="更多選單">
              <a class="menuItem" href="甄鼎quality.html">返回品質管理表</a>
              <div class="menuSep"></div>
              <a class="menuItem" href="index.html">返回首頁</a>
              <div class="menuSep"></div>
              <a class="menuItem" href="臻鼎工程審核明細表.html">工程審核明細表</a>

              <!-- ✅ 修正：手機更多選單也一併改 -->
              <a class="menuItem" href="臻鼎工程審核明細登錄.html">工程審核明細登錄</a>
              <a class="menuItem" href="臻鼎工程審核明細查詢.html">工程審核明細查詢</a>

              <div class="menuSep"></div>
              <a class="menuItem" href="權限表.html">權限表</a>
            </div>
          </div>
        </div>
      </div>

      <div class="brand">
        <div class="title">工程審核明細表</div>
        <div class="sub">項次 · 文件文號 · 文件名稱 · 工種 · 系統 · 版本 · 日期 · 狀態</div>
      </div>

      <div class="right">
        <div class="pill">使用者：<b id="uName">—</b></div>
        <div class="pill">權限：<b id="uRole">—</b></div>
        <button class="btn ghost" id="btnExport" type="button">匯出 CSV</button>
        <button class="btn" id="btnAdd" type="button">新增</button>
      </div>
    </div>

    <div class="panel">
      <div class="controls">
        <div class="field">
          <div class="label">搜尋（文號 / 名稱 / 工種 / 系統 / 版本 / 狀態 / 類別 / 備註 / 連結）</div>
          <input id="q" placeholder="例如：LJS-D-035、機電、退件、計劃書..." />
        </div>

        <div class="field">
          <div class="label">工種</div>
          <select id="fTrade"><option value="">全部</option></select>
        </div>

        <div class="field">
          <div class="label">系統</div>
          <select id="fSys"><option value="">全部</option></select>
        </div>

        <div class="field">
          <div class="label">版本</div>
          <select id="fVer"><option value="">全部</option></select>
        </div>

        <div class="field">
          <div class="label">審核狀態</div>
          <select id="fStatus"><option value="">全部</option></select>
        </div>

        <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
          <button class="btn ghost" id="btnClear" type="button">清除條件</button>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:80px;">項次</th>
              <th style="width:160px;">文件文號</th>
              <th style="width:260px;">文件名稱</th>
              <th style="width:120px;">工種</th>
              <th style="width:160px;">系統</th>
              <th style="width:120px;">版本</th>
              <th style="width:140px;">送審日期</th>
              <th style="width:140px;">審核狀態</th>
              <th style="width:140px;">審核日期</th>
              <th style="width:140px;">文件類別</th>
              <th style="width:110px;">電子檔</th>
              <th style="width:320px;">備註</th>
              <th style="width:170px;">操作</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="hint" id="hint"></div>
    </div>
  </div>

  <!-- Edit/View Modal -->
  <div class="mask" id="mask">
    <div class="modal">
      <div class="mHead">
        <div class="mTitle" id="mTitle">新增</div>
        <button class="btn ghost small" id="btnClose" type="button">關閉</button>
      </div>
      <div class="mBody">
        <div class="grid">
          <div class="field">
            <div class="label">文件類別（影響文號前綴）</div>
            <div class="inline2">
              <select id="mDocType"></select>
              <button class="btn ghost small" id="btnAddType" type="button">新增類別</button>
            </div>
            <div class="miniHint">計劃書→LJS-P；施工圖→LJS-D；廠商資格→LJS-M。</div>
          </div>

          <div class="field">
            <div class="label">文件文號（輸入流水號數字，例如 35）</div>
            <input id="mSerial" placeholder="例如：35" inputmode="numeric" />
            <div class="miniHint">預覽：<b id="mDocPreview" style="color:var(--gold)">—</b></div>
          </div>

          <div class="field span2">
            <div class="label">文件名稱</div>
            <input id="mName" placeholder="例如：電氣系統施工圖（核准版）" />
          </div>

          <div class="field">
            <div class="label">工種（預設：機電/營造；仍可新增）</div>
            <div class="inline2">
              <select id="mTrade"></select>
              <button class="btn ghost small" id="btnAddTrade" type="button">新增工種</button>
            </div>
          </div>

          <div class="field">
            <div class="label">系統</div>
            <div class="inline2">
              <select id="mSys"></select>
              <button class="btn ghost small" id="btnAddSys" type="button">新增系統</button>
            </div>
          </div>

          <div class="field">
            <div class="label">版本</div>
            <div class="inline2">
              <select id="mVer"></select>
              <button class="btn ghost small" id="btnAddVer" type="button">新增版本</button>
            </div>
          </div>

          <div class="field">
            <div class="label">審核狀態</div>
            <div class="inline2">
              <select id="mStatus"></select>
              <button class="btn ghost small" id="btnAddStatus" type="button">新增狀態</button>
            </div>
          </div>

          <div class="field">
            <div class="label">送審日期</div>
            <input id="mSubmitDate" type="date" />
          </div>

          <div class="field">
            <div class="label">審核日期</div>
            <input id="mReviewDate" type="date" />
          </div>

          <div class="field span2">
            <div class="label">電子檔（超連結網址）</div>
            <input id="mUrl" type="url" placeholder="https://..." />
          </div>

          <div class="field span2">
            <div class="label">備註</div>
            <textarea id="mRemark" placeholder="可輸入文字..."></textarea>
          </div>
        </div>
      </div>
      <div class="mFoot">
        <button class="btn danger" id="btnDelete" style="display:none;" type="button">刪除</button>
        <button class="btn ghost" id="btnCancel" type="button">取消</button>
        <button class="btn" id="btnSave" type="button">儲存</button>
      </div>
    </div>
  </div>

  <!-- Prompt：新增選項 -->
  <div class="pMask" id="pMask">
    <div class="pModal">
      <div class="pHead">
        <div class="pTitle" id="pTitle">新增</div>
        <button class="btn ghost small" id="pClose" type="button">關閉</button>
      </div>
      <div class="pBody">
        <div class="field">
          <div class="label" id="pLabel">請輸入</div>
          <input id="pInput" placeholder="請輸入..." />
          <div class="miniHint">新增後會加入選單來源（字典），以維持資料一致。</div>
        </div>
      </div>
      <div class="pFoot">
        <button class="btn ghost" id="pCancel" type="button">取消</button>
        <button class="btn" id="pOk" type="button">確定新增</button>
      </div>
    </div>
  </div>

  <!-- Login Modal（共用） -->
  <div class="loginMask" id="loginMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="登入">
      <div class="loginHead">
        <div class="loginTitle">登入</div>
        <button class="btn ghost small" id="loginClose" type="button">關閉</button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label">帳號</div>
          <select id="loginUser" autocomplete="username">
            <option value="">請選擇帳號</option>
          </select>
        </div>
        <div class="field" style="margin-top:10px;">
          <div class="label">密碼</div>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="請輸入密碼" />
        </div>
        <div class="loginErr" id="loginErr"></div>
        <div class="loginHint">
          登入帳密完全以「權限表.html」的權限表（localStorage: <b>tasunAuthTable_v1</b>）為準。
        </div>
      </div>
      <div class="loginFoot">
        <a class="btn ghost" href="權限表.html">前往權限表</a>
        <button class="btn" id="loginBtn" type="button">登入</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ===== Keys =====
    const CURRENT_KEY = "tasunCurrentUser_v1";
    const AUTH_KEY    = "tasunAuthTable_v1";

    const DB_KEY      = "tasunAuditDetail_v1";
    const COUNTER_KEY = "tasunAuditDetail_counter_v1";

    const VER_DICT    = "tasunAuditDetail_versions_v1";
    const SYS_DICT    = "tasunAuditDetail_systems_v1";
    const STATUS_DICT = "tasunAuditDetail_status_v1";
    const TYPE_DICT   = "tasunAuditDetail_docTypes_v1";
    const TRADE_DICT  = "tasunAuditDetail_trades_v1";

    // ===== DocNo =====
    const TYPE_PREFIX = { "計劃書":"LJS-P-","施工圖":"LJS-D-","廠商資格":"LJS-M-" };
    const FIXED_TYPES = ["計劃書","施工圖","廠商資格"];
    const FIXED_TRADES = ["機電","營造"];

    let currentUser=null;
    let db=[];
    let editingId=null;
    let promptMode=null;

    const $=(id)=>document.getElementById(id);
    const norm=(s)=>(s??"").toString().trim();

    function digitsOnly(s){ return (s ?? "").toString().replace(/[^\d]/g, ""); }
    function pad3(nStr){
      const s=(nStr??"").toString();
      if(!s) return "";
      return s.length>=3 ? s : ("000".slice(s.length)+s);
    }
    function getPrefix(type){ return TYPE_PREFIX[norm(type)] || ""; }
    function formatDocNo(type, serialInput){
      const d=digitsOnly(serialInput);
      if(!d) return "";
      const pre=getPrefix(type);
      return pre ? (pre + pad3(d)) : pad3(d);
    }

    function toast(msg){
      const t=$("toast");
      t.textContent=msg;
      t.style.display="block";
      clearTimeout(toast._tm);
      toast._tm=setTimeout(()=>t.style.display="none",2200);
    }
    function escHtml(s){
      return (s??"").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // ===== CSV Export =====
    function csvEscape(v){
      const s = (v ?? "").toString();
      if(/[",\r\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
      return s;
    }
    function downloadCSV(filename, headers, rows){
      const bom = "\uFEFF";
      const lines = [];
      lines.push(headers.map(csvEscape).join(","));
      for(const r of rows){
        lines.push(r.map(csvEscape).join(","));
      }
      const blob = new Blob([bom + lines.join("\r\n")], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{
        URL.revokeObjectURL(a.href);
        a.remove();
      },0);
    }

    // ===== Auth =====
    function mapRole(v){
      const s=(v??"").toString().trim().toLowerCase();
      if(!s) return "read";
      if(s==="admin") return "admin";
      if(s==="write"||s==="edit") return "write";
      if(s==="read"||s==="view") return "read";
      if(s==="0") return "admin";
      if(s==="1") return "write";
      if(s==="2") return "read";
      return s;
    }
    function loadAuthTable(){
      try{
        const raw=localStorage.getItem(AUTH_KEY);
        if(!raw) return [];
        const parsed=JSON.parse(raw);
        if(Array.isArray(parsed)) return parsed;
        if(parsed && Array.isArray(parsed.users)) return parsed.users;
        return [];
      }catch(e){ return []; }
    }
    function pickUsername(row){ return norm(row?.username ?? row?.user ?? row?.account ?? row?.name); }
    function pickPassword(row){ return (row?.password ?? row?.pass ?? row?.pwd ?? "").toString(); }
    function pickRole(row){ return mapRole(row?.role ?? row?.level ?? row?.perm ?? row?.permission); }

    function findAuthUser(username){
      const u=norm(username).toLowerCase();
      if(!u) return null;
      const rows=loadAuthTable();
      for(const r of rows){
        const ru=pickUsername(r).toLowerCase();
        if(ru && ru===u){
          return { user: pickUsername(r), pass: pickPassword(r), role: pickRole(r) || "read" };
        }
      }
      return null;
    }

    function loadCurrentUser(){
      try{ currentUser=JSON.parse(localStorage.getItem(CURRENT_KEY) || "null"); }
      catch(e){ currentUser=null; }
      if(currentUser && typeof currentUser==="object"){
        const uname=norm(currentUser.user ?? currentUser.username ?? currentUser.account ?? currentUser.name);
        if(uname){
          currentUser.user=uname;
          currentUser.username=uname;
        }
        currentUser.role=mapRole(currentUser.role ?? currentUser.level ?? "read");
        currentUser.level=currentUser.role;
        currentUser.authStamp=(currentUser.authStamp ?? "").toString();
      }
    }
    function setCurrentUser(user, role, authStamp){
      const obj={ user, username:user, role:mapRole(role), level:mapRole(role), authStamp:(authStamp||"").toString() };
      localStorage.setItem(CURRENT_KEY, JSON.stringify(obj));
      currentUser=obj;
    }
    function role(){ return mapRole(currentUser?.role ?? currentUser?.level ?? "read"); }
    function canWrite(){ const r=role(); return r==="admin" || r==="write"; }
    function isAdmin(){ return role()==="admin"; }

    // ===== Session Watch Patch =====
    const SESSION_WATCH_MS=3000;
    let _watchStarted=false;
    function fnv1a(str){
      let h=0x811c9dc5;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 0x01000193);
      }
      return (h>>>0).toString(16).padStart(8,"0");
    }
    function authStampFromAuth(auth){ return fnv1a(`${auth.user}|${auth.pass ?? ""}`); }

    function rebuildUserDropdown(preselectUser){
      const sel=$("loginUser");
      const rows=loadAuthTable();
      const users=rows.map(r=>pickUsername(r)).filter(Boolean);

      const seen=new Set();
      const uniq=[];
      for(const u of users){
        const k=u.toLowerCase();
        if(seen.has(k)) continue;
        seen.add(k);
        uniq.push(u);
      }

      sel.innerHTML = `<option value="">請選擇帳號</option>` + uniq.map(u=>{
        const s=(preselectUser && u.toLowerCase()===preselectUser.toLowerCase()) ? "selected":"";
        return `<option value="${escHtml(u)}" ${s}>${escHtml(u)}</option>`;
      }).join("");
    }

    function openLoginModal(msg){
      $("loginErr").style.display="none";
      if(msg){
        $("loginErr").textContent=msg;
        $("loginErr").style.display="block";
      }
      loadCurrentUser();
      rebuildUserDropdown(currentUser?.user || "");
      $("loginPass").value="";
      $("loginMask").classList.add("show");
      $("loginMask").setAttribute("aria-hidden","false");
      setTimeout(()=>{
        if($("loginUser").value) $("loginPass").focus();
        else $("loginUser").focus();
      },0);
    }
    function closeLoginModal(){
      $("loginMask").classList.remove("show");
      $("loginMask").setAttribute("aria-hidden","true");
    }

    function forceReLogin(msg){
      try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}
      currentUser=null;
      toast(msg || "權限表已更新，請重新登入");
      openLoginModal(msg || "權限表已更新，請重新登入");
      $("uName").textContent="—";
      $("uRole").textContent="—";
    }

    function validateSession(){
      const lm=$("loginMask");
      if(lm && lm.classList.contains("show")) return;

      loadCurrentUser();
      if(!currentUser || !currentUser.user) return;

      const auth=findAuthUser(currentUser.user);
      if(!auth){ forceReLogin("帳號已被移除，請重新登入"); return; }

      const stampNow=authStampFromAuth(auth);
      if(!currentUser.authStamp){
        setCurrentUser(auth.user, auth.role || "read", stampNow);
        $("uName").textContent=auth.user;
        $("uRole").textContent=role();
        return;
      }
      if(currentUser.authStamp !== stampNow){
        forceReLogin("密碼已更新，請重新登入");
        return;
      }
      const r=auth.role || "read";
      if(mapRole(currentUser.role) !== r){
        setCurrentUser(auth.user, r, stampNow);
        $("uRole").textContent=r;
      }
    }

    function startSessionWatch(){
      if(_watchStarted) return;
      _watchStarted=true;

      window.addEventListener("storage",(e)=>{
        if(e.key===AUTH_KEY || e.key===CURRENT_KEY) validateSession();
        if(e.key===DB_KEY || e.key===VER_DICT || e.key===SYS_DICT || e.key===STATUS_DICT || e.key===TYPE_DICT || e.key===TRADE_DICT){
          loadDB();
          render();
        }
      });
      setInterval(validateSession, SESSION_WATCH_MS);
    }

    function ensureLoggedIn(){
      loadCurrentUser();
      const rows=loadAuthTable();
      if(!Array.isArray(rows) || rows.length===0){
        openLoginModal("尚未建立權限表：請先到「權限表.html」建立帳號。");
        return false;
      }
      if(!currentUser || !currentUser.user){
        openLoginModal();
        return false;
      }
      const auth=findAuthUser(currentUser.user);
      if(!auth){ forceReLogin("帳號已被移除，請重新登入"); return false; }

      const stampNow=authStampFromAuth(auth);
      if(currentUser.authStamp && currentUser.authStamp !== stampNow){
        forceReLogin("密碼已更新，請重新登入");
        return false;
      }
      setCurrentUser(auth.user, auth.role || "read", stampNow);
      $("uName").textContent=auth.user;
      $("uRole").textContent=role();
      return true;
    }

    function doLogin(){
      const u=norm($("loginUser").value);
      const p=($("loginPass").value ?? "").toString();
      const rows=loadAuthTable();

      if(!Array.isArray(rows) || rows.length===0){
        $("loginErr").textContent="尚未建立權限表：請先到「權限表.html」建立帳號。";
        $("loginErr").style.display="block";
        return;
      }
      if(!u){
        $("loginErr").textContent="請先選擇帳號。";
        $("loginErr").style.display="block";
        return;
      }
      if(!p){
        $("loginErr").textContent="請輸入密碼。";
        $("loginErr").style.display="block";
        return;
      }

      const auth=findAuthUser(u);
      if(!auth){
        $("loginErr").textContent="帳號不存在（以權限表為準）。";
        $("loginErr").style.display="block";
        return;
      }
      if((auth.pass ?? "") !== p){
        $("loginErr").textContent="密碼錯誤（以權限表為準）。";
        $("loginErr").style.display="block";
        return;
      }

      setCurrentUser(auth.user, auth.role || "read", authStampFromAuth(auth));
      closeLoginModal();
      toast("登入成功");
      start();
    }

    // ===== DB + Dict =====
    function getCounter(){
      const n=Number(localStorage.getItem(COUNTER_KEY) || "0");
      return Number.isFinite(n) ? n : 0;
    }
    function nextCounter(){
      const n=getCounter()+1;
      localStorage.setItem(COUNTER_KEY, String(n));
      return n;
    }

    function loadDB(){
      try{
        db=JSON.parse(localStorage.getItem(DB_KEY) || "[]");
        if(!Array.isArray(db)) db=[];
      }catch(e){ db=[]; }

      let changed=false;
      for(const r of db){
        if(r && typeof r==="object"){
          if(r.id == null || !Number.isFinite(Number(r.id))){
            r.id = nextCounter();
            changed=true;
          }
          if(r.name == null) { r.name = ""; changed=true; }
          if(r.trade == null) { r.trade = ""; changed=true; }
          if(r.docType == null) { r.docType = ""; changed=true; }
          if(r.serial == null) { r.serial = ""; changed=true; }
          if(r.version == null) { r.version = ""; changed=true; }
          if(r.system == null) { r.system = ""; changed=true; }
          if(r.status == null) { r.status = ""; changed=true; }
          if(r.submitDate == null) { r.submitDate = ""; changed=true; }
          if(r.reviewDate == null) { r.reviewDate = ""; changed=true; }
          if(r.url == null) { r.url = ""; changed=true; }
          if(r.remark == null) { r.remark = ""; changed=true; }
        }
      }
      if(changed) saveDB();
    }
    function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }

    function loadDict(key){
      try{
        const raw=localStorage.getItem(key);
        const arr=raw?JSON.parse(raw):[];
        return Array.isArray(arr)?arr.map(norm).filter(Boolean):[];
      }catch(e){ return []; }
    }
    function saveDict(key, arr){ localStorage.setItem(key, JSON.stringify(arr)); }

    function uniqueFromDB(field){
      const set=new Set();
      for(const r of db){
        const v=norm(r[field]);
        if(v) set.add(v);
      }
      return set;
    }
    function unionOptions(field, dictKey, fixedArr){
      const set=new Set();
      if(Array.isArray(fixedArr)) for(const v of fixedArr) set.add(norm(v));
      for(const v of uniqueFromDB(field)) set.add(v);
      for(const v of loadDict(dictKey)) set.add(v);
      set.delete("");
      const arr=Array.from(set);
      arr.sort((a,b)=>a.localeCompare(b,"zh-Hant"));
      return arr;
    }

    function rebuildFilters(){
      const keepTrade=norm($("fTrade").value);
      const keepSys=norm($("fSys").value);
      const keepVer=norm($("fVer").value);
      const keepStatus=norm($("fStatus").value);

      const trades = unionOptions("trade", TRADE_DICT, FIXED_TRADES);
      const sys    = unionOptions("system", SYS_DICT);
      const vers   = unionOptions("version", VER_DICT);
      const st     = unionOptions("status", STATUS_DICT);

      $("fTrade").innerHTML = `<option value="">全部</option>` + trades.map(v=>`<option value="${escHtml(v)}">${escHtml(v)}</option>`).join("");
      $("fSys").innerHTML   = `<option value="">全部</option>` + sys.map(v=>`<option value="${escHtml(v)}">${escHtml(v)}</option>`).join("");
      $("fVer").innerHTML   = `<option value="">全部</option>` + vers.map(v=>`<option value="${escHtml(v)}">${escHtml(v)}</option>`).join("");
      $("fStatus").innerHTML= `<option value="">全部</option>` + st.map(v=>`<option value="${escHtml(v)}">${escHtml(v)}</option>`).join("");

      if(trades.includes(keepTrade)) $("fTrade").value=keepTrade;
      if(sys.includes(keepSys)) $("fSys").value=keepSys;
      if(vers.includes(keepVer)) $("fVer").value=keepVer;
      if(st.includes(keepStatus)) $("fStatus").value=keepStatus;
    }

    function filteredRows(){
      const q=norm($("q").value).toLowerCase();
      const trade=norm($("fTrade").value);
      const sys=norm($("fSys").value);
      const ver=norm($("fVer").value);
      const status=norm($("fStatus").value);

      let rows=db.slice();

      if(trade) rows=rows.filter(r=>norm(r.trade)===trade);
      if(sys) rows=rows.filter(r=>norm(r.system)===sys);
      if(ver) rows=rows.filter(r=>norm(r.version)===ver);
      if(status) rows=rows.filter(r=>norm(r.status)===status);

      if(q){
        rows=rows.filter(r=>{
          const docNo = formatDocNo(r.docType, r.serial);
          const hay=[docNo,r.name,r.trade,r.system,r.version,r.status,r.docType,r.submitDate,r.reviewDate,r.url,r.remark]
            .map(x=>(x??"").toString().toLowerCase()).join(" | ");
          return hay.includes(q);
        });
      }

      rows.sort((a,b)=>{
        const s1=norm(b.submitDate||"").localeCompare(norm(a.submitDate||""));
        if(s1!==0) return s1;
        const s2=norm(b.reviewDate||"").localeCompare(norm(a.reviewDate||""));
        if(s2!==0) return s2;
        return Number(b.id||0) - Number(a.id||0);
      });

      return rows;
    }

    function render(){
      rebuildFilters();

      const rows=filteredRows();
      const writable=canWrite();

      $("tbody").innerHTML = rows.map((r, idx)=>{
        const docNo = formatDocNo(r.docType, r.serial) || "—";
        const url=norm(r.url);
        const linkCell = url
          ? `<a class="link" href="${escHtml(url)}" target="_blank" rel="noopener">開啟</a>`
          : `<span class="muted">—</span>`;

        return `
          <tr>
            <td>${idx+1}</td>
            <td>${escHtml(docNo)}</td>
            <td>${escHtml(r.name||"") || `<span class="muted">—</span>`}</td>
            <td>${escHtml(r.trade||"") || `<span class="muted">—</span>`}</td>
            <td>${escHtml(r.system||"") || `<span class="muted">—</span>`}</td>
            <td>${escHtml(r.version||"") || `<span class="muted">—</span>`}</td>
            <td>${escHtml(r.submitDate||"") || `<span class="muted">—</span>`}</td>
            <td>${escHtml(r.status||"") || `<span class="muted">—</span>`}</td>
            <td>${escHtml(r.reviewDate||"") || `<span class="muted">—</span>`}</td>
            <td>${escHtml(r.docType||"") || `<span class="muted">—</span>`}</td>
            <td>${linkCell}</td>
            <td>${escHtml(r.remark||"") || `<span class="muted">—</span>`}</td>
            <td>
              <div class="rowBtns">
                <button class="btn ghost small" data-act="view" data-id="${r.id}" type="button">查看</button>
                ${writable ? `<button class="btn small" data-act="edit" data-id="${r.id}" type="button">編輯</button>` : ``}
              </div>
            </td>
          </tr>
        `;
      }).join("") || `
        <tr>
          <td colspan="13" class="muted" style="padding:18px;">尚無資料（可到「工程審核明細登錄」建立第一筆）</td>
        </tr>
      `;

      $("hint").innerHTML =
        `目前為 <b style="color:var(--gold)">${writable ? "可維護模式" : "唯讀模式"}</b>（role: ${escHtml(role())}）。` +
        ` 筆數：<b style="color:var(--gold)">${rows.length}</b>。`;
    }

    // ===== Modal =====
    function setModalEditable(editable){
      $("btnSave").style.display = editable ? "inline-block" : "none";
      $("btnDelete").style.display = (editable && isAdmin() && editingId!=null) ? "inline-block" : "none";

      const ids=["mDocType","mSerial","mName","mTrade","mSys","mVer","mStatus","mSubmitDate","mReviewDate","mUrl","mRemark",
        "btnAddType","btnAddTrade","btnAddSys","btnAddVer","btnAddStatus"];
      for(const id of ids){
        if($(id)) $(id).disabled = !editable;
      }
      const allowAdd = editable && canWrite();
      ["btnAddType","btnAddTrade","btnAddSys","btnAddVer","btnAddStatus"].forEach(id=>{
        if($(id)) $(id).style.display = allowAdd ? "inline-block" : "none";
      });
    }

    function fillSelectWithPlaceholder(selId, options, placeholder, keepValue){
      const sel=$(selId);
      const keep=norm(keepValue);
      sel.innerHTML =
        `<option value="" disabled ${keep ? "" : "selected"}>${escHtml(placeholder || "請選擇")}</option>` +
        options.map(v=>`<option value="${escHtml(v)}">${escHtml(v)}</option>`).join("");
      if(keep && options.includes(keep)) sel.value=keep;
    }

    function refreshModalOptions(keep){
      const prevType = keep ? norm($("mDocType").value) : "";
      const prevTrade= keep ? norm($("mTrade").value) : "";
      const prevSys  = keep ? norm($("mSys").value) : "";
      const prevVer  = keep ? norm($("mVer").value) : "";
      const prevSt   = keep ? norm($("mStatus").value) : "";

      const types  = unionOptions("docType", TYPE_DICT, FIXED_TYPES);
      const trades = unionOptions("trade", TRADE_DICT, FIXED_TRADES);
      const sys    = unionOptions("system", SYS_DICT);
      const vers   = unionOptions("version", VER_DICT);
      const st     = unionOptions("status", STATUS_DICT);

      fillSelectWithPlaceholder("mDocType", types,  "（請選擇文件類別 / 或先新增）", prevType);
      fillSelectWithPlaceholder("mTrade",   trades, "（請選擇工種 / 或先新增）",     prevTrade);
      fillSelectWithPlaceholder("mSys",     sys,    "（請選擇系統 / 或先新增）",     prevSys);
      fillSelectWithPlaceholder("mVer",     vers,   "（請選擇版本 / 或先新增）",     prevVer);
      fillSelectWithPlaceholder("mStatus",  st,     "（請選擇狀態 / 或先新增）",     prevSt);

      updateModalPreview();
    }

    function updateModalPreview(){
      const docNo = formatDocNo(norm($("mDocType").value), norm($("mSerial").value));
      $("mDocPreview").textContent = docNo || "—";
    }

    function openModal(id, editable){
      validateSession();
      if(!currentUser || !currentUser.user){
        openLoginModal();
        return;
      }

      refreshModalOptions(false);

      const item = (id!=null) ? (db.find(x=>Number(x.id)===Number(id)) || null) : null;
      editingId = item ? Number(item.id) : null;

      $("mTitle").textContent = editable ? (item ? "編輯資料" : "新增資料") : "查看資料";
      setModalEditable(editable);

      const today = new Date().toISOString().slice(0,10);

      $("mDocType").value = item?.docType || "";
      $("mSerial").value  = item?.serial || "";
      $("mName").value    = item?.name || "";
      $("mTrade").value   = item?.trade || "";
      $("mSys").value     = item?.system || "";
      $("mVer").value     = item?.version || "";
      $("mStatus").value  = item?.status || "";
      $("mSubmitDate").value = item?.submitDate || today;
      $("mReviewDate").value = item?.reviewDate || "";
      $("mUrl").value     = item?.url || "";
      $("mRemark").value  = item?.remark || "";

      refreshModalOptions(true);
      updateModalPreview();

      $("mask").style.display="flex";
    }

    function closeModal(){ $("mask").style.display="none"; }

    function saveItem(){
      validateSession();
      if(!currentUser || !currentUser.user){ openLoginModal(); return; }
      if(!canWrite()){ toast("唯讀權限不可儲存"); return; }

      const docType = norm($("mDocType").value);
      const serial  = digitsOnly($("mSerial").value);
      const name    = norm($("mName").value);
      const trade   = norm($("mTrade").value);
      const system  = norm($("mSys").value);
      const version = norm($("mVer").value);
      const status  = norm($("mStatus").value);
      const submitDate = norm($("mSubmitDate").value);
      const reviewDate = norm($("mReviewDate").value);
      const url     = norm($("mUrl").value);
      const remark  = norm($("mRemark").value);

      if(!docType){ toast("請先選擇文件類別"); return; }
      if(!serial){ toast("請在文件文號欄輸入流水號數字"); $("mSerial").focus(); return; }
      if(!name){ toast("文件名稱不可空白"); $("mName").focus(); return; }
      if(!trade){ toast("請先選擇工種（或先新增工種）"); return; }
      if(!system){ toast("請先選擇系統（或先新增系統）"); return; }
      if(!version){ toast("請先選擇版本（或先新增版本）"); return; }
      if(!status){ toast("請先選擇審核狀態（或先新增狀態）"); return; }
      if(!submitDate){ toast("請選擇送審日期"); return; }

      const row = { id: editingId ?? nextCounter(), docType, serial, name, trade, system, version, status, submitDate, reviewDate, url, remark };

      const key = [docType, serial, version, system, trade].join("|").toLowerCase();
      const isDup = db.some(x=>{
        if(editingId!=null && Number(x.id)===Number(editingId)) return false;
        const k2=[norm(x.docType), digitsOnly(x.serial), norm(x.version), norm(x.system), norm(x.trade)].join("|").toLowerCase();
        return k2===key;
      });
      if(isDup){
        toast("此筆資料已存在（類別+流水號+版本+系統+工種），請調整後再儲存");
        return;
      }

      if(editingId!=null){
        const idx=db.findIndex(x=>Number(x.id)===Number(editingId));
        if(idx>=0) db[idx]=row;
      }else{
        db.unshift(row);
      }

      saveDB();
      closeModal();
      render();
      toast("已儲存");
    }

    function deleteItem(){
      validateSession();
      if(!currentUser || !currentUser.user){ openLoginModal(); return; }
      if(!isAdmin()){ toast("僅 admin 可刪除"); return; }
      if(editingId==null) return;
      if(!confirm("確定刪除這筆資料？")) return;

      db = db.filter(x=>Number(x.id)!==Number(editingId));
      saveDB();

      closeModal();
      render();
      toast("已刪除");
    }

    // ===== Prompt新增 =====
    function openPrompt(mode){
      validateSession();
      if(!currentUser || !currentUser.user){ openLoginModal(); return; }
      if(!canWrite()){ toast("read 權限不可新增"); return; }

      promptMode=mode;
      $("pInput").value="";

      if(mode==="trade"){
        $("pTitle").textContent="新增工種";
        $("pLabel").textContent="請輸入新的工種";
        $("pInput").placeholder="例如：機電 / 營造 / 景觀...";
      }else if(mode==="type"){
        $("pTitle").textContent="新增文件類別";
        $("pLabel").textContent="請輸入新的文件類別";
        $("pInput").placeholder="例如：計劃書 / 施工圖 / 廠商資格...";
      }else if(mode==="ver"){
        $("pTitle").textContent="新增版本";
        $("pLabel").textContent="請輸入新的版本";
        $("pInput").placeholder="例如：A / B / R1...";
      }else if(mode==="sys"){
        $("pTitle").textContent="新增系統";
        $("pLabel").textContent="請輸入新的系統";
        $("pInput").placeholder="例如：電氣 / 空調 / 消防...";
      }else{
        $("pTitle").textContent="新增審核狀態";
        $("pLabel").textContent="請輸入新的審核狀態";
        $("pInput").placeholder="例如：送審 / 退件 / 核准...";
      }

      $("pMask").style.display="flex";
      setTimeout(()=>$("pInput").focus(),0);
    }
    function closePrompt(){ $("pMask").style.display="none"; promptMode=null; }

    function dictKeyByMode(mode){
      if(mode==="trade") return TRADE_DICT;
      if(mode==="type") return TYPE_DICT;
      if(mode==="ver")  return VER_DICT;
      if(mode==="sys")  return SYS_DICT;
      return STATUS_DICT;
    }
    function fixedByMode(mode){
      if(mode==="trade") return FIXED_TRADES;
      if(mode==="type") return FIXED_TYPES;
      return null;
    }

    function addOption(){
      if(!canWrite()) return;

      const v=norm($("pInput").value);
      if(!v){ toast("不可空白"); $("pInput").focus(); return; }

      const dk=dictKeyByMode(promptMode);
      const fixed=fixedByMode(promptMode);
      const existLower = new Set(
        unionOptions(
          promptMode==="trade" ? "trade" :
          promptMode==="type" ? "docType" :
          promptMode==="ver" ? "version" :
          promptMode==="sys" ? "system" : "status",
          dk,
          fixed
        ).map(x=>x.toLowerCase())
      );
      if(existLower.has(v.toLowerCase())){ toast("已存在相同選項"); return; }

      const dict=loadDict(dk);
      dict.push(v);
      dict.sort((a,b)=>a.localeCompare(b,"zh-Hant"));
      saveDict(dk, dict);

      refreshModalOptions(true);
      rebuildFilters();

      if(promptMode==="trade") $("mTrade").value=v;
      if(promptMode==="type") $("mDocType").value=v;
      if(promptMode==="ver") $("mVer").value=v;
      if(promptMode==="sys") $("mSys").value=v;
      if(promptMode==="status") $("mStatus").value=v;

      closePrompt();
      render();
      toast("已新增選項");
    }

    // ===== Export =====
    function exportCurrent(){
      const rows = filteredRows();
      const headers = ["項次","文件文號","文件名稱","工種","系統","版本","送審日期","審核狀態","審核日期","文件類別","電子檔","備註"];
      const body = rows.map((r, idx)=>{
        const docNo = formatDocNo(r.docType, r.serial);
        return [
          String(idx+1),
          docNo || "",
          norm(r.name),
          norm(r.trade),
          norm(r.system),
          norm(r.version),
          norm(r.submitDate),
          norm(r.status),
          norm(r.reviewDate),
          norm(r.docType),
          norm(r.url),
          norm(r.remark)
        ];
      });
      const stamp = new Date().toISOString().slice(0,19).replaceAll(":","").replace("T","_");
      downloadCSV(`工程審核明細表_${stamp}.csv`, headers, body);
      toast("已匯出 CSV");
    }

    // ===== Mobile more menu =====
    function bindMoreMenu(){
      const moreBtn=$("mMoreBtn");
      const menu=$("mMoreMenu");
      if(!moreBtn || !menu) return;

      const close=()=>menu.classList.remove("open");
      const toggle=(e)=>{
        e.preventDefault();
        e.stopPropagation();
        menu.classList.toggle("open");
      };
      moreBtn.addEventListener("click", toggle);
      menu.addEventListener("click", ()=>close());
      document.addEventListener("click", close);
      window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") close(); });
    }

    function start(){
      if(!ensureLoggedIn()) return;

      loadDB();
      bindMoreMenu();

      $("btnAdd").onclick=()=>{
        if(!canWrite()){ toast("read 權限不可新增"); return; }
        openModal(null, true);
      };
      $("btnExport").onclick=exportCurrent;

      $("q").addEventListener("input", render);
      $("fTrade").addEventListener("change", render);
      $("fSys").addEventListener("change", render);
      $("fVer").addEventListener("change", render);
      $("fStatus").addEventListener("change", render);
      $("btnClear").onclick=()=>{
        $("q").value="";
        $("fTrade").value="";
        $("fSys").value="";
        $("fVer").value="";
        $("fStatus").value="";
        render();
      };

      $("btnClose").onclick=()=>closeModal();
      $("btnCancel").onclick=()=>closeModal();
      $("mask").addEventListener("click",(e)=>{ if(e.target===$("mask")) closeModal(); });

      $("btnSave").onclick=saveItem;
      $("btnDelete").onclick=deleteItem;

      $("mDocType").addEventListener("change", updateModalPreview);
      $("mSerial").addEventListener("input", updateModalPreview);

      $("btnAddTrade").onclick=()=>openPrompt("trade");
      $("btnAddType").onclick =()=>openPrompt("type");
      $("btnAddVer").onclick  =()=>openPrompt("ver");
      $("btnAddSys").onclick  =()=>openPrompt("sys");
      $("btnAddStatus").onclick=()=>openPrompt("status");

      $("pClose").onclick=closePrompt;
      $("pCancel").onclick=closePrompt;
      $("pOk").onclick=addOption;
      $("pMask").addEventListener("click",(e)=>{ if(e.target===$("pMask")) closePrompt(); });

      $("tbody").addEventListener("click",(e)=>{
        const btn=e.target.closest("button[data-act]");
        if(!btn) return;
        const act=btn.getAttribute("data-act");
        const id=Number(btn.getAttribute("data-id"));
        if(!Number.isFinite(id)) return;

        if(act==="view") openModal(id, false);
        if(act==="edit"){
          if(!canWrite()){ toast("唯讀權限不可編輯"); return; }
          openModal(id, true);
        }
      });

      window.addEventListener("keydown",(e)=>{
        if(e.key==="Escape"){
          if($("pMask").style.display==="flex") closePrompt();
          else if($("mask").style.display==="flex") closeModal();
        }
        if(e.key==="Enter" && $("pMask").style.display==="flex") addOption();
      });

      render();
    }

    // ===== Login Modal Bindings =====
    (function bindLogin(){
      $("loginClose").onclick=closeLoginModal;
      $("loginBtn").onclick=doLogin;

      $("loginMask").addEventListener("click",(e)=>{ if(e.target===$("loginMask")) closeLoginModal(); });
      window.addEventListener("keydown",(e)=>{
        if(e.key==="Escape" && $("loginMask").classList.contains("show")) closeLoginModal();
        if(e.key==="Enter" && $("loginMask").classList.contains("show")) doLogin();
      });
      $("loginUser").addEventListener("change",()=>{ if($("loginUser").value) $("loginPass").focus(); });
    })();

    startSessionWatch();
    start();
  </script>
</body>
</html>
