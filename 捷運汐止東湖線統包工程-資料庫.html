<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>捷運汐止東湖線統包工程-資料庫 · Tasun</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#070809;
      --bg1:#0b0d10;
      --gold:#f6d37a;
      --gold2:rgba(246,211,122,.55);
      --border:rgba(246,211,122,.28);
      --border2:rgba(246,211,122,.40);
      --text:#ececec;
      --muted:rgba(236,236,236,.70);
      --shadow:0 18px 50px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family:"Noto Serif TC", serif;
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(246,211,122,.10), transparent 60%),
        radial-gradient(900px 520px at 85% 25%, rgba(246,211,122,.08), transparent 62%),
        radial-gradient(1100px 700px at 55% 85%, rgba(246,211,122,.06), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:20px 16px 34px}

    .topbar{
      position:relative;
      z-index:20;
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:12px;
      align-items:center;
      padding:14px;
      border:1px solid var(--border);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
    }
    @media (max-width:920px){
      .topbar{grid-template-columns:1fr}
      .nav-left{order:0}
      .brand{order:1}
      .right{order:2; justify-content:flex-start}
    }

    .nav-left{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-start;}
    .brand{
      display:flex; flex-direction:column; gap:4px;
      align-items:center; justify-content:center; text-align:center;
    }
    .title{
      font-weight:900; letter-spacing:.12em;
      font-size:22px; color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.22);
    }
    .sub{font-size:12px; color:var(--muted); letter-spacing:.10em}

    .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    @media (max-width:920px){ .right{justify-content:flex-start;} }

    .pill{
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.05);
      font-size:13px; color:rgba(236,236,236,.85);
      display:flex; gap:8px; align-items:center; white-space:nowrap;
    }
    .pill b{color:var(--gold)}

    .btn{
      appearance:none;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(246,211,122,.18), rgba(246,211,122,.07));
      color:var(--gold);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-family:inherit;
      font-weight:900;
      letter-spacing:.05em;
      box-shadow:0 10px 22px rgba(0,0,0,.35);
      transition:transform .12s ease, filter .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.06)}
    .btn:active{transform:translateY(0); filter:brightness(.98)}
    .btn.ghost{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.18);
      color:rgba(236,236,236,.85);
      font-weight:600;
    }
    .small{padding:8px 10px; font-size:12px; border-radius:999px; letter-spacing:.04em}

    .panel{
      margin-top:16px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:18px;
    }

    .cards{
      display:flex;
      flex-wrap:wrap;
      gap:14px;
      justify-content:center;
      align-items:stretch;
    }
    .card{
      flex:1 1 260px;
      min-width:260px;
      border-radius:999px;
      border:1px solid rgba(246,211,122,.28);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:0 18px 50px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      padding:16px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      cursor:pointer;
      transition: transform .12s ease, filter .12s ease;
      user-select:none;
    }
    .card:hover{ transform: translateY(-2px); filter: brightness(1.06); }
    .card:active{ transform: translateY(0); filter: brightness(.99); }

    .card .name{
      font-weight:900;
      letter-spacing:.08em;
      color:rgba(246,211,122,.96);
      font-size:16px;
      text-shadow:0 0 16px rgba(246,211,122,.14);
      white-space:nowrap;
    }
    .card .desc{
      font-size:12px;
      color:rgba(236,236,236,.70);
      letter-spacing:.06em;
      margin-top:4px;
    }
    .card .rightTag{
      border-radius:999px;
      padding:7px 10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:rgba(236,236,236,.80);
      font-size:12px;
      white-space:nowrap;
    }

    /* ===== 共用 Toast ===== */
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.55);
      color:rgba(236,236,236,.92);
      font-size:13px;
      box-shadow:var(--shadow);
      display:none;
      z-index:200;
      backdrop-filter:blur(10px);
    }

    /* ===== 共用登入 Login Modal（四頁一致）===== */
    .loginMask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.68);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:999;
    }
    .loginMask.show{display:flex;}
    .loginModal{
      width:min(520px, 96vw);
      border-radius:22px;
      border:1px solid rgba(246,211,122,.40);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow:0 30px 90px rgba(0,0,0,.78);
      overflow:hidden;
      backdrop-filter:blur(12px);
    }
    .loginHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .loginTitle{
      font-weight:900; letter-spacing:.08em;
      color:#f6d37a;
      text-shadow:0 0 18px rgba(246,211,122,.22);
    }
    .loginBody{padding:14px 16px 10px;}
    .loginFoot{
      padding:12px 16px;
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .loginErr{
      margin-top:10px;
      color:rgba(255,190,190,.95);
      font-size:13px;
      line-height:1.5;
      display:none;
      white-space: pre-wrap;
    }
    .loginHint{
      margin-top:10px;
      color:rgba(236,236,236,.65);
      font-size:12px;
      line-height:1.6;
    }
    .field{display:flex; flex-direction:column; gap:6px}
    .label{font-size:12px; letter-spacing:.08em; color:rgba(236,236,236,.70)}
    input,select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);
      color:rgba(236,236,236,.92);
      padding:10px 12px;
      font-family:inherit;
      outline:none;
      transition:border-color .12s ease, filter .12s ease;
    }
    input:focus,select:focus{border-color:rgba(246,211,122,.55); filter:brightness(1.05)}
    .loginBody select{
      appearance:none;
      -webkit-appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(236,236,236,.85) 50%),
        linear-gradient(135deg, rgba(236,236,236,.85) 50%, transparent 50%);
      background-position:
        calc(100% - 18px) 50%,
        calc(100% - 12px) 50%;
      background-size: 6px 6px, 6px 6px;
      background-repeat:no-repeat;
      padding-right:34px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="nav-left">
        <button class="btn ghost small" id="btnHome">返回首頁</button>
      </div>

      <div class="brand">
        <!-- ✅ 這裡把「工程資料」改成「汐東線資料」 -->
        <div class="title">汐 東 線 資 料</div>
        <div class="sub">登錄 / 查詢 / 明細表（權限表控管）</div>
      </div>

      <div class="right">
        <div class="pill">使用者：<b id="uName">—</b></div>
        <div class="pill">權限：<b id="uRole">—</b></div>
        <button class="btn" id="btnReLogin">切換帳號</button>
      </div>
    </div>

    <div class="panel">
      <div class="cards">
        <div class="card" data-href="捷運汐止東湖線統包工程-資料明細表登錄.html">
          <div>
            <div class="name">資料明細表登錄</div>
            <div class="desc">新增文件資料（系統/工種）</div>
          </div>
          <div class="rightTag">REG</div>
        </div>

        <div class="card" data-href="捷運汐止東湖線統包工程-資料明細表查詢.html">
          <div>
            <div class="name">資料明細表查詢</div>
            <div class="desc">純查詢 / 篩選 / 點連結開啟</div>
          </div>
          <div class="rightTag">QUERY</div>
        </div>

        <div class="card" data-href="捷運汐止東湖線統包工程-資料明細表.html">
          <div>
            <div class="name">資料明細表</div>
            <div class="desc">查看 /（write 可編輯）/（admin 可刪除）</div>
          </div>
          <div class="rightTag">LIST</div>
        </div>

        <div class="card" data-href="https://www.dropbox.com/" id="btnCloud">
          <div>
            <div class="name">雲端資料庫入口</div>
            <div class="desc">保持原網址（可自行改成你專案的入口）</div>
          </div>
          <div class="rightTag">CLOUD</div>
        </div>
      </div>
    </div>
  </div>

  <!-- 共用登入 Login Modal（四頁一致） -->
  <div class="loginMask" id="loginMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="登入">
      <div class="loginHead">
        <div class="loginTitle">登入</div>
        <button class="btn ghost small" id="loginClose" type="button">關閉</button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label">帳號</div>
          <select id="loginUser" autocomplete="username">
            <option value="">請選擇帳號</option>
          </select>
        </div>
        <div class="field" style="margin-top:10px;">
          <div class="label">密碼</div>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="請輸入密碼" />
        </div>
        <div class="loginErr" id="loginErr"></div>
        <div class="loginHint">
          登入帳密以「權限表.html」權限表（localStorage: <b>tasunAuthTable_v1</b>）為準。
        </div>
      </div>
      <div class="loginFoot">
        <button class="btn ghost" id="loginToAuth" type="button">前往權限表</button>
        <button class="btn" id="loginBtn" type="button">登入</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
/* ===========================
   TasunAuth 共用登入模組 v1
   四頁完全一致
   =========================== */
window.TasunAuth = (function(){
  const CURRENT_KEY = "tasunCurrentUser_v1";
  const AUTH_KEY    = "tasunAuthTable_v1";
  const SESSION_WATCH_MS = 3000;

  let currentUser = null;
  let _watchStarted = false;
  let _onAuthed = null;
  let _onSessionChange = null;
  let _onForceRelogin = null;

  const $ = (id)=>document.getElementById(id);
  const norm = (s)=>(s??"").toString().trim();

  function mapRole(v){
    const s=(v??"").toString().trim().toLowerCase();
    if(!s) return "read";
    if(s==="admin") return "admin";
    if(s==="write"||s==="edit") return "write";
    if(s==="read"||s==="view") return "read";
    if(s==="0") return "admin";
    if(s==="1") return "write";
    if(s==="2") return "read";
    return s;
  }

  function loadAuthTable(){
    try{
      const raw=localStorage.getItem(AUTH_KEY);
      if(!raw) return [];
      const parsed=JSON.parse(raw);
      if(Array.isArray(parsed)) return parsed;
      if(parsed && Array.isArray(parsed.users)) return parsed.users;
      return [];
    }catch(e){ return []; }
  }

  function pickUsername(row){
    return norm(row?.user ?? row?.username ?? row?.account ?? row?.name);
  }
  function pickPassword(row){
    return (row?.pass ?? row?.password ?? row?.pwd ?? "").toString();
  }
  function pickRole(row){
    return mapRole(row?.role ?? row?.level ?? row?.perm ?? row?.permission);
  }

  function findAuthUser(username){
    const u=norm(username).toLowerCase();
    if(!u) return null;
    const rows=loadAuthTable();
    for(const r of rows){
      const ru=pickUsername(r).toLowerCase();
      if(ru && ru===u){
        return { username: pickUsername(r), password: pickPassword(r), role: pickRole(r) || "read" };
      }
    }
    return null;
  }

  function loadCurrentUser(){
    try{ currentUser = JSON.parse(localStorage.getItem(CURRENT_KEY) || "null"); }
    catch(e){ currentUser=null; }
    if(currentUser && typeof currentUser==="object"){
      const uname = norm(currentUser.username ?? currentUser.user ?? currentUser.name ?? currentUser.account);
      if(uname) currentUser.username = uname;
      if(currentUser.role) currentUser.role = mapRole(currentUser.role);
      if(currentUser.level) currentUser.level = mapRole(currentUser.level);
      currentUser.authStamp = (currentUser.authStamp ?? "").toString();
    }
  }

  function setCurrentUser(username, role, authStamp){
    const u = { username, user: username, role: mapRole(role), level: mapRole(role), authStamp: authStamp || "" };
    localStorage.setItem(CURRENT_KEY, JSON.stringify(u));
    currentUser = u;
  }

  function role(){ return mapRole(currentUser?.role ?? currentUser?.level ?? "read"); }
  function canWrite(){ const r=role(); return r==="admin" || r==="write"; }
  function isAdmin(){ return role()==="admin"; }

  function fnv1a(str){
    let h = 0x811c9dc5;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 0x01000193);
    }
    return (h >>> 0).toString(16).padStart(8, "0");
  }
  function authStampFromAuth(auth){
    return fnv1a(`${auth.username}|${auth.password ?? ""}`);
  }

  function rebuildUserDropdown(preselectUser){
    const sel = $("loginUser");
    if(!sel) return;

    const rows = loadAuthTable();
    const users = rows.map(r => pickUsername(r)).filter(x => !!norm(x));

    const seen = new Set();
    const uniq = [];
    for(const u of users){
      const k = u.toLowerCase();
      if(seen.has(k)) continue;
      seen.add(k);
      uniq.push(u);
    }

    sel.innerHTML =
      `<option value="">請選擇帳號</option>` +
      uniq.map(u=>{
        const s = (preselectUser && u.toLowerCase() === preselectUser.toLowerCase()) ? "selected" : "";
        const vv = u.replace(/"/g,"&quot;");
        return `<option value="${vv}" ${s}>${u}</option>`;
      }).join("");
  }

  function openLoginModal(msg){
    const mask=$("loginMask");
    const err=$("loginErr");
    if(!mask) return;

    if(err){
      err.style.display="none";
      if(msg){
        err.textContent = msg;
        err.style.display="block";
      }
    }

    loadCurrentUser();
    rebuildUserDropdown(currentUser?.username || "");
    const pass=$("loginPass");
    if(pass) pass.value="";

    mask.classList.add("show");
    mask.setAttribute("aria-hidden","false");

    setTimeout(()=>{
      const userSel=$("loginUser");
      if(userSel && userSel.value && pass) pass.focus();
      else if(userSel) userSel.focus();
    },0);
  }

  function closeLoginModal(){
    const mask=$("loginMask");
    if(!mask) return;
    mask.classList.remove("show");
    mask.setAttribute("aria-hidden","true");
  }

  function fireSessionChange(){
    if(typeof _onSessionChange === "function") _onSessionChange(current());
  }

  function forceReLogin(msg){
    try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}
    currentUser = null;

    if(typeof _onForceRelogin === "function") _onForceRelogin(msg || "");
    openLoginModal(msg || "權限表已更新，請重新登入");
    fireSessionChange();
  }

  function validateSession(){
    const mask=$("loginMask");
    if(mask && mask.classList.contains("show")) return;

    loadCurrentUser();
    if(!currentUser || !currentUser.username) return;

    const auth = findAuthUser(currentUser.username);
    if(!auth){
      forceReLogin("帳號已被移除，請重新登入");
      return;
    }

    const stampNow = authStampFromAuth(auth);

    if(!currentUser.authStamp){
      setCurrentUser(auth.username, auth.role || "read", stampNow);
      fireSessionChange();
      return;
    }

    if(currentUser.authStamp !== stampNow){
      forceReLogin("密碼已更新，請重新登入");
      return;
    }

    const r = auth.role || "read";
    if(mapRole(currentUser.role) !== r){
      setCurrentUser(auth.username, r, stampNow);
      fireSessionChange();
    }
  }

  function ensureLoggedIn(){
    loadCurrentUser();
    const rows = loadAuthTable();
    if(!Array.isArray(rows) || rows.length === 0){
      openLoginModal("尚未建立權限表：請先到「權限表.html」建立帳號。");
      return false;
    }

    if(!currentUser || !currentUser.username){
      openLoginModal();
      return false;
    }

    const auth = findAuthUser(currentUser.username);
    if(!auth){
      forceReLogin("帳號已被移除，請重新登入");
      return false;
    }

    const stampNow = authStampFromAuth(auth);
    if(currentUser.authStamp && currentUser.authStamp !== stampNow){
      forceReLogin("密碼已更新，請重新登入");
      return false;
    }

    setCurrentUser(auth.username, auth.role || "read", stampNow);
    fireSessionChange();
    return true;
  }

  function doLogin(){
    const userSel=$("loginUser");
    const passEl=$("loginPass");
    const err=$("loginErr");

    const u = norm(userSel ? userSel.value : "");
    const p = (passEl ? passEl.value : "").toString();
    const rows = loadAuthTable();

    function showErr(m){
      if(!err) return;
      err.textContent = m;
      err.style.display="block";
    }

    if(!Array.isArray(rows) || rows.length === 0) return showErr("尚未建立權限表：請先到「權限表.html」建立帳號。");
    if(!u) return showErr("請先選擇帳號。");
    if(!p) return showErr("請輸入密碼。");

    const auth = findAuthUser(u);
    if(!auth) return showErr("帳號不存在（以權限表為準）。");
    if((auth.password ?? "") !== p) return showErr("密碼錯誤（以權限表為準）。");

    const stampNow = authStampFromAuth(auth);
    setCurrentUser(auth.username, auth.role || "read", stampNow);

    closeLoginModal();
    fireSessionChange();
    if(typeof _onAuthed === "function") _onAuthed(current());
  }

  function bindUI(){
    const closeBtn=$("loginClose");
    const toAuth=$("loginToAuth");
    const loginBtn=$("loginBtn");
    const mask=$("loginMask");
    const userSel=$("loginUser");

    if(closeBtn) closeBtn.onclick = closeLoginModal;
    if(toAuth) toAuth.onclick = ()=> location.href="權限表.html";
    if(loginBtn) loginBtn.onclick = doLogin;

    if(userSel){
      userSel.addEventListener("change", ()=>{
        const pass=$("loginPass");
        if(userSel.value && pass) pass.focus();
      });
    }

    if(mask){
      mask.addEventListener("click",(e)=>{
        if(e.target === mask) closeLoginModal();
      });
    }

    window.addEventListener("keydown",(e)=>{
      const mask=$("loginMask");
      if(!mask) return;
      if(e.key === "Escape" && mask.classList.contains("show")) closeLoginModal();
      if(e.key === "Enter" && mask.classList.contains("show")) doLogin();
    });
  }

  function startWatch(){
    if(_watchStarted) return;
    _watchStarted = true;

    window.addEventListener("storage", (e)=>{
      if(e.key === AUTH_KEY || e.key === CURRENT_KEY){
        validateSession();
      }
    });
    setInterval(validateSession, SESSION_WATCH_MS);
  }

  function init(opts){
    _onAuthed = opts?.onAuthed || null;
    _onSessionChange = opts?.onSessionChange || null;
    _onForceRelogin = opts?.onForceRelogin || null;
    bindUI();
    startWatch();
  }

  function current(){ loadCurrentUser(); return currentUser; }

  return {
    init,
    ensureLoggedIn,
    validateSession,
    open: openLoginModal,
    close: closeLoginModal,
    current,
    role: ()=>{ loadCurrentUser(); return role(); },
    canWrite: ()=>{ loadCurrentUser(); return canWrite(); },
    isAdmin: ()=>{ loadCurrentUser(); return isAdmin(); },
  };
})();

    // ===== Page =====
    const $ = (id)=>document.getElementById(id);

    function toast(msg){
      const t=$("toast");
      t.textContent=msg;
      t.style.display="block";
      clearTimeout(toast._tm);
      toast._tm=setTimeout(()=>t.style.display="none",2200);
    }

    function syncUserUI(){
      const u = TasunAuth.current();
      $("uName").textContent = u?.username || "—";
      $("uRole").textContent = TasunAuth.role();
    }

    function start(){
      if(!TasunAuth.ensureLoggedIn()) return;
      syncUserUI();

      $("btnHome").onclick = ()=>location.href="index.html";
      $("btnReLogin").onclick = ()=> TasunAuth.open("請重新登入或切換帳號");

      document.querySelectorAll(".card[data-href]").forEach(el=>{
        el.addEventListener("click", ()=>{
          const href = el.getAttribute("data-href");
          if(href) location.href = href;
        });
      });

      // 雲端入口（保持原網址；你可改成固定專案連結）
      $("btnCloud").addEventListener("click", (e)=>{
        e.preventDefault();
        const href = $("btnCloud").getAttribute("data-href");
        if(href) window.open(href, "_blank", "noopener");
      });
    }

    TasunAuth.init({
      onAuthed: ()=>{ toast("登入成功"); start(); },
      onSessionChange: ()=>{ syncUserUI(); },
      onForceRelogin: (msg)=>{ toast(msg || "請重新登入"); syncUserUI(); }
    });

    start();
  </script>
</body>
</html>
