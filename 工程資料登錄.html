<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>工程資料登錄 · Tasun</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#070809;
      --bg1:#0b0d10;
      --gold:#f6d37a;
      --border:rgba(246,211,122,.28);
      --border2:rgba(246,211,122,.40);
      --text:#ececec;
      --muted:rgba(236,236,236,.70);
      --shadow:0 18px 50px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family:"Noto Serif TC", serif;
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(246,211,122,.10), transparent 60%),
        radial-gradient(900px 520px at 85% 25%, rgba(246,211,122,.08), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{max-width:980px;margin:0 auto;padding:20px 16px 34px}

    /* ✅ 不用 fixed / sticky（避免遮擋） */
    .topbar{
      position:relative;
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:12px;
      align-items:center;
      padding:14px;
      border:1px solid var(--border);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
    }
    @media (max-width:920px){
      .topbar{grid-template-columns:1fr}
      .nav-left{order:0}
      .brand{order:1}
      .right{order:2; justify-content:flex-start}
    }

    .nav-left{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-start;}
    .nav-desktop{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .nav-mobile{display:none; gap:10px; align-items:center; width:100%;}
    @media (max-width:600px){
      .nav-desktop{display:none}
      .nav-mobile{display:flex}
    }

    .brand{display:flex; flex-direction:column}
    .title{
      font-weight:900; letter-spacing:.08em;
      font-size:20px; color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.22)
    }
    .sub{font-size:12px; color:var(--muted); letter-spacing:.08em; margin-top:4px}

    .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    @media (max-width:920px){ .right{justify-content:flex-start;} }

    .pill{
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.05);
      font-size:13px; color:rgba(236,236,236,.85);
      display:flex; gap:8px; align-items:center; white-space:nowrap;
    }
    .pill b{color:var(--gold)}

    .btn{
      appearance:none;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(246,211,122,.18), rgba(246,211,122,.07));
      color:var(--gold);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-family:inherit;
      font-weight:900;
      letter-spacing:.05em;
      box-shadow:0 10px 22px rgba(0,0,0,.35);
      transition:transform .12s ease, filter .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.06)}
    .btn:active{transform:translateY(0); filter:brightness(.98)}
    .btn.ghost{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.18);
      color:rgba(236,236,236,.85);
      font-weight:600;
    }
    .small{padding:8px 10px; font-size:12px; border-radius:999px; letter-spacing:.04em}

    /* 手機更多浮層 */
    .moreWrap{ position:relative; display:inline-flex; }
    .moreMenu{
      position:absolute;
      top:calc(100% + 8px);
      left:0;
      min-width: 220px;
      border-radius:16px;
      border:1px solid rgba(246,211,122,.30);
      background:linear-gradient(180deg, rgba(0,0,0,.72), rgba(0,0,0,.45));
      box-shadow:0 18px 50px rgba(0,0,0,.65);
      backdrop-filter:blur(10px);
      padding:8px;
      display:none;
      z-index:60;
    }
    .moreMenu.open{ display:block; }
    .menuItem{
      width:100%;
      text-align:left;
      border:none;
      background:rgba(255,255,255,.04);
      color:rgba(236,236,236,.92);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-family:inherit;
      letter-spacing:.04em;
    }
    .menuItem:hover{ background:rgba(246,211,122,.12); color:var(--gold); }
    .menuSep{ height:1px; margin:8px 6px; background:rgba(255,255,255,.10); }

    .panel{
      margin-top:16px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
    }

    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    .span2{grid-column:span 2}
    @media (max-width:720px){
      .grid{grid-template-columns:1fr}
      .span2{grid-column:span 1}
    }

    .field{display:flex; flex-direction:column; gap:6px}
    .label{font-size:12px; letter-spacing:.08em; color:var(--muted)}
    input,select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);
      color:var(--text);
      padding:10px 12px;
      font-family:inherit;
      outline:none;
      transition:border-color .12s ease, filter .12s ease;
    }
    input:focus,select:focus{border-color:rgba(246,211,122,.55); filter:brightness(1.05)}
    input:disabled,select:disabled{
      opacity:.55;
      cursor:not-allowed;
      filter:saturate(.85);
    }

    .miniHint{font-size:12px; color:rgba(236,236,236,.62); line-height:1.5}
    .warn{color:rgba(255,190,190,.95)}
    .inline2{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end}
    .row{display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; margin-top:10px}

    .pMask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.65);
      display:none;
      align-items:center; justify-content:center;
      padding:20px; z-index:160;
    }
    .pModal{
      width:min(520px, 96vw);
      border-radius:20px;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      box-shadow:0 30px 90px rgba(0,0,0,.75);
      overflow:hidden;
      backdrop-filter:blur(10px);
    }
    .pHead{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .pTitle{
      font-weight:900; letter-spacing:.08em;
      color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.22);
      font-size:16px;
    }
    .pBody{padding:14px}
    .pFoot{
      padding:12px 14px;
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.10);
    }

    /* ✅ 重複確認 Modal */
    .dMask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.68);
      display:none;
      align-items:center; justify-content:center;
      padding:20px; z-index:180;
    }
    .dMask.show{display:flex;}
    .dModal{
      width:min(760px, 96vw);
      border-radius:22px;
      border:1px solid rgba(246,211,122,.40);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow:0 30px 90px rgba(0,0,0,.78);
      overflow:hidden;
      backdrop-filter:blur(12px);
    }
    .dHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .dTitle{
      font-weight:900; letter-spacing:.08em;
      color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.22);
    }
    .dBody{padding:14px 16px 10px;}
    .dFoot{
      padding:12px 16px;
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .dTableWrap{
      margin-top:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      overflow:auto;
      max-height: 42vh;
      background:rgba(0,0,0,.18);
    }
    .dTable{
      width:100%;
      border-collapse:collapse;
      min-width: 640px;
    }
    .dTable th,.dTable td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      text-align:left;
      font-size:13px;
      color:rgba(236,236,236,.92);
      vertical-align:top;
      white-space:nowrap;
    }
    .dTable th{
      position:sticky; top:0; z-index:2;
      background:linear-gradient(180deg, rgba(0,0,0,.62), rgba(0,0,0,.38));
      color:rgba(246,211,122,.95);
      letter-spacing:.06em;
    }
    .dMsg{color:rgba(236,236,236,.85); line-height:1.6; font-size:13px;}
    .dMsg b{color:var(--gold)}

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.55);
      color:rgba(236,236,236,.92);
      font-size:13px;
      box-shadow:var(--shadow);
      display:none;
      z-index:200;
      backdrop-filter:blur(10px);
    }

    /* ===== Login Modal（共用）===== */
    .loginMask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.68);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:999;
    }
    .loginMask.show{display:flex;}
    .loginModal{
      width:min(520px, 96vw);
      border-radius:22px;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow:0 30px 90px rgba(0,0,0,.78);
      overflow:hidden;
      backdrop-filter:blur(12px);
    }
    .loginHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .loginTitle{
      font-weight:900; letter-spacing:.08em;
      color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.22);
    }
    .loginBody{padding:14px 16px 10px;}
    .loginFoot{
      padding:12px 16px;
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .loginErr{
      margin-top:10px;
      color:rgba(255,190,190,.95);
      font-size:13px;
      line-height:1.5;
      display:none;
      white-space: pre-wrap;
    }
    .loginHint{
      margin-top:10px;
      color:rgba(236,236,236,.65);
      font-size:12px;
      line-height:1.6;
    }
    /* ✅ 下拉箭頭（不影響你原本風格） */
    .loginBody select{
      appearance:none;
      -webkit-appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(236,236,236,.85) 50%),
        linear-gradient(135deg, rgba(236,236,236,.85) 50%, transparent 50%);
      background-position:
        calc(100% - 18px) 50%,
        calc(100% - 12px) 50%;
      background-size: 6px 6px, 6px 6px;
      background-repeat:no-repeat;
      padding-right:34px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="nav-left">
        <!-- 桌面：左上返回工程資料庫 -->
        <div class="nav-desktop">
          <button class="btn ghost small" id="navBackList">返回工程資料庫</button>
        </div>

        <!-- 手機：返回 + 更多 -->
        <div class="nav-mobile">
          <button class="btn ghost small" id="mBack">返回</button>
          <div class="moreWrap">
            <button class="btn ghost small" id="mMoreBtn" type="button">更多 ▾</button>
            <div class="moreMenu" id="mMoreMenu" role="menu" aria-label="更多選單">
              <button class="menuItem" data-href="工程資料庫.html" type="button">工程資料庫</button>
              <button class="menuItem" data-href="工程資料明細表.html" type="button">工程資料明細表</button>
              <button class="menuItem" data-href="工程資料查詢.html" type="button">工程資料查詢</button>
              <div class="menuSep"></div>
              <button class="menuItem" data-href="index.html" type="button">返回首頁</button>
            </div>
          </div>
        </div>
      </div>

      <div class="brand">
        <div class="title">工程資料登錄</div>
        <div class="sub">新增文件資料（系統/類別受控選單；新增請按「新增系統/新增類別」）</div>
      </div>

      <div class="right">
        <div class="pill">使用者：<b id="uName">—</b></div>
        <div class="pill">權限：<b id="uRole">—</b></div>

        <!-- ✅ 新增：雲端資料庫入口（同工程資料庫.html） -->
        <button class="btn ghost" id="btnCloud" type="button" data-href="https://www.dropbox.com/">雲端資料庫入口</button>

        <button class="btn ghost" id="btnHome">返回首頁</button>
      </div>
    </div>

    <div class="panel">
      <div id="noPerm" class="miniHint warn" style="display:none;margin-bottom:10px;">
        你目前是 read 權限，不能登錄資料（請用 admin/write 登入）。
      </div>

      <div class="grid">
        <div class="field">
          <div class="label">編號（自動產生）</div>
          <input id="no" disabled />
        </div>
        <div class="field">
          <div class="label">登錄日期（自動）</div>
          <input id="date" type="date" />
        </div>

        <div class="field span2">
          <div class="label">文件名稱</div>
          <input id="name" placeholder="例如：消防系統施工圖（核准版）" />
          <div class="miniHint warn" id="dupNameHint" style="display:none;"></div>
        </div>

        <div class="field">
          <div class="label">系統（必須從選單選；新增請按右側）</div>
          <div class="inline2">
            <select id="sys"></select>
            <button class="btn ghost" id="btnAddSys" type="button">新增系統</button>
          </div>
          <div class="miniHint">選單來源：明細表資料不重複 + 系統字典。</div>
        </div>

        <div class="field">
          <div class="label">類別（必須從選單選；新增請按右側）</div>
          <div class="inline2">
            <select id="cat"></select>
            <button class="btn ghost" id="btnAddCat" type="button">新增類別</button>
          </div>
          <div class="miniHint">選單來源：明細表資料不重複 + 類別字典。</div>
        </div>

        <div class="field span2">
          <div class="label">檔案連結（Dropbox / 雲端 / 內網網址）</div>
          <input id="url" type="url" placeholder="https://..." />
          <div class="miniHint warn" id="dupUrlHint" style="display:none;"></div>
        </div>
      </div>

      <div class="row">
        <button class="btn ghost" id="btnReset" type="button">清空</button>
        <button class="btn" id="btnSave" type="button">新增</button>
      </div>
    </div>
  </div>

  <!-- Prompt：新增系統/類別 -->
  <div class="pMask" id="pMask">
    <div class="pModal">
      <div class="pHead">
        <div class="pTitle" id="pTitle">新增</div>
        <button class="btn ghost" id="pClose" type="button">關閉</button>
      </div>
      <div class="pBody">
        <div class="field">
          <div class="label" id="pLabel">請輸入</div>
          <input id="pInput" placeholder="例如：消防 / 弱電 / 空調..." />
          <div class="miniHint">新增後會加入選單來源（字典），以維持資料一致。</div>
        </div>
      </div>
      <div class="pFoot">
        <button class="btn ghost" id="pCancel" type="button">取消</button>
        <button class="btn" id="pOk" type="button">確定新增</button>
      </div>
    </div>
  </div>

  <!-- ✅ 重複確認 Modal -->
  <div class="dMask" id="dMask" aria-hidden="true">
    <div class="dModal" role="dialog" aria-modal="true" aria-label="重複確認">
      <div class="dHead">
        <div class="dTitle" id="dTitle">偵測到可能重複</div>
        <button class="btn ghost small" id="dClose" type="button">關閉</button>
      </div>
      <div class="dBody">
        <div class="dMsg" id="dMsg"></div>
        <div class="dTableWrap" id="dTableWrap" style="display:none;">
          <table class="dTable">
            <thead>
              <tr>
                <th style="width:90px;">編號</th>
                <th>文件名稱</th>
                <th style="width:140px;">系統</th>
                <th style="width:140px;">類別</th>
                <th style="width:130px;">登錄日期</th>
              </tr>
            </thead>
            <tbody id="dTbody"></tbody>
          </table>
        </div>
        <div class="miniHint" style="margin-top:10px;">
          你可以選「仍要使用」繼續輸入；或選「取消」回去修改。
        </div>
      </div>
      <div class="dFoot">
        <button class="btn ghost" id="dCancel" type="button">取消</button>
        <button class="btn" id="dOk" type="button">仍要使用</button>
      </div>
    </div>
  </div>

  <!-- Login Modal（共用） -->
  <div class="loginMask" id="loginMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="登入">
      <div class="loginHead">
        <div class="loginTitle">登入</div>
        <button class="btn ghost small" id="loginClose" type="button">關閉</button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label">帳號</div>
          <select id="loginUser" autocomplete="username">
            <option value="">請選擇帳號</option>
          </select>
        </div>
        <div class="field" style="margin-top:10px;">
          <div class="label">密碼</div>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="請輸入密碼" />
        </div>
        <div class="loginErr" id="loginErr"></div>
        <div class="loginHint" id="loginHint">
          登入帳密完全以「權限表.html」的權限表（localStorage: <b>tasunAuthTable_v1</b>）為準。
        </div>
      </div>
      <div class="loginFoot">
        <button class="btn ghost" id="loginToAuth" type="button">前往權限表</button>
        <button class="btn" id="loginBtn" type="button">登入</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ===== Keys =====
    const CURRENT_KEY = "tasunCurrentUser_v1";
    const AUTH_KEY = "tasunAuthTable_v1";
    const DB_KEY = "tasunEngineeringDetail_v1";
    const COUNTER_KEY = "tasunEngineeringDetail_counter_v1";
    const SYS_DICT_KEY = "tasunEngineeringDetail_systems_v1";
    const CAT_DICT_KEY = "tasunEngineeringDetail_categories_v1";

    // ✅ 雲端資料庫入口（同工程資料庫.html）
    const CLOUD_URL = "https://www.dropbox.com/";

    // ===== State =====
    let currentUser=null;
    let db=[];
    let promptMode=null;
    let pageReady=false;

    // ✅ 重複確認：避免同一個值一直跳提示
    let confirmedNameSig = "";
    let confirmedUrlSig  = "";
    let _dupConfirm = { open:false, onOk:null, onCancel:null };

    // ===== Utils =====
    const $=(id)=>document.getElementById(id);
    const norm=(s)=>(s??"").toString().trim();

    function toast(msg){
      const t=$("toast");
      t.textContent=msg;
      t.style.display="block";
      clearTimeout(toast._tm);
      toast._tm=setTimeout(()=>t.style.display="none",2200);
    }

    function escHtml(s){
      return (s??"").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // ===== Auth Table (唯一真相來源) =====
    function mapRole(v){
      const s=(v??"").toString().trim().toLowerCase();
      if(!s) return "read";
      if(s==="admin") return "admin";
      if(s==="write"||s==="edit") return "write";
      if(s==="read"||s==="view") return "read";
      if(s==="0") return "admin";
      if(s==="1") return "write";
      if(s==="2") return "read";
      return s;
    }

    function loadAuthTable(){
      try{
        const raw=localStorage.getItem(AUTH_KEY);
        if(!raw) return [];
        const parsed=JSON.parse(raw);
        if(Array.isArray(parsed)) return parsed;
        if(parsed && Array.isArray(parsed.users)) return parsed.users;
        return [];
      }catch(e){ return []; }
    }

    function pickUsername(row){
      return norm(row?.user ?? row?.username ?? row?.account ?? row?.name);
    }
    function pickPassword(row){
      return (row?.pass ?? row?.password ?? row?.pwd ?? "").toString();
    }
    function pickRole(row){
      return mapRole(row?.role ?? row?.level ?? row?.perm ?? row?.permission);
    }

    function findAuthUser(username){
      const u=norm(username).toLowerCase();
      if(!u) return null;
      const rows=loadAuthTable();
      for(const r of rows){
        const ru=pickUsername(r).toLowerCase();
        if(ru && ru===u){
          return {
            username: pickUsername(r),
            password: pickPassword(r),
            role: pickRole(r) || "read"
          };
        }
      }
      return null;
    }

    function loadCurrentUser(){
      try{ currentUser = JSON.parse(localStorage.getItem(CURRENT_KEY) || "null"); }
      catch(e){ currentUser=null; }
      if(currentUser && typeof currentUser==="object"){
        const uname = norm(currentUser.username ?? currentUser.user ?? currentUser.name ?? currentUser.account);
        if(uname) currentUser.username = uname;
        if(currentUser.role) currentUser.role = mapRole(currentUser.role);
        if(currentUser.level) currentUser.level = mapRole(currentUser.level);
        currentUser.authStamp = (currentUser.authStamp ?? "").toString();
      }
    }

    function setCurrentUser(username, role, authStamp){
      const u = { username, user: username, role: mapRole(role), level: mapRole(role), authStamp: authStamp || "" };
      localStorage.setItem(CURRENT_KEY, JSON.stringify(u));
      currentUser = u;
    }

    function role(){
      return mapRole(currentUser?.role ?? currentUser?.level ?? "read");
    }
    function canWrite(){
      const r = role();
      return r==="admin" || r==="write";
    }

    function applyPermissionUI(){
      if(!pageReady) return;
      const writable = canWrite();

      $("noPerm").style.display = writable ? "none" : "block";
      $("btnSave").disabled = !writable;

      $("name").disabled = !writable;
      $("sys").disabled  = !writable;
      $("cat").disabled  = !writable;
      $("url").disabled  = !writable;
      $("date").disabled = !writable;

      $("btnAddSys").style.display = writable ? "inline-block" : "none";
      $("btnAddCat").style.display = writable ? "inline-block" : "none";
    }

    // ===== Session Watch Patch =====
    const SESSION_WATCH_MS = 3000;
    let _watchStarted = false;

    function fnv1a(str){
      let h = 0x811c9dc5;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 0x01000193);
      }
      return (h >>> 0).toString(16).padStart(8, "0");
    }
    function authStampFromAuth(auth){
      return fnv1a(`${auth.username}|${auth.password ?? ""}`);
    }

    function rebuildUserDropdown(preselectUser){
      const sel = $("loginUser");
      const rows = loadAuthTable();
      const users = rows.map(r => pickUsername(r)).filter(x => !!norm(x));

      const seen = new Set();
      const uniq = [];
      for(const u of users){
        const k = u.toLowerCase();
        if(seen.has(k)) continue;
        seen.add(k);
        uniq.push(u);
      }

      sel.innerHTML =
        `<option value="">請選擇帳號</option>` +
        uniq.map(u=>{
          const s = (preselectUser && u.toLowerCase() === preselectUser.toLowerCase()) ? "selected" : "";
          return `<option value="${u.replace(/"/g,"&quot;")}" ${s}>${escHtml(u)}</option>`;
        }).join("");
    }

    function openLoginModal(msg){
      const m = $("loginMask");
      $("loginErr").style.display = "none";
      if(msg){
        $("loginErr").textContent = msg;
        $("loginErr").style.display = "block";
      }

      loadCurrentUser();
      rebuildUserDropdown(currentUser?.username || "");
      $("loginPass").value = "";

      m.classList.add("show");
      m.setAttribute("aria-hidden","false");

      setTimeout(()=>{
        if($("loginUser").value) $("loginPass").focus();
        else $("loginUser").focus();
      }, 0);
    }
    function closeLoginModal(){
      const m = $("loginMask");
      m.classList.remove("show");
      m.setAttribute("aria-hidden","true");
    }

    function forceReLogin(msg){
      try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}
      currentUser = null;
      toast(msg || "權限表已更新，請重新登入");
      openLoginModal(msg || "權限表已更新，請重新登入");
      $("uName").textContent = "—";
      $("uRole").textContent = "—";
      if(pageReady) applyPermissionUI();
    }

    function validateSession(){
      const lm = $("loginMask");
      if(lm && lm.classList.contains("show")) return;

      loadCurrentUser();
      if(!currentUser || !currentUser.username) return;

      const auth = findAuthUser(currentUser.username);
      if(!auth){
        forceReLogin("帳號已被移除，請重新登入");
        return;
      }

      const stampNow = authStampFromAuth(auth);

      if(!currentUser.authStamp){
        setCurrentUser(auth.username, auth.role || "read", stampNow);
        $("uName").textContent = auth.username;
        $("uRole").textContent = role();
        if(pageReady) applyPermissionUI();
        return;
      }

      if(currentUser.authStamp !== stampNow){
        forceReLogin("密碼已更新，請重新登入");
        return;
      }

      const r = auth.role || "read";
      if(mapRole(currentUser.role) !== r){
        setCurrentUser(auth.username, r, stampNow);
        $("uRole").textContent = r;
        if(pageReady) applyPermissionUI();
      }
    }

    function startSessionWatch(){
      if(_watchStarted) return;
      _watchStarted = true;

      window.addEventListener("storage", (e)=>{
        if(e.key === AUTH_KEY || e.key === CURRENT_KEY){
          validateSession();
        }
      });

      setInterval(validateSession, SESSION_WATCH_MS);
    }

    function ensureLoggedIn(){
      loadCurrentUser();
      const rows = loadAuthTable();
      if(!Array.isArray(rows) || rows.length === 0){
        openLoginModal("尚未建立權限表：請先到「權限表.html」建立帳號。");
        return false;
      }

      if(!currentUser || !currentUser.username){
        openLoginModal();
        return false;
      }

      const auth = findAuthUser(currentUser.username);
      if(!auth){
        forceReLogin("帳號已被移除，請重新登入");
        return false;
      }

      const stampNow = authStampFromAuth(auth);
      if(currentUser.authStamp && currentUser.authStamp !== stampNow){
        forceReLogin("密碼已更新，請重新登入");
        return false;
      }

      setCurrentUser(auth.username, auth.role || "read", stampNow);
      $("uName").textContent = auth.username;
      $("uRole").textContent = role();
      return true;
    }

    function doLogin(){
      const u = norm($("loginUser").value);
      const p = ($("loginPass").value ?? "").toString();
      const rows = loadAuthTable();

      if(!Array.isArray(rows) || rows.length === 0){
        $("loginErr").textContent = "尚未建立權限表：請先到「權限表.html」建立帳號。";
        $("loginErr").style.display = "block";
        return;
      }
      if(!u){
        $("loginErr").textContent = "請先選擇帳號。";
        $("loginErr").style.display = "block";
        return;
      }
      if(!p){
        $("loginErr").textContent = "請輸入密碼。";
        $("loginErr").style.display = "block";
        return;
      }

      const auth = findAuthUser(u);
      if(!auth){
        $("loginErr").textContent = "帳號不存在（以權限表為準）。";
        $("loginErr").style.display = "block";
        return;
      }
      if((auth.password ?? "") !== p){
        $("loginErr").textContent = "密碼錯誤（以權限表為準）。";
        $("loginErr").style.display = "block";
        return;
      }

      const stampNow = authStampFromAuth(auth);
      setCurrentUser(auth.username, auth.role || "read", stampNow);

      closeLoginModal();
      toast("登入成功");
      start();
    }

    // ===== Data =====
    function loadDB(){
      try{
        db=JSON.parse(localStorage.getItem(DB_KEY) || "[]");
        if(!Array.isArray(db)) db=[];
      }catch(e){ db=[]; }
    }
    function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }

    function loadDict(key){
      try{
        const raw=localStorage.getItem(key);
        const arr=raw?JSON.parse(raw):[];
        return Array.isArray(arr)?arr.map(norm).filter(Boolean):[];
      }catch(e){ return []; }
    }
    function saveDict(key, arr){ localStorage.setItem(key, JSON.stringify(arr)); }

    function uniqueFromDB(field){
      const set=new Set();
      for(const r of db){
        const v=norm(r[field]);
        if(v) set.add(v);
      }
      return set;
    }
    function unionOptions(field, dictKey){
      const set=uniqueFromDB(field);
      for(const v of loadDict(dictKey)) set.add(v);
      const arr=Array.from(set);
      arr.sort((a,b)=>a.localeCompare(b,"zh-Hant"));
      return arr;
    }

    function getCounter(){
      const n=Number(localStorage.getItem(COUNTER_KEY) || "0");
      return Number.isFinite(n)?n:0;
    }
    function nextCounter(){
      const n=getCounter()+1;
      localStorage.setItem(COUNTER_KEY, String(n));
      return n;
    }

    function fillSelectWithPlaceholder(selId, options, placeholder, keepValue){
      const sel=$(selId);
      const ph = placeholder || "請選擇";
      const keep = norm(keepValue);

      sel.innerHTML =
        `<option value="" disabled ${keep ? "" : "selected"}>${escHtml(ph)}</option>` +
        options.map(v=>`<option value="${escHtml(v)}">${escHtml(v)}</option>`).join("");

      if(keep){
        const ok = options.some(x => x === keep);
        if(ok) sel.value = keep;
      }
    }

    // ✅ 編號不固定 4 位數：直接顯示自然數字
    function rebuildOptions(keepSelection){
      $("no").value = String(getCounter()+1);
      $("date").value = new Date().toISOString().slice(0,10);

      const prevSys = keepSelection ? norm($("sys").value) : "";
      const prevCat = keepSelection ? norm($("cat").value) : "";

      const sys = unionOptions("system", SYS_DICT_KEY);
      const cat = unionOptions("category", CAT_DICT_KEY);

      fillSelectWithPlaceholder("sys", sys, "（請選擇系統 / 或先新增）", prevSys);
      fillSelectWithPlaceholder("cat", cat, "（請選擇類別 / 或先新增）", prevCat);

      applyPermissionUI();
    }

    function resetDupHints(){
      $("dupNameHint").style.display="none";
      $("dupNameHint").textContent="";
      $("dupUrlHint").style.display="none";
      $("dupUrlHint").textContent="";
    }

    function resetForm(){
      $("name").value="";
      $("url").value="";
      confirmedNameSig = "";
      confirmedUrlSig  = "";
      resetDupHints();
      rebuildOptions(false);
      if(canWrite()) $("name").focus();
    }

    // ===== ✅ 重複檢查（文件名稱 / 檔案連結）=====
    function normNameKey(s){
      return norm(s).toLowerCase().replace(/\s+/g," ");
    }

    function normUrlKey(u){
      let s = norm(u);
      if(!s) return "";
      s = s.trim();

      // 盡量做一致化（避免 dropbox dl=0/1 造成同檔不同字串）
      try{
        const url = new URL(s);
        url.hash = "";

        // 若是 dropbox：忽略 dl=0/1（同一檔不同下載模式）
        if(url.hostname.includes("dropbox.com")){
          url.searchParams.delete("dl");
        }

        // 移除一些常見追蹤參數（可選，不影響其他雲端/內網）
        url.searchParams.delete("utm_source");
        url.searchParams.delete("utm_medium");
        url.searchParams.delete("utm_campaign");
        url.searchParams.delete("utm_content");
        url.searchParams.delete("utm_term");

        // 去掉尾端 /
        let out = url.toString();
        out = out.replace(/\/+$/,"");
        return out.toLowerCase();
      }catch(e){
        // 非標準 URL（內網可能是檔案路徑之類）：至少做 trim + lower
        return s.replace(/\/+$/,"").toLowerCase();
      }
    }

    function findDupByName(name){
      const k = normNameKey(name);
      if(!k) return [];
      const hits = [];
      for(const r of db){
        if(normNameKey(r?.name) === k) hits.push(r);
      }
      return hits;
    }

    function findDupByUrl(url){
      const k = normUrlKey(url);
      if(!k) return [];
      const hits = [];
      for(const r of db){
        if(normUrlKey(r?.url) === k) hits.push(r);
      }
      return hits;
    }

    function buildDupTable(rows){
      const list = rows.slice(0, 12);
      $("dTbody").innerHTML = list.map(r=>{
        return `
          <tr>
            <td>${escHtml(r?.id ?? "")}</td>
            <td>${escHtml(r?.name ?? "")}</td>
            <td>${escHtml(r?.system ?? "")}</td>
            <td>${escHtml(r?.category ?? "")}</td>
            <td>${escHtml(r?.regDate ?? "")}</td>
          </tr>
        `;
      }).join("");
      $("dTableWrap").style.display = list.length ? "block" : "none";
    }

    function openDupConfirm(messageHtml, rowsForTable, onOk, onCancel){
      if(_dupConfirm.open) return;
      _dupConfirm.open = true;
      _dupConfirm.onOk = onOk || null;
      _dupConfirm.onCancel = onCancel || null;

      $("dMsg").innerHTML = messageHtml || "";
      buildDupTable(rowsForTable || []);

      $("dMask").classList.add("show");
      $("dMask").setAttribute("aria-hidden","false");

      setTimeout(()=> $("dOk").focus(), 0);
    }

    function closeDupConfirm(){
      $("dMask").classList.remove("show");
      $("dMask").setAttribute("aria-hidden","true");
      _dupConfirm.open = false;
      _dupConfirm.onOk = null;
      _dupConfirm.onCancel = null;
    }

    function checkDupHintsOnly(){
      // 僅顯示提示，不打斷（用於 blur）
      const name = norm($("name").value);
      const url  = norm($("url").value);

      const dn = findDupByName(name);
      if(name && dn.length){
        $("dupNameHint").style.display="block";
        $("dupNameHint").textContent = `⚠ 文件名稱疑似重複：已存在 ${dn.length} 筆`;
      }else{
        $("dupNameHint").style.display="none";
        $("dupNameHint").textContent = "";
      }

      const du = findDupByUrl(url);
      if(url && du.length){
        $("dupUrlHint").style.display="block";
        $("dupUrlHint").textContent = `⚠ 檔案連結疑似重複：已存在 ${du.length} 筆`;
      }else{
        $("dupUrlHint").style.display="none";
        $("dupUrlHint").textContent = "";
      }
    }

    function confirmIfDuplicate(field){
      // field: "name" | "url"
      if(!canWrite()) return;

      const name = norm($("name").value);
      const url  = norm($("url").value);

      // 更新提示（不一定會彈窗）
      checkDupHintsOnly();

      if(field === "name"){
        const sig = normNameKey(name);
        if(!sig) return;

        const dn = findDupByName(name);
        if(!dn.length) return;

        if(confirmedNameSig === sig) return; // 已確認過這個值

        openDupConfirm(
          `你剛剛貼上的 <b>文件名稱</b> 可能重複（已存在 <b>${dn.length}</b> 筆）。<br>是否仍要使用這個文件名稱？`,
          dn,
          ()=>{
            confirmedNameSig = sig;
            closeDupConfirm();
            toast("已確認：允許重複文件名稱");
          },
          ()=>{
            closeDupConfirm();
            $("name").value = "";
            confirmedNameSig = "";
            checkDupHintsOnly();
            $("name").focus();
          }
        );
        return;
      }

      if(field === "url"){
        const sig = normUrlKey(url);
        if(!sig) return;

        const du = findDupByUrl(url);
        if(!du.length) return;

        if(confirmedUrlSig === sig) return; // 已確認過這個值

        openDupConfirm(
          `你剛剛貼上的 <b>檔案連結</b> 可能重複（已存在 <b>${du.length}</b> 筆）。<br>是否仍要使用這個連結？`,
          du,
          ()=>{
            confirmedUrlSig = sig;
            closeDupConfirm();
            toast("已確認：允許重複檔案連結");
          },
          ()=>{
            closeDupConfirm();
            $("url").value = "";
            confirmedUrlSig = "";
            checkDupHintsOnly();
            $("url").focus();
          }
        );
        return;
      }
    }

    function confirmDuplicatesBeforeSave(onOk){
      const name = norm($("name").value);
      const url  = norm($("url").value);

      const dn = name ? findDupByName(name) : [];
      const du = url  ? findDupByUrl(url)  : [];

      const nameSig = normNameKey(name);
      const urlSig  = normUrlKey(url);

      const needNameConfirm = dn.length && confirmedNameSig !== nameSig;
      const needUrlConfirm  = du.length && confirmedUrlSig  !== urlSig;

      if(!needNameConfirm && !needUrlConfirm){
        onOk && onOk();
        return;
      }

      // 合併顯示（一次確認兩個欄位）
      const msgs = [];
      let tableRows = [];
      if(needNameConfirm){
        msgs.push(`• <b>文件名稱</b> 重複：<b>${dn.length}</b> 筆`);
        tableRows = dn;
      }
      if(needUrlConfirm){
        msgs.push(`• <b>檔案連結</b> 重複：<b>${du.length}</b> 筆`);
        if(!tableRows.length) tableRows = du;
      }

      openDupConfirm(
        `偵測到可能重複：<br>${msgs.join("<br>")}<br><br>是否仍要「新增」？`,
        tableRows,
        ()=>{
          if(needNameConfirm) confirmedNameSig = nameSig;
          if(needUrlConfirm)  confirmedUrlSig  = urlSig;
          closeDupConfirm();
          onOk && onOk();
        },
        ()=>{
          closeDupConfirm();
        }
      );
    }

    // ===== 新增系統/類別 prompt =====
    function openPrompt(mode){
      if(!canWrite()){ toast("read 權限不可新增"); return; }
      promptMode=mode;
      $("pInput").value="";

      if(mode==="sys"){
        $("pTitle").textContent="新增系統";
        $("pLabel").textContent="請輸入新的系統名稱";
        $("pInput").placeholder="例如：空調 / 消防 / 弱電 / 給排水...";
      }else{
        $("pTitle").textContent="新增類別";
        $("pLabel").textContent="請輸入新的類別名稱";
        $("pInput").placeholder="例如：施工圖 / 材料審查 / 計劃書 / 會議...";
      }

      $("pMask").style.display="flex";
      setTimeout(()=>$("pInput").focus(),0);
    }

    function closePrompt(){
      $("pMask").style.display="none";
      promptMode=null;
    }

    function addOption(){
      if(!canWrite()) return;

      const v=norm($("pInput").value);
      if(!v){ toast("不可空白"); $("pInput").focus(); return; }

      const key=(promptMode==="sys") ? SYS_DICT_KEY : CAT_DICT_KEY;
      const existing = unionOptions(promptMode==="sys" ? "system" : "category", key).map(x=>x.toLowerCase());
      if(existing.includes(v.toLowerCase())){ toast("已存在相同選項"); return; }

      const dict=loadDict(key);
      dict.push(v);
      dict.sort((a,b)=>a.localeCompare(b,"zh-Hant"));
      saveDict(key, dict);

      rebuildOptions(true);
      if(promptMode==="sys") $("sys").value=v; else $("cat").value=v;

      closePrompt();
      toast("已新增選項");
    }

    // ===== Save =====
    function save(){
      validateSession();
      if(!currentUser || !currentUser.username){
        openLoginModal();
        return;
      }

      if(!canWrite()){ toast("read 權限不可登錄"); return; }

      const name=norm($("name").value);
      if(!name){ toast("文件名稱不可空白"); $("name").focus(); return; }

      const system=norm($("sys").value);
      const category=norm($("cat").value);
      if(!system){ toast("請先選擇系統（或先新增系統）"); return; }
      if(!category){ toast("請先選擇類別（或先新增類別）"); return; }

      const url=norm($("url").value);
      const regDate=norm($("date").value) || new Date().toISOString().slice(0,10);

      // ✅ 按新增時也要確認是否重複（避免漏掉）
      confirmDuplicatesBeforeSave(()=>{
        const id=nextCounter();
        db.unshift({ id, name, system, category, url, regDate });
        saveDB();

        // ✅ 新增成功顯示「登錄成功」
        toast("登錄成功");
        resetForm();
      });
    }

    function setupMoreMenu(backHref){
      const backBtn=$("mBack");
      const moreBtn=$("mMoreBtn");
      const menu=$("mMoreMenu");

      const close=()=>menu.classList.remove("open");
      const toggle=(e)=>{
        e.preventDefault();
        e.stopPropagation();
        menu.classList.toggle("open");
      };

      backBtn.onclick=()=>location.href=backHref;
      moreBtn.addEventListener("click", toggle);

      menu.addEventListener("click",(e)=>{
        e.stopPropagation();
        const item=e.target.closest("button.menuItem[data-href]");
        if(!item) return;
        const href=item.getAttribute("data-href");
        if(href) location.href=href;
      });

      document.addEventListener("click", close);
      window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") close(); });
    }

    // ===== Page Start =====
    function start(){
      if(!ensureLoggedIn()) return;

      loadDB();

      $("navBackList").onclick = ()=>location.href="工程資料庫.html";
      setupMoreMenu("工程資料庫.html");

      $("btnHome").onclick = ()=>location.href="index.html";

      // ✅ 新增：雲端資料庫入口（同工程資料庫.html 的行為：新分頁）
      $("btnCloud").addEventListener("click", (e)=>{
        e.preventDefault();
        const href = $("btnCloud").getAttribute("data-href") || CLOUD_URL;
        window.open(href, "_blank", "noopener");
      });

      $("btnAddSys").onclick=()=>openPrompt("sys");
      $("btnAddCat").onclick=()=>openPrompt("cat");
      $("btnReset").onclick=resetForm;
      $("btnSave").onclick=save;

      $("pClose").onclick=closePrompt;
      $("pCancel").onclick=closePrompt;
      $("pOk").onclick=addOption;
      $("pMask").addEventListener("click",(e)=>{ if(e.target===$("pMask")) closePrompt(); });

      // ✅ 重複確認 modal bindings
      $("dClose").onclick = ()=>{ closeDupConfirm(); };
      $("dCancel").onclick = ()=>{
        // 若是 paste 彈出來，走 onCancel（清欄位）
        if(_dupConfirm.onCancel) _dupConfirm.onCancel();
        else closeDupConfirm();
      };
      $("dOk").onclick = ()=>{
        if(_dupConfirm.onOk) _dupConfirm.onOk();
        else closeDupConfirm();
      };
      $("dMask").addEventListener("click",(e)=>{
        if(e.target === $("dMask")){
          // 點遮罩視為取消
          if(_dupConfirm.onCancel) _dupConfirm.onCancel();
          else closeDupConfirm();
        }
      });

      window.addEventListener("keydown",(e)=>{
        if(e.key==="Escape" && $("pMask").style.display==="flex") closePrompt();
        if(e.key==="Enter" && $("pMask").style.display==="flex") addOption();

        if(e.key==="Escape" && $("dMask").classList.contains("show")){
          if(_dupConfirm.onCancel) _dupConfirm.onCancel();
          else closeDupConfirm();
        }
        if(e.key==="Enter" && $("dMask").classList.contains("show")){
          if(_dupConfirm.onOk) _dupConfirm.onOk();
          else closeDupConfirm();
        }
      });

      // ✅ 兩欄貼上要確認是否重複（paste 後檢查）
      $("name").addEventListener("paste", ()=>{
        setTimeout(()=>{
          // 值變了就重置確認狀態
          confirmedNameSig = "";
          confirmIfDuplicate("name");
        }, 0);
      });
      $("url").addEventListener("paste", ()=>{
        setTimeout(()=>{
          confirmedUrlSig = "";
          confirmIfDuplicate("url");
        }, 0);
      });

      // ✅ 平常輸入時：只顯示提示（不打斷），離開欄位再提示一次
      $("name").addEventListener("input", ()=>{
        confirmedNameSig = ""; // 值改了 → 需重新確認
        checkDupHintsOnly();
      });
      $("url").addEventListener("input", ()=>{
        confirmedUrlSig = "";
        checkDupHintsOnly();
      });
      $("name").addEventListener("blur", ()=> checkDupHintsOnly());
      $("url").addEventListener("blur", ()=> checkDupHintsOnly());

      pageReady = true;
      resetForm();
      applyPermissionUI();
    }

    // ===== Login Modal Bindings =====
    (function bindLogin(){
      $("loginClose").onclick = closeLoginModal;
      $("loginToAuth").onclick = ()=> location.href="權限表.html";
      $("loginBtn").onclick = doLogin;

      $("loginUser").addEventListener("change", ()=>{
        if($("loginUser").value) $("loginPass").focus();
      });

      $("loginMask").addEventListener("click",(e)=>{
        if(e.target === $("loginMask")) closeLoginModal();
      });

      window.addEventListener("keydown",(e)=>{
        if(e.key === "Escape" && $("loginMask").classList.contains("show")) closeLoginModal();
        if(e.key === "Enter" && $("loginMask").classList.contains("show")) doLogin();
      });
    })();

    // ===== Boot =====
    startSessionWatch();
    start();
  </script>
</body>
</html>
