<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>捷運汐東線審查文件管制登錄表-水環組 · Tasun</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- ✅✅✅ APP_VER 強制同步（跨頁一致 v；自動 replace 強制刷新） -->
  <script>
  (function(){
    const APP_VER = "2026-01-26.v1";
    const KEY_VER  = "tasun_app_ver_v1";
    const ONCE_KEY = "tasun_app_ver_sync_once_v1";
    const norm = (s)=>(s??"").toString().trim();

    function chooseUseVer(){
      const stored = norm(localStorage.getItem(KEY_VER));
      if(!stored){
        localStorage.setItem(KEY_VER, APP_VER);
        return APP_VER;
      }
      const a = Number(stored.replace(/[^\d.]/g,""));
      const b = Number(APP_VER.replace(/[^\d.]/g,""));
      let use = APP_VER;
      if(Number.isFinite(a) && Number.isFinite(b) && (a||b)){
        use = (a > b) ? stored : APP_VER;
      }else{
        use = (stored > APP_VER) ? stored : APP_VER;
      }
      if(use !== stored) localStorage.setItem(KEY_VER, use);
      return use;
    }

    const useVer = chooseUseVer();
    const u = new URL(location.href);
    const cur = u.searchParams.get("v") || "";

    if(cur !== useVer){
      u.searchParams.set("v", useVer);
      const once = sessionStorage.getItem(ONCE_KEY);
      if(once !== useVer){
        sessionStorage.setItem(ONCE_KEY, useVer);
        location.replace(u.toString());
        return;
      }
    }

    window.__CACHE_V = useVer;

    window.__withV = function(url){
      const vv = norm(window.__CACHE_V);
      if(!vv) return url;
      try{
        const uu = new URL(url, document.baseURI);
        if(!uu.searchParams.has("v")) uu.searchParams.set("v", vv);
        return uu.toString();
      }catch(e){
        return url + (url.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(vv);
      }
    };

    window.addEventListener("storage",(e)=>{
      if(e.key === KEY_VER){
        const nv = norm(e.newValue);
        if(nv && nv !== norm(window.__CACHE_V)){
          const uu = new URL(location.href);
          uu.searchParams.set("v", nv);
          location.replace(uu.toString());
        }
      }
    });
  })();
  </script>

  <style>
    :root{
      --bg0:#070809;
      --bg1:#0b0d10;
      --gold:#f6d37a;
      --border:rgba(246,211,122,.28);
      --border2:rgba(246,211,122,.40);
      --text:#ececec;
      --muted:rgba(236,236,236,.70);
      --shadow:0 18px 50px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family:"Noto Serif TC", serif;
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(246,211,122,.10), transparent 60%),
        radial-gradient(900px 520px at 85% 25%, rgba(246,211,122,.08), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:20px 16px 34px}

    .topbar{
      position:relative;
      z-index:20;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      gap:12px;
      align-items:center;
      padding:14px;
      border:1px solid var(--border);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
    }
    @media (max-width:920px){
      .topbar{grid-template-columns:1fr}
      .nav-left{order:0}
      .brand{order:1}
      .right{order:2; justify-content:flex-start}
    }

    .nav-left{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:flex-start;
      min-width:220px;
    }
    .nav-desktop{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .nav-mobile{display:none; gap:10px; align-items:center; width:100%;}
    @media (max-width:650px){
      .nav-desktop{display:none}
      .nav-mobile{display:flex}
    }

    .brand{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:0 6px;
    }
    .title{
      font-weight:900; letter-spacing:.06em;
      font-size: clamp(16px, 1.6vw, 20px);
      color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.22);
      line-height:1.25;
    }
    .sub{font-size:12px; color:var(--muted); letter-spacing:.08em; margin-top:4px}

    .right{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
      min-width:220px;
    }
    @media (max-width:920px){ .right{justify-content:flex-start;} }

    .pill{
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.05);
      font-size:13px; color:rgba(236,236,236,.85);
      display:flex; gap:8px; align-items:center; white-space:nowrap;
    }
    .pill b{color:var(--gold)}

    .btn{
      appearance:none;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(246,211,122,.18), rgba(246,211,122,.07));
      color:var(--gold);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-family:inherit;
      font-weight:900;
      letter-spacing:.05em;
      box-shadow:0 10px 22px rgba(0,0,0,.35);
      transition:transform .12s ease, filter .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.06)}
    .btn:active{transform:translateY(0); filter:brightness(.98)}
    .btn.ghost{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.18);
      color:rgba(236,236,236,.85);
      font-weight:600;
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      filter:saturate(.85);
      transform:none !important;
    }
    .small{padding:8px 10px; font-size:12px; border-radius:999px; letter-spacing:.04em}

    .moreWrap{ position:relative; display:inline-flex; }
    .moreMenu{
      position:absolute;
      top:calc(100% + 8px);
      left:0;
      min-width: 250px;
      border-radius:16px;
      border:1px solid rgba(246,211,122,.30);
      background:linear-gradient(180deg, rgba(0,0,0,.72), rgba(0,0,0,.45));
      box-shadow:0 18px 50px rgba(0,0,0,.65);
      backdrop-filter:blur(10px);
      padding:8px;
      display:none;
      z-index:60;
    }
    .moreMenu.open{ display:block; }
    .menuItem{
      width:100%;
      text-align:left;
      border:none;
      background:rgba(255,255,255,.04);
      color:rgba(236,236,236,.92);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-family:inherit;
      letter-spacing:.04em;
    }
    .menuItem:hover{ background:rgba(246,211,122,.12); color:var(--gold); }
    .menuSep{ height:1px; margin:8px 6px; background:rgba(255,255,255,.10); }

    .panel{
      margin-top:16px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
    }

    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    .span2{grid-column:span 2}
    @media (max-width:760px){
      .grid{grid-template-columns:1fr}
      .span2{grid-column:span 1}
    }

    .field{display:flex; flex-direction:column; gap:6px}
    .label{font-size:12px; letter-spacing:.08em; color:var(--muted)}

    input,textarea,select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);
      color:var(--text);
      padding:10px 12px;
      font-family:inherit;
      outline:none;
      transition:border-color .12s ease, filter .12s ease;
    }
    input:focus,textarea:focus,select:focus{border-color:rgba(246,211,122,.55); filter:brightness(1.05)}
    input:disabled,textarea:disabled,select:disabled{
      opacity:.55;
      cursor:not-allowed;
      filter:saturate(.85);
    }
    textarea{min-height:90px; resize:vertical;}

    select{
      appearance:none;
      -webkit-appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(236,236,236,.85) 50%),
        linear-gradient(135deg, rgba(236,236,236,.85) 50%, transparent 50%);
      background-position:
        calc(100% - 18px) 50%,
        calc(100% - 12px) 50%;
      background-size: 6px 6px, 6px 6px;
      background-repeat:no-repeat;
      padding-right:34px;
    }

    .miniHint{font-size:12px; color:rgba(236,236,236,.62); line-height:1.6}
    .warn{color:rgba(255,190,190,.95)}
    .row{display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; margin-top:10px}

    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      font-size:12px;
      white-space:nowrap;
    }
    .tag b{color:var(--gold)}

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.55);
      color:rgba(236,236,236,.92);
      font-size:13px;
      box-shadow:var(--shadow);
      display:none;
      z-index:200;
      backdrop-filter:blur(10px);
    }

    .selPlus{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:end;
    }
    .plusBtn{
      appearance:none;
      width:46px;
      height:42px;
      border-radius:14px;
      border:1px solid rgba(246,211,122,.40);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:0 10px 22px rgba(0,0,0,.35);
      color:var(--gold);
      cursor:pointer;
      font-family:inherit;
      font-weight:900;
      font-size:18px;
      line-height:1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition:transform .12s ease, filter .12s ease;
      user-select:none;
    }
    .plusBtn:hover{transform:translateY(-1px); filter:brightness(1.06)}
    .plusBtn:active{transform:translateY(0); filter:brightness(.98)}
    .plusBtn:disabled{ opacity:.45; cursor:not-allowed; transform:none; filter:none; }

    .addBox{
      display:none;
      margin-top:8px;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(246,211,122,.32);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:0 14px 35px rgba(0,0,0,.45);
      backdrop-filter:blur(10px);
    }
    .addRow{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .addRow input{
      flex:1;
      min-width: 180px;
      padding:9px 10px;
      border-radius:12px;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.18);
    }

    .loginMask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.68);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:999;
    }
    .loginMask.show{display:flex;}
    .loginModal{
      width:min(520px, 96vw);
      border-radius:22px;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow:0 30px 90px rgba(0,0,0,.78);
      overflow:hidden;
      backdrop-filter:blur(12px);
    }
    .loginHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .loginTitle{
      font-weight:900; letter-spacing:.08em;
      color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.22);
    }
    .loginBody{padding:14px 16px 10px;}
    .loginFoot{
      padding:12px 16px;
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .loginErr{
      margin-top:10px;
      color:rgba(255,190,190,.95);
      font-size:13px;
      line-height:1.5;
      display:none;
      white-space: pre-wrap;
    }
    .loginHint{
      margin-top:10px;
      color:rgba(236,236,236,.65);
      font-size:12px;
      line-height:1.6;
    }
    .loginBody input,.loginBody select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);
      color:rgba(236,236,236,.92);
      padding:10px 12px;
      font-family:inherit;
      outline:none;
      transition:border-color .12s ease, filter .12s ease;
    }
    .loginBody input:focus,.loginBody select:focus{border-color:rgba(246,211,122,.55); filter:brightness(1.05)}
    .loginBody select{
      appearance:none;
      -webkit-appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(236,236,236,.85) 50%),
        linear-gradient(135deg, rgba(236,236,236,.85) 50%, transparent 50%);
      background-position:
        calc(100% - 18px) 50%,
        calc(100% - 12px) 50%;
      background-size: 6px 6px, 6px 6px;
      background-repeat:no-repeat;
      padding-right:34px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="nav-left">
        <div class="nav-desktop">
          <button class="btn ghost small" id="navBackList">返回管制表</button>
          <button class="btn ghost small" id="navToQry">前往查詢表</button>
          <button class="btn ghost small" id="navBackDB">返回資料庫</button>
          <button class="btn ghost small" id="navBackXidong">返回汐東工程管理表</button>
          <button class="btn ghost small" id="navHome">返回首頁</button>
        </div>

        <div class="nav-mobile">
          <button class="btn ghost small" id="mBack">返回</button>
          <div class="moreWrap">
            <button class="btn ghost small" id="mMoreBtn" type="button">更多 ▾</button>
            <div class="moreMenu" id="mMoreMenu" role="menu" aria-label="更多選單">
              <button class="menuItem" data-href="捷運汐東線審查文件管制表-水環組.html" type="button">返回管制表</button>
              <button class="menuItem" data-href="捷運汐東線審查文件管制查詢表-水環組.html" type="button">前往查詢表</button>
              <button class="menuItem" data-href="捷運汐止東湖線統包工程-資料庫.html" type="button">返回資料庫</button>
              <button class="menuItem" data-href="汐東工程管理表.html" type="button">返回汐東工程管理表</button>
              <div class="menuSep"></div>
              <button class="menuItem" data-href="index.html" type="button">返回首頁</button>
            </div>
          </div>
        </div>
      </div>

      <div class="brand">
        <div class="title">捷運汐東線審查文件管制登錄表-水環組</div>
        <div class="sub">項次固定遞增；到期日=送審日期+期限；到期日距今=到期日-今日+1（完成不算）</div>
      </div>

      <div class="right">
        <div class="pill">使用者：<b id="uName">—</b></div>
        <div class="pill">權限：<b id="uRole">—</b></div>
        <button class="btn" id="btnReLogin">切換帳號</button>
      </div>
    </div>

    <div class="panel">
      <div id="noPerm" class="miniHint warn" style="display:none;margin-bottom:10px;">
        你目前是 read 權限，不能登錄資料（請用 admin/write 登入）。
      </div>

      <div class="miniHint" id="dutyHint" style="margin-bottom:10px;">
        權責分工工程項目會嘗試自動讀取「捷運汐東線權責分工精簡版.html」的工程項目/期限/權責。
      </div>

      <div class="grid">
        <div class="field">
          <div class="label">項次（自動）</div>
          <input id="no" disabled />
        </div>

        <div class="field">
          <div class="label">權責分工工程項目（下拉即時更新；可＋新增自訂值）</div>
          <div class="selPlus">
            <select id="dutyItem"></select>
            <button class="plusBtn" id="dutyItemPlus" type="button" title="新增工程項目">＋</button>
          </div>
          <div class="addBox" id="addDutyItemBox" aria-hidden="true">
            <div class="addRow">
              <input id="addDutyItemInput" placeholder="輸入新工程項目…" />
              <button class="btn ghost small" id="addDutyItemCancel" type="button">取消</button>
              <button class="btn small" id="addDutyItemOk" type="button">加入</button>
            </div>
          </div>
          <div class="miniHint">選定後會自動帶入：期限、權責（若該項目存在於權責分工表）。</div>
        </div>

        <div class="field">
          <div class="label">期限（天，自動帶入；可手動改）</div>
          <input id="termDays" type="number" min="0" step="1" placeholder="例如 30" />
        </div>

        <div class="field">
          <div class="label">權責（自動帶入；可手動改）</div>
          <input id="duty" placeholder="例如：水環組 / 顧問 / 施工廠商..." />
        </div>

        <div class="field">
          <div class="label">送審日期（用日曆選擇）</div>
          <input id="submitDate" type="date" />
        </div>

        <div class="field">
          <div class="label">到期日（自動=送審日期+期限）</div>
          <input id="dueDate" type="date" disabled />
        </div>

        <div class="field">
          <div class="label">到期日距今（完成不算）</div>
          <input id="dueInDays" disabled />
        </div>

        <div class="field">
          <div class="label">狀態（下拉即時更新；可＋新增自訂值）</div>
          <div class="selPlus">
            <select id="status"></select>
            <button class="plusBtn" id="statusPlus" type="button" title="新增狀態">＋</button>
          </div>
          <div class="addBox" id="addStatusBox" aria-hidden="true">
            <div class="addRow">
              <input id="addStatusInput" placeholder="輸入新狀態…" />
              <button class="btn ghost small" id="addStatusCancel" type="button">取消</button>
              <button class="btn small" id="addStatusOk" type="button">加入</button>
            </div>
          </div>
        </div>

        <div class="field">
          <div class="label">文件編碼（下拉即時更新；可＋新增自訂值）</div>
          <div class="selPlus">
            <select id="docCode"></select>
            <button class="plusBtn" id="docCodePlus" type="button" title="新增文件編碼">＋</button>
          </div>
          <div class="addBox" id="addDocCodeBox" aria-hidden="true">
            <div class="addRow">
              <input id="addDocCodeInput" placeholder="輸入新文件編碼…" />
              <button class="btn ghost small" id="addDocCodeCancel" type="button">取消</button>
              <button class="btn small" id="addDocCodeOk" type="button">加入</button>
            </div>
          </div>
        </div>

        <div class="field span2">
          <div class="label">文件名稱（下拉即時更新；可＋新增自訂值）</div>
          <div class="selPlus">
            <select id="docName"></select>
            <button class="plusBtn" id="docNamePlus" type="button" title="新增文件名稱">＋</button>
          </div>
          <div class="addBox" id="addDocNameBox" aria-hidden="true">
            <div class="addRow">
              <input id="addDocNameInput" placeholder="輸入新文件名稱…" />
              <button class="btn ghost small" id="addDocNameCancel" type="button">取消</button>
              <button class="btn small" id="addDocNameOk" type="button">加入</button>
            </div>
          </div>
        </div>

        <div class="field">
          <div class="label">版次（下拉即時更新；可＋新增自訂值）</div>
          <div class="selPlus">
            <select id="version"></select>
            <button class="plusBtn" id="versionPlus" type="button" title="新增版次">＋</button>
          </div>
          <div class="addBox" id="addVersionBox" aria-hidden="true">
            <div class="addRow">
              <input id="addVersionInput" placeholder="輸入新版次…" />
              <button class="btn ghost small" id="addVersionCancel" type="button">取消</button>
              <button class="btn small" id="addVersionOk" type="button">加入</button>
            </div>
          </div>
        </div>

        <div class="field">
          <div class="label">系統（下拉即時更新；可＋新增自訂值）</div>
          <div class="selPlus">
            <select id="system"></select>
            <button class="plusBtn" id="systemPlus" type="button" title="新增系統">＋</button>
          </div>
          <div class="addBox" id="addSystemBox" aria-hidden="true">
            <div class="addRow">
              <input id="addSystemInput" placeholder="輸入新系統…" />
              <button class="btn ghost small" id="addSystemCancel" type="button">取消</button>
              <button class="btn small" id="addSystemOk" type="button">加入</button>
            </div>
          </div>
        </div>

        <div class="field">
          <div class="label">文件類別（下拉即時更新；可＋新增自訂值）</div>
          <div class="selPlus">
            <select id="docType"></select>
            <button class="plusBtn" id="docTypePlus" type="button" title="新增文件類別">＋</button>
          </div>
          <div class="addBox" id="addDocTypeBox" aria-hidden="true">
            <div class="addRow">
              <input id="addDocTypeInput" placeholder="輸入新文件類別…" />
              <button class="btn ghost small" id="addDocTypeCancel" type="button">取消</button>
              <button class="btn small" id="addDocTypeOk" type="button">加入</button>
            </div>
          </div>
        </div>

        <div class="field">
          <div class="label">審查結果（下拉即時更新；可＋新增自訂值）</div>
          <div class="selPlus">
            <select id="reviewResult"></select>
            <button class="plusBtn" id="reviewResultPlus" type="button" title="新增審查結果">＋</button>
          </div>
          <div class="addBox" id="addReviewResultBox" aria-hidden="true">
            <div class="addRow">
              <input id="addReviewResultInput" placeholder="輸入新審查結果…" />
              <button class="btn ghost small" id="addReviewResultCancel" type="button">取消</button>
              <button class="btn small" id="addReviewResultOk" type="button">加入</button>
            </div>
          </div>
        </div>

        <div class="field">
          <div class="label">承辦人（下拉即時更新；可＋新增自訂值）</div>
          <div class="selPlus">
            <select id="officer"></select>
            <button class="plusBtn" id="officerPlus" type="button" title="新增承辦人">＋</button>
          </div>
          <div class="addBox" id="addOfficerBox" aria-hidden="true">
            <div class="addRow">
              <input id="addOfficerInput" placeholder="輸入新承辦人…" />
              <button class="btn ghost small" id="addOfficerCancel" type="button">取消</button>
              <button class="btn small" id="addOfficerOk" type="button">加入</button>
            </div>
          </div>
        </div>

        <div class="field">
          <div class="label">擺放編號</div>
          <input id="placeNo" placeholder="例如：A-01-03..." />
        </div>

        <div class="field span2">
          <div class="label">提示</div>
          <div class="miniHint">
            <span class="tag">今日：<b id="todayTag">—</b></span>
            <span class="tag">到期日距今：<b id="dueTag">—</b></span>
          </div>
        </div>
      </div>

      <div class="row">
        <button class="btn ghost" id="btnReset" type="button">清空</button>
        <button class="btn" id="btnSave" type="button">新增</button>
      </div>
    </div>
  </div>

  <div class="loginMask" id="loginMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="登入">
      <div class="loginHead">
        <div class="loginTitle">登入</div>
        <button class="btn ghost small" id="loginClose" type="button">關閉</button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label">帳號</div>
          <select id="loginUser" autocomplete="username">
            <option value="">請選擇帳號</option>
          </select>
        </div>
        <div class="field" style="margin-top:10px;">
          <div class="label">密碼</div>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="請輸入密碼" />
        </div>
        <div class="loginErr" id="loginErr"></div>
        <div class="loginHint">
          登入帳密完全以「權限表.html」的權限表（localStorage: <b>tasunAuthTable_v1</b>）為準。
        </div>
      </div>
      <div class="loginFoot">
        <button class="btn ghost" id="loginToAuth" type="button">前往權限表</button>
        <button class="btn" id="loginBtn" type="button">登入</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
/* ===========================
   TasunAuth 共用登入模組 v1
   =========================== */
window.TasunAuth = (function(){
  const CURRENT_KEY = "tasunCurrentUser_v1";
  const AUTH_KEY    = "tasunAuthTable_v1";
  const SESSION_WATCH_MS = 3000;

  let currentUser = null;
  let _watchStarted = false;

  const $ = (id)=>document.getElementById(id);
  const norm = (s)=>(s??"").toString().trim();

  function mapRole(v){
    const s=(v??"").toString().trim().toLowerCase();
    if(!s) return "read";
    if(s==="admin") return "admin";
    if(s==="write"||s==="edit") return "write";
    if(s==="read"||s==="view") return "read";
    if(s==="0") return "admin";
    if(s==="1") return "write";
    if(s==="2") return "read";
    return s;
  }

  function loadAuthTable(){
    try{
      const raw=localStorage.getItem(AUTH_KEY);
      if(!raw) return [];
      const parsed=JSON.parse(raw);
      if(Array.isArray(parsed)) return parsed;
      if(parsed && Array.isArray(parsed.users)) return parsed.users;
      return [];
    }catch(e){ return []; }
  }

  function pickUsername(row){ return norm(row?.user ?? row?.username ?? row?.account ?? row?.name); }
  function pickPassword(row){ return (row?.pass ?? row?.password ?? row?.pwd ?? "").toString(); }
  function pickRole(row){ return mapRole(row?.role ?? row?.level ?? row?.perm ?? row?.permission); }

  function findAuthUser(username){
    const u=norm(username).toLowerCase();
    if(!u) return null;
    const rows=loadAuthTable();
    for(const r of rows){
      const ru=pickUsername(r).toLowerCase();
      if(ru && ru===u){
        return { username: pickUsername(r), password: pickPassword(r), role: pickRole(r) || "read" };
      }
    }
    return null;
  }

  function loadCurrentUser(){
    try{ currentUser = JSON.parse(localStorage.getItem(CURRENT_KEY) || "null"); }
    catch(e){ currentUser=null; }
    if(currentUser && typeof currentUser==="object"){
      const uname = norm(currentUser.username ?? currentUser.user ?? currentUser.name ?? currentUser.account);
      if(uname) currentUser.username = uname;
      currentUser.role = mapRole(currentUser.role ?? currentUser.level ?? "read");
      currentUser.level = currentUser.role;
      currentUser.authStamp = (currentUser.authStamp ?? "").toString();
    }
  }

  function setCurrentUser(username, role, authStamp){
    const u = { username, user: username, role: mapRole(role), level: mapRole(role), authStamp: authStamp || "" };
    localStorage.setItem(CURRENT_KEY, JSON.stringify(u));
    currentUser = u;
  }

  function role(){ return mapRole(currentUser?.role ?? currentUser?.level ?? "read"); }
  function canWrite(){ const r=role(); return r==="admin" || r==="write"; }

  function fnv1a(str){
    let h = 0x811c9dc5;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 0x01000193);
    }
    return (h >>> 0).toString(16).padStart(8, "0");
  }
  function authStampFromAuth(auth){
    return fnv1a(`${auth.username}|${auth.password ?? ""}`);
  }

  function rebuildUserDropdown(preselectUser){
    const sel = $("loginUser");
    if(!sel) return;

    const rows = loadAuthTable();
    const users = rows.map(r => pickUsername(r)).filter(x => !!norm(x));

    const seen = new Set();
    const uniq = [];
    for(const u of users){
      const k = u.toLowerCase();
      if(seen.has(k)) continue;
      seen.add(k);
      uniq.push(u);
    }

    sel.innerHTML =
      `<option value="">請選擇帳號</option>` +
      uniq.map(u=>{
        const s = (preselectUser && u.toLowerCase() === preselectUser.toLowerCase()) ? "selected" : "";
        const vv = u.replace(/"/g,"&quot;");
        return `<option value="${vv}" ${s}>${u}</option>`;
      }).join("");
  }

  function openLoginModal(msg){
    const mask=$("loginMask");
    const err=$("loginErr");
    if(!mask) return;

    if(err){
      err.style.display="none";
      if(msg){
        err.textContent = msg;
        err.style.display="block";
      }
    }

    loadCurrentUser();
    rebuildUserDropdown(currentUser?.username || "");
    const pass=$("loginPass");
    if(pass) pass.value="";

    mask.classList.add("show");
    mask.setAttribute("aria-hidden","false");
    setTimeout(()=>{
      const userSel=$("loginUser");
      if(userSel && userSel.value && pass) pass.focus();
      else if(userSel) userSel.focus();
    },0);
  }

  function closeLoginModal(){
    const mask=$("loginMask");
    if(!mask) return;
    mask.classList.remove("show");
    mask.setAttribute("aria-hidden","true");
  }

  function validateSession(){
    const mask=$("loginMask");
    if(mask && mask.classList.contains("show")) return;

    loadCurrentUser();
    if(!currentUser || !currentUser.username) return;

    const auth = findAuthUser(currentUser.username);
    if(!auth){
      try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}
      openLoginModal("帳號已被移除，請重新登入");
      return;
    }

    const stampNow = authStampFromAuth(auth);

    if(!currentUser.authStamp){
      setCurrentUser(auth.username, auth.role || "read", stampNow);
      return;
    }

    if(currentUser.authStamp !== stampNow){
      try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}
      openLoginModal("密碼已更新，請重新登入");
      return;
    }

    const r = auth.role || "read";
    if(mapRole(currentUser.role) !== r){
      setCurrentUser(auth.username, r, stampNow);
    }
  }

  function ensureLoggedIn(){
    loadCurrentUser();
    const rows = loadAuthTable();
    if(!Array.isArray(rows) || rows.length === 0){
      openLoginModal("尚未建立權限表：請先到「權限表.html」建立帳號。");
      return false;
    }
    if(!currentUser || !currentUser.username){
      openLoginModal();
      return false;
    }
    const auth = findAuthUser(currentUser.username);
    if(!auth){
      openLoginModal("帳號已被移除，請重新登入");
      return false;
    }
    const stampNow = authStampFromAuth(auth);
    if(currentUser.authStamp && currentUser.authStamp !== stampNow){
      openLoginModal("密碼已更新，請重新登入");
      return false;
    }
    setCurrentUser(auth.username, auth.role || "read", stampNow);
    return true;
  }

  function doLogin(){
    const userSel=$("loginUser");
    const passEl=$("loginPass");
    const err=$("loginErr");

    const u = norm(userSel ? userSel.value : "");
    const p = (passEl ? passEl.value : "").toString();
    const rows = loadAuthTable();

    function showErr(m){
      if(!err) return;
      err.textContent = m;
      err.style.display="block";
    }

    if(!Array.isArray(rows) || rows.length === 0) return showErr("尚未建立權限表：請先到「權限表.html」建立帳號。");
    if(!u) return showErr("請先選擇帳號。");
    if(!p) return showErr("請輸入密碼。");

    const auth = findAuthUser(u);
    if(!auth) return showErr("帳號不存在（以權限表為準）。");
    if((auth.password ?? "") !== p) return showErr("密碼錯誤（以權限表為準）。");

    const stampNow = authStampFromAuth(auth);
    setCurrentUser(auth.username, auth.role || "read", stampNow);

    closeLoginModal();
    if(typeof window.__onAuthed === "function") window.__onAuthed();
  }

  function bindUI(){
    $("loginClose").onclick = closeLoginModal;
    $("loginToAuth").onclick = ()=> location.href="權限表.html";
    $("loginBtn").onclick = doLogin;

    $("loginMask").addEventListener("click",(e)=>{
      if(e.target === $("loginMask")) closeLoginModal();
    });

    window.addEventListener("keydown",(e)=>{
      const mask=$("loginMask");
      if(!mask) return;
      if(e.key === "Escape" && mask.classList.contains("show")) closeLoginModal();
      if(e.key === "Enter" && mask.classList.contains("show")) doLogin();
    });

    $("loginUser").addEventListener("change", ()=>{
      if($("loginUser").value) $("loginPass").focus();
    });
  }

  function startWatch(){
    if(_watchStarted) return;
    _watchStarted = true;

    window.addEventListener("storage", (e)=>{
      if(e.key === AUTH_KEY || e.key === CURRENT_KEY){
        validateSession();
      }
    });
    setInterval(validateSession, SESSION_WATCH_MS);
  }

  function init(){
    bindUI();
    startWatch();
  }

  function current(){ loadCurrentUser(); return currentUser; }

  return {
    init,
    ensureLoggedIn,
    validateSession,
    open: openLoginModal,
    current,
    role: ()=>{ loadCurrentUser(); return role(); },
    canWrite: ()=>{ loadCurrentUser(); return canWrite(); },
  };
})();

/* ===========================
   Page Logic
   =========================== */
const DB_KEY = "tasunXidongReviewWater_ctl_v1";
const COUNTER_KEY = "tasunXidongReviewWater_counter_v1";
const ADD_VALUE = "__add__";

const $ = (id)=>document.getElementById(id);
const norm = (s)=>(s??"").toString().trim();

let db = [];
let dutyMap = new Map();
let dutyItemsBase = [];

function toast(msg){
  const t=$("toast");
  t.textContent=msg;
  t.style.display="block";
  clearTimeout(toast._tm);
  toast._tm=setTimeout(()=>t.style.display="none",2200);
}
function escHtml(s){
  return (s??"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
function todayISO(){ return new Date().toISOString().slice(0,10); }
function daysDiff(aISO, bISO){
  const a = new Date(aISO+"T00:00:00");
  const b = new Date(bISO+"T00:00:00");
  return Math.round((a - b)/86400000);
}
function addDays(dateISO, days){
  if(!dateISO || !Number.isFinite(days)) return "";
  const d = new Date(dateISO+"T00:00:00");
  d.setDate(d.getDate() + days);
  return d.toISOString().slice(0,10);
}

function loadDB(){
  try{
    db = JSON.parse(localStorage.getItem(DB_KEY) || "[]");
    if(!Array.isArray(db)) db=[];
  }catch(e){ db=[]; }
}
function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }

function getCounter(){
  const n = Number(localStorage.getItem(COUNTER_KEY) || "0");
  return Number.isFinite(n) ? n : 0;
}
function nextCounter(){
  const n = getCounter() + 1;
  localStorage.setItem(COUNTER_KEY, String(n));
  return n;
}

function uniqueOptions(field){
  const set = new Set();
  for(const r of db){
    const v = norm(r?.[field]);
    if(v) set.add(v);
  }
  const arr = Array.from(set);
  arr.sort((a,b)=>a.localeCompare(b,"zh-Hant"));
  return arr;
}

function mergeUnique(a, b){
  const set = new Set();
  const push = (x)=>{
    const v = norm(x);
    if(!v) return;
    set.add(v.toLowerCase()+"\u0000"+v);
  };
  (a||[]).forEach(push);
  (b||[]).forEach(push);

  const out = Array.from(set).map(k=>k.split("\u0000")[1]);
  out.sort((x,y)=>x.localeCompare(y,"zh-Hant"));
  return out;
}

function fillSelect(sel, opts, keep, firstLabel, withAdd){
  if(!sel) return;
  const first = `<option value="">${escHtml(firstLabel || "請選擇")}</option>`;
  const addOpt = withAdd ? `<option value="${ADD_VALUE}">新增…</option>` : "";
  sel.innerHTML =
    first +
    (opts||[]).map(v=>`<option value="${escHtml(v)}">${escHtml(v)}</option>`).join("") +
    addOpt;

  if(keep && opts.includes(keep)){
    sel.value = keep;
  }else if(keep && keep !== ADD_VALUE){
    sel.value = "";
  }else{
    sel.value = "";
  }
}

function rebuildSelects(){
  const keep = {
    dutyItem: norm($("dutyItem").value),
    status: norm($("status").value),
    docCode: norm($("docCode").value),
    docName: norm($("docName").value),
    version: norm($("version").value),
    system: norm($("system").value),
    docType: norm($("docType").value),
    reviewResult: norm($("reviewResult").value),
    officer: norm($("officer").value),
  };

  const dutyFromDB = uniqueOptions("dutyItem");
  const dutyAll = mergeUnique(dutyItemsBase, dutyFromDB);

  fillSelect($("dutyItem"), dutyAll, keep.dutyItem, "請選擇/新增工程項目", true);

  const statusSeed = ["辦理中","待審","補正","完成"];
  const statusAll = mergeUnique(statusSeed, uniqueOptions("status"));
  fillSelect($("status"), statusAll, keep.status, "請選擇/新增狀態", true);

  fillSelect($("docCode"), uniqueOptions("docCode"), keep.docCode, "請選擇/新增文件編碼", true);
  fillSelect($("docName"), uniqueOptions("docName"), keep.docName, "請選擇/新增文件名稱", true);
  fillSelect($("version"), uniqueOptions("version"), keep.version, "請選擇/新增版次", true);
  fillSelect($("system"), uniqueOptions("system"), keep.system, "請選擇/新增系統", true);
  fillSelect($("docType"), uniqueOptions("docType"), keep.docType, "請選擇/新增文件類別", true);
  fillSelect($("reviewResult"), uniqueOptions("reviewResult"), keep.reviewResult, "請選擇/新增審查結果", true);
  fillSelect($("officer"), uniqueOptions("officer"), keep.officer, "請選擇/新增承辦人", true);
}

function refreshOptionsNow(){
  loadDB();
  rebuildSelects();
}

const ADD_UI = [
  { id:"dutyItem",     label:"工程項目" },
  { id:"status",       label:"狀態" },
  { id:"docCode",      label:"文件編碼" },
  { id:"docName",      label:"文件名稱" },
  { id:"version",      label:"版次" },
  { id:"system",       label:"系統" },
  { id:"docType",      label:"文件類別" },
  { id:"reviewResult", label:"審查結果" },
  { id:"officer",      label:"承辦人" },
];

function cap(id){ return id.charAt(0).toUpperCase() + id.slice(1); }

function showAddBox(id){
  const box = $("add"+cap(id)+"Box");
  const inp = $("add"+cap(id)+"Input");
  if(!box || !inp) return;
  box.style.display = "block";
  box.setAttribute("aria-hidden","false");
  inp.value = "";
  setTimeout(()=>inp.focus(),0);
}
function hideAddBox(id){
  const box = $("add"+cap(id)+"Box");
  const inp = $("add"+cap(id)+"Input");
  if(!box || !inp) return;
  box.style.display = "none";
  box.setAttribute("aria-hidden","true");
  inp.value = "";
}
function addOptionToSelect(sel, value){
  const v = norm(value);
  if(!sel || !v) return false;

  const exists = Array.from(sel.options).some(op => norm(op.value).toLowerCase() === v.toLowerCase());
  if(!exists){
    const op = document.createElement("option");
    op.value = v;
    op.textContent = v;

    const addNode = Array.from(sel.options).find(o => o.value === ADD_VALUE);
    if(addNode) sel.insertBefore(op, addNode);
    else sel.appendChild(op);
  }
  sel.value = v;
  sel.dataset.prev = v;
  return true;
}

function bindAddUI(){
  ADD_UI.forEach(cfg=>{
    const sel = $(cfg.id);
    const plus = $(cfg.id+"Plus");

    const box = $("add"+cap(cfg.id)+"Box");
    const inp = $("add"+cap(cfg.id)+"Input");
    const ok = $("add"+cap(cfg.id)+"Ok");
    const cancel = $("add"+cap(cfg.id)+"Cancel");

    if(!sel || !plus || !box || !inp || !ok || !cancel) return;

    plus.onclick = ()=>{
      if(sel.disabled) return;
      sel.dataset.prev = (sel.value ?? "").toString();
      showAddBox(cfg.id);
    };

    sel.addEventListener("change", ()=>{
      if(sel.value === ADD_VALUE){
        sel.dataset.prev = (sel.dataset.prev ?? "").toString();
        showAddBox(cfg.id);
      }else{
        hideAddBox(cfg.id);
        sel.dataset.prev = (sel.value ?? "").toString();
      }
    });

    cancel.onclick = ()=>{
      hideAddBox(cfg.id);
      sel.value = (sel.dataset.prev ?? "").toString();
    };

    ok.onclick = ()=>{
      const v = norm(inp.value);
      if(!v){ toast(cfg.label + "不可空白"); inp.focus(); return; }
      if(addOptionToSelect(sel, v)){
        hideAddBox(cfg.id);
        toast("已加入" + cfg.label);
        if(cfg.id === "dutyItem") onDutyItemChanged();
        if(cfg.id === "status") recalcDue();
      }
    };

    inp.addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){ e.preventDefault(); ok.click(); }
      if(e.key==="Escape"){ e.preventDefault(); cancel.click(); }
    });
  });
}

function bindSelectAutoRefresh(){
  const ids = ADD_UI.map(x=>x.id);
  const evs = ["pointerdown","mousedown","focus"];
  ids.forEach(id=>{
    const el = $(id);
    if(!el) return;
    evs.forEach(ev=>{
      el.addEventListener(ev, ()=>{
        el.dataset.prev = (el.value ?? "").toString();
        try{ refreshOptionsNow(); }catch(e){}
      }, { passive:true });
    });
  });
}

function rebuildNo(){
  $("no").value = String(getCounter() + 1);
  if(!$("submitDate").value) $("submitDate").value = todayISO();
}

function applyPermissionUI(){
  const writable = TasunAuth.canWrite();
  $("noPerm").style.display = writable ? "none" : "block";
  $("btnSave").disabled = !writable;

  const ids = [
    "dutyItem","termDays","duty","submitDate",
    "docCode","docName","version","system","docType",
    "status","reviewResult","officer","placeNo"
  ];
  ids.forEach(id=>{ $(id).disabled = !writable; });

  document.querySelectorAll(".plusBtn").forEach(btn=>{
    btn.disabled = !writable;
  });

  document.querySelectorAll(".addBox button, .addBox input").forEach(el=>{
    el.disabled = !writable;
  });
}

function recalcDue(){
  const submit = norm($("submitDate").value);
  const termStr = norm($("termDays").value);
  const term = termStr === "" ? NaN : Number(termStr);
  const status = norm($("status").value);

  const due = (submit && Number.isFinite(term)) ? addDays(submit, term) : "";
  $("dueDate").value = due;

  let dueIn = "";
  if(status === "完成"){
    dueIn = "";
  }else{
    if(due){
      dueIn = String(daysDiff(due, todayISO()) + 1);
    }
  }

  $("dueInDays").value = dueIn;
  $("todayTag").textContent = todayISO();
  $("dueTag").textContent = dueIn==="" ? "—" : dueIn;
}

function hideAllAddBoxes(){ ADD_UI.forEach(cfg=> hideAddBox(cfg.id)); }

function resetForm(){
  hideAllAddBoxes();
  $("dutyItem").value="";
  $("termDays").value="";
  $("duty").value="";
  $("submitDate").value=todayISO();
  $("dueDate").value="";
  $("dueInDays").value="";
  $("status").value="";
  $("docCode").value="";
  $("docName").value="";
  $("version").value="";
  $("system").value="";
  $("docType").value="";
  $("reviewResult").value="";
  $("officer").value="";
  $("placeNo").value="";
  rebuildNo();
  recalcDue();
  applyPermissionUI();
  if(TasunAuth.canWrite()) $("dutyItem").focus();
}

function onDutyItemChanged(){
  const item = norm($("dutyItem").value);
  if(!item || item === ADD_VALUE) return;

  const got = dutyMap.get(item);
  if(got){
    if(!norm($("termDays").value)) $("termDays").value = String(got.termDays ?? "");
    if(!norm($("duty").value)) $("duty").value = String(got.duty ?? "");
  }
  recalcDue();
}

function save(){
  TasunAuth.validateSession();
  if(!TasunAuth.canWrite()){ toast("read 權限不可登錄"); return; }

  const guardIds = ["dutyItem","status","docCode","docName","version","system","docType","reviewResult","officer"];
  for(const id of guardIds){
    if(norm($(id).value) === ADD_VALUE){
      toast("請先完成新增或改選其他選項：" + id);
      $(id).focus();
      return;
    }
  }

  const dutyItem = norm($("dutyItem").value);
  if(!dutyItem){ toast("請選擇/新增「權責分工工程項目」"); $("dutyItem").focus(); return; }

  const docCode = norm($("docCode").value);
  const docName = norm($("docName").value);
  const version = norm($("version").value);
  const system  = norm($("system").value);
  const docType = norm($("docType").value);

  const submitDate = norm($("submitDate").value);

  const termStr = norm($("termDays").value);
  const termDays = termStr === "" ? NaN : Number(termStr);

  const dueDate = norm($("dueDate").value);

  const status = norm($("status").value);
  const reviewResult = norm($("reviewResult").value);
  const officer = norm($("officer").value);
  const duty = norm($("duty").value);
  const placeNo = norm($("placeNo").value);

  if(!submitDate){ toast("請選擇送審日期"); $("submitDate").focus(); return; }
  if(!Number.isFinite(termDays)){ toast("期限(天)必須是數字"); $("termDays").focus(); return; }
  if(!docName){ toast("文件名稱不可空白"); $("docName").focus(); return; }

  const id = nextCounter();

  let dueInDays = "";
  if(status !== "完成" && dueDate){
    dueInDays = String(daysDiff(dueDate, todayISO()) + 1);
  }

  loadDB();
  db.unshift({
    id,
    dutyItem,
    docCode, docName, version, system, docType,
    submitDate,
    dueDate,
    dueInDays,
    termDays,
    status,
    reviewResult,
    officer,
    duty,
    placeNo
  });
  saveDB();

  toast("登錄成功");

  refreshOptionsNow();
  resetForm();
}

/* ===========================
   讀取 權責分工精簡版.html
   =========================== */
async function loadDutyFromResponsibilityHTML(){
  const rawUrl = "捷運汐東線權責分工精簡版.html";
  const url = (window.__withV ? window.__withV(rawUrl) : rawUrl);

  try{
    const res = await fetch(url, { cache:"no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const html = await res.text();

    const doc = new DOMParser().parseFromString(html, "text/html");

    const tables = Array.from(doc.querySelectorAll("table"));
    let targetTable = null;
    let headerIdx = { item:-1, term:-1, duty:-1 };

    for(const tb of tables){
      const ths = Array.from(tb.querySelectorAll("thead th, tr th"));
      if(ths.length === 0) continue;
      const names = ths.map(th=>norm(th.textContent).replace(/\s+/g,""));
      const idxItem = names.findIndex(x=>x.includes("工程項目"));
      if(idxItem < 0) continue;

      const idxTerm = names.findIndex(x=>x.includes("期限"));
      const idxDuty = names.findIndex(x=>x.includes("權責"));

      targetTable = tb;
      headerIdx = { item: idxItem, term: idxTerm, duty: idxDuty };
      break;
    }

    if(!targetTable || headerIdx.item < 0){
      $("dutyHint").innerHTML = `<span class="warn">找不到「工程項目」表格，請確認 ${escHtml(rawUrl)} 內有表頭「工程項目」。</span>`;
      dutyMap = new Map();
      dutyItemsBase = [];
      return;
    }

    const rows = Array.from(targetTable.querySelectorAll("tbody tr"));
    const map = new Map();
    const items = [];

    for(const tr of rows){
      const tds = Array.from(tr.querySelectorAll("td"));
      if(tds.length === 0) continue;
      const item = norm(tds[headerIdx.item]?.textContent);
      if(!item) continue;

      const termRaw = headerIdx.term >= 0 ? norm(tds[headerIdx.term]?.textContent) : "";
      const dutyRaw = headerIdx.duty >= 0 ? norm(tds[headerIdx.duty]?.textContent) : "";

      const termNum = Number((termRaw||"").replace(/[^\d\-]/g,""));
      const termDays = Number.isFinite(termNum) ? termNum : (Number(termRaw)||0);

      if(!map.has(item)){
        map.set(item, { termDays: (Number.isFinite(termDays)? termDays : 0), duty: dutyRaw });
        items.push(item);
      }
    }

    items.sort((a,b)=>a.localeCompare(b,"zh-Hant"));

    dutyMap = map;
    dutyItemsBase = items;

    $("dutyHint").innerHTML = `<span class="miniHint">已載入權責分工：工程項目 <b style="color:var(--gold)">${items.length}</b> 筆</span>`;
    refreshOptionsNow();
  }catch(err){
    $("dutyHint").innerHTML =
      `<span class="warn">無法讀取「${escHtml(rawUrl)}」來自動帶入期限/權責（可能是瀏覽器阻擋 file:// fetch 或路徑不對）。</span>
       <div class="miniHint">你仍可直接用「＋」新增工程項目後登錄。</div>`;
    dutyMap = new Map();
    dutyItemsBase = [];
    refreshOptionsNow();
  }
}

function syncUserUI(){
  const u = TasunAuth.current();
  $("uName").textContent = u?.username || "—";
  $("uRole").textContent = TasunAuth.role();
}

function setupMoreMenu(backHref){
  const backBtn=$("mBack");
  const moreBtn=$("mMoreBtn");
  const menu=$("mMoreMenu");
  if(!backBtn || !moreBtn || !menu) return;

  const close=()=>menu.classList.remove("open");
  const toggle=(e)=>{
    e.preventDefault();
    e.stopPropagation();
    menu.classList.toggle("open");
  };

  backBtn.onclick=()=>location.href=backHref;
  moreBtn.addEventListener("click", toggle);

  menu.addEventListener("click",(e)=>{
    e.stopPropagation();
    const item=e.target.closest("button.menuItem[data-href]");
    if(!item) return;
    const href=item.getAttribute("data-href");
    if(href) location.href=href;
  });

  document.addEventListener("click", close);
  window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") close(); });
}

function startDBStorageWatch(){
  window.addEventListener("storage",(e)=>{
    if(e.key === DB_KEY){
      refreshOptionsNow();
    }
  });
}
function startDBPollWatch(){
  let lastRaw = null;
  setInterval(()=>{
    const raw = localStorage.getItem(DB_KEY) || "";
    if(raw !== lastRaw){
      lastRaw = raw;
      refreshOptionsNow();
    }
  }, 1500);
}

function start(){
  if(!TasunAuth.ensureLoggedIn()) return;

  syncUserUI();
  loadDB();
  rebuildSelects();
  rebuildNo();

  $("navBackList").onclick = ()=>location.href="捷運汐東線審查文件管制表-水環組.html";
  $("navToQry").onclick    = ()=>location.href="捷運汐東線審查文件管制查詢表-水環組.html";
  $("navBackDB").onclick   = ()=>location.href="捷運汐止東湖線統包工程-資料庫.html";
  $("navBackXidong").onclick=()=>location.href="汐東工程管理表.html";
  $("navHome").onclick     = ()=>location.href="index.html";
  setupMoreMenu("捷運汐東線審查文件管制表-水環組.html");

  bindAddUI();
  bindSelectAutoRefresh();
  applyPermissionUI();
  recalcDue();

  $("dutyItem").addEventListener("change", onDutyItemChanged);
  $("termDays").addEventListener("input", recalcDue);
  $("submitDate").addEventListener("change", recalcDue);
  $("status").addEventListener("change", recalcDue);

  $("btnReset").onclick = resetForm;
  $("btnSave").onclick = save;

  $("btnReLogin").onclick = ()=> TasunAuth.open();
  window.__onAuthed = ()=>{
    syncUserUI();
    applyPermissionUI();
    refreshOptionsNow();
    rebuildNo();
    recalcDue();
  };

  startDBStorageWatch();
  startDBPollWatch();

  loadDutyFromResponsibilityHTML();

  if(TasunAuth.canWrite()){
    setTimeout(()=> $("dutyItem").focus(), 0);
  }
}

TasunAuth.init();
start();
  </script>
</body>
</html>
