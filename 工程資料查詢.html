<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å·¥ç¨‹è³‡æ–™æŸ¥è©¢ Â· Tasun</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#070809;
      --bg1:#0b0d10;
      --gold:#f6d37a;
      --border:rgba(246,211,122,.28);
      --border2:rgba(246,211,122,.40);
      --text:#ececec;
      --muted:rgba(236,236,236,.70);
      --shadow:0 18px 50px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--text);
      font-family:"Noto Serif TC", serif;
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(246,211,122,.10), transparent 60%),
        radial-gradient(900px 520px at 85% 25%, rgba(246,211,122,.08), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:20px 16px 34px}

    /* âœ… ä¸ç”¨ sticky / fixed */
    .topbar{
      position:relative;
      z-index:20;
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:12px;
      align-items:center;
      padding:14px;
      border:1px solid var(--border);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
    }
    @media (max-width:920px){
      .topbar{ grid-template-columns: 1fr; }
      .nav-left{ order:0; }
      .brand{ order:1; }
      .right{ order:2; justify-content:flex-start; }
    }

    .nav-left{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-start; min-width: 220px; }
    .nav-desktop{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .nav-mobile{ display:none; gap:10px; align-items:center; width:100%; }
    @media (max-width:600px){
      .nav-desktop{ display:none; }
      .nav-mobile{ display:flex; }
    }

    .brand{display:flex; flex-direction:column}
    .title{font-weight:900; letter-spacing:.08em; font-size:20px; color:var(--gold); text-shadow:0 0 18px rgba(246,211,122,.22)}
    .sub{font-size:12px; color:var(--muted); letter-spacing:.08em; margin-top:4px}

    .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    @media (max-width:920px){ .right{justify-content:flex-start;} }

    .pill{
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.05);
      font-size:13px; color:rgba(236,236,236,.85);
      display:flex; gap:8px; align-items:center; white-space:nowrap;
    }
    .pill b{color:var(--gold)}

    .btn{
      appearance:none;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(246,211,122,.18), rgba(246,211,122,.07));
      color:var(--gold);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-family:inherit;
      font-weight:900;
      letter-spacing:.05em;
      box-shadow:0 10px 22px rgba(0,0,0,.35);
      transition:transform .12s ease, filter .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.06)}
    .btn:active{transform:translateY(0); filter:brightness(.98)}
    .btn.ghost{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.18);
      color:rgba(236,236,236,.85);
      font-weight:600;
    }
    .small{padding:8px 10px; font-size:12px; border-radius:999px; letter-spacing:.04em}

    /* æ‰‹æ©Ÿæ›´å¤šæµ®å±¤ */
    .moreWrap{ position:relative; display:inline-flex; }
    .moreMenu{
      position:absolute;
      top:calc(100% + 8px);
      right:0;
      min-width: 220px;
      border-radius:16px;
      border:1px solid rgba(246,211,122,.30);
      background:linear-gradient(180deg, rgba(0,0,0,.72), rgba(0,0,0,.45));
      box-shadow:0 18px 50px rgba(0,0,0,.65);
      backdrop-filter:blur(10px);
      padding:8px;
      display:none;
      z-index:60;
    }
    .moreMenu.open{ display:block; }
    .menuItem{
      width:100%;
      text-align:left;
      border:none;
      background:rgba(255,255,255,.04);
      color:rgba(236,236,236,.92);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-family:inherit;
      letter-spacing:.04em;
    }
    .menuItem:hover{ background:rgba(246,211,122,.12); color:var(--gold); }
    .menuSep{ height:1px; margin:8px 6px; background:rgba(255,255,255,.10); }

    .panel{
      margin-top:16px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
    }

    .controls{
      display:grid;
      grid-template-columns: 1.2fr .9fr .9fr auto;
      gap:10px;
      align-items:end;
    }
    @media (max-width:920px){ .controls{grid-template-columns:1fr 1fr} }
    @media (max-width:520px){ .controls{grid-template-columns:1fr} }

    .field{display:flex; flex-direction:column; gap:6px}
    .label{font-size:12px; letter-spacing:.08em; color:var(--muted)}
    input,select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);
      color:var(--text);
      padding:10px 12px;
      font-family:inherit;
      outline:none;
      transition:border-color .12s ease, filter .12s ease;
    }
    input:focus,select:focus{border-color:rgba(246,211,122,.55); filter:brightness(1.05)}

    .tableWrap{margin-top:14px; overflow:auto; border-radius:16px; border:1px solid rgba(255,255,255,.12)}
    table{width:100%; border-collapse:collapse; min-width:920px; background:rgba(0,0,0,.18)}
    thead th{
      position:sticky; top:0; z-index:2;
      background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
      color:rgba(246,211,122,.95);
      font-size:13px; letter-spacing:.06em;
      text-align:left;
      padding:12px 12px;
      border-bottom:1px solid rgba(246,211,122,.25);
      white-space:nowrap;
    }
    tbody td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
      font-size:14px;
      color:rgba(236,236,236,.92);
    }
    tbody tr:hover td{background:rgba(255,255,255,.04)}
    .link{color:var(--gold); text-decoration:none; border-bottom:1px dashed rgba(246,211,122,.45); white-space:nowrap;}
    .muted{color:rgba(236,236,236,.55)}
    .hint{margin-top:10px; color:var(--muted); font-size:13px; line-height:1.6}

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.55);
      color:rgba(236,236,236,.92);
      font-size:13px;
      box-shadow:var(--shadow);
      display:none;
      z-index:200;
      backdrop-filter:blur(10px);
    }

    /* ===== Login Modalï¼ˆå…±ç”¨ï¼‰===== */
    .loginMask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.68);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:999;
    }
    .loginMask.show{display:flex;}
    .loginModal{
      width:min(520px, 96vw);
      border-radius:22px;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow:0 30px 90px rgba(0,0,0,.78);
      overflow:hidden;
      backdrop-filter:blur(12px);
    }
    .loginHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .loginTitle{
      font-weight:900; letter-spacing:.08em;
      color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.22);
    }
    .loginBody{padding:14px 16px 10px;}
    .loginFoot{
      padding:12px 16px;
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .loginErr{
      margin-top:10px;
      color:rgba(255,190,190,.95);
      font-size:13px;
      line-height:1.5;
      display:none;
      white-space:pre-wrap;
    }
    .loginHint{
      margin-top:10px;
      color:rgba(236,236,236,.65);
      font-size:12px;
      line-height:1.6;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="nav-left">
        <!-- æ¡Œé¢ -->
        <div class="nav-desktop">
          <button class="btn ghost small" id="navBackList">è¿”å›å·¥ç¨‹è³‡æ–™æ˜ç´°è¡¨</button>
        </div>

        <!-- æ‰‹æ©Ÿï¼šè¿”å› + æ›´å¤š -->
        <div class="nav-mobile">
          <button class="btn ghost small" id="mBack">è¿”å›</button>
          <div class="moreWrap">
            <button class="btn ghost small" id="mMoreBtn" type="button">æ›´å¤š â–¾</button>
            <div class="moreMenu" id="mMoreMenu" role="menu" aria-label="æ›´å¤šé¸å–®">
              <button class="menuItem" data-href="å·¥ç¨‹è³‡æ–™æ˜ç´°è¡¨.html" type="button">å·¥ç¨‹è³‡æ–™æ˜ç´°è¡¨</button>
              <button class="menuItem" data-href="å·¥ç¨‹è³‡æ–™ç™»éŒ„.html" type="button">å·¥ç¨‹è³‡æ–™ç™»éŒ„</button>
              <div class="menuSep"></div>
              <button class="menuItem" data-href="index.html" type="button">è¿”å›é¦–é </button>
            </div>
          </div>
        </div>
      </div>

      <div class="brand">
        <div class="title">å·¥ç¨‹è³‡æ–™æŸ¥è©¢</div>
        <div class="sub">ç´”æŸ¥è©¢ / é»é€£çµé–‹å•Ÿ / ä¸ä¿®æ”¹è³‡æ–™</div>
      </div>

      <div class="right">
        <div class="pill">ä½¿ç”¨è€…ï¼š<b id="uName">â€”</b></div>
        <div class="pill">æ¬Šé™ï¼š<b id="uRole">â€”</b></div>
        <button class="btn ghost" id="btnHome">è¿”å›é¦–é </button>
        <button class="btn" id="btnReg">ç™»éŒ„è³‡æ–™</button>
      </div>
    </div>

    <div class="panel">
      <div class="controls">
        <div class="field">
          <div class="label">æœå°‹ï¼ˆæ–‡ä»¶åç¨± / ç³»çµ± / é¡åˆ¥ / é€£çµï¼‰</div>
          <input id="q" placeholder="ä¾‹å¦‚ï¼šææ–™å¯©æŸ¥ã€æ–½å·¥åœ–ã€æ¶ˆé˜²ã€å¼±é›»..." />
        </div>
        <div class="field">
          <div class="label">ç³»çµ±</div>
          <select id="sys"><option value="">å…¨éƒ¨</option></select>
        </div>
        <div class="field">
          <div class="label">é¡åˆ¥</div>
          <select id="cat"><option value="">å…¨éƒ¨</option></select>
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
          <button class="btn ghost" id="btnClear">æ¸…é™¤æ¢ä»¶</button>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:100px;">ç·¨è™Ÿ</th>
              <th style="width:320px;">æ–‡ä»¶åç¨±</th>
              <th style="width:180px;">ç³»çµ±</th>
              <th style="width:180px;">é¡åˆ¥</th>
              <th>æª”æ¡ˆé€£çµ</th>
              <th style="width:140px;">ç™»éŒ„æ—¥æœŸ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="hint" id="hint"></div>
    </div>
  </div>

  <!-- Login Modalï¼ˆå…±ç”¨ï¼‰ -->
  <div class="loginMask" id="loginMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="ç™»å…¥">
      <div class="loginHead">
        <div class="loginTitle">ç™»å…¥</div>
        <button class="btn ghost small" id="loginClose" type="button">é—œé–‰</button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label">å¸³è™Ÿ</div>
          <select id="loginUser" autocomplete="username">
            <option value="">è«‹é¸æ“‡å¸³è™Ÿ</option>
          </select>
        </div>
        <div class="field" style="margin-top:10px;">
          <div class="label">å¯†ç¢¼</div>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />
        </div>
        <div class="loginErr" id="loginErr"></div>
        <div class="loginHint">
          ç™»å…¥å¸³å¯†å®Œå…¨ä»¥ã€Œæ¬Šé™è¡¨.htmlã€çš„æ¬Šé™è¡¨ï¼ˆlocalStorage: <b>tasunAuthTable_v1</b>ï¼‰ç‚ºæº–ã€‚
        </div>
      </div>
      <div class="loginFoot">
        <button class="btn ghost" id="loginToAuth" type="button">å‰å¾€æ¬Šé™è¡¨</button>
        <button class="btn" id="loginBtn" type="button">ç™»å…¥</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ===== Keys =====
    const CURRENT_KEY = "tasunCurrentUser_v1";
    const AUTH_KEY = "tasunAuthTable_v1";
    const DB_KEY = "tasunEngineeringDetail_v1";
    const SYS_DICT_KEY = "tasunEngineeringDetail_systems_v1";
    const CAT_DICT_KEY = "tasunEngineeringDetail_categories_v1";

    // ===== State =====
    let currentUser=null;
    let db=[];

    // ===== Utils =====
    const $=(id)=>document.getElementById(id);
    const norm=(s)=>(s??"").toString().trim();

    function toast(msg){
      const t=$("toast");
      t.textContent=msg;
      t.style.display="block";
      clearTimeout(toast._tm);
      toast._tm=setTimeout(()=>t.style.display="none",2200);
    }
    function escHtml(s){
      return (s??"").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // ===== Auth Table (å”¯ä¸€çœŸç›¸ä¾†æº) =====
    function mapRole(v){
      const s=(v??"").toString().trim().toLowerCase();
      if(!s) return "read";
      if(s==="admin") return "admin";
      if(s==="write"||s==="edit") return "write";
      if(s==="read"||s==="view") return "read";
      if(s==="0") return "admin";
      if(s==="1") return "write";
      if(s==="2") return "read";
      return s;
    }

    function loadAuthTable(){
      try{
        const raw=localStorage.getItem(AUTH_KEY);
        if(!raw) return [];
        const parsed=JSON.parse(raw);
        if(Array.isArray(parsed)) return parsed;
        if(parsed && Array.isArray(parsed.users)) return parsed.users;
        return [];
      }catch(e){ return []; }
    }

    function pickUsername(row){ return norm(row?.username ?? row?.user ?? row?.account ?? row?.name); }
    function pickPassword(row){ return (row?.password ?? row?.pass ?? row?.pwd ?? "").toString(); }
    function pickRole(row){ return mapRole(row?.role ?? row?.level ?? row?.perm ?? row?.permission); }

    function findAuthUser(username){
      const u=norm(username).toLowerCase();
      if(!u) return null;
      const rows=loadAuthTable();
      for(const r of rows){
        const ru=pickUsername(r).toLowerCase();
        if(ru && ru===u){
          return { user: pickUsername(r), pass: pickPassword(r), role: pickRole(r) || "read" };
        }
      }
      return null;
    }

    function loadCurrentUser(){
      try{ currentUser = JSON.parse(localStorage.getItem(CURRENT_KEY) || "null"); }
      catch(e){ currentUser=null; }
      if(currentUser && typeof currentUser==="object"){
        const uname = norm(currentUser.user ?? currentUser.username ?? currentUser.name ?? currentUser.account);
        if(uname){
          currentUser.user = uname;
          currentUser.username = uname; // å…¼å®¹
        }
        if(currentUser.role) currentUser.role = mapRole(currentUser.role);
        if(currentUser.level) currentUser.level = mapRole(currentUser.level);
        currentUser.authStamp = (currentUser.authStamp ?? "").toString();
      }
    }

    function setCurrentUser(user, role, authStamp){
      const u = {
        user,
        username: user,        // å…¼å®¹èˆŠé 
        role: mapRole(role),
        level: mapRole(role),  // å…¼å®¹èˆŠé 
        authStamp: (authStamp || "").toString()
      };
      localStorage.setItem(CURRENT_KEY, JSON.stringify(u));
      currentUser = u;
    }

    function role(){ return mapRole(currentUser?.role ?? currentUser?.level ?? "read"); }
    function canWrite(){ const r = role(); return r==="admin" || r==="write"; }

    // ===== Session Watch Patch =====
    const SESSION_WATCH_MS = 3000;
    let _watchStarted = false;

    function fnv1a(str){
      let h = 0x811c9dc5;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 0x01000193);
      }
      return (h >>> 0).toString(16).padStart(8, "0");
    }
    function authStampFromAuth(auth){
      return fnv1a(`${auth.user}|${auth.pass ?? ""}`);
    }

    function rebuildUserDropdown(preselectUser){
      const sel = $("loginUser");
      const rows = loadAuthTable();
      const users = rows.map(r => pickUsername(r)).filter(Boolean);

      const seen = new Set();
      const uniq = [];
      for(const u of users){
        const k = u.toLowerCase();
        if(seen.has(k)) continue;
        seen.add(k);
        uniq.push(u);
      }

      sel.innerHTML = `<option value="">è«‹é¸æ“‡å¸³è™Ÿ</option>` + uniq.map(u=>{
        const s = (preselectUser && u.toLowerCase() === preselectUser.toLowerCase()) ? "selected" : "";
        return `<option value="${escHtml(u)}" ${s}>${escHtml(u)}</option>`;
      }).join("");
    }

    function openLoginModal(msg){
      $("loginErr").style.display="none";
      if(msg){
        $("loginErr").textContent = msg;
        $("loginErr").style.display="block";
      }
      loadCurrentUser();
      rebuildUserDropdown(currentUser?.user || "");

      $("loginPass").value="";
      $("loginMask").classList.add("show");
      $("loginMask").setAttribute("aria-hidden","false");

      setTimeout(()=>{
        if($("loginUser").value) $("loginPass").focus();
        else $("loginUser").focus();
      },0);
    }
    function closeLoginModal(){
      $("loginMask").classList.remove("show");
      $("loginMask").setAttribute("aria-hidden","true");
    }

    function forceReLogin(msg){
      try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}
      currentUser = null;
      toast(msg || "æ¬Šé™è¡¨å·²æ›´æ–°ï¼Œè«‹é‡æ–°ç™»å…¥");
      openLoginModal(msg || "æ¬Šé™è¡¨å·²æ›´æ–°ï¼Œè«‹é‡æ–°ç™»å…¥");
      $("uName").textContent="â€”";
      $("uRole").textContent="â€”";
      $("btnReg").style.display="none";
    }

    function validateSession(){
      const lm = $("loginMask");
      if(lm && lm.classList.contains("show")) return;

      loadCurrentUser();
      if(!currentUser || !currentUser.user) return;

      const auth = findAuthUser(currentUser.user);
      if(!auth){ forceReLogin("å¸³è™Ÿå·²è¢«ç§»é™¤ï¼Œè«‹é‡æ–°ç™»å…¥"); return; }

      const stampNow = authStampFromAuth(auth);

      if(!currentUser.authStamp){
        setCurrentUser(auth.user, auth.role || "read", stampNow);
        $("uName").textContent = auth.user;
        $("uRole").textContent = role();
        $("btnReg").style.display = canWrite() ? "inline-block" : "none";
        return;
      }

      if(currentUser.authStamp !== stampNow){
        forceReLogin("å¯†ç¢¼å·²æ›´æ–°ï¼Œè«‹é‡æ–°ç™»å…¥");
        return;
      }

      const r = auth.role || "read";
      if(mapRole(currentUser.role) !== r){
        setCurrentUser(auth.user, r, stampNow);
        $("uRole").textContent = r;
        $("btnReg").style.display = canWrite() ? "inline-block" : "none";
      }
    }

    function startSessionWatch(){
      if(_watchStarted) return;
      _watchStarted = true;

      window.addEventListener("storage", (e)=>{
        if(e.key === AUTH_KEY || e.key === CURRENT_KEY) validateSession();
        // âœ… æ˜ç´°è¡¨è³‡æ–™æ›´æ–°ï¼ˆä¾‹å¦‚å¦é æ–°å¢/ç·¨è¼¯ï¼‰
        if(e.key === DB_KEY){
          loadDB();
          rebuildSysSelect();              // ç³»çµ±å¯èƒ½æ–°å¢
          rebuildCatSelectForSys(norm($("sys").value), norm($("cat").value)); // é¡åˆ¥ä¾ç³»çµ±é‡ç®—
          renderTableOnly();
        }
      });
      setInterval(validateSession, SESSION_WATCH_MS);
    }

    function ensureLoggedIn(){
      loadCurrentUser();
      const rows = loadAuthTable();
      if(!Array.isArray(rows) || rows.length === 0){
        openLoginModal("å°šæœªå»ºç«‹æ¬Šé™è¡¨ï¼šè«‹å…ˆåˆ°ã€Œæ¬Šé™è¡¨.htmlã€å»ºç«‹å¸³è™Ÿã€‚");
        return false;
      }

      if(!currentUser || !currentUser.user){
        openLoginModal();
        return false;
      }

      const auth = findAuthUser(currentUser.user);
      if(!auth){ forceReLogin("å¸³è™Ÿå·²è¢«ç§»é™¤ï¼Œè«‹é‡æ–°ç™»å…¥"); return false; }

      const stampNow = authStampFromAuth(auth);
      if(currentUser.authStamp && currentUser.authStamp !== stampNow){
        forceReLogin("å¯†ç¢¼å·²æ›´æ–°ï¼Œè«‹é‡æ–°ç™»å…¥");
        return false;
      }

      setCurrentUser(auth.user, auth.role || "read", stampNow);
      $("uName").textContent = auth.user;
      $("uRole").textContent = role();
      $("btnReg").style.display = canWrite() ? "inline-block" : "none";
      return true;
    }

    function doLogin(){
      const u = norm($("loginUser").value);
      const p = ($("loginPass").value ?? "").toString();
      const rows = loadAuthTable();

      if(!Array.isArray(rows) || rows.length === 0){
        $("loginErr").textContent = "å°šæœªå»ºç«‹æ¬Šé™è¡¨ï¼šè«‹å…ˆåˆ°ã€Œæ¬Šé™è¡¨.htmlã€å»ºç«‹å¸³è™Ÿã€‚";
        $("loginErr").style.display = "block";
        return;
      }
      if(!u){
        $("loginErr").textContent = "è«‹å…ˆé¸æ“‡å¸³è™Ÿã€‚";
        $("loginErr").style.display = "block";
        return;
      }
      if(!p){
        $("loginErr").textContent = "è«‹è¼¸å…¥å¯†ç¢¼ã€‚";
        $("loginErr").style.display = "block";
        return;
      }

      const auth = findAuthUser(u);
      if(!auth){
        $("loginErr").textContent = "å¸³è™Ÿä¸å­˜åœ¨ï¼ˆä»¥æ¬Šé™è¡¨ç‚ºæº–ï¼‰ã€‚";
        $("loginErr").style.display = "block";
        return;
      }
      if((auth.pass ?? "") !== p){
        $("loginErr").textContent = "å¯†ç¢¼éŒ¯èª¤ï¼ˆä»¥æ¬Šé™è¡¨ç‚ºæº–ï¼‰ã€‚";
        $("loginErr").style.display = "block";
        return;
      }

      const stampNow = authStampFromAuth(auth);
      setCurrentUser(auth.user, auth.role || "read", stampNow);

      closeLoginModal();
      toast("ç™»å…¥æˆåŠŸ");
      start(); // é‡è·‘åˆå§‹åŒ–ï¼ˆç¢ºä¿æ¬Šé™èˆ‡æŒ‰éˆ•ç‹€æ…‹æ­£ç¢ºï¼‰
    }

    // ===== Data =====
    function loadDB(){
      try{
        db = JSON.parse(localStorage.getItem(DB_KEY) || "[]");
        if(!Array.isArray(db)) db=[];
      }catch(e){ db=[]; }
    }

    function padNo(n){
      const nn = Number(n);
      const s = Number.isFinite(nn) ? String(nn) : String(n ?? "");
      return s.length>=4?s:("0000".slice(s.length)+s);
    }

    function loadDict(key){
      try{
        const raw = localStorage.getItem(key);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr.map(norm).filter(Boolean) : [];
      }catch(e){ return []; }
    }

    function uniqueFromDB(field){
      const set=new Set();
      for(const r of db){
        const v=norm(r[field]);
        if(v) set.add(v);
      }
      return set;
    }

    function unionOptions(field, dictKey){
      const set = uniqueFromDB(field);
      for(const v of loadDict(dictKey)) set.add(v);
      const arr = Array.from(set);
      arr.sort((a,b)=>a.localeCompare(b,"zh-Hant"));
      return arr;
    }

    // âœ… ç³»çµ±ï¼šä»æ¡ã€Œæ˜ç´°è¡¨è³‡æ–™ä¸é‡è¤‡ + ç³»çµ±å­—å…¸ã€
    function rebuildSysSelect(){
      const keepS = norm($("sys").value);
      const sys = unionOptions("system", SYS_DICT_KEY);

      $("sys").innerHTML =
        `<option value="">å…¨éƒ¨</option>` +
        sys.map(v=>`<option value="${escHtml(v)}">${escHtml(v)}</option>`).join("");

      if(sys.includes(keepS)) $("sys").value = keepS;
    }

    // âœ… é¡åˆ¥ï¼šä¾ã€Œå·²é¸ç³»çµ±ã€â†’ å¾æ˜ç´°è¡¨è³‡æ–™æŠ“å‡ºã€Œä¸é‡è¤‡é¡åˆ¥ã€åšä¸‹æ‹‰
    //   - sys="" â†’ é¡åˆ¥é¡¯ç¤ºå…¨éƒ¨ï¼ˆè³‡æ–™ä¸é‡è¤‡ + é¡åˆ¥å­—å…¸ï¼Œç¶­æŒåŸé‚è¼¯ï¼‰
    //   - sys!= "" â†’ é¡åˆ¥åªé¡¯ç¤ºè©²ç³»çµ±åœ¨æ˜ç´°è¡¨å…§å‡ºç¾éçš„é¡åˆ¥ï¼ˆä¸é‡è¤‡ï¼‰
    function rebuildCatSelectForSys(sysValue, keepCat){
      const sys = norm(sysValue);
      const keep = norm(keepCat);

      let cats = [];

      if(!sys){
        // å…¨éƒ¨ï¼ˆç¶­æŒåŸæœ¬ï¼šè³‡æ–™ä¸é‡è¤‡ + å­—å…¸ï¼‰
        cats = unionOptions("category", CAT_DICT_KEY);
      }else{
        // åªå–è©²ç³»çµ±åœ¨è³‡æ–™ä¸­ã€Œå¯¦éš›å­˜åœ¨ã€çš„é¡åˆ¥
        const set = new Set();
        for(const r of db){
          if(norm(r.system) !== sys) continue;
          const c = norm(r.category);
          if(c) set.add(c);
        }
        cats = Array.from(set);
        cats.sort((a,b)=>a.localeCompare(b,"zh-Hant"));
      }

      $("cat").innerHTML =
        `<option value="">å…¨éƒ¨</option>` +
        cats.map(v=>`<option value="${escHtml(v)}">${escHtml(v)}</option>`).join("");

      // è‹¥åŸæœ¬å·²é¸é¡åˆ¥ä¸åœ¨æ–°æ¸…å–® â†’ è‡ªå‹•å›åˆ°å…¨éƒ¨
      if(keep && cats.includes(keep)) $("cat").value = keep;
      else $("cat").value = "";
    }

    function filtered(){
      const q=norm($("q").value).toLowerCase();
      const sys=norm($("sys").value);
      const cat=norm($("cat").value);

      let rows=db.slice();
      if(sys) rows=rows.filter(r=>norm(r.system)===sys);
      if(cat) rows=rows.filter(r=>norm(r.category)===cat);

      if(q){
        rows=rows.filter(r=>{
          const hay=[r.name,r.system,r.category,r.url,r.regDate,r.id]
            .map(x=>(x??"").toString().toLowerCase()).join(" | ");
          return hay.includes(q);
        });
      }

      rows.sort((a,b)=>(norm(b.regDate)||"").localeCompare(norm(a.regDate)||""));
      return rows;
    }

    function renderTableOnly(){
      const rows=filtered();

      $("tbody").innerHTML = rows.map(r=>{
        const url=norm(r.url);
        const link = url
          ? `<a class="link" href="${escHtml(url)}" target="_blank" rel="noopener">é–‹å•Ÿ</a>`
          : `<span class="muted">â€”</span>`;

        return `
          <tr>
            <td>${escHtml(padNo(r.id))}</td>
            <td>${escHtml(r.name)}</td>
            <td>${escHtml(r.system) || `<span class="muted">â€”</span>`}</td>
            <td>${escHtml(r.category) || `<span class="muted">â€”</span>`}</td>
            <td>${link}</td>
            <td>${escHtml(r.regDate||"") || `<span class="muted">â€”</span>`}</td>
          </tr>
        `;
      }).join("") || `<tr><td colspan="6" class="muted" style="padding:18px;">å°šç„¡è³‡æ–™</td></tr>`;

      // é¡¯ç¤ºï¼šè©²ç³»çµ±çš„ã€Œä¸é‡è¤‡é¡åˆ¥æ•¸ã€
      const sysNow = norm($("sys").value);
      let catCount = 0;
      if(sysNow){
        const set = new Set();
        for(const r of db){
          if(norm(r.system) !== sysNow) continue;
          const c = norm(r.category);
          if(c) set.add(c);
        }
        catCount = set.size;
      }

      const writable = canWrite();
      $("hint").innerHTML =
        `ç­†æ•¸ï¼š<b style="color:var(--gold)">${rows.length}</b>ã€‚` +
        (sysNow ? ` è©²ç³»çµ±ä¸é‡è¤‡é¡åˆ¥ï¼š<b style="color:var(--gold)">${catCount}</b>ã€‚` : ``) +
        (writable ? ` ä½ ä¹Ÿå¯ä»¥åˆ°ã€Œç™»éŒ„è³‡æ–™ã€æ–°å¢ã€‚` : `ï¼ˆread æ¬Šé™åƒ…å¯æŸ¥è©¢ï¼‰`);
    }

    function render(){
      // âœ… ç³»çµ±ä¸‹æ‹‰ï¼ˆå…¨åŸŸï¼‰
      rebuildSysSelect();
      // âœ… é¡åˆ¥ä¸‹æ‹‰ï¼ˆä¾ç³»çµ±è€Œè®Šï¼‰
      rebuildCatSelectForSys(norm($("sys").value), norm($("cat").value));
      renderTableOnly();
    }

    function setupMoreMenu(backHref){
      const backBtn = $("mBack");
      const moreBtn = $("mMoreBtn");
      const menu = $("mMoreMenu");

      const close = ()=> menu.classList.remove("open");
      const toggle = (e)=>{
        e.preventDefault();
        e.stopPropagation();
        menu.classList.toggle("open");
      };

      backBtn.onclick = ()=> location.href = backHref;
      moreBtn.addEventListener("click", toggle);

      menu.addEventListener("click", (e)=>{
        e.stopPropagation();
        const item = e.target.closest("button.menuItem[data-href]");
        if(!item) return;
        const href = item.getAttribute("data-href");
        if(href) location.href = href;
      });

      document.addEventListener("click", close);
      window.addEventListener("keydown", (e)=>{ if(e.key === "Escape") close(); });
    }

    function start(){
      if(!ensureLoggedIn()) return;

      loadDB();

      $("navBackList").onclick = ()=>location.href="å·¥ç¨‹è³‡æ–™æ˜ç´°è¡¨.html";
      setupMoreMenu("å·¥ç¨‹è³‡æ–™æ˜ç´°è¡¨.html");

      $("btnHome").onclick = ()=>location.href="index.html";
      $("btnReg").onclick = ()=>location.href="å·¥ç¨‹è³‡æ–™ç™»éŒ„.html";

      // âœ… ç™»éŒ„æŒ‰éˆ•æ¬Šé™æ§åˆ¶
      $("btnReg").style.display = canWrite() ? "inline-block" : "none";

      // ğŸ”‘ é‡é»ï¼šç³»çµ±è®Šæ›´ â†’ å…ˆé‡å»ºã€Œè©²ç³»çµ±çš„é¡åˆ¥æ¸…å–®ã€â†’ å†æ¸²æŸ“
      $("sys").addEventListener("change", ()=>{
        rebuildCatSelectForSys(norm($("sys").value), ""); // ç³»çµ±è®Šæ›´ â†’ é¡åˆ¥é‡ç½®ç‚ºå…¨éƒ¨
        renderTableOnly();
      });

      $("q").addEventListener("input", renderTableOnly);
      $("cat").addEventListener("change", renderTableOnly);

      $("btnClear").onclick = ()=>{
        $("q").value="";
        $("sys").value="";
        rebuildCatSelectForSys("", ""); // å›åˆ°å…¨éƒ¨é¡åˆ¥
        renderTableOnly();
      };

      // åˆå§‹å»ºä¸€æ¬¡
      rebuildSysSelect();
      rebuildCatSelectForSys(norm($("sys").value), norm($("cat").value));
      renderTableOnly();
    }

    // ===== Login Modal Bindings =====
    (function bindLogin(){
      $("loginClose").onclick = closeLoginModal;
      $("loginToAuth").onclick = ()=> location.href="æ¬Šé™è¡¨.html";
      $("loginBtn").onclick = doLogin;

      $("loginMask").addEventListener("click",(e)=>{
        if(e.target === $("loginMask")) closeLoginModal();
      });

      window.addEventListener("keydown",(e)=>{
        if(e.key === "Escape" && $("loginMask").classList.contains("show")) closeLoginModal();
        if(e.key === "Enter" && $("loginMask").classList.contains("show")) doLogin();
      });

      $("loginUser").addEventListener("change", ()=>{
        if($("loginUser").value) $("loginPass").focus();
      });
    })();

    startSessionWatch();
    start();
  </script>
</body>
</html>
