<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>工程資料查詢 · Tasun</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg0:#070809; --bg1:#0b0d10;
      --gold:#f6d37a; --border:rgba(246,211,122,.28); --border2:rgba(246,211,122,.40);
      --text:#ececec; --muted:rgba(236,236,236,.70);
      --shadow:0 18px 50px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family:"Noto Serif TC", serif;
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(246,211,122,.10), transparent 60%),
        radial-gradient(900px 520px at 85% 25%, rgba(246,211,122,.08), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{max-width:1200px;margin:0 auto;padding:20px 16px 34px}

    .topbar{
      position:sticky; top:10px; z-index:20;
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:12px;
      align-items:center;
      padding:14px;
      border:1px solid var(--border);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
    }
    @media (max-width:920px){
      .topbar{ grid-template-columns: 1fr; }
      .nav-left{ order:0; }
      .brand{ order:1; }
      .right{ order:2; justify-content:flex-start; }
    }

    .nav-left{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-start;
      min-width: 220px;
    }
    .nav-desktop{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .nav-mobile{ display:none; gap:10px; align-items:center; width:100%; }
    @media (max-width:600px){
      .nav-desktop{ display:none; }
      .nav-mobile{ display:flex; }
    }

    .brand{display:flex; flex-direction:column}
    .title{font-weight:900; letter-spacing:.08em; font-size:20px; color:var(--gold); text-shadow:0 0 18px rgba(246,211,122,.22)}
    .sub{font-size:12px; color:var(--muted); letter-spacing:.08em; margin-top:4px}

    .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    @media (max-width:920px){ .right{justify-content:flex-start;} }

    .pill{
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.05);
      font-size:13px; color:rgba(236,236,236,.85);
      display:flex; gap:8px; align-items:center; white-space:nowrap;
    }
    .pill b{color:var(--gold)}

    .btn{
      appearance:none; border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(246,211,122,.18), rgba(246,211,122,.07));
      color:var(--gold);
      padding:9px 12px; border-radius:999px;
      cursor:pointer; font-family:inherit; font-weight:900; letter-spacing:.05em;
      box-shadow:0 10px 22px rgba(0,0,0,.35);
      transition:transform .12s ease, filter .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.06)}
    .btn.ghost{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.18);
      color:rgba(236,236,236,.85);
      font-weight:600;
    }
    .small{padding:8px 10px; font-size:12px; border-radius:999px; letter-spacing:.04em}

    /* 手機更多浮層 */
    .moreWrap{ position:relative; display:inline-flex; }
    .moreMenu{
      position:absolute;
      top:calc(100% + 8px);
      right:0;
      min-width: 220px;
      border-radius:16px;
      border:1px solid rgba(246,211,122,.30);
      background:linear-gradient(180deg, rgba(0,0,0,.72), rgba(0,0,0,.45));
      box-shadow:0 18px 50px rgba(0,0,0,.65);
      backdrop-filter:blur(10px);
      padding:8px;
      display:none;
      z-index:60;
    }
    .moreMenu.open{ display:block; }
    .menuItem{
      width:100%;
      text-align:left;
      border:none;
      background:rgba(255,255,255,.04);
      color:rgba(236,236,236,.92);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-family:inherit;
      letter-spacing:.04em;
    }
    .menuItem:hover{ background:rgba(246,211,122,.12); color:var(--gold); }
    .menuSep{ height:1px; margin:8px 6px; background:rgba(255,255,255,.10); }

    .panel{
      margin-top:16px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
    }

    .controls{
      display:grid;
      grid-template-columns: 1.2fr .9fr .9fr auto;
      gap:10px; align-items:end;
    }
    @media (max-width:920px){ .controls{grid-template-columns:1fr 1fr} }
    @media (max-width:520px){ .controls{grid-template-columns:1fr} }

    .field{display:flex; flex-direction:column; gap:6px}
    .label{font-size:12px; letter-spacing:.08em; color:var(--muted)}
    input,select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);
      color:var(--text);
      padding:10px 12px;
      font-family:inherit;
      outline:none;
    }

    .tableWrap{margin-top:14px; overflow:auto; border-radius:16px; border:1px solid rgba(255,255,255,.12)}
    table{width:100%; border-collapse:collapse; min-width:920px; background:rgba(0,0,0,.18)}
    thead th{
      position:sticky; top:0; z-index:2;
      background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
      color:rgba(246,211,122,.95);
      font-size:13px; letter-spacing:.06em;
      text-align:left;
      padding:12px 12px;
      border-bottom:1px solid rgba(246,211,122,.25);
      white-space:nowrap;
    }
    tbody td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
      font-size:14px;
      color:rgba(236,236,236,.92);
    }
    tbody tr:hover td{background:rgba(255,255,255,.04)}
    .link{color:var(--gold); text-decoration:none; border-bottom:1px dashed rgba(246,211,122,.45); white-space:nowrap;}
    .muted{color:rgba(236,236,236,.55)}
    .hint{margin-top:10px; color:var(--muted); font-size:13px; line-height:1.6}
  </style>
</head>
<body>

  <div class="wrap">
    <div class="topbar">
      <div class="nav-left">
        <!-- 桌面 -->
        <div class="nav-desktop">
          <button class="btn ghost small" id="navBackList">返回工程資料明細表</button>
        </div>

        <!-- 手機：返回 + 更多(浮層) -->
        <div class="nav-mobile">
          <button class="btn ghost small" id="mBack">返回</button>

          <div class="moreWrap">
            <button class="btn ghost small" id="mMoreBtn" type="button">更多 ▾</button>
            <div class="moreMenu" id="mMoreMenu" role="menu" aria-label="更多選單">
              <button class="menuItem" data-href="工程資料明細表.html" type="button">工程資料明細表</button>
              <button class="menuItem" data-href="工程資料登錄.html" type="button">工程資料登錄</button>
              <div class="menuSep"></div>
              <button class="menuItem" data-href="index.html" type="button">返回首頁</button>
            </div>
          </div>
        </div>
      </div>

      <div class="brand">
        <div class="title">工程資料查詢</div>
        <div class="sub">純查詢 / 點連結開啟 / 不修改資料</div>
      </div>

      <div class="right">
        <div class="pill">使用者：<b id="uName">—</b></div>
        <div class="pill">權限：<b id="uRole">—</b></div>
        <button class="btn ghost" id="btnHome">返回首頁</button>
        <button class="btn" id="btnReg">登錄資料</button>
      </div>
    </div>

    <div class="panel">
      <div class="controls">
        <div class="field">
          <div class="label">搜尋（文件名稱 / 系統 / 類別 / 連結）</div>
          <input id="q" placeholder="例如：材料審查、施工圖、消防、弱電..." />
        </div>

        <div class="field">
          <div class="label">系統</div>
          <select id="sys"><option value="">全部</option></select>
        </div>

        <div class="field">
          <div class="label">類別</div>
          <select id="cat"><option value="">全部</option></select>
        </div>

        <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
          <button class="btn ghost" id="btnClear">清除條件</button>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:100px;">編號</th>
              <th style="width:320px;">文件名稱</th>
              <th style="width:180px;">系統</th>
              <th style="width:180px;">類別</th>
              <th>檔案連結</th>
              <th style="width:140px;">登錄日期</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="hint" id="hint"></div>
    </div>
  </div>

  <script>
    const CURRENT_KEY  = "tasunCurrentUser_v1";
    const DB_KEY       = "tasunEngineeringDetail_v1";
    const SYS_DICT_KEY = "tasunEngineeringDetail_systems_v1";
    const CAT_DICT_KEY = "tasunEngineeringDetail_categories_v1";

    let currentUser=null;
    let db=[];

    const $=(id)=>document.getElementById(id);
    const norm=(s)=>(s??"").toString().trim();

    function loadCurrentUser(){
      try{ currentUser = JSON.parse(localStorage.getItem(CURRENT_KEY) || "null"); }catch(e){ currentUser=null; }
    }
    function role(){ return (currentUser?.role || "read").toLowerCase(); }
    function canWrite(){ const r=role(); return r==="admin"||r==="write"; }
    function gate(){
      if(!currentUser || !currentUser.username){
        alert("尚未登入，將返回首頁。");
        location.href="index.html";
        return false;
      }
      $("uName").textContent = currentUser.username;
      $("uRole").textContent = role();
      return true;
    }
    function loadDB(){
      try{
        db = JSON.parse(localStorage.getItem(DB_KEY) || "[]");
        if(!Array.isArray(db)) db=[];
      }catch(e){ db=[]; }
    }
    function padNo(n){
      const s=String(n);
      return s.length>=4?s:("0000".slice(s.length)+s);
    }
    function escHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#39;");
    }
    function loadDict(key){
      try{
        const raw = localStorage.getItem(key);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr.map(norm).filter(Boolean) : [];
      }catch(e){ return []; }
    }
    function uniqueFromDB(field){
      const set=new Set();
      for(const r of db){
        const v=norm(r[field]);
        if(v) set.add(v);
      }
      return set;
    }
    function unionOptions(field, dictKey){
      const set = uniqueFromDB(field);
      for(const v of loadDict(dictKey)) set.add(v);
      const arr = Array.from(set);
      arr.sort((a,b)=>a.localeCompare(b,"zh-Hant"));
      return arr;
    }

    function rebuildSelects(){
      const keepS = $("sys").value;
      const keepC = $("cat").value;

      const sys = unionOptions("system", SYS_DICT_KEY);
      const cat = unionOptions("category", CAT_DICT_KEY);

      $("sys").innerHTML = `<option value="">全部</option>` + sys.map(v=>`<option value="${escHtml(v)}">${escHtml(v)}</option>`).join("");
      $("cat").innerHTML = `<option value="">全部</option>` + cat.map(v=>`<option value="${escHtml(v)}">${escHtml(v)}</option>`).join("");

      if(sys.includes(keepS)) $("sys").value = keepS;
      if(cat.includes(keepC)) $("cat").value = keepC;
    }

    function filtered(){
      const q=norm($("q").value).toLowerCase();
      const sys=norm($("sys").value);
      const cat=norm($("cat").value);

      let rows=db.slice();
      if(sys) rows=rows.filter(r=>norm(r.system)===sys);
      if(cat) rows=rows.filter(r=>norm(r.category)===cat);

      if(q){
        rows=rows.filter(r=>{
          const hay=[r.name,r.system,r.category,r.url,r.regDate,r.id].map(x=>(x??"").toString().toLowerCase()).join(" | ");
          return hay.includes(q);
        });
      }
      rows.sort((a,b)=>(norm(b.regDate)||"").localeCompare(norm(a.regDate)||""));
      return rows;
    }

    function render(){
      rebuildSelects();
      const rows=filtered();

      $("tbody").innerHTML = rows.map(r=>{
        const url=norm(r.url);
        const link = url
          ? `<a class="link" href="${escHtml(url)}" target="_blank" rel="noopener">開啟</a>`
          : `<span class="muted">—</span>`;
        return `<tr>
          <td>${escHtml(padNo(r.id))}</td>
          <td>${escHtml(r.name)}</td>
          <td>${escHtml(r.system)||`<span class="muted">—</span>`}</td>
          <td>${escHtml(r.category)||`<span class="muted">—</span>`}</td>
          <td>${link}</td>
          <td>${escHtml(r.regDate||"")||`<span class="muted">—</span>`}</td>
        </tr>`;
      }).join("") || `<tr><td colspan="6" class="muted" style="padding:18px;">尚無資料</td></tr>`;

      $("hint").innerHTML = `筆數：<b style="color:var(--gold)">${rows.length}</b>。` +
        (canWrite() ? ` 你也可以到「登錄資料」新增。` : ` （read 權限僅可查詢）`);
    }

    function setupMoreMenu(backHref){
      const backBtn = $("mBack");
      const moreBtn = $("mMoreBtn");
      const menu = $("mMoreMenu");

      const close = ()=> menu.classList.remove("open");
      const toggle = (e)=>{
        e.preventDefault();
        e.stopPropagation();
        menu.classList.toggle("open");
      };

      backBtn.onclick = ()=> location.href = backHref;

      moreBtn.addEventListener("click", toggle);

      menu.addEventListener("click", (e)=>{
        e.stopPropagation();
        const item = e.target.closest("button.menuItem[data-href]");
        if(!item) return;
        const href = item.getAttribute("data-href");
        if(href) location.href = href;
      });

      document.addEventListener("click", close);
      window.addEventListener("keydown", (e)=>{ if(e.key === "Escape") close(); });
    }

    function init(){
      loadCurrentUser();
      if(!gate()) return;
      loadDB();

      $("navBackList").onclick = ()=>location.href="工程資料明細表.html";
      setupMoreMenu("工程資料明細表.html");

      $("btnHome").onclick = ()=>location.href="index.html";
      $("btnReg").onclick  = ()=>location.href="工程資料登錄.html";

      $("q").addEventListener("input", render);
      $("sys").addEventListener("change", render);
      $("cat").addEventListener("change", render);

      $("btnClear").onclick = ()=>{
        $("q").value=""; $("sys").value=""; $("cat").value="";
        render();
      };

      render();
    }

    init();
  </script>
</body>
</html>
