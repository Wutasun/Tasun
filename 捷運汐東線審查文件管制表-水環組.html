<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>捷運汐東線審查文件管制表-水環組 · Tasun</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#070809;
      --bg1:#0b0d10;
      --gold:#f6d37a;
      --gold2:rgba(246,211,122,.55);
      --border:rgba(246,211,122,.28);
      --border2:rgba(246,211,122,.40);
      --text:#ececec;
      --muted:rgba(236,236,236,.70);
      --shadow:0 18px 50px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family:"Noto Serif TC", serif;
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(246,211,122,.10), transparent 60%),
        radial-gradient(900px 520px at 85% 25%, rgba(246,211,122,.08), transparent 62%),
        radial-gradient(1100px 700px at 55% 85%, rgba(246,211,122,.06), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{max-width:1400px;margin:0 auto;padding:20px 16px 34px}

    .topbar{
      position:relative;
      z-index:20;
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:12px;
      align-items:center;
      padding:14px;
      border:1px solid var(--border);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
    }
    @media (max-width:980px){
      .topbar{grid-template-columns:1fr}
      .nav-left{order:0}
      .brand{order:1}
      .right{order:2; justify-content:flex-start}
    }

    .nav-left{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-start;}
    .nav-desktop{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .nav-mobile{display:none; gap:10px; align-items:center; width:100%;}
    @media (max-width:650px){
      .nav-desktop{display:none}
      .nav-mobile{display:flex}
    }

    .brand{
      display:flex; flex-direction:column;
      align-items:center; justify-content:center; text-align:center;
      gap:4px;
    }
    .title{
      font-weight:900; letter-spacing:.08em;
      font-size: clamp(16px, 1.8vw, 22px);
      color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.22);
      line-height:1.25;
    }
    .sub{font-size:12px; color:var(--muted); letter-spacing:.08em}

    .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    @media (max-width:980px){ .right{justify-content:flex-start;} }

    .pill{
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.05);
      font-size:13px; color:rgba(236,236,236,.85);
      display:flex; gap:8px; align-items:center; white-space:nowrap;
    }
    .pill b{color:var(--gold)}

    .btn{
      appearance:none;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(246,211,122,.18), rgba(246,211,122,.07));
      color:var(--gold);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-family:inherit;
      font-weight:900;
      letter-spacing:.05em;
      box-shadow:0 10px 22px rgba(0,0,0,.35);
      transition:transform .12s ease, filter .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.06)}
    .btn:active{transform:translateY(0); filter:brightness(.98)}
    .btn.ghost{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.18);
      color:rgba(236,236,236,.85);
      font-weight:600;
    }
    .btn.danger{
      border-color:rgba(255,140,140,.35);
      background:linear-gradient(180deg, rgba(255,140,140,.14), rgba(255,140,140,.06));
      color:rgba(255,210,210,.95);
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      filter:saturate(.85);
      transform:none !important;
    }
    .small{padding:8px 10px; font-size:12px; border-radius:999px; letter-spacing:.04em}

    .moreWrap{ position:relative; display:inline-flex; }
    .moreMenu{
      position:absolute;
      top:calc(100% + 8px);
      left:0;
      min-width: 250px;
      border-radius:16px;
      border:1px solid rgba(246,211,122,.30);
      background:linear-gradient(180deg, rgba(0,0,0,.72), rgba(0,0,0,.45));
      box-shadow:0 18px 50px rgba(0,0,0,.65);
      backdrop-filter:blur(10px);
      padding:8px;
      display:none;
      z-index:60;
    }
    .moreMenu.open{ display:block; }
    .menuItem{
      width:100%;
      text-align:left;
      border:none;
      background:rgba(255,255,255,.04);
      color:rgba(236,236,236,.92);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-family:inherit;
      letter-spacing:.04em;
    }
    .menuItem:hover{ background:rgba(246,211,122,.12); color:var(--gold); }
    .menuSep{ height:1px; margin:8px 6px; background:rgba(255,255,255,.10); }

    .panel{
      margin-top:16px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
    }

    .bar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .leftOps,.rightOps{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .miniHint{font-size:12px; color:rgba(236,236,236,.62); line-height:1.6}
    .warn{color:rgba(255,190,190,.95)}
    .ok{color:rgba(190,255,210,.95)}

    .tableWrap{margin-top:10px; overflow:auto; border-radius:16px; border:1px solid rgba(255,255,255,.12)}
    table{width:100%; border-collapse:collapse; min-width:2100px; background:rgba(0,0,0,.18)}
    thead th{
      position:sticky; top:0; z-index:2;
      background:linear-gradient(180deg, rgba(0,0,0,.60), rgba(0,0,0,.38));
      color:rgba(246,211,122,.95);
      font-size:13px; letter-spacing:.06em;
      text-align:left;
      padding:12px 10px;
      border-bottom:1px solid rgba(246,211,122,.25);
      white-space:nowrap;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
      font-size:14px;
      color:rgba(236,236,236,.92);
    }
    tbody tr:hover td{background:rgba(255,255,255,.04)}

    .cellInput, .cellSelect{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.22);
      color:rgba(236,236,236,.92);
      padding:8px 10px;
      font-family:inherit;
      outline:none;
      transition:border-color .12s ease, filter .12s ease;
    }
    .cellInput:focus, .cellSelect:focus{border-color:rgba(246,211,122,.55); filter:brightness(1.05)}
    .cellInput:disabled, .cellSelect:disabled{opacity:.55; cursor:not-allowed; filter:saturate(.85)}

    .muted{color:rgba(236,236,236,.55)}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      font-size:12px;
      white-space:nowrap;
    }
    .tag b{color:var(--gold)}
    .overdue{border-color:rgba(255,140,140,.30); color:rgba(255,200,200,.95)}
    .soon{border-color:rgba(255,220,140,.30); color:rgba(255,235,200,.95)}
    .safe{border-color:rgba(190,255,210,.25); color:rgba(210,255,230,.95)}

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.55);
      color:rgba(236,236,236,.92);
      font-size:13px;
      box-shadow:var(--shadow);
      display:none;
      z-index:200;
      backdrop-filter:blur(10px);
    }

    /* ===== 共用登入 Login Modal（與你現有頁一致）===== */
    .loginMask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.68);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:999;
    }
    .loginMask.show{display:flex;}
    .loginModal{
      width:min(520px, 96vw);
      border-radius:22px;
      border:1px solid rgba(246,211,122,.40);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow:0 30px 90px rgba(0,0,0,.78);
      overflow:hidden;
      backdrop-filter:blur(12px);
    }
    .loginHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .loginTitle{
      font-weight:900; letter-spacing:.08em;
      color:#f6d37a;
      text-shadow:0 0 18px rgba(246,211,122,.22);
    }
    .loginBody{padding:14px 16px 10px;}
    .loginFoot{
      padding:12px 16px;
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .loginErr{
      margin-top:10px;
      color:rgba(255,190,190,.95);
      font-size:13px;
      line-height:1.5;
      display:none;
      white-space: pre-wrap;
    }
    .loginHint{
      margin-top:10px;
      color:rgba(236,236,236,.65);
      font-size:12px;
      line-height:1.6;
    }
    .field{display:flex; flex-direction:column; gap:6px}
    .label{font-size:12px; letter-spacing:.08em; color:rgba(236,236,236,.70)}
    .loginBody input,.loginBody select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);
      color:rgba(236,236,236,.92);
      padding:10px 12px;
      font-family:inherit;
      outline:none;
      transition:border-color .12s ease, filter .12s ease;
    }
    .loginBody input:focus,.loginBody select:focus{border-color:rgba(246,211,122,.55); filter:brightness(1.05)}
    .loginBody select{
      appearance:none;
      -webkit-appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(236,236,236,.85) 50%),
        linear-gradient(135deg, rgba(236,236,236,.85) 50%, transparent 50%);
      background-position:
        calc(100% - 18px) 50%,
        calc(100% - 12px) 50%;
      background-size: 6px 6px, 6px 6px;
      background-repeat:no-repeat;
      padding-right:34px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="nav-left">
        <div class="nav-desktop">
          <button class="btn ghost small" id="navBackDB">返回資料庫</button>
          <button class="btn ghost small" id="navToReg">前往登錄表</button>
          <button class="btn ghost small" id="navToQry">前往查詢表</button>
          <button class="btn ghost small" id="navBackXidong">返回汐東工程管理表</button>
          <button class="btn ghost small" id="navHome">返回首頁</button>
        </div>

        <div class="nav-mobile">
          <button class="btn ghost small" id="mBack">返回</button>
          <div class="moreWrap">
            <button class="btn ghost small" id="mMoreBtn" type="button">更多 ▾</button>
            <div class="moreMenu" id="mMoreMenu" role="menu" aria-label="更多選單">
              <button class="menuItem" data-href="捷運汐止東湖線統包工程-資料庫.html" type="button">返回資料庫</button>
              <button class="menuItem" data-href="捷運汐東線審查文件管制登錄表-水環組.html" type="button">前往登錄表</button>
              <button class="menuItem" data-href="捷運汐東線審查文件管制查詢表-水環組.html" type="button">前往查詢表</button>
              <button class="menuItem" data-href="汐東工程管理表.html" type="button">返回汐東工程管理表</button>
              <div class="menuSep"></div>
              <button class="menuItem" data-href="index.html" type="button">返回首頁</button>
            </div>
          </div>
        </div>
      </div>

      <div class="brand">
        <div class="title">捷運汐東線審查文件管制表-水環組</div>
        <div class="sub">write/admin 可修改儲存；read 只可閱讀｜到期日距今每次開啟自動更新</div>
      </div>

      <div class="right">
        <div class="pill">使用者：<b id="uName">—</b></div>
        <div class="pill">權限：<b id="uRole">—</b></div>
        <button class="btn" id="btnReLogin">切換帳號</button>
      </div>
    </div>

    <div class="panel">
      <div class="bar">
        <div class="leftOps">
          <span class="tag">今日：<b id="todayTag">—</b></span>
          <span class="tag">筆數：<b id="countTag">0</b></span>
          <span class="miniHint" id="permHint"></span>
        </div>
        <div class="rightOps">
          <button class="btn ghost small" id="btnRefresh" type="button">重新整理/重算</button>
          <button class="btn small" id="btnSaveAll" type="button">儲存變更</button>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:90px;">項次</th>
              <th style="width:170px;">文件編碼</th>
              <th style="width:320px;">文件名稱</th>
              <th style="width:120px;">版次</th>
              <th style="width:150px;">系統</th>
              <th style="width:160px;">文件類別</th>
              <th style="width:140px;">送審日期</th>
              <th style="width:140px;">到期日</th>
              <th style="width:160px;">到期日距今</th>
              <th style="width:110px;">期限(天)</th>
              <th style="width:140px;">狀態</th>
              <th style="width:160px;">審查結果</th>
              <th style="width:140px;">承辦人</th>
              <th style="width:220px;">權責</th>
              <th style="width:140px;">擺放編號</th>
              <th style="width:110px;" id="thAdminOps">操作</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="miniHint" style="margin-top:10px;">
        預設排序：<b style="color:var(--gold)">未完成</b> 依「到期日距今」由近到遠；<b style="color:var(--gold)">完成</b> 排在最後。
      </div>
    </div>
  </div>

  <!-- 共用登入 Login Modal（與你現有頁一致） -->
  <div class="loginMask" id="loginMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="登入">
      <div class="loginHead">
        <div class="loginTitle">登入</div>
        <button class="btn ghost small" id="loginClose" type="button">關閉</button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label">帳號</div>
          <select id="loginUser" autocomplete="username">
            <option value="">請選擇帳號</option>
          </select>
        </div>
        <div class="field" style="margin-top:10px;">
          <div class="label">密碼</div>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="請輸入密碼" />
        </div>
        <div class="loginErr" id="loginErr"></div>
        <div class="loginHint">
          登入帳密以「權限表.html」權限表（localStorage: <b>tasunAuthTable_v1</b>）為準。
        </div>
      </div>
      <div class="loginFoot">
        <button class="btn ghost" id="loginToAuth" type="button">前往權限表</button>
        <button class="btn" id="loginBtn" type="button">登入</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
/* ===========================
   TasunAuth 共用登入模組 v1
   =========================== */
window.TasunAuth = (function(){
  const CURRENT_KEY = "tasunCurrentUser_v1";
  const AUTH_KEY    = "tasunAuthTable_v1";
  const SESSION_WATCH_MS = 3000;

  let currentUser = null;
  let _watchStarted = false;
  let _onAuthed = null;
  let _onSessionChange = null;
  let _onForceRelogin = null;

  const $ = (id)=>document.getElementById(id);
  const norm = (s)=>(s??"").toString().trim();

  function mapRole(v){
    const s=(v??"").toString().trim().toLowerCase();
    if(!s) return "read";
    if(s==="admin") return "admin";
    if(s==="write"||s==="edit") return "write";
    if(s==="read"||s==="view") return "read";
    if(s==="0") return "admin";
    if(s==="1") return "write";
    if(s==="2") return "read";
    return s;
  }

  function loadAuthTable(){
    try{
      const raw=localStorage.getItem(AUTH_KEY);
      if(!raw) return [];
      const parsed=JSON.parse(raw);
      if(Array.isArray(parsed)) return parsed;
      if(parsed && Array.isArray(parsed.users)) return parsed.users;
      return [];
    }catch(e){ return []; }
  }

  function pickUsername(row){
    return norm(row?.user ?? row?.username ?? row?.account ?? row?.name);
  }
  function pickPassword(row){
    return (row?.pass ?? row?.password ?? row?.pwd ?? "").toString();
  }
  function pickRole(row){
    return mapRole(row?.role ?? row?.level ?? row?.perm ?? row?.permission);
  }

  function findAuthUser(username){
    const u=norm(username).toLowerCase();
    if(!u) return null;
    const rows=loadAuthTable();
    for(const r of rows){
      const ru=pickUsername(r).toLowerCase();
      if(ru && ru===u){
        return { username: pickUsername(r), password: pickPassword(r), role: pickRole(r) || "read" };
      }
    }
    return null;
  }

  function loadCurrentUser(){
    try{ currentUser = JSON.parse(localStorage.getItem(CURRENT_KEY) || "null"); }
    catch(e){ currentUser=null; }
    if(currentUser && typeof currentUser==="object"){
      const uname = norm(currentUser.username ?? currentUser.user ?? currentUser.name ?? currentUser.account);
      if(uname) currentUser.username = uname;
      if(currentUser.role) currentUser.role = mapRole(currentUser.role);
      if(currentUser.level) currentUser.level = mapRole(currentUser.level);
      currentUser.authStamp = (currentUser.authStamp ?? "").toString();
    }
  }

  function setCurrentUser(username, role, authStamp){
    const u = { username, user: username, role: mapRole(role), level: mapRole(role), authStamp: authStamp || "" };
    localStorage.setItem(CURRENT_KEY, JSON.stringify(u));
    currentUser = u;
  }

  function role(){ return mapRole(currentUser?.role ?? currentUser?.level ?? "read"); }
  function canWrite(){ const r=role(); return r==="admin" || r==="write"; }
  function isAdmin(){ return role()==="admin"; }

  function fnv1a(str){
    let h = 0x811c9dc5;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 0x01000193);
    }
    return (h >>> 0).toString(16).padStart(8, "0");
  }
  function authStampFromAuth(auth){
    return fnv1a(`${auth.username}|${auth.password ?? ""}`);
  }

  function rebuildUserDropdown(preselectUser){
    const sel = $("loginUser");
    if(!sel) return;

    const rows = loadAuthTable();
    const users = rows.map(r => pickUsername(r)).filter(x => !!norm(x));

    const seen = new Set();
    const uniq = [];
    for(const u of users){
      const k = u.toLowerCase();
      if(seen.has(k)) continue;
      seen.add(k);
      uniq.push(u);
    }

    sel.innerHTML =
      `<option value="">請選擇帳號</option>` +
      uniq.map(u=>{
        const s = (preselectUser && u.toLowerCase() === preselectUser.toLowerCase()) ? "selected" : "";
        const vv = u.replace(/"/g,"&quot;");
        return `<option value="${vv}" ${s}>${u}</option>`;
      }).join("");
  }

  function openLoginModal(msg){
    const mask=$("loginMask");
    const err=$("loginErr");
    if(!mask) return;

    if(err){
      err.style.display="none";
      if(msg){
        err.textContent = msg;
        err.style.display="block";
      }
    }

    loadCurrentUser();
    rebuildUserDropdown(currentUser?.username || "");
    const pass=$("loginPass");
    if(pass) pass.value="";

    mask.classList.add("show");
    mask.setAttribute("aria-hidden","false");

    setTimeout(()=>{
      const userSel=$("loginUser");
      if(userSel && userSel.value && pass) pass.focus();
      else if(userSel) userSel.focus();
    },0);
  }

  function closeLoginModal(){
    const mask=$("loginMask");
    if(!mask) return;
    mask.classList.remove("show");
    mask.setAttribute("aria-hidden","true");
  }

  function fireSessionChange(){
    if(typeof _onSessionChange === "function") _onSessionChange(current());
  }

  function forceReLogin(msg){
    try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}
    currentUser = null;

    if(typeof _onForceRelogin === "function") _onForceRelogin(msg || "");
    openLoginModal(msg || "權限表已更新，請重新登入");
    fireSessionChange();
  }

  function validateSession(){
    const mask=$("loginMask");
    if(mask && mask.classList.contains("show")) return;

    loadCurrentUser();
    if(!currentUser || !currentUser.username) return;

    const auth = findAuthUser(currentUser.username);
    if(!auth){
      forceReLogin("帳號已被移除，請重新登入");
      return;
    }

    const stampNow = authStampFromAuth(auth);

    if(!currentUser.authStamp){
      setCurrentUser(auth.username, auth.role || "read", stampNow);
      fireSessionChange();
      return;
    }

    if(currentUser.authStamp !== stampNow){
      forceReLogin("密碼已更新，請重新登入");
      return;
    }

    const r = auth.role || "read";
    if(mapRole(currentUser.role) !== r){
      setCurrentUser(auth.username, r, stampNow);
      fireSessionChange();
    }
  }

  function ensureLoggedIn(){
    loadCurrentUser();
    const rows = loadAuthTable();
    if(!Array.isArray(rows) || rows.length === 0){
      openLoginModal("尚未建立權限表：請先到「權限表.html」建立帳號。");
      return false;
    }

    if(!currentUser || !currentUser.username){
      openLoginModal();
      return false;
    }

    const auth = findAuthUser(currentUser.username);
    if(!auth){
      forceReLogin("帳號已被移除，請重新登入");
      return false;
    }

    const stampNow = authStampFromAuth(auth);
    if(currentUser.authStamp && currentUser.authStamp !== stampNow){
      forceReLogin("密碼已更新，請重新登入");
      return false;
    }

    setCurrentUser(auth.username, auth.role || "read", stampNow);
    fireSessionChange();
    return true;
  }

  function doLogin(){
    const userSel=$("loginUser");
    const passEl=$("loginPass");
    const err=$("loginErr");

    const u = norm(userSel ? userSel.value : "");
    const p = (passEl ? passEl.value : "").toString();
    const rows = loadAuthTable();

    function showErr(m){
      if(!err) return;
      err.textContent = m;
      err.style.display="block";
    }

    if(!Array.isArray(rows) || rows.length === 0) return showErr("尚未建立權限表：請先到「權限表.html」建立帳號。");
    if(!u) return showErr("請先選擇帳號。");
    if(!p) return showErr("請輸入密碼。");

    const auth = findAuthUser(u);
    if(!auth) return showErr("帳號不存在（以權限表為準）。");
    if((auth.password ?? "") !== p) return showErr("密碼錯誤（以權限表為準）。");

    const stampNow = authStampFromAuth(auth);
    setCurrentUser(auth.username, auth.role || "read", stampNow);

    closeLoginModal();
    fireSessionChange();
    if(typeof _onAuthed === "function") _onAuthed(current());
  }

  function bindUI(){
    const closeBtn=$("loginClose");
    const toAuth=$("loginToAuth");
    const loginBtn=$("loginBtn");
    const mask=$("loginMask");
    const userSel=$("loginUser");

    if(closeBtn) closeBtn.onclick = closeLoginModal;
    if(toAuth) toAuth.onclick = ()=> location.href="權限表.html";
    if(loginBtn) loginBtn.onclick = doLogin;

    if(userSel){
      userSel.addEventListener("change", ()=>{
        const pass=$("loginPass");
        if(userSel.value && pass) pass.focus();
      });
    }

    if(mask){
      mask.addEventListener("click",(e)=>{
        if(e.target === mask) closeLoginModal();
      });
    }

    window.addEventListener("keydown",(e)=>{
      const mask=$("loginMask");
      if(!mask) return;
      if(e.key === "Escape" && mask.classList.contains("show")) closeLoginModal();
      if(e.key === "Enter" && mask.classList.contains("show")) doLogin();
    });
  }

  function startWatch(){
    if(_watchStarted) return;
    _watchStarted = true;

    window.addEventListener("storage", (e)=>{
      if(e.key === AUTH_KEY || e.key === CURRENT_KEY){
        validateSession();
      }
    });
    setInterval(validateSession, SESSION_WATCH_MS);
  }

  function init(opts){
    _onAuthed = opts?.onAuthed || null;
    _onSessionChange = opts?.onSessionChange || null;
    _onForceRelogin = opts?.onForceRelogin || null;
    bindUI();
    startWatch();
  }

  function current(){ loadCurrentUser(); return currentUser; }

  return {
    init,
    ensureLoggedIn,
    validateSession,
    open: openLoginModal,
    close: closeLoginModal,
    current,
    role: ()=>{ loadCurrentUser(); return role(); },
    canWrite: ()=>{ loadCurrentUser(); return canWrite(); },
    isAdmin: ()=>{ loadCurrentUser(); return isAdmin(); },
  };
})();

/* ===========================
   Page: Water Review Control
   =========================== */
const DB_KEY = "tasunXidongReviewWater_ctl_v1";
const COUNTER_KEY = "tasunXidongReviewWater_counter_v1";

const $ = (id)=>document.getElementById(id);
const norm = (s)=>(s??"").toString().trim();

let db = [];

function toast(msg){
  const t=$("toast");
  t.textContent=msg;
  t.style.display="block";
  clearTimeout(toast._tm);
  toast._tm=setTimeout(()=>t.style.display="none",2200);
}
function escHtml(s){
  return (s??"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
function todayISO(){
  return new Date().toISOString().slice(0,10);
}
function daysDiff(aISO, bISO){
  // a - b
  const a = new Date(aISO+"T00:00:00");
  const b = new Date(bISO+"T00:00:00");
  return Math.round((a - b)/86400000);
}
function addDays(dateISO, days){
  if(!dateISO || !Number.isFinite(days)) return "";
  const d = new Date(dateISO+"T00:00:00");
  d.setDate(d.getDate() + days);
  return d.toISOString().slice(0,10);
}

function loadDB(){
  try{
    db = JSON.parse(localStorage.getItem(DB_KEY) || "[]");
    if(!Array.isArray(db)) db=[];
  }catch(e){ db=[]; }
}
function saveDB(){
  localStorage.setItem(DB_KEY, JSON.stringify(db));
}
function getCounter(){
  const n = Number(localStorage.getItem(COUNTER_KEY) || "0");
  return Number.isFinite(n) ? n : 0;
}

function uniqueOptions(field){
  const set = new Set();
  for(const r of db){
    const v = norm(r?.[field]);
    if(v) set.add(v);
  }
  const arr = Array.from(set);
  arr.sort((a,b)=>a.localeCompare(b,"zh-Hant"));
  return arr;
}
function normalizeRow(r){
  const row = {...r};
  row.id = Number(row.id) || 0;
  row.docCode = norm(row.docCode);
  row.docName = norm(row.docName);
  row.version = norm(row.version);
  row.system = norm(row.system);
  row.docType = norm(row.docType);
  row.submitDate = norm(row.submitDate);
  row.termDays = Number(row.termDays);
  if(!Number.isFinite(row.termDays)) row.termDays = Number(norm(r.termDays)) || 0;

  row.status = norm(row.status);
  row.reviewResult = norm(row.reviewResult);
  row.officer = norm(row.officer);
  row.duty = norm(row.duty);
  row.placeNo = norm(row.placeNo);

  // dutyItem 只供登錄表抓期限/權責用；管制表不額外顯示
  row.dutyItem = norm(row.dutyItem);

  // 自動算：到期日、到期日距今（完成不算）
  if(row.submitDate && Number.isFinite(row.termDays)){
    if(!row.dueDate || norm(row.dueDate).length!==10){
      row.dueDate = addDays(row.submitDate, row.termDays);
    }
  }
  row.dueDate = norm(row.dueDate);

  if(row.status === "完成"){
    row.dueInDays = "";
  }else{
    if(row.dueDate){
      row.dueInDays = daysDiff(row.dueDate, todayISO());
    }else{
      row.dueInDays = "";
    }
  }
  return row;
}

function recalcAllAndPersist(){
  loadDB();
  db = db.map(normalizeRow);
  saveDB();
}

function sortRows(rows){
  const active = [];
  const done = [];
  for(const r of rows){
    if(norm(r.status) === "完成") done.push(r);
    else active.push(r);
  }
  active.sort((a,b)=>{
    const ai = (a.dueInDays === "" || a.dueInDays === null || a.dueInDays === undefined) ? 999999 : Number(a.dueInDays);
    const bi = (b.dueInDays === "" || b.dueInDays === null || b.dueInDays === undefined) ? 999999 : Number(b.dueInDays);
    if(ai !== bi) return ai - bi;
    return (a.id||0) - (b.id||0);
  });
  done.sort((a,b)=>(b.id||0)-(a.id||0));
  return active.concat(done);
}

function dueTagHTML(dueInDays, status){
  if(status === "完成"){
    return `<span class="tag"><span class="muted">完成</span></span>`;
  }
  if(dueInDays === "" || dueInDays === null || dueInDays === undefined) return `<span class="tag"><span class="muted">—</span></span>`;
  const n = Number(dueInDays);
  if(!Number.isFinite(n)) return `<span class="tag"><span class="muted">—</span></span>`;
  if(n < 0) return `<span class="tag overdue">逾期 <b>${n}</b> 天</span>`;
  if(n <= 7) return `<span class="tag soon">剩 <b>${n}</b> 天</span>`;
  return `<span class="tag safe">剩 <b>${n}</b> 天</span>`;
}

function inputCell(name, value, disabled, type="text", extraAttr=""){
  const v = escHtml(value ?? "");
  return `<input class="cellInput" data-k="${escHtml(name)}" type="${escHtml(type)}" value="${v}" ${disabled?"disabled":""} ${extraAttr}>`;
}
function selectCell(name, value, disabled, options){
  const cur = norm(value);
  const opts = (options||[]).slice();
  if(cur && !opts.includes(cur)) opts.unshift(cur);

  const html = opts.map(o=>{
    const s = (o===cur) ? "selected" : "";
    return `<option value="${escHtml(o)}" ${s}>${escHtml(o)}</option>`;
  }).join("");

  return `
    <select class="cellSelect" data-k="${escHtml(name)}" ${disabled?"disabled":""}>
      <option value="">—</option>
      ${html}
    </select>
  `;
}

function render(){
  const canWrite = TasunAuth.canWrite();
  const isAdmin = TasunAuth.isAdmin();

  $("btnSaveAll").disabled = !canWrite;
  $("thAdminOps").style.display = isAdmin ? "" : "none";

  const optsDocCode = uniqueOptions("docCode");
  const optsDocName = uniqueOptions("docName");
  const optsVersion = uniqueOptions("version");
  const optsSystem = uniqueOptions("system");
  const optsDocType = uniqueOptions("docType");
  const optsStatus = uniqueOptions("status");
  const optsResult = uniqueOptions("reviewResult");
  const optsOfficer = uniqueOptions("officer");
  const optsDuty = uniqueOptions("duty");
  const optsPlace = uniqueOptions("placeNo");

  const rows = sortRows(db);

  $("countTag").textContent = String(rows.length);

  $("tbody").innerHTML = rows.map(r=>{
    const rid = Number(r.id)||0;

    const delBtn = isAdmin
      ? `<button class="btn danger small" data-act="del" data-id="${rid}" type="button">刪除</button>`
      : "";

    return `
      <tr data-id="${rid}">
        <td><span class="tag"><b>${escHtml(rid)}</b></span></td>

        <td>${inputCell("docCode", r.docCode, !canWrite, "text", `list="dl_docCode_${rid}"`)}
            <datalist id="dl_docCode_${rid}">${optsDocCode.map(v=>`<option value="${escHtml(v)}"></option>`).join("")}</datalist>
        </td>

        <td>${inputCell("docName", r.docName, !canWrite, "text", `list="dl_docName_${rid}"`)}
            <datalist id="dl_docName_${rid}">${optsDocName.map(v=>`<option value="${escHtml(v)}"></option>`).join("")}</datalist>
        </td>

        <td>${inputCell("version", r.version, !canWrite, "text", `list="dl_version_${rid}"`)}
            <datalist id="dl_version_${rid}">${optsVersion.map(v=>`<option value="${escHtml(v)}"></option>`).join("")}</datalist>
        </td>

        <td>${inputCell("system", r.system, !canWrite, "text", `list="dl_system_${rid}"`)}
            <datalist id="dl_system_${rid}">${optsSystem.map(v=>`<option value="${escHtml(v)}"></option>`).join("")}</datalist>
        </td>

        <td>${inputCell("docType", r.docType, !canWrite, "text", `list="dl_docType_${rid}"`)}
            <datalist id="dl_docType_${rid}">${optsDocType.map(v=>`<option value="${escHtml(v)}"></option>`).join("")}</datalist>
        </td>

        <td>${inputCell("submitDate", r.submitDate, !canWrite, "date")}</td>

        <td>${inputCell("dueDate", r.dueDate, !canWrite, "date")}</td>

        <td>
          ${canWrite
            ? `<input class="cellInput" data-k="dueInDays" value="${escHtml(r.dueInDays)}" disabled />`
            : dueTagHTML(r.dueInDays, r.status)
          }
        </td>

        <td>${inputCell("termDays", (Number.isFinite(Number(r.termDays))? String(Number(r.termDays)) : ""), !canWrite, "number", `min="0" step="1"`)}</td>

        <td>${inputCell("status", r.status, !canWrite, "text", `list="dl_status_${rid}"`)}
            <datalist id="dl_status_${rid}">${optsStatus.map(v=>`<option value="${escHtml(v)}"></option>`).join("")}</datalist>
        </td>

        <td>${inputCell("reviewResult", r.reviewResult, !canWrite, "text", `list="dl_result_${rid}"`)}
            <datalist id="dl_result_${rid}">${optsResult.map(v=>`<option value="${escHtml(v)}"></option>`).join("")}</datalist>
        </td>

        <td>${inputCell("officer", r.officer, !canWrite, "text", `list="dl_officer_${rid}"`)}
            <datalist id="dl_officer_${rid}">${optsOfficer.map(v=>`<option value="${escHtml(v)}"></option>`).join("")}</datalist>
        </td>

        <td>${inputCell("duty", r.duty, !canWrite, "text", `list="dl_duty_${rid}"`)}
            <datalist id="dl_duty_${rid}">${optsDuty.map(v=>`<option value="${escHtml(v)}"></option>`).join("")}</datalist>
        </td>

        <td>${inputCell("placeNo", r.placeNo, !canWrite, "text", `list="dl_place_${rid}"`)}
            <datalist id="dl_place_${rid}">${optsPlace.map(v=>`<option value="${escHtml(v)}"></option>`).join("")}</datalist>
        </td>

        <td style="${isAdmin?"":"display:none"}">${delBtn}</td>
      </tr>
    `;
  }).join("") || `<tr><td colspan="16" class="muted" style="padding:18px;">尚無資料（請到「登錄表」新增）</td></tr>`;

  // read 權限提示
  if(!canWrite){
    $("permHint").innerHTML = `<span class="warn">你目前是 read 權限：只能閱讀，不能修改/儲存。</span>`;
  }else{
    $("permHint").innerHTML = `<span class="ok">你目前是 ${escHtml(TasunAuth.role())}：可修改並儲存。</span>`;
  }
}

function collectFromUI(){
  const rows = Array.from(document.querySelectorAll("#tbody tr[data-id]"));
  const byId = new Map(db.map(r=>[Number(r.id)||0, r]));

  for(const tr of rows){
    const id = Number(tr.getAttribute("data-id")||"0")||0;
    const base = byId.get(id);
    if(!base) continue;

    const inputs = tr.querySelectorAll("input[data-k], select[data-k]");
    const patch = {};
    inputs.forEach(el=>{
      const k = el.getAttribute("data-k");
      if(!k) return;
      patch[k] = (el.value ?? "").toString();
    });

    // 合併
    const next = {...base};

    next.docCode = norm(patch.docCode);
    next.docName = norm(patch.docName);
    next.version = norm(patch.version);
    next.system = norm(patch.system);
    next.docType = norm(patch.docType);

    next.submitDate = norm(patch.submitDate);
    next.dueDate = norm(patch.dueDate);

    const term = Number(patch.termDays);
    next.termDays = Number.isFinite(term) ? term : (Number(base.termDays)||0);

    next.status = norm(patch.status);
    next.reviewResult = norm(patch.reviewResult);
    next.officer = norm(patch.officer);
    next.duty = norm(patch.duty);
    next.placeNo = norm(patch.placeNo);

    // 如果送審日期/期限變了：優先自動重算到期日（但若使用者手動改到期日也允許）
    if(next.submitDate && Number.isFinite(next.termDays)){
      const autoDue = addDays(next.submitDate, next.termDays);
      // 若使用者沒有手動改到期日（空白或與舊值相同），就跟著自動算
      if(!next.dueDate || next.dueDate === base.dueDate){
        next.dueDate = autoDue;
      }
    }

    // 到期日距今：完成不算
    if(next.status === "完成"){
      next.dueInDays = "";
    }else{
      if(next.dueDate) next.dueInDays = daysDiff(next.dueDate, todayISO());
      else next.dueInDays = "";
    }

    // 回寫
    const idx = db.findIndex(x=>(Number(x.id)||0)===id);
    if(idx>=0) db[idx] = next;
  }
}

function handleDelete(id){
  if(!TasunAuth.isAdmin()){
    toast("只有 admin 可以刪除");
    return;
  }
  const rid = Number(id)||0;
  const ok = confirm(`確定刪除項次 ${rid} ？`);
  if(!ok) return;
  db = db.filter(r=>(Number(r.id)||0)!==rid);
  saveDB();
  toast("已刪除");
  render();
}

function setupMoreMenu(backHref){
  const backBtn=$("mBack");
  const moreBtn=$("mMoreBtn");
  const menu=$("mMoreMenu");
  if(!backBtn || !moreBtn || !menu) return;

  const close=()=>menu.classList.remove("open");
  const toggle=(e)=>{
    e.preventDefault();
    e.stopPropagation();
    menu.classList.toggle("open");
  };

  backBtn.onclick=()=>location.href=backHref;
  moreBtn.addEventListener("click", toggle);

  menu.addEventListener("click",(e)=>{
    e.stopPropagation();
    const item=e.target.closest("button.menuItem[data-href]");
    if(!item) return;
    const href=item.getAttribute("data-href");
    if(href) location.href=href;
  });

  document.addEventListener("click", close);
  window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") close(); });
}

function syncUserUI(){
  const u = TasunAuth.current();
  $("uName").textContent = u?.username || "—";
  $("uRole").textContent = TasunAuth.role();
}

function start(){
  if(!TasunAuth.ensureLoggedIn()) return;
  syncUserUI();

  $("todayTag").textContent = todayISO();

  $("navBackDB").onclick = ()=>location.href="捷運汐止東湖線統包工程-資料庫.html";
  $("navToReg").onclick = ()=>location.href="捷運汐東線審查文件管制登錄表-水環組.html";
  $("navToQry").onclick = ()=>location.href="捷運汐東線審查文件管制查詢表-水環組.html";
  $("navBackXidong").onclick = ()=>location.href="汐東工程管理表.html";
  $("navHome").onclick = ()=>location.href="index.html";

  setupMoreMenu("捷運汐止東湖線統包工程-資料庫.html");

  $("btnReLogin").onclick = ()=> TasunAuth.open("請重新登入或切換帳號");

  // 每次開啟：自動更新一次（到期日距今）
  recalcAllAndPersist();

  loadDB();
  db = db.map(normalizeRow);

  render();

  $("btnRefresh").onclick = ()=>{
    recalcAllAndPersist();
    loadDB(); db = db.map(normalizeRow);
    render();
    toast("已重算到期日距今");
  };

  $("btnSaveAll").onclick = ()=>{
    TasunAuth.validateSession();
    if(!TasunAuth.canWrite()){
      toast("read 權限不可儲存");
      return;
    }
    collectFromUI();
    db = db.map(normalizeRow);
    saveDB();
    render();
    toast("已儲存");
  };

  // 刪除（admin）
  $("tbody").addEventListener("click",(e)=>{
    const btn = e.target.closest("button[data-act='del'][data-id]");
    if(!btn) return;
    handleDelete(btn.getAttribute("data-id"));
  });

  // 任何欄位變動：即時計算到期日/距今（不直接存檔，等按儲存）
  $("tbody").addEventListener("change",(e)=>{
    const el = e.target.closest("input[data-k], select[data-k]");
    if(!el) return;
    if(!TasunAuth.canWrite()) return;
    // 做一次即時 UI 內重算（用 collectFromUI 會把所有列都抓，成本可接受）
    collectFromUI();
    render();
  });

  // 監聽 storage：跨頁更新即時刷新
  window.addEventListener("storage",(e)=>{
    if(e.key === DB_KEY){
      loadDB(); db = db.map(normalizeRow);
      render();
    }
  });
}

TasunAuth.init({
  onAuthed: ()=>{ toast("登入成功"); start(); },
  onSessionChange: ()=>{ syncUserUI(); },
  onForceRelogin: (msg)=>{ toast(msg || "請重新登入"); syncUserUI(); }
});

start();
  </script>
</body>
</html>
