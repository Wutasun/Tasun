<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>汐東工程管理表 · Tasun</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#070809;
      --bg1:#050302;
      --gold:#f6d37a;
      --gold2:rgba(246,211,122,.55);
      --border:rgba(246,211,122,.28);
      --border2:rgba(246,211,122,.40);
      --text:#ececec;

      /* ✅ 左右留白再縮小（舞台更貼近左右箭頭） */
      --outer-side: clamp(8px, 1.0vw, 18px);

      /* ✅ 舞台更寬、更高（對應左右/上方箭頭） */
      --stage-w: min(1780px, calc(100vw - (2 * var(--outer-side))));
      --stage-pad: clamp(22px, 2.6vw, 48px);
      --stage-min-h: clamp(680px, 84vh, 960px);

      /* ✅ 舞台往上靠（減少上方黑區） */
      --app-top-pad: clamp(66px, 7.2vh, 96px);

      /* ✅ 頁面標題（不放舞台內） */
      --page-title-size: clamp(2.05rem, 3.6vw, 3.55rem);
      --page-title-top: clamp(54px, 6.6vh, 86px); /* 位於上方黑區中間偏下 */

      /* ✅ 按鍵：自適應更穩（桌機/筆電/大螢幕都能放大） */
      --btn-w: min(760px, 92vw);
      --btn-h: clamp(84px, 9.8vh, 136px);
      --btn-font: clamp(1.02rem, 1.1vw, 1.22rem);
    }

    *{ box-sizing:border-box; margin:0; padding:0; }

    body{
      min-height:100vh;
      font-family:"Noto Serif TC","標楷體","Microsoft JhengHei",serif;
      background:
        radial-gradient(circle at 50% 16%, rgba(246,211,122,0.12), rgba(0,0,0,0.92) 52%, rgba(0,0,0,0.985) 100%),
        radial-gradient(circle at 50% 86%, rgba(246,211,122,0.06), rgba(0,0,0,0.00) 58%),
        linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.72));
      color: var(--gold);
      overflow-x:hidden;
    }

    /* ====== Gate overlay（沿用「此頁不提供登入」）====== */
    body.locked{ overflow:hidden; }
    body.locked .app{ visibility:hidden; }

    .login-overlay{
      position:fixed; inset:0;
      background: radial-gradient(circle at 50% 18%, rgba(255,228,170,0.35), rgba(0,0,0,0.98));
      display:flex; align-items:center; justify-content:center;
      z-index:999;
    }
    .login-box{
      width:min(420px,92vw);
      padding:2.3rem 2.4rem 2.1rem;
      border-radius:18px;
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,0.28), rgba(0,0,0,0.94));
      border:1px solid rgba(246,211,122,0.35);
      box-shadow:0 0 24px rgba(0,0,0,0.9), 0 0 32px rgba(246,211,122,0.25);
      color:rgba(246,211,122,0.78);
      text-align:center;
    }
    .login-title{
      font-size:1.35rem;
      letter-spacing:.18em;
      text-indent:.18em;
      margin-bottom:.75rem;
      text-shadow:0 0 8px rgba(246,211,122,0.8), 0 0 18px rgba(246,211,122,0.5);
    }
    .login-sub{
      font-size:.92rem;
      letter-spacing:.12em;
      text-indent:.12em;
      color: rgba(246,211,122,0.70);
      min-height:1.1rem;
    }

    /* ====== Top bar ====== */
    .topbar{
      position: fixed;
      top: .75rem;
      left: .85rem;
      right: .85rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.8rem;
      z-index:60;
      pointer-events:none;
    }
    .topbar .left,
    .topbar .right{
      display:flex;
      align-items:center;
      gap:.6rem;
      pointer-events:auto;
    }

    .btn-back{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:.28rem 1.05rem;
      border-radius:999px;
      border:1px solid rgba(246,211,122,0.62);
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,0.18), rgba(0,0,0,0.88));
      color: var(--gold);
      text-decoration:none;
      font-size:.82rem;
      letter-spacing:.12em;
      text-indent:.12em;
      box-shadow:0 10px 18px rgba(0,0,0,0.85), 0 0 14px rgba(246,211,122,0.18);
      transition: transform .15s ease-out, box-shadow .2s ease-out, border-color .2s ease-out;
      white-space:nowrap;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .btn-back:hover{
      transform: translateY(-1px);
      border-color: rgba(255,238,190,0.95);
      box-shadow:0 12px 22px rgba(0,0,0,0.92), 0 0 18px rgba(246,211,122,0.28);
    }

    .user-pill{
      padding:.30rem 1.05rem;
      border-radius:999px;
      border:1px solid rgba(246,211,122,0.55);
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,0.16), rgba(0,0,0,0.90));
      font-size:.82rem;
      letter-spacing:.10em;
      text-indent:.10em;
      opacity:.92;
      box-shadow:0 8px 16px rgba(0,0,0,0.82), 0 0 12px rgba(246,211,122,0.16);
      white-space:nowrap;
    }
    .btn-switch{
      padding:.26rem 1.00rem;
      border-radius:999px;
      border:1px solid rgba(246,211,122,0.62);
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,0.22), rgba(0,0,0,0.92));
      color:var(--gold);
      font-size:.80rem;
      letter-spacing:.10em;
      text-indent:.10em;
      cursor:pointer;
      opacity:.88;
      box-shadow:0 8px 16px rgba(0,0,0,0.85), 0 0 12px rgba(246,211,122,0.18);
      transition:transform .15s ease-out, box-shadow .2s ease-out, background .2s ease-out, opacity .2s ease-out;
      white-space:nowrap;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .btn-switch:hover{
      transform:translateY(-1px);
      opacity:.98;
      background: radial-gradient(circle at 0% 0%, rgba(255,244,208,0.28), rgba(0,0,0,0.93));
      box-shadow:0 12px 22px rgba(0,0,0,0.92), 0 0 16px rgba(246,211,122,0.26);
    }

    /* ✅ 頁面標題：不放舞台內，放在上方黑區（如紅圈位置） */
    .page-title{
      position: fixed;
      top: var(--page-title-top);
      left: 50%;
      transform: translateX(-50%);
      width: calc(100vw - (2 * var(--outer-side)));
      max-width: var(--stage-w);
      text-align:center;

      font-family:"DFKai-SB","標楷體","BiauKai","KaiTi","STKaiti","Kaiti TC","Noto Serif TC",serif;
      font-weight:700;
      font-size: var(--page-title-size);
      letter-spacing:.34em;
      text-indent:.34em;
      white-space:nowrap;

      color: var(--gold);
      text-shadow:
        0 1px 0 rgba(0,0,0,0.70),
        0 2px 0 rgba(0,0,0,0.60),
        0 12px 26px rgba(0,0,0,0.90),
        0 0 18px rgba(246,211,122,0.92),
        0 0 44px rgba(246,211,122,0.55);

      z-index:55;            /* 低於 topbar(60)，高於舞台 */
      pointer-events:none;   /* 不遮擋點擊 */
      padding: 0 12px;
    }

    /* ====== App & Stage ====== */
    .app{
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;

      /* ✅ 讓舞台留出上方空間給 page-title */
      padding: calc(var(--app-top-pad) + 4.0rem) var(--outer-side) 2.2rem;
    }

    /* ✅ 舞台：玻璃液化感＋與黑底融合 */
    .stage{
      width: var(--stage-w);
      min-height: var(--stage-min-h);
      border-radius: 32px;
      padding: var(--stage-pad);
      position:relative;
      overflow:hidden;

      /* ✅ 更透明、更像玻璃水波（底色融合黑背景） */
      background:
        radial-gradient(120% 90% at 50% 6%,  rgba(246,211,122,0.18), rgba(0,0,0,0.00) 56%),
        radial-gradient(80%  70% at 18% 22%, rgba(255,255,255,0.11), rgba(0,0,0,0.00) 62%),
        radial-gradient(80%  70% at 82% 26%, rgba(255,244,210,0.10), rgba(0,0,0,0.00) 64%),
        radial-gradient(120% 120% at 50% 96%, rgba(246,211,122,0.10), rgba(0,0,0,0.00) 62%),
        linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.03) 35%, rgba(0,0,0,0.22)),
        rgba(0,0,0,0.16);

      border: 1px solid rgba(246,211,122,0.16);
      box-shadow:
        0 42px 130px rgba(0,0,0,0.66),
        0 0 84px rgba(246,211,122,0.10),
        inset 0 0 0 1px rgba(255,255,255,0.05),
        inset 0 18px 40px rgba(255,255,255,0.04);

      backdrop-filter: blur(20px) saturate(1.18);
      -webkit-backdrop-filter: blur(20px) saturate(1.18);

      display:flex;
      flex-direction:column;
    }

    /* ✅ 液化光澤（慢速漂移） */
    .stage::before{
      content:"";
      position:absolute; inset:-45%;
      background:
        radial-gradient(ellipse at 22% 30%, rgba(255,255,255,0.16), rgba(0,0,0,0.00) 58%),
        radial-gradient(ellipse at 82% 36%, rgba(255,248,220,0.14), rgba(0,0,0,0.00) 62%),
        conic-gradient(from 200deg at 50% 50%,
          rgba(255,255,255,0.00) 0deg,
          rgba(255,255,255,0.07) 70deg,
          rgba(246,211,122,0.07) 150deg,
          rgba(255,255,255,0.00) 235deg,
          rgba(255,255,255,0.06) 310deg,
          rgba(255,255,255,0.00) 360deg);
      filter: blur(26px);
      opacity:.62;
      mix-blend-mode: screen;
      pointer-events:none;
      animation: liquidDrift 18s ease-in-out infinite;
    }

    /* ✅ 邊緣暗角柔化（與黑底融合一體） */
    .stage::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 50% 36%, rgba(0,0,0,0.00), rgba(0,0,0,0.26) 72%, rgba(0,0,0,0.55) 100%),
        linear-gradient(180deg, rgba(0,0,0,0.06), rgba(0,0,0,0.22));
      pointer-events:none;
      mix-blend-mode: multiply;
      opacity:.84;
    }

    @keyframes liquidDrift{
      0%{ transform: translate(-1.2%, -0.8%) rotate(-0.25deg); }
      50%{ transform: translate(1.2%, 0.8%) rotate(0.25deg); }
      100%{ transform: translate(-1.2%, -0.8%) rotate(-0.25deg); }
    }
    @media (prefers-reduced-motion: reduce){
      .stage::before{ animation:none; }
    }

    /* ✅ 按鍵區：依舞台高度自動置中 */
    .btn-grid{
      position:relative;
      z-index:2;
      flex: 1;

      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;

      gap: clamp(16px, 2.3vh, 28px);
      padding: clamp(10px, 2.0vh, 28px) 0 clamp(26px, 5.0vh, 78px);
    }

    .pill-btn{
      width: var(--btn-w);
      height: var(--btn-h);
      border-radius:999px;
      border:1px solid rgba(246,211,122,0.92);
      background:
        radial-gradient(120% 140% at 20% 15%, rgba(255,255,255,0.22), rgba(255,255,255,0.06) 45%, rgba(0,0,0,0.18) 100%),
        radial-gradient(circle at 0% 0%, rgba(246,211,122,0.20), rgba(0,0,0,0.74));
      color: var(--gold);
      text-decoration:none;
      cursor:pointer;

      box-shadow:
        0 22px 46px rgba(0,0,0,0.65),
        0 10px 18px rgba(0,0,0,0.48),
        0 0 28px rgba(246,211,122,0.18),
        inset 0 0 0 1px rgba(255,255,255,0.08),
        inset 0 18px 30px rgba(255,255,255,0.06);

      display:flex;
      align-items:center;
      justify-content:center;

      padding: 0 1.2rem;
      backdrop-filter: blur(16px) saturate(1.12);
      -webkit-backdrop-filter: blur(16px) saturate(1.12);

      transition: transform .18s ease-out, box-shadow .22s ease-out, border-color .2s ease-out, filter .2s ease-out;
      transform: translateZ(0);
      overflow:hidden;

      letter-spacing: .18em;
      text-indent: .18em;
      font-size: var(--btn-font);

      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      position:relative;
      max-width: 820px;
    }

    .pill-btn::before{
      content:"";
      position:absolute; inset:-40%;
      background:
        radial-gradient(ellipse at 28% 28%, rgba(255,255,255,0.22), rgba(255,255,255,0.00) 55%),
        radial-gradient(ellipse at 70% 62%, rgba(246,211,122,0.12), rgba(0,0,0,0.00) 60%),
        conic-gradient(from 110deg at 50% 50%,
          rgba(255,255,255,0.00) 0deg,
          rgba(255,255,255,0.08) 70deg,
          rgba(246,211,122,0.06) 145deg,
          rgba(255,255,255,0.00) 230deg,
          rgba(255,255,255,0.06) 305deg,
          rgba(255,255,255,0.00) 360deg);
      opacity:.36;
      filter: blur(16px);
      mix-blend-mode: screen;
      pointer-events:none;
      animation: btnSheen 22s ease-in-out infinite;
    }
    @keyframes btnSheen{
      0%{ transform: translate(-2%, -1%) rotate(-0.3deg); }
      50%{ transform: translate(2%, 1%) rotate(0.3deg); }
      100%{ transform: translate(-2%, -1%) rotate(-0.3deg); }
    }
    @media (prefers-reduced-motion: reduce){
      .pill-btn::before{ animation:none; }
    }

    .pill-btn:hover{
      transform: translateY(-3px) translateZ(0);
      border-color: rgba(255,235,180,0.98);
      box-shadow:
        0 28px 56px rgba(0,0,0,0.72),
        0 12px 22px rgba(0,0,0,0.52),
        0 0 40px rgba(246,211,122,0.28),
        inset 0 0 0 1px rgba(255,255,255,0.10),
        inset 0 18px 30px rgba(255,255,255,0.08);
      filter: brightness(1.02);
    }

    /* ✅ 超大螢幕 */
    @media (min-width: 1400px){
      :root{
        --stage-w: min(1960px, calc(100vw - (2 * var(--outer-side))));
        --btn-w: min(860px, 60vw);
        --btn-h: clamp(92px, 10.5vh, 150px);
        --btn-font: clamp(1.06rem, 0.95vw, 1.26rem);
      }
    }

    /* Mobile */
    @media (max-width: 900px){
      :root{
        --outer-side: 12px;
        --app-top-pad: 74px;
        --stage-w: calc(100vw - (2 * var(--outer-side)));
        --stage-min-h: clamp(560px, 82vh, 820px);
        --btn-w: 100%;
        --btn-h: clamp(78px, 9.6vh, 120px);
        --btn-font: clamp(0.98rem, 4.0vw, 1.12rem);

        /* ✅ 手機：標題位置稍低，避免壓到 topbar */
        --page-title-top: 78px;
      }
      .topbar{
        left:.6rem; right:.6rem;
        gap:.5rem;
        flex-wrap:wrap;
        justify-content:flex-start;
      }
      .topbar .right{ margin-left:auto; }
      .stage{ border-radius:22px; }
      .btn-grid{
        gap: .85rem;
        padding: .6rem 0 2.0rem;
      }
      .user-pill{ display:none; }
    }

    /* ✅ 極小手機 */
    @media (max-width: 420px){
      :root{
        --stage-pad: 18px;
        --stage-min-h: 560px;
        --btn-h: 74px;
      }
      .page-title{ white-space:normal; }
    }
  </style>
</head>

<body class="locked">
  <!-- ✅ 驗證登入遮罩（此頁不提供登入，首頁控制登入） -->
  <div class="login-overlay" id="gateOverlay">
    <div class="login-box">
      <div class="login-title">汐東工程管理表</div>
      <div class="login-sub" id="gateSub">驗證登入中…</div>
    </div>
  </div>

  <!-- ✅ 不放舞台內：主標題放在上方黑區（如紅圈） -->
  <div class="page-title" aria-hidden="true">汐東工程管理表</div>

  <div class="app">
    <!-- Topbar：保留「返回首頁」 -->
    <div class="topbar">
      <div class="left">
        <a class="btn-back" href="index.html">返回首頁</a>
      </div>
      <div class="right">
        <div class="user-pill" id="userInfo">目前使用者：未登入</div>
        <button class="btn-switch" id="btnSwitchUser" type="button">切換帳號</button>
      </div>
    </div>

    <main class="stage" aria-label="汐東工程管理表">
      <!-- ✅ 已移除舞台內的 title -->

      <!-- ✅ 只保留 3 個按鍵 -->
      <section class="btn-grid">
        <a class="pill-btn" id="btnData" href="捷運汐止東湖線統包工程-資料庫.html">資料管理表</a>
        <a class="pill-btn" id="btnCloud" href="https://www.dropbox.com/" target="_blank" rel="noopener noreferrer">雲端檔案</a>
        <a class="pill-btn" id="btnDb" href="資料庫.html">資料庫</a>
      </section>
    </main>
  </div>

  <script>
    // ✅ 此頁只做「讀取 CURRENT_KEY 自動登入」：首頁控制登入
    const CURRENT_KEY = "tasunCurrentUser_v1";
    const SESSION_KEY = "tasunSessionLogin_v1";
    const NAV_KEY     = "tasunNavButtons_v1"; // index.html 的主按鍵設定

    const gateOverlay = document.getElementById("gateOverlay");
    const gateSub = document.getElementById("gateSub");
    const userInfo = document.getElementById("userInfo");
    const btnSwitch = document.getElementById("btnSwitchUser");
    const btnCloud  = document.getElementById("btnCloud");

    function safeParse(s){
      try{ return JSON.parse(s); }catch(e){ return null; }
    }

    function getCurrentUser(){
      const obj = safeParse(localStorage.getItem(CURRENT_KEY) || "null");
      if(!obj || typeof obj !== "object") return null;

      const user = String(obj.user || obj.username || "").trim();
      const role = String(obj.role || obj.level || "read").trim().toLowerCase();
      if(!user) return null;

      return { user, role: role || "read" };
    }

    function setSession(cur){
      try{
        sessionStorage.setItem(SESSION_KEY, JSON.stringify({
          user: cur.user,
          role: cur.role,
          t: Date.now()
        }));
      }catch(e){}
    }

    function unlock(cur){
      document.body.classList.remove("locked");
      if(gateOverlay) gateOverlay.style.display = "none";
      if(userInfo) userInfo.textContent = `目前使用者：${cur.user} (${cur.role})`;
    }

    function backToIndex(){
      location.replace("index.html");
    }

    // ✅ 讀取 index.html 的「雲端檔案」按鍵連結（優先第3顆/或 label 含「雲端檔案」）
    function resolveCloudHrefFromIndex(){
      const fallback = { href: "https://www.dropbox.com/", target: "_blank" };

      const nav = safeParse(localStorage.getItem(NAV_KEY) || "null");
      if(!Array.isArray(nav) || !nav.length) return fallback;

      // 1) 先抓第 3 顆（index 的預設 btn3 就是雲端檔案）
      const third = nav[2];
      if(third && typeof third === "object"){
        const label = String(third.label || "").trim();
        const href  = String(third.href  || "").trim();
        const target= String(third.target|| "").trim();
        if(label.includes("雲端檔案") && href) return { href, target: target || "_blank" };
        if(href && /^https?:\/\//i.test(href)) return { href, target: target || "_blank" };
      }

      // 2) 再掃描 label
      const found = nav.find(it => it && typeof it === "object" && String(it.label || "").includes("雲端檔案") && String(it.href || "").trim());
      if(found){
        return {
          href: String(found.href || "").trim(),
          target: String(found.target || "").trim() || "_blank"
        };
      }

      return fallback;
    }

    function applyCloudLink(){
      if(!btnCloud) return;
      const c = resolveCloudHrefFromIndex();
      btnCloud.setAttribute("href", c.href || "https://www.dropbox.com/");
      if((c.target || "_blank") === "_blank"){
        btnCloud.setAttribute("target", "_blank");
        btnCloud.setAttribute("rel", "noopener noreferrer");
      }else{
        btnCloud.removeAttribute("target");
        btnCloud.removeAttribute("rel");
      }
    }

    function runGate(){
      applyCloudLink();

      const cur = getCurrentUser();
      if(cur){
        if(gateSub) gateSub.textContent = `已登入：${cur.user}（${cur.role}）`;
        setSession(cur);
        unlock(cur);
        return;
      }
      if(gateSub) gateSub.textContent = "尚未登入，返回首頁…";
      backToIndex();
    }

    document.addEventListener("DOMContentLoaded", runGate);

    window.addEventListener("storage", (e) => {
      if(e.key === CURRENT_KEY){
        const cur = getCurrentUser();
        if(!cur) backToIndex();
        else{
          setSession(cur);
          unlock(cur);
        }
      }
      if(e.key === NAV_KEY){
        applyCloudLink();
      }
    });

    if(btnSwitch){
      btnSwitch.addEventListener("click", () => {
        try{ sessionStorage.removeItem(SESSION_KEY); }catch(e){}
        try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}
        backToIndex();
      });
    }
  </script>
</body>
</html>
