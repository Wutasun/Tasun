<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>汐東工程管理表 · Tasun</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --gold:#f6d37a;

      --outer-side: clamp(18px, 2.2vw, 64px);

      /* frame */
      --frame-inset: clamp(0.55rem, 1.0vw, 1.1rem);
      --frame-radius: clamp(22px, 2vw, 34px);
      --stage-top: clamp(4.0rem, 7vh, 5.4rem);
      --glass-inset: clamp(8px, 0.9vw, 14px);

      /* 按鍵尺寸（維持你現有風格） */
      --btn-w: clamp(300px, 26vw, 520px);
      --btn-h: clamp(92px, 11vh, 148px);
      --btn-font-max: clamp(1.02rem, 1.10vw, 1.24rem);
      --btn-font-min: 0.86rem;

      /* 「空無明」位置 */
      --title-top: calc(var(--stage-top) + clamp(58px, 9.2vh, 96px));
      --title-h: clamp(150px, 18vh, 220px);

      /* 主視覺融入 */
      --zen-opacity: .72;
      --zen-scale: 1.14;
      --zen-contrast: 1.06;
      --zen-bright: 1.07;

      /* 玻璃液化（舞台） */
      --liquid-op: .30;
      --liquid-blur: 18px;
      --liquid-speed: 16s;
      --liquid-shift: 4%;

      /* 左右水波紋玻璃（更透明、不搶戲） */
      --sideglass-w: clamp(70px, 6.2vw, 150px);
      --sideglass-op: .30;
      --ripple-op: .16;
      --ripple-speed: 20s;
    }

    *{ box-sizing:border-box; margin:0; padding:0; }

    body{
      min-height:100vh;
      font-family:"Noto Serif TC","標楷體","Microsoft JhengHei",serif;
      background:#050302;
      color:var(--gold);
      overflow-x:hidden;
    }
    body.locked{ overflow:hidden; }
    body.locked main.hero{ visibility:hidden; }
    body:not(.locked) main.hero{ visibility:visible; }

    /* ========================== Gate Overlay（取代登入） ========================== */
    .login-overlay{
      position:fixed; inset:0;
      background: radial-gradient(circle at 50% 18%, rgba(255,228,170,0.35), rgba(0,0,0,0.98));
      display:flex; align-items:center; justify-content:center;
      z-index:999;
    }
    .login-box{
      width:min(420px,92vw);
      padding:2.3rem 2.4rem 2.1rem;
      border-radius:18px;
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,0.28), rgba(0,0,0,0.94));
      border:1px solid rgba(246,211,122,0.35);
      box-shadow:0 0 24px rgba(0,0,0,0.9), 0 0 32px rgba(246,211,122,0.25);
      color:rgba(246,211,122,0.78);
      text-align:center;
    }
    .login-title{
      font-size:1.35rem;
      letter-spacing:.18em;
      text-indent:.18em;
      margin-bottom:.75rem;
      text-shadow:0 0 8px rgba(246,211,122,0.8), 0 0 18px rgba(246,211,122,0.5);
    }
    .login-sub{
      font-size:.92rem;
      letter-spacing:.12em;
      text-indent:.12em;
      color: rgba(246,211,122,0.70);
      min-height:1.1rem;
    }

    /* ========================== Hero ========================== */
    .hero{
      position:relative;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      color:var(--gold);
    }
    .hero::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 50% 12%,
          rgba(255,237,180,0.92) 0,
          rgba(255,237,180,0.42) 18%,
          rgba(255,237,180,0.10) 40%,
          rgba(255,237,180,0.00) 60%),
        linear-gradient(to bottom,
          rgba(0,0,0,0.86) 0%,
          rgba(0,0,0,0.62) 30%,
          rgba(0,0,0,0.46) 56%,
          rgba(0,0,0,0.58) 100%);
      z-index:-6;
    }
    .hero::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 50% 60%, rgba(246,211,122,0.10) 0, rgba(0,0,0,0.00) 55%),
        radial-gradient(circle at 50% 64%, rgba(0,0,0,0.00) 0, rgba(0,0,0,0.22) 60%, rgba(0,0,0,0.60) 100%);
      z-index:-5;
      pointer-events:none;
    }

    .hero-inner{
      position:relative;
      width: calc(100vw - (2 * var(--outer-side)));
      height:100vh;
      margin:0 var(--outer-side);
      padding: clamp(1.0rem, 1.6vw, 1.6rem);
      isolation:isolate;
    }

    .hero-inner::before{
      content:"";
      position:absolute;
      inset:var(--frame-inset);
      border-radius:var(--frame-radius);
      background:
        radial-gradient(circle at 50% 46%, rgba(255,244,210,0.12), rgba(0,0,0,0.00) 62%),
        radial-gradient(circle at 18% 55%, rgba(246,211,122,0.06), rgba(0,0,0,0.00) 60%),
        radial-gradient(circle at 82% 55%, rgba(246,211,122,0.06), rgba(0,0,0,0.00) 60%),
        linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.22));
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      opacity: .96;
      z-index:-6;
      pointer-events:none;
    }
    .hero-inner::after{
      content:"";
      position:absolute;
      inset:var(--frame-inset);
      border-radius:var(--frame-radius);
      background:
        radial-gradient(circle at 50% 18%, rgba(255,244,210,0.06), rgba(255,244,210,0.00) 58%),
        linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.015));
      border:1px solid rgba(246,211,122,0.14);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,0.05),
        0 0 28px rgba(0,0,0,0.55),
        0 0 26px rgba(246,211,122,0.10);
      z-index:-5;
      pointer-events:none;
    }

    .ripple-film{
      position:absolute;
      inset:var(--frame-inset);
      border-radius:var(--frame-radius);
      pointer-events:none;
      z-index:-4;
      opacity: var(--ripple-op);
      mix-blend-mode: screen;
      background:
        repeating-radial-gradient(circle at 30% 40%,
          rgba(255,255,255,0.20) 0 1px,
          rgba(255,255,255,0.00) 6px 18px),
        repeating-radial-gradient(circle at 72% 58%,
          rgba(246,211,122,0.14) 0 1px,
          rgba(0,0,0,0.00) 7px 22px);
      filter: blur(.25px);
      mask-image: radial-gradient(circle at 50% 55%, rgba(0,0,0,1) 0 62%, rgba(0,0,0,0) 90%);
      -webkit-mask-image: radial-gradient(circle at 50% 55%, rgba(0,0,0,1) 0 62%, rgba(0,0,0,0) 90%);
      animation: rippleMove var(--ripple-speed) ease-in-out infinite;
    }
    @keyframes rippleMove{
      0%{ background-position: 0% 0%, 0% 0%; transform: translateY(0px); }
      50%{ background-position: 14% 8%, -10% 12%; transform: translateY(-1px); }
      100%{ background-position: 0% 0%, 0% 0%; transform: translateY(0px); }
    }
    @media (prefers-reduced-motion: reduce){
      .ripple-film{ animation:none; }
    }

    .side-glass{
      position:absolute;
      top: var(--stage-top);
      bottom: calc(var(--frame-inset) + var(--glass-inset));
      width: var(--sideglass-w);
      pointer-events:none;
      border-radius: calc(var(--frame-radius) - 12px);
      z-index:-4;
      opacity: var(--sideglass-op);
      background:
        radial-gradient(140% 120% at 20% 20%, rgba(255,255,255,0.14), rgba(255,255,255,0.02) 48%, rgba(0,0,0,0.10) 100%),
        radial-gradient(circle at 50% 45%, rgba(246,211,122,0.10), rgba(0,0,0,0.00) 62%),
        linear-gradient(180deg, rgba(255,255,255,0.05), rgba(0,0,0,0.10));
      backdrop-filter: blur(18px) saturate(1.10);
      -webkit-backdrop-filter: blur(18px) saturate(1.10);
      box-shadow:
        0 18px 60px rgba(0,0,0,0.30),
        0 0 22px rgba(246,211,122,0.10),
        inset 0 0 0 1px rgba(255,255,255,0.04),
        inset 0 18px 32px rgba(255,255,255,0.04);
      overflow:hidden;
    }
    .side-glass::before{
      content:"";
      position:absolute; inset:-28%;
      opacity:.55;
      mix-blend-mode: screen;
      background:
        repeating-radial-gradient(circle at 40% 35%,
          rgba(255,255,255,0.18) 0 1px,
          rgba(255,255,255,0.00) 6px 18px),
        conic-gradient(from 120deg at 50% 50%,
          rgba(255,255,255,0.00) 0deg,
          rgba(255,255,255,0.06) 70deg,
          rgba(246,211,122,0.06) 145deg,
          rgba(255,255,255,0.00) 230deg,
          rgba(255,255,255,0.05) 305deg,
          rgba(255,255,255,0.00) 360deg);
      filter: blur(16px);
      animation: sideRipple 18s ease-in-out infinite;
    }
    @keyframes sideRipple{
      0%{ transform: translate(-2%, -1%) rotate(-0.2deg) scale(1.02); }
      50%{ transform: translate(2%, 1%) rotate(0.2deg) scale(1.03); }
      100%{ transform: translate(-2%, -1%) rotate(-0.2deg) scale(1.02); }
    }
    @media (prefers-reduced-motion: reduce){
      .side-glass::before{ animation:none; opacity:.40; }
    }
    .side-glass-left{ left: calc(var(--frame-inset) + var(--glass-inset)); }
    .side-glass-right{ right: calc(var(--frame-inset) + var(--glass-inset)); }

    .lotus-stage{
      position:absolute;
      top:var(--stage-top);
      bottom: calc(var(--frame-inset) + var(--glass-inset));
      left:  calc(var(--frame-inset) + var(--glass-inset));
      right: calc(var(--frame-inset) + var(--glass-inset));
      border-radius: calc(var(--frame-radius) - 2px);
      overflow:hidden;
      pointer-events:none;
      z-index:-3;

      background:
        radial-gradient(circle at 50% 22%, rgba(255,244,210,0.20), rgba(0,0,0,0.00) 52%),
        radial-gradient(circle at 50% 68%, rgba(246,211,122,0.14), rgba(0,0,0,0.00) 60%),
        linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,0.20));
      border:none;

      box-shadow:
        0 30px 90px rgba(0,0,0,0.55),
        0 0 40px rgba(246,211,122,0.12),
        inset 0 18px 36px rgba(255,255,255,0.04);

      backdrop-filter: blur(18px) saturate(1.10);
      -webkit-backdrop-filter: blur(18px) saturate(1.10);
      transform: translateZ(0);
    }
    .lotus-stage::before{
      content:"";
      position:absolute; inset:-18%;
      z-index:3;
      background:
        radial-gradient(ellipse at 20% 30%, rgba(255,255,255,0.14), rgba(0,0,0,0.00) 52%),
        radial-gradient(ellipse at 80% 36%, rgba(255,248,220,0.12), rgba(0,0,0,0.00) 55%),
        radial-gradient(ellipse at 52% 72%, rgba(246,211,122,0.12), rgba(0,0,0,0.00) 58%),
        conic-gradient(from 200deg at 50% 55%,
          rgba(255,255,255,0.00) 0deg,
          rgba(255,255,255,0.07) 55deg,
          rgba(246,211,122,0.06) 120deg,
          rgba(255,255,255,0.00) 200deg,
          rgba(255,255,255,0.05) 280deg,
          rgba(255,255,255,0.00) 360deg);
      filter: blur(18px);
      opacity: .88;
      mix-blend-mode: screen;
      pointer-events:none;
    }
    .lotus-stage .liquid-flow{
      position:absolute;
      inset:-22%;
      z-index:4;
      pointer-events:none;
      mix-blend-mode: screen;
      opacity: var(--liquid-op);
      filter: blur(var(--liquid-blur));
      transform: translateZ(0);

      background:
        radial-gradient(ellipse at 18% 34%, rgba(255,255,255,0.18), rgba(0,0,0,0.00) 58%),
        radial-gradient(ellipse at 80% 44%, rgba(255,248,220,0.16), rgba(0,0,0,0.00) 60%),
        radial-gradient(ellipse at 52% 72%, rgba(246,211,122,0.16), rgba(0,0,0,0.00) 62%),
        conic-gradient(from 120deg at 50% 55%,
          rgba(255,255,255,0.00) 0deg,
          rgba(255,255,255,0.10) 65deg,
          rgba(246,211,122,0.08) 140deg,
          rgba(255,255,255,0.00) 220deg,
          rgba(255,255,255,0.07) 300deg,
          rgba(255,255,255,0.00) 360deg);

      animation: liquidDrift var(--liquid-speed) ease-in-out infinite;
    }
    @keyframes liquidDrift{
      0%{   transform: translate(calc(-1 * var(--liquid-shift)), calc(-0.6 * var(--liquid-shift))) rotate(-0.35deg) scale(1.02); }
      50%{  transform: translate(var(--liquid-shift), calc(0.9 * var(--liquid-shift))) rotate(0.35deg) scale(1.03); }
      100%{ transform: translate(calc(-1 * var(--liquid-shift)), calc(-0.6 * var(--liquid-shift))) rotate(-0.35deg) scale(1.02); }
    }
    @media (prefers-reduced-motion: reduce){
      .lotus-stage .liquid-flow{ animation:none; opacity:.18; }
    }
    .lotus-stage::after{
      content:"";
      position:absolute; inset:0;
      z-index:5;
      background:
        radial-gradient(ellipse at 50% 55%,
          rgba(0,0,0,0.00) 0%,
          rgba(0,0,0,0.10) 62%,
          rgba(0,0,0,0.26) 100%),
        linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,0.10));
      opacity:.60;
      pointer-events:none;
    }

    .zen-visual{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      opacity: var(--zen-opacity);
      pointer-events:none;
      z-index:2;
    }
    .zen-visual img{
      width: 116%;
      height: 116%;
      object-fit: cover;
      object-position: center;
      transform: scale(var(--zen-scale)) translateZ(0);
      filter:
        saturate(1.03)
        contrast(var(--zen-contrast))
        brightness(var(--zen-bright))
        drop-shadow(0 26px 40px rgba(0,0,0,0.45));
    }

    /* ========================== Top UI ========================== */
    .user-bar{
      position:fixed;
      top:.8rem;
      left:.9rem;
      display:flex;
      align-items:center;
      gap:.75rem;

      /* ✅ 不擋點擊（與首頁一致） */
      pointer-events:none;

      z-index:40;
    }
    .user-pill, .btn-switch{ pointer-events:auto; }

    .user-pill{
      padding:.30rem 1.05rem;
      border-radius:999px;
      border:1px solid rgba(246,211,122,0.55);
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,0.18), rgba(0,0,0,0.88));
      font-size:.82rem;
      letter-spacing:.10em;
      text-indent:.10em;
      opacity:.90;
      box-shadow:0 3px 8px rgba(0,0,0,0.75), 0 0 10px rgba(246,211,122,0.18);
      white-space:nowrap;
    }
    .btn-switch{
      padding:.26rem 1.00rem;
      border-radius:999px;
      border:1px solid rgba(246,211,122,0.62);
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,0.22), rgba(0,0,0,0.92));
      color:var(--gold);
      font-size:.80rem;
      letter-spacing:.10em;
      text-indent:.10em;
      cursor:pointer;
      opacity:.86;
      box-shadow:0 4px 9px rgba(0,0,0,0.82), 0 0 10px rgba(246,211,122,0.20);
      transition:transform .15s ease-out, box-shadow .2s ease-out, background .2s ease-out, opacity .2s ease-out;
    }
    .btn-switch:hover{
      transform:translateY(-1px);
      opacity:.96;
      background: radial-gradient(circle at 0% 0%, rgba(255,244,208,0.30), rgba(0,0,0,0.93));
      box-shadow:0 7px 14px rgba(0,0,0,0.90), 0 0 14px rgba(246,211,122,0.30);
    }

    .site-title-wrapper{
      position:fixed;
      top:.18rem;
      left:50%;
      transform:translateX(-50%);
      text-align:center;
      letter-spacing:.38em;
      text-indent:.38em;
      z-index:39;
      pointer-events:none;
    }
    .site-title{
      font-family:"DFKai-SB","標楷體","BiauKai","KaiTi","STKaiti","Kaiti TC","Noto Serif TC",serif;
      font-size: clamp(2.2rem, 4.1vw, 3.6rem);
      font-weight:700;
      -webkit-text-stroke:.8px rgba(255,244,208,0.42);
      text-shadow:
        0 1px 0 rgba(0,0,0,0.65),
        0 2px 0 rgba(0,0,0,0.55),
        0 10px 22px rgba(0,0,0,0.88),
        0 0 18px rgba(246,211,122,0.92),
        0 0 40px rgba(246,211,122,0.65);
      filter: drop-shadow(0 10px 18px rgba(0,0,0,0.85));
      white-space:nowrap;
    }

    /* ========================== 黃水晶字（保留） ========================== */
    .zen-text{
      position:absolute;
      white-space:nowrap;
      pointer-events:none;
      z-index:10;
      font-family:"DFKai-SB","標楷體","BiauKai","KaiTi","STKaiti","Kaiti TC","Noto Serif TC",serif;
      font-weight:700;
    }
    .zen-text span{
      display:inline-block;
      color: transparent;
      background:
        linear-gradient(180deg,
          rgba(255,255,255,0.95) 0%,
          rgba(255,248,220,0.90) 16%,
          rgba(255,228,160,0.96) 34%,
          rgba(246,211,122,1.00) 54%,
          rgba(214,142,48,0.96) 78%,
          rgba(255,238,190,0.92) 100%);
      -webkit-background-clip:text;
      background-clip:text;
      -webkit-text-stroke: 1px rgba(255,220,140,0.38);
      text-shadow:
        0 1px 0 rgba(255,255,255,0.18),
        0 3px 0 rgba(0,0,0,0.18),
        0 10px 22px rgba(0,0,0,0.66),
        0 0 16px rgba(255,248,220,0.70),
        0 0 34px rgba(246,211,122,0.70),
        0 0 78px rgba(246,211,122,0.26);
      filter:
        drop-shadow(0 14px 14px rgba(0,0,0,0.34))
        drop-shadow(0 0 18px rgba(246,211,122,0.40));
      opacity:.98;
    }

    .hero-title{
      left: 0; right: 0;
      top: var(--title-top);
      height: var(--title-h);
      width:auto;
      transform:none;
      pointer-events:none;
      mix-blend-mode: screen;
      z-index:11;
    }
    .hero-title span{
      position:absolute;
      font-size: clamp(2.7rem, 4.6vw, 4.1rem);
      line-height:1;
      letter-spacing:.06em;
      text-indent:.06em;
    }
    .hero-title span:nth-child(1){
      left: 30%;
      top: 28%;
      transform: translate(-50%,-50%) rotate(-12deg) scale(1.02);
    }
    .hero-title span:nth-child(2){
      left: 50%;
      top: 18%;
      transform: translate(-50%,-50%) rotate(0deg) scale(1.02);
    }
    .hero-title span:nth-child(3){
      left: 70%;
      top: 28%;
      transform: translate(-50%,-50%) rotate(12deg) scale(1.02);
    }

    .hero-left, .hero-right{
      top: 58%;
      transform: translateY(-50%);
      display:flex;
      flex-direction:column;
      align-items:center;
      font-size: clamp(1.9rem, 2.7vw, 2.6rem);
      opacity:.92;
      z-index:12;
      filter: drop-shadow(0 10px 12px rgba(0,0,0,0.35));
    }
    .hero-left { left: calc(50% - clamp(250px, 20vw, 360px)); }
    .hero-right{ left: calc(50% + clamp(250px, 20vw, 360px)); }
    .hero-left span, .hero-right span{
      line-height: 1.18;
      letter-spacing: .14em;
    }
    .char-space{ margin-top: .75em; margin-bottom: .25em; }

    .hero-bottom{
      left:50%;
      bottom: 11%;
      transform: translateX(-50%);
      display:flex;
      gap: 1.9em;
      font-size: clamp(1.6rem, 2.2vw, 2.2rem);
      opacity: .66;
      z-index:10;
    }

    @media (max-width: 900px){
      :root{
        --outer-side: 10px;
        --title-top: calc(var(--stage-top) + clamp(54px, 8.6vh, 86px));
        --title-h: clamp(140px, 18vh, 200px);
        --liquid-op: .22;
        --liquid-speed: 18s;
        --liquid-shift: 3%;
        --btn-h: 88px;
        --sideglass-op: .22;
        --ripple-op: .12;
      }
      .hero-inner{
        width: calc(100vw - (2 * var(--outer-side)));
        margin: 0 var(--outer-side);
        height:auto;
        min-height:100vh;
        padding:1.2rem .75rem 2.2rem;
      }
      .side-glass{ display:none; }
      .ripple-film{
        mask-image:none;
        -webkit-mask-image:none;
        opacity:.10;
      }
      .hero-left, .hero-right{ top: 58%; font-size: 2.0rem; }
      .hero-left{ left: calc(50% - 160px); }
      .hero-right{ left: calc(50% + 160px); }
    }
  </style>
</head>

<body class="locked">
  <!-- ✅ 改成「驗證登入中」遮罩（不再提供此頁登入） -->
  <div class="login-overlay" id="gateOverlay">
    <div class="login-box">
      <div class="login-title">汐東工程管理表</div>
      <div class="login-sub" id="gateSub">驗證登入中…</div>
    </div>
  </div>

  <main class="hero">
    <div class="hero-inner">

      <div class="ripple-film" aria-hidden="true"></div>

      <div class="side-glass side-glass-left" aria-hidden="true"></div>
      <div class="side-glass side-glass-right" aria-hidden="true"></div>

      <div class="lotus-stage" aria-hidden="true">
        <div class="zen-visual" aria-hidden="true">
          <img src="佛教禪意主視覺.png" alt="">
        </div>
        <div class="liquid-flow" aria-hidden="true"></div>
      </div>

      <div class="user-bar">
        <div class="user-pill" id="userInfo">目前使用者：未登入</div>
        <button class="btn-switch" id="btnSwitchUser" type="button">切換帳號</button>
      </div>

      <div class="site-title-wrapper">
        <div class="site-title">汐東工程管理表</div>
      </div>

      <div class="zen-text hero-title">
        <span>空</span><span>無</span><span>明</span>
      </div>

      <div class="zen-text hero-left">
        <span>空</span><span>靈</span><span class="char-space"></span><span>無</span><span>我</span>
      </div>
      <div class="zen-text hero-right">
        <span>清</span><span>明</span><span class="char-space"></span><span>寧</span><span>靜</span>
      </div>

      <div class="zen-text hero-bottom">
        <span>空</span><span>無</span><span>明</span><span>靜</span>
      </div>

      <!-- 你之後要放「汐東工程管理表內容」就在這個 hero-inner 裡面加 -->
    </div>
  </main>

  <script>
    // ✅ 此頁只做「讀取 CURRENT_KEY 自動登入」：首頁控制登入
    const CURRENT_KEY = "tasunCurrentUser_v1";
    const SESSION_KEY = "tasunSessionLogin_v1";

    const gateOverlay = document.getElementById("gateOverlay");
    const gateSub = document.getElementById("gateSub");
    const userInfo = document.getElementById("userInfo");
    const btnSwitch = document.getElementById("btnSwitchUser");

    function safeParse(s){
      try{ return JSON.parse(s); }catch(e){ return null; }
    }

    function getCurrentUser(){
      const obj = safeParse(localStorage.getItem(CURRENT_KEY) || "null");
      if(!obj || typeof obj !== "object") return null;

      const user = String(obj.user || obj.username || "").trim();
      const role = String(obj.role || obj.level || "read").trim().toLowerCase();
      if(!user) return null;

      return { user, role: role || "read" };
    }

    function setSession(cur){
      try{
        sessionStorage.setItem(SESSION_KEY, JSON.stringify({
          user: cur.user,
          role: cur.role,
          t: Date.now()
        }));
      }catch(e){}
    }

    function unlock(cur){
      document.body.classList.remove("locked");
      if(gateOverlay) gateOverlay.style.display = "none";
      if(userInfo) userInfo.textContent = `目前使用者：${cur.user} (${cur.role})`;
    }

    function backToIndex(){
      // 用 replace：避免使用者按上一頁又回到未登入的本頁
      location.replace("index.html");
    }

    function runGate(){
      const cur = getCurrentUser();
      if(cur){
        if(gateSub) gateSub.textContent = `已登入：${cur.user}（${cur.role}）`;
        setSession(cur);
        unlock(cur);
        return;
      }
      if(gateSub) gateSub.textContent = "尚未登入，返回首頁…";
      backToIndex();
    }

    document.addEventListener("DOMContentLoaded", runGate);

    // ✅ 如果別的分頁把 CURRENT_KEY 清掉，這頁也要立即回首頁
    window.addEventListener("storage", (e) => {
      if(e.key === CURRENT_KEY){
        const cur = getCurrentUser();
        if(!cur) backToIndex();
        else{
          setSession(cur);
          unlock(cur);
        }
      }
    });

    // ✅ 切換帳號：清掉登入 → 回首頁登入
    if(btnSwitch){
      btnSwitch.addEventListener("click", () => {
        try{ sessionStorage.removeItem(SESSION_KEY); }catch(e){}
        try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}
        backToIndex();
      });
    }
  </script>
</body>
</html>
