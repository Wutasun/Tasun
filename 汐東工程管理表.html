<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>汐東工程管理表 · Tasun</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#070809; --bg1:#0b0d10;
      --gold:#f6d37a;
      --shadow:0 18px 50px rgba(0,0,0,.55);
      --r:20px;

      --gold-crystal: linear-gradient(180deg,
        rgba(255,255,255,0.96) 0%,
        rgba(255,248,220,0.93) 12%,
        rgba(255,228,160,0.93) 28%,
        rgba(246,211,122,1.00) 52%,
        rgba(232,162,62,0.96) 72%,
        rgba(255,232,186,0.92) 100%);
      --crystal-stroke: rgba(96, 52, 16, 0.72);
      --crystal-deep: rgba(0,0,0,0.62);
      --crystal-deep2: rgba(0,0,0,0.32);
      --crystal-glow1: rgba(246,211,122,0.22);
      --crystal-glow2: rgba(246,211,122,0.10);
      --crystal-hi: rgba(255,255,255,0.16);

      --fs-title: clamp(22px, 1.8vw, 30px);
      --fs-sub: clamp(12px, 1.0vw, 14px);
      --fs-pill: clamp(12px, 1.0vw, 14px);
      --fs-btn: clamp(13px, 1.05vw, 15px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family:"Noto Serif TC","Microsoft JhengHei",serif;
      color:rgba(236,236,236,.94);
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(246,211,122,.10), transparent 60%),
        radial-gradient(900px 520px at 85% 25%, rgba(246,211,122,.08), transparent 62%),
        radial-gradient(1100px 700px at 55% 85%, rgba(246,211,122,.06), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
      -webkit-font-smoothing: antialiased;
      text-rendering: geometricPrecision;
    }

    .crystalText{
      position:relative;
      font-weight:900;
      letter-spacing:.08em;
      color: rgba(240,190,92,.98) !important;
      -webkit-text-fill-color: rgba(240,190,92,.98) !important;
      -webkit-text-stroke: 1.15px var(--crystal-stroke);
      text-shadow:
        0 1px 0 rgba(255,255,255,0.04),
        0 2px 3px var(--crystal-deep),
        0 10px 18px var(--crystal-deep2),
        0 0 12px var(--crystal-glow1),
        0 0 18px var(--crystal-glow2);
    }
    @supports ((-webkit-background-clip: text) or (background-clip: text)) {
      .crystalText::after{
        content: attr(data-text);
        position:absolute; inset:0;
        pointer-events:none;
        background-image: var(--gold-crystal);
        -webkit-background-clip:text;
        background-clip:text;
        color:transparent;
        -webkit-text-fill-color:transparent;
        -webkit-text-stroke:0;
        opacity:.62;
        text-shadow:
          0 0 4px var(--crystal-hi),
          0 0 10px rgba(246,211,122,0.14);
      }
    }

    .wrap{
      width:min(1100px, calc(100vw - 24px));
      margin:0 auto;
      padding:20px 12px 34px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:14px 14px;
      border:1px solid rgba(246,211,122,.32);
      border-radius:var(--r);
      background:
        radial-gradient(120% 160% at 18% 18%, rgba(255,255,255,.070), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.055), rgba(0,0,0,.11));
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px) saturate(1.05);
      -webkit-backdrop-filter:blur(10px) saturate(1.05);
      flex-wrap:wrap;
    }

    .brand{
      flex:1 1 auto;
      min-width:260px;
      text-align:center;
    }
    .title{ font-size:var(--fs-title); }
    .sub{
      margin-top:4px;
      font-size:var(--fs-sub);
      letter-spacing:.10em;
      color:rgba(236,236,236,.70);
      text-shadow:0 1px 0 rgba(0,0,0,0.55);
    }

    .right{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(120% 160% at 16% 18%, rgba(255,255,255,.055), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.14));
      font-size:var(--fs-pill);
      display:flex; gap:8px; align-items:center; white-space:nowrap;
      box-shadow:0 12px 24px rgba(0,0,0,.25);
      backdrop-filter: blur(7px) saturate(1.05);
      -webkit-backdrop-filter: blur(7px) saturate(1.05);
    }

    .btn{
      appearance:none;
      border:1px solid rgba(246,211,122,.30);
      background:
        radial-gradient(120% 160% at 16% 18%, rgba(255,255,255,.055), rgba(255,255,255,0) 58%),
        radial-gradient(120% 160% at 80% 70%, rgba(246,211,122,.030), rgba(0,0,0,0) 76%),
        linear-gradient(180deg, rgba(255,255,255,.030), rgba(0,0,0,.12));
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-family:inherit;
      font-weight:900;
      letter-spacing:.06em;
      font-size:var(--fs-btn);
      user-select:none;
      box-shadow:
        0 14px 28px rgba(0,0,0,.36),
        0 0 16px rgba(246,211,122,.07),
        inset 0 0 0 1px rgba(255,255,255,.05);
      transition:transform .12s ease, border-color .12s ease;
      backdrop-filter: blur(8px) saturate(1.06);
      -webkit-backdrop-filter: blur(8px) saturate(1.06);
    }
    .btn:hover{ transform:translateY(-1px); border-color:rgba(255,235,180,.70); }
    .btn:active{ transform:translateY(0); }
    .btn.ghost{
      border:1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(120% 160% at 16% 18%, rgba(255,255,255,.045), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.022), rgba(0,0,0,.10));
    }

    .panel{
      margin-top:16px;
      padding:16px;
      border-radius:var(--r);
      border:1px solid rgba(246,211,122,.28);
      background:
        radial-gradient(120% 160% at 16% 18%, rgba(255,255,255,.055), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.025), rgba(0,0,0,.12));
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px) saturate(1.05);
      -webkit-backdrop-filter: blur(10px) saturate(1.05);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width:720px){
      .grid{ grid-template-columns: 1fr; }
      .brand{ text-align:left; }
      .right{ justify-content:flex-start; }
    }

    .cardBtn{
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:74px;
      text-decoration:none;
    }

    .loginMask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.68);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:999;
    }
    .loginMask.show{display:flex;}
    .loginModal{
      width:min(520px, 96vw);
      border-radius:22px;
      border:1px solid rgba(246,211,122,.46);
      background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      box-shadow:0 30px 90px rgba(0,0,0,.78);
      overflow:hidden;
      backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px);
    }
    .loginHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .loginBody{padding:14px 16px 10px;}
    .loginFoot{
      padding:12px 16px;
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .field{display:flex; flex-direction:column; gap:6px; margin-top:10px}
    .label{font-size:13px; letter-spacing:.10em; font-weight:900; opacity:.9}
    select,input{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.42);
      color:rgba(255,244,208,.95);
      padding:11px 12px;
      font-family:"Noto Serif TC",serif;
      outline:none;
    }
    .loginErr{
      margin-top:10px;
      color:rgba(255,190,190,.95);
      font-size:13px;
      line-height:1.5;
      display:none;
      white-space:pre-wrap;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <button class="btn ghost crystalText" id="btnHome" type="button" data-text="返回首頁">返回首頁</button>

      <div class="brand">
        <div class="title crystalText" data-text="汐東工程管理表">汐東工程管理表</div>
        <div class="sub">入口總表 · 依權限顯示</div>
      </div>

      <div class="right">
        <div class="pill">使用者：<b class="crystalText" id="uName" data-text="—">—</b></div>
        <div class="pill">權限：<b class="crystalText" id="uRole" data-text="—">—</b></div>
        <button class="btn crystalText" id="btnSwitch" type="button" data-text="切換帳號">切換帳號</button>
      </div>
    </div>

    <div class="panel">
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="loginMask" id="loginMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="登入">
      <div class="loginHead">
        <div class="crystalText" data-text="登入">登入</div>
        <button class="btn ghost crystalText" id="loginClose" type="button" data-text="關閉">關閉</button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label crystalText" data-text="帳號">帳號</div>
          <select id="loginUser" autocomplete="username">
            <option value="">請選擇帳號</option>
          </select>
        </div>
        <div class="field">
          <div class="label crystalText" data-text="密碼">密碼</div>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="請輸入密碼" />
        </div>
        <div class="loginErr" id="loginErr"></div>
      </div>
      <div class="loginFoot">
        <button class="btn ghost crystalText" id="loginToAuth" type="button" data-text="前往權限表">前往權限表</button>
        <button class="btn crystalText" id="loginBtn" type="button" data-text="登入">登入</button>
      </div>
    </div>
  </div>

  <script>
    const AUTH_KEY    = "tasunAuthTable_v1";
    const CURRENT_KEY = "tasunCurrentUser_v1";

    const BTN_DEFS = [
      { id:"btn1", label:"捷運汐東線事項記錄", href:"捷運汐東線記事.html", roles:["admin","write","read"] },
      { id:"btn2", label:"返回 Tasun 首頁",     href:"index.html",       roles:["admin","write","read"] },
      { id:"btn3", label:"工程資料庫",          href:"工程資料庫.html",   roles:["admin","write"] },
      { id:"btn4", label:"雲端檔案（Dropbox）", href:"https://www.dropbox.com/", target:"_blank", roles:["admin","write","read"] },
      { id:"btn5", label:"系統 / 權限",         href:"權限表.html",       roles:["admin"] }
    ];

    const $ = (id)=>document.getElementById(id);
    const norm = (s)=>(s??"").toString().trim();

    function crystalizeAll(root=document){
      root.querySelectorAll(".crystalText").forEach(el=>{
        const t=(el.textContent||"").trim();
        if(t) el.setAttribute("data-text", t);
      });
    }

    function loadAuthTable(){
      try{
        const raw = localStorage.getItem(AUTH_KEY);
        if(!raw) return [];
        const p = JSON.parse(raw);
        if(Array.isArray(p)) return p;
        if(p && Array.isArray(p.users)) return p.users;
        return [];
      }catch(e){ return []; }
    }
    function pickUser(row){ return norm(row?.username ?? row?.user ?? row?.account ?? row?.name); }
    function pickPass(row){ return (row?.password ?? row?.pass ?? "").toString(); }
    function mapRole(v){
      const s=(v??"").toString().trim().toLowerCase();
      if(!s) return "read";
      if(s==="admin") return "admin";
      if(s==="write"||s==="edit") return "write";
      if(s==="read"||s==="view") return "read";
      if(s==="0") return "admin";
      if(s==="1") return "write";
      if(s==="2") return "read";
      return s;
    }
    function pickRole(row){ return mapRole(row?.role ?? row?.level ?? "read"); }

    let current = null;

    function setCurrent(user, role){
      const obj = { user, username:user, role:mapRole(role), level:mapRole(role) };
      localStorage.setItem(CURRENT_KEY, JSON.stringify(obj));
      current = obj;
    }
    function loadCurrent(){
      try{ current = JSON.parse(localStorage.getItem(CURRENT_KEY) || "null"); }
      catch(e){ current = null; }
      if(current && typeof current==="object"){
        current.user = norm(current.user ?? current.username);
        current.role = mapRole(current.role ?? current.level);
        current.level = current.role;
      }
    }

    function rebuildLoginUsers(preselect){
      const rows = loadAuthTable();
      const users = rows.map(pickUser).filter(Boolean);
      const seen = new Set();
      const uniq = [];
      for(const u of users){
        const k=u.toLowerCase();
        if(seen.has(k)) continue;
        seen.add(k);
        uniq.push(u);
      }
      uniq.sort((a,b)=>a.localeCompare(b,"zh-Hant"));
      $("loginUser").innerHTML =
        `<option value="">請選擇帳號</option>` +
        uniq.map(u=>{
          const s = (preselect && u.toLowerCase()===preselect.toLowerCase()) ? "selected" : "";
          return `<option value="${u.replaceAll('"','&quot;')}" ${s}>${u}</option>`;
        }).join("");
    }

    function openLogin(msg){
      $("loginErr").style.display="none";
      if(msg){
        $("loginErr").textContent = msg;
        $("loginErr").style.display="block";
      }
      loadCurrent();
      rebuildLoginUsers(current?.user || "");
      $("loginPass").value="";
      $("loginMask").classList.add("show");
      $("loginMask").setAttribute("aria-hidden","false");
      crystalizeAll(document);
      setTimeout(()=>{ ($("loginUser").value ? $("loginPass") : $("loginUser")).focus(); },0);
    }
    function closeLogin(){
      $("loginMask").classList.remove("show");
      $("loginMask").setAttribute("aria-hidden","true");
    }

    function ensureLogin(){
      const rows = loadAuthTable();
      if(!rows.length){ openLogin("尚未建立權限表：請先到「權限表.html」建立帳號。"); return false; }

      loadCurrent();
      if(!current || !current.user){ openLogin(); return false; }

      // 校驗帳號存在
      const auth = rows.map(r=>({u:pickUser(r), p:pickPass(r), r:pickRole(r)}))
        .find(x=>x.u && x.u.toLowerCase()===current.user.toLowerCase());

      if(!auth){ openLogin("帳號已被移除，請重新登入"); return false; }

      // 只同步 role（密碼校驗在 login 時做）
      setCurrent(auth.u, auth.r);
      $("uName").textContent = auth.u;
      $("uRole").textContent = auth.r;
      crystalizeAll(document);
      return true;
    }

    function render(){
      const r = mapRole(current?.role ?? "read");
      $("uName").textContent = current?.user || "—";
      $("uRole").textContent = r;
      const grid = $("grid");
      grid.innerHTML = "";

      BTN_DEFS.forEach(def=>{
        if(def.roles && !def.roles.includes(r)) return;

        const a = document.createElement("a");
        a.className = "btn cardBtn crystalText";
        a.href = def.href;
        a.textContent = def.label;
        a.setAttribute("data-text", def.label);

        if(def.target){
          a.target = def.target;
          if(def.target === "_blank") a.rel = "noopener noreferrer";
        }
        grid.appendChild(a);
      });

      crystalizeAll(document);
    }

    function doLogin(){
      const u = norm($("loginUser").value);
      const p = ($("loginPass").value ?? "").toString();

      const rows = loadAuthTable();
      if(!rows.length){ $("loginErr").textContent="尚未建立權限表。"; $("loginErr").style.display="block"; return; }
      if(!u){ $("loginErr").textContent="請先選擇帳號。"; $("loginErr").style.display="block"; return; }
      if(!p){ $("loginErr").textContent="請輸入密碼。"; $("loginErr").style.display="block"; return; }

      const auth = rows.map(r=>({u:pickUser(r), p:pickPass(r), r:pickRole(r)}))
        .find(x=>x.u && x.u.toLowerCase()===u.toLowerCase());

      if(!auth){ $("loginErr").textContent="帳號不存在（以權限表為準）。"; $("loginErr").style.display="block"; return; }
      if((auth.p ?? "") !== p){ $("loginErr").textContent="密碼錯誤（以權限表為準）。"; $("loginErr").style.display="block"; return; }

      setCurrent(auth.u, auth.r);
      closeLogin();
      render();
    }

    // events
    $("btnHome").onclick = ()=> location.href="index.html";
    $("btnSwitch").onclick = ()=>{ try{localStorage.removeItem(CURRENT_KEY);}catch(e){} current=null; openLogin("請重新登入"); };
    $("loginClose").onclick = closeLogin;
    $("loginToAuth").onclick = ()=> location.href="權限表.html";
    $("loginBtn").onclick = doLogin;
    $("loginMask").addEventListener("click",(e)=>{ if(e.target===$("loginMask")) closeLogin(); });
    window.addEventListener("keydown",(e)=>{
      if(e.key==="Escape" && $("loginMask").classList.contains("show")) closeLogin();
      if(e.key==="Enter" && $("loginMask").classList.contains("show")) doLogin();
    });

    // init
    crystalizeAll(document);
    if(ensureLogin()){
      render();
    }
  </script>
</body>
</html>
