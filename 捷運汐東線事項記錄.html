<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>æ·é‹æ±æ±ç·šäº‹é …è¨˜éŒ„ Â· Tasun</title>

  <link rel="icon" href="data:,">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- âœ… å…¨ç«™ç‰ˆæœ¬ï¼šè¦èˆ‡ tasun-version.json ä¸€è‡´ï¼ˆä½ å¯è‡ªè¡Œæ”¹æˆä½ çš„æœ€æ–°ç‰ˆï¼‰ -->
  <script>window.TASUN_APP_VER = window.TASUN_APP_VER || "20260205_01";</script>

  <style>
    :root{
      --bg0:#07070b;
      --bg1:#0c0b12;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.08);
      --line:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.72);
      --danger:#ff4d4f;

      /* âœ…âœ…âœ… A) ä¿®æ­£é»‘éœ§é®è“‹ï¼šæ”¹æ›´ç´°ã€é™ä½é»‘é®è“‹æ„Ÿ */
      --btnStroke: .55px;
      --strokeBlack: rgba(0,0,0,.42);
      --strokeBlackStrong: rgba(0,0,0,.52);

      --radius:18px;
      --radius2:22px;
      --shadow: 0 14px 40px rgba(0,0,0,.45);

      --tap:48px;
      --font: "Noto Serif TC", "Noto Sans TC", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color:var(--text);
      background:
        radial-gradient(1100px 560px at 20% 12%, rgba(255,214,120,.10), transparent 55%),
        radial-gradient(900px 520px at 88% 18%, rgba(160,210,255,.10), transparent 58%),
        radial-gradient(1200px 820px at 50% 92%, rgba(255,140,180,.08), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{ max-width:1180px; margin:0 auto; padding:18px 14px 96px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 14px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .right{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    .back{
      height:44px; min-width:44px; padding:0 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color:var(--text);
      display:inline-flex; align-items:center; justify-content:center;
      cursor:pointer;
    }
    .back:active{ transform: translateY(1px); }

    .title{
      min-width:0;
      display:flex; flex-direction:column; gap:2px;
    }
    .title h1{
      margin:0;
      font-size:22px;
      line-height:1.2;
      letter-spacing:.08em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .subtitle{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .card{
      margin-top:14px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.035));
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .toolbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .toolbar .hint{ font-size:12px; color:var(--muted); }

    .btn{
      height:42px;
      padding:0 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      cursor:pointer;
      user-select:none;
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      position:relative;
      min-width: var(--tap);
      -webkit-tap-highlight-color: transparent;
    }
    .btn.small{ height:36px; border-radius:14px; padding:0 12px; }
    .btn.danger{ border-color: rgba(255,77,79,.45); background: rgba(255,77,79,.08); }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }

    /* âœ…âœ…âœ… A) æ¸…æ™°é‡‘å­—ï¼ˆæ›¿æ›ä½ åŸæœ¬ goldCrystal / btn .t / goldCrystalModal / attBtn .tï¼‰ */
    .goldCrystal{
      background: linear-gradient(180deg,
        rgba(255,254,246,.99) 0%,
        rgba(255,248,228,.99) 18%,
        rgba(252,228,170,.99) 46%,
        rgba(235,168,64,.99) 78%,
        rgba(255,254,246,.99) 100%);
      -webkit-background-clip:text;
      background-clip:text;
      color: rgba(246,214,150,.98);
      text-shadow: 0 1px 0 rgba(255,255,255,.10);
    }
    @supports (-webkit-background-clip:text) or (background-clip:text){
      .goldCrystal{
        color:transparent;
        -webkit-text-fill-color:transparent;
        -webkit-text-stroke: .70px var(--strokeBlack);
        text-shadow: 0 1px 0 rgba(255,255,255,.10);
      }
    }

    .goldCrystalModal{
      background: linear-gradient(180deg,
        rgba(255,254,246,1) 0%,
        rgba(255,252,244,1) 22%,
        rgba(255,235,190,1) 50%,
        rgba(248,196,92,1) 78%,
        rgba(255,254,246,1) 100%);
      -webkit-background-clip:text;
      background-clip:text;
      color: rgba(246,214,150,.98);
      text-shadow: 0 1px 0 rgba(255,255,255,.08);
    }
    @supports (-webkit-background-clip:text) or (background-clip:text){
      .goldCrystalModal{
        color:transparent;
        -webkit-text-fill-color:transparent;
        -webkit-text-stroke: .78px var(--strokeBlackStrong);
        text-shadow: 0 1px 0 rgba(255,255,255,.08);
      }
    }

    .btn .t{
      color: rgba(255,242,210,.98);
      text-shadow: 0 1px 0 rgba(255,255,255,.10);
      font-weight:900;
      letter-spacing:.05em;
      white-space:nowrap;
    }
    @supports (-webkit-background-clip:text) or (background-clip:text){
      .btn .t{
        background: linear-gradient(180deg,
          rgba(255,254,246,1) 0%,
          rgba(255,252,244,1) 22%,
          rgba(255,235,190,1) 50%,
          rgba(248,196,92,1) 78%,
          rgba(255,254,246,1) 100%);
        -webkit-background-clip:text;
        background-clip:text;
        color:transparent;
        -webkit-text-fill-color:transparent;
        -webkit-text-stroke: var(--btnStroke) var(--strokeBlack);
        text-shadow: 0 1px 0 rgba(255,255,255,.10);
        filter:none;
      }
      .btn.small .t{
        -webkit-text-stroke: calc(var(--btnStroke) + .15px) var(--strokeBlackStrong);
      }
    }

    .tableWrap{ width:100%; overflow:auto; }
    table{ width:100%; border-collapse:separate; border-spacing:0; min-width:980px; }
    thead th{
      position:sticky; top:0;
      background: rgba(0,0,0,.35);
      border-bottom:1px solid rgba(255,255,255,.10);
      color:rgba(255,255,255,.88);
      font-size:12px;
      letter-spacing:.08em;
      text-align:left;
      padding:12px 10px;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index:2;
    }
    tbody td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 10px;
      font-size:13px;
      color:rgba(255,255,255,.90);
      vertical-align:top;
    }
    tbody tr:hover td{ background: rgba(255,255,255,.04); }
    .colNo{ width:70px; color:rgba(255,255,255,.78); }
    .colDate{ width:130px; color:rgba(255,255,255,.78); white-space:nowrap; }
    .colTrade{ width:120px; white-space:nowrap; }
    .colSys{ width:140px; white-space:nowrap; }
    .colAtt{ width:220px; }
    .colRemark{ width:220px; color:rgba(255,255,255,.80); }
    .colAct{ width:160px; white-space:nowrap; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.85);
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .pill:active{ transform: translateY(1px); }

    /* Modal */
    .modalMask{
      position:fixed; inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modalMask.show{ display:flex; }
    .modal{
      width:min(920px, 100%);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .modalHeader{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.28);
    }
    .modalHeader .h{
      display:flex; align-items:baseline; gap:10px; min-width:0;
    }
    .modalHeader .h .ttl{
      font-size:18px;
      letter-spacing:.10em;
      margin:0;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .modalBody{ padding:14px; }
    .grid{
      display:grid;
      grid-template-columns: 1.4fr .8fr .8fr;
      gap:12px;
    }
    .field{
      display:flex; flex-direction:column; gap:8px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: 18px;
      padding:12px;
    }
    .field .lab{ font-size:12px; color:rgba(255,255,255,.72); letter-spacing:.08em; }
    input, textarea, select{
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      border-radius: 14px;
      padding:10px 10px;
      font-size:14px;
      outline:none;
    }
    textarea{ min-height:110px; resize:vertical; }

    .row2{ grid-column: 1 / -1; }
    .attList{ display:flex; flex-wrap:wrap; gap:8px; }
    .attItem{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .attItem .x{
      width:18px; height:18px; border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      display:inline-flex; align-items:center; justify-content:center;
      background: rgba(255,77,79,.10);
    }

    .modalFooter{
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      padding:14px;
      border-top:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
    }

    /* Viewer */
    .viewerBox{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      border-radius: 18px;
      overflow:hidden;
    }
    .viewerBox iframe, .viewerBox img{
      width:100%;
      height:min(70vh, 560px);
      border:0;
      display:block;
      background:#000;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      background: rgba(0,0,0,.72);
      border:1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius: 999px;
      font-size:13px;
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      display:none;
      z-index:10000;
      max-width:min(92vw, 980px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{ display:block; }

    /* Cloud mini status */
    .cloudBar{
      position:fixed;
      right:12px;
      bottom:12px;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      z-index:9998;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.35);
      border:1px solid rgba(255,255,255,.18);
    }
    .cloudTxt{ font-size:12px; color: rgba(255,255,255,.82); }

    /* Attachment button style uses same clear-text */
    .attBtn{ height:34px; border-radius: 14px; padding:0 12px; }
    .attBtn .t{
      color: rgba(255,242,210,.98);
      text-shadow: 0 1px 0 rgba(255,255,255,.10);
      font-weight:900;
      letter-spacing:.05em;
      white-space:nowrap;
    }
    @supports (-webkit-background-clip:text) or (background-clip:text){
      .attBtn .t{
        background: linear-gradient(180deg,
          rgba(255,254,246,1) 0%,
          rgba(255,252,244,1) 22%,
          rgba(255,235,190,1) 50%,
          rgba(248,196,92,1) 78%,
          rgba(255,254,246,1) 100%);
        -webkit-background-clip:text;
        background-clip:text;
        color:transparent;
        -webkit-text-fill-color:transparent;
        -webkit-text-stroke: .60px var(--strokeBlack);
        text-shadow: 0 1px 0 rgba(255,255,255,.10);
        filter:none;
      }
    }

    @media (max-width:900px){
      .grid{ grid-template-columns: 1fr; }
      table{ min-width:860px; }
      .title h1{ font-size:18px; }
    }
  </style>

  <!-- Fontsï¼ˆå¯é¸ï¼‰ -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="left">
        <button class="back" id="btnBack" title="è¿”å›">â†</button>
        <div class="title">
          <h1 class="goldCrystal">æ·é‹æ±æ±ç·šäº‹é …è¨˜éŒ„</h1>
          <div class="subtitle" id="subInfo">æœ¬æ©Ÿè³‡æ–™ï¼šâ€”ã€€ï½œã€€é›²ç«¯ï¼šâ€”</div>
        </div>
      </div>
      <div class="right">
        <button class="btn small" id="btnAdd"><span class="t">æ–°å¢</span></button>
        <button class="btn small" id="btnExport"><span class="t">åŒ¯å‡º</span></button>
        <button class="btn small" id="btnImport"><span class="t">åŒ¯å…¥</span></button>
        <button class="btn small" id="btnPull"><span class="t">é›²ç«¯åŒæ­¥</span></button>
      </div>
    </div>

    <div class="card">
      <div class="toolbar">
        <div class="hint" id="hintLine">æç¤ºï¼šé»ã€Œé™„ä»¶ã€å¯é¡¯ç¤ºç•«é¢ï¼›å¯å¤šäººåŒæ™‚æ–°å¢ï¼Œé›²ç«¯æ¡åˆä½µå¯«å…¥ã€‚</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn small" id="btnBackup"><span class="t">å‚™ä»½</span></button>
          <button class="btn small danger" id="btnWipe"><span class="t">æ¸…ç©ºæœ¬æ©Ÿ</span></button>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th class="colNo">é …æ¬¡</th>
              <th>è¨˜äº‹å…§å®¹</th>
              <th class="colTrade">å·¥ç¨®</th>
              <th class="colSys">ç³»çµ±</th>
              <th class="colAtt">é™„ä»¶</th>
              <th class="colRemark">å‚™è¨»</th>
              <th class="colDate">ç™»éŒ„æ—¥æœŸ</th>
              <th class="colAct">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modalMask" id="editMask" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <div class="h">
          <h2 class="ttl goldCrystalModal" id="editTitle">æ–°å¢äº‹é …</h2>
          <div class="subtitle" id="editSub">â€”</div>
        </div>
        <button class="btn small" id="btnEditClose"><span class="t">é—œé–‰</span></button>
      </div>
      <div class="modalBody">
        <div class="grid">
          <div class="field row2">
            <div class="lab">è¨˜äº‹å…§å®¹</div>
            <textarea id="inText" placeholder="è«‹è¼¸å…¥è¨˜äº‹å…§å®¹â€¦"></textarea>
          </div>

          <div class="field">
            <div class="lab">å·¥ç¨®</div>
            <input id="inTrade" placeholder="ä¾‹å¦‚ï¼šæ©Ÿé›» / åœŸå»º / æ¶ˆé˜²â€¦" list="tradeList">
            <datalist id="tradeList"></datalist>
          </div>

          <div class="field">
            <div class="lab">ç³»çµ±</div>
            <input id="inSystem" placeholder="ä¾‹å¦‚ï¼šçµ¦æ’æ°´ / ç©ºèª¿ / é›»åŠ›â€¦" list="sysList">
            <datalist id="sysList"></datalist>
          </div>

          <div class="field row2">
            <div class="lab">é™„ä»¶ï¼ˆé€£çµï¼‰</div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
              <button class="btn small attBtn" id="btnAddAtt"><span class="t">æ–°å¢é™„ä»¶</span></button>
              <button class="btn small attBtn" id="btnOpenDisk"><span class="t">ç¶²è·¯ç¡¬ç¢Ÿ</span></button>
              <div class="subtitle" style="margin-left:auto;">é»é™„ä»¶å¯é è¦½ï¼›é»å³å´å°å‰å¯ç§»é™¤</div>
            </div>
            <div class="attList" id="attList"></div>
          </div>

          <div class="field row2">
            <div class="lab">å‚™è¨»</div>
            <textarea id="inRemark" placeholder="å‚™è¨»ï¼ˆé¸å¡«ï¼‰"></textarea>
          </div>

          <div class="field">
            <div class="lab">ç™»éŒ„æ—¥æœŸ</div>
            <input id="inDate" type="date">
          </div>
          <div class="field">
            <div class="lab">UIDï¼ˆç³»çµ±ç”¨ï¼‰</div>
            <input id="inUid" disabled>
          </div>
          <div class="field">
            <div class="lab">IDï¼ˆæ’åºç”¨ï¼‰</div>
            <input id="inId" disabled>
          </div>
        </div>
      </div>
      <div class="modalFooter">
        <button class="btn danger" id="btnDelete"><span class="t">åˆªé™¤</span></button>
        <button class="btn" id="btnSave"><span class="t">å„²å­˜</span></button>
      </div>
    </div>
  </div>

  <!-- Viewer Modal ("é¡¯ç¤ºç•«é¢") -->
  <div class="modalMask" id="viewMask" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" style="width:min(980px,100%);">
      <div class="modalHeader">
        <div class="h">
          <h2 class="ttl goldCrystalModal">é¡¯ç¤ºç•«é¢</h2>
          <div class="subtitle" id="viewSub">â€”</div>
        </div>
        <button class="btn small" id="btnViewClose"><span class="t">é—œé–‰</span></button>
      </div>
      <div class="modalBody">
        <div class="viewerBox">
          <iframe id="viewerFrame" src="about:blank" title="viewer" referrerpolicy="no-referrer"></iframe>
          <img id="viewerImg" alt="preview" style="display:none;">
        </div>
      </div>
      <div class="modalFooter">
        <button class="btn small" id="btnViewDisk"><span class="t">ç¶²è·¯ç¡¬ç¢Ÿ</span></button>
        <button class="btn small" id="btnViewCancel"><span class="t">å–æ¶ˆ</span></button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="cloudBar" id="cloudBar" title="é›²ç«¯ç‹€æ…‹">
    <div class="dot" id="cloudDot"></div>
    <div class="cloudTxt" id="cloudTxt">é›²ç«¯ï¼šæœªåˆå§‹åŒ–</div>
  </div>

  <!-- âœ… é›²ç«¯å¥—ä»¶ï¼ˆä½ è‹¥å·²æ”¾åœ¨åŒè³‡æ–™å¤¾ï¼Œä¿æŒæ­¤è¡Œï¼‰ -->
  <script src="tasun-cloud-kit.js?v=20260205_01"></script>

  <script>
  (function(){
    "use strict";

    // -------------------------------
    // Config
    // -------------------------------
    var APP_VER = String(window.TASUN_APP_VER || "20260205_01");
    var PAGE_KEY = "sxdh-notes";                 // âœ… resourceKey = sxdh-notes
    var PAGE_SCHEMA = "tasun.sxdh.notes.v1";     // âœ… æœ¬é  schema
    var PK_FIELD = "k";                          // âœ… pk = kï¼ˆmerge-table keyï¼‰
    var DB_KEY = "tasunSxdhNotes_v1";            // âœ… æœ¬æ©Ÿä¸»è³‡æ–™ key
    var COUNTER_KEY = "tasunSxdhNotes_counter_v1";

    // schema/settings
    var SETTINGS_UID = "__settings__";
    var TRADE_DICT_KEY = "tasunSxdhNotes_tradeDict_v1";
    var SYS_DICT_KEY   = "tasunSxdhNotes_sysDict_v1";
    var TRADE_SYS_MAP_KEY = "tasunSxdhNotes_tradeSysMap_v1";
    var PROTECT_EMPTY_REMOTE_KEY = "tasunSxdhNotes_protectEmptyRemote_v1";

    // optional: network disk url (å¯è‡ªè¡Œæ”¹æˆä½ çš„é›²ç«¯ç¡¬ç¢Ÿ)
    var NET_DISK_URL = localStorage.getItem("tasunNetDiskUrl_v1") || "";

    // -------------------------------
    // State
    // -------------------------------
    var db = [];
    var counter = 0;
    var lastCloudSyncAt = 0;
    var editingUid = null;

    // cloud ctrl
    var cloud = null;

    // -------------------------------
    // DOM
    // -------------------------------
    var $ = function(id){ return document.getElementById(id); };

    var tbody = $("tbody");
    var subInfo = $("subInfo");

    var editMask = $("editMask");
    var editTitle = $("editTitle");
    var editSub = $("editSub");
    var inText = $("inText");
    var inTrade = $("inTrade");
    var inSystem = $("inSystem");
    var inRemark = $("inRemark");
    var inDate = $("inDate");
    var inUid = $("inUid");
    var inId = $("inId");
    var attList = $("attList");
    var tradeList = $("tradeList");
    var sysList = $("sysList");

    var viewMask = $("viewMask");
    var viewSub = $("viewSub");
    var viewerFrame = $("viewerFrame");
    var viewerImg = $("viewerImg");

    var toastEl = $("toast");
    var cloudDot = $("cloudDot");
    var cloudTxt = $("cloudTxt");

    // -------------------------------
    // Utils
    // -------------------------------
    function norm(s){ return (s===undefined||s===null) ? "" : String(s).trim(); }
    function nowISO(){ return new Date().toISOString(); }
    function toDateInputValue(d){
      try{
        var dt = (d instanceof Date) ? d : new Date(d);
        if(!isFinite(dt.getTime())) dt = new Date();
        var y = dt.getFullYear();
        var m = String(dt.getMonth()+1).padStart(2,"0");
        var day = String(dt.getDate()).padStart(2,"0");
        return y+"-"+m+"-"+day;
      }catch(e){
        return "";
      }
    }
    function toast(msg){
      msg = norm(msg);
      if(!msg) return;
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(function(){ toastEl.classList.remove("show"); }, 2800);
    }
    function safeJSONParse(s, fallback){
      try{ return JSON.parse(s); }catch(e){ return fallback; }
    }
    function genUid(){
      return "k_" + Date.now() + "_" + Math.random().toString(16).slice(2,10);
    }
    function ensureCounterAtLeast(n){
      n = Number(n||0);
      if(!Number.isFinite(n)) n = 0;
      if(n > counter) counter = n;
      localStorage.setItem(COUNTER_KEY, String(counter));
    }

    // -------------------------------
    // Backup / snapshot
    // -------------------------------
    function saveSafetySnapshot(tag){
      try{
        var snap = {
          at: nowISO(),
          tag: norm(tag),
          db: Array.isArray(db) ? db : [],
          counter: counter
        };
        localStorage.setItem(DB_KEY + "_safetySnapshot_v1", JSON.stringify(snap));
      }catch(e){}
    }
    function restoreFromSafetySnapshot(showToast){
      try{
        var s = localStorage.getItem(DB_KEY + "_safetySnapshot_v1");
        if(!s) return false;
        var snap = safeJSONParse(s, null);
        if(!snap || !Array.isArray(snap.db)) return false;
        db = snap.db.map(normalizeRow).filter(Boolean);
        counter = Number(snap.counter||0);
        if(!Number.isFinite(counter)) counter = 0;
        localStorage.setItem(DB_KEY, JSON.stringify(db));
        localStorage.setItem(COUNTER_KEY, String(counter));
        if(showToast) toast("å·²å¾å®‰å…¨å¿«ç…§é‚„åŸ");
        render();
        return true;
      }catch(e){
        return false;
      }
    }
    function rotateBackups(beforeDb){
      try{
        // keep last 3
        var k0 = DB_KEY + "_bak0_v1";
        var k1 = DB_KEY + "_bak1_v1";
        var k2 = DB_KEY + "_bak2_v1";
        localStorage.setItem(k2, localStorage.getItem(k1) || "");
        localStorage.setItem(k1, localStorage.getItem(k0) || "");
        localStorage.setItem(k0, JSON.stringify({ at: nowISO(), db: beforeDb, counter: counter }));
      }catch(e){}
    }

    // -------------------------------
    // Dictionaries
    // -------------------------------
    function loadDict(key){
      var arr = safeJSONParse(localStorage.getItem(key)||"[]", []);
      if(!Array.isArray(arr)) arr = [];
      return arr.map(norm).filter(Boolean);
    }
    function saveDict(key, arr){
      arr = Array.isArray(arr) ? arr.map(norm).filter(Boolean) : [];
      // unique
      var seen = Object.create(null);
      var out = [];
      arr.forEach(function(x){
        if(!x) return;
        var k = x.toLowerCase();
        if(seen[k]) return;
        seen[k]=1; out.push(x);
      });
      localStorage.setItem(key, JSON.stringify(out));
      return out;
    }
    function loadTradeSysMap(){
      var m = safeJSONParse(localStorage.getItem(TRADE_SYS_MAP_KEY)||"{}", {});
      if(!m || typeof m!=="object") m = {};
      return m;
    }
    function saveTradeSysMap(m){
      if(!m || typeof m!=="object") m = {};
      localStorage.setItem(TRADE_SYS_MAP_KEY, JSON.stringify(m));
      return m;
    }

    function refreshDatalist(){
      var trades = loadDict(TRADE_DICT_KEY);
      var systems = loadDict(SYS_DICT_KEY);

      tradeList.innerHTML = trades.map(function(x){ return "<option value=\""+escapeHtml(x)+"\"></option>"; }).join("");
      sysList.innerHTML   = systems.map(function(x){ return "<option value=\""+escapeHtml(x)+"\"></option>"; }).join("");
    }

    function learnDictFromDb(){
      var trades = [];
      var systems = [];
      db.forEach(function(r){
        if(r.trade) trades.push(r.trade);
        if(r.system) systems.push(r.system);
      });
      saveDict(TRADE_DICT_KEY, loadDict(TRADE_DICT_KEY).concat(trades));
      saveDict(SYS_DICT_KEY, loadDict(SYS_DICT_KEY).concat(systems));
      refreshDatalist();
    }

    // -------------------------------
    // Auth (æœ€å°ç›¸å®¹ï¼šå¯å¯«å–æ±ºæ–¼æœ¬æ©Ÿè¨­å®š/æˆ–ç”± cloud kit ç®¡æ§)
    // -------------------------------
    var Auth = {
      role: norm(localStorage.getItem("tasunRole_v1") || "read"),
      canWrite: function(){
        var r = norm(Auth.role).toLowerCase();
        return (r==="admin" || r==="write");
      }
    };

    // -------------------------------
    // Data normalize
    // -------------------------------
    function normalizeRow(r){
      if(!r || typeof r!=="object") return null;

      // æ”¯æ´ merge-table æ ¼å¼ï¼š{k, v}
      if(("v" in r) && (r.k!==undefined || r.key!==undefined)){
        var inner = r.v;
        if(typeof inner === "string"){ inner = safeJSONParse(inner, inner); }
        if(inner && typeof inner==="object"){
          r = Object.assign({}, inner, { uid: norm(r.k ?? r.key ?? inner.uid ?? "") });
        }
      }

      var uid = norm(r.uid || r.k || r.key);
      var id = Number(r.id||0);
      if(!Number.isFinite(id)) id = 0;

      var text = (r.text ?? r.content ?? r.note ?? r.memo ?? "");
      var trade = norm(r.trade);
      var system = norm(r.system);
      var remark = (r.remark ?? r.note2 ?? r.comment ?? "");
      var date = norm(r.date || r.createdDate || r.createdAt || "");

      var attach = r.attach || r.attachments || r.att || [];
      if(typeof attach === "string"){
        attach = safeJSONParse(attach, []);
      }
      if(!Array.isArray(attach)) attach = [];

      attach = attach.map(function(a){
        if(typeof a === "string"){
          var s = norm(a);
          return s ? ({ name: guessNameFromUrl(s), url: s }) : null;
        }
        if(a && typeof a==="object"){
          var name = norm(a.name || a.title || guessNameFromUrl(a.url||""));
          var url = norm(a.url || a.href || "");
          if(!url) return null;
          return { name: name || guessNameFromUrl(url), url: url };
        }
        return null;
      }).filter(Boolean);

      if(!date){
        date = toDateInputValue(new Date());
      }else{
        // allow ISO or yyyy-mm-dd; keep yyyy-mm-dd in storage
        if(date.length>=10) date = date.slice(0,10);
      }

      return {
        id: id,
        uid: uid,
        text: String(text||""),
        trade: trade,
        system: system,
        attach: attach,
        remark: String(remark||""),
        date: date
      };
    }

    function escapeHtml(s){
      s = String(s||"");
      return s.replace(/[&<>"']/g, function(c){
        return ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" })[c];
      });
    }

    function guessNameFromUrl(url){
      url = norm(url);
      if(!url) return "é™„ä»¶";
      try{
        var u = new URL(url, location.href);
        var p = u.pathname.split("/").filter(Boolean);
        var last = p.length ? p[p.length-1] : "";
        last = decodeURIComponent(last || "");
        return last || "é™„ä»¶";
      }catch(e){
        return url.length>26 ? (url.slice(0,26)+"â€¦") : url;
      }
    }

    // -------------------------------
    // Render
    // -------------------------------
    function render(){
      // sort by id asc
      var rows = db.slice().sort(function(a,b){ return (a.id||0) - (b.id||0); });

      tbody.innerHTML = rows.map(function(r, idx){
        var attHtml = "";
        if(r.attach && r.attach.length){
          attHtml = r.attach.map(function(a, i){
            var label = escapeHtml(a.name || ("é™„ä»¶"+(i+1)));
            return '<span class="pill" data-act="viewAtt" data-uid="'+escapeHtml(r.uid)+'" data-i="'+i+'">ğŸ“ '+label+'</span>';
          }).join(" ");
        }else{
          attHtml = '<span style="color:rgba(255,255,255,.45);">â€”</span>';
        }

        return ''+
          '<tr>'+
            '<td class="colNo">'+(idx+1)+'</td>'+
            '<td>'+escapeHtml(r.text).replace(/\n/g,"<br>")+'</td>'+
            '<td class="colTrade">'+(r.trade?escapeHtml(r.trade):'<span style="color:rgba(255,255,255,.45);">â€”</span>')+'</td>'+
            '<td class="colSys">'+(r.system?escapeHtml(r.system):'<span style="color:rgba(255,255,255,.45);">â€”</span>')+'</td>'+
            '<td class="colAtt">'+attHtml+'</td>'+
            '<td class="colRemark">'+(r.remark?escapeHtml(r.remark).replace(/\n/g,"<br>"):'<span style="color:rgba(255,255,255,.45);">â€”</span>')+'</td>'+
            '<td class="colDate">'+escapeHtml(r.date||"")+'</td>'+
            '<td class="colAct">'+
              '<button class="btn small" data-act="edit" data-uid="'+escapeHtml(r.uid)+'"><span class="t">ç·¨è¼¯</span></button> '+
              '<button class="btn small danger" data-act="del" data-uid="'+escapeHtml(r.uid)+'"><span class="t">åˆªé™¤</span></button>'+
            '</td>'+
          '</tr>';
      }).join("");

      var localCnt = db.filter(function(x){ return x && norm(x.text); }).length;
      var cloudStr = lastCloudSyncAt ? (new Date(lastCloudSyncAt).toLocaleString()) : "â€”";
      subInfo.textContent = "æœ¬æ©Ÿè³‡æ–™ï¼š" + localCnt + " ç­†ã€€ï½œã€€é›²ç«¯ï¼š" + cloudStr;

      learnDictFromDb();
      refreshCloudUI();
    }

    function persist(){
      try{
        localStorage.setItem(DB_KEY, JSON.stringify(db));
        localStorage.setItem(COUNTER_KEY, String(counter));
      }catch(e){
        toast("âš ï¸ æœ¬æ©Ÿå„²å­˜å¤±æ•—ï¼ˆå¯èƒ½å®¹é‡ä¸è¶³ï¼‰");
      }
    }

    // -------------------------------
    // Edit modal
    // -------------------------------
    function openEdit(uid){
      var isNew = !uid;
      var r = isNew ? null : db.find(function(x){ return x.uid === uid; }) || null;

      editingUid = uid || null;

      editTitle.textContent = isNew ? "æ–°å¢äº‹é …" : "ç·¨è¼¯äº‹é …";
      editSub.textContent = isNew ? "" : ("ID=" + (r.id||"") + " / " + (r.uid||""));

      inText.value = r ? (r.text||"") : "";
      inTrade.value = r ? (r.trade||"") : "";
      inSystem.value = r ? (r.system||"") : "";
      inRemark.value = r ? (r.remark||"") : "";
      inDate.value = r ? (r.date||toDateInputValue(new Date())) : toDateInputValue(new Date());

      inUid.value = r ? (r.uid||"") : "(å„²å­˜å¾Œç”Ÿæˆ)";
      inId.value  = r ? String(r.id||"") : "(å„²å­˜å¾Œç”Ÿæˆ)";

      // attachments
      var atts = (r && Array.isArray(r.attach)) ? r.attach.slice() : [];
      renderAttList(atts);

      $("btnDelete").style.display = isNew ? "none" : "";
      editMask.classList.add("show");
      editMask.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
    }

    function closeEdit(){
      editMask.classList.remove("show");
      editMask.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
      editingUid = null;
    }

    function renderAttList(atts){
      attList._atts = atts || [];
      attList.innerHTML = (attList._atts.length ? attList._atts.map(function(a, i){
        return '<span class="attItem" data-act="attOpen" data-i="'+i+'">'+
          'ğŸ“ '+escapeHtml(a.name||("é™„ä»¶"+(i+1)))+
          ' <span class="x" data-act="attRemove" data-i="'+i+'">Ã—</span>'+
        '</span>';
      }).join("") : '<span style="color:rgba(255,255,255,.45);">â€” å°šæœªåŠ å…¥é™„ä»¶ â€”</span>');
    }

    function saveEdit(){
      var text = String(inText.value||"").trim();
      if(!text){
        toast("è«‹å…ˆè¼¸å…¥ã€Œè¨˜äº‹å…§å®¹ã€");
        return;
      }
      var trade = norm(inTrade.value);
      var system = norm(inSystem.value);
      var remark = String(inRemark.value||"");
      var date = norm(inDate.value) || toDateInputValue(new Date());

      var atts = Array.isArray(attList._atts) ? attList._atts.slice() : [];

      var beforeDb = db.slice();

      if(!editingUid){
        // create
        counter = Number(localStorage.getItem(COUNTER_KEY) || counter || 0);
        if(!Number.isFinite(counter)) counter = 0;
        counter += 1;

        var uid = genUid();
        var row = normalizeRow({
          id: counter,
          uid: uid,
          text: text,
          trade: trade,
          system: system,
          attach: atts,
          remark: remark,
          date: date
        });
        db.push(row);
        ensureCounterAtLeast(counter);
      }else{
        var idx = db.findIndex(function(x){ return x.uid === editingUid; });
        if(idx<0){
          toast("âš ï¸ æ‰¾ä¸åˆ°è¦ç·¨è¼¯çš„è³‡æ–™ï¼ˆå¯èƒ½å·²è¢«åˆªé™¤ï¼‰");
          closeEdit();
          return;
        }
        var cur = db[idx];
        var row2 = normalizeRow({
          id: cur.id,
          uid: cur.uid,
          text: text,
          trade: trade,
          system: system,
          attach: atts,
          remark: remark,
          date: date
        });
        db[idx] = row2;
      }

      try{
        saveSafetySnapshot("manual_save_before");
        rotateBackups(beforeDb);
      }catch(e){}

      persist();
      render();
      closeEdit();

      // cloud merged save
      if(cloud && Auth.canWrite()){
        cloud.saveMerged();
      }
    }

    function deleteRow(uid){
      var idx = db.findIndex(function(x){ return x.uid === uid; });
      if(idx<0) return;
      if(!confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†ï¼Ÿ")) return;

      var beforeDb = db.slice();
      db.splice(idx,1);

      try{
        saveSafetySnapshot("manual_delete_before");
        rotateBackups(beforeDb);
      }catch(e){}

      persist();
      render();

      if(cloud && Auth.canWrite()){
        cloud.saveMerged();
      }
    }

    // -------------------------------
    // Viewer
    // -------------------------------
    function openViewer(title, url){
      title = norm(title) || "é™„ä»¶";
      url = norm(url);
      if(!url){ toast("é™„ä»¶é€£çµç„¡æ•ˆ"); return; }

      viewSub.textContent = title;

      viewerImg.style.display = "none";
      viewerFrame.style.display = "block";

      // image?
      var lower = url.toLowerCase();
      var isImg = (/\.(png|jpg|jpeg|gif|webp|bmp)$/i).test(lower);

      if(isImg){
        viewerFrame.style.display = "none";
        viewerImg.style.display = "block";
        viewerImg.src = url;
      }else{
        // use iframe for pdf/html/office viewer link
        viewerFrame.src = url;
      }

      viewMask.classList.add("show");
      viewMask.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
    }

    function closeViewer(){
      viewMask.classList.remove("show");
      viewMask.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
      viewerFrame.src = "about:blank";
      viewerImg.src = "";
    }

    // -------------------------------
    // Export / import
    // -------------------------------
    function exportFile(){
      var payload = exportPayload();
      var blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
      var a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "sxdh-notes_export_" + (new Date().toISOString().slice(0,10)) + ".json";
      a.click();
      setTimeout(function(){ URL.revokeObjectURL(a.href); }, 5000);
    }

    function importFile(){
      var input = document.createElement("input");
      input.type = "file";
      input.accept = "application/json,.json";
      input.onchange = function(){
        var f = input.files && input.files[0];
        if(!f) return;
        var fr = new FileReader();
        fr.onload = function(){
          try{
            var obj = JSON.parse(fr.result);
            // reuse importPayload flow
            importPayload(obj, { merged:false, conflicts:false });
            render();
            toast("åŒ¯å…¥å®Œæˆ");
            if(cloud && Auth.canWrite()){
              cloud.saveMerged();
            }
          }catch(e){
            toast("âš ï¸ åŒ¯å…¥å¤±æ•—ï¼šJSON æ ¼å¼éŒ¯èª¤");
          }
        };
        fr.readAsText(f);
      };
      input.click();
    }

    // -------------------------------
    // Cloud getLocal / payload
    // -------------------------------
    function buildSettingsRow(){
      var tradeDict = loadDict(TRADE_DICT_KEY);
      var sysDict = loadDict(SYS_DICT_KEY);
      var tradeSysMap = loadTradeSysMap();
      return {
        k: SETTINGS_UID,
        v: {
          schema: PAGE_SCHEMA,
          pageKey: PAGE_KEY,
          tradeDict: tradeDict,
          sysDict: sysDict,
          tradeSysMap: tradeSysMap,
          updatedAt: nowISO()
        }
      };
    }

    function exportPayload(){
      // merge-table: [{k, v}, ...]
      var list = db.map(function(r){
        return { k: r.uid, v: r };
      });
      list.unshift(buildSettingsRow());

      // counter
      var maxId = 0;
      db.forEach(function(r){ if(Number(r.id||0)>maxId) maxId = Number(r.id||0); });
      var cnt = Math.max(Number(counter||0), maxId);
      if(!Number.isFinite(cnt)) cnt = maxId;

      return {
        schema: PAGE_SCHEMA,
        pageKey: PAGE_KEY,
        counter: cnt,
        db: list
      };
    }

    // -------------------------------
    // âœ…âœ…âœ… B) é˜²ä¸²é /åªå¥—ç”¨æ­£ç¢ºè³‡æ–™ï¼šæ›¿æ› importPayload()
    // -------------------------------
    function importPayload(payload, info){
      payload = (payload && typeof payload==="object") ? payload : {};
      var arr = Array.isArray(payload.db) ? payload.db : [];

      // æœ¬æ©Ÿç¾æ³
      var beforeDb = Array.isArray(db) ? db.slice() : [];
      var localCount = beforeDb
        .map(normalizeRow).filter(Boolean)
        .filter(function(r){ return r.text && r.text.toString().trim(); }).length;

      // ===== æ‰¾ settingsï¼ˆæœ¬é å”¯ä¸€è­˜åˆ¥ï¼‰=====
      var srow = null;
      for(var i=0;i<arr.length;i++){
        var it = arr[i];
        var kk = norm(it && (it.k ?? it.uid ?? it.key));
        if(kk === SETTINGS_UID || norm(it && it.uid) === SETTINGS_UID){
          srow = it; break;
        }
      }

      // ===== åˆ¤æ–·é€™ä»½ payload æ˜¯å¦ã€Œåƒæœ¬é è³‡æ–™ã€=====
      function looksLikeNotesPayload(list){
        if(!Array.isArray(list) || list.length===0) return false;
        for(var j=0;j<list.length;j++){
          var r = list[j] || {};
          // merge-table: {k,v:{text...}} æˆ– ç›´æ¥ {text...}
          var v = (r && typeof r==="object" && "v" in r) ? r.v : null;
          if(v && typeof v==="string"){ try{ v = JSON.parse(v); }catch(e){} }
          var cand = (v && typeof v==="object") ? v : r;
          var t = (cand.text ?? cand.content ?? cand.note ?? cand.memo);
          if(t && String(t).trim()) return true;
        }
        return false;
      }

      var sv = null, schema = "", pageKeyRemote = "";
      if(srow){
        sv = (srow && typeof srow==="object") ? (srow.v || srow) : null;
        schema = sv && sv.schema ? norm(sv.schema) : "";
        pageKeyRemote = sv && (sv.pageKey || sv.page) ? norm(sv.pageKey || sv.page) : "";
      }

      // ===== 1) æœ‰ settings ä½† schema/pageKey ä¸ç¬¦ â†’ ä¸€å¾‹è¦–ç‚ºä¸²é ï¼Œæ‹’çµ•å¥—ç”¨ =====
      if(srow && ((schema && schema !== PAGE_SCHEMA) || (pageKeyRemote && pageKeyRemote !== PAGE_KEY))){
        var msg1 = "âš ï¸ åµæ¸¬åˆ°é›²ç«¯è³‡æ–™ä¸æ˜¯æœ¬é ï¼ˆ" +
          (schema ? ("schema=" + schema) : "schema=?") + " / " +
          (pageKeyRemote ? ("pageKey=" + pageKeyRemote) : "pageKey=?") +
          "ï¼‰ï¼Œå·²ä¿è­·æœ¬é è³‡æ–™ä¸è¢«è¦†å¯«ã€‚";
        toast(msg1);

        // å˜—è©¦å¾å®‰å…¨å¿«ç…§é‚„åŸï¼ˆå¦‚æœæœ¬æ©Ÿè¢«éŒ¯èª¤è¦†å¯«éï¼‰
        if((!Array.isArray(db) || db.length===0) && localCount===0){
          try{ restoreFromSafetySnapshot(false); }catch(e){}
        }

        // è‹¥æœ¬æ©Ÿæœ‰è³‡æ–™ä¸”å¯å¯«ï¼Œå˜—è©¦ç”¨æœ¬é è³‡æ–™å›å¯«é›²ç«¯ï¼ˆé¿å…ä¸€ç›´è¢«ä¸²ï¼‰
        if(Auth.canWrite() && Array.isArray(db) && db.length>0 && cloud){
          setTimeout(function(){ cloud.saveMerged(); }, 0);
        }
        return;
      }

      // ===== 2) æ²’ settingsï¼šåªæœ‰åœ¨ã€Œçœ‹èµ·ä¾†åƒæœ¬é è³‡æ–™ã€æ‰å…è¨±å¥—ç”¨ï¼›å¦å‰‡è¦–ç‚ºä¸²é /èª¤ç”¨ key =====
      if(!srow && arr.length>0 && !looksLikeNotesPayload(arr)){
        toast("âš ï¸ é›²ç«¯è³‡æ–™ç¼ºå°‘ settings ä¸”æ ¼å¼ä¸åƒæœ¬é è¨˜äº‹è³‡æ–™ï¼Œå·²ç•¥éå¥—ç”¨ï¼ˆé¿å…ä¸²é ï¼‰ã€‚");

        // è‹¥æœ¬æ©Ÿç›®å‰æ˜¯ç©ºçš„ï¼Œå˜—è©¦å¾å®‰å…¨å¿«ç…§é‚„åŸ
        if((!Array.isArray(db) || db.length===0) && localCount===0){
          try{ restoreFromSafetySnapshot(false); }catch(e){}
        }

        // è‹¥æœ¬æ©Ÿæœ‰è³‡æ–™ä¸”å¯å¯«ï¼Œå›å¯«ä¿®å¾©é›²ç«¯ï¼ˆæŠŠæ­£ç¢ºè³‡æ–™æ¨å›æœ¬ keyï¼‰
        if(Auth.canWrite() && Array.isArray(db) && db.length>0 && cloud){
          setTimeout(function(){ cloud.saveMerged(); }, 0);
        }
        return;
      }

      // ===== æœ‰ settingsï¼šåŒæ­¥å­—å…¸ï¼ˆä¿ç•™ä½ åŸæœ¬é‚è¼¯ï¼‰=====
      if(srow && sv){
        if(Array.isArray(sv.tradeDict)) saveDict(TRADE_DICT_KEY, sv.tradeDict.map(norm).filter(Boolean));
        if(Array.isArray(sv.sysDict)) saveDict(SYS_DICT_KEY, sv.sysDict.map(norm).filter(Boolean));
        if(sv.tradeSysMap && typeof sv.tradeSysMap==="object") saveTradeSysMap(sv.tradeSysMap);
      }

      // å¥—ç”¨å‰å…ˆå‚™ä»½
      if(beforeDb.length>0){
        try{
          saveSafetySnapshot("before_cloud_apply");
          rotateBackups(beforeDb);
        }catch(e){}
      }

      // ===== åŒ¯å…¥è³‡æ–™åˆ—ï¼ˆä¿ç•™ä½ åŸæœ¬æµç¨‹ï¼Œä½†åªä¿ç•™æœ‰ text çš„è¨˜äº‹åˆ—ï¼‰=====
      var incoming = arr
        .filter(function(r){
          var kk2 = norm(r && (r.k ?? r.uid ?? r.key));
          return kk2 !== SETTINGS_UID;
        })
        .map(function(r){
          if(r && typeof r==="object" && ("v" in r) && (r.k!==undefined || r.key!==undefined)){
            var inner = r.v;
            if(typeof inner === "string"){ try{ inner = JSON.parse(inner); }catch(e){} }
            if(inner && typeof inner==="object"){
              var obj = Object.assign({}, inner);
              obj.uid = norm(r.k ?? r.key ?? obj.uid ?? "");
              obj.id = Number(r.id||obj.id||0);
              obj.text = obj.text ?? obj.content ?? obj.note ?? obj.memo ?? "";
              return obj;
            }
          }
          return r;
        })
        .map(normalizeRow)
        .filter(Boolean)
        .filter(function(r){ return r.text && r.text.toString().trim(); });

      var incomingCount = incoming.length;

      // ===== 3) é›²ç«¯æ˜¯ç©ºï¼ˆæˆ–å…¨éƒ½ä¸æ˜¯è¨˜äº‹åˆ—ï¼‰ï¼šä¿è­·æœ¬æ©Ÿä¸è¢«è¦†å¯«ï¼Œä¸¦å˜—è©¦æ¨å›é›²ç«¯ =====
      if(incomingCount === 0){
        if(localCount > 0){
          try{
            if(!sessionStorage.getItem(PROTECT_EMPTY_REMOTE_KEY)){
              sessionStorage.setItem(PROTECT_EMPTY_REMOTE_KEY, "1");
              toast("âš ï¸ é›²ç«¯ç›®å‰ç©ºç™½/ç„¡æœ‰æ•ˆè¨˜äº‹ï¼šå·²ä¿è­·æœ¬æ©Ÿè³‡æ–™ï¼Œå°‡å˜—è©¦æ¨é€åˆä½µåˆ°é›²ç«¯â€¦");
              if(cloud && Auth.canWrite()){
                setTimeout(function(){ cloud.saveMerged(); }, 0);
              }
            }
          }catch(e){}
          return;
        }else{
          // æœ¬æ©Ÿä¹Ÿç©º â†’ å˜—è©¦å¿«ç…§é‚„åŸ
          try{ restoreFromSafetySnapshot(false); }catch(e){}
          return;
        }
      }

      // ===== æ­£å¸¸å¥—ç”¨ =====
      db = incoming;

      var maxId2 = 0;
      for(var k=0;k<db.length;k++){
        var n = Number(db[k].id||0);
        if(Number.isFinite(n) && n>maxId2) maxId2 = n;
      }
      var cnt = Number(payload.counter||0);
      if(!Number.isFinite(cnt)) cnt = 0;
      ensureCounterAtLeast(Math.max(cnt, maxId2));

      try{
        if(Array.isArray(db) && db.length>0) saveSafetySnapshot("after_cloud_apply");
        localStorage.setItem(DB_KEY, JSON.stringify(db));
      }catch(e){}

      lastCloudSyncAt = Date.now();
      if(info && (info.conflicts || info.merged)){
        toast("é›²ç«¯åˆä½µå®Œæˆ");
      }
    }

    // -------------------------------
    // Cloud init/mount (æœ€ç©©å…¼å®¹ç‰ˆ)
    // -------------------------------
    function refreshCloudUI(){
      if(!cloud){
        cloudDot.style.background = "rgba(255,255,255,.35)";
        cloudTxt.textContent = "é›²ç«¯ï¼šæœªåˆå§‹åŒ–";
        return;
      }
      try{
        var st = cloud.status ? cloud.status() : null;
        var ok = st && (st.ok || st.ready || st.inited);
        cloudDot.style.background = ok ? "rgba(120,255,160,.85)" : "rgba(255,210,120,.85)";
        cloudTxt.textContent = "é›²ç«¯ï¼š" + (st && st.text ? st.text : (ok ? "å·²é€£ç·š" : "å¯ç”¨"));
      }catch(e){
        cloudDot.style.background = "rgba(255,210,120,.85)";
        cloudTxt.textContent = "é›²ç«¯ï¼šå¯ç”¨";
      }
    }

    function initCloud(){
      if(!window.TasunCloudKit || typeof window.TasunCloudKit.init!=="function"){
        refreshCloudUI();
        return;
      }

      // âœ… initï¼ˆresourcesUrl å›ºå®šç”¨ tasun-resources.jsonï¼‰
      window.TasunCloudKit.init({
        appVer: APP_VER,
        resourcesUrl: "tasun-resources.json",
        ui: { enabled:true, hideLockButtons:true, position:"bottom-right" },
        lock: { enabled:false, auto:false }
      });

      // âœ… mountï¼ˆresourceKey / pk å›ºå®šï¼‰
      cloud = window.TasunCloudKit.mount({
        resourceKey: PAGE_KEY,
        pk: PK_FIELD,
        getLocal: function(){
          return exportPayload();
        },
        apply: function(payload, info){
          importPayload(payload, info);
          render();
        }
      });

      refreshCloudUI();
    }

    // -------------------------------
    // Events
    // -------------------------------
    $("btnBack").addEventListener("click", function(){
      // ä½ å¯æ”¹æˆä½ è¦å›å»çš„é é¢
      location.href = "index.html";
    });

    $("btnAdd").addEventListener("click", function(){ openEdit(null); });
    $("btnEditClose").addEventListener("click", closeEdit);
    editMask.addEventListener("click", function(e){
      if(e.target === editMask) closeEdit();
    });

    $("btnSave").addEventListener("click", saveEdit);

    $("btnDelete").addEventListener("click", function(){
      if(!editingUid) return;
      closeEdit();
      deleteRow(editingUid);
    });

    $("btnAddAtt").addEventListener("click", function(){
      var name = prompt("é™„ä»¶åç¨±ï¼ˆå¯ç•™ç©ºï¼‰","");
      if(name===null) return;
      var url = prompt("é™„ä»¶é€£çµ URLï¼ˆå¯è²¼ Dropbox/Drive/ç¶²è·¯ç¡¬ç¢Ÿ/åœ–ç‰‡/PDF é€£çµï¼‰","");
      if(url===null) return;
      url = norm(url);
      if(!url){ toast("é™„ä»¶é€£çµä¸å¯ç©ºç™½"); return; }
      var atts = Array.isArray(attList._atts) ? attList._atts.slice() : [];
      atts.push({ name: norm(name) || guessNameFromUrl(url), url: url });
      renderAttList(atts);
    });

    $("btnOpenDisk").addEventListener("click", function(){
      if(!NET_DISK_URL){
        toast("å°šæœªè¨­å®šç¶²è·¯ç¡¬ç¢Ÿé€£çµï¼ˆå¯å­˜åˆ° localStorage: tasunNetDiskUrl_v1ï¼‰");
        return;
      }
      window.open(NET_DISK_URL, "_blank", "noopener,noreferrer");
    });

    attList.addEventListener("click", function(e){
      var t = e.target;
      var act = t && t.getAttribute("data-act");
      var i = Number(t && t.getAttribute("data-i"));
      if(!act) return;

      var atts = Array.isArray(attList._atts) ? attList._atts.slice() : [];

      if(act==="attRemove"){
        if(Number.isFinite(i) && i>=0 && i<atts.length){
          atts.splice(i,1);
          renderAttList(atts);
        }
        return;
      }
      if(act==="attOpen"){
        if(Number.isFinite(i) && i>=0 && i<atts.length){
          openViewer(atts[i].name, atts[i].url);
        }
        return;
      }
    });

    $("btnViewClose").addEventListener("click", closeViewer);
    $("btnViewCancel").addEventListener("click", closeViewer);
    viewMask.addEventListener("click", function(e){
      if(e.target === viewMask) closeViewer();
    });

    $("btnViewDisk").addEventListener("click", function(){
      if(!NET_DISK_URL){
        toast("å°šæœªè¨­å®šç¶²è·¯ç¡¬ç¢Ÿé€£çµï¼ˆå¯å­˜åˆ° localStorage: tasunNetDiskUrl_v1ï¼‰");
        return;
      }
      window.open(NET_DISK_URL, "_blank", "noopener,noreferrer");
    });

    $("btnExport").addEventListener("click", exportFile);
    $("btnImport").addEventListener("click", importFile);

    $("btnBackup").addEventListener("click", function(){
      try{
        saveSafetySnapshot("manual_backup");
        rotateBackups(db.slice());
        toast("å·²å»ºç«‹å‚™ä»½/å¿«ç…§");
      }catch(e){
        toast("âš ï¸ å‚™ä»½å¤±æ•—");
      }
    });

    $("btnWipe").addEventListener("click", function(){
      if(!confirm("ç¢ºå®šæ¸…ç©ºæœ¬æ©Ÿè³‡æ–™ï¼Ÿï¼ˆä¸æœƒç«‹åˆ»åˆªé›²ç«¯ï¼‰")) return;
      try{
        saveSafetySnapshot("before_wipe");
        rotateBackups(db.slice());
      }catch(e){}
      db = [];
      counter = 0;
      persist();
      render();
      toast("æœ¬æ©Ÿå·²æ¸…ç©º");
    });

    $("btnPull").addEventListener("click", function(){
      if(!cloud || !cloud.pullNow){
        toast("é›²ç«¯å°šæœªåˆå§‹åŒ–");
        return;
      }
      cloud.pullNow();
      toast("é›²ç«¯åŒæ­¥ä¸­â€¦");
    });

    tbody.addEventListener("click", function(e){
      var t = e.target;
      // buttons contain span.t
      var btn = t && (t.closest ? t.closest("[data-act]") : null);
      if(!btn) btn = t && t.getAttribute && t.getAttribute("data-act") ? t : null;
      if(!btn) return;

      var act = btn.getAttribute("data-act");
      var uid = btn.getAttribute("data-uid");
      var i = btn.getAttribute("data-i");

      if(act==="edit"){
        openEdit(uid);
        // fill attachments current
        var r = db.find(function(x){ return x.uid===uid; });
        if(r) renderAttList((r.attach||[]).slice());
        inUid.value = r ? (r.uid||"") : "";
        inId.value = r ? String(r.id||"") : "";
        return;
      }
      if(act==="del"){
        deleteRow(uid);
        return;
      }
      if(act==="viewAtt"){
        var rr = db.find(function(x){ return x.uid===uid; });
        if(!rr || !Array.isArray(rr.attach)) return;
        var idx = Number(i);
        if(!Number.isFinite(idx) || idx<0 || idx>=rr.attach.length) return;
        openViewer(rr.attach[idx].name, rr.attach[idx].url);
        return;
      }
    });

    // -------------------------------
    // Boot
    // -------------------------------
    function loadLocal(){
      db = safeJSONParse(localStorage.getItem(DB_KEY)||"[]", []);
      if(!Array.isArray(db)) db = [];
      db = db.map(normalizeRow).filter(Boolean);

      counter = Number(localStorage.getItem(COUNTER_KEY) || 0);
      if(!Number.isFinite(counter)) counter = 0;

      // if counter too small, fix
      var maxId = 0;
      db.forEach(function(r){ if(Number(r.id||0)>maxId) maxId = Number(r.id||0); });
      ensureCounterAtLeast(maxId);
    }

    loadLocal();
    refreshDatalist();
    render();
    initCloud();

    // auto pull once
    if(cloud && cloud.pullNow){
      cloud.pullNow();
    }

    // expose for debug
    window.__SXDHL = {
      get db(){ return db; },
      setRole: function(role){ Auth.role = String(role||"read"); localStorage.setItem("tasunRole_v1", Auth.role); toast("Role=" + Auth.role); },
      saveMerged: function(){ if(cloud && cloud.saveMerged) cloud.saveMerged(); },
      pull: function(){ if(cloud && cloud.pullNow) cloud.pullNow(); },
      restore: function(){ restoreFromSafetySnapshot(true); }
    };

  })();
  </script>
</body>
</html>
