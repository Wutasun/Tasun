<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>捷運汐東線事項記錄 · Tasun</title>

  <link rel="icon" href="data:,">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- ✅ 全站版本：可與 tasun-version.json 一致（本頁只用於 cache busting/顯示） -->
  <script>window.TASUN_APP_VER="20260224_01";</script>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700;800;900&family=Noto+Serif+TC:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#dbe3e1; --bg1:#c7d4d1;
      --ink:#111;
      --paper: rgba(255,255,255,.96);
      --paper2: rgba(255,255,255,.92);
      --border: rgba(0,0,0,.18);
      --border2: rgba(0,0,0,.28);
      --r:18px;
      --shadow: 0 16px 44px rgba(0,0,0,.10);
      --shadow2: 0 10px 26px rgba(0,0,0,.08);

      --goldHi: rgba(255,254,246,.98);
      --goldText: rgba(246,214,150,.98);
      --goldDeep: rgba(170,110,18,.98);

      --strokeBlack: rgba(0,0,0,.58);
      --olPx: .78px;

      --titleSize: clamp(28px, 2.6vw, 42px);
      --subSize:   clamp(12.5px, 1.05vw, 15.5px);
      --labelSize: clamp(13.5px, 1.00vw, 15.5px);
      --ctrlSize:  clamp(13.5px, 1.05vw, 16px);
      --thSize:    clamp(15px, 1.10vw, 17px);
      --tdSize:    clamp(14.5px, 1.06vw, 16.5px);
      --readBody:  clamp(14.5px, 1.10vw, 17.5px);

      --btnFont: clamp(14.5px, 1.12vw, 17px);
      --btnFontSmall: clamp(13.5px, 1.06vw, 16px);

      /* ✅ 修訂 1：舞台兩側距離網頁邊框固定 1cm（桌機） */
      --stageSide: 1cm;

      --tableWrapBg: rgba(255,252,244,.94);
      --tableBg: rgba(255,252,244,.92);
      --tableHeadBg: rgba(252,240,218,.96);
      --tableStripe: rgba(40,120,90,.035);
      --tableHover: rgba(170,110,18,.060);
      --tableSel: rgba(170,110,18,.120);
      --tableLine: rgba(90,60,20,.180);
      --tableText: rgba(22,18,14,.92);
      --tableMuted: rgba(90,60,20,.55);

      --btnBg1: rgba(255,255,255,.70);
      --btnBg2: rgba(255,255,255,.54);
      --btnBgGhost1: rgba(255,255,255,.62);
      --btnBgGhost2: rgba(255,255,255,.46);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    html{
      background:
        radial-gradient(1000px 560px at 50% 120px, rgba(255,255,255,.55), transparent 64%),
        radial-gradient(1200px 900px at 32% 36%, rgba(255,255,255,.40), transparent 68%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    body{
      margin:0; color:var(--ink);
      font-family:"Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      background: inherit;
      overflow:hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    :where(.sub,.label,.pill,.hint,.miniHint,.loginErr,.loginHint,.toast, thead th, tbody td, .noteTag,.noteNo,.noteBody){
      text-shadow:none !important; filter:none !important;
    }

    .goldCrystal{
      display:inline-block;
      --_ol: var(--strokeBlack); --_olpx: var(--olPx);
      background: linear-gradient(180deg, var(--goldHi) 0%, rgba(255,246,224,.98) 18%, var(--goldText) 46%, rgba(226,156,54,.98) 78%, var(--goldHi) 100%);
      -webkit-background-clip:text; background-clip:text;
      color: var(--goldDeep);
      text-shadow:
        var(--_olpx) 0 0 var(--_ol), calc(var(--_olpx)*-1) 0 0 var(--_ol),
        0 var(--_olpx) 0 var(--_ol), 0 calc(var(--_olpx)*-1) 0 var(--_ol),
        var(--_olpx) var(--_olpx) 0 var(--_ol), var(--_olpx) calc(var(--_olpx)*-1) 0 var(--_ol),
        calc(var(--_olpx)*-1) var(--_olpx) 0 var(--_ol), calc(var(--_olpx)*-1) calc(var(--_olpx)*-1) 0 var(--_ol);
    }
    @supports (-webkit-background-clip:text) or (background-clip:text){
      .goldCrystal{ color: transparent; -webkit-text-fill-color: transparent; }
    }

    .wrap{
      width:min(1720px, calc(100vw - (2*var(--stageSide))));
      margin:0 auto;
      padding: 18px 16px 18px;
      height:100vh;
      display:flex; flex-direction:column; gap:16px;
    }

    .topbar{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      gap:12px; align-items:center;
      padding:14px 14px;
      border:1px solid var(--border2);
      border-radius:var(--r);
      background: linear-gradient(180deg, var(--paper), var(--paper2));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    @media (max-width:920px){
      .topbar{grid-template-columns:1fr}
      .nav-left{order:0} .brand{order:1} .right{order:2; justify-content:flex-start}
    }

    .nav-left{display:flex; gap:10px; flex-wrap:wrap; align-items:center; min-width:220px;}
    .nav-desktop{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .nav-mobile{display:none; gap:10px; align-items:center; width:100%;}
    @media (max-width:600px){ .nav-desktop{display:none;} .nav-mobile{display:flex;} }

    .brand{display:flex; flex-direction:column; gap:6px; align-items:center; justify-content:center; text-align:center;}
    .title{font-family:"Noto Serif TC","Noto Sans TC",serif; font-weight:820; letter-spacing:.10em; font-size:var(--titleSize); line-height:1.12;}
    .sub{font-size:var(--subSize); color:rgba(0,0,0,.55); letter-spacing:.10em; font-weight:700;}

    .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; min-width:220px;}
    .pill{
      padding:9px 12px; border-radius:999px; border:1px solid var(--border);
      background: rgba(255,255,255,.90); font-size:14px; color: rgba(0,0,0,.78);
      display:flex; gap:8px; align-items:center; white-space:nowrap;
      box-shadow: var(--shadow2); font-weight:800; letter-spacing:.03em;
    }
    .pill b{font-weight:900; color: rgba(0,0,0,.86);}

    .btn{
      position:relative; appearance:none;
      border:1px solid var(--border2);
      background: linear-gradient(180deg, var(--btnBg1), var(--btnBg2));
      padding:11px 16px; border-radius:999px;
      cursor:pointer; font-family:inherit;
      font-weight:720; letter-spacing:.05em;
      font-size: var(--btnFont);
      box-shadow: 0 12px 22px rgba(0,0,0,.10);
      transition:transform .12s ease, border-color .12s ease, box-shadow .12s ease;
      user-select:none; white-space:nowrap;
      color: rgba(0,0,0,.82); overflow:hidden;
    }
    .btn::before{
      content:""; position:absolute; inset:0; pointer-events:none;
      background: radial-gradient(240px 110px at 26% 20%, rgba(255,255,255,.12), transparent 66%);
      opacity:.28; z-index:0;
    }
    .btn:hover{transform:translateY(-1px); border-color: rgba(0,0,0,.40); box-shadow: 0 14px 26px rgba(0,0,0,.12);}
    .btn:active{transform:none}
    .btn.ghost{ background: linear-gradient(180deg, var(--btnBgGhost1), var(--btnBgGhost2)); border:1px solid var(--border); }
    .btn.danger{ border-color: rgba(0,0,0,.42); }
    .small{ padding:10px 14px; font-size: var(--btnFontSmall); }
    .btn[disabled]{opacity:.45; cursor:not-allowed; transform:none !important;}
    .btn .t{
      position:relative; z-index:1; display:inline-block;
      color: rgba(120,64,6,.98);
      font-weight:700; letter-spacing:.04em; line-height:1.12;
      text-shadow:none !important;
    }

    .panel{
      border:1px solid var(--border2);
      border-radius:var(--r);
      background: linear-gradient(180deg, var(--paper), var(--paper2));
      box-shadow: var(--shadow);
      padding:14px;
      flex:1; min-height:0;
      display:flex; flex-direction:column;
      overflow:hidden;
    }

    .panelHead{display:flex; flex-direction:column; gap:10px; flex:0 0 auto;}
    .controls{display:grid; grid-template-columns: 1.3fr .9fr .9fr auto; gap:10px; align-items:end;}
    @media (max-width:920px){ .controls{grid-template-columns:1fr 1fr} }
    @media (max-width:520px){ .controls{grid-template-columns:1fr} }

    .field{display:flex; flex-direction:column; gap:6px;}
    .label{font-size:var(--labelSize); letter-spacing:.08em; font-weight:700; color: rgba(0,0,0,.70); text-align:center;}
    input,select,textarea{
      width:100%;
      border-radius:14px; border:1px solid var(--border2);
      background: rgba(255,255,255,.96); color: rgba(0,0,0,.86);
      padding:11px 12px; font-family:inherit;
      font-size:var(--ctrlSize); font-weight:700;
      outline:none; transition:border-color .12s ease, box-shadow .12s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
    }
    input:focus,select:focus,textarea:focus{ border-color: rgba(0,0,0,.46); box-shadow: 0 0 0 3px rgba(0,0,0,.08), 0 12px 26px rgba(0,0,0,.10); }
    textarea{min-height:92px; resize:vertical;}
    select{ text-align:center; text-align-last:center; font-weight:800; }
    select option{ background:#fff; color: rgba(0,0,0,.88); }

    .hint{
      display:flex; flex-wrap:wrap; gap:8px;
      align-items:center; justify-content:center;
      padding:9px 10px;
      border-radius:14px; border:1px solid var(--border);
      background: rgba(255,255,255,.92);
      box-shadow: 0 12px 26px rgba(0,0,0,.08);
      color: rgba(0,0,0,.78);
      font-size:14px; line-height:1.55;
      font-weight:900; letter-spacing:.04em;
    }
    .hint .hb{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(0,0,0,.14); background: rgba(255,255,255,.86); white-space:nowrap; }
    .hint .hb .k{ color: rgba(0,0,0,.62); font-weight:900; }
    .hint .hb .v{ color: rgba(0,0,0,.84); font-weight:900; }
    .hint .hb.bad .v{ color: rgba(170,60,60,.92); }

    .panelBody{flex:1; min-height:0; display:flex; flex-direction:column;}
    .tableWrap{
      margin-top:4px;
      overflow:auto;
      border-radius:16px;
      border:1px solid var(--border2);
      background: var(--tableWrapBg);
      box-shadow: var(--shadow2);
      flex:1; min-height:0;
      -webkit-overflow-scrolling: touch;
    }

    table{width:100%; border-collapse:collapse; min-width:1460px; background: var(--tableBg);}
    thead th{
      position:sticky; top:0; z-index:3;
      padding:13px 10px;
      border-bottom:1px solid var(--tableLine);
      white-space:nowrap; text-align:center;
      letter-spacing:.06em;
      font-size: var(--thSize);
      font-weight:900;
      color: rgba(30,22,16,.92);
      background: var(--tableHeadBg);
    }
    tbody td{
      padding:13px 10px;
      border-bottom:1px solid var(--tableLine);
      vertical-align:top;
      font-size: var(--tdSize);
      color: var(--tableText);
      line-height:1.75;
      font-weight:700;
      background: transparent;
    }
    tbody tr:nth-child(even) td{ background: var(--tableStripe); }
    tbody tr:hover td{ background: var(--tableHover); }
    tbody tr.sel td{ background: var(--tableSel); }
    .muted{ color: var(--tableMuted); }

    .attBtn{
      display:inline-flex; align-items:center; justify-content:center; gap:6px;
      padding:9px 12px; border-radius:999px;
      border:1px solid var(--border2); background: rgba(255,255,255,.88);
      cursor:pointer; white-space:nowrap;
      box-shadow: 0 10px 20px rgba(0,0,0,.08);
      font-weight:900;
    }
    .attBtn .t{ color: rgba(0,0,0,.82); letter-spacing:.04em; font-weight:900; }

    .mask,.pMask,.loginMask{
      position:fixed; inset:0;
      display:none; align-items:center; justify-content:center;
      padding:20px; z-index:100;
      background: rgba(0,0,0,.45);
    }
    .modal,.pModal,.loginModal{
      width:min(980px, 96vw);
      border-radius:22px; border:1px solid var(--border2);
      background: rgba(255,255,255,.98);
      box-shadow:0 32px 110px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .pModal,.loginModal{ width:min(560px, 96vw); }
    .mHead,.pHead,.loginHead{
      padding:14px 16px;
      display:grid; grid-template-columns: 1fr auto 1fr;
      align-items:center; gap:10px;
      border-bottom:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.98);
      min-height:56px;
    }
    .mTitle,.pTitle,.loginTitle{
      grid-column:2; justify-self:center;
      letter-spacing:.14em;
      font-family:"Noto Serif TC","Noto Sans TC",serif;
      font-size: clamp(16px, 1.6vw, 22px);
      font-weight:900; white-space:nowrap;
    }
    .mHead .btn,.pHead .btn,.loginHead .btn{ grid-column:3; justify-self:end; }
    .mBody,.pBody,.loginBody{ padding:14px 16px 10px; color: rgba(0,0,0,.86); }
    .mFoot,.pFoot,.loginFoot{
      padding:12px 16px;
      display:flex; gap:10px;
      justify-content:flex-end; flex-wrap:wrap;
      border-top:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.98);
    }

    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .span2{grid-column:span 2}
    @media (max-width:720px){
      .grid{grid-template-columns:1fr}
      .span2{grid-column:span 1}
      table{min-width:1240px}
    }
    .inline2{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end}
    @media (max-width:520px){
      .inline2{ grid-template-columns: 1fr; }
      .mHead,.pHead,.loginHead{ grid-template-columns: 1fr auto; }
      .mTitle,.pTitle,.loginTitle{ grid-column:1; justify-self:start; }
      .mHead .btn,.pHead .btn,.loginHead .btn{ grid-column:2; }
    }

    .miniHint{font-size:12px; line-height:1.6; font-weight:700; color: rgba(0,0,0,.55); text-align:center;}
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px; padding:10px 14px;
      border-radius:999px; border:1px solid var(--border2);
      background: rgba(255,255,255,.96); color: rgba(0,0,0,.84);
      font-size:14px; box-shadow: 0 18px 50px rgba(0,0,0,.20);
      display:none; z-index:200; font-weight:800; letter-spacing:.06em;
    }
    .loginErr{
      margin-top:10px; color:rgba(170,60,60,.95);
      font-size:14px; line-height:1.6; display:none; white-space:pre-wrap;
      font-weight:900; text-align:center;
    }
    .loginHint{ margin-top:10px; color: rgba(0,0,0,.60); font-size:12.5px; line-height:1.7; font-weight:700; text-align:center; }

    body.readMode #tbl{ display:none; }
    body.readMode #cards{ display:block !important; padding:10px 6px; }
    body:not(.readMode) #tbl{ display:table; }
    body:not(.readMode) #cards{ display:none !important; }

    #cards{display:none; overflow:auto; max-height:100%; -webkit-overflow-scrolling: touch;}
    .noteCard{
      border-radius:16px; border:1px solid var(--border2);
      background: rgba(255,255,255,.96);
      box-shadow: 0 14px 26px rgba(0,0,0,.10);
      padding:12px; margin:10px 4px;
      color: rgba(0,0,0,.86); cursor:pointer;
    }
    .noteCard.sel{ outline: 2px solid rgba(0,0,0,.18); box-shadow: 0 18px 34px rgba(0,0,0,.12); }
    .noteHead{ display:flex; gap:10px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
    .noteMeta{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; font-weight:900; letter-spacing:.04em; }
    .noteTag{
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(0,0,0,.14);
      background: rgba(0,0,0,.03);
      color: rgba(0,0,0,.78);
      font-size:13px; white-space:nowrap;
    }
    .noteNo{ font-family:"Noto Serif TC","Noto Sans TC",serif; font-weight:900; letter-spacing:.06em; color: rgba(0,0,0,.88); white-space:nowrap; }
    .noteBody{
      margin-top:10px; line-height:1.85;
      font-size: var(--readBody);
      white-space:pre-wrap; word-break:break-word;
      color: rgba(0,0,0,.86);
    }
    .noteCard:not(.open) .noteBody{
      display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;
    }
    .noteMore{ margin-top:10px; display:none; opacity:.92; }
    .noteCard.open .noteMore{ display:block; }

    @media (max-width:720px){
      :root{
        /* 手機維持原本緊湊邊距 */
        --stageSide: 10px;
        --titleSize: clamp(20px, 5.0vw, 28px);
        --subSize: clamp(11px, 3.2vw, 13px);
        --btnFont: 14px;
        --btnFontSmall: 13px;
      }
      .wrap{ height:100dvh; padding:10px 10px 12px; gap:10px; }
      .topbar{ padding:10px; gap:10px; }
      .brand{ gap:4px; }
      .pill{ padding:6px 9px; font-size:12.5px; box-shadow: 0 10px 18px rgba(0,0,0,.08); }
      .right{ gap:8px; }
      .btn{ padding:9px 12px; box-shadow: 0 10px 16px rgba(0,0,0,.10); }
      .small{ padding:8px 10px; }
      .panel{ padding:10px; }
      .panelHead{ gap:8px; position:sticky; top:0; z-index:6; background: transparent; }
      .controls{ gap:8px; }
      input,select,textarea{ padding:10px 11px; border-radius:12px; }
      .hint{ justify-content:flex-start; flex-wrap:nowrap; overflow:auto; -webkit-overflow-scrolling: touch; padding:7px 8px; gap:7px; }
      .hint .hb{ flex:0 0 auto; padding:5px 9px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="nav-left">
        <div class="nav-desktop">
          <button class="btn ghost small" id="navBack"><span class="t">返回汐東工程管理表</span></button>
        </div>

        <div class="nav-mobile">
          <button class="btn ghost small" id="mBack"><span class="t">返回</span></button>
          <div style="position:relative; display:inline-flex;">
            <button class="btn ghost small" id="mMoreBtn" type="button"><span class="t">更多 ▾</span></button>
            <div id="mMoreMenu" style="display:none; position:absolute; top:calc(100% + 8px); right:0; min-width:220px; border-radius:16px; border:1px solid rgba(0,0,0,.20); background:rgba(255,255,255,.98); box-shadow:0 18px 50px rgba(0,0,0,.20); padding:8px; z-index:60;">
              <button class="menuItem" data-href="汐東工程管理表.html" type="button" style="width:100%; text-align:left; border:none; background:rgba(0,0,0,.03); color:rgba(0,0,0,.86); padding:10px 12px; border-radius:12px; cursor:pointer; font-family:inherit; letter-spacing:.04em; font-weight:800;">汐東工程管理表</button>
              <div style="height:1px; margin:8px 6px; background:rgba(0,0,0,.10);"></div>
              <button class="menuItem" data-href="index.html" type="button" style="width:100%; text-align:left; border:none; background:rgba(0,0,0,.03); color:rgba(0,0,0,.86); padding:10px 12px; border-radius:12px; cursor:pointer; font-family:inherit; letter-spacing:.04em; font-weight:800;">返回首頁</button>
            </div>
          </div>
        </div>
      </div>

      <div class="brand">
        <div class="title goldCrystal">捷運汐東線事項記錄</div>
        <div class="sub">記事內容 · 工種 · 系統 · 出處 · 附件 · 登錄日期</div>
      </div>

      <div class="right">
        <div class="pill">使用者：<b id="uName">—</b></div>
        <div class="pill">權限：<b id="uRole">—</b></div>

        <button class="btn small" id="btnView"><span class="t">檢視</span></button>
        <button class="btn small" id="btnAdd" style="display:none;"><span class="t">新增</span></button>
        <button class="btn small" id="btnEdit" style="display:none;"><span class="t">編輯</span></button>
        <button class="btn small" id="btnToken" style="display:none;"><span class="t">雲端設定</span></button>
      </div>
    </div>

    <div class="panel">
      <div class="panelHead">
        <div class="controls">
          <div class="field">
            <div class="label">搜尋（記事內容）</div>
            <input id="qText" placeholder="可輸入關鍵字，例如：送審、會議、現勘..." />
          </div>

          <div class="field">
            <div class="label">工種</div>
            <select id="fTrade"><option value="">全部</option></select>
          </div>

          <div class="field">
            <div class="label">系統</div>
            <select id="fSys"><option value="">全部</option></select>
          </div>

          <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
            <button class="btn ghost" id="btnCloud" type="button"><span class="t">雲端檔案</span></button>
            <button class="btn ghost" id="btnExport" type="button"><span class="t">匯出備份</span></button>
            <button class="btn ghost" id="btnRead" type="button"><span class="t">閱讀模式：關</span></button>
            <button class="btn ghost" id="btnClear" type="button"><span class="t">清除條件</span></button>
          </div>
        </div>

        <div class="hint" id="hint"></div>
      </div>

      <div class="panelBody">
        <div class="tableWrap">
          <div id="cards" style="display:none; position:relative; z-index:2;"></div>

          <table id="tbl">
            <thead>
              <tr>
                <th style="width:90px;">項次</th>
                <th>記事內容</th>
                <th style="width:150px;">工種</th>
                <th style="width:150px;">系統</th>
                <th style="width:150px;">出處</th>
                <th style="width:160px;">附件</th>
                <th style="width:220px;">備註</th>
                <th style="width:140px;">登錄日期</th>
                <th style="width:160px;">操作</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- Edit/View Modal -->
  <div class="mask" id="mask">
    <div class="modal">
      <div class="mHead">
        <div></div>
        <div class="mTitle goldCrystal" id="mTitle">查看</div>
        <button class="btn ghost small" id="btnClose" type="button"><span class="t">關閉</span></button>
      </div>

      <div class="mBody">
        <div class="grid">
          <div class="field span2">
            <div class="label">記事內容</div>
            <textarea id="mText" placeholder="請輸入記事內容（可多行）..."></textarea>
          </div>

          <div class="field">
            <div class="label">工種（下拉；可新增選項）</div>
            <div class="inline2">
              <select id="mTradeSel"></select>
              <button class="btn ghost small" id="btnAddTrade" type="button"><span class="t">新增工種</span></button>
            </div>
            <div class="miniHint">選單來源：本頁資料不重複 + 工種字典。</div>
          </div>

          <div class="field">
            <div class="label">系統（下拉；可新增選項）</div>
            <div class="inline2">
              <select id="mSysSel"></select>
              <button class="btn ghost small" id="btnAddSys" type="button"><span class="t">新增系統</span></button>
            </div>
            <div class="miniHint">✅ 系統會依「工種」篩選；可輸入既有系統名稱來「綁定」到目前工種。</div>
          </div>

          <div class="field span2">
            <div class="label">出處（下拉；可新增）</div>
            <div class="inline2">
              <select id="mSourceSel"></select>
              <button class="btn ghost small" id="btnAddSource" type="button"><span class="t">新增出處</span></button>
            </div>
            <div class="miniHint">選單來源：本頁資料「出處」不重複 + 出處字典。</div>
          </div>

          <div class="field span2">
            <div class="label">附件（超連結）</div>
            <div class="inline2">
              <input id="mAttach" placeholder="貼上連結，例如：https://... / Dropbox 連結 / file:///..." />
              <button class="btn ghost small" id="btnNetDisk" type="button"><span class="t">網路硬碟</span></button>
            </div>
            <div class="miniHint">可留空；相對網址會自動帶 v。</div>
          </div>

          <div class="field span2">
            <div class="label">備註</div>
            <textarea id="mRemark" placeholder="可輸入備註（可多行）..."></textarea>
          </div>

          <div class="field">
            <div class="label">登錄日期（可改）</div>
            <input id="mDate" type="date" />
            <div class="miniHint">預設為今日；可用日曆修改。</div>
          </div>

          <div class="field">
            <div class="label">項次</div>
            <input id="mNo" disabled />
          </div>
        </div>
      </div>

      <div class="mFoot">
        <button class="btn danger" id="btnDelete" style="display:none;" type="button"><span class="t">刪除</span></button>
        <button class="btn ghost" id="btnCancel" type="button"><span class="t">取消</span></button>
        <button class="btn" id="btnSave" type="button"><span class="t">儲存</span></button>
      </div>
    </div>
  </div>

  <!-- Prompt：新增 工種/系統/出處 -->
  <div class="pMask" id="pMask">
    <div class="pModal">
      <div class="pHead">
        <div></div>
        <div class="pTitle goldCrystal" id="pTitle">新增</div>
        <button class="btn ghost small" id="pClose" type="button"><span class="t">關閉</span></button>
      </div>
      <div class="pBody">
        <div class="field">
          <div class="label" id="pLabel">請輸入</div>
          <input id="pInput" placeholder="例如：機電 / 土建 / ..."/>
          <div class="miniHint" id="pHint">新增後會加入「選單字典」，且系統會綁到目前工種。</div>
        </div>
      </div>
      <div class="pFoot">
        <button class="btn ghost" id="pCancel" type="button"><span class="t">取消</span></button>
        <button class="btn" id="pOk" type="button"><span class="t">確定新增</span></button>
      </div>
    </div>
  </div>

  <!-- 雲端設定（可用來覆蓋 apiBase / endpoints） -->
  <div class="loginMask" id="tokenMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="雲端設定">
      <div class="loginHead">
        <div></div>
        <div class="loginTitle goldCrystal" id="cloudCfgTitle">雲端設定（Worker API）</div>
        <button class="btn ghost small" id="tokenClose" type="button"><span class="t">關閉</span></button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label" id="cloudCfgLabel">貼上（可擇一）</div>
          <input id="tokenInput" type="password" placeholder="① Worker apiBase ② 或 JSON：{&quot;apiBase&quot;:&quot;...&quot;,&quot;endpoints&quot;:{...}}" autocomplete="off" />
        </div>
        <div class="loginErr" id="tokenErr"></div>
        <div class="loginHint" id="tokenHint">目前狀態：—</div>
        <div class="loginHint">
          ✅ 你也可以直接貼 <b>Worker apiBase</b>，例如：<b>https://tasun-worker.wutasun.workers.dev</b><br>
          ✅ 或貼 JSON：<b>{"apiBase":"...","endpoints":{"read":"/api/read","merge":"/api/merge"}}</b><br>
          （正式來源仍以 tasun-resources.json 為主；此框僅作為臨時覆蓋。）
        </div>
      </div>
      <div class="loginFoot">
        <button class="btn danger" id="tokenClear" type="button"><span class="t">清除</span></button>
        <button class="btn ghost" id="tokenToggle" type="button"><span class="t">顯示/隱藏</span></button>
        <button class="btn" id="tokenSave" type="button"><span class="t">儲存</span></button>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="loginMask" id="loginMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="登入">
      <div class="loginHead">
        <div></div>
        <div class="loginTitle goldCrystal">登入</div>
        <button class="btn ghost small" id="loginClose" type="button"><span class="t">關閉</span></button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label">帳號</div>
          <select id="loginUser" autocomplete="username"><option value="">請選擇帳號</option></select>
        </div>
        <div class="field" style="margin-top:10px;">
          <div class="label">密碼</div>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="請輸入密碼" />
        </div>
        <div class="loginErr" id="loginErr"></div>
        <div class="loginHint">登入帳密以「權限表.html」(localStorage: <b>tasunAuthTable_v1</b>) 為準。</div>
      </div>
      <div class="loginFoot">
        <button class="btn ghost" id="loginToAuth" type="button"><span class="t">前往權限表</span></button>
        <button class="btn" id="loginBtn" type="button"><span class="t">登入</span></button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
  (function(){
    "use strict";

    // ---------------------------
    // Constants / Keys
    // ---------------------------
    var PAGE_KEY = "sxdh-notes";
    var APP_VER = (window.TASUN_APP_VER||"").toString().trim() || "dev";
    var RESOURCES_URL = "tasun-resources.json";

    var DEFAULT_API_BASE = "https://tasun-worker.wutasun.workers.dev";
    var DEFAULT_ENDPOINTS = { health:"/health", read:"/api/read", merge:"/api/merge" };

    var AUTH_KEY = "tasunAuthTable_v1";
    var CURRENT_KEY = "tasunCurrentUser_v1";

    var DB_KEY = "tasunSxdhNotes_v1";
    var COUNTER_KEY = "tasunSxdhNotes_counter_v1";
    var READ_MODE_KEY  = "tasunSxdhNotes_readMode_v1";

    var TRADE_DICT_KEY = "tasunSxdhNotes_tradeDict_v1";
    var SYS_DICT_KEY   = "tasunSxdhNotes_sysDict_v1";
    var SOURCE_DICT_KEY = "tasunSxdhNotes_sourceDict_v1";
    var TRADE_SYS_MAP_KEY = "tasunSxdhNotes_tradeSysMap_v1";

    // Optional overrides
    var API_BASE_LS_KEY = "tasunApiBase_v1";
    var API_EP_LS_KEY   = "tasunApiEndpoints_v1__" + PAGE_KEY;

    // ---------------------------
    // DOM helpers
    // ---------------------------
    function $(id){ return document.getElementById(id); }
    function norm(s){ return (s===undefined||s===null) ? "" : String(s).trim(); }
    function safeJSON(raw){ try{ return JSON.parse(raw); }catch(e){ return null; } }
    function nowISO(){ return new Date().toISOString(); }
    function todayISO(){ return new Date().toISOString().slice(0,10); }
    function pad2(n){ return String(n).padStart(2,"0"); }
    function fmtClock(ts){ if(!ts) return ""; var d = new Date(ts); return pad2(d.getHours())+":"+pad2(d.getMinutes())+":"+pad2(d.getSeconds()); }
    function uuid(){ return "u" + Date.now().toString(16) + "_" + Math.random().toString(16).slice(2); }

    function toast(msg, ms){
      var t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._tm);
      var dur = Number(ms);
      if(!Number.isFinite(dur) || dur<=0) dur = 2600;
      toast._tm = setTimeout(function(){ t.style.display="none"; }, dur);
    }

    function escHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#39;");
    }

    function addV(url){
      if(!url) return url;
      if(url.startsWith("http://") || url.startsWith("https://")){
        try{ var u = new URL(url); u.searchParams.set("v", APP_VER); return u.toString(); }catch(e){ return url; }
      }
      return url + (url.indexOf("?")>=0 ? "&" : "?") + "v=" + encodeURIComponent(APP_VER);
    }

    // ---------------------------
    // Auth
    // ---------------------------
    function ensureAuthTable(){
      var t = safeJSON(localStorage.getItem(AUTH_KEY));
      if(!t || typeof t !== "object"){
        t = {
          users: [
            { user:"alex", pass:"alex", role:"admin", name:"alex" },
            { user:"tasun", pass:"tasun", role:"write", name:"tasun" },
            { user:"wu", pass:"wu", role:"read", name:"wu" }
          ],
          updatedAt: nowISO(),
          rev: "seed"
        };
        localStorage.setItem(AUTH_KEY, JSON.stringify(t));
      }
      if(!Array.isArray(t.users)) t.users = [];
      return t;
    }

    function getCurrentUser(){
      var cur = safeJSON(localStorage.getItem(CURRENT_KEY));
      if(cur && cur.user && cur.role) return cur;
      return null;
    }

    function setCurrentUser(u){
      if(!u) localStorage.removeItem(CURRENT_KEY);
      else localStorage.setItem(CURRENT_KEY, JSON.stringify(u));
    }

    function roleRank(role){
      if(role==="admin") return 3;
      if(role==="write") return 2;
      return 1;
    }

    // ---------------------------
    // Cloud config
    // ---------------------------
    function parseJsonLenient(raw){
      raw = (raw===undefined||raw===null) ? "" : String(raw);
      try{ return JSON.parse(raw); }catch(e){}
      try{
        var cleaned = raw.replace(/\/\*[\s\S]*?\*\//g, "").replace(/,\s*([}\]])/g, "$1");
        return JSON.parse(cleaned);
      }catch(e2){}
      return null;
    }

    function normalizeEndpoints(ep){
      ep = (ep && typeof ep==="object") ? ep : {};
      return {
        health: norm(ep.health || "/health") || "/health",
        read:   norm(ep.read   || "/api/read") || "/api/read",
        merge:  norm(ep.merge  || "/api/merge") || "/api/merge"
      };
    }

    function joinApiBase(base, path){
      base = norm(base).replace(/\/+$/,"");
      path = norm(path);
      if(!path) return base;
      if(/^https?:\/\//i.test(path)) return path;
      if(path.charAt(0)!="/") path = "/" + path;
      return base + path;
    }

    function isValidApiBase(v){
      v = norm(v);
      if(!v) return false;
      if(!/^https?:\/\//i.test(v)) return false;
      if(/YOUR-WORKER-DOMAIN/i.test(v)) return false;
      return true;
    }

    function getFileName(){
      try{
        var p = location.pathname || "";
        var fn = p.split("/").pop() || "";
        return decodeURIComponent(fn) || fn;
      }catch(e){ return (location.pathname||"").split("/").pop() || ""; }
    }

    var _cloudCfgCache = null;

    async function loadCloudCfg(){
      if(_cloudCfgCache) return _cloudCfgCache;

      // Start with defaults
      var cfg = { apiBase: DEFAULT_API_BASE, endpoints: Object.assign({}, DEFAULT_ENDPOINTS) };

      // 1) resources.json (best)
      try{
        var res = await fetch(addV(RESOURCES_URL), { cache:"no-store" });
        if(res && res.ok){
          var text = await res.text();
          var json = parseJsonLenient(text);
          if(json && json.resources && typeof json.resources==="object"){
            var fn = getFileName();
            var r = json.resources;
            var pick = r[fn] || r[PAGE_KEY] || r["*"] || null;
            if(pick){
              if(isValidApiBase(pick.apiBase)) cfg.apiBase = pick.apiBase;
              if(pick.endpoints) cfg.endpoints = normalizeEndpoints(pick.endpoints);
            }else{
              if(isValidApiBase(json.apiBase)) cfg.apiBase = json.apiBase;
              if(json.endpoints) cfg.endpoints = normalizeEndpoints(json.endpoints);
            }
          }
        }
      }catch(e){ /* ignore */ }

      // 2) local overrides (optional)
      var ob = norm(localStorage.getItem(API_BASE_LS_KEY));
      if(isValidApiBase(ob)) cfg.apiBase = ob;

      var oe = safeJSON(localStorage.getItem(API_EP_LS_KEY));
      if(oe) cfg.endpoints = normalizeEndpoints(Object.assign({}, cfg.endpoints, oe));

      _cloudCfgCache = cfg;
      return cfg;
    }

    // ---------------------------
    // Local data + dicts
    // ---------------------------
    function loadDb(){
      var arr = safeJSON(localStorage.getItem(DB_KEY));
      if(!Array.isArray(arr)) arr = [];
      var c = Number(localStorage.getItem(COUNTER_KEY)||"0");
      if(!Number.isFinite(c) || c<0) c = 0;
      return { db: arr, counter: c };
    }

    function saveLocal(payload){
      localStorage.setItem(DB_KEY, JSON.stringify(payload.db||[]));
      localStorage.setItem(COUNTER_KEY, String(Number(payload.counter||0)||0));
    }

    function normalizeRow(x){
      if(!x || typeof x!=="object") return null;
      var r = Object.assign({}, x);
      r.uid = norm(r.uid) || "";
      if(!r.uid) return null;
      r.id = Number(r.id||0);
      if(!Number.isFinite(r.id)) r.id = 0;
      r.text = norm(r.text);
      r.trade = norm(r.trade);
      r.sys = norm(r.sys);
      r.source = norm(r.source);
      r.attach = norm(r.attach);
      r.remark = norm(r.remark);
      r.date = norm(r.date) || "";
      r.updatedAt = norm(r.updatedAt) || "";
      r.rev = norm(r.rev) || "";
      r.deleted = !!r.deleted;
      return r;
    }

    function maxId(arr){
      var m = 0;
      for(var i=0;i<arr.length;i++){
        var id = Number(arr[i] && arr[i].id || 0);
        if(Number.isFinite(id) && id>m) m = id;
      }
      return m;
    }

    function tsOf(x){
      var s = norm(x && x.updatedAt);
      if(!s) return 0;
      var t = Date.parse(s);
      return isNaN(t) ? 0 : t;
    }

    function pickNewer(a,b){
      if(!a) return b;
      if(!b) return a;
      var ta = tsOf(a), tb = tsOf(b);
      if(tb>ta) return b;
      if(ta>tb) return a;
      var ra = norm(a.rev||""), rb = norm(b.rev||"");
      return (rb>ra) ? b : a;
    }

    function unwrap(payload){
      var out = (payload && typeof payload==="object") ? payload : {};
      if(out && typeof out==="object"){
        if("payload" in out) out = out.payload || {};
        else if("data" in out) out = out.data || {};
        else if("result" in out) out = out.result || {};
      }
      if(!Array.isArray(out.db)) out.db = [];
      var c = Number(out.counter||0); if(!Number.isFinite(c) || c<0) c=0;
      out.counter = c;
      return out;
    }

    function mergePayload(remotePayload, localPayload){
      var r = unwrap(remotePayload||{});
      var l = unwrap(localPayload||{});

      var map = Object.create(null);
      function putAll(arr){
        for(var i=0;i<arr.length;i++){
          var row = normalizeRow(arr[i]);
          if(!row) continue;
          map[row.uid] = pickNewer(map[row.uid], row);
        }
      }
      putAll(r.db||[]);
      putAll(l.db||[]);

      var merged = [];
      for(var k in map){ if(Object.prototype.hasOwnProperty.call(map,k)) merged.push(map[k]); }

      // Ensure unique visible id for non-deleted rows
      var counterMerged = Math.max(Number(r.counter||0)||0, Number(l.counter||0)||0, maxId(merged));
      var used = new Set();
      merged.sort(function(a,b){
        var da = a.deleted ? 1 : 0, db = b.deleted ? 1 : 0;
        if(da!==db) return da-db;
        return (Number(a.id||0) - Number(b.id||0)) || (tsOf(a)-tsOf(b));
      });
      for(var j=0;j<merged.length;j++){
        var rr = merged[j];
        if(!rr || rr.deleted) continue;
        var idv = Number(rr.id||0);
        if(!Number.isFinite(idv) || idv<=0 || used.has(idv)){
          counterMerged += 1;
          rr.id = counterMerged;
          rr.updatedAt = rr.updatedAt || nowISO();
          rr.rev = rr.rev || ("r"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16));
        }
        used.add(Number(rr.id));
        if(Number(rr.id)>counterMerged) counterMerged = Number(rr.id);
      }

      return { db: merged, counter: counterMerged, updatedAt: nowISO(), rev: "merge_"+Date.now().toString(16) };
    }

    function loadDict(key){
      var v = safeJSON(localStorage.getItem(key));
      if(!Array.isArray(v)) v = [];
      return v.map(function(s){ return norm(s); }).filter(Boolean);
    }
    function saveDict(key, arr){
      arr = (arr||[]).map(function(s){ return norm(s); }).filter(Boolean);
      // dedupe
      var set = new Set();
      var out = [];
      for(var i=0;i<arr.length;i++){
        var x = arr[i];
        if(set.has(x)) continue;
        set.add(x); out.push(x);
      }
      localStorage.setItem(key, JSON.stringify(out));
      return out;
    }
    function loadMap(){
      var m = safeJSON(localStorage.getItem(TRADE_SYS_MAP_KEY));
      if(!m || typeof m!=="object") m = {};
      return m;
    }
    function saveMap(m){
      localStorage.setItem(TRADE_SYS_MAP_KEY, JSON.stringify(m||{}));
    }

    // ---------------------------
    // UI state
    // ---------------------------
    var state = {
      user: null,
      db: [],
      counter: 0,
      selectedUid: null,
      editingUid: null,
      promptMode: null,
      readMode: false,
      lastSyncAt: 0,
      cloudState: "offline", // offline|sync|save|ok|readonly|need_auth|deny|neterr|noapi|bad|svcerr
    };

    // ---------------------------
    // Cloud I/O
    // ---------------------------
    async function cloudHealth(){
      var cfg = await loadCloudCfg();
      var url = joinApiBase(cfg.apiBase, cfg.endpoints.health);
      try{
        var res = await fetch(addV(url), { cache:"no-store", credentials:"include" });
        return !!(res && res.ok);
      }catch(e){ return false; }
    }

    async function cloudRead(){
      var cfg = await loadCloudCfg();
      var url = joinApiBase(cfg.apiBase, cfg.endpoints.read);
      url = url + (url.indexOf("?")>=0 ? "&" : "?") + "key=" + encodeURIComponent(PAGE_KEY);
      url = addV(url);
      var res = await fetch(url, { cache:"no-store", credentials:"include" });
      if(res.status===401 || res.status===403) throw { code:"deny", status: res.status };
      if(!res.ok) throw { code:"neterr", status: res.status };
      return await res.json();
    }

    async function cloudMerge(payload, reason){
      var cfg = await loadCloudCfg();
      var url = addV(joinApiBase(cfg.apiBase, cfg.endpoints.merge));
      var body = {
        key: PAGE_KEY,
        pk: "uid",
        payload: payload,
        reason: reason || "client_merge",
        client: { appVer: APP_VER, pageKey: PAGE_KEY, ua: navigator.userAgent }
      };
      var res = await fetch(url, {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify(body),
        cache:"no-store",
        credentials:"include"
      });
      if(res.status===401 || res.status===403) throw { code:"deny", status: res.status };
      if(!res.ok) throw { code:"neterr", status: res.status };
      return await res.json();
    }

    async function syncPull(){
      state.cloudState = "sync";
      renderHint();
      try{
        var remote = await cloudRead();
        var merged = mergePayload(remote && (remote.payload||remote), { db: state.db, counter: state.counter });
        state.db = merged.db; state.counter = merged.counter;
        saveLocal({ db: state.db, counter: state.counter });

        // If user can write, push merged back to consolidate (optional)
        if(state.user && roleRank(state.user.role) >= 2){
          state.cloudState = "save"; renderHint();
          try{ await cloudMerge({ db: state.db, counter: state.counter }, "pull_then_consolidate"); }catch(e2){ /* ignore */ }
        }
        state.lastSyncAt = Date.now();
        state.cloudState = "ok";
      }catch(e){
        if(e && e.code==="deny") state.cloudState = "deny";
        else state.cloudState = "neterr";
      }
      renderAll();
    }

    async function saveToCloud(reason){
      if(!(state.user && roleRank(state.user.role) >= 2)) return;
      state.cloudState = "save";
      renderHint();
      try{
        var remote = null;
        try{ remote = await cloudRead(); }catch(e0){ remote = null; }
        var merged = mergePayload(remote && (remote.payload||remote), { db: state.db, counter: state.counter });
        // update local to merged, then push
        state.db = merged.db; state.counter = merged.counter;
        saveLocal({ db: state.db, counter: state.counter });

        await cloudMerge({ db: state.db, counter: state.counter }, reason||"save");
        state.lastSyncAt = Date.now();
        state.cloudState = "ok";
      }catch(e){
        if(e && e.code==="deny") state.cloudState = "deny";
        else state.cloudState = "neterr";
      }
      renderAll();
    }

    // ---------------------------
    // Render helpers
    // ---------------------------
    function getVisibleRows(){
      var q = norm($("qText").value).toLowerCase();
      var ft = norm($("fTrade").value);
      var fs = norm($("fSys").value);
      var rows = state.db
        .map(normalizeRow)
        .filter(Boolean)
        .filter(function(r){ return !r.deleted; });

      // sort by id asc
      rows.sort(function(a,b){ return (Number(a.id||0)-Number(b.id||0)) || (tsOf(a)-tsOf(b)); });

      if(q){
        rows = rows.filter(function(r){ return (r.text||"").toLowerCase().includes(q); });
      }
      if(ft){
        rows = rows.filter(function(r){ return r.trade===ft; });
      }
      if(fs){
        rows = rows.filter(function(r){ return r.sys===fs; });
      }
      return rows;
    }

    function buildDictsFromDb(){
      var rows = state.db.map(normalizeRow).filter(Boolean).filter(function(r){ return !r.deleted; });
      var trades = new Set(loadDict(TRADE_DICT_KEY));
      var syss = new Set(loadDict(SYS_DICT_KEY));
      var sources = new Set(loadDict(SOURCE_DICT_KEY));

      var map = loadMap(); // trade -> [sys]
      for(var i=0;i<rows.length;i++){
        var r = rows[i];
        if(r.trade) trades.add(r.trade);
        if(r.sys) syss.add(r.sys);
        if(r.source) sources.add(r.source);
        if(r.trade && r.sys){
          map[r.trade] = map[r.trade] || [];
          if(!map[r.trade].includes(r.sys)) map[r.trade].push(r.sys);
        }
      }
      saveDict(TRADE_DICT_KEY, Array.from(trades).sort());
      saveDict(SYS_DICT_KEY, Array.from(syss).sort());
      saveDict(SOURCE_DICT_KEY, Array.from(sources).sort());
      saveMap(map);
    }

    function fillSelect(sel, items, includeAll){
      var v = sel.value;
      sel.innerHTML = "";
      if(includeAll){
        var op0 = document.createElement("option");
        op0.value = "";
        op0.textContent = "全部";
        sel.appendChild(op0);
      }
      items.forEach(function(it){
        var op = document.createElement("option");
        op.value = it;
        op.textContent = it;
        sel.appendChild(op);
      });
      // restore if possible
      if(v && items.includes(v)) sel.value = v;
      else if(includeAll) sel.value = "";
    }

    function renderFilters(){
      buildDictsFromDb();
      var trades = loadDict(TRADE_DICT_KEY);
      var syss = loadDict(SYS_DICT_KEY);

      fillSelect($("fTrade"), trades, true);

      // sys filter: if trade selected, limit to map
      var map = loadMap();
      var ft = norm($("fTrade").value);
      if(ft && map[ft] && Array.isArray(map[ft]) && map[ft].length){
        fillSelect($("fSys"), map[ft].slice().sort(), true);
      }else{
        fillSelect($("fSys"), syss, true);
      }
    }

    function renderTable(){
      var rows = getVisibleRows();
      var tb = $("tbody");
      tb.innerHTML = "";
      for(var i=0;i<rows.length;i++){
        var r = rows[i];
        var tr = document.createElement("tr");
        if(state.selectedUid===r.uid) tr.classList.add("sel");

        var tdNo = document.createElement("td");
        tdNo.textContent = String(r.id||"");
        tdNo.style.textAlign = "center";
        tr.appendChild(tdNo);

        function tdText(v){
          var td = document.createElement("td");
          td.innerHTML = escHtml(v||"");
          return td;
        }
        tr.appendChild(tdText(r.text));
        tr.appendChild(tdText(r.trade));
        tr.appendChild(tdText(r.sys));
        tr.appendChild(tdText(r.source));

        // attach
        var tdA = document.createElement("td");
        tdA.style.textAlign="center";
        if(r.attach){
          var a = document.createElement("a");
          a.className = "attBtn";
          a.href = addV(r.attach);
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.innerHTML = '<span class="t">開啟附件</span>';
          tdA.appendChild(a);
        }else{
          tdA.innerHTML = '<span class="muted">—</span>';
        }
        tr.appendChild(tdA);

        tr.appendChild(tdText(r.remark));
        var tdD = document.createElement("td");
        tdD.style.textAlign="center";
        tdD.textContent = r.date || "";
        tr.appendChild(tdD);

        var tdOp = document.createElement("td");
        tdOp.style.textAlign="center";
        var bSel = document.createElement("button");
        bSel.className = "btn ghost small";
        bSel.type = "button";
        bSel.innerHTML = '<span class="t">選取</span>';
        bSel.addEventListener("click", (function(uid){ return function(e){ e.stopPropagation(); selectRow(uid); }; })(r.uid));
        tdOp.appendChild(bSel);
        tr.appendChild(tdOp);

        tr.addEventListener("click", (function(uid){ return function(){ selectRow(uid); }; })(r.uid));
        tb.appendChild(tr);
      }
    }

    function renderCards(){
      var rows = getVisibleRows();
      var wrap = $("cards");
      wrap.innerHTML = "";
      for(var i=0;i<rows.length;i++){
        var r = rows[i];
        var card = document.createElement("div");
        card.className = "noteCard" + (state.selectedUid===r.uid ? " sel" : "");
        card.dataset.uid = r.uid;

        var head = document.createElement("div");
        head.className = "noteHead";

        var meta = document.createElement("div");
        meta.className = "noteMeta";
        meta.innerHTML =
          '<span class="noteNo">#' + escHtml(String(r.id||"")) + '</span>' +
          (r.trade ? '<span class="noteTag">' + escHtml(r.trade) + '</span>' : '') +
          (r.sys ? '<span class="noteTag">' + escHtml(r.sys) + '</span>' : '') +
          (r.source ? '<span class="noteTag">' + escHtml(r.source) + '</span>' : '') +
          (r.date ? '<span class="noteTag">' + escHtml(r.date) + '</span>' : '');
        head.appendChild(meta);

        var more = document.createElement("div");
        more.className = "noteMore";
        more.innerHTML = (r.attach ? ('<a class="attBtn" href="'+escHtml(addV(r.attach))+'" target="_blank" rel="noopener noreferrer"><span class="t">附件</span></a>') : '') +
                         (r.remark ? ('<div class="miniHint" style="margin-top:8px; text-align:left;">備註：'+escHtml(r.remark)+'</div>') : '');
        head.appendChild(more);

        var body = document.createElement("div");
        body.className = "noteBody";
        body.textContent = r.text || "";

        card.appendChild(head);
        card.appendChild(body);

        card.addEventListener("click", function(e){
          var uid = this.dataset.uid;
          if(state.selectedUid!==uid) selectRow(uid);
          // toggle open
          this.classList.toggle("open");
        });

        wrap.appendChild(card);
      }
    }

    function renderHint(){
      var rows = getVisibleRows();
      var total = state.db.map(normalizeRow).filter(Boolean).filter(function(r){ return !r.deleted; }).length;

      var user = state.user || { user:"—", role:"—" };
      $("uName").textContent = user.user || "—";
      $("uRole").textContent = user.role || "—";

      var canWrite = (user && roleRank(user.role)>=2);

      $("btnAdd").style.display = canWrite ? "" : "none";
      $("btnEdit").style.display = canWrite ? "" : "none";
      $("btnToken").style.display = (user && user.role==="admin") ? "" : "none";

      var stateLabel = {
        offline: ["雲端", "離線/未啟用"],
        sync: ["雲端", "同步中…"],
        save: ["雲端", "上傳中…"],
        ok: ["雲端", "已同步"],
        deny: ["雲端", "被拒絕（Access/權限）"],
        neterr: ["雲端", "網路/服務異常"],
      }[state.cloudState] || ["雲端","—"];

      var last = state.lastSyncAt ? fmtClock(state.lastSyncAt) : "—";
      var sel = state.selectedUid ? ("已選取") : ("未選取");

      $("hint").innerHTML =
        '<span class="hb"><span class="k">版本</span><span class="v">'+escHtml(APP_VER)+'</span></span>' +
        '<span class="hb"><span class="k">筆數</span><span class="v">'+escHtml(String(rows.length))+'</span><span class="k">/</span><span class="v">'+escHtml(String(total))+'</span></span>' +
        '<span class="hb"><span class="k">選取</span><span class="v">'+escHtml(sel)+'</span></span>' +
        '<span class="hb '+(state.cloudState==="deny"||state.cloudState==="neterr"?"bad":"")+'"><span class="k">'+escHtml(stateLabel[0])+'</span><span class="v">'+escHtml(stateLabel[1])+'</span></span>' +
        '<span class="hb"><span class="k">最後</span><span class="v">'+escHtml(last)+'</span></span>' +
        '<span class="hb"><span class="k">權限</span><span class="v">'+escHtml(canWrite?"可編輯":"唯讀")+'</span></span>';
    }

    function renderAll(){
      renderFilters();
      renderHint();
      renderTable();
      renderCards();
    }

    // ---------------------------
    // Selection + modal
    // ---------------------------
    function findRow(uid){
      uid = norm(uid);
      if(!uid) return null;
      for(var i=0;i<state.db.length;i++){
        var r = normalizeRow(state.db[i]);
        if(r && r.uid===uid) return r;
      }
      return null;
    }

    function selectRow(uid){
      state.selectedUid = norm(uid) || null;
      renderAll();
    }

    function openMask(title){
      $("mTitle").textContent = title;
      $("mask").style.display = "flex";
      $("mask").setAttribute("aria-hidden","false");
    }
    function closeMask(){
      $("mask").style.display = "none";
      $("mask").setAttribute("aria-hidden","true");
      state.editingUid = null;
    }

    function setModalReadonly(ro){
      ["mText","mTradeSel","mSysSel","mSourceSel","mAttach","mRemark","mDate"].forEach(function(id){
        var el = $(id);
        if(!el) return;
        el.disabled = !!ro;
      });
      $("btnAddTrade").disabled = !!ro;
      $("btnAddSys").disabled = !!ro;
      $("btnAddSource").disabled = !!ro;
      $("btnNetDisk").disabled = false;
    }

    function fillModalFromRow(r){
      $("mNo").value = r ? String(r.id||"") : "";
      $("mText").value = r ? (r.text||"") : "";
      $("mAttach").value = r ? (r.attach||"") : "";
      $("mRemark").value = r ? (r.remark||"") : "";
      $("mDate").value = r ? (r.date||todayISO()) : todayISO();

      // dict selects
      buildDictsFromDb();
      var trades = loadDict(TRADE_DICT_KEY);
      var syss = loadDict(SYS_DICT_KEY);
      var sources = loadDict(SOURCE_DICT_KEY);
      var map = loadMap();

      function fill(sel, items, keep){
        sel.innerHTML = "";
        items.forEach(function(it){
          var op = document.createElement("option");
          op.value = it; op.textContent = it;
          sel.appendChild(op);
        });
        if(keep && items.includes(keep)) sel.value = keep;
        else if(items.length) sel.value = items[0];
        else sel.value = "";
      }

      fill($("mTradeSel"), trades, r && r.trade);
      var t = norm($("mTradeSel").value);
      var sysItems = (t && map[t] && Array.isArray(map[t]) && map[t].length) ? map[t].slice().sort() : syss.slice().sort();
      fill($("mSysSel"), sysItems, r && r.sys);
      fill($("mSourceSel"), sources, r && r.source);
    }

    function openView(){
      if(!state.selectedUid){ toast("請先選取一筆", 2200); return; }
      var r = findRow(state.selectedUid);
      if(!r){ toast("找不到資料（可能已被刪除）", 2400); return; }
      fillModalFromRow(r);
      setModalReadonly(true);
      $("btnSave").style.display = "none";
      $("btnDelete").style.display = "none";
      openMask("查看");
    }

    function openAdd(){
      if(!(state.user && roleRank(state.user.role)>=2)){ toast("目前為唯讀權限", 2400); return; }
      state.editingUid = null;
      fillModalFromRow(null);
      setModalReadonly(false);
      $("btnSave").style.display = "";
      $("btnDelete").style.display = "none";
      openMask("新增");
    }

    function openEdit(){
      if(!(state.user && roleRank(state.user.role)>=2)){ toast("目前為唯讀權限", 2400); return; }
      if(!state.selectedUid){ toast("請先選取一筆", 2200); return; }
      var r = findRow(state.selectedUid);
      if(!r){ toast("找不到資料（可能已被刪除）", 2400); return; }
      state.editingUid = r.uid;
      fillModalFromRow(r);
      setModalReadonly(false);
      $("btnSave").style.display = "";
      $("btnDelete").style.display = "";
      openMask("編輯");
    }

    function readModal(){
      return {
        text: norm($("mText").value),
        trade: norm($("mTradeSel").value),
        sys: norm($("mSysSel").value),
        source: norm($("mSourceSel").value),
        attach: norm($("mAttach").value),
        remark: norm($("mRemark").value),
        date: norm($("mDate").value) || todayISO()
      };
    }

    function ensureSelectOptions(){
      // when trade changes, sys options should filter
      $("mTradeSel").addEventListener("change", function(){
        var t = norm(this.value);
        var syss = loadDict(SYS_DICT_KEY);
        var map = loadMap();
        var sysItems = (t && map[t] && Array.isArray(map[t]) && map[t].length) ? map[t].slice().sort() : syss.slice().sort();
        var keep = norm($("mSysSel").value);
        $("mSysSel").innerHTML = "";
        sysItems.forEach(function(it){
          var op=document.createElement("option"); op.value=it; op.textContent=it; $("mSysSel").appendChild(op);
        });
        if(keep && sysItems.includes(keep)) $("mSysSel").value = keep;
        else if(sysItems.length) $("mSysSel").value = sysItems[0];
      });
    }

    // ---------------------------
    // Prompt modal (add dict items)
    // ---------------------------
    function openPrompt(mode){
      state.promptMode = mode; // "trade"|"sys"|"source"
      $("pInput").value = "";
      $("pMask").style.display = "flex";
      if(mode==="trade"){
        $("pTitle").textContent = "新增工種";
        $("pLabel").textContent = "請輸入工種";
        $("pHint").textContent = "新增後會加入工種字典。";
      }else if(mode==="sys"){
        $("pTitle").textContent = "新增系統";
        $("pLabel").textContent = "請輸入系統名稱";
        $("pHint").textContent = "新增後會加入系統字典，並綁定到目前工種。";
      }else{
        $("pTitle").textContent = "新增出處";
        $("pLabel").textContent = "請輸入出處";
        $("pHint").textContent = "新增後會加入出處字典。";
      }
      setTimeout(function(){ $("pInput").focus(); }, 0);
    }
    function closePrompt(){
      $("pMask").style.display = "none";
      state.promptMode = null;
    }
    function confirmPrompt(){
      var v = norm($("pInput").value);
      if(!v){ toast("請輸入內容", 2200); return; }
      if(state.promptMode==="trade"){
        var trades = saveDict(TRADE_DICT_KEY, loadDict(TRADE_DICT_KEY).concat([v]));
        // refresh select
        $("mTradeSel").innerHTML = "";
        trades.forEach(function(it){ var op=document.createElement("option"); op.value=it; op.textContent=it; $("mTradeSel").appendChild(op); });
        $("mTradeSel").value = v;
        $("mTradeSel").dispatchEvent(new Event("change"));
        closePrompt();
        toast("已新增工種", 2000);
      }else if(state.promptMode==="sys"){
        var syss = saveDict(SYS_DICT_KEY, loadDict(SYS_DICT_KEY).concat([v]));
        var t = norm($("mTradeSel").value);
        var map = loadMap();
        if(t){
          map[t] = map[t] || [];
          if(!map[t].includes(v)) map[t].push(v);
          saveMap(map);
        }
        // refresh sys select according to trade
        $("mTradeSel").dispatchEvent(new Event("change"));
        $("mSysSel").value = v;
        closePrompt();
        toast("已新增系統", 2000);
      }else if(state.promptMode==="source"){
        var srcs = saveDict(SOURCE_DICT_KEY, loadDict(SOURCE_DICT_KEY).concat([v]));
        $("mSourceSel").innerHTML = "";
        srcs.forEach(function(it){ var op=document.createElement("option"); op.value=it; op.textContent=it; $("mSourceSel").appendChild(op); });
        $("mSourceSel").value = v;
        closePrompt();
        toast("已新增出處", 2000);
      }
      renderFilters();
    }

    // ---------------------------
    // CRUD
    // ---------------------------
    function upsertRow(uid, data){
      var found = false;
      for(var i=0;i<state.db.length;i++){
        var r = normalizeRow(state.db[i]);
        if(r && r.uid===uid){
          found = true;
          state.db[i] = Object.assign({}, r, data);
          break;
        }
      }
      if(!found){
        state.db.push(Object.assign({ uid: uid }, data));
      }
    }

    async function onSave(){
      if(!(state.user && roleRank(state.user.role)>=2)){ toast("目前為唯讀權限", 2400); return; }

      var d = readModal();
      if(!d.text){ toast("記事內容不可空白", 2400); return; }

      // Normalize dict binding
      if(d.trade && d.sys){
        var map = loadMap();
        map[d.trade] = map[d.trade] || [];
        if(!map[d.trade].includes(d.sys)) map[d.trade].push(d.sys);
        saveMap(map);
      }

      var isEdit = !!state.editingUid;
      var uid = isEdit ? state.editingUid : uuid();

      // assign id
      var idv = 0;
      if(isEdit){
        var old = findRow(uid);
        idv = old ? Number(old.id||0) : 0;
      }
      if(!idv || !Number.isFinite(idv) || idv<=0){
        state.counter = Math.max(state.counter, maxId(state.db.map(normalizeRow).filter(Boolean)));
        state.counter += 1;
        idv = state.counter;
      }

      var row = {
        uid: uid,
        id: idv,
        text: d.text,
        trade: d.trade,
        sys: d.sys,
        source: d.source,
        attach: d.attach,
        remark: d.remark,
        date: d.date,
        updatedAt: nowISO(),
        rev: "r"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16),
        deleted: false
      };

      upsertRow(uid, row);
      saveLocal({ db: state.db, counter: state.counter });
      buildDictsFromDb();
      closeMask();
      selectRow(uid);
      toast(isEdit ? "已儲存修改" : "已新增", 2000);

      // Cloud save (best effort)
      await saveToCloud(isEdit ? "edit" : "add");
    }

    async function onDelete(){
      if(!(state.user && roleRank(state.user.role)>=2)){ toast("目前為唯讀權限", 2400); return; }
      if(!state.editingUid){ toast("未選取要刪除的資料", 2200); return; }
      if(!confirm("確定刪除這筆？（可由雲端同步回復需管理者介入）")) return;

      var uid = state.editingUid;
      var old = findRow(uid);
      if(!old){ toast("找不到資料", 2200); return; }

      upsertRow(uid, {
        uid: uid,
        id: old.id,
        deleted: true,
        updatedAt: nowISO(),
        rev: "r"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16)
      });
      saveLocal({ db: state.db, counter: state.counter });
      closeMask();
      state.selectedUid = null;
      renderAll();
      toast("已刪除", 2000);

      await saveToCloud("delete");
    }

    // ---------------------------
    // Export / Read mode / Clear
    // ---------------------------
    function exportBackup(){
      var payload = {
        pageKey: PAGE_KEY,
        appVer: APP_VER,
        exportedAt: nowISO(),
        payload: { db: state.db, counter: state.counter }
      };
      var blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
      var a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "sxdh-notes_backup_" + todayISO().replaceAll("-","") + ".json";
      document.body.appendChild(a);
      a.click();
      setTimeout(function(){
        URL.revokeObjectURL(a.href);
        a.remove();
      }, 2000);
      toast("已匯出備份", 2000);
    }

    function setReadMode(on){
      state.readMode = !!on;
      document.body.classList.toggle("readMode", state.readMode);
      localStorage.setItem(READ_MODE_KEY, state.readMode ? "1" : "0");
      $("btnRead").querySelector(".t").textContent = "閱讀模式：" + (state.readMode ? "開" : "關");
      renderAll();
    }

    function clearFilters(){
      $("qText").value = "";
      $("fTrade").value = "";
      $("fSys").value = "";
      renderAll();
    }

    // ---------------------------
    // Cloud settings modal
    // ---------------------------
    function openToken(){
      $("tokenErr").style.display = "none";
      $("tokenErr").textContent = "";
      $("tokenMask").style.display = "flex";
      $("tokenMask").setAttribute("aria-hidden","false");
      $("tokenInput").value = "";
      refreshTokenHint();
      setTimeout(function(){ $("tokenInput").focus(); }, 0);
    }
    function closeToken(){
      $("tokenMask").style.display = "none";
      $("tokenMask").setAttribute("aria-hidden","true");
    }
    async function refreshTokenHint(){
      var cfg = await loadCloudCfg();
      $("tokenHint").textContent = "目前狀態：" + (cfg && cfg.apiBase ? cfg.apiBase : "—");
    }

    function tokenToggle(){
      var el = $("tokenInput");
      el.type = (el.type==="password") ? "text" : "password";
    }

    async function tokenSave(){
      var raw = norm($("tokenInput").value);
      $("tokenErr").style.display = "none";
      $("tokenErr").textContent = "";
      if(!raw){ toast("未輸入", 2000); return; }

      var j = safeJSON(raw);
      if(j && typeof j==="object"){
        if(j.apiBase && isValidApiBase(j.apiBase)) localStorage.setItem(API_BASE_LS_KEY, j.apiBase);
        if(j.endpoints && typeof j.endpoints==="object"){
          localStorage.setItem(API_EP_LS_KEY, JSON.stringify(normalizeEndpoints(j.endpoints)));
        }
      }else{
        if(!isValidApiBase(raw)){
          $("tokenErr").style.display = "block";
          $("tokenErr").textContent = "輸入格式不正確：請貼 apiBase（https://...）或 JSON。";
          return;
        }
        localStorage.setItem(API_BASE_LS_KEY, raw);
      }
      _cloudCfgCache = null;
      toast("已儲存雲端設定（覆蓋）", 2400);
      closeToken();
      await syncPull();
    }

    function tokenClear(){
      localStorage.removeItem(API_BASE_LS_KEY);
      localStorage.removeItem(API_EP_LS_KEY);
      _cloudCfgCache = null;
      toast("已清除雲端覆蓋設定", 2400);
      refreshTokenHint();
    }

    // ---------------------------
    // Login modal
    // ---------------------------
    function openLogin(){
      var tab = ensureAuthTable();
      var sel = $("loginUser");
      sel.innerHTML = '<option value="">請選擇帳號</option>';
      tab.users.forEach(function(u){
        var op=document.createElement("option");
        op.value=u.user; op.textContent = u.user + " (" + (u.role||"read") + ")";
        sel.appendChild(op);
      });
      $("loginPass").value = "";
      $("loginErr").style.display = "none";
      $("loginErr").textContent = "";
      $("loginMask").style.display = "flex";
      $("loginMask").setAttribute("aria-hidden","false");
    }
    function closeLogin(){
      $("loginMask").style.display = "none";
      $("loginMask").setAttribute("aria-hidden","true");
    }
    function doLogin(){
      var user = norm($("loginUser").value);
      var pass = norm($("loginPass").value);
      var tab = ensureAuthTable();
      var found = tab.users.find(function(u){ return u.user===user; });
      if(!found || found.pass!==pass){
        $("loginErr").style.display="block";
        $("loginErr").textContent = "帳號或密碼錯誤";
        return;
      }
      state.user = { user: found.user, role: found.role||"read", name: found.name||found.user, loginAt: nowISO() };
      setCurrentUser(state.user);
      closeLogin();
      renderHint();
      toast("登入成功", 1800);
      // After login, try sync
      syncPull();
    }

    // ---------------------------
    // Nav + mobile menu
    // ---------------------------
    function initNav(){
      function go(href){ location.href = addV(href); }

      $("navBack").addEventListener("click", function(){ go("汐東工程管理表.html"); });
      $("mBack").addEventListener("click", function(){ history.length>1 ? history.back() : go("汐東工程管理表.html"); });

      var btn = $("mMoreBtn");
      var menu = $("mMoreMenu");
      btn.addEventListener("click", function(e){
        e.stopPropagation();
        menu.style.display = (menu.style.display==="none" || !menu.style.display) ? "block" : "none";
      });
      document.addEventListener("click", function(){ menu.style.display = "none"; });
      Array.from(document.querySelectorAll(".menuItem")).forEach(function(el){
        el.addEventListener("click", function(e){
          e.stopPropagation();
          var href = this.getAttribute("data-href");
          menu.style.display = "none";
          if(href) go(href);
        });
      });
    }

    // ---------------------------
    // Wire UI events
    // ---------------------------
    function wire(){
      initNav();

      $("btnView").addEventListener("click", openView);
      $("btnAdd").addEventListener("click", openAdd);
      $("btnEdit").addEventListener("click", openEdit);
      $("btnToken").addEventListener("click", openToken);

      $("btnClose").addEventListener("click", closeMask);
      $("btnCancel").addEventListener("click", closeMask);
      $("btnSave").addEventListener("click", onSave);
      $("btnDelete").addEventListener("click", onDelete);
      $("btnNetDisk").addEventListener("click", function(){
        var url = "https://www.dropbox.com/scl/fo/glb4s65934h195bxuyuqm/AH5ClZ2u4MtPMvmgtfOUAa4?rlkey=tfxkpbpw8k9bctshx5xvuge8h&st=9deaoqpw&dl=0";
        window.open(url, "_blank", "noopener,noreferrer");
      });

      $("btnAddTrade").addEventListener("click", function(){ openPrompt("trade"); });
      $("btnAddSys").addEventListener("click", function(){ openPrompt("sys"); });
      $("btnAddSource").addEventListener("click", function(){ openPrompt("source"); });

      $("pClose").addEventListener("click", closePrompt);
      $("pCancel").addEventListener("click", closePrompt);
      $("pOk").addEventListener("click", confirmPrompt);
      $("pInput").addEventListener("keydown", function(e){ if(e.key==="Enter"){ e.preventDefault(); confirmPrompt(); } });

      $("tokenClose").addEventListener("click", closeToken);
      $("tokenToggle").addEventListener("click", tokenToggle);
      $("tokenSave").addEventListener("click", tokenSave);
      $("tokenClear").addEventListener("click", tokenClear);

      $("loginClose").addEventListener("click", closeLogin);
      $("loginBtn").addEventListener("click", doLogin);
      $("loginPass").addEventListener("keydown", function(e){ if(e.key==="Enter"){ e.preventDefault(); doLogin(); } });
      $("loginToAuth").addEventListener("click", function(){ location.href = addV("權限表.html"); });

      $("btnExport").addEventListener("click", exportBackup);
      $("btnClear").addEventListener("click", clearFilters);
      $("btnRead").addEventListener("click", function(){ setReadMode(!state.readMode); });

      $("btnCloud").addEventListener("click", function(){ syncPull(); });

      $("qText").addEventListener("input", function(){ renderAll(); });
      $("fTrade").addEventListener("change", function(){ renderFilters(); renderAll(); });
      $("fSys").addEventListener("change", function(){ renderAll(); });

      ensureSelectOptions();
    }

    // ---------------------------
    // Boot
    // ---------------------------
    async function boot(){
      wire();

      // load local state
      var local = loadDb();
      state.db = local.db || [];
      state.counter = local.counter || 0;

      // read mode
      state.readMode = (localStorage.getItem(READ_MODE_KEY)==="1");
      document.body.classList.toggle("readMode", state.readMode);
      $("btnRead").querySelector(".t").textContent = "閱讀模式：" + (state.readMode ? "開" : "關");

      // user
      state.user = getCurrentUser();
      renderAll();

      // if no user => login
      if(!state.user) openLogin();

      // attempt cloud health & pull (non-blocking)
      var ok = await cloudHealth();
      state.cloudState = ok ? "offline" : "neterr"; // show net err if unreachable
      renderHint();
      if(ok) syncPull();
    }

    boot().catch(function(e){
      console.error(e);
      toast("啟動失敗（請開 Console 檢查錯誤）", 7000);
    });

  })();
  </script>
</body>
</html>
