<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>捷運汐東線事項記錄 · Tasun</title>

  <link rel="icon" href="data:,">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- ✅ 全站版本：要與 tasun-version.json 一致（你若有更新版本，這裡請跟著改） -->
  <script>window.TASUN_APP_VER="20260127_05";</script>

  <!-- ✅ 進站必鎖定最新版 ?v=APP_VER（舊書籤也會跳轉成最新；避免無限轉） -->
  <script>
  (function(){
    try{
      var APP = (window.TASUN_APP_VER||"").toString().trim();
      if(!APP) return;
      var u = new URL(location.href);
      var cur = (u.searchParams.get("v")||"").toString().trim();
      var KEY = "tasun_force_v_once__sxdh_notes__" + (cur||"none") + "_to_" + APP;
      if(cur !== APP && !sessionStorage.getItem(KEY)){
        sessionStorage.setItem(KEY, "1");
        u.searchParams.set("v", APP);
        location.replace(u.toString());
        return;
      }
    }catch(e){}
  })();
  </script>

  <!-- ✅ 共用等待方式（全站共用）：可 push(fn) 排隊、也保留 then(fn) 相容 -->
  <script>
  (function(){
    var APP = (window.TASUN_APP_VER||"").toString().trim();
    if(!APP) return;

    var WAIT = window.__TASUN_READY__;
    if(!WAIT || typeof WAIT !== "object"){
      var _q = [];
      var _ready = false;
      var _resolve = null;
      var _p = new Promise(function(res){ _resolve = res; });

      WAIT = {
        get ready(){ return _ready; },
        push: function(fn){
          if(typeof fn !== "function") return;
          if(_ready){
            try{ fn(); }catch(e){}
          }else{
            _q.push(fn);
          }
        },
        then: function(onFulfilled, onRejected){
          return _p.then(onFulfilled, onRejected);
        },
        flush: function(){
          if(_ready) return;
          _ready = true;
          try{ _resolve(true); }catch(e){}
          var list = _q.splice(0);
          for(var i=0;i<list.length;i++){
            try{ list[i](); }catch(e){}
          }
        }
      };

      window.__TASUN_READY__ = WAIT;
    }
    window.__TASUN_WAIT__ = WAIT;

    function addV(src){
      return src + (src.indexOf("?")>=0 ? "&" : "?") + "v=" + encodeURIComponent(APP);
    }
    function hasScript(id){
      return !!document.querySelector('script[data-tasun-id="'+id+'"]');
    }
    function loadOnce(id, src){
      return new Promise(function(resolve){
        if(hasScript(id)) return resolve(true);
        var s = document.createElement("script");
        s.src = src;
        s.async = false;
        s.setAttribute("data-tasun-id", id);
        s.onload  = function(){ resolve(true); };
        s.onerror = function(){ resolve(false); };
        document.head.appendChild(s);
      });
    }

    // ✅ core → boot
    (async function(){
      try{
        if(!window.TasunCore) await loadOnce("tasun-core", addV("tasun-core.js"));
        await loadOnce("tasun-boot", addV("tasun-boot.js"));
      }catch(e){}
      try{ if(!WAIT.ready) WAIT.flush(); }catch(e){}
    })();
  })();
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700;800;900&family=Noto+Serif+TC:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#dbe3e1;
      --bg1:#c7d4d1;

      --ink:#111;
      --paper: rgba(255,255,255,.96);
      --paper2: rgba(255,255,255,.92);

      --border: rgba(0,0,0,.18);
      --border2: rgba(0,0,0,.28);

      --r:18px;
      --shadow: 0 16px 44px rgba(0,0,0,.10);
      --shadow2: 0 10px 26px rgba(0,0,0,.08);

      --goldHi: rgba(255,254,246,.98);
      --goldText: rgba(246,214,150,.98);
      --goldDeep: rgba(170,110,18,.98);

      --strokeBlack: rgba(0,0,0,.58);
      --strokeBlackStrong: rgba(0,0,0,.72);
      --olPx: .78px;

      --titleSize: clamp(28px, 2.6vw, 42px);
      --subSize:   clamp(12.5px, 1.05vw, 15.5px);
      --labelSize: clamp(13.5px, 1.00vw, 15.5px);
      --ctrlSize:  clamp(13.5px, 1.05vw, 16px);
      --thSize:    clamp(15px, 1.10vw, 17px);
      --tdSize:    clamp(14.5px, 1.06vw, 16.5px);

      --readTitle: clamp(14.5px, 1.12vw, 17px);
      --readBody:  clamp(14.5px, 1.10vw, 17.5px);

      --wTitle: 820;
      --wStrong: 800;
      --wUI: 700;
      --wTable: 650;
      --wBtn: 720;

      --modalTitleSize: clamp(18px, 1.7vw, 24px);

      --stageSide: clamp(16px, 3.2vw, 1.6cm);

      --tableWrapBg: rgba(255,252,244,.94);
      --tableBg: rgba(255,252,244,.92);
      --tableHeadBg: rgba(252,240,218,.96);
      --tableStripe: rgba(40,120,90,.035);
      --tableHover: rgba(170,110,18,.060);
      --tableSel: rgba(170,110,18,.120);
      --tableLine: rgba(90,60,20,.180);
      --tableText: rgba(22,18,14,.92);
      --tableMuted: rgba(90,60,20,.55);

      /* ✅ 按鍵：字體大小仍自適應；文字改「細、無暗影」 */
      --btnFont: clamp(14.5px, 1.12vw, 17px);
      --btnFontSmall: clamp(13.5px, 1.06vw, 16px);

      --btnBg1: rgba(255,255,255,.70);
      --btnBg2: rgba(255,255,255,.54);
      --btnBgGhost1: rgba(255,255,255,.62);
      --btnBgGhost2: rgba(255,255,255,.46);
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    html{
      background:
        radial-gradient(1000px 560px at 50% 120px, rgba(255,255,255,.55), transparent 64%),
        radial-gradient(1200px 900px at 32% 36%, rgba(255,255,255,.40), transparent 68%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    body{
      margin:0;
      color:var(--ink);
      font-family:"Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      background: inherit;
      overflow:hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }

    /* ✅ 全站一般文字：去陰影 */
    :where(.sub,.label,.pill,.hint,.miniHint,.loginErr,.loginHint,.toast,
           thead th, tbody td,
           .noteTag,.noteNo,.noteBody){
      text-shadow: none !important;
      filter: none !important;
    }

    .goldCrystal{
      display:inline-block;
      --_ol: var(--strokeBlack);
      --_olpx: var(--olPx);
      background:
        linear-gradient(180deg,
          var(--goldHi) 0%,
          rgba(255,246,224,.98) 18%,
          var(--goldText) 46%,
          rgba(226,156,54,.98) 78%,
          var(--goldHi) 100%);
      -webkit-background-clip:text;
      background-clip:text;

      color: var(--goldDeep);
      text-shadow:
        var(--_olpx) 0 0 var(--_ol),
        calc(var(--_olpx) * -1) 0 0 var(--_ol),
        0 var(--_olpx) 0 var(--_ol),
        0 calc(var(--_olpx) * -1) 0 var(--_ol),
        var(--_olpx) var(--_olpx) 0 var(--_ol),
        var(--_olpx) calc(var(--_olpx) * -1) 0 var(--_ol),
        calc(var(--_olpx) * -1) var(--_olpx) 0 var(--_ol),
        calc(var(--_olpx) * -1) calc(var(--_olpx) * -1) 0 var(--_ol);
      filter:none;
    }
    @supports (-webkit-background-clip:text) or (background-clip:text){
      .goldCrystal{
        color: transparent;
        -webkit-text-fill-color: transparent;
      }
    }

    .goldCrystalModal{
      display:inline-block;
      --_ol: var(--strokeBlackStrong);
      --_olpx: calc(var(--olPx) + .10px);
      background:
        linear-gradient(180deg,
          rgba(255,254,246,.99) 0%,
          rgba(255,248,228,.99) 18%,
          rgba(252,228,170,.99) 46%,
          rgba(235,168,64,.99) 78%,
          rgba(255,254,246,.99) 100%);
      -webkit-background-clip:text;
      background-clip:text;

      color: var(--goldDeep);
      text-shadow:
        var(--_olpx) 0 0 var(--_ol),
        calc(var(--_olpx) * -1) 0 0 var(--_ol),
        0 var(--_olpx) 0 var(--_ol),
        0 calc(var(--_olpx) * -1) 0 var(--_ol),
        var(--_olpx) var(--_olpx) 0 var(--_ol),
        var(--_olpx) calc(var(--_olpx) * -1) 0 var(--_ol),
        calc(var(--_olpx) * -1) var(--_olpx) 0 var(--_ol),
        calc(var(--_olpx) * -1) calc(var(--_olpx) * -1) 0 var(--_ol);
      filter:none;
    }
    @supports (-webkit-background-clip:text) or (background-clip:text){
      .goldCrystalModal{
        color: transparent;
        -webkit-text-fill-color: transparent;
      }
    }

    .wrap{
      width: min(1720px, calc(100vw - (2 * var(--stageSide))));
      margin:0 auto;
      padding: 18px 16px 18px;
      height:100vh;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .topbar{
      position:relative;
      z-index:20;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      gap:12px;
      align-items:center;
      padding:14px 14px;
      border:1px solid var(--border2);
      border-radius:var(--r);
      background: linear-gradient(180deg, var(--paper), var(--paper2));
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }

    @media (max-width:920px){
      .topbar{ grid-template-columns:1fr; }
      .nav-left{ order:0; }
      .brand{ order:1; }
      .right{ order:2; justify-content:flex-start; }
    }

    .nav-left{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:flex-start;
      min-width:220px;
    }
    .nav-desktop{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .nav-mobile{ display:none; gap:10px; align-items:center; width:100%; }
    @media (max-width:600px){
      .nav-desktop{ display:none; }
      .nav-mobile{ display:flex; }
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:center;
      justify-content:center;
      text-align:center;
    }

    .title{
      font-family:"Noto Serif TC","Noto Sans TC",serif;
      font-weight:var(--wTitle);
      letter-spacing:.10em;
      font-size: var(--titleSize);
      line-height:1.12;
    }
    .sub{
      font-size: var(--subSize);
      color: rgba(0,0,0,.55);
      letter-spacing:.10em;
      font-weight:var(--wUI);
      text-align:center;
    }

    .right{
      display:flex; gap:10px;
      align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
      min-width:220px;
    }
    @media (max-width:920px){ .right{ justify-content:flex-start; } }

    .pill{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.90);
      font-size:14px;
      color: rgba(0,0,0,.78);
      display:flex; gap:8px; align-items:center; white-space:nowrap;
      box-shadow: var(--shadow2);
      font-weight:800;
      letter-spacing:.03em;
    }
    .pill b{ font-weight:900; color: rgba(0,0,0,.86); }

    /* ✅✅✅ 按鈕：文字更細、無暗影 */
    .btn{
      position:relative;
      appearance:none;
      border:1px solid var(--border2);
      background: linear-gradient(180deg, var(--btnBg1), var(--btnBg2));
      padding:11px 16px;
      border-radius:999px;
      cursor:pointer;
      font-family:inherit;
      font-weight:var(--wBtn);
      letter-spacing:.05em;
      font-size: var(--btnFont);
      box-shadow: 0 12px 22px rgba(0,0,0,.10);
      transition:transform .12s ease, border-color .12s ease, box-shadow .12s ease;
      user-select:none;
      white-space:nowrap;
      color: rgba(0,0,0,.82);
      overflow:hidden;
    }
    .btn::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(240px 110px at 26% 20%, rgba(255,255,255,.12), transparent 66%);
      opacity:.28;
      z-index:0;
    }
    .btn:hover{
      transform:translateY(-1px);
      border-color: rgba(0,0,0,.40);
      box-shadow: 0 14px 26px rgba(0,0,0,.12);
    }
    .btn:active{transform:none}
    .btn.ghost{
      background: linear-gradient(180deg, var(--btnBgGhost1), var(--btnBgGhost2));
      border:1px solid var(--border);
    }
    .btn.ghost::before{
      background: radial-gradient(220px 100px at 26% 18%, rgba(255,255,255,.10), transparent 68%);
      opacity:.22;
    }
    .btn.danger{ border-color: rgba(0,0,0,.42); }

    .small{
      padding:10px 14px;
      font-size: var(--btnFontSmall);
      border-radius:999px;
      letter-spacing:.05em;
    }
    .btn[disabled]{opacity:.45; cursor:not-allowed; transform:none !important;}

    /* ✅✅✅（重點）按鍵文字：更細、無暗影（完全移除 text-shadow） */
    .btn .t{
      position:relative;
      z-index:1;
      display:inline-block;
      color: rgba(120,64,6,.98);
      font-weight:700;
      letter-spacing:.04em;
      line-height:1.12;
      text-shadow: none !important;
      filter:none !important;
    }

    .panel{
      border:1px solid var(--border2);
      border-radius:var(--r);
      background: linear-gradient(180deg, var(--paper), var(--paper2));
      box-shadow: var(--shadow);
      padding:14px;
      overflow:hidden;
      position:relative;
      flex:1;
      display:flex;
      flex-direction:column;
      min-height:0;
      backdrop-filter:none;
      -webkit-backdrop-filter:none;
    }

    .panelHead{
      position:relative;
      z-index:2;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:0 0 auto;
    }

    .controls{
      display:grid;
      grid-template-columns: 1.3fr .9fr .9fr auto;
      gap:10px;
      align-items:end;
    }
    @media (max-width:920px){ .controls{grid-template-columns:1fr 1fr} }
    @media (max-width:520px){ .controls{grid-template-columns:1fr} }

    .field{display:flex; flex-direction:column; gap:6px}
    .label{
      font-size: var(--labelSize);
      letter-spacing:.08em;
      font-weight:var(--wUI);
      color: rgba(0,0,0,.70);
      text-align:center;
    }

    input,select,textarea{
      width:100%;
      border-radius:14px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.96);
      color: rgba(0,0,0,.86);
      padding:11px 12px;
      font-family:"Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      font-size: var(--ctrlSize);
      font-weight:700;
      outline:none;
      transition:border-color .12s ease, box-shadow .12s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      text-shadow: none;
      backdrop-filter:none;
      -webkit-backdrop-filter:none;
    }
    input:focus,select:focus,textarea:focus{
      border-color: rgba(0,0,0,.46);
      box-shadow:
        0 0 0 3px rgba(0,0,0,.08),
        0 12px 26px rgba(0,0,0,.10);
    }
    textarea{min-height:92px; resize:vertical;}
    input::placeholder{ color: rgba(0,0,0,.40); }
    select{ text-align:center; text-align-last:center; font-weight:800; }
    select option{
      background: #ffffff;
      color: rgba(0,0,0,.88);
    }

    .hint{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:center;
      padding:9px 10px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.92);
      box-shadow: 0 12px 26px rgba(0,0,0,.08);
      color: rgba(0,0,0,.78);
      font-size:14px;
      line-height:1.55;
      font-weight:900;
      letter-spacing:.04em;
    }
    .hint .hb{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.14);
      background: rgba(255,255,255,.86);
      box-shadow: none;
      white-space:nowrap;
    }
    .hint .hb .k{
      color: rgba(0,0,0,.62);
      font-weight:900;
      letter-spacing:.04em;
    }
    .hint .hb .v{
      color: rgba(0,0,0,.84);
      font-weight:900;
    }
    .hint .hb.ok .v{ color: rgba(0,0,0,.84); }
    .hint .hb.bad .v{ color: rgba(170,60,60,.92); }

    .panelBody{
      position:relative;
      z-index:2;
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
    }

    .tableWrap{
      position:relative;
      margin-top:4px;
      overflow:auto;
      border-radius:16px;
      border:1px solid var(--border2);
      background: var(--tableWrapBg);
      box-shadow: var(--shadow2);
      flex:1;
      min-height:0;
      backdrop-filter:none;
      -webkit-backdrop-filter:none;
      -webkit-overflow-scrolling: touch;
    }

    table{
      width:100%;
      border-collapse:collapse;
      min-width:1460px;
      background: var(--tableBg);
      font-family:"Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
    }

    thead th{
      position:sticky; top:0; z-index:3;
      padding:13px 10px;
      border-bottom:1px solid var(--tableLine);
      white-space:nowrap;
      text-align:center;
      letter-spacing:.06em;
      font-size: var(--thSize);
      font-weight:900;
      color: rgba(30,22,16,.92);
      background: var(--tableHeadBg);
    }

    tbody td{
      padding:13px 10px;
      border-bottom:1px solid var(--tableLine);
      vertical-align:top;
      font-size: var(--tdSize);
      color: var(--tableText);
      line-height:1.75;
      font-weight:700;
      letter-spacing:0;
      background: transparent;
    }
    tbody td:nth-child(2),
    tbody td:nth-child(7){
      text-align: justify;
      text-justify: inter-ideograph;
      word-break: break-word;
    }

    tbody tr:nth-child(even) td{ background: var(--tableStripe); }
    tbody tr:hover td{ background: var(--tableHover); }
    tbody tr.sel td{ background: var(--tableSel); }

    .muted{ color: var(--tableMuted); opacity:1; }

    .attBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.88);
      cursor:pointer;
      white-space:nowrap;
      box-shadow: 0 10px 20px rgba(0,0,0,.08);
      font-weight:900;
    }
    .attBtn .t{
      color: rgba(0,0,0,.82);
      letter-spacing:.04em;
      font-weight:900;
      text-shadow:none !important;
    }

    .mask{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:100;
      background: rgba(0,0,0,.45);
    }

    .modal{
      width:min(980px, 96vw);
      border-radius:22px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.98);
      box-shadow:0 32px 110px rgba(0,0,0,.35);
      overflow:hidden;
      position:relative;
    }

    .mHead{
      padding:14px 16px;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap:10px;
      border-bottom:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.98);
      min-height:56px;
    }
    .mTitle{
      grid-column:2;
      justify-self:center;
      letter-spacing:.14em;
      font-family:"Noto Serif TC","Noto Sans TC",serif;
      font-size: var(--modalTitleSize);
      font-weight:900;
      white-space:nowrap;
    }
    .mHead .btn{ grid-column:3; justify-self:end; }

    .mBody{ padding:14px 16px 16px; color: rgba(0,0,0,.86); }
    .modal .label{ color: rgba(0,0,0,.70); }

    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .span2{grid-column:span 2}
    @media (max-width:720px){
      .grid{grid-template-columns:1fr}
      .span2{grid-column:span 1}
      table{min-width:1320px}
    }

    .inline2{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end}
    @media (max-width:520px){
      .inline2{ grid-template-columns: 1fr; }
      .mHead{ grid-template-columns: 1fr auto; }
      .mTitle{ grid-column:1; justify-self:start; }
      .mHead .btn{ grid-column:2; }
    }

    .miniHint{
      font-size:12px; line-height:1.6; font-weight:700;
      color: rgba(0,0,0,.55); text-align:center;
    }

    .mFoot{
      padding:14px 16px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      border-top:1px solid rgba(0,0,0,.10);
      flex-wrap:wrap;
      background: rgba(255,255,255,.98);
    }

    .pMask{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:160;
    }
    .pModal{
      width:min(560px, 96vw);
      border-radius:20px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.98);
      box-shadow:0 30px 90px rgba(0,0,0,.32);
      overflow:hidden;
    }
    .pHead{
      padding:12px 14px;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      border-bottom:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.98);
      min-height:52px;
    }
    .pTitle{
      grid-column:2;
      justify-self:center;
      letter-spacing:.14em;
      font-size: clamp(16px, 1.6vw, 22px);
      font-family:"Noto Serif TC","Noto Sans TC",serif;
      font-weight:900;
      white-space:nowrap;
    }
    .pHead .btn{ grid-column:3; justify-self:end; }
    .pBody{padding:14px;}
    .pFoot{
      padding:12px 14px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      border-top:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.98);
    }

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.96);
      color: rgba(0,0,0,.84);
      font-size:14px;
      box-shadow: 0 18px 50px rgba(0,0,0,.20);
      display:none;
      z-index:200;
      font-weight:800;
      letter-spacing:.06em;
    }

    .loginMask{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:999;
    }
    .loginMask.show{display:flex;}
    .loginModal{
      width:min(520px, 96vw);
      border-radius:22px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.98);
      box-shadow:0 30px 90px rgba(0,0,0,.32);
      overflow:hidden;
      position:relative;
    }
    .loginHead{
      padding:14px 16px;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      border-bottom:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.98);
      min-height:56px;
    }
    .loginTitle{
      grid-column:2;
      justify-self:center;
      font-weight:900; letter-spacing:.14em;
      font-family:"Noto Serif TC","Noto Sans TC",serif;
      font-size: clamp(16px, 1.6vw, 22px);
      white-space:nowrap;
    }
    .loginHead .btn{ grid-column:3; justify-self:end; }
    .loginBody{padding:14px 16px 10px;}
    .loginFoot{
      padding:12px 16px;
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      border-top:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.98);
    }
    .loginErr{
      margin-top:10px;
      color:rgba(170,60,60,.95);
      font-size:14px;
      line-height:1.6;
      display:none;
      white-space:pre-wrap;
      font-weight:900;
      text-align:center;
    }
    .loginHint{
      margin-top:10px;
      color: rgba(0,0,0,.60);
      font-size:12.5px;
      line-height:1.7;
      font-weight:700;
      text-align:center;
    }

    body.readMode #tbl{ display:none; }
    body.readMode #cards{ display:block !important; padding:10px 6px; }
    body:not(.readMode) #tbl{ display:table; }
    body:not(.readMode) #cards{ display:none !important; }

    #cards{
      display:none;
      overflow:auto;
      max-height:100%;
      -webkit-overflow-scrolling: touch;
    }

    .noteCard{
      border-radius:16px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.96);
      box-shadow: 0 14px 26px rgba(0,0,0,.10);
      padding:12px 12px;
      margin:10px 4px;
      color: rgba(0,0,0,.86);
      cursor:pointer;
    }
    .noteCard.sel{
      outline: 2px solid rgba(0,0,0,.18);
      box-shadow: 0 18px 34px rgba(0,0,0,.12);
    }

    .noteHead{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .noteMeta{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      font-weight:900;
      letter-spacing:.04em;
    }

    .noteTag{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.14);
      background: rgba(0,0,0,.03);
      color: rgba(0,0,0,.78);
      font-size:13px;
      white-space:nowrap;
    }

    .noteNo{
      font-family:"Noto Serif TC","Noto Sans TC",serif;
      font-weight:900;
      letter-spacing:.06em;
      color: rgba(0,0,0,.88);
      white-space:nowrap;
    }

    .noteBody{
      margin-top:10px;
      line-height:1.85;
      font-size: var(--readBody);
      white-space:pre-wrap;
      word-break:break-word;
      color: rgba(0,0,0,.86);
    }

    .noteCard:not(.open) .noteBody{
      display:-webkit-box;
      -webkit-line-clamp:3;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }

    .noteMore{ margin-top:10px; display:none; opacity:.92; }
    .noteCard.open .noteMore{ display:block; }

    .noteActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }

    /* ✅✅✅ 手機版：上端更緊湊；hint 變單列可橫向滑動（高度變小）；預設仍「表格」 */
    @media (max-width:720px){
      :root{
        --stageSide: 10px;
        --titleSize: clamp(20px, 5.0vw, 28px);
        --subSize: clamp(11px, 3.2vw, 13px);
        --btnFont: 14px;
        --btnFontSmall: 13px;
      }
      .wrap{
        height:100dvh;
        padding:10px 10px 12px;
        gap:10px;
      }
      .topbar{
        padding:10px 10px;
        gap:10px;
      }
      .brand{ gap:4px; }
      .pill{
        padding:6px 9px;
        font-size:12.5px;
        box-shadow: 0 10px 18px rgba(0,0,0,.08);
      }
      .right{ gap:8px; }
      .btn{ padding:9px 12px; box-shadow: 0 10px 16px rgba(0,0,0,.10); }
      .small{ padding:8px 10px; }

      .panel{ padding:10px; overflow:hidden; }
      .panelHead{ gap:8px; }

      .controls{ gap:8px; }
      .field{ gap:5px; }
      input,select,textarea{ padding:10px 11px; border-radius:12px; }

      /* ✅ hint：單列橫向滾動，避免佔用太多高度 */
      .hint{
        justify-content:flex-start;
        flex-wrap:nowrap;
        overflow:auto;
        -webkit-overflow-scrolling: touch;
        padding:7px 8px;
        gap:7px;
      }
      .hint .hb{ flex:0 0 auto; padding:5px 9px; }

      /* ✅ 手機：controls 固定、表格區滾動 */
      .panelHead{ position:sticky; top:0; z-index:6; background: transparent; }
      .tableWrap{ flex:1; min-height:0; }

      /* ✅ 手機：表格仍可顯示（預設表格）；必要時左右滑 */
      table{ min-width:1240px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="nav-left">
        <div class="nav-desktop">
          <button class="btn ghost small" id="navBack"><span class="t">返回汐東工程管理表</span></button>
        </div>

        <div class="nav-mobile">
          <button class="btn ghost small" id="mBack"><span class="t">返回</span></button>
          <div class="moreWrap" style="position:relative; display:inline-flex;">
            <button class="btn ghost small" id="mMoreBtn" type="button"><span class="t">更多 ▾</span></button>
            <div class="moreMenu" id="mMoreMenu" style="display:none; position:absolute; top:calc(100% + 8px); right:0; min-width:220px; border-radius:16px; border:1px solid rgba(0,0,0,.20); background:rgba(255,255,255,.98); box-shadow:0 18px 50px rgba(0,0,0,.20); padding:8px; z-index:60;">
              <button class="menuItem" data-href="汐東工程管理表.html" type="button" style="width:100%; text-align:left; border:none; background:rgba(0,0,0,.03); color:rgba(0,0,0,.86); padding:10px 12px; border-radius:12px; cursor:pointer; font-family:inherit; letter-spacing:.04em; font-weight:800;">汐東工程管理表</button>
              <div class="menuSep" style="height:1px; margin:8px 6px; background:rgba(0,0,0,.10);"></div>
              <button class="menuItem" data-href="index.html" type="button" style="width:100%; text-align:left; border:none; background:rgba(0,0,0,.03); color:rgba(0,0,0,.86); padding:10px 12px; border-radius:12px; cursor:pointer; font-family:inherit; letter-spacing:.04em; font-weight:800;">返回首頁</button>
            </div>
          </div>
        </div>
      </div>

      <div class="brand">
        <div class="title goldCrystal">捷運汐東線事項記錄</div>
        <div class="sub">記事內容 · 工種 · 系統 · 出處 · 附件 · 登錄日期</div>
      </div>

      <div class="right">
        <div class="pill">使用者：<b id="uName">—</b></div>
        <div class="pill">權限：<b id="uRole">—</b></div>

        <button class="btn small" id="btnView"><span class="t">檢視</span></button>
        <button class="btn small" id="btnAdd" style="display:none;"><span class="t">新增</span></button>
        <button class="btn small" id="btnEdit" style="display:none;"><span class="t">編輯</span></button>

        <!-- ✅ 右上雲端設定（僅 admin 顯示） -->
        <button class="btn small" id="btnToken" style="display:none;"><span class="t">雲端設定</span></button>
      </div>
    </div>

    <div class="panel">
      <div class="panelHead">
        <div class="controls">
          <div class="field">
            <div class="label">搜尋（記事內容）</div>
            <input id="qText" placeholder="可輸入關鍵字，例如：送審、會議、現勘..." />
          </div>

          <div class="field">
            <div class="label">工種</div>
            <select id="fTrade"><option value="">全部</option></select>
          </div>

          <div class="field">
            <div class="label">系統</div>
            <select id="fSys"><option value="">全部</option></select>
          </div>

          <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
            <button class="btn ghost" id="btnCloud" type="button"><span class="t">雲端檔案</span></button>
            <button class="btn ghost" id="btnExport" type="button"><span class="t">匯出備份</span></button>
            <button class="btn ghost" id="btnRead"><span class="t">閱讀模式：關</span></button>
            <button class="btn ghost" id="btnClear"><span class="t">清除條件</span></button>
          </div>
        </div>

        <div class="hint" id="hint"></div>
      </div>

      <div class="panelBody">
        <div class="tableWrap">
          <div id="cards" style="display:none; position:relative; z-index:2;"></div>

          <table id="tbl">
            <thead>
              <tr>
                <th style="width:90px;">項次</th>
                <th>記事內容</th>
                <th style="width:150px;">工種</th>
                <th style="width:150px;">系統</th>
                <th style="width:150px;">出處</th>
                <th style="width:160px;">附件</th>
                <th style="width:220px;">備註</th>
                <th style="width:140px;">登錄日期</th>
                <th style="width:140px;">操作</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit/View Modal -->
  <div class="mask" id="mask">
    <div class="modal">
      <div class="mHead">
        <div></div>
        <div class="mTitle goldCrystalModal" id="mTitle">查看</div>
        <button class="btn ghost small" id="btnClose"><span class="t">關閉</span></button>
      </div>

      <div class="mBody">
        <div class="grid">
          <div class="field span2">
            <div class="label">記事內容</div>
            <textarea id="mText" placeholder="請輸入記事內容（可多行）..."></textarea>
          </div>

          <div class="field">
            <div class="label">工種（下拉；可新增選項）</div>
            <div class="inline2">
              <select id="mTradeSel"></select>
              <button class="btn ghost small" id="btnAddTrade" type="button"><span class="t">新增工種</span></button>
            </div>
            <div class="miniHint">選單來源：本頁資料不重複 + 工種字典（可改）。</div>
          </div>

          <div class="field">
            <div class="label">系統（下拉；可新增選項）</div>
            <div class="inline2">
              <select id="mSysSel"></select>
              <button class="btn ghost small" id="btnAddSys" type="button"><span class="t">新增系統</span></button>
            </div>
            <div class="miniHint">✅ 系統會依「工種」篩選；可輸入既有系統名稱來「綁定」到目前工種。</div>
          </div>

          <div class="field span2">
            <div class="label">出處（下拉；可新增）</div>
            <div class="inline2">
              <select id="mSourceSel"></select>
              <button class="btn ghost small" id="btnAddSource" type="button"><span class="t">新增出處</span></button>
            </div>
            <div class="miniHint">選單來源：本頁資料「出處」不重複 + 出處字典。</div>
          </div>

          <div class="field span2">
            <div class="label">附件（超連結）</div>
            <div class="inline2">
              <input id="mAttach" placeholder="貼上連結，例如：https://... / Dropbox 連結 / file:///..." />
              <button class="btn ghost small" id="btnNetDisk" type="button"><span class="t">網路硬碟</span></button>
            </div>
            <div class="miniHint">可留空。若是相對網址（同網站檔案），會自動帶 v 並可開啟。</div>
          </div>

          <div class="field span2">
            <div class="label">備註</div>
            <textarea id="mRemark" placeholder="可輸入備註（可多行）..."></textarea>
          </div>

          <div class="field">
            <div class="label">登錄日期（可改）</div>
            <input id="mDate" type="date" />
            <div class="miniHint">預設為今日；可用日曆修改。</div>
          </div>

          <div class="field">
            <div class="label">項次（固定：由小到大排序）</div>
            <input id="mNo" disabled />
          </div>
        </div>
      </div>

      <div class="mFoot">
        <button class="btn danger" id="btnDelete" style="display:none;"><span class="t">刪除</span></button>
        <button class="btn ghost" id="btnCancel"><span class="t">取消</span></button>
        <button class="btn" id="btnSave"><span class="t">儲存</span></button>
      </div>
    </div>
  </div>

  <!-- Prompt：新增 工種/系統/出處 -->
  <div class="pMask" id="pMask">
    <div class="pModal">
      <div class="pHead">
        <div></div>
        <div class="pTitle goldCrystalModal" id="pTitle">新增</div>
        <button class="btn ghost small" id="pClose" type="button"><span class="t">關閉</span></button>
      </div>
      <div class="pBody">
        <div class="field">
          <div class="label" id="pLabel">請輸入</div>
          <input id="pInput" placeholder="例如：機電 / 土建 / ..."/>
          <div class="miniHint" id="pHint">新增後會加入「選單字典」，且系統會綁到目前工種。</div>
        </div>
      </div>
      <div class="pFoot">
        <button class="btn ghost" id="pCancel" type="button"><span class="t">取消</span></button>
        <button class="btn" id="pOk" type="button"><span class="t">確定新增</span></button>
      </div>
    </div>
  </div>

  <!-- ✅ 雲端設定（D1 + Access） -->
  <div class="loginMask" id="tokenMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="雲端設定">
      <div class="loginHead">
        <div></div>
        <div class="loginTitle goldCrystalModal" id="cloudCfgTitle">雲端設定（D1 / Access）</div>
        <button class="btn ghost small" id="tokenClose" type="button"><span class="t">關閉</span></button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label" id="cloudCfgLabel">貼上（可擇一）</div>
          <input id="tokenInput" type="password" placeholder="① https://API_BASE ② CLIENT_ID ③ CLIENT_SECRET（用空白或 | 分隔）" autocomplete="off" />
        </div>
        <div class="loginErr" id="tokenErr"></div>
        <div class="loginHint" id="tokenHint">目前狀態：—</div>
        <div class="loginHint">
          ✅ 你可以貼：
          <b>API_BASE|CLIENT_ID|CLIENT_SECRET</b>（或用空白/逗號分隔），也可只貼 <b>CLIENT_ID|CLIENT_SECRET</b>。<br>
          若你是「使用者互動登入 Access（cookie）」：可不填 token，只要按「雲端檔案」去觸發 Access 登入一次即可。
        </div>
      </div>
      <div class="loginFoot">
        <button class="btn danger" id="tokenClear" type="button"><span class="t">清除</span></button>
        <button class="btn ghost" id="tokenToggle" type="button"><span class="t">顯示/隱藏</span></button>
        <button class="btn ghost" id="tokenNetDisk" type="button"><span class="t">網路硬碟</span></button>
        <button class="btn" id="tokenSave" type="button"><span class="t">儲存</span></button>
      </div>
    </div>
  </div>

  <!-- Login Modal（DOM 保留；登入邏輯由 tasun-core.js 的 TasunCore.Auth 接管） -->
  <div class="loginMask" id="loginMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="登入">
      <div class="loginHead">
        <div></div>
        <div class="loginTitle goldCrystal">登入</div>
        <button class="btn ghost small" id="loginClose" type="button"><span class="t">關閉</span></button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label">帳號</div>
          <select id="loginUser" autocomplete="username">
            <option value="">請選擇帳號</option>
          </select>
        </div>
        <div class="field" style="margin-top:10px;">
          <div class="label">密碼</div>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="請輸入密碼" />
        </div>
        <div class="loginErr" id="loginErr"></div>
        <div class="loginHint">
          登入帳密完全以「權限表.html」的權限表（localStorage: <b>tasunAuthTable_v1</b>）為準。
        </div>
      </div>
      <div class="loginFoot">
        <button class="btn ghost" id="loginToAuth" type="button"><span class="t">前往權限表</span></button>
        <button class="btn" id="loginBtn" type="button"><span class="t">登入</span></button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
  (function(){
    "use strict";

    function run(){
      var Core = window.TasunCore;
      if(!Core || !Core.Auth){
        console.error("TasunCore/Auth not ready.");
        return;
      }

      var PAGE_KEY = "sxdh-notes";
      var PAGE_SCHEMA = "sxdh-notes-v1";

      Core.init({
        pageKey: PAGE_KEY,
        forceUrlV: true,
        forceVersionSync: true,
        patchResources: true,
        networkToast: false,
        appHeightVar: false
      });

      var Auth = Core.Auth;
      var withV = Core.withV;

      var DB_KEY      = "tasunSxdhNotes_v1";
      var COUNTER_KEY = "tasunSxdhNotes_counter_v1";

      var BACKUP_KEY  = DB_KEY + "__backup_v1";
      var BK1_KEY     = DB_KEY + "__backup_1";
      var BK2_KEY     = DB_KEY + "__backup_2";
      var BK3_KEY     = DB_KEY + "__backup_3";

      var EXPORT_LAST_KEY = DB_KEY + "__export_last_v1";
      var LEAVE_SNAP_KEY  = DB_KEY + "__leave_snapshot_v1";

      var SAFETY_SNAPSHOT_KEY = DB_KEY + "__safety_snapshot_v1";
      var PROTECT_EMPTY_REMOTE_KEY = "tasun_protect_empty_remote__" + DB_KEY;

      var LEGACY_DB_KEYS = [
        "tasunSxdhNotes_v1","tasunSxdhNotes_v0","tasunSxdhNotes",
        "tasunXidongNotes_v1","tasunXidongNotes_v0","tasunXidongNotes",
        "tasunNotes_sxdh_v1","tasunNotes_xidong_v1"
      ];
      var LEGACY_COUNTER_KEYS = [
        COUNTER_KEY,
        "tasunSxdhNotes_counter_v0",
        "tasunXidongNotes_counter_v1","tasunXidongNotes_counter_v0",
        "tasunNotes_sxdh_counter_v1","tasunNotes_xidong_counter_v1"
      ];

      var TRADE_DICT_KEY = "tasunSxdhNotes_tradeDict_v1";
      var SYS_DICT_KEY   = "tasunSxdhNotes_sysDict_v1";
      var SOURCE_DICT_KEY = "tasunSxdhNotes_sourceDict_v1";
      var TRADE_SYS_MAP_KEY = "tasunSxdhNotes_tradeSysMap_v1";
      var READ_MODE_KEY  = "tasunSxdhNotes_readMode_v1";

      var D1_API_BASE_KEY = "tasunD1ApiBase_v1";
      var ACCESS_ST_KEY   = "tasunAccessServiceToken_v1";

      var D1_PING_PATH  = "/api/tasun/ping";
      var D1_PULL_PATH  = "/api/tasun/pull";
      var D1_MERGE_PATH = "/api/tasun/merge";

      var CLOUD_RESOURCE_KEY = PAGE_KEY;
      var CLOUD_PK = "k";
      var SETTINGS_UID = "__settings__";

      var NET_DISK_URL = "https://www.dropbox.com/scl/fo/glb4s65934h195bxuyuqm/AH5ClZ2u4MtPMvmgtfOUAa4?rlkey=tfxkpbpw8k9bctshx5xvuge8h&st=9deaoqpw&dl=0";
      var CLOUD_NETDISK_URL = "https://www.dropbox.com/developers/apps";

      var db = [];
      var editingUid = null;
      var selectedUid = null;
      var promptMode = null;

      var cloud = null;
      var cloudCreated = false;
      var cloudStarted = false;

      var lastCloudSyncAt = 0;
      var accessOk = false;

      var apiLastStatus = 0;
      var apiLastAt = 0;
      var apiLastMsg = "";
      var accessState = "unknown"; // ok | deny | unknown | neterr | noapi

      function markApiOk(){
        apiLastStatus = 200;
        apiLastAt = Date.now();
        apiLastMsg = "";
      }
      function markApiErr(e){
        apiLastStatus = Number((e && e.status) || 0) || 0;
        apiLastAt = Date.now();
        apiLastMsg = (e && (e.body || e.message)) ? String(e.body || e.message) : "";
      }

      var $ = function(id){ return document.getElementById(id); };
      var norm = function(s){ return (s===undefined||s===null) ? "" : String(s).trim(); };

      function pad2(n){ return String(n).padStart(2,"0"); }
      function fmtClock(ts){
        if(!ts) return "";
        var d = new Date(ts);
        return pad2(d.getHours()) + ":" + pad2(d.getMinutes()) + ":" + pad2(d.getSeconds());
      }

      function uuid(){
        var a = Math.random().toString(16).slice(2);
        return "u" + Date.now().toString(16) + "_" + a;
      }

      function toast(msg){
        var t = $("toast");
        t.textContent = msg;
        t.style.display = "block";
        clearTimeout(toast._tm);
        toast._tm = setTimeout(function(){ t.style.display = "none"; }, 2600);
      }

      function escHtml(s){
        return (s ?? "").toString()
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#39;");
      }

      function fnv1a(str2){
        var h = 0x811c9dc5;
        for(var i=0;i<str2.length;i++){
          h ^= str2.charCodeAt(i);
          h = Math.imul(h, 0x01000193);
        }
        return (h >>> 0).toString(16).padStart(8, "0");
      }

      function safeParseJSON(raw){
        if(!raw) return null;
        try{ return JSON.parse(raw); }catch(e){ return null; }
      }

      // ===============================
      // ✅ D1 + Access helpers
      // ===============================
      function getApiBase(){
        var b = norm(window.TASUN_D1_API_BASE);
        if(b) return b.replace(/\/+$/,"");
        try{
          b = norm(sessionStorage.getItem(D1_API_BASE_KEY));
          if(b) return b.replace(/\/+$/,"");
        }catch(e){}
        try{
          b = norm(localStorage.getItem(D1_API_BASE_KEY));
          if(b) return b.replace(/\/+$/,"");
        }catch(e){}
        return "";
      }

      function setApiBase(v){
        v = norm(v).replace(/\/+$/,"");
        try{ window.TASUN_D1_API_BASE = v; }catch(e){}
        try{
          if(v) sessionStorage.setItem(D1_API_BASE_KEY, v);
          else sessionStorage.removeItem(D1_API_BASE_KEY);
        }catch(e){}
        try{
          if(v) localStorage.setItem(D1_API_BASE_KEY, v);
          else localStorage.removeItem(D1_API_BASE_KEY);
        }catch(e){}
      }

      function getAccessServiceToken(){
        try{
          var w = window.TASUN_ACCESS_SERVICE_TOKEN;
          if(w && typeof w === "object"){
            var idw = norm(w.clientId || w.client_id || w.id || "");
            var secw = norm(w.clientSecret || w.client_secret || w.secret || "");
            if(idw && secw) return { clientId:idw, clientSecret:secw };
          }
          if(typeof w === "string"){
            var partsW = w.split(/[\s|,;]+/).map(norm).filter(Boolean);
            if(partsW.length>=2) return { clientId: partsW[0], clientSecret: partsW[1] };
          }
        }catch(e){}

        function parseStored(raw){
          raw = norm(raw);
          if(!raw) return null;
          var obj = safeParseJSON(raw);
          if(obj && typeof obj === "object"){
            var id = norm(obj.clientId || obj.id || obj.client_id || "");
            var sec = norm(obj.clientSecret || obj.secret || obj.client_secret || "");
            if(id && sec) return { clientId:id, clientSecret:sec };
          }
          var parts = raw.split(/[\s|,;]+/).map(norm).filter(Boolean);
          if(parts.length>=2) return { clientId: parts[0], clientSecret: parts[1] };
          return null;
        }

        try{
          var s1 = parseStored(sessionStorage.getItem(ACCESS_ST_KEY));
          if(s1) return s1;
        }catch(e){}
        try{
          var s2 = parseStored(localStorage.getItem(ACCESS_ST_KEY));
          if(s2) return s2;
        }catch(e){}
        return null;
      }

      function hasAccessServiceToken(){
        var st = getAccessServiceToken();
        return !!(st && st.clientId && st.clientSecret);
      }

      function setAccessServiceToken(obj){
        try{ window.TASUN_ACCESS_SERVICE_TOKEN = obj || null; }catch(e){}
        try{
          if(obj && obj.clientId && obj.clientSecret){
            sessionStorage.setItem(ACCESS_ST_KEY, JSON.stringify({ clientId: obj.clientId, clientSecret: obj.clientSecret }));
          }else{
            sessionStorage.removeItem(ACCESS_ST_KEY);
          }
        }catch(e){}
        try{
          if(obj && obj.clientId && obj.clientSecret){
            localStorage.setItem(ACCESS_ST_KEY, JSON.stringify({ clientId: obj.clientId, clientSecret: obj.clientSecret }));
          }else{
            localStorage.removeItem(ACCESS_ST_KEY);
          }
        }catch(e){}
      }

      function getAccessHeaders(){
        var st = getAccessServiceToken();
        if(!st) return {};
        return {
          "CF-Access-Client-Id": st.clientId,
          "CF-Access-Client-Secret": st.clientSecret
        };
      }

      function buildUrl(path){
        var base = getApiBase();
        if(/^https?:\/\//i.test(path)) return path;
        if(!path) path = "/";
        if(path[0] !== "/") path = "/" + path;
        return base ? (base + path) : path;
      }

      function cloudPortalUrl(){
        return buildUrl(D1_PING_PATH);
      }

      function maskApiBase(){
        var base = getApiBase();
        if(!base) return "未設定";
        try{
          var u = new URL(base);
          return u.origin;
        }catch(e){
          return base.length > 36 ? (base.slice(0,36) + "…") : base;
        }
      }

      function parseCloudCfgInput(raw){
        raw = norm(raw);
        if(!raw) return null;

        var obj = safeParseJSON(raw);
        if(obj && typeof obj === "object"){
          var apiBase = norm(obj.apiBase || obj.base || obj.url || "");
          var id = norm(obj.clientId || obj.id || obj.client_id || "");
          var sec = norm(obj.clientSecret || obj.secret || obj.client_secret || "");
          return { apiBase: apiBase, clientId: id, clientSecret: sec };
        }

        var apiBaseKV = "";
        var cidKV = "";
        var secKV = "";

        var m;
        m = raw.match(/https?:\/\/[^\s|,;]+/i);
        if(m) apiBaseKV = norm(m[0]);

        m = raw.match(/(?:client[_\s-]*id|cf[_\s-]*access[_\s-]*client[_\s-]*id)\s*[:=]\s*([^\s|,;]+)/i);
        if(m) cidKV = norm(m[1]);

        m = raw.match(/(?:client[_\s-]*secret|cf[_\s-]*access[_\s-]*client[_\s-]*secret)\s*[:=]\s*([^\s|,;]+)/i);
        if(m) secKV = norm(m[1]);

        var cleaned = raw
          .replace(/[\u2460-\u2469]/g, " ")
          .replace(/[①②③④⑤⑥⑦⑧⑨]/g, " ")
          .replace(/(API_BASE|CLIENT_ID|CLIENT_SECRET)/gi, " ")
          .replace(/(CF-Access-Client-Id|CF-Access-Client-Secret)/gi, " ")
          .replace(/(client[_\s-]*id|client[_\s-]*secret)/gi, " ")
          .replace(/[=：:]/g, " ")
          .replace(/\s+/g, " ")
          .trim();

        var parts = cleaned.split(/[\s|,;]+/).map(norm).filter(Boolean);

        var apiBase2 = apiBaseKV || "";
        if(!apiBase2){
          for(var i=0;i<parts.length;i++){
            if(/^https?:\/\//i.test(parts[i])){
              apiBase2 = parts[i];
              parts.splice(i,1);
              break;
            }
          }
        }

        var id2 = cidKV || (parts[0] || "");
        var sec2 = secKV || (parts[1] || "");

        return { apiBase: apiBase2, clientId: id2, clientSecret: sec2 };
      }

      function accessTokenMasked(){
        return hasAccessServiceToken() ? "已設定" : "未設定";
      }

      async function httpJSON(url, opt){
        opt = opt || {};
        opt.mode = "cors";
        opt.cache = "no-store";
        opt.credentials = hasAccessServiceToken() ? "omit" : "include";

        opt.headers = Object.assign(
          { "Accept": "application/json" },
          opt.headers || {},
          getAccessHeaders(),
          {
            "X-Tasun-AppVer": String(window.TASUN_APP_VER||""),
            "X-Tasun-Page": PAGE_KEY,
            "X-Tasun-User": (Auth.current() && Auth.current().username) ? String(Auth.current().username) : "",
            "X-Tasun-Role": String(Auth.role()||"")
          }
        );

        var res;
        try{
          res = await fetch(url, opt);
        }catch(err){
          var e2 = new Error(err && err.message ? err.message : "Failed to fetch");
          e2.status = 0;
          e2.code = "FETCH_FAIL";
          throw e2;
        }

        if(!res.ok){
          var body = "";
          try{ body = await res.text(); }catch(e){}
          var err2 = new Error("HTTP " + res.status + " " + res.statusText);
          err2.status = res.status;
          err2.body = body;
          if(res.status === 401 || res.status === 403){
            err2.code = "ACCESS_DENY";
          }
          throw err2;
        }

        var ct = (res.headers.get("content-type")||"").toLowerCase();
        if(ct.includes("application/json")){
          return await res.json();
        }
        var txt = await res.text();
        try{ return JSON.parse(txt); }catch(e){ return { ok:true, raw:txt }; }
      }

      function unwrapPayload(resp){
        if(resp == null) return { payload:{db:[],counter:0}, info:{} };
        var info = (resp && typeof resp === "object") ? (resp.info || resp.meta || {}) : {};
        var p = resp;
        if(p && typeof p === "object"){
          if("payload" in p) p = p.payload;
          else if("data" in p) p = p.data;
          else if("result" in p) p = p.result;
        }
        var out = (p && typeof p === "object") ? p : {};
        if(!Array.isArray(out.db)) out.db = [];
        var c = Number(out.counter || 0);
        if(!Number.isFinite(c)) c = 0;
        out.counter = c;
        return { payload: out, info: info };
      }

      async function apiPing(){
        if(!getApiBase()){
          var e0 = new Error("NO_API_BASE");
          e0.status = 0;
          e0.code = "NO_API_BASE";
          throw e0;
        }
        var url = cloudPortalUrl() + (cloudPortalUrl().includes("?") ? "&" : "?") + "_=" + Date.now();
        return await httpJSON(url, { method:"GET" });
      }

      async function apiPull(){
        if(!getApiBase()){
          var e0 = new Error("NO_API_BASE");
          e0.status = 0;
          e0.code = "NO_API_BASE";
          throw e0;
        }
        var url = buildUrl("/api/tasun/pull") + "?key=" + encodeURIComponent(CLOUD_RESOURCE_KEY) + "&_=" + Date.now();
        return await httpJSON(url, { method:"GET" });
      }

      async function apiMerge(localPayload){
        if(!getApiBase()){
          var e0 = new Error("NO_API_BASE");
          e0.status = 0;
          e0.code = "NO_API_BASE";
          throw e0;
        }
        var url = buildUrl("/api/tasun/merge");
        var body = {
          key: CLOUD_RESOURCE_KEY,
          pk: CLOUD_PK,
          idField: "id",
          counterField: "counter",
          local: localPayload,
          client: {
            ts: Date.now(),
            page: PAGE_KEY,
            user: (Auth.current() && Auth.current().username) ? String(Auth.current().username) : "",
            role: String(Auth.role()||""),
            ua: navigator.userAgent
          },
          merge: { conflictPolicy: "stash-remote" }
        };
        return await httpJSON(url, {
          method:"POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(body)
        });
      }

      function tryImportCloudCfgFromAuthTable(){
        try{
          if(!(Auth && typeof Auth.isAdmin==="function" && Auth.isAdmin())) return;

          var AUTH_KEY = "tasunAuthTable_v1";
          var raw = localStorage.getItem(AUTH_KEY);
          var tab = safeParseJSON(raw);
          if(!tab) return;

          var users = Array.isArray(tab) ? tab : (Array.isArray(tab.users) ? tab.users : null);
          if(!Array.isArray(users) || users.length===0) return;

          function pick(obj, keys){
            if(!obj || typeof obj!=="object") return "";
            for(var i=0;i<keys.length;i++){
              var v = norm(obj[keys[i]]);
              if(v) return v;
            }
            return "";
          }

          var adminRow = users.find(function(u){
            return norm(u.role).toLowerCase()==="admin" || norm(u.username).toLowerCase()==="alex";
          }) || users[0];

          var apiBase = pick(adminRow, ["apiBase","d1ApiBase","cloudApiBase","D1_API_BASE","d1_api_base"]);
          var cid = pick(adminRow, ["clientId","accessClientId","cfAccessClientId","CF_ACCESS_CLIENT_ID","cf_access_client_id"]);
          var csec = pick(adminRow, ["clientSecret","accessClientSecret","cfAccessClientSecret","CF_ACCESS_CLIENT_SECRET","cf_access_client_secret"]);

          if(!getApiBase() && apiBase && /^https?:\/\//i.test(apiBase)) setApiBase(apiBase);
          if(!hasAccessServiceToken() && cid && csec){
            setAccessServiceToken({ clientId: cid, clientSecret: csec });
          }
        }catch(e){}
      }

      function D1Cloud(cfg){
        this._cfg = cfg || {};
        this.ready = Promise.resolve(true);
        this._timer = 0;
        this._destroyed = false;

        /* ✅✅✅ push 佇列：避免保存中觸發第二次而漏掉 */
        this._saving = false;
        this._pending = false;
      }
      D1Cloud.prototype._handleErr = function(e){
        if(!e) return;

        markApiErr(e);

        if(e.code === "NO_API_BASE"){
          accessOk = false;
          accessState = "noapi";
          var k0 = "tasun_noapi_once__" + CLOUD_RESOURCE_KEY;
          try{
            if(!sessionStorage.getItem(k0)){
              sessionStorage.setItem(k0, "1");
              toast("⚠️ 尚未設定 API_BASE：請按右上「雲端設定」先貼上 API_BASE（可選貼 Service Token）。");
            }
          }catch(_e0){}
          return;
        }

        if(e && (e.code==="FETCH_FAIL" || e.status===0)){
          accessOk = false;
          accessState = "neterr";
          toast("⚠️ 雲端連線失敗：可能 API_BASE 未設定 / CORS 未放行 / 網路或 DNS 問題。請用右上「雲端設定」確認。");
          return;
        }

        if(e.code === "ACCESS_DENY" || e.status === 401 || e.status === 403){
          accessOk = false;
          accessState = "deny";
          var k = "tasun_access_deny_once__" + CLOUD_RESOURCE_KEY;
          try{
            if(!sessionStorage.getItem(k)){
              sessionStorage.setItem(k, "1");
              toast("⚠️ 雲端驗證未通過：請先完成 Access 登入（按「雲端檔案」），或在右上「雲端設定」貼上 Access Service Token。");
            }
          }catch(_e){}
          return;
        }

        if(e.status === 404){
          accessState = "unknown";
          accessOk = false;
          var k404 = "tasun_api_404_once__" + CLOUD_RESOURCE_KEY;
          try{
            if(!sessionStorage.getItem(k404)){
              sessionStorage.setItem(k404, "1");
              toast("⚠️ 雲端 API 路徑不存在（HTTP 404）。請在右上「雲端設定」填入正確 API_BASE，或確認後端路徑。");
            }
          }catch(_e2){}
          return;
        }

        toast("雲端錯誤：" + (e.message ? e.message : String(e)));
      };
      D1Cloud.prototype.pullNow = function(){
        var self = this;
        if(self._destroyed) return Promise.resolve(false);
        return apiPull().then(function(resp){
          markApiOk();
          accessOk = true;
          accessState = "ok";
          var u = unwrapPayload(resp);
          self._cfg.apply(u.payload, u.info || {});
          return true;
        }).catch(function(e){
          self._handleErr(e);
          return false;
        });
      };

      /* ✅✅✅ 保存：若保存中又觸發保存 → 設 pending，保存完會再補一次 */
      D1Cloud.prototype.saveMerged = function(){
        var self = this;
        if(self._destroyed) return Promise.resolve(false);

        if(self._saving){
          self._pending = true;
          return Promise.resolve(false);
        }

        self._saving = true;
        self._pending = false;

        var local = self._cfg.getLocal();
        return apiMerge(local).then(function(resp){
          markApiOk();
          accessOk = true;
          accessState = "ok";
          var u = unwrapPayload(resp);
          self._cfg.apply(u.payload, Object.assign({ merged:true }, u.info||{}));
          return true;
        }).catch(function(e){
          self._handleErr(e);
          return false;
        }).finally(function(){
          self._saving = false;
          if(self._pending){
            self._pending = false;
            setTimeout(function(){ self.saveMerged(); }, 0);
          }
        });
      };

      D1Cloud.prototype.startWatch = function(intervalSec){
        var self = this;
        if(self._destroyed) return;
        var sec = Number(intervalSec||0);
        if(!Number.isFinite(sec) || sec <= 0) sec = 8;
        clearInterval(self._timer);
        self._timer = setInterval(function(){ self.pullNow(); }, sec*1000);
      };
      D1Cloud.prototype.destroy = function(){
        this._destroyed = true;
        clearInterval(this._timer);
      };

      function rotateBackups(snapshotArr){
        if(!Array.isArray(snapshotArr) || snapshotArr.length===0) return;

        var snap = { ts: Date.now(), db: snapshotArr };
        try{
          var b1 = localStorage.getItem(BK1_KEY);
          var b2 = localStorage.getItem(BK2_KEY);
          if(b2) localStorage.setItem(BK3_KEY, b2);
          if(b1) localStorage.setItem(BK2_KEY, b1);
          localStorage.setItem(BK1_KEY, JSON.stringify(snap));
          localStorage.setItem(BACKUP_KEY, JSON.stringify(snap));
        }catch(e){}
      }

      function getSafetySnapshotDb(){
        try{
          var obj = safeParseJSON(localStorage.getItem(SAFETY_SNAPSHOT_KEY));
          if(obj && typeof obj === "object" && Array.isArray(obj.db) && obj.db.length>0) return obj.db;
        }catch(e){}
        return null;
      }

      function saveSafetySnapshot(reason){
        try{
          if(!Array.isArray(db) || db.length===0) return;
          var cur = safeParseJSON(localStorage.getItem(SAFETY_SNAPSHOT_KEY));
          var curLen = (cur && Array.isArray(cur.db)) ? cur.db.length : 0;
          if(db.length >= curLen){
            localStorage.setItem(SAFETY_SNAPSHOT_KEY, JSON.stringify({ ts: Date.now(), reason: reason||"", db: db }));
          }
        }catch(e){}
      }

      function restoreFromSafetySnapshot(quiet){
        quiet = !!quiet;
        var safeDb = getSafetySnapshotDb();
        if(!Array.isArray(safeDb) || safeDb.length===0) return false;
        db = safeDb.map(normalizeRow).filter(Boolean);
        if(db.length===0) return false;
        try{
          rotateBackups(db);
          localStorage.setItem(DB_KEY, JSON.stringify(db));
        }catch(e){}
        if(!quiet) toast("已由安全快照自動還原資料");
        return true;
      }

      function backupOnExit(reason){
        try{
          var snapDb = Array.isArray(db) ? db : [];
          if(snapDb.length===0){
            var safeDb = getSafetySnapshotDb();
            if(safeDb && safeDb.length>0){
              localStorage.setItem(LEAVE_SNAP_KEY, JSON.stringify({ ts: Date.now(), reason: reason || "exit", db: safeDb, note:"protected_empty_db" }));
              return;
            }
          }
          rotateBackups(snapDb);
          localStorage.setItem(LEAVE_SNAP_KEY, JSON.stringify({ ts: Date.now(), reason: reason || "exit", db: snapDb }));
        }catch(e){}
      }

      function go(href){
        backupOnExit("navigate");
        location.href = withV(href);
      }

      function openAttachment(href){
        var h = (href ?? "").toString().trim();
        if(!h) return;
        if(/^https?:\/\//i.test(h) || /^mailto:/i.test(h) || /^file:/i.test(h)){
          backupOnExit("open_attachment");
          window.open(h, "_blank", "noopener");
          return;
        }
        go(h);
      }

      window.addEventListener("beforeunload", function(){ backupOnExit("beforeunload"); });
      window.addEventListener("pagehide", function(){ backupOnExit("pagehide"); });
      document.addEventListener("visibilitychange", function(){
        if(document.visibilityState === "hidden") backupOnExit("visibility_hidden");
      });

      function normalizeRow(x){
        if(!x || typeof x !== "object") return null;

        if("v" in x && (x.k !== undefined || x.key !== undefined)){
          var inner = x.v;
          if(typeof inner === "string"){
            var p = safeParseJSON(inner);
            if(p && typeof p === "object") inner = p;
          }
          if(inner && typeof inner === "object"){
            x = Object.assign({}, inner, x);
            if(!x.uid) x.uid = x.k || x.key || "";
          }
        }

        var uid = norm(x.uid ?? x._uid ?? x.pk ?? x.k ?? x.key ?? "");
        var idRaw = (x.id ?? x.no ?? x.idx ?? x.key);
        var id = Number(idRaw);
        if(!Number.isFinite(id) || id <= 0) id = null;

        var text   = (x.text ?? x.content ?? x.note ?? x.memo ?? "").toString();
        var trade  = norm(x.trade ?? x.kind ?? x.type ?? x.work ?? "");
        var system = norm(x.system ?? x.sys ?? x.category ?? "");
        var source = norm(x.source ?? x.origin ?? x.from ?? x.src ?? "");
        var attach = norm(x.attach ?? x.attachment ?? x.file ?? x.link ?? "");
        var remark = (x.remark ?? x.note2 ?? x.desc ?? "").toString();
        var date   = norm(x.date ?? x.day ?? x.created ?? x.createdAt ?? "");

        if(date){
          if(!/^\d{4}-\d{2}-\d{2}$/.test(date)){
            var d = new Date(date);
            if(!isNaN(d.getTime())) date = d.toISOString().slice(0,10);
            else date = "";
          }
        }

        if(!uid){
          if(id) uid = "legacy_" + String(id);
          else uid = uuid();
        }

        return { uid: uid, id: id, text: text, trade: trade, system: system, source: source, attach: attach, remark: remark, date: date };
      }

      function rowKey(r){
        var t = (r.text ?? "").toString().trim().replace(/\s+/g," ");
        var so = (r.source ?? "").toString().trim();
        var a = (r.attach ?? "").toString().trim();
        var rm = (r.remark ?? "").toString().trim().replace(/\s+/g," ");
        return fnv1a((r.date||"") + "|" + (r.trade||"") + "|" + (r.system||"") + "|" + so + "|" + t + "|" + a + "|" + rm);
      }

      function readBackupCandidates(){
        var keys = [BACKUP_KEY, BK1_KEY, BK2_KEY, BK3_KEY, SAFETY_SNAPSHOT_KEY];
        var best = null;
        for(var i=0;i<keys.length;i++){
          var raw = null, obj = null, arr = null, ts = 0;
          try{ raw = localStorage.getItem(keys[i]); }catch(e){ raw = null; }
          obj = safeParseJSON(raw);

          if(obj && typeof obj === "object"){
            if(Array.isArray(obj.db)) { arr = obj.db; ts = Number(obj.ts||0) || 0; }
            else if(Array.isArray(obj)) { arr = obj; ts = 0; }
          }

          if(Array.isArray(arr) && arr.length>0){
            if(!best || arr.length > best.len || (arr.length === best.len && ts > best.ts)){
              best = { len: arr.length, ts: ts, db: arr };
            }
          }
        }
        return best ? best.db : null;
      }

      function mergeFromLegacyKeys(){
        var collected = [];
        for(var i=0;i<LEGACY_DB_KEYS.length;i++){
          var raw = localStorage.getItem(LEGACY_DB_KEYS[i]);
          var parsed = safeParseJSON(raw);
          if(!parsed) continue;
          var arr = Array.isArray(parsed) ? parsed : (Array.isArray(parsed.db) ? parsed.db : null);
          if(!Array.isArray(arr)) continue;
          collected.push.apply(collected, arr);
        }
        var backup = readBackupCandidates();
        if(Array.isArray(backup)) collected.push.apply(collected, backup);

        var normed = collected.map(normalizeRow).filter(Boolean);
        if(normed.length === 0) return { db: [], changed: false };

        var maxId = 0;
        for(var j=0;j<normed.length;j++){
          if(Number.isFinite(normed[j].id) && normed[j].id > maxId) maxId = normed[j].id;
        }
        for(var k=0;k<normed.length;k++){
          if(!normed[k].id){ maxId += 1; normed[k].id = maxId; }
          if(!normed[k].uid) normed[k].uid = "legacy_" + String(normed[k].id);
        }

        var seen = new Set();
        var uniq = [];
        for(var m=0;m<normed.length;m++){
          var key = rowKey(normed[m]);
          if(seen.has(key)) continue;
          seen.add(key);
          uniq.push(normed[m]);
        }
        uniq.sort(function(a,b){ return (a.id||0) - (b.id||0); });
        return { db: uniq, changed: true };
      }

      function loadCounterFromLegacy(){
        var best = 0;
        for(var i=0;i<LEGACY_COUNTER_KEYS.length;i++){
          var n = Number(localStorage.getItem(LEGACY_COUNTER_KEYS[i]) || "0");
          if(Number.isFinite(n) && n > best) best = n;
        }
        return best;
      }

      function ensureCounterAtLeast(n){
        var cur = Number(localStorage.getItem(COUNTER_KEY) || "0");
        var curOk = Number.isFinite(cur) ? cur : 0;
        var v = Math.max(curOk, n);
        localStorage.setItem(COUNTER_KEY, String(v));
      }

      function repairDBIfNeeded(){
        if(!Array.isArray(db)) db = [];
        var cleaned = [];
        var usedId = new Set();
        var maxId = 0;

        for(var i=0;i<db.length;i++){
          var r = normalizeRow(db[i]);
          if(!r) continue;
          if(!r.text || !r.text.toString().trim()) continue;
          if(Number.isFinite(r.id) && r.id > maxId) maxId = r.id;
          cleaned.push(r);
        }

        var needNewId = [];
        for(var j=0;j<cleaned.length;j++){
          if(!cleaned[j].id || usedId.has(cleaned[j].id)){
            needNewId.push(cleaned[j]);
            continue;
          }
          usedId.add(cleaned[j].id);
        }
        for(var k=0;k<needNewId.length;k++){
          maxId += 1;
          while(usedId.has(maxId)) maxId += 1;
          needNewId[k].id = maxId;
          usedId.add(maxId);
        }

        cleaned.sort(function(a,b){ return (a.id||0) - (b.id||0); });
        db = cleaned;

        try{
          if(db.length>0) saveSafetySnapshot("repair");
          if(db.length>0) rotateBackups(db);
          localStorage.setItem(DB_KEY, JSON.stringify(db));
          ensureCounterAtLeast(maxId);
        }catch(e){}
      }

      function loadDB(quiet){
        quiet = !!quiet;
        try{
          var raw = localStorage.getItem(DB_KEY);
          var parsed = safeParseJSON(raw);

          if(Array.isArray(parsed)){
            db = parsed.map(normalizeRow).filter(Boolean);
          }else if(parsed && Array.isArray(parsed.db)){
            db = parsed.db.map(normalizeRow).filter(Boolean);
          }else{
            db = [];
          }

          if(db.length === 0){
            var merged = mergeFromLegacyKeys();
            if(merged.db.length > 0){
              db = merged.db;
              if(db.length>0){
                saveSafetySnapshot("load_legacy_merge");
                rotateBackups(db);
              }
              localStorage.setItem(DB_KEY, JSON.stringify(db));
              if(!quiet) toast("已自動找回既有資料並合併到本頁");
            }else{
              var backup = readBackupCandidates();
              if(Array.isArray(backup) && backup.length>0){
                db = backup.map(normalizeRow).filter(Boolean);
                if(db.length>0){
                  saveSafetySnapshot("load_backup_restore");
                  rotateBackups(db);
                }
                localStorage.setItem(DB_KEY, JSON.stringify(db));
                if(!quiet) toast("主資料異常，已由備份自動還原");
              }else{
                restoreFromSafetySnapshot(quiet);
              }
            }
          }else{
            if(db.length>0){
              saveSafetySnapshot("load_ok");
              rotateBackups(db);
            }
          }
        }catch(e){
          db = [];
          var backup2 = readBackupCandidates();
          if(Array.isArray(backup2) && backup2.length>0){
            db = backup2.map(normalizeRow).filter(Boolean);
            if(db.length>0){
              saveSafetySnapshot("load_fail_restore");
              rotateBackups(db);
            }
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            if(!quiet) toast("主資料讀取失敗，已由備份自動還原");
          }else{
            restoreFromSafetySnapshot(quiet);
          }
        }

        var maxId = 0;
        for(var r=0;r<db.length;r++){
          if(Number.isFinite(db[r].id) && db[r].id > maxId) maxId = db[r].id;
        }
        var legacyCounter = loadCounterFromLegacy();
        ensureCounterAtLeast(Math.max(maxId, legacyCounter));

        repairDBIfNeeded();

        if(Array.isArray(db) && db.length===0){
          restoreFromSafetySnapshot(quiet);
        }
      }

      function saveDB(){
        try{
          if(Array.isArray(db) && db.length>0) saveSafetySnapshot("saveDB");
          rotateBackups(db);
          localStorage.setItem(DB_KEY, JSON.stringify(db));
        }catch(e){
          toast("儲存失敗：可能瀏覽器儲存空間不足");
        }
      }

      function getCounter(){
        var n = Number(localStorage.getItem(COUNTER_KEY) || "0");
        return Number.isFinite(n) ? n : 0;
      }
      function nextCounter(){
        var n = getCounter() + 1;
        localStorage.setItem(COUNTER_KEY, String(n));
        return n;
      }

      function loadDict(key){
        try{
          var raw = localStorage.getItem(key);
          var arr = raw ? JSON.parse(raw) : [];
          return Array.isArray(arr) ? arr.map(norm).filter(Boolean) : [];
        }catch(e){ return []; }
      }
      function saveDict(key, arr){ localStorage.setItem(key, JSON.stringify(arr)); }

      function ensureSeedDict(){
        if(!localStorage.getItem(TRADE_DICT_KEY)){
          saveDict(TRADE_DICT_KEY, ["土建","機電","水電","消防","裝修","其他"]);
        }
        if(!localStorage.getItem(SYS_DICT_KEY)){
          saveDict(SYS_DICT_KEY, ["電氣","給排水","消防","空調","弱電","土建","其他"]);
        }
        if(!localStorage.getItem(SOURCE_DICT_KEY)){
          saveDict(SOURCE_DICT_KEY, ["會議紀錄","公文","圖說","現勘","需求書","送審","施工","其他"]);
        }
        if(!localStorage.getItem(TRADE_SYS_MAP_KEY)){
          try{ localStorage.setItem(TRADE_SYS_MAP_KEY, JSON.stringify({})); }catch(e){}
        }
      }

      function loadTradeSysMap(){
        try{
          var raw = localStorage.getItem(TRADE_SYS_MAP_KEY);
          var obj = raw ? JSON.parse(raw) : {};
          return (obj && typeof obj === "object") ? obj : {};
        }catch(e){ return {}; }
      }
      function saveTradeSysMap(map){
        try{ localStorage.setItem(TRADE_SYS_MAP_KEY, JSON.stringify(map || {})); }catch(e){}
      }
      function addTradeSysLink(trade, system){
        trade = norm(trade); system = norm(system);
        if(!trade || !system) return;

        var map = loadTradeSysMap();
        if(!Array.isArray(map[trade])) map[trade] = [];
        var exists = map[trade].some(function(x){ return norm(x).toLowerCase() === system.toLowerCase(); });
        if(!exists) map[trade].push(system);
        map[trade].sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });
        saveTradeSysMap(map);
      }

      function exportDbWithSettings(){
        var rows = (Array.isArray(db)?db:[]).map(function(r){
          var uid = norm(r.uid) || (r.id ? "legacy_"+String(r.id) : uuid());
          return {
            id: Number(r.id||0),
            k: uid,
            v: {
              text: (r.text||""),
              trade: (r.trade||""),
              system: (r.system||""),
              source: (r.source||""),
              attach: (r.attach||""),
              remark: (r.remark||""),
              date: (r.date||"")
            }
          };
        });

        rows.push({
          id: 0,
          k: SETTINGS_UID,
          v: {
            schema: PAGE_SCHEMA,
            pageKey: PAGE_KEY,
            resourceKey: CLOUD_RESOURCE_KEY,
            pk: CLOUD_PK,
            tradeDict: loadDict(TRADE_DICT_KEY),
            sysDict: loadDict(SYS_DICT_KEY),
            sourceDict: loadDict(SOURCE_DICT_KEY),
            tradeSysMap: loadTradeSysMap()
          }
        });

        return rows;
      }

      function importPayload(payload, info){
        payload = (payload && typeof payload==="object") ? payload : {};
        var arr = Array.isArray(payload.db) ? payload.db : [];

        var beforeDb = Array.isArray(db) ? db.slice() : [];
        var localCount = beforeDb.map(normalizeRow).filter(Boolean).filter(function(r){ return r.text && r.text.toString().trim(); }).length;

        var srow = null;
        for(var i=0;i<arr.length;i++){
          var it = arr[i];
          var kk = norm(it && (it.k ?? it.uid ?? it.key));
          if(kk === SETTINGS_UID){ srow = it; break; }
          if(norm(it && it.uid) === SETTINGS_UID){ srow = it; break; }
        }

        var adoptLegacy = false;
        if(arr.length > 0 && !srow){
          if(Auth && typeof Auth.isAdmin === "function" && Auth.isAdmin()){
            adoptLegacy = confirm("⚠️ 偵測到雲端資料缺少 settings/schema（可能是其他頁資料或舊版資料）。\n\n若你『確定』這就是本頁舊資料：按【確定】採用並補上 settings。\n若不確定：按【取消】保護本頁避免串頁。");
          }
          if(!adoptLegacy){
            var warnKey = "tasun_cloud_missing_settings_once__" + CLOUD_RESOURCE_KEY;
            try{
              if(!sessionStorage.getItem(warnKey)){
                sessionStorage.setItem(warnKey, "1");
                toast("⚠️ 雲端資料缺少 settings/schema：已保護不套用（避免顯示成別頁資料）。請確認後端 key 是否被其他頁誤用。");
              }
            }catch(e){}
            return;
          }
        }

        if(srow){
          var sv = (srow && typeof srow==="object") ? (srow.v || srow) : null;

          var schema = sv && sv.schema ? norm(sv.schema) : "";
          var svPageKey = sv && sv.pageKey ? norm(sv.pageKey) : "";
          var svResKey = sv && sv.resourceKey ? norm(sv.resourceKey) : "";

          if(schema && schema !== PAGE_SCHEMA){
            toast("⚠️ 雲端資料 schema 不符（" + schema + "），已保護本頁不套用（避免串頁）。");
            return;
          }
          if(svPageKey && svPageKey !== PAGE_KEY){
            toast("⚠️ 雲端資料 pageKey 不符（" + svPageKey + "），已保護本頁不套用（避免串頁）。");
            return;
          }
          if(svResKey && svResKey !== CLOUD_RESOURCE_KEY){
            toast("⚠️ 雲端資料 resourceKey 不符（" + svResKey + "），已保護本頁不套用（避免串頁）。");
            return;
          }

          if(sv){
            if(Array.isArray(sv.tradeDict)) saveDict(TRADE_DICT_KEY, sv.tradeDict.map(norm).filter(Boolean));
            if(Array.isArray(sv.sysDict)) saveDict(SYS_DICT_KEY, sv.sysDict.map(norm).filter(Boolean));
            if(Array.isArray(sv.sourceDict)) saveDict(SOURCE_DICT_KEY, sv.sourceDict.map(norm).filter(Boolean));
            if(sv.tradeSysMap && typeof sv.tradeSysMap==="object") saveTradeSysMap(sv.tradeSysMap);
          }
        }

        if(beforeDb.length>0){
          try{
            saveSafetySnapshot("before_cloud_apply");
            rotateBackups(beforeDb);
          }catch(e){}
        }

        var incoming = arr
          .filter(function(r){
            var kk2 = norm(r && (r.k ?? r.uid ?? r.key));
            return kk2 !== SETTINGS_UID;
          })
          .map(function(r){
            if(r && typeof r==="object" && ("v" in r) && (r.k!==undefined || r.key!==undefined)){
              var inner = r.v;
              if(typeof inner === "string"){
                var p = safeParseJSON(inner);
                if(p && typeof p==="object") inner = p;
              }
              if(inner && typeof inner==="object"){
                var obj = Object.assign({}, inner);
                obj.uid = norm(r.k ?? r.key ?? obj.uid ?? "");
                obj.id  = Number(r.id||obj.id||0);
                obj.text = obj.text ?? obj.content ?? obj.note ?? obj.memo ?? "";
                return obj;
              }
            }
            return r;
          })
          .map(normalizeRow)
          .filter(Boolean)
          .filter(function(r){ return r.text && r.text.toString().trim(); });

        var incomingCount = incoming.length;

        /* ✅ 保護：若 pull 回來空白，但本機有資料 → 不覆寫，改以 merge 推回 */
        if(incomingCount === 0 && localCount > 0){
          try{
            if(!sessionStorage.getItem(PROTECT_EMPTY_REMOTE_KEY)){
              sessionStorage.setItem(PROTECT_EMPTY_REMOTE_KEY, "1");
              toast("⚠️ 雲端目前空白：已保護本機資料不覆寫，將嘗試推送合併到雲端…");
              if(cloud && Auth.canWrite()){
                setTimeout(function(){
                  if(!cloud) return;
                  cloud.ready.then(function(){ return cloud.saveMerged(); }).catch(function(){});
                }, 0);
              }
            }
          }catch(e){}
          return;
        }

        db = incoming;

        var maxId2 = 0;
        for(var j=0;j<db.length;j++){
          var n = Number(db[j].id||0);
          if(Number.isFinite(n) && n>maxId2) maxId2 = n;
        }
        var cnt = Number(payload.counter||0);
        if(!Number.isFinite(cnt)) cnt = 0;
        ensureCounterAtLeast(Math.max(cnt, maxId2));

        try{
          if(Array.isArray(db) && db.length>0) saveSafetySnapshot("after_cloud_apply");
          localStorage.setItem(DB_KEY, JSON.stringify(db));
        }catch(e){}

        lastCloudSyncAt = Date.now();
        if(info && (info.conflicts || info.merged)){
          toast("雲端合併完成");
        }

        if(adoptLegacy && cloud && Auth && Auth.canWrite()){
          setTimeout(function(){
            cloud.ready.then(function(){ return cloud.saveMerged(); }).catch(function(){});
          }, 0);
        }
      }

      var _cloudSaveTm = 0;
      function cloudSave(reason){
        if(!cloud) return;
        if(!Auth.canWrite()) return;
        clearTimeout(_cloudSaveTm);
        _cloudSaveTm = setTimeout(function(){
          cloud.ready.then(function(){ return cloud.saveMerged(); }).catch(function(){});
        }, 260);
      }

      function initCloudOnce(){
        if(!cloudCreated){
          cloudCreated = true;

          cloud = new D1Cloud({
            getLocal: function(){
              return { db: exportDbWithSettings(), counter: getCounter() };
            },
            apply: function(payload, info){
              importPayload(payload, info);
              scheduleRender();
            }
          });
        }
      }

      function startCloudWatchOnce(){
        if(!cloud) return;
        if(!getApiBase()) return;
        if(cloudStarted) return;
        cloudStarted = true;
        cloud.startWatch(8);
        window.addEventListener("focus", function(){ if(cloud) cloud.pullNow(); });
      }

      function makeExportPayload(){
        return {
          meta: {
            app: "捷運汐東線事項記錄",
            pageKey: PAGE_KEY,
            schema: PAGE_SCHEMA,
            dbKey: DB_KEY,
            exportedAt: new Date().toISOString(),
            ver: 1
          },
          counter: getCounter(),
          tradeDict: loadDict(TRADE_DICT_KEY),
          sysDict: loadDict(SYS_DICT_KEY),
          sourceDict: loadDict(SOURCE_DICT_KEY),
          tradeSysMap: loadTradeSysMap(),
          db: Array.isArray(db) ? db : []
        };
      }

      function safeFileStamp(){
        var s = new Date().toISOString().slice(0,19);
        return s.replaceAll(":", "-").replace("T","_");
      }

      function downloadJSON(filename, obj){
        var blob = new Blob([JSON.stringify(obj, null, 2)], { type:"application/json" });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(function(){ URL.revokeObjectURL(url); a.remove(); }, 0);
      }

      function doExportBackup(){
        if(!Auth.ensureLoggedIn()) return;
        var payload = makeExportPayload();
        try{ localStorage.setItem(EXPORT_LAST_KEY, JSON.stringify(payload)); }catch(e){}
        downloadJSON("捷運汐東線事項記錄_備份_" + safeFileStamp() + ".json", payload);
        toast("已匯出備份（並寫入本機備份快照）");
        backupOnExit("export");
      }

      function isReadModeOn(){ return localStorage.getItem(READ_MODE_KEY) === "1"; }
      function applyReadMode(on){
        document.body.classList.toggle("readMode", !!on);
        var b = $("btnRead");
        var t = b && b.querySelector ? b.querySelector(".t") : null;
        if(t) t.textContent = on ? "閱讀模式：開" : "閱讀模式：關";
        scheduleRender();
      }
      function toggleReadMode(){
        var on = !document.body.classList.contains("readMode");
        localStorage.setItem(READ_MODE_KEY, on ? "1" : "0");
        applyReadMode(on);
        toast(on ? "已切換為閱讀模式（點卡片可展開/收合）" : "已切換為表格模式");
      }

      function uniqueFromDB(field){
        var set = new Set();
        for(var i=0;i<db.length;i++){
          var v = norm(db[i] && db[i][field]);
          if(v) set.add(v);
        }
        return set;
      }

      function uniqueFieldArrFromDB(field, tradeFilter){
        var set = new Set();
        var t = norm(tradeFilter);
        for(var i=0;i<db.length;i++){
          var r = db[i];
          if(t && norm(r.trade) !== t) continue;
          var v = norm(r && r[field]);
          if(v) set.add(v);
        }
        var arr = Array.from(set);
        arr.sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });
        return arr;
      }

      function rebuildFilters(){
        var tSel = $("fTrade");
        var sSel = $("fSys");

        var keepT = norm(tSel.value);
        var keepS = norm(sSel.value);

        var trades = uniqueFieldArrFromDB("trade", "");
        tSel.innerHTML = '<option value="">全部</option>' + trades.map(function(v){
          return '<option value="'+escHtml(v)+'">'+escHtml(v)+'</option>';
        }).join("");

        if(trades.length === 0){
          tSel.value = "";
          tSel.disabled = true;
        }else{
          tSel.disabled = false;
          tSel.value = trades.includes(keepT) ? keepT : "";
        }

        var pickedTrade = norm(tSel.value);

        var systems = pickedTrade
          ? uniqueFieldArrFromDB("system", pickedTrade)
          : uniqueFieldArrFromDB("system", "");

        sSel.innerHTML = '<option value="">全部</option>' + systems.map(function(v){
          return '<option value="'+escHtml(v)+'">'+escHtml(v)+'</option>';
        }).join("");

        if(systems.length === 0){
          sSel.value = "";
          sSel.disabled = true;
        }else{
          sSel.disabled = false;
          sSel.value = systems.includes(keepS) ? keepS : "";
        }
      }

      function filteredRows(){
        var q = norm($("qText").value).toLowerCase();
        var t = norm($("fTrade").value);
        var s = norm($("fSys").value);

        var rows = db.slice();

        if(t) rows = rows.filter(function(r){ return norm(r.trade) === t; });
        if(s) rows = rows.filter(function(r){ return norm(r.system) === s; });

        if(q){
          rows = rows.filter(function(r){
            return (r.text ?? "").toString().toLowerCase().includes(q);
          });
        }

        rows.sort(function(a,b){ return (a.id||0) - (b.id||0); });
        return rows;
      }

      var _renderPending = false;
      function scheduleRender(){
        if(_renderPending) return;
        _renderPending = true;
        requestAnimationFrame(function(){
          _renderPending = false;
          render();
        });
      }

      function applySelectionToDOM(){
        document.querySelectorAll("tr.sel").forEach(function(el){ el.classList.remove("sel"); });
        document.querySelectorAll(".noteCard.sel").forEach(function(el){ el.classList.remove("sel"); });
        if(!selectedUid) return;
        var tr = document.querySelector('tr[data-uid="'+selectedUid+'"]');
        if(tr) tr.classList.add("sel");
        var card = document.querySelector('.noteCard[data-uid="'+selectedUid+'"]');
        if(card) card.classList.add("sel");
      }

      function renderHint(rows){
        var rowsCount = rows.length;
        var modeText = Auth.canWrite() ? "可維護模式" : "唯讀模式";

        $("btnAdd").style.display  = Auth.canWrite() ? "inline-block" : "none";
        $("btnEdit").style.display = Auth.canWrite() ? "inline-block" : "none";
        $("btnView").disabled = !selectedUid;

        $("btnToken").style.display = Auth.isAdmin() ? "inline-block" : "none";

        var selIndex = -1;
        if(selectedUid){
          selIndex = rows.findIndex(function(x){ return x.uid===selectedUid; });
        }
        var selText = (selIndex>=0) ? ("#"+String(selIndex+1)) : "";

        var apiBaseText = maskApiBase();

        var apiStatusText = (accessState === "noapi")
          ? "—"
          : ((apiLastStatus === 200) ? "OK" : (apiLastStatus ? ("HTTP " + apiLastStatus) : "—"));

        var apiCls = (apiLastStatus === 200) ? "ok" : (apiLastStatus ? "bad" : "");

        var accessText = "待確認";
        var accessCls = "";
        if(accessState === "noapi"){
          accessText = "—";
          accessCls = "";
        }else if(accessState === "neterr"){
          accessText = "連線失敗";
          accessCls = "bad";
        }else if(apiLastStatus === 404){
          accessText = "—";
          accessCls = "";
        }else if(accessState === "ok"){
          accessText = "OK";
          accessCls = "ok";
        }else if(accessState === "deny"){
          accessText = "未驗證";
          accessCls = "bad";
        }else{
          accessText = accessOk ? "OK" : "待確認";
          accessCls = accessOk ? "ok" : "";
        }

        var tokenText = hasAccessServiceToken() ? "已設定" : "未設定";
        var tokenCls = hasAccessServiceToken() ? "ok" : "bad";

        var hintHtml = ""
          + '<span class="hb"><span class="k">模式</span><span class="v">'+escHtml(modeText)+'</span></span>'
          + '<span class="hb"><span class="k">role</span><span class="v">'+escHtml(Auth.role())+'</span></span>'
          + '<span class="hb"><span class="k">筆數</span><span class="v">'+escHtml(String(rowsCount))+'</span></span>'
          + '<span class="hb"><span class="k">key</span><span class="v">'+escHtml(String(CLOUD_RESOURCE_KEY))+'</span></span>'
          + '<span class="hb"><span class="k">pk</span><span class="v">'+escHtml(String(CLOUD_PK))+'</span></span>'
          + '<span class="hb"><span class="k">雲端</span><span class="v">D1</span></span>'
          + '<span class="hb"><span class="k">API</span><span class="v">'+escHtml(apiBaseText)+'</span></span>'
          + '<span class="hb '+apiCls+'"><span class="k">狀態</span><span class="v">'+escHtml(apiStatusText)+'</span></span>'
          + '<span class="hb '+accessCls+'"><span class="k">Access</span><span class="v">'+escHtml(accessText)+'</span></span>'
          + '<span class="hb '+tokenCls+'"><span class="k">Token</span><span class="v">'+escHtml(tokenText)+'</span></span>';

        if(lastCloudSyncAt){
          hintHtml += '<span class="hb"><span class="k">最近同步</span><span class="v">'+escHtml(fmtClock(lastCloudSyncAt))+'</span></span>';
        }

        if(selectedUid){
          hintHtml += '<span class="hb"><span class="k">已選取</span><span class="v">'+escHtml(selText)+'</span></span>';
        }else{
          hintHtml += '<span class="hb bad"><span class="k">提示</span><span class="v">請先點選一筆，再按「檢視 / 編輯」</span></span>';
        }

        $("hint").innerHTML = hintHtml;
      }

      function fillDropdown(selectId, options, placeholder){
        var sel = $(selectId);
        if(options.length === 0){
          sel.innerHTML = '<option value="" disabled selected>'+escHtml(placeholder)+'</option>';
        }else{
          sel.innerHTML = options.map(function(v){
            return '<option value="'+escHtml(v)+'">'+escHtml(v)+'</option>';
          }).join("");
        }
      }

      function rebuildModalTradeOptions(selected){
        var trades = Array.from(uniqueFromDB("trade"));
        loadDict(TRADE_DICT_KEY).forEach(function(x){ if(x) trades.push(x); });
        trades = Array.from(new Set(trades.map(norm).filter(Boolean)));
        trades.sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });

        fillDropdown("mTradeSel", trades, "（請先新增工種）");
        var v = norm(selected);
        if(v && trades.includes(v)) $("mTradeSel").value = v;
      }

      function systemsByTradeFromMapAndDB(trade){
        var t = norm(trade);
        if(!t) return [];
        var set = new Set();

        var map = loadTradeSysMap();
        if(Array.isArray(map[t])) map[t].forEach(function(x){
          x = norm(x); if(x) set.add(x);
        });

        for(var i=0;i<db.length;i++){
          if(norm(db[i].trade) !== t) continue;
          var s = norm(db[i].system);
          if(s) set.add(s);
        }

        var arr = Array.from(set);
        arr.sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });
        return arr;
      }

      function rebuildModalSystemOptions(trade, selected){
        var t = norm(trade);
        var systems = t ? systemsByTradeFromMapAndDB(t) : [];
        fillDropdown("mSysSel", systems, t ? "（此工種尚無系統：請按「新增系統」）" : "（請先選擇工種）");
        var v = norm(selected);
        if(v && systems.includes(v)) $("mSysSel").value = v;
        else if(systems.length > 0) $("mSysSel").value = systems[0];
      }

      function rebuildModalSourceOptions(selected){
        var list = uniqueFieldArrFromDB("source", "");
        loadDict(SOURCE_DICT_KEY).forEach(function(x){ if(x) list.push(x); });
        list = Array.from(new Set(list.map(norm).filter(Boolean)));
        list.sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });

        fillDropdown("mSourceSel", list, "（可按「新增出處」建立）");
        var v = norm(selected);
        if(v && list.includes(v)) $("mSourceSel").value = v;
        else if(list.length>0) $("mSourceSel").value = list[0];
      }

      function isSysSelEmpty(){
        var sel = $("mSysSel");
        if(!sel) return true;
        return (sel.options.length === 1 && sel.options[0].disabled);
      }

      function setModalEditable(editable){
        $("btnSave").style.display = editable ? "inline-block" : "none";
        $("btnDelete").style.display = (editable && Auth.isAdmin() && editingUid != null) ? "inline-block" : "none";
        ["mText","mTradeSel","mSysSel","mSourceSel","mAttach","mRemark","mDate"].forEach(function(id){
          $(id).disabled = !editable;
        });
        var allowAddOpt = editable && Auth.canWrite();
        $("btnAddTrade").style.display = allowAddOpt ? "inline-block" : "none";
        $("btnAddSys").style.display   = allowAddOpt ? "inline-block" : "none";
        $("btnAddSource").style.display = allowAddOpt ? "inline-block" : "none";

        $("btnNetDisk").style.display = "inline-block";

        if(editable && isSysSelEmpty()){
          $("mSysSel").disabled = true;
        }
      }

      function openModal(uid, editable){
        Auth.validateSession();
        if(!Auth.ensureLoggedIn()) return;

        var item = (uid == null) ? null : (db.find(function(x){ return x.uid === uid; }) || null);
        editingUid = item ? item.uid : null;

        rebuildModalTradeOptions(item ? item.trade : "");
        var tradeNow = norm($("mTradeSel").value) || (item ? item.trade : "");
        rebuildModalSystemOptions(tradeNow, item ? item.system : "");
        rebuildModalSourceOptions(item ? item.source : "");

        $("mTitle").textContent = editable ? (item ? "編輯" : "新增") : "檢視";
        setModalEditable(editable);

        $("mNo").value = item ? (item.id ?? (getCounter() + 1)) : (getCounter() + 1);
        $("mText").value = item ? (item.text || "") : "";
        $("mRemark").value = item ? (item.remark || "") : "";
        $("mDate").value = item ? (item.date || new Date().toISOString().slice(0,10)) : new Date().toISOString().slice(0,10);
        $("mAttach").value = item ? (item.attach || "") : "";

        $("mask").style.display = "flex";
      }

      function closeModal(){ $("mask").style.display = "none"; }

      function saveItem(){
        Auth.validateSession();
        if(!Auth.ensureLoggedIn()) return;
        if(!Auth.canWrite()){ toast("唯讀權限不可儲存"); return; }

        var text = norm($("mText").value);
        if(!text){ toast("記事內容不可空白"); $("mText").focus(); return; }

        var trade  = norm($("mTradeSel").value);
        var system = norm($("mSysSel").value);
        if(!trade){ toast("工種尚未建立：請先按「新增工種」"); return; }
        if(!system){ toast("系統尚未建立：請先按「新增系統」"); return; }

        var source = norm($("mSourceSel").value);
        var attach = norm($("mAttach").value);
        var remark = norm($("mRemark").value);
        var date   = norm($("mDate").value) || new Date().toISOString().slice(0,10);

        if(editingUid != null){
          var idx = db.findIndex(function(x){ return x.uid === editingUid; });
          if(idx >= 0){
            var keep = db[idx];
            db[idx] = { uid: keep.uid, id: keep.id, text: text, trade: trade, system: system, source: source, attach: attach, remark: remark, date: date };
          }
        }else{
          var nid = nextCounter();
          var newUid = uuid();
          db.push({ uid: newUid, id: nid, text: text, trade: trade, system: system, source: source, attach: attach, remark: remark, date: date });
          selectedUid = newUid;
        }

        addTradeSysLink(trade, system);

        saveDB();
        closeModal();
        scheduleRender();
        toast("已儲存");
        backupOnExit("save");

        cloudSave("save");
      }

      function deleteItem(){
        Auth.validateSession();
        if(!Auth.ensureLoggedIn()) return;
        if(!Auth.isAdmin()){ toast("僅 admin 可刪除"); return; }
        if(editingUid == null) return;
        if(!confirm("確定刪除這筆記事？")) return;

        db = db.filter(function(x){ return x.uid !== editingUid; });
        if(selectedUid === editingUid) selectedUid = null;
        saveDB();

        closeModal();
        scheduleRender();
        toast("已刪除");
        backupOnExit("delete");

        cloudSave("delete");
      }

      function openPrompt(mode){
        Auth.validateSession();
        if(!Auth.ensureLoggedIn()) return;
        if(!Auth.canWrite()){ toast("read 權限不可新增選單"); return; }

        if(mode === "sys"){
          var curT = norm($("mTradeSel").value);
          if(!curT){
            toast("請先選擇工種，再新增系統");
            return;
          }
        }

        promptMode = mode;
        $("pInput").value = "";

        if(mode === "trade"){
          $("pTitle").textContent = "新增工種";
          $("pLabel").textContent = "請輸入新的工種";
          $("pInput").placeholder = "例如：土建 / 機電 / 水電...";
          $("pHint").textContent = "新增後會加入「工種字典」。";
        }else if(mode === "sys"){
          $("pTitle").textContent = "新增系統";
          $("pLabel").textContent = "請輸入系統（會綁到目前工種）";
          $("pInput").placeholder = "例如：電氣 / 給排水 / 消防...";
          $("pHint").textContent = "✅ 若你輸入的系統已存在於系統字典，會改為「綁定到目前工種」（不會被擋掉）。";
        }else{
          $("pTitle").textContent = "新增出處";
          $("pLabel").textContent = "請輸入出處（會加入出處字典）";
          $("pInput").placeholder = "例如：會議紀錄 / 公文 / 圖說 / 現勘...";
          $("pHint").textContent = "新增後會加入「出處字典」，下拉選單可直接選。";
        }

        $("pMask").style.display = "flex";
        setTimeout(function(){ $("pInput").focus(); }, 0);
      }

      function closePrompt(){
        $("pMask").style.display = "none";
        promptMode = null;
      }

      function addOption(){
        if(!Auth.canWrite()) return;

        var v = norm($("pInput").value);
        if(!v){ toast("不可空白"); $("pInput").focus(); return; }

        if(promptMode === "trade"){
          var dictT = loadDict(TRADE_DICT_KEY);
          var existsTrade = dictT.map(function(x){ return x.toLowerCase(); });
          if(existsTrade.includes(v.toLowerCase())){ toast("已存在相同工種"); return; }

          dictT.push(v);
          dictT.sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });
          saveDict(TRADE_DICT_KEY, dictT);

          rebuildModalTradeOptions(v);
          $("mTradeSel").value = v;
          rebuildModalSystemOptions(v, "");
          if(isSysSelEmpty()) $("mSysSel").disabled = true;

          scheduleRender();
          closePrompt();
          toast("已新增工種");
          backupOnExit("add_trade");
          cloudSave("dict");
          return;
        }

        if(promptMode === "sys"){
          var curTrade = norm($("mTradeSel").value);
          if(!curTrade){ toast("請先選擇工種"); return; }

          var sysDict = loadDict(SYS_DICT_KEY);
          var sysLower = sysDict.map(function(x){ return x.toLowerCase(); });
          var inSysDict = sysLower.includes(v.toLowerCase());

          if(!inSysDict){
            sysDict.push(v);
            sysDict.sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });
            saveDict(SYS_DICT_KEY, sysDict);
          }

          addTradeSysLink(curTrade, v);
          toast(inSysDict ? "已綁定系統到目前工種" : "已新增並綁定系統");

          rebuildModalSystemOptions(curTrade, v);
          $("mSysSel").disabled = false;
          $("mSysSel").value = v;

          scheduleRender();
          closePrompt();
          backupOnExit("add_sys");
          cloudSave("dict");
          return;
        }

        var srcDict = loadDict(SOURCE_DICT_KEY);
        var srcLower = srcDict.map(function(x){ return x.toLowerCase(); });
        if(srcLower.includes(v.toLowerCase())){ toast("已存在相同出處"); return; }
        srcDict.push(v);
        srcDict.sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });
        saveDict(SOURCE_DICT_KEY, srcDict);

        rebuildModalSourceOptions(v);
        $("mSourceSel").value = v;

        scheduleRender();
        closePrompt();
        toast("已新增出處");
        backupOnExit("add_source");
        cloudSave("dict");
      }

      function renderTable(rows){
        var tbody = $("tbody");
        tbody.innerHTML = rows.map(function(r, idx){
          var isSel = (selectedUid === r.uid);
          var att = norm(r.attach || "");
          var attCell = att
            ? '<button class="attBtn" data-act="att" data-uid="'+escHtml(r.uid)+'"><span class="t">開啟</span></button>'
            : '<span class="muted">—</span>';

          var textHtml = escHtml((r.text ?? "").toString()).replaceAll("\n","<br>");
          var remarkHtml = escHtml((r.remark ?? "").toString()).replaceAll("\n","<br>");
          var srcHtml = escHtml(norm(r.source||""));

          return ''
            + '<tr data-uid="'+escHtml(r.uid)+'" class="'+(isSel ? "sel" : "")+'">'
            +   '<td style="text-align:center;">'+String(idx+1)+'</td>'
            +   '<td>'+(textHtml ? textHtml : '<span class="muted">—</span>')+'</td>'
            +   '<td style="text-align:center;">'+(escHtml(r.trade) || '<span class="muted">—</span>')+'</td>'
            +   '<td style="text-align:center;">'+(escHtml(r.system) || '<span class="muted">—</span>')+'</td>'
            +   '<td style="text-align:center;">'+(srcHtml || '<span class="muted">—</span>')+'</td>'
            +   '<td style="text-align:center;">'+attCell+'</td>'
            +   '<td>'+(remarkHtml ? remarkHtml : '<span class="muted">—</span>')+'</td>'
            +   '<td style="text-align:center;">'+(escHtml(r.date) || '<span class="muted">—</span>')+'</td>'
            +   '<td style="text-align:center;"><button class="btn ghost small" data-act="view" data-uid="'+escHtml(r.uid)+'"><span class="t">檢視</span></button></td>'
            + '</tr>';
        }).join("") || (
          '<tr><td colspan="9" class="muted" style="padding:18px;">尚無資料（write/admin 可用右上「新增」建立第一筆）</td></tr>'
        );
      }

      function renderCards(rows){
        var c = $("cards");
        c.innerHTML = rows.map(function(r, idx){
          var att = norm(r.attach||"");
          var date = norm(r.date||"") || "—";
          var t = norm(r.trade||"") || "—";
          var s = norm(r.system||"") || "—";
          var so = norm(r.source||"") || "—";
          var text = (r.text ?? "").toString();
          var remark = (r.remark ?? "").toString();

          var actions = ''
            + '<div class="noteActions">'
            +   (att ? '<button class="attBtn" data-act="att" data-uid="'+escHtml(r.uid)+'"><span class="t">附件</span></button>' : '')
            +   '<button class="btn ghost small" data-act="view" data-uid="'+escHtml(r.uid)+'"><span class="t">檢視</span></button>'
            + '</div>';

          return ''
            + '<div class="noteCard" data-uid="'+escHtml(r.uid)+'">'
            +   '<div class="noteHead">'
            +     '<div class="noteMeta">'
            +       '<span class="noteNo">#'+escHtml(String(idx+1))+'</span>'
            +       '<span class="noteTag">工種：'+escHtml(t)+'</span>'
            +       '<span class="noteTag">系統：'+escHtml(s)+'</span>'
            +       '<span class="noteTag">出處：'+escHtml(so)+'</span>'
            +       '<span class="noteTag">日期：'+escHtml(date)+'</span>'
            +     '</div>'
            +     actions
            +   '</div>'
            +   '<div class="noteBody">'+escHtml(text)+'</div>'
            +   '<div class="noteMore">'
            +     '<div class="noteBody"><b>備註：</b>'+(remark ? escHtml(remark) : '<span class="muted">—</span>')+'</div>'
            +   '</div>'
            + '</div>';
        }).join("") || (
          '<div class="muted" style="padding:18px;">尚無資料（write/admin 可用右上「新增」建立第一筆）</div>'
        );
      }

      function render(){
        rebuildFilters();
        var rows = filteredRows();
        if(selectedUid && !rows.some(function(r){ return r.uid===selectedUid; })) selectedUid = null;

        var isRead = document.body.classList.contains("readMode");
        $("cards").style.display = isRead ? "block" : "none";
        $("tbl").style.display = isRead ? "none" : "table";

        if(isRead) renderCards(rows);
        else renderTable(rows);

        applySelectionToDOM();
        renderHint(rows);
      }

      function syncUserUI(){
        var u = Auth.current();
        $("uName").textContent = u && u.username ? u.username : "—";
        $("uRole").textContent = Auth.role();
      }

      function setupMoreMenu(backHref){
        var backBtn = $("mBack");
        var moreBtn = $("mMoreBtn");
        var menu = $("mMoreMenu");

        function close(){ menu.style.display = "none"; }
        function toggle(e){
          e.preventDefault();
          e.stopPropagation();
          menu.style.display = (menu.style.display === "block") ? "none" : "block";
        }

        backBtn.onclick = function(){ go(backHref); };
        moreBtn.addEventListener("click", toggle);

        menu.addEventListener("click", function(e){
          e.stopPropagation();
          var item = e.target.closest("button.menuItem[data-href]");
          if(!item) return;
          var href = item.getAttribute("data-href");
          if(href) go(href);
        });

        document.addEventListener("click", close);
        window.addEventListener("keydown", function(e){ if(e.key === "Escape") close(); });
      }

      function openTokenMask(){
        if(!Auth.isAdmin()){
          toast("僅 admin 可設定雲端");
          return;
        }
        $("tokenErr").style.display = "none";
        $("tokenErr").textContent = "";
        $("tokenInput").value = "";
        $("tokenInput").type = "password";
        $("tokenHint").textContent =
          "目前狀態：API=" + maskApiBase()
          + " / 狀態=" + ((accessState==="noapi") ? "—" : (apiLastStatus ? ("HTTP " + apiLastStatus) : "—"))
          + " / Access=" + (accessState==="ok" ? "OK" : (accessState==="deny" ? "未驗證" : (accessState==="neterr" ? "連線失敗" : (accessState==="noapi" ? "—" : "待確認"))))
          + " / Token=" + accessTokenMasked();
        $("tokenMask").classList.add("show");
        setTimeout(function(){ $("tokenInput").focus(); }, 0);
      }
      function closeTokenMask(){
        $("tokenMask").classList.remove("show");
      }

      function saveToken(){
        if(!Auth.isAdmin()){
          toast("僅 admin 可設定雲端");
          return;
        }

        var raw = norm($("tokenInput").value);
        var cfg = parseCloudCfgInput(raw);

        if(!cfg){
          $("tokenErr").textContent = "格式不正確。請貼：API_BASE|CLIENT_ID|CLIENT_SECRET（或 CLIENT_ID|CLIENT_SECRET）。";
          $("tokenErr").style.display = "block";
          return;
        }

        if(cfg.apiBase){
          if(!/^https?:\/\//i.test(cfg.apiBase)){
            $("tokenErr").textContent = "API_BASE 必須以 http(s) 開頭。";
            $("tokenErr").style.display = "block";
            return;
          }
          setApiBase(cfg.apiBase);
          accessState = "unknown";
        }

        if(cfg.clientId || cfg.clientSecret){
          if(!(cfg.clientId && cfg.clientSecret)){
            $("tokenErr").textContent = "你似乎只貼到一段 Token。請同時貼：CLIENT_ID + CLIENT_SECRET（兩段）。";
            $("tokenErr").style.display = "block";
            return;
          }
          setAccessServiceToken({ clientId: cfg.clientId, clientSecret: cfg.clientSecret });
          accessState = "unknown";
        }

        closeTokenMask();
        toast("已儲存雲端設定，將嘗試連線…");

        initCloudOnce();
        scheduleRender();

        apiPing().then(function(){
          markApiOk();
          accessOk = true;
          accessState = "ok";
          if(cloud){
            /* ✅ 設定完立刻做一次同步：write/admin 用 merge；read 用 pull */
            if(Auth.canWrite()) cloud.saveMerged();
            else cloud.pullNow();
            startCloudWatchOnce();
          }
          scheduleRender();
        }).catch(function(e){
          markApiErr(e);
          if(e && e.code==="NO_API_BASE"){
            accessOk = false;
            accessState = "noapi";
          }else if(e && (e.code==="FETCH_FAIL" || e.status===0)){
            accessOk = false;
            accessState = "neterr";
          }else if(e && (e.code==="ACCESS_DENY" || e.status===401 || e.status===403)){
            accessOk = false;
            accessState = "deny";
          }else{
            accessOk = false;
            accessState = "unknown";
          }
          if(cloud) cloud.pullNow();
          scheduleRender();
        });
      }

      function clearToken(){
        if(!Auth.isAdmin()){
          toast("僅 admin 可清除雲端設定");
          return;
        }
        try{ setAccessServiceToken(null); }catch(e){}
        try{ setApiBase(""); }catch(e){}

        $("tokenHint").textContent = "目前狀態：API=未設定 / Token=未設定";
        toast("已清除雲端設定（改用純本機，或之後再設定）");
        accessOk = false;
        accessState = "noapi";
        apiLastStatus = 0;
        apiLastAt = 0;
        apiLastMsg = "";
        scheduleRender();
      }
      function toggleTokenVisible(){
        var inp = $("tokenInput");
        inp.type = (inp.type === "password") ? "text" : "password";
      }

      var _uiBound = false;
      function bindUIOnce(){
        if(_uiBound) return;
        _uiBound = true;

        $("navBack").onclick = function(){ go("汐東工程管理表.html"); };
        setupMoreMenu("汐東工程管理表.html");

        $("btnRead").onclick = toggleReadMode;

        $("btnCloud").onclick = function(){
          if(!getApiBase()){
            if(Auth.isAdmin()){
              toast("⚠️ 尚未設定 API_BASE：請先按右上「雲端設定」。");
              openTokenMask();
            }else{
              toast("⚠️ 尚未設定雲端（請聯絡 admin 設定 API_BASE / Access）");
            }
            return;
          }
          openAttachment(cloudPortalUrl());
        };

        $("btnExport").onclick = function(){
          Auth.validateSession();
          if(!Auth.ensureLoggedIn()) return;
          doExportBackup();
        };

        $("btnView").onclick = function(){
          if(!selectedUid){ toast("請先點選一筆，再按檢視"); return; }
          openModal(selectedUid, false);
        };

        $("qText").addEventListener("input", scheduleRender);
        $("fTrade").addEventListener("change", scheduleRender);
        $("fSys").addEventListener("change", scheduleRender);

        $("btnClear").onclick = function(){
          $("qText").value = "";
          $("fTrade").value = "";
          $("fSys").value = "";
          scheduleRender();
        };

        $("btnAdd").onclick = function(){
          if(!Auth.canWrite()){ toast("唯讀不可新增"); return; }
          editingUid = null;
          openModal(null, true);
        };

        $("btnEdit").onclick = function(){
          if(!Auth.canWrite()){ toast("唯讀不可編輯"); return; }
          if(!selectedUid){ toast("請先點選項目再按編輯"); return; }
          openModal(selectedUid, true);
        };

        $("btnClose").onclick = closeModal;
        $("btnCancel").onclick = closeModal;
        $("mask").addEventListener("click", function(e){ if(e.target === $("mask")) closeModal(); });

        $("btnSave").onclick = saveItem;
        $("btnDelete").onclick = deleteItem;

        $("btnAddTrade").onclick = function(){ openPrompt("trade"); };
        $("btnAddSys").onclick   = function(){ openPrompt("sys"); };
        $("btnAddSource").onclick = function(){ openPrompt("source"); };

        $("pClose").onclick = closePrompt;
        $("pCancel").onclick = closePrompt;
        $("pOk").onclick = addOption;
        $("pMask").addEventListener("click", function(e){ if(e.target === $("pMask")) closePrompt(); });

        $("mTradeSel").addEventListener("change", function(){
          var t = norm($("mTradeSel").value);
          rebuildModalSystemOptions(t, "");
          if(isSysSelEmpty()) $("mSysSel").disabled = true;
          else $("mSysSel").disabled = false;
        });

        $("btnNetDisk").onclick = function(){
          openAttachment(NET_DISK_URL);
        };

        $("tbody").addEventListener("click", function(e){
          var viewBtn = e.target.closest("button[data-act='view']");
          if(viewBtn){
            var uid = norm(viewBtn.getAttribute("data-uid"));
            if(uid) openModal(uid, false);
            return;
          }
          var attBtn = e.target.closest("button[data-act='att']");
          if(attBtn){
            var uid2 = norm(attBtn.getAttribute("data-uid"));
            var item2 = db.find(function(x){ return x.uid === uid2; });
            var href2 = norm(item2 && item2.attach ? item2.attach : "");
            if(!href2){ toast("此筆尚未設定附件"); return; }
            openAttachment(href2);
            return;
          }
          var tr = e.target.closest("tr[data-uid]");
          if(!tr) return;
          var uid3 = norm(tr.getAttribute("data-uid"));
          if(!uid3) return;
          selectedUid = uid3;
          applySelectionToDOM();
          renderHint(filteredRows());
        });

        $("cards").addEventListener("click", function(e){
          var btn = e.target.closest("button[data-act]");
          if(btn){
            var act = btn.getAttribute("data-act");
            var uid = norm(btn.getAttribute("data-uid"));
            if(!uid) return;
            if(act === "view"){
              openModal(uid, false);
              return;
            }
            if(act === "att"){
              var item = db.find(function(x){ return x.uid === uid; });
              var href = norm(item && item.attach ? item.attach : "");
              if(!href){ toast("此筆尚未設定附件"); return; }
              openAttachment(href);
              return;
            }
          }

          var card = e.target.closest(".noteCard[data-uid]");
          if(!card) return;

          var uid2 = norm(card.getAttribute("data-uid"));
          if(!uid2) return;
          selectedUid = uid2;

          card.classList.toggle("open");

          applySelectionToDOM();
          renderHint(filteredRows());
        });

        window.addEventListener("keydown", function(e){
          if(e.key === "Escape"){
            if($("tokenMask").classList.contains("show")) closeTokenMask();
            else if($("pMask").style.display === "flex") closePrompt();
            else if($("mask").style.display === "flex") closeModal();
          }
          if(e.key === "Enter" && $("pMask").style.display === "flex") addOption();
        });

        window.addEventListener("storage", function(e){
          if(e.key === DB_KEY || LEGACY_DB_KEYS.includes(e.key)){
            loadDB(true);
            scheduleRender();
          }
          if(e.key === READ_MODE_KEY){
            applyReadMode(isReadModeOn());
          }
          if(e.key === TRADE_SYS_MAP_KEY || e.key === SOURCE_DICT_KEY){
            scheduleRender();
          }
          if(e.key === ACCESS_ST_KEY || e.key === D1_API_BASE_KEY){
            accessOk = false;
            accessState = getApiBase() ? "unknown" : "noapi";
            if(cloud) cloud.pullNow();
            scheduleRender();
          }
        });

        $("btnToken").onclick = openTokenMask;
        $("tokenClose").onclick = closeTokenMask;
        $("tokenSave").onclick = saveToken;
        $("tokenClear").onclick = clearToken;
        $("tokenToggle").onclick = toggleTokenVisible;

        var nd = $("tokenNetDisk");
        if(nd) nd.onclick = function(){ openAttachment(CLOUD_NETDISK_URL); };

        $("tokenMask").addEventListener("click", function(e){ if(e.target === $("tokenMask")) closeTokenMask(); });
      }

      /* ✅✅✅ 關鍵：開啟頁面先雲端同步（read: pull；write/admin: merge 一次＝pull+push 合併） */
      async function initialCloudSync(){
        if(!getApiBase()){
          accessState = "noapi";
          return false;
        }
        initCloudOnce();
        accessState = "unknown";

        var ok = false;
        if(cloud){
          if(Auth.canWrite()){
            ok = await cloud.saveMerged();  // ✅ 這一步就是你要的：不同設備本機資料自動推上雲端＋同時拉回合併結果
          }else{
            ok = await cloud.pullNow();     // ✅ read 只拉，不推
          }
          startCloudWatchOnce();
        }
        return ok;
      }

      async function start(){
        if(!Auth.ensureLoggedIn()) return;

        tryImportCloudCfgFromAuthTable();

        ensureSeedDict();
        loadDB(true);
        bindUIOnce();
        syncUserUI();

        /* ✅ 手機預設：表格（所以只在 key 不存在時設為 0） */
        try{
          if(localStorage.getItem(READ_MODE_KEY) == null){
            localStorage.setItem(READ_MODE_KEY, "0");
          }
        }catch(e){}

        applyReadMode(isReadModeOn());

        accessState = getApiBase() ? "unknown" : "noapi";
        scheduleRender();

        await initialCloudSync();   // ✅ 先同步再讓畫面穩定（同步過程仍可先看到本機，完成後會自動更新）
        scheduleRender();
      }

      Auth.init({
        onAuthed: function(){ toast("登入成功"); start(); },
        onSessionChange: function(){ syncUserUI(); scheduleRender(); },
        onForceRelogin: function(msg){
          toast(msg || "請重新登入");
          syncUserUI();
          try{ closeModal(); closePrompt(); closeTokenMask(); }catch(e){}
          scheduleRender();
        }
      });

      var toAuth = $("loginToAuth");
      if(toAuth) toAuth.onclick = function(){ go("權限表.html"); };

      start();
    }

    (function(onReady){
      onReady(run);
    })(function(fn){
      try{
        var W = window.__TASUN_WAIT__ || window.__TASUN_READY__;
        if(W){
          if(typeof W.push === "function"){ W.push(fn); return; }
          if(typeof W.then === "function"){ W.then(fn); return; }
          if(W.ready === true){ fn(); return; }
        }
      }catch(e){}
      if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", fn);
      else fn();
    });

  })();
  </script>
</body>
</html>
