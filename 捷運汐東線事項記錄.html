<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>捷運汐東線事項記錄 · Tasun</title>

  <link rel="icon" href="data:,">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- ✅ 全站版本：要與 tasun-version.json 一致 -->
  <script>window.TASUN_APP_VER="20260127_05";</script>

  <!-- ✅ 進站必鎖定最新版 ?v=APP_VER（避免不同裝置卡舊版） -->
  <script>
  (function(){
    var v = (window.TASUN_APP_VER||"").trim();
    if(!v) return;
    try{
      var u = new URL(location.href);
      if(u.searchParams.get("v") !== v){
        u.searchParams.set("v", v);
        location.replace(u.toString());
      }
    }catch(e){}
  })();
  </script>

  <style>
    :root{
      --bg: #0b0d12;
      --gold: #d6b56d;
      --gold2: #f0d8a2;
      --glass: rgba(255,255,255,.08);
      --glass2: rgba(255,255,255,.12);
      --line: rgba(214,181,109,.35);
      --shadow: 0 10px 30px rgba(0,0,0,.55);
      --r: 18px;
      --font: "Noto Serif TC", "Noto Sans TC", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang TC", "Microsoft JhengHei", sans-serif;
    }
    html,body{height:100%; margin:0; background:var(--bg); color:#e9eef6; font-family:var(--font);}
    *{box-sizing:border-box;}
    .wrap{
      min-height:100%;
      display:flex;
      flex-direction:column;
      padding:18px 14px 16px;
      gap:12px;
      position:relative;
      overflow:hidden;
    }
    /* 背景光暈 */
    .glow{
      position:absolute; inset:-30% -30%;
      background:
        radial-gradient(closest-side, rgba(214,181,109,.20), transparent 70%),
        radial-gradient(closest-side, rgba(160,120,255,.12), transparent 65%),
        radial-gradient(closest-side, rgba(120,255,240,.06), transparent 60%);
      filter: blur(30px);
      opacity:.75;
      pointer-events:none;
      transform: translate3d(0,0,0);
    }
    header{
      position:relative;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      z-index:2;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:6px;
      max-width:72%;
    }
    .title h1{
      margin:0;
      font-weight:700;
      letter-spacing:.08em;
      font-size:22px;
      color:var(--gold2);
      text-shadow: 0 0 10px rgba(214,181,109,.35);
    }
    .title .sub{
      font-size:13px;
      opacity:.86;
      line-height:1.25;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      box-shadow: 0 8px 24px rgba(0,0,0,.35);
      white-space:nowrap;
      user-select:none;
    }
    .pill b{color:var(--gold2); font-weight:700;}
    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:flex-start;
      max-width:44%;
    }
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      color: #eef3fb;
      border-radius: 999px;
      padding: 10px 14px;
      cursor:pointer;
      box-shadow: 0 10px 26px rgba(0,0,0,.38);
      font-weight:700;
      letter-spacing:.06em;
      font-size:14px;
      user-select:none;
    }
    .btn:active{transform: translateY(1px);}
    .btn.primary{
      border-color: rgba(240,216,162,.55);
      background: linear-gradient(180deg, rgba(240,216,162,.22), rgba(214,181,109,.12));
      color:#fff;
    }

    main{
      position:relative;
      z-index:2;
      display:flex;
      flex-direction:column;
      gap:12px;
      flex:1;
    }
    .panel{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid rgba(214,181,109,.22);
      background: linear-gradient(180deg, rgba(214,181,109,.10), rgba(255,255,255,0));
    }
    .panel .hd .left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .panel .hd .left .k{
      font-weight:800;
      letter-spacing:.08em;
      color: var(--gold2);
      font-size:14px;
    }
    .panel .hd .left .v{
      font-size:12px;
      opacity:.86;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 48vw;
    }
    .panel .bd{
      padding: 12px 12px 10px;
    }

    /* 表格 */
    .tblWrap{
      width:100%;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width: 920px;
    }
    th, td{
      border:1px solid rgba(214,181,109,.22);
      padding:10px 10px;
      vertical-align:top;
      font-size:13px;
      line-height:1.35;
    }
    th{
      color: var(--gold2);
      background: rgba(214,181,109,.10);
      position:sticky;
      top:0;
      z-index:1;
      text-align:left;
      white-space:nowrap;
    }
    td textarea, td input, td select{
      width:100%;
      font: inherit;
      color:#eef3fb;
      background: rgba(0,0,0,.20);
      border:1px solid rgba(214,181,109,.20);
      border-radius: 12px;
      padding:8px 10px;
      outline:none;
      resize: vertical;
      min-height: 40px;
    }
    td input, td select{min-height: 40px;}
    td textarea{min-height: 68px;}
    td .mini{
      font-size:12px;
      opacity:.85;
      margin-top:6px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      padding:2px 10px;
      border:1px solid rgba(214,181,109,.25);
      border-radius:999px;
      background: rgba(255,255,255,.06);
    }
    .right{ text-align:right; }
    .muted{ opacity:.78; }

    /* 底部狀態列 */
    .statusbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-top:4px;
    }
    .hint{
      font-size:12px;
      opacity:.85;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .hint b{color:var(--gold2); font-weight:800;}
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(214,181,109,.24);
      background: rgba(255,255,255,.06);
    }

    /* RWD：手機 */
    @media (max-width: 760px){
      .title{max-width:64%;}
      .btns{max-width:52%;}
      .title h1{font-size:19px;}
      .btn{padding:10px 12px;}
      .panel .hd .left .v{max-width: 56vw;}
      table{min-width: 980px;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="glow"></div>

    <header>
      <div class="title">
        <h1>捷運汐東線事項記錄</h1>
        <div class="sub">多人/多設備同步（讀取公開，寫入需 Cloudflare Access）</div>
      </div>
      <div class="btns">
        <button class="btn" id="btnBack">返回</button>
        <button class="btn" id="btnAdd">新增</button>
        <button class="btn primary" id="btnSave">存檔/同步</button>
      </div>
    </header>

    <main>
      <section class="panel">
        <div class="hd">
          <div class="left">
            <div class="k">目前狀態</div>
            <div class="v" id="stateLine">初始化中…</div>
          </div>
          <div class="pill">
            使用者：<b id="who">未登入</b>
            <span class="muted" id="role">(read)</span>
          </div>
        </div>
        <div class="bd">
          <div class="tblWrap">
            <table id="tbl">
              <thead>
                <tr>
                  <th style="width:72px;">項次</th>
                  <th style="min-width:260px;">記事內容</th>
                  <th style="width:130px;">工種</th>
                  <th style="width:150px;">系統</th>
                  <th style="min-width:190px;">附件</th>
                  <th style="min-width:220px;">備註</th>
                  <th style="width:150px;">登錄日期</th>
                </tr>
              </thead>
              <tbody id="tb"></tbody>
            </table>
          </div>

          <div class="statusbar">
            <div class="hint" id="hint"></div>
            <div class="hint">
              <span class="chip">筆數：<b id="cnt">0</b></span>
              <span class="chip">本機：<b id="localState">未載入</b></span>
              <span class="chip">雲端：<b id="cloudState">未檢查</b></span>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

<script>
/* =========================================================
 * 捷運汐東線事項記錄.html（GitHub backend via Cloudflare Worker）
 * - read: GET  /api/tasun/pull?key=RESOURCE_KEY
 * - write: POST /api/tasun/merge  (Cloudflare Access protect)
 * - localStorage as local cache
 * ========================================================= */

(function(){
  "use strict";

  // ===== Page identity =====
  var PAGE_KEY = "sxdh-notes";
  var RESOURCES_URL = "tasun-resources.json"; // 用於取得 API_BASE
  var API_BASE_DEFAULT = ""; // 若 resources 沒設定，可填入 https://tasun-worker.wutasun.workers.dev

  // ===== Local keys =====
  var DB_KEY = "tasunSxdhNotes_v1";
  var COUNTER_KEY = "tasunSxdhNotes_counter_v1";
  var READ_MODE_KEY  = "tasunSxdhNotes_readMode_v1";
  var USER_KEY = "tasunSxdhNotes_user_v1";

  // ===== Cloud keys =====
  // 依「全站雲端同步標準 v1」：pk 一律 uid(uuid)
  var RESOURCE_KEY = PAGE_KEY;
  var PK = "uid";

  // ===== Runtime =====
  var API_BASE = "";

  // ===== UI refs =====
  var elTB = document.getElementById("tb");
  var elCnt = document.getElementById("cnt");
  var elStateLine = document.getElementById("stateLine");
  var elWho = document.getElementById("who");
  var elRole = document.getElementById("role");
  var elHint = document.getElementById("hint");
  var elLocalState = document.getElementById("localState");
  var elCloudState = document.getElementById("cloudState");

  // ===== Simple users (page-level) =====
  // 注意：真正寫入權限以 Cloudflare Access（Emails allow list）為準
  var USERS = [
    { u:"alex",  p:"admin", role:"admin" },
    { u:"tasun", p:"write", role:"write" },
    { u:"wu",    p:"read",  role:"read" }
  ];

  // ===== Utilities =====
  function nowISO(){ return new Date().toISOString(); }
  function qs(sel,root){ return (root||document).querySelector(sel); }
  function qsa(sel,root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
  function norm(s){ return (s===undefined||s===null) ? "" : String(s); }

  function toast(msg, ms){
    try{ console.log("[toast]", msg); }catch(e){}
    ms = ms || 2600;
    var t = document.createElement("div");
    t.style.cssText = "position:fixed;left:50%;bottom:18px;transform:translateX(-50%);max-width:92vw;z-index:9999;padding:10px 14px;border-radius:999px;border:1px solid rgba(214,181,109,.35);background:rgba(20,22,30,.88);color:#fff;box-shadow:0 12px 28px rgba(0,0,0,.45);font:700 13px/1.2 var(--font);letter-spacing:.04em";
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(function(){ t.style.opacity="0"; t.style.transition="opacity .25s"; }, ms-250);
    setTimeout(function(){ try{ t.remove(); }catch(e){} }, ms);
  }

  function uuid(){
    // RFC4122 v4 (safe enough)
    var s = [], hex = "0123456789abcdef";
    for(var i=0;i<36;i++) s[i] = hex[Math.floor(Math.random()*16)];
    s[14] = "4";
    s[19] = hex[(parseInt(s[19],16)&0x3)|0x8];
    s[8]=s[13]=s[18]=s[23]="-";
    return s.join("");
  }

  function safeJsonParse(s, fallback){
    try{ return JSON.parse(s); }catch(e){ return fallback; }
  }

  function loadLS(key, fallback){
    try{
      var v = localStorage.getItem(key);
      if(v===null||v===undefined) return fallback;
      return safeJsonParse(v, fallback);
    }catch(e){ return fallback; }
  }
  function saveLS(key, obj){
    try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(e){}
  }

  // ===== Auth (page-level) =====
  function getUser(){
    var u = loadLS(USER_KEY, null);
    if(!u || !u.u) return { u:"wu", role:"read" };
    var found = USERS.find(function(x){ return x.u===u.u && x.role===u.role; });
    return found ? {u:found.u, role:found.role} : { u:"wu", role:"read" };
  }
  function setUser(u, role){
    saveLS(USER_KEY, {u:u, role:role, at: nowISO()});
  }

  // ===== Data model =====
  // 標準 v1：uid/rev/updatedAt/deleted 必備，id 僅顯示
  function newRow(){
    var uid_ = uuid();
    return {
      uid: uid_,
      id: "",                // 顯示用（可空）
      content: "",
      trade: "",
      system: "",
      attach: "",
      note: "",
      date: "",
      rev: 1,
      updatedAt: nowISO(),
      deleted: false
    };
  }

  function normalizeRows(rows){
    rows = Array.isArray(rows) ? rows : [];
    return rows.map(function(r){
      r = r || {};
      if(!r.uid) r.uid = uuid();
      if(r.deleted!==true) r.deleted = false;
      if(!r.updatedAt) r.updatedAt = nowISO();
      if(!r.rev) r.rev = 1;
      if(r.id===undefined||r.id===null) r.id = "";
      if(r.content===undefined||r.content===null) r.content = "";
      if(r.trade===undefined||r.trade===null) r.trade = "";
      if(r.system===undefined||r.system===null) r.system = "";
      if(r.attach===undefined||r.attach===null) r.attach = "";
      if(r.note===undefined||r.note===null) r.note = "";
      if(r.date===undefined||r.date===null) r.date = "";
      return r;
    });
  }

  // ===== Cloud: resolve API_BASE from tasun-resources.json =====
  async function resolveApiBase(){
    if(API_BASE) return API_BASE;
    var base = "";
    try{
      var u = new URL(RESOURCES_URL, location.href).toString();
      var r = await fetch(u, { cache:"no-store" });
      var j = await r.json();
      // 支援多種寫法
      base = (j && (j.API_BASE || j.apiBase || (j.cloud && j.cloud.API_BASE) || (j.cloud && j.cloud.apiBase))) || "";
    }catch(e){}
    base = (base||API_BASE_DEFAULT||"").trim();
    API_BASE = base.replace(/\/+$/,"");
    return API_BASE;
  }

  // ===== Server API =====
  async function apiPull(){
    var base = await resolveApiBase();
    if(!base) throw { code:"off" };
    var url = base + "/api/tasun/pull?key=" + encodeURIComponent(RESOURCE_KEY) + "&t=" + Date.now();
    var r = await fetch(url, { method:"GET", credentials:"include", cache:"no-store", redirect:"manual" });
    if(r.type==="opaqueredirect" || (r.status>=300 && r.status<400)) throw { code:"need_auth", status:r.status };
    if(!r.ok){
      if(r.status===401||r.status===403) throw { code:"deny", status:r.status };
      throw { code:"neterr", status:r.status };
    }
    var j = null;
    try{ j = await r.json(); }catch(e){}
    if(!j || !j.ok) throw { code:"bad", status:r.status, detail:j };
    return j.data || {};
  }

  async function apiMerge(body){
    var base = await resolveApiBase();
    if(!base) throw { code:"off" };
    var url = base + "/api/tasun/merge";
    var r = await fetch(url, {
      method:"POST",
      credentials:"include",
      cache:"no-store",
      redirect:"manual",
      headers: { "content-type":"application/json" },
      body: JSON.stringify(body)
    });
    if(r.type==="opaqueredirect" || (r.status>=300 && r.status<400)) throw { code:"need_auth", status:r.status };
    if(!r.ok){
      if(r.status===401||r.status===403) throw { code:"deny", status:r.status };
      throw { code:"neterr", status:r.status };
    }
    var j = null;
    try{ j = await r.json(); }catch(e){}
    if(!j || !j.ok) throw { code:"bad", status:r.status, detail:j };
    return j.data || {};
  }

  // ===== Merge strategy (client-side, standard v1) =====
  function indexBy(rows, key){
    var m = new Map();
    rows.forEach(function(r){ if(r && r[key]) m.set(String(r[key]), r); });
    return m;
  }

  function mergeRows(localRows, cloudRows){
    localRows = normalizeRows(localRows);
    cloudRows = normalizeRows(cloudRows);

    var lm = indexBy(localRows, PK);
    var cm = indexBy(cloudRows, PK);

    // union keys
    var keys = new Set();
    lm.forEach(function(_,k){ keys.add(k); });
    cm.forEach(function(_,k){ keys.add(k); });

    var merged = [];
    keys.forEach(function(k){
      var a = lm.get(k);
      var b = cm.get(k);
      if(!a && b){ merged.push(b); return; }
      if(a && !b){ merged.push(a); return; }
      // both exist: pick newer updatedAt; if tie, higher rev
      var atA = Date.parse(a.updatedAt||"") || 0;
      var atB = Date.parse(b.updatedAt||"") || 0;
      if(atA > atB) merged.push(a);
      else if(atB > atA) merged.push(b);
      else {
        merged.push( (Number(a.rev||0) >= Number(b.rev||0)) ? a : b );
      }
    });

    // sort by date then id (optional)
    merged.sort(function(x,y){
      var dx = (x.date||"").localeCompare(y.date||"");
      if(dx!==0) return dx;
      return (x.id||"").localeCompare(y.id||"");
    });

    return normalizeRows(merged);
  }

  // ===== Cloud controller =====
  var cloudState = "init"; // ok/off/deny/neterr/bad/need_auth
  var lastCloudAt = 0;
  var lastPullAt = 0;

  function renderHint(){
    var u = getUser();
    elWho.textContent = u.u;
    elRole.textContent = "(" + u.role + ")";

    var localTxt = "OK";
    elLocalState.textContent = localTxt;

    var cloudTxt = "OFF";
    if(cloudState==="init") cloudTxt = "INIT";
    if(cloudState==="ok") cloudTxt = "OK";
    if(cloudState==="off") cloudTxt = "OFF";
    if(cloudState==="deny") cloudTxt = "DENY";
        if(cloudState==="need_auth") cloudTxt = "需登入 Access";
    if(cloudState==="neterr") cloudTxt = "NET";
    if(cloudState==="bad") cloudTxt = "BAD";
    elCloudState.textContent = cloudTxt;

    var msg = [];
    msg.push("pageKey=" + PAGE_KEY);
    msg.push("resourceKey=" + RESOURCE_KEY);
    msg.push("pk=" + PK);
    if(API_BASE) msg.push("api=" + API_BASE);

    // 顯示更友善狀態
    if(cloudState==="need_auth"){
      msg.push("寫入需先登入 Cloudflare Access（允許 Emails 才能寫入）");
    }else if(cloudState==="deny"){
      msg.push("雲端拒絕（權限不足）");
    }else if(cloudState==="neterr"){
      msg.push("雲端連線失敗");
    }else if(cloudState==="bad"){
      msg.push("雲端回應異常");
    }else if(cloudState==="off"){
      msg.push("尚未設定 API_BASE（tasun-resources.json）");
    }else if(cloudState==="ok"){
      msg.push("雲端已連線");
    }

    elHint.textContent = msg.join(" · ");
    elStateLine.textContent = (cloudState==="ok" ? "雲端可用" : (cloudState==="need_auth" ? "寫入需登入 Access" : "雲端：" + cloudTxt));
  }

  function CloudCtrl(opts){
    this.opts = opts || {};
    this.busy = false;
  }
  CloudCtrl.prototype.pullNow = async function(){
    var self = this;
    if(self.busy) return false;
    self.busy = true;
    try{
      var data = await apiPull();
      cloudState = "ok";
      lastPullAt = Date.now();
      self.busy = false;
      return data;
    }catch(e){
      self.busy=false;
      cloudState = e.code || "neterr";
      renderHint();
      if(cloudState==="need_auth"){
        toast("需要 Cloudflare Access 登入才能寫入：請先在新分頁開啟 "+(API_BASE||"")+"/api/tasun/merge 進行登入，再回來重試。", 7000);
      }
      return false;
    }
  };
  CloudCtrl.prototype.saveMerged = async function(localRows){
    var self = this;
    if(self.busy) return false;
    self.busy = true;
    try{
      // pull latest cloud
      var cloudData = await apiPull();
      var cloudRows = normalizeRows(cloudData.rows || []);
      var merged = mergeRows(localRows, cloudRows);

      // payload for worker merge
      var body = {
        key: RESOURCE_KEY,
        pk: PK,
        rows: merged,
        meta: {
          pageKey: PAGE_KEY,
          updatedAt: nowISO(),
          count: merged.length
        }
      };

      var res = await apiMerge(body);
      cloudState = "ok";
      lastCloudAt = Date.now();
      self.busy = false;
      return res;
    }catch(e){
      self.busy=false;
      cloudState = e.code || "neterr";
      renderHint();
      if(cloudState==="need_auth"){
        toast("需要 Cloudflare Access 登入才能寫入：請先在新分頁開啟 "+(API_BASE||"")+"/api/tasun/merge 進行登入，再回來重試。", 7000);
      }
      return false;
    }
  };

  var cloud = new CloudCtrl({});

  // ===== UI render =====
  var rows = [];

  function render(){
    elTB.innerHTML = "";
    rows = normalizeRows(rows);

    // 顯示序號（id 顯示用，若空則用 1..n）
    rows.forEach(function(r, idx){
      var tr = document.createElement("tr");

      // item
      var td0 = document.createElement("td");
      td0.className = "right";
      var inp0 = document.createElement("input");
      inp0.placeholder = String(idx+1);
      inp0.value = norm(r.id);
      inp0.addEventListener("input", function(){
        r.id = this.value;
        touch(r);
      });
      td0.appendChild(inp0);
      tr.appendChild(td0);

      // content
      tr.appendChild(makeTA(r, "content", "請輸入記事內容…"));

      // trade
      tr.appendChild(makeIN(r, "trade", "工種"));

      // system
      tr.appendChild(makeIN(r, "system", "系統"));

      // attach
      tr.appendChild(makeTA(r, "attach", "附件連結/說明…"));

      // note
      tr.appendChild(makeTA(r, "note", "備註…"));

      // date
      var td6 = document.createElement("td");
      var inp6 = document.createElement("input");
      inp6.placeholder = "YYYY-MM-DD";
      inp6.value = norm(r.date);
      inp6.addEventListener("input", function(){
        r.date = this.value;
        touch(r);
      });
      td6.appendChild(inp6);

      // mini
      var mini = document.createElement("div");
      mini.className = "mini";
      mini.innerHTML =
        '<span class="tag">uid: '+escapeHtml(r.uid).slice(0,8)+'…</span>' +
        '<span class="tag">rev: '+(r.rev||0)+'</span>' +
        '<span class="tag">upd: '+escapeHtml((r.updatedAt||"").replace("T"," ").slice(0,19))+'</span>' +
        (r.deleted ? '<span class="tag" style="border-color:rgba(255,80,80,.35);">deleted</span>' : '');
      td6.appendChild(mini);

      tr.appendChild(td6);

      elTB.appendChild(tr);
    });

    elCnt.textContent = String(rows.length);
    saveLocal();
    renderHint();
  }

  function escapeHtml(s){
    s = String(s||"");
    return s.replace(/[&<>"']/g, function(c){
      return {"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[c];
    });
  }

  function touch(r){
    r.rev = Number(r.rev||0) + 1;
    r.updatedAt = nowISO();
  }

  function makeIN(r, key, placeholder){
    var td = document.createElement("td");
    var input = document.createElement("input");
    input.placeholder = placeholder || "";
    input.value = norm(r[key]);
    input.addEventListener("input", function(){
      r[key] = this.value;
      touch(r);
    });
    td.appendChild(input);
    return td;
  }

  function makeTA(r, key, placeholder){
    var td = document.createElement("td");
    var ta = document.createElement("textarea");
    ta.placeholder = placeholder || "";
    ta.value = norm(r[key]);
    ta.addEventListener("input", function(){
      r[key] = this.value;
      touch(r);
      autoGrow(ta);
    });
    td.appendChild(ta);
    setTimeout(function(){ autoGrow(ta); }, 0);
    return td;
  }

  function autoGrow(el){
    try{
      el.style.height = "auto";
      el.style.height = (el.scrollHeight + 2) + "px";
    }catch(e){}
  }

  // ===== Local persistence =====
  function loadLocal(){
    var obj = loadLS(DB_KEY, null);
    if(!obj || !obj.rows) return [];
    return normalizeRows(obj.rows);
  }
  function saveLocal(){
    saveLS(DB_KEY, { rows: rows, updatedAt: nowISO() });
    elLocalState.textContent = "OK";
  }

  // ===== Actions =====
  async function initialLoad(){
    renderHint();
    rows = loadLocal();
    render();

    // pull from cloud (read)
    try{
      await resolveApiBase();
      var data = await cloud.pullNow();
      if(data && data.rows){
        var cloudRows = normalizeRows(data.rows);
        // merge local+cloud to avoid overwrite
        rows = mergeRows(rows, cloudRows);
        saveLocal();
        cloudState = "ok";
        render();
      }
    }catch(e){
      cloudState = (e && e.code) ? e.code : "neterr";
      renderHint();
    }
  }

  function addRow(){
    rows.push(newRow());
    render();
  }

  async function saveNow(){
    var u = getUser();
    if(u.role==="read"){
      toast("read 使用者不可寫入（請切換為 admin/write）", 3000);
      return;
    }
    renderHint();

    var res = await cloud.saveMerged(rows);
    if(res){
      toast("已合併寫入雲端", 2400);
      // pull once to ensure latest
      var data = await cloud.pullNow();
      if(data && data.rows){
        rows = mergeRows(rows, normalizeRows(data.rows));
        saveLocal();
        render();
      }
    }else{
      if(cloudState==="need_auth"){
        // 已由 CloudCtrl toast
      }else{
        toast("寫入失敗（" + cloudState + "）", 3500);
      }
    }
  }

  // ===== Back / user switching =====
  function goBack(){
    // 若有上一頁，回上一頁；否則回到臻鼎管理表或 index
    try{
      if(history.length>1) history.back();
      else location.href = "index.html";
    }catch(e){
      location.href = "index.html";
    }
  }

  function cycleUser(){
    var cur = getUser();
    var idx = USERS.findIndex(function(x){ return x.u===cur.u && x.role===cur.role; });
    idx = (idx<0) ? 0 : idx;
    var next = USERS[(idx+1) % USERS.length];
    setUser(next.u, next.role);
    toast("切換使用者：" + next.u + " (" + next.role + ")", 2000);
    renderHint();
  }

  // ===== Bind =====
  document.getElementById("btnBack").addEventListener("click", goBack);
  document.getElementById("btnAdd").addEventListener("click", addRow);
  document.getElementById("btnSave").addEventListener("click", saveNow);

  // double-click the pill to cycle user quickly
  try{
    var pill = document.querySelector(".pill");
    pill.addEventListener("dblclick", cycleUser);
  }catch(e){}

  // init user default
  (function(){
    var u = loadLS(USER_KEY, null);
    if(!u){ setUser("wu","read"); }
  })();

  // start
  initialLoad();

})();
</script>

</body>
</html>
