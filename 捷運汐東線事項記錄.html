<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>捷運汐東線事項記錄 · Tasun</title>

  <link rel="icon" href="data:,">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- ✅ 全站版本：可與 tasun-version.json 一致（本頁只用於 cache busting/顯示） -->
  <script>window.TASUN_APP_VER="20260224_01";</script>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700;800;900&family=Noto+Serif+TC:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#dbe3e1; --bg1:#c7d4d1;
      --ink:#111;
      --paper: rgba(255,255,255,.96);
      --paper2: rgba(255,255,255,.92);
      --border: rgba(0,0,0,.18);
      --border2: rgba(0,0,0,.28);
      --r:18px;
      --shadow: 0 16px 44px rgba(0,0,0,.10);
      --shadow2: 0 10px 26px rgba(0,0,0,.08);

      --goldHi: rgba(255,254,246,.98);
      --goldText: rgba(246,214,150,.98);
      --goldDeep: rgba(170,110,18,.98);

      --strokeBlack: rgba(0,0,0,.58);
      --olPx: .78px;

      --titleSize: clamp(28px, 2.6vw, 42px);
      --subSize:   clamp(12.5px, 1.05vw, 15.5px);
      --labelSize: clamp(13.5px, 1.00vw, 15.5px);
      --ctrlSize:  clamp(13.5px, 1.05vw, 16px);
      --thSize:    clamp(15px, 1.10vw, 17px);
      --tdSize:    clamp(14.5px, 1.06vw, 16.5px);
      --readBody:  clamp(14.5px, 1.10vw, 17.5px);

      --btnFont: clamp(14.5px, 1.12vw, 17px);
      --btnFontSmall: clamp(13.5px, 1.06vw, 16px);

      /* ✅ 修訂 1：舞台兩側距離網頁邊框固定 1cm（桌機） */
      --stageSide: 1cm;

      --tableWrapBg: rgba(255,252,244,.94);
      --tableBg: rgba(255,252,244,.92);
      --tableHeadBg: rgba(252,240,218,.96);
      --tableStripe: rgba(40,120,90,.035);
      --tableHover: rgba(170,110,18,.060);
      --tableSel: rgba(170,110,18,.120);
      --tableLine: rgba(90,60,20,.180);
      --tableText: rgba(22,18,14,.92);
      --tableMuted: rgba(90,60,20,.55);

      --btnBg1: rgba(255,255,255,.70);
      --btnBg2: rgba(255,255,255,.54);
      --btnBgGhost1: rgba(255,255,255,.62);
      --btnBgGhost2: rgba(255,255,255,.46);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    html{
      background:
        radial-gradient(1000px 560px at 50% 120px, rgba(255,255,255,.55), transparent 64%),
        radial-gradient(1200px 900px at 32% 36%, rgba(255,255,255,.40), transparent 68%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    body{
      margin:0; color:var(--ink);
      font-family:"Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      background: inherit;
      overflow:hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    :where(.sub,.label,.pill,.hint,.miniHint,.loginErr,.loginHint,.toast, thead th, tbody td, .noteTag,.noteNo,.noteBody){
      text-shadow:none !important; filter:none !important;
    }

    .goldCrystal{
      display:inline-block;
      --_ol: var(--strokeBlack); --_olpx: var(--olPx);
      background: linear-gradient(180deg, var(--goldHi) 0%, rgba(255,246,224,.98) 18%, var(--goldText) 46%, rgba(226,156,54,.98) 78%, var(--goldHi) 100%);
      -webkit-background-clip:text; background-clip:text;
      color: var(--goldDeep);
      text-shadow:
        var(--_olpx) 0 0 var(--_ol), calc(var(--_olpx)*-1) 0 0 var(--_ol),
        0 var(--_olpx) 0 var(--_ol), 0 calc(var(--_olpx)*-1) 0 var(--_ol),
        var(--_olpx) var(--_olpx) 0 var(--_ol), var(--_olpx) calc(var(--_olpx)*-1) 0 var(--_ol),
        calc(var(--_olpx)*-1) var(--_olpx) 0 var(--_ol), calc(var(--_olpx)*-1) calc(var(--_olpx)*-1) 0 var(--_ol);
    }
    @supports (-webkit-background-clip:text) or (background-clip:text){
      .goldCrystal{ color: transparent; -webkit-text-fill-color: transparent; }
    }

    .wrap{
      width:min(1720px, calc(100vw - (2*var(--stageSide))));
      margin:0 auto;
      padding: 18px 16px 18px;
      height:100vh;
      display:flex; flex-direction:column; gap:16px;
    }

    .topbar{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      gap:12px; align-items:center;
      padding:14px 14px;
      border:1px solid var(--border2);
      border-radius:var(--r);
      background: linear-gradient(180deg, var(--paper), var(--paper2));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    @media (max-width:920px){
      .topbar{grid-template-columns:1fr}
      .nav-left{order:0} .brand{order:1} .right{order:2; justify-content:flex-start}
    }

    .nav-left{display:flex; gap:10px; flex-wrap:wrap; align-items:center; min-width:220px;}
    .nav-desktop{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .nav-mobile{display:none; gap:10px; align-items:center; width:100%;}
    @media (max-width:600px){ .nav-desktop{display:none;} .nav-mobile{display:flex;} }

    .brand{display:flex; flex-direction:column; gap:6px; align-items:center; justify-content:center; text-align:center;}
    .title{font-family:"Noto Serif TC","Noto Sans TC",serif; font-weight:820; letter-spacing:.10em; font-size:var(--titleSize); line-height:1.12;}
    .sub{font-size:var(--subSize); color:rgba(0,0,0,.55); letter-spacing:.10em; font-weight:700;}

    .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; min-width:220px;}
    .pill{
      padding:9px 12px; border-radius:999px; border:1px solid var(--border);
      background: rgba(255,255,255,.90); font-size:14px; color: rgba(0,0,0,.78);
      display:flex; gap:8px; align-items:center; white-space:nowrap;
      box-shadow: var(--shadow2); font-weight:800; letter-spacing:.03em;
    }
    .pill b{font-weight:900; color: rgba(0,0,0,.86);}

    .btn{
      position:relative; appearance:none;
      border:1px solid var(--border2);
      background: linear-gradient(180deg, var(--btnBg1), var(--btnBg2));
      padding:11px 16px; border-radius:999px;
      cursor:pointer; font-family:inherit;
      font-weight:720; letter-spacing:.05em;
      font-size: var(--btnFont);
      box-shadow: 0 12px 22px rgba(0,0,0,.10);
      transition:transform .12s ease, border-color .12s ease, box-shadow .12s ease;
      user-select:none; white-space:nowrap;
      color: rgba(0,0,0,.82); overflow:hidden;
    }
    .btn::before{
      content:""; position:absolute; inset:0; pointer-events:none;
      background: radial-gradient(240px 110px at 26% 20%, rgba(255,255,255,.12), transparent 66%);
      opacity:.28; z-index:0;
    }
    .btn:hover{transform:translateY(-1px); border-color: rgba(0,0,0,.40); box-shadow: 0 14px 26px rgba(0,0,0,.12);}
    .btn:active{transform:none}
    .btn.ghost{ background: linear-gradient(180deg, var(--btnBgGhost1), var(--btnBgGhost2)); border:1px solid var(--border); }
    .btn.danger{ border-color: rgba(0,0,0,.42); }
    .small{ padding:10px 14px; font-size: var(--btnFontSmall); }
    .btn[disabled]{opacity:.45; cursor:not-allowed; transform:none !important;}
    .btn .t{
      position:relative; z-index:1; display:inline-block;
      color: rgba(120,64,6,.98);
      font-weight:700; letter-spacing:.04em; line-height:1.12;
      text-shadow:none !important;
    }

    .panel{
      border:1px solid var(--border2);
      border-radius:var(--r);
      background: linear-gradient(180deg, var(--paper), var(--paper2));
      box-shadow: var(--shadow);
      padding:14px;
      flex:1; min-height:0;
      display:flex; flex-direction:column;
      overflow:hidden;
    }

    .panelHead{display:flex; flex-direction:column; gap:10px; flex:0 0 auto;}
    .controls{display:grid; grid-template-columns: 1.3fr .9fr .9fr auto; gap:10px; align-items:end;}
    @media (max-width:920px){ .controls{grid-template-columns:1fr 1fr} }
    @media (max-width:520px){ .controls{grid-template-columns:1fr} }

    .field{display:flex; flex-direction:column; gap:6px;}
    .label{font-size:var(--labelSize); letter-spacing:.08em; font-weight:700; color: rgba(0,0,0,.70); text-align:center;}
    input,select,textarea{
      width:100%;
      border-radius:14px; border:1px solid var(--border2);
      background: rgba(255,255,255,.96); color: rgba(0,0,0,.86);
      padding:11px 12px; font-family:inherit;
      font-size:var(--ctrlSize); font-weight:700;
      outline:none; transition:border-color .12s ease, box-shadow .12s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
    }
    input:focus,select:focus,textarea:focus{ border-color: rgba(0,0,0,.46); box-shadow: 0 0 0 3px rgba(0,0,0,.08), 0 12px 26px rgba(0,0,0,.10); }
    textarea{min-height:92px; resize:vertical;}
    select{ text-align:center; text-align-last:center; font-weight:800; }
    select option{ background:#fff; color: rgba(0,0,0,.88); }

    .hint{
      display:flex; flex-wrap:wrap; gap:8px;
      align-items:center; justify-content:center;
      padding:9px 10px;
      min-height: 44px;
      border-radius:14px; border:1px solid var(--border);
      background: rgba(255,255,255,.92);
      box-shadow: 0 12px 26px rgba(0,0,0,.08);
      color: rgba(0,0,0,.78);
      font-size:14px; line-height:1.55;
      font-weight:900; letter-spacing:.04em;
    }
    .hint .hb{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(0,0,0,.14); background: rgba(255,255,255,.86); white-space:nowrap; }
    .hint .hb .k{ color: rgba(0,0,0,.62); font-weight:900; }
    .hint .hb .v{ color: rgba(0,0,0,.84); font-weight:900; }
    .hint .hb.bad .v{ color: rgba(170,60,60,.92); }

    .panelBody{flex:1; min-height:0; display:flex; flex-direction:column;}
    .tableWrap{
      margin-top:4px;
      overflow:auto;
      border-radius:16px;
      border:1px solid var(--border2);
      background: var(--tableWrapBg);
      box-shadow: var(--shadow2);
      flex:1; min-height:0;
      -webkit-overflow-scrolling: touch;
    }

    table{width:100%; border-collapse:collapse; min-width:1460px; background: var(--tableBg);}
    thead th{
      position:sticky; top:0; z-index:3;
      padding:13px 10px;
      border-bottom:1px solid var(--tableLine);
      white-space:nowrap; text-align:center;
      letter-spacing:.06em;
      font-size: var(--thSize);
      font-weight:900;
      color: rgba(30,22,16,.92);
      background: var(--tableHeadBg);
    }
    tbody td{
      padding:13px 10px;
      border-bottom:1px solid var(--tableLine);
      vertical-align:top;
      font-size: var(--tdSize);
      color: var(--tableText);
      line-height:1.75;
      font-weight:700;
      background: transparent;
    }
    tbody tr:nth-child(even) td{ background: var(--tableStripe); }
    tbody tr:hover td{ background: var(--tableHover); }
    tbody tr.sel td{ background: var(--tableSel); }
    .muted{ color: var(--tableMuted); }

    .attBtn{
      display:inline-flex; align-items:center; justify-content:center; gap:6px;
      padding:9px 12px; border-radius:999px;
      border:1px solid var(--border2); background: rgba(255,255,255,.88);
      cursor:pointer; white-space:nowrap;
      box-shadow: 0 10px 20px rgba(0,0,0,.08);
      font-weight:900;
    }
    .attBtn .t{ color: rgba(0,0,0,.82); letter-spacing:.04em; font-weight:900; }

    .mask,.pMask,.loginMask{
      position:fixed; inset:0;
      display:none; align-items:center; justify-content:center;
      padding:20px; z-index:100;
      background: rgba(0,0,0,.45);
    }
    .modal,.pModal,.loginModal{
      width:min(980px, 96vw);
      border-radius:22px; border:1px solid var(--border2);
      background: rgba(255,255,255,.98);
      box-shadow:0 32px 110px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .pModal,.loginModal{ width:min(560px, 96vw); }
    .mHead,.pHead,.loginHead{
      padding:14px 16px;
      display:grid; grid-template-columns: 1fr auto 1fr;
      align-items:center; gap:10px;
      border-bottom:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.98);
      min-height:56px;
    }
    .mTitle,.pTitle,.loginTitle{
      grid-column:2; justify-self:center;
      letter-spacing:.14em;
      font-family:"Noto Serif TC","Noto Sans TC",serif;
      font-size: clamp(16px, 1.6vw, 22px);
      font-weight:900; white-space:nowrap;
    }
    .mHead .btn,.pHead .btn,.loginHead .btn{ grid-column:3; justify-self:end; }
    .mBody,.pBody,.loginBody{ padding:14px 16px 10px; color: rgba(0,0,0,.86); }
    .mFoot,.pFoot,.loginFoot{
      padding:12px 16px;
      display:flex; gap:10px;
      justify-content:flex-end; flex-wrap:wrap;
      border-top:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.98);
    }

    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .span2{grid-column:span 2}
    @media (max-width:720px){
      .grid{grid-template-columns:1fr}
      .span2{grid-column:span 1}
      table{min-width:1240px}
    }
    .inline2{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end}
    @media (max-width:520px){
      .inline2{ grid-template-columns: 1fr; }
      .mHead,.pHead,.loginHead{ grid-template-columns: 1fr auto; }
      .mTitle,.pTitle,.loginTitle{ grid-column:1; justify-self:start; }
      .mHead .btn,.pHead .btn,.loginHead .btn{ grid-column:2; }
    }

    .miniHint{font-size:12px; line-height:1.6; font-weight:700; color: rgba(0,0,0,.55); text-align:center;}
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px; padding:10px 14px;
      border-radius:999px; border:1px solid var(--border2);
      background: rgba(255,255,255,.96); color: rgba(0,0,0,.84);
      font-size:14px; box-shadow: 0 18px 50px rgba(0,0,0,.20);
      display:none; z-index:200; font-weight:800; letter-spacing:.06em;
    }
    .loginErr{
      margin-top:10px; color:rgba(170,60,60,.95);
      font-size:14px; line-height:1.6; display:none; white-space:pre-wrap;
      font-weight:900; text-align:center;
    }
    .loginHint{ margin-top:10px; color: rgba(0,0,0,.60); font-size:12.5px; line-height:1.7; font-weight:700; text-align:center; }

    body.readMode #tbl{ display:none; }
    body.readMode #cards{ display:block !important; padding:10px 6px; }
    body:not(.readMode) #tbl{ display:table; }
    body:not(.readMode) #cards{ display:none !important; }

    #cards{display:none; overflow:auto; max-height:100%; -webkit-overflow-scrolling: touch;}
    .noteCard{
      border-radius:16px; border:1px solid var(--border2);
      background: rgba(255,255,255,.96);
      box-shadow: 0 14px 26px rgba(0,0,0,.10);
      padding:12px; margin:10px 4px;
      color: rgba(0,0,0,.86); cursor:pointer;
    }
    .noteCard.sel{ outline: 2px solid rgba(0,0,0,.18); box-shadow: 0 18px 34px rgba(0,0,0,.12); }
    .noteHead{ display:flex; gap:10px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
    .noteMeta{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; font-weight:900; letter-spacing:.04em; }
    .noteTag{
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(0,0,0,.14);
      background: rgba(0,0,0,.03);
      color: rgba(0,0,0,.78);
      font-size:13px; white-space:nowrap;
    }
    .noteNo{ font-family:"Noto Serif TC","Noto Sans TC",serif; font-weight:900; letter-spacing:.06em; color: rgba(0,0,0,.88); white-space:nowrap; }
    .noteBody{
      margin-top:10px; line-height:1.85;
      font-size: var(--readBody);
      white-space:pre-wrap; word-break:break-word;
      color: rgba(0,0,0,.86);
    }
    .noteCard:not(.open) .noteBody{
      display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;
    }
    .noteMore{ margin-top:10px; display:none; opacity:.92; }
    .noteCard.open .noteMore{ display:block; }

    @media (max-width:720px){
      :root{
        /* 手機維持原本緊湊邊距 */
        --stageSide: 10px;
        --titleSize: clamp(20px, 5.0vw, 28px);
        --subSize: clamp(11px, 3.2vw, 13px);
        --btnFont: 14px;
        --btnFontSmall: 13px;
      }
      .wrap{ height:100dvh; padding:10px 10px 12px; gap:10px; }
      .topbar{ padding:10px; gap:10px; }
      .brand{ gap:4px; }
      .pill{ padding:6px 9px; font-size:12.5px; box-shadow: 0 10px 18px rgba(0,0,0,.08); }
      .right{ gap:8px; }
      .btn{ padding:9px 12px; box-shadow: 0 10px 16px rgba(0,0,0,.10); }
      .small{ padding:8px 10px; }
      .panel{ padding:10px; }
      .panelHead{ gap:8px; position:sticky; top:0; z-index:6; background: transparent; }
      .controls{ gap:8px; }
      input,select,textarea{ padding:10px 11px; border-radius:12px; }
      .hint{ justify-content:flex-start; flex-wrap:nowrap; overflow:auto; -webkit-overflow-scrolling: touch; padding:7px 8px; gap:7px; }
      .hint .hb{ flex:0 0 auto; padding:5px 9px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="nav-left">
        <div class="nav-desktop">
          <button class="btn ghost small" id="navBack"><span class="t">返回汐東工程管理表</span></button>
        </div>

        <div class="nav-mobile">
          <button class="btn ghost small" id="mBack"><span class="t">返回</span></button>
          <div style="position:relative; display:inline-flex;">
            <button class="btn ghost small" id="mMoreBtn" type="button"><span class="t">更多 ▾</span></button>
            <div id="mMoreMenu" style="display:none; position:absolute; top:calc(100% + 8px); right:0; min-width:220px; border-radius:16px; border:1px solid rgba(0,0,0,.20); background:rgba(255,255,255,.98); box-shadow:0 18px 50px rgba(0,0,0,.20); padding:8px; z-index:60;">
              <button class="menuItem" data-href="汐東工程管理表.html" type="button" style="width:100%; text-align:left; border:none; background:rgba(0,0,0,.03); color:rgba(0,0,0,.86); padding:10px 12px; border-radius:12px; cursor:pointer; font-family:inherit; letter-spacing:.04em; font-weight:800;">汐東工程管理表</button>
              <div style="height:1px; margin:8px 6px; background:rgba(0,0,0,.10);"></div>
              <button class="menuItem" data-href="index.html" type="button" style="width:100%; text-align:left; border:none; background:rgba(0,0,0,.03); color:rgba(0,0,0,.86); padding:10px 12px; border-radius:12px; cursor:pointer; font-family:inherit; letter-spacing:.04em; font-weight:800;">返回首頁</button>
            </div>
          </div>
        </div>
      </div>

      <div class="brand">
        <div class="title goldCrystal">捷運汐東線事項記錄</div>
        <div class="sub">記事內容 · 工種 · 系統 · 出處 · 附件 · 登錄日期</div>
      </div>

      <div class="right">
        <div class="pill">使用者：<b id="uName">—</b></div>
        <div class="pill">權限：<b id="uRole">—</b></div>

        <button class="btn small" id="btnView"><span class="t">檢視</span></button>
        <button class="btn small" id="btnAdd" style="display:none;"><span class="t">新增</span></button>
        <button class="btn small" id="btnEdit" style="display:none;"><span class="t">編輯</span></button>
        <button class="btn small" id="btnToken" style="display:none;"><span class="t">雲端設定</span></button>
      </div>
    </div>

    <div class="panel">
      <div class="panelHead">
        <div class="controls">
          <div class="field">
            <div class="label">搜尋（記事內容）</div>
            <input id="qText" placeholder="可輸入關鍵字，例如：送審、會議、現勘..." />
          </div>

          <div class="field">
            <div class="label">工種</div>
            <select id="fTrade"><option value="">全部</option></select>
          </div>

          <div class="field">
            <div class="label">系統</div>
            <select id="fSys"><option value="">全部</option></select>
          </div>

          <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
            <button class="btn ghost" id="btnCloud" type="button"><span class="t">雲端檔案</span></button>
            <button class="btn ghost" id="btnExport" type="button"><span class="t">匯出備份</span></button>
            <button class="btn ghost" id="btnRead" type="button"><span class="t">閱讀模式：關</span></button>
            <button class="btn ghost" id="btnClear" type="button"><span class="t">清除條件</span></button>
          </div>
        </div>

        <div class="hint" id="hint"></div>
      </div>

      <div class="panelBody">
        <div class="tableWrap">
          <div id="cards" style="display:none; position:relative; z-index:2;"></div>

          <table id="tbl">
            <thead>
              <tr>
                <th style="width:90px;">項次</th>
                <th>記事內容</th>
                <th style="width:150px;">工種</th>
                <th style="width:150px;">系統</th>
                <th style="width:150px;">出處</th>
                <th style="width:160px;">附件</th>
                <th style="width:220px;">備註</th>
                <th style="width:140px;">登錄日期</th>
                <th style="width:160px;">操作</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- Edit/View Modal -->
  <div class="mask" id="mask">
    <div class="modal">
      <div class="mHead">
        <div></div>
        <div class="mTitle goldCrystal" id="mTitle">查看</div>
        <button class="btn ghost small" id="btnClose" type="button"><span class="t">關閉</span></button>
      </div>

      <div class="mBody">
        <div class="grid">
          <div class="field span2">
            <div class="label">記事內容</div>
            <textarea id="mText" placeholder="請輸入記事內容（可多行）..."></textarea>
          </div>

          <div class="field">
            <div class="label">工種（下拉；可新增選項）</div>
            <div class="inline2">
              <select id="mTradeSel"></select>
              <button class="btn ghost small" id="btnAddTrade" type="button"><span class="t">新增工種</span></button>
            </div>
            <div class="miniHint">選單來源：本頁資料不重複 + 工種字典。</div>
          </div>

          <div class="field">
            <div class="label">系統（下拉；可新增選項）</div>
            <div class="inline2">
              <select id="mSysSel"></select>
              <button class="btn ghost small" id="btnAddSys" type="button"><span class="t">新增系統</span></button>
            </div>
            <div class="miniHint">✅ 系統會依「工種」篩選；可輸入既有系統名稱來「綁定」到目前工種。</div>
          </div>

          <div class="field span2">
            <div class="label">出處（下拉；可新增）</div>
            <div class="inline2">
              <input id="mSourceSel" list="mSourceList" placeholder="可選擇或直接輸入出處..." />
              <datalist id="mSourceList"></datalist>
              <button class="btn ghost small" id="btnAddSource" type="button"><span class="t">新增出處</span></button>
            </div>
            <div class="miniHint">選單來源：本頁資料「出處」不重複 + 出處字典。</div>
          </div>

          <div class="field span2">
            <div class="label">附件（超連結）</div>
            <div class="inline2">
              <input id="mAttach" placeholder="貼上連結，例如：https://... / Dropbox 連結 / file:///..." />
              <button class="btn ghost small" id="btnNetDisk" type="button"><span class="t">網路硬碟</span></button>
            </div>
            <div class="miniHint">可留空；相對網址會自動帶 v。</div>
          </div>

          <div class="field span2">
            <div class="label">備註</div>
            <textarea id="mRemark" placeholder="可輸入備註（可多行）..."></textarea>
          </div>

          <div class="field">
            <div class="label">登錄日期（可改）</div>
            <input id="mDate" type="date" />
            <div class="miniHint">預設為今日；可用日曆修改。</div>
          </div>

          <div class="field">
            <div class="label">項次</div>
            <input id="mNo" disabled />
          </div>
        </div>
      </div>

      <div class="mFoot">
        <button class="btn danger" id="btnDelete" style="display:none;" type="button"><span class="t">刪除</span></button>
        <button class="btn ghost" id="btnCancel" type="button"><span class="t">取消</span></button>
        <button class="btn" id="btnSave" type="button"><span class="t">儲存</span></button>
      </div>
    </div>
  </div>

  <!-- Prompt：新增 工種/系統/出處 -->
  <div class="pMask" id="pMask">
    <div class="pModal">
      <div class="pHead">
        <div></div>
        <div class="pTitle goldCrystal" id="pTitle">新增</div>
        <button class="btn ghost small" id="pClose" type="button"><span class="t">關閉</span></button>
      </div>
      <div class="pBody">
        <div class="field">
          <div class="label" id="pLabel">請輸入</div>
          <input id="pInput" placeholder="例如：機電 / 土建 / ..."/>
          <div class="miniHint" id="pHint">新增後會加入「選單字典」，且系統會綁到目前工種。</div>
        </div>
      </div>
      <div class="pFoot">
        <button class="btn ghost" id="pCancel" type="button"><span class="t">取消</span></button>
        <button class="btn" id="pOk" type="button"><span class="t">確定新增</span></button>
      </div>
    </div>
  </div>

  <!-- 雲端設定（可用來覆蓋 apiBase / endpoints） -->
  <div class="loginMask" id="tokenMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="雲端設定">
      <div class="loginHead">
        <div></div>
        <div class="loginTitle goldCrystal" id="cloudCfgTitle">雲端設定（Worker API）</div>
        <button class="btn ghost small" id="tokenClose" type="button"><span class="t">關閉</span></button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label" id="cloudCfgLabel">貼上（可擇一）</div>
          <input id="tokenInput" type="password" placeholder="① Worker apiBase ② 或 JSON：{&quot;apiBase&quot;:&quot;...&quot;,&quot;endpoints&quot;:{...}}" autocomplete="off" />
        </div>
        <div class="loginErr" id="tokenErr"></div>
        <div class="loginHint" id="tokenHint">目前狀態：—</div>
        <div class="loginHint">
          ✅ 你也可以直接貼 <b>Worker apiBase</b>，例如：<b>https://tasun-worker.wutasun.workers.dev</b><br>
          ✅ 或貼 JSON：<b>{"apiBase":"...","endpoints":{"read":"/api/read","merge":"/api/merge"}}</b><br>
          （正式來源仍以 tasun-resources.json 為主；此框僅作為臨時覆蓋。）
        </div>
      </div>
      <div class="loginFoot">
        <button class="btn danger" id="tokenClear" type="button"><span class="t">清除</span></button>
        <button class="btn ghost" id="tokenToggle" type="button"><span class="t">顯示/隱藏</span></button>
        <button class="btn" id="tokenSave" type="button"><span class="t">儲存</span></button>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="loginMask" id="loginMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="登入">
      <div class="loginHead">
        <div></div>
        <div class="loginTitle goldCrystal">登入</div>
        <button class="btn ghost small" id="loginClose" type="button"><span class="t">關閉</span></button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label">帳號</div>
          <select id="loginUser" autocomplete="username"><option value="">請選擇帳號</option></select>
        </div>
        <div class="field" style="margin-top:10px;">
          <div class="label">密碼</div>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="請輸入密碼" />
        </div>
        <div class="loginErr" id="loginErr"></div>
        <div class="loginHint">登入帳密以「權限表.html」(localStorage: <b>tasunAuthTable_v1</b>) 為準。</div>
      </div>
      <div class="loginFoot">
        <button class="btn ghost" id="loginToAuth" type="button"><span class="t">前往權限表</span></button>
        <button class="btn" id="loginBtn" type="button"><span class="t">登入</span></button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
  (function(){
    "use strict";

    // ---------------------------
    // Constants / Keys
    // ---------------------------
    var PAGE_KEY = "sxdh-notes";
    var APP_VER = (window.TASUN_APP_VER||"").toString().trim() || "dev";
    var RESOURCES_URL = "tasun-resources.json";

    var DEFAULT_API_BASE = "https://tasun-worker.wutasun.workers.dev";
    var DEFAULT_ENDPOINTS = { health:"/health", read:"/api/read", merge:"/api/merge" };

    var AUTH_KEY = "tasunAuthTable_v1";
    var CURRENT_KEY = "tasunCurrentUser_v1";

    var DB_KEY = "tasunSxdhNotes_v1";
    var COUNTER_KEY = "tasunSxdhNotes_counter_v1";
    var READ_MODE_KEY  = "tasunSxdhNotes_readMode_v1";

    var TRADE_DICT_KEY = "tasunSxdhNotes_tradeDict_v1";
    var SYS_DICT_KEY   = "tasunSxdhNotes_sysDict_v1";
    var SOURCE_DICT_KEY = "tasunSxdhNotes_sourceDict_v1";
    var TRADE_SYS_MAP_KEY = "tasunSxdhNotes_tradeSysMap_v1";

    // Optional overrides
    var API_BASE_LS_KEY = "tasunApiBase_v1";
    var API_EP_LS_KEY   = "tasunApiEndpoints_v1__" + PAGE_KEY;

    // ---------------------------
    // DOM helpers
    // ---------------------------
    function $(id){ return document.getElementById(id); }
    function norm(s){ return (s===undefined||s===null) ? "" : String(s).trim(); }
    function safeJSON(raw){ try{ return JSON.parse(raw); }catch(e){ return null; } }
    function nowISO(){ return new Date().toISOString(); }
    function todayISO(){ return new Date().toISOString().slice(0,10); }
    function pad2(n){ return String(n).padStart(2,"0"); }
    function fmtClock(ts){ if(!ts) return ""; var d = new Date(ts); return pad2(d.getHours())+":"+pad2(d.getMinutes())+":"+pad2(d.getSeconds()); }
    function uuid(){ return "u" + Date.now().toString(16) + "_" + Math.random().toString(16).slice(2); }

    function toast(msg, ms){
      var t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._tm);
      var dur = Number(ms);
      if(!Number.isFinite(dur) || dur<=0) dur = 2600;
      toast._tm = setTimeout(function(){ t.style.display="none"; }, dur);
    }

    function escHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#39;");
    }

    function addV(url){
      if(!url) return url;
      if(url.startsWith("http://") || url.startsWith("https://")){
        try{ var u = new URL(url); u.searchParams.set("v", APP_VER); return u.toString(); }catch(e){ return url; }
      }
      return url + (url.indexOf("?")>=0 ? "&" : "?") + "v=" + encodeURIComponent(APP_VER);
    }

    // ---------------------------
    // Auth
    // ---------------------------
    function ensureAuthTable(){
      var t = safeJSON(localStorage.getItem(AUTH_KEY));
      if(!t || typeof t !== "object"){
        t = {
          users: [
            { user:"alex", pass:"alex", role:"admin", name:"alex" },
            { user:"tasun", pass:"tasun", role:"write", name:"tasun" },
            { user:"wu", pass:"wu", role:"read", name:"wu" }
          ],
          updatedAt: nowISO(),
          rev: "seed"
        };
        localStorage.setItem(AUTH_KEY, JSON.stringify(t));
      }
      if(!Array.isArray(t.users)) t.users = [];
      return t;
    }

    function getCurrentUser(){
      var cur = safeJSON(localStorage.getItem(CURRENT_KEY));
      if(cur && cur.user && cur.role) return cur;
      return null;
    }

    function setCurrentUser(u){
      if(!u) localStorage.removeItem(CURRENT_KEY);
      else localStorage.setItem(CURRENT_KEY, JSON.stringify(u));
    }

    function roleRank(role){
      if(role==="admin") return 3;
      if(role==="write") return 2;
      return 1;
    }

    // ---------------------------
    // Cloud config
    // ---------------------------
    function parseJsonLenient(raw){
      raw = (raw===undefined||raw===null) ? "" : String(raw);
      try{ return JSON.parse(raw); }catch(e){}
      try{
        var cleaned = raw.replace(/\/\*[\s\S]*?\*\//g, "").replace(/,\s*([}\]])/g, "$1");
        return JSON.parse(cleaned);
      }catch(e2){}
      return null;
    }

    function normalizeEndpoints(ep){
      ep = (ep && typeof ep==="object") ? ep : {};
      return {
        health: norm(ep.health || "/health") || "/health",
        read:   norm(ep.read   || "/api/read") || "/api/read",
        merge:  norm(ep.merge  || "/api/merge") || "/api/merge"
      };
    }

    function joinApiBase(base, path){
      base = norm(base).replace(/\/+$/,"");
      path = norm(path);
      if(!path) return base;
      if(/^https?:\/\//i.test(path)) return path;
      if(path.charAt(0)!="/") path = "/" + path;
      return base + path;
    }

    function isValidApiBase(v){
      v = norm(v);
      if(!v) return false;
      if(!/^https?:\/\//i.test(v)) return false;
      if(/YOUR-WORKER-DOMAIN/i.test(v)) return false;
      return true;
    }

    function getFileName(){
      try{
        var p = location.pathname || "";
        var fn = p.split("/").pop() || "";
        return decodeURIComponent(fn) || fn;
      }catch(e){ return (location.pathname||"").split("/").pop() || ""; }
    }

    var _cloudCfgCache = null;

    async function loadCloudCfg(){
      if(_cloudCfgCache) return _cloudCfgCache;

      // Start with defaults
      var cfg = { apiBase: DEFAULT_API_BASE, endpoints: Object.assign({}, DEFAULT_ENDPOINTS) };

      // 1) resources.json (best)
      try{
        var res = await fetch(addV(RESOURCES_URL), { cache:"no-store" });
        if(res && res.ok){
          var text = await res.text();
          var json = parseJsonLenient(text);
          if(json && json.resources && typeof json.resources==="object"){
            var fn = getFileName();
            var r = json.resources;
            var pick = r[fn] || r[PAGE_KEY] || r["*"] || null;
            if(pick){
              if(isValidApiBase(pick.apiBase)) cfg.apiBase = pick.apiBase;
              if(pick.endpoints) cfg.endpoints = normalizeEndpoints(pick.endpoints);
            }else{
              if(isValidApiBase(json.apiBase)) cfg.apiBase = json.apiBase;
              if(json.endpoints) cfg.endpoints = normalizeEndpoints(json.endpoints);
            }
          }
        }
      }catch(e){ /* ignore */ }

      // 2) local overrides (optional)
      var ob = norm(localStorage.getItem(API_BASE_LS_KEY));
      if(isValidApiBase(ob)) cfg.apiBase = ob;

      var oe = safeJSON(localStorage.getItem(API_EP_LS_KEY));
      if(oe) cfg.endpoints = normalizeEndpoints(Object.assign({}, cfg.endpoints, oe));

      _cloudCfgCache = cfg;
      return cfg;
    }

    // ---------------------------
    // Local data + dicts
    // ---------------------------
    function loadDb(){
      var arr = safeJSON(localStorage.getItem(DB_KEY));
      if(!Array.isArray(arr)) arr = [];
      var c = Number(localStorage.getItem(COUNTER_KEY)||"0");
      if(!Number.isFinite(c) || c<0) c = 0;
      return { db: arr, counter: c };
    }

    // 嘗試復原舊版本本機資料（不同 key / 舊備份格式），並合併回目前 db
    function recoverLegacyLocal(){
      // 以「內容特徵」找舊資料：任何 storage key 只要能解析出 {db:[{uid/text/trade/sys/...}], counter} 或直接是陣列，都納入合併
      function tryParsePayload(parsed){
        if(Array.isArray(parsed)){
          // 直接是資料列陣列
          return { db: parsed, counter: 0 };
        }
        if(parsed && typeof parsed==="object"){
          // 可能包在 payload/data/result
          var un = unwrap(parsed);
          if(Array.isArray(un.db) && un.db.length) return { db: un.db, counter: un.counter||0 };
          // 也可能就是 {records:[...]} 或 {rows:[...]} 等
          if(Array.isArray(parsed.records) && parsed.records.length) return { db: parsed.records, counter: Number(parsed.counter||0)||0 };
          if(Array.isArray(parsed.rows) && parsed.rows.length) return { db: parsed.rows, counter: Number(parsed.counter||0)||0 };
          if(Array.isArray(parsed.items) && parsed.items.length) return { db: parsed.items, counter: Number(parsed.counter||0)||0 };
        }
        return null;
      }

      function looksLikeRow(x){
        if(!x || typeof x!=="object") return false;
        // 允許舊欄名：content/note/body 也視作 text
        var hasUid = !!norm(x.uid || x.pk || x.key || x.uuid || "");
        var hasText = !!norm(x.text || x.content || x.note || x.body || x.msg || "");
        var hasMeta = !!norm(x.trade || x.kind || x.work || "") || !!norm(x.sys || x.system || "") || !!norm(x.date || x.createdAt || "");
        return (hasUid && hasText) || (hasText && hasMeta);
      }

      function normalizeLegacyRows(arr){
        var out = [];
        for(var i=0;i<(arr||[]).length;i++){
          var x = arr[i];
          if(!x || typeof x!=="object") continue;
          // map legacy fields
          var uid = norm(x.uid || x.pk || x.key || x.uuid || "");
          if(!uid) uid = uuid(); // fallback
          out.push({
            uid: uid,
            id: Number(x.id||x.no||0)||0,
            text: norm(x.text || x.content || x.note || x.body || x.msg || ""),
            trade: norm(x.trade || x.kind || x.work || ""),
            sys: norm(x.sys || x.system || ""),
            source: norm(x.source || x.from || x.origin || ""),
            attach: norm(x.attach || x.link || x.url || ""),
            remark: norm(x.remark || x.memo || ""),
            date: norm(x.date || (x.createdAt? String(x.createdAt).slice(0,10):"") || ""),
            updatedAt: norm(x.updatedAt || x.updated || x.modifiedAt || x.ts || ""),
            rev: norm(x.rev || x.version || ""),
            deleted: !!(x.deleted || x.isDeleted)
          });
        }
        return out;
      }

      function scanStorage(storage, storageName){
        var keys = [];
        try{
          for(var i=0;i<storage.length;i++){
            var k = storage.key(i);
            if(k) keys.push(k);
          }
        }catch(e){}
        var mergedAny = false;
        var localNow = { db: state.db, counter: state.counter };
        var matched = [];
        for(var j=0;j<keys.length;j++){
          var key = keys[j];
          if(key===DB_KEY || key===COUNTER_KEY || key===READ_MODE_KEY) continue;
          var raw = null;
          try{ raw = storage.getItem(key); }catch(e){ raw=null; }
          if(!raw || raw.length<2) continue;

          var parsed = safeJSON(raw);
          if(!parsed) continue;

          var pay = tryParsePayload(parsed);
          if(!pay || !Array.isArray(pay.db) || !pay.db.length) continue;

          // 檢查是否像是我們的資料列（至少 1 筆符合）
          var arr = pay.db;
          var ok = false;
          for(var k=0;k<Math.min(arr.length, 10);k++){
            if(looksLikeRow(arr[k])) { ok = true; break; }
          }
          if(!ok) continue;

          // normalize legacy
          var normed = normalizeLegacyRows(arr);
          if(!normed.length) continue;

          var merged = mergePayload({ db: normed, counter: pay.counter||0 }, localNow);
          localNow = { db: merged.db, counter: merged.counter };
          mergedAny = true;
          matched.push({ storage: storageName, key: key, rows: normed.length, bytes: raw.length });
        }

        if(mergedAny){
          state.db = localNow.db;
          state.counter = localNow.counter;
          saveLocal({ db: state.db, counter: state.counter });
          buildDictsFromDb();
        }
        return { mergedAny: mergedAny, matched: matched };
      }

      var res1 = scanStorage(localStorage, "localStorage");
      var res2 = scanStorage(sessionStorage, "sessionStorage");

      // expose last scan result for debugging
      state._legacyScan = { local: res1, session: res2, at: nowISO() };

      return !!(res1.mergedAny || res2.mergedAny);
    }


    function saveLocal(payload){
      localStorage.setItem(DB_KEY, JSON.stringify(payload.db||[]));
      localStorage.setItem(COUNTER_KEY, String(Number(payload.counter||0)||0));
    }

    function normalizeRow(x){
      if(!x || typeof x!=="object") return null;
      var r = Object.assign({}, x);

      // 兼容舊欄位命名：system/系統、trade/工種、text/記事內容... 等
      var pick = function(obj, keys){
        for(var i=0;i<keys.length;i++){
          var k = keys[i];
          if(obj && obj[k]!==undefined && obj[k]!==null && String(obj[k]).trim()!=="") return obj[k];
        }
        return "";
      };

      // uid / pk
      r.uid = norm(pick(r, ["uid","pk","_pk","uuid","_uid","user"])) || "";
      if(!r.uid) return null;

      // 顯示用 id（允許舊資料用「項次/序號」）
      var rawId = pick(r, ["id","_id","no","項次","序號"]);
      r.id = Number(rawId || 0);

      r.text = norm(pick(r, ["text","content","記事內容","事項內容","內容","記事"])) || "";
      r.trade = norm(pick(r, ["trade","工種","類別","工程","工別"])) || "";
      r.sys = norm(pick(r, ["sys","system","系統","系統項目","系統別"])) || "";
      r.source = norm(pick(r, ["source","src","出處","來源"])) || "";
      r.attach = norm(pick(r, ["attach","附件","file","files","附件連結"])) || "";
      r.remark = norm(pick(r, ["remark","備註","note","註記"])) || "";

      // 日期欄位兼容（仍以字串顯示）
      r.date = norm(pick(r, ["date","登錄日期","日期","createdAt","created_at"])) || "";
      r.updatedAt = norm(pick(r, ["updatedAt","updated_at","updateAt","ts","time"])) || "";
      r.rev = norm(pick(r, ["rev","_rev","version"])) || "";

      r.deleted = !!(r.deleted || r._deleted);
      return r;
    }

function getVisibleRows(){
      var q = norm($("qText").value).toLowerCase();
      var ft = norm($("fTrade").value);
      var fs = norm($("fSys").value);
      var rows = state.db
        .map(normalizeRow)
        .filter(Boolean)
        .filter(function(r){ return !r.deleted; });

      // sort by id asc
      rows.sort(function(a,b){ return (Number(a.id||0)-Number(b.id||0)) || (tsOf(a)-tsOf(b)); });

      if(q){
        rows = rows.filter(function(r){ return (r.text||"").toLowerCase().includes(q); });
      }
      if(ft){
        rows = rows.filter(function(r){ return r.trade===ft; });
      }
      if(fs){
        rows = rows.filter(function(r){ return r.sys===fs; });
      }
      return rows;
    }

    function displayNoOf(uid){
      uid = norm(uid);
      if(!uid) return 0;
      var rows = getVisibleRows();
      for(var i=0;i<rows.length;i++){
        if(rows[i] && rows[i].uid===uid) return i+1;
      }
      return 0;
    }


    function buildDictsFromDb(){
      var rows = state.db.map(normalizeRow).filter(Boolean).filter(function(r){ return !r.deleted; });
      var trades = new Set(loadDict(TRADE_DICT_KEY));
      var syss = new Set(loadDict(SYS_DICT_KEY));
      var sources = new Set(loadDict(SOURCE_DICT_KEY));

      var map = loadMap(); // trade -> [sys]
      for(var i=0;i<rows.length;i++){
        var r = rows[i];
        if(r.trade) trades.add(r.trade);
        if(r.sys) syss.add(r.sys);
        if(r.source) sources.add(r.source);
        if(r.trade && r.sys){
          map[r.trade] = map[r.trade] || [];
          if(!map[r.trade].includes(r.sys)) map[r.trade].push(r.sys);
        }
      }
      saveDict(TRADE_DICT_KEY, Array.from(trades).sort());
      saveDict(SYS_DICT_KEY, Array.from(syss).sort());
      saveDict(SOURCE_DICT_KEY, Array.from(sources).sort());
      saveMap(map);
    }

    // 修訂2：依工種取得系統清單（來源：工種-系統綁定表 + 本頁資料），並去重排序
    function collectSysForTrade(trade, dbArr){
      trade = norm(trade);
      var set = new Set();

      // 來源1：工種-系統綁定表（指定工種）
      var bound = (TRADE_SYS_MAP && trade && TRADE_SYS_MAP[trade]) ? TRADE_SYS_MAP[trade] : [];
      for(var i=0;i<bound.length;i++){ if(bound[i]) set.add(String(bound[i])); }

      // 來源2：本頁資料庫中該工種實際出現過的系統（補強：避免綁定表漏掉）
      var rows = (dbArr||[]).map(normalizeRow).filter(Boolean).filter(function(r){ return !r.deleted; });
      for(var j=0;j<rows.length;j++){
        if(rows[j].trade===trade && rows[j].sys) set.add(rows[j].sys);
      }

      return Array.from(set).sort();
    }







    // ---------------------------
    // Dict / Map helpers
    // ---------------------------
    function loadDict(key){
      var a = safeJSON(localStorage.getItem(key));
      return Array.isArray(a) ? a.filter(Boolean).map(function(x){return norm(x);}).filter(Boolean) : [];
    }
    function saveDict(key, arr){
      arr = Array.isArray(arr) ? arr.filter(Boolean).map(function(x){return norm(x);}).filter(Boolean) : [];
      // unique + sort
      var set = new Set(arr);
      localStorage.setItem(key, JSON.stringify(Array.from(set).sort()));
    }
    function loadMap(){
      var m = safeJSON(localStorage.getItem(TRADE_SYS_MAP_KEY));
      return (m && typeof m==="object") ? m : {};
    }
    function saveMap(m){
      if(!m || typeof m!=="object") m = {};
      // normalize arrays
      Object.keys(m).forEach(function(k){
        var a = m[k];
        if(!Array.isArray(a)) a = [];
        var set = new Set(a.map(function(x){return norm(x);}).filter(Boolean));
        m[k] = Array.from(set).sort();
      });
      localStorage.setItem(TRADE_SYS_MAP_KEY, JSON.stringify(m));
    }

    function unwrap(obj){
      if(!obj || typeof obj!=="object") return obj;
      return obj.payload ?? obj.data ?? obj.result ?? obj;
    }

    function tsOf(r){
      var t = norm(r && (r.updatedAt||r.ts||r.time||""));
      if(!t) return 0;
      var n = Date.parse(t);
      return Number.isFinite(n) ? n : 0;
    }

    // ---------------------------
    // State
    // ---------------------------
    var state = {
      db: [],
      counter: 0,
      user: null,
      role: "read",
      selectedUid: "",
      mode: "view",
      readMode: false,
      cloud: { ok:false, apiBase:"", endpoints:null, lastSyncAt:"", lastOkAt:"" },
      _legacyScan: null
    };

    // load map once (kept in memory + persisted on change)
    var TRADE_SYS_MAP = loadMap();

    // ---------------------------
    // Merge logic (cloud/local)
    // ---------------------------
    function ensureRowV1(r){
      r = normalizeRow(r);
      if(!r) return null;

      // mandatory fields per v1
      r.uid = norm(r.uid);
      if(!r.uid) return null;
      r.pk = r.uid; // internal convenience
      if(!r.updatedAt) r.updatedAt = nowISO();
      if(!r.rev) r.rev = "r" + Date.now().toString(16) + Math.random().toString(16).slice(2,6);
      r.deleted = !!r.deleted;

      // id is display only; keep numeric but not required
      if(!Number.isFinite(Number(r.id))) r.id = 0;

      // normalize date value (YYYY-MM-DD preferred)
      if(r.date && /^\d{4}-\d{2}-\d{2}/.test(r.date)===false){
        // accept ISO -> slice
        if(/^\d{4}-\d{2}-\d{2}T/.test(r.date)) r.date = r.date.slice(0,10);
      }
      return r;
    }

    function mergeTwo(a, b){
      // choose newer by updatedAt; tie -> keep non-empty fields of either
      var ta = tsOf(a), tb = tsOf(b);
      var newer = (tb>ta) ? b : a;
      var older = (newer===a) ? b : a;
      var out = Object.assign({}, older, newer);
      // ✅ 修訂：避免 newer 的空字串覆蓋舊資料（例如 sys 變空造成表格只剩 1 列有值）
      ["text","trade","sys","source","attach","remark","date"].forEach(function(k){
        if(!norm(newer && newer[k]) && norm(older && older[k])) out[k] = older[k];
      });

      // if either says deleted true and it's newer, keep deleted true
      out.deleted = !!newer.deleted;

      // keep essential fields
      out.uid = norm(out.uid || newer.uid || older.uid);
      out.updatedAt = norm(out.updatedAt) || nowISO();
      out.rev = norm(out.rev || newer.rev || older.rev) || ("r"+Date.now().toString(16));
      out.pk = out.uid;
      return out;
    }

    function mergePayload(remote, local){
      // payload: {db:[rows], counter}
      var ldb = (local && Array.isArray(local.db)) ? local.db : [];
      var rdb = (remote && Array.isArray(remote.db)) ? remote.db : [];

      var map = new Map();
      function put(x){
        var r = ensureRowV1(x);
        if(!r) return;
        var key = r.uid;
        if(!map.has(key)) map.set(key, r);
        else map.set(key, mergeTwo(map.get(key), r));
      }
      ldb.forEach(put);
      rdb.forEach(put);

      var outDb = Array.from(map.values());
      // keep stable order: by date desc then updatedAt desc, else uid
      outDb.sort(function(a,b){
        var da = norm(a.date), db = norm(b.date);
        if(da && db && da!==db) return db.localeCompare(da);
        var ta = tsOf(a), tb = tsOf(b);
        if(tb!==ta) return tb-ta;
        return norm(a.uid).localeCompare(norm(b.uid));
      });

      var lc = Number(local && local.counter || 0) || 0;
      var rc = Number(remote && remote.counter || 0) || 0;
      return { db: outDb, counter: Math.max(lc, rc) };
    }

    // ---------------------------
    // UI: filters and selects
    // ---------------------------
    function setOptions(el, arr, keepValue, opt){
      opt = opt || {};
      if(!el) return;
      var cur = keepValue ? norm(el.value) : "";
      var tag = (el.tagName||"").toUpperCase();

      // SELECT: rebuild <option>
      if(tag==="SELECT"){
        el.innerHTML = "";
        if(opt.includeAll){
          var op0 = document.createElement("option");
          op0.value = ""; op0.textContent = "全部";
          el.appendChild(op0);
        }
        (arr||[]).forEach(function(v){
          v = norm(v);
          if(!v) return;
          var op = document.createElement("option");
          op.value = v; op.textContent = v;
          el.appendChild(op);
        });
        if(opt.forceValue!==undefined) el.value = String(opt.forceValue);
        if(keepValue && cur && Array.from(el.options).some(function(o){return o.value===cur;})){
          el.value = cur;
        }
        return;
      }

      // INPUT + datalist: rebuild datalist options (keep input value as-is)
      var listId = el.getAttribute("list");
      var dl = listId ? $(listId) : null;
      if(dl){
        dl.innerHTML = "";
        (arr||[]).forEach(function(v){
          v = norm(v);
          if(!v) return;
          var op = document.createElement("option");
          op.value = v;
          dl.appendChild(op);
        });
      }
      if(keepValue && cur) el.value = cur;
    }

    function uniqueOf(arr){
      var set = new Set();
      (arr||[]).forEach(function(x){ x = norm(x); if(x) set.add(x); });
      return Array.from(set).sort();
    }

    function rebuildFilterOptions(){
      // build dicts first
      buildDictsFromDb();

      var rows = state.db.map(normalizeRow).filter(Boolean).filter(function(r){ return !r.deleted; });

      // ✅ 主頁「工種」篩選：只顯示目前資料表工種不重複
      var tradesTable = uniqueOf(rows.map(function(r){return r.trade;}));
      setOptions($("fTrade"), tradesTable, true, { includeAll:true });

      // ✅ 主頁「系統」篩選：依目前選取工種顯示不重複系統（工種-系統綁定表 + 本頁資料）
      var ft = norm($("fTrade").value);
      var sysList;
      if(ft){
        sysList = collectSysForTrade(ft, state.db);
      }else{
        // 無工種時：所有系統（字典 + 本頁資料）去重
        sysList = uniqueOf(rows.map(function(r){return r.sys;})).concat(loadDict(SYS_DICT_KEY));
        sysList = uniqueOf(sysList);
      }
      setOptions($("fSys"), sysList, true, { includeAll:true });

      // ✅「新增/編輯」視窗  工種：依字典不重複（若字典空，回退用表格不重複）
      var tradeDict = uniqueOf(loadDict(TRADE_DICT_KEY));
      if(!tradeDict.length) tradeDict = tradesTable.slice();
      setOptions($("mTradeSel"), tradeDict, true, { includeBlank:true });

      // ✅「新增/編輯」視窗  系統：依字典工種所屬不重複系統（工種-系統綁定表 + 本頁資料）
      var mTrade = norm($("mTradeSel").value);
      var mSysList = mTrade ? collectSysForTrade(mTrade, state.db) : uniqueOf(loadDict(SYS_DICT_KEY));
      setOptions($("mSysSel"), mSysList, true, { includeBlank:true });

      // ✅ 出處：字典 + 本頁資料去重；輸入框的 datalist 由 mSourceSel 來填
      var sources = uniqueOf(rows.map(function(r){return r.source;})).concat(loadDict(SOURCE_DICT_KEY));
      sources = uniqueOf(sources);
      setOptions($("mSourceSel"), sources, true, { includeBlank:true });
    }

    // when trade filter changes, system filter must be recomputed (修訂2), system filter must be recomputed (修訂2)
    function onTradeFilterChanged(){
      var ft = norm($("fTrade").value);
      var fsOld = norm($("fSys").value);

      var sysList;
      if(ft){
        sysList = collectSysForTrade(ft, state.db);
      }else{
        var rows = state.db.map(normalizeRow).filter(Boolean).filter(function(r){ return !r.deleted; });
        sysList = uniqueOf(rows.map(function(r){return r.sys;})).concat(loadDict(SYS_DICT_KEY));
        sysList = uniqueOf(sysList);
      }
      setOptions($("fSys"), sysList, false, { includeAll:true, forceValue:"" });
      if(fsOld && sysList.includes(fsOld)) $("fSys").value = fsOld;
      refresh();
    }

    // modal trade changed => update modal system options (修訂2)
    function onModalTradeChanged(){
      var t = norm($("mTradeSel").value);
      var curSys = norm($("mSysSel").value);
      var list = t ? collectSysForTrade(t, state.db) : uniqueOf(loadDict(SYS_DICT_KEY));
      setOptions($("mSysSel"), list, false, { includeBlank:true });
      if(curSys && list.includes(curSys)) $("mSysSel").value = curSys;
    }

    // ---------------------------
    // Render: table + cards
    // ---------------------------
    function attachCell(attach){
      attach = norm(attach);
      if(!attach) return document.createTextNode("—");
      var a = document.createElement("a");
      a.href = addV(attach);
      a.target="_blank";
      a.rel="noopener";
      a.textContent = "開啟";
      a.style.fontWeight="900";
      a.style.color="rgba(120,64,6,.96)";
      return a;
    }

    function mkBtn(text, onClick){
      var b = document.createElement("button");
      b.className="attBtn";
      b.type="button";
      var span = document.createElement("span");
      span.className="t";
      span.textContent = text;
      b.appendChild(span);
      b.addEventListener("click", onClick);
      return b;
    }

    function renderTable(rows){
      var tb = $("tbody");
      tb.innerHTML = "";
      for(var i=0;i<rows.length;i++){
        var r = rows[i];
        var tr = document.createElement("tr");
        if(r.uid===state.selectedUid) tr.classList.add("sel");

        var tdNo = document.createElement("td");
        tdNo.style.textAlign="center";
        tdNo.textContent = String(i+1); // 修訂3：依顯示列排序顯示項次
        tr.appendChild(tdNo);

        var tdText = document.createElement("td");
        tdText.textContent = r.text || "";
        tr.appendChild(tdText);

        var tdTrade = document.createElement("td");
        tdTrade.style.textAlign="center";
        tdTrade.textContent = r.trade || "";
        tr.appendChild(tdTrade);

        var tdSys = document.createElement("td");
        tdSys.style.textAlign="center";
        tdSys.textContent = r.sys || "";
        tr.appendChild(tdSys);

        var tdSrc = document.createElement("td");
        tdSrc.style.textAlign="center";
        tdSrc.textContent = r.source || "";
        tr.appendChild(tdSrc);

        var tdAtt = document.createElement("td");
        tdAtt.style.textAlign="center";
        tdAtt.appendChild(attachCell(r.attach));
        tr.appendChild(tdAtt);

        var tdRem = document.createElement("td");
        tdRem.textContent = r.remark || "";
        tr.appendChild(tdRem);

        var tdDate = document.createElement("td");
        tdDate.style.textAlign="center";
        tdDate.textContent = r.date || "";
        tr.appendChild(tdDate);

        var tdAct = document.createElement("td");
        tdAct.style.textAlign="center";
        tdAct.appendChild(mkBtn("選取", (function(uid){ return function(e){
          e.stopPropagation();
          selectRow(uid);
        };})(r.uid)));
        tr.appendChild(tdAct);

        tr.addEventListener("click", (function(uid){ return function(){
          selectRow(uid);
        };})(r.uid));

        tb.appendChild(tr);
      }
    }

    function renderCards(rows){
      var box = $("cards");
      box.innerHTML = "";
      for(var i=0;i<rows.length;i++){
        var r = rows[i];
        var card = document.createElement("div");
        card.className = "noteCard" + (r.uid===state.selectedUid ? " sel": "");
        card.dataset.uid = r.uid;

        var head = document.createElement("div");
        head.className = "noteHead";
        var meta = document.createElement("div");
        meta.className = "noteMeta";

        function tag(txt){
          var s=document.createElement("span");
          s.className="noteTag";
          s.textContent=txt;
          return s;
        }
        meta.appendChild(tag("項次 " + (i+1)));
        if(r.trade) meta.appendChild(tag(r.trade));
        if(r.sys) meta.appendChild(tag(r.sys));
        if(r.source) meta.appendChild(tag(r.source));
        if(r.date) meta.appendChild(tag(r.date));

        head.appendChild(meta);

        var btn = mkBtn("選取", (function(uid){ return function(e){ e.stopPropagation(); selectRow(uid); };})(r.uid));
        head.appendChild(btn);

        var body = document.createElement("div");
        body.className="noteBody";
        body.textContent = r.text || "";

        var more = document.createElement("div");
        more.className="noteMore miniHint";
        more.textContent = "點一下展開/收合內容";

        card.appendChild(head);
        card.appendChild(body);
        card.appendChild(more);

        card.addEventListener("click", function(){
          var uid = this.dataset.uid;
          selectRow(uid);
          this.classList.toggle("open");
        });

        box.appendChild(card);
      }
    }

    function refresh(){
      rebuildFilterOptions();
      var rows = getVisibleRows();

      renderTable(rows);
      renderCards(rows);

      // hint
      var cloudTxt = state.cloud.ok ? "已同步" : "未設定";
      var lastTxt = state.cloud.lastOkAt ? fmtClock(state.cloud.lastOkAt) : "—";
      var roleTxt = state.role==="admin" ? "admin" : (state.role==="write"?"可編輯":"唯讀");

      $("hint").innerHTML = "";
      function hb(k,v,bad){
        var s=document.createElement("span");
        s.className="hb"+(bad?" bad":"");
        s.innerHTML = '<span class="k">'+escHtml(k)+'</span><span class="v">'+escHtml(v)+'</span>';
        return s;
      }
      $("hint").appendChild(hb("版本", APP_VER));
      $("hint").appendChild(hb("筆數", String(rows.length) + " / " + String(state.db.map(normalizeRow).filter(Boolean).filter(function(r){return !r.deleted;}).length)));
      $("hint").appendChild(hb("選取", state.selectedUid ? "已選取" : "未選取", !state.selectedUid));
      $("hint").appendChild(hb("雲端", cloudTxt, !state.cloud.ok));
      $("hint").appendChild(hb("最後", lastTxt));
      $("hint").appendChild(hb("權限", roleTxt));
    }

    function selectRow(uid){
      uid = norm(uid);
      state.selectedUid = uid;
      refresh();
    }

    // ---------------------------
    // Modal logic
    // ---------------------------
    function openMask(mode){
      state.mode = mode;
      $("mask").style.display = "flex";
      $("mTitle").textContent = (mode==="add") ? "新增" : (mode==="edit" ? "編輯" : "查看");
      var canEdit = (state.role==="admin" || state.role==="write") && (mode!=="view");
      $("btnSave").style.display = canEdit ? "" : "none";
      $("btnDelete").style.display = (canEdit && mode!=="add") ? "" : "none";
      // lock inputs in view mode
      var ro = (mode==="view");
      ["mText","mAttach","mRemark","mDate"].forEach(function(id){ $(id).disabled = ro; });
      ["mTradeSel","mSysSel","mSourceSel"].forEach(function(id){ $(id).disabled = ro; });
      ["btnAddTrade","btnAddSys","btnAddSource","btnNetDisk"].forEach(function(id){ $(id).disabled = ro; });
    }

    function closeMask(){
      $("mask").style.display = "none";
    }

    function fillModal(row){
      row = row || {};
      $("mText").value = norm(row.text);
      $("mTradeSel").value = norm(row.trade);
      onModalTradeChanged();
      $("mSysSel").value = norm(row.sys);
      $("mSourceSel").value = norm(row.source);
      $("mAttach").value = norm(row.attach);
      $("mRemark").value = norm(row.remark);
      $("mDate").value = norm(row.date) || todayISO();
      $("mNo").value = row.uid ? String(displayNoOf(row.uid) || "") : "";
    }

    function currentRowByUid(uid){
      uid = norm(uid);
      if(!uid) return null;
      for(var i=0;i<state.db.length;i++){
        var r = ensureRowV1(state.db[i]);
        if(r && r.uid===uid) return r;
      }
      return null;
    }

    function openView(){
      if(!state.selectedUid){ toast("請先選取一筆"); return; }
      var r = currentRowByUid(state.selectedUid);
      if(!r){ toast("找不到資料"); return; }
      fillModal(r);
      openMask("view");
    }

    function openEdit(){
      if(!state.selectedUid){ toast("請先選取一筆"); return; }
      if(!(state.role==="admin" || state.role==="write")){ toast("目前權限不可編輯"); return; }
      var r = currentRowByUid(state.selectedUid);
      if(!r){ toast("找不到資料"); return; }
      fillModal(r);
      openMask("edit");
    }

    function openAdd(){
      if(!(state.role==="admin" || state.role==="write")){ toast("目前權限不可新增"); return; }
      state.selectedUid = "";
      fillModal({ date: todayISO() });
      openMask("add");
    }

    function modalToRow(existingUid){
      var uid = existingUid ? norm(existingUid) : uuid();
      var r = {
        uid: uid,
        id: 0, // display only
        text: norm($("mText").value),
        trade: norm($("mTradeSel").value),
        sys: norm($("mSysSel").value),
        source: norm($("mSourceSel").value),
        attach: norm($("mAttach").value),
        remark: norm($("mRemark").value),
        date: norm($("mDate").value) || todayISO(),
        updatedAt: nowISO(),
        rev: "r" + Date.now().toString(16) + Math.random().toString(16).slice(2,6),
        deleted: false
      };
      return ensureRowV1(r);
    }

    function upsertRow(row){
      var found = false;
      for(var i=0;i<state.db.length;i++){
        var r = ensureRowV1(state.db[i]);
        if(r && r.uid===row.uid){
          state.db[i] = mergeTwo(r, row);
          found = true;
          break;
        }
      }
      if(!found) state.db.push(row);
      saveLocal({ db: state.db, counter: state.counter });
      buildDictsFromDb();
      refresh();
    }

    function deleteRow(uid){
      uid = norm(uid);
      if(!uid) return;
      for(var i=0;i<state.db.length;i++){
        var r = ensureRowV1(state.db[i]);
        if(r && r.uid===uid){
          r.deleted = true;
          r.updatedAt = nowISO();
          r.rev = "r" + Date.now().toString(16) + Math.random().toString(16).slice(2,6);
          state.db[i] = r;
          break;
        }
      }
      saveLocal({ db: state.db, counter: state.counter });
      refresh();
    }

    // ---------------------------
    // Prompt modal (add trade/sys/source)
    // ---------------------------
    var promptMode = ""; // "trade" | "sys" | "source"
    function openPrompt(mode){
      promptMode = mode;
      $("pMask").style.display="flex";
      $("pInput").value="";
      if(mode==="trade"){
        $("pTitle").textContent="新增工種";
        $("pLabel").textContent="請輸入工種";
        $("pHint").textContent="新增後會加入「工種字典」。";
      }else if(mode==="sys"){
        $("pTitle").textContent="新增系統";
        $("pLabel").textContent="請輸入系統";
        $("pHint").textContent="新增後會加入「系統字典」，並綁定到目前工種。";
      }else{
        $("pTitle").textContent="新增出處";
        $("pLabel").textContent="請輸入出處";
        $("pHint").textContent="新增後會加入「出處字典」。";
      }
      setTimeout(function(){ $("pInput").focus(); }, 50);
    }
    function closePrompt(){ $("pMask").style.display="none"; promptMode=""; }

    function commitPrompt(){
      var val = norm($("pInput").value);
      if(!val){ toast("請輸入內容"); return; }

      if(promptMode==="trade"){
        var trades = uniqueOf(loadDict(TRADE_DICT_KEY).concat([val]));
        saveDict(TRADE_DICT_KEY, trades);
        rebuildFilterOptions();
        $("mTradeSel").value = val;
        onModalTradeChanged();
        toast("已新增工種");
      }else if(promptMode==="sys"){
        var syss = uniqueOf(loadDict(SYS_DICT_KEY).concat([val]));
        saveDict(SYS_DICT_KEY, syss);

        var t = norm($("mTradeSel").value);
        if(t){
          TRADE_SYS_MAP[t] = TRADE_SYS_MAP[t] || [];
          if(!TRADE_SYS_MAP[t].includes(val)) TRADE_SYS_MAP[t].push(val);
          saveMap(TRADE_SYS_MAP);
        }
        rebuildFilterOptions();
        $("mSysSel").value = val;
        toast("已新增系統並綁定");
      }else if(promptMode==="source"){
        var srcs = uniqueOf(loadDict(SOURCE_DICT_KEY).concat([val]));
        saveDict(SOURCE_DICT_KEY, srcs);
        rebuildFilterOptions();
        $("mSourceSel").value = val;
        toast("已新增出處");
      }
      closePrompt();
    }

    // ---------------------------
    // Cloud API
    // ---------------------------
    async function cloudHealth(){
      var cfg = await loadCloudCfg();
      state.cloud.apiBase = cfg.apiBase;
      state.cloud.endpoints = cfg.endpoints;

      try{
        var url = joinApiBase(cfg.apiBase, cfg.endpoints.health);
        var res = await fetch(addV(url), { cache:"no-store" });
        state.cloud.ok = !!(res && res.ok);
        if(state.cloud.ok) state.cloud.lastOkAt = Date.now();
      }catch(e){
        state.cloud.ok = false;
      }
      refresh();
      return state.cloud.ok;
    }

    function buildCloudEnvelope(payload){
      // Worker side commonly accepts JSON body; keep flexible
      return {
        pageKey: PAGE_KEY,
        resourceKey: "tasun-index-db",
        pk: "uid",
        client: { appVer: APP_VER, ua: navigator.userAgent, at: nowISO() },
        payload: payload
      };
    }

    async function cloudRead(){
      var cfg = await loadCloudCfg();
      var url = joinApiBase(cfg.apiBase, cfg.endpoints.read);
      var body = buildCloudEnvelope({ op:"read" });
      var res = await fetch(addV(url), {
        method:"POST",
        headers: { "content-type":"application/json" },
        body: JSON.stringify(body)
      });
      if(!res.ok) throw new Error("read failed");
      var json = await res.json();
      var un = unwrap(json);
      // accept shapes: {db:[...], counter}, {data:{db:[]}}, {payload:{db:[]}}
      var db = un && (un.db || (un.data && un.data.db) || (un.payload && un.payload.db) || un.rows) || [];
      var counter = un && (un.counter || (un.data && un.data.counter) || 0) || 0;
      if(!Array.isArray(db)) db = [];
      return { db: db, counter: Number(counter||0)||0 };
    }

    async function cloudMerge(localPayload){
      var cfg = await loadCloudCfg();
      var url = joinApiBase(cfg.apiBase, cfg.endpoints.merge);
      var body = buildCloudEnvelope({ op:"merge", db: localPayload.db, counter: localPayload.counter });
      var res = await fetch(addV(url), {
        method:"POST",
        headers: { "content-type":"application/json" },
        body: JSON.stringify(body)
      });
      if(!res.ok) throw new Error("merge failed");
      var json = await res.json();
      var un = unwrap(json);
      var db = un && (un.db || (un.data && un.data.db) || (un.payload && un.payload.db) || un.rows) || [];
      var counter = un && (un.counter || (un.data && un.data.counter) || 0) || 0;
      if(!Array.isArray(db)) db = [];
      return { db: db, counter: Number(counter||0)||0 };
    }

    async function syncFromCloud(){
      try{
        var ok = await cloudHealth();
        if(!ok){ toast("雲端未設定或不可用"); return; }

        var remote = await cloudRead();
        var merged = mergePayload(remote, { db: state.db, counter: state.counter });
        state.db = merged.db;
        state.counter = merged.counter;
        saveLocal({ db: state.db, counter: state.counter });
        state.cloud.lastSyncAt = Date.now();
        refresh();
        toast("已從雲端同步");
      }catch(e){
        console.error(e);
        toast("雲端同步失敗");
      }
    }

    async function syncToCloud(){
      try{
        var ok = await cloudHealth();
        if(!ok){ toast("雲端未設定或不可用"); return; }

        // ensure v1 shape before upload
        var clean = state.db.map(ensureRowV1).filter(Boolean);
        var payload = { db: clean, counter: state.counter };

        var remoteMerged = await cloudMerge(payload);
        var merged = mergePayload(remoteMerged, payload); // trust server, but keep merge safety
        state.db = merged.db;
        state.counter = merged.counter;
        saveLocal({ db: state.db, counter: state.counter });
        state.cloud.lastSyncAt = Date.now();
        refresh();
        toast("已上傳並同步");
      }catch(e){
        console.error(e);
        toast("雲端上傳失敗");
      }
    }

    // ---------------------------
    // Export / Import helpers (backup)
    // ---------------------------
    function downloadText(filename, text){
      var blob = new Blob([text], {type:"application/json;charset=utf-8"});
      var a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(function(){
        URL.revokeObjectURL(a.href);
        a.remove();
      }, 0);
    }

    function exportBackup(){
      var pack = {
        meta: { app:"Tasun sxdh-notes", ver: APP_VER, exportedAt: nowISO(), pageKey: PAGE_KEY },
        db: state.db.map(ensureRowV1).filter(Boolean),
        counter: state.counter,
        dicts: {
          trades: loadDict(TRADE_DICT_KEY),
          syss: loadDict(SYS_DICT_KEY),
          sources: loadDict(SOURCE_DICT_KEY),
          tradeSysMap: loadMap()
        }
      };
      downloadText("捷運汐東線事項記錄_backup_"+APP_VER+".json", JSON.stringify(pack, null, 2));
      toast("已匯出備份");
    }

    // ---------------------------
    // Read mode
    // ---------------------------
    function applyReadMode(on){
      state.readMode = !!on;
      document.body.classList.toggle("readMode", state.readMode);
      $("btnRead").querySelector(".t").textContent = "閱讀模式：" + (state.readMode ? "開" : "關");
      localStorage.setItem(READ_MODE_KEY, state.readMode ? "1" : "0");
      refresh();
    }

    // ---------------------------
    // Nav / menus
    // ---------------------------
    function navTo(href){
      href = norm(href);
      if(!href) return;
      location.href = addV(href);
    }

    function setupMobileMenu(){
      var btn = $("mMoreBtn");
      var menu = $("mMoreMenu");
      if(!btn || !menu) return;

      btn.addEventListener("click", function(e){
        e.stopPropagation();
        menu.style.display = (menu.style.display==="none" || !menu.style.display) ? "block" : "none";
      });
      document.addEventListener("click", function(){ menu.style.display="none"; });
      menu.querySelectorAll(".menuItem").forEach(function(it){
        it.addEventListener("click", function(){
          navTo(this.dataset.href);
        });
      });
    }

    // ---------------------------
    // Login
    // ---------------------------
    function openLogin(){
      $("loginMask").style.display="flex";
      $("loginErr").style.display="none";
      $("loginPass").value="";
      var auth = ensureAuthTable();
      var sel = $("loginUser");
      sel.innerHTML = '<option value="">請選擇帳號</option>';
      auth.users.forEach(function(u){
        var op = document.createElement("option");
        op.value = u.user;
        op.textContent = (u.name||u.user) + " ("+(u.role||"read")+")";
        sel.appendChild(op);
      });
    }
    function closeLogin(){ $("loginMask").style.display="none"; }

    function applyUser(u){
      state.user = u;
      state.role = u && u.role ? u.role : "read";
      $("uName").textContent = u && (u.name||u.user) ? (u.name||u.user) : "—";
      $("uRole").textContent = state.role || "—";

      var canWrite = (state.role==="admin" || state.role==="write");
      $("btnAdd").style.display = canWrite ? "" : "none";
      $("btnEdit").style.display = canWrite ? "" : "none";
      $("btnToken").style.display = (state.role==="admin") ? "" : "none";
      refresh();
    }

    function doLogin(){
      var user = norm($("loginUser").value);
      var pass = norm($("loginPass").value);
      if(!user || !pass){
        $("loginErr").style.display="block";
        $("loginErr").textContent="請選擇帳號並輸入密碼";
        return;
      }
      var auth = ensureAuthTable();
      var hit = auth.users.find(function(u){ return u.user===user && u.pass===pass; });
      if(!hit){
        $("loginErr").style.display="block";
        $("loginErr").textContent="帳號或密碼錯誤";
        return;
      }
      var cur = { user: hit.user, role: hit.role||"read", name: hit.name||hit.user, at: nowISO() };
      setCurrentUser(cur);
      applyUser(cur);
      closeLogin();
      toast("登入成功");
    }

    // ---------------------------
    // Cloud setting modal
    // ---------------------------
    function openToken(){
      $("tokenMask").style.display="flex";
      $("tokenErr").style.display="none";
      $("tokenInput").value = "";
      updateTokenHint();
    }
    function closeToken(){ $("tokenMask").style.display="none"; }

    async function updateTokenHint(){
      var cfg = await loadCloudCfg();
      var txt = (cfg && cfg.apiBase) ? cfg.apiBase : "—";
      $("tokenHint").textContent = "目前狀態：" + txt;
    }

    function saveToken(){
      var raw = norm($("tokenInput").value);
      if(!raw){
        $("tokenErr").style.display="block";
        $("tokenErr").textContent="請貼上 apiBase 或 JSON";
        return;
      }
      var js = parseJsonLenient(raw);
      if(js && typeof js==="object" && (js.apiBase || js.endpoints)){
        if(js.apiBase){
          if(!isValidApiBase(js.apiBase)){
            $("tokenErr").style.display="block";
            $("tokenErr").textContent="apiBase 格式不正確";
            return;
          }
          localStorage.setItem(API_BASE_LS_KEY, norm(js.apiBase));
        }
        if(js.endpoints){
          localStorage.setItem(API_EP_LS_KEY, JSON.stringify(normalizeEndpoints(js.endpoints)));
        }
      }else{
        if(!isValidApiBase(raw)){
          $("tokenErr").style.display="block";
          $("tokenErr").textContent="apiBase 格式不正確";
          return;
        }
        localStorage.setItem(API_BASE_LS_KEY, raw);
      }
      _cloudCfgCache = null;
      toast("已儲存雲端設定");
      updateTokenHint();
      cloudHealth();
    }

    function clearToken(){
      localStorage.removeItem(API_BASE_LS_KEY);
      localStorage.removeItem(API_EP_LS_KEY);
      _cloudCfgCache = null;
      toast("已清除雲端設定");
      updateTokenHint();
      cloudHealth();
    }

    function toggleTokenVis(){
      var inp = $("tokenInput");
      inp.type = (inp.type==="password") ? "text" : "password";
    }

    // ---------------------------
    // Wire events
    // ---------------------------
    function wire(){
      $("navBack").addEventListener("click", function(){ navTo("汐東工程管理表.html"); });
      $("mBack").addEventListener("click", function(){ navTo("汐東工程管理表.html"); });
      setupMobileMenu();

      $("btnView").addEventListener("click", openView);
      $("btnEdit").addEventListener("click", openEdit);
      $("btnAdd").addEventListener("click", openAdd);

      $("btnCloud").addEventListener("click", syncFromCloud);
      $("btnExport").addEventListener("click", exportBackup);
      $("btnClear").addEventListener("click", function(){
        $("qText").value="";
        $("fTrade").value="";
        $("fSys").value="";
        refresh();
      });

      $("qText").addEventListener("input", function(){ refresh(); });
      $("fTrade").addEventListener("change", onTradeFilterChanged);
      $("fSys").addEventListener("change", function(){ refresh(); });

      $("btnRead").addEventListener("click", function(){ applyReadMode(!state.readMode); });

      // modal buttons
      $("btnClose").addEventListener("click", closeMask);
      $("btnCancel").addEventListener("click", closeMask);

      $("mTradeSel").addEventListener("change", onModalTradeChanged);

      $("btnAddTrade").addEventListener("click", function(){ openPrompt("trade"); });
      $("btnAddSys").addEventListener("click", function(){ openPrompt("sys"); });
      $("btnAddSource").addEventListener("click", function(){ openPrompt("source"); });

      $("btnNetDisk").addEventListener("click", function(){
        if($("mAttach").value){ window.open(addV($("mAttach").value), "_blank", "noopener"); }
        else toast("請先貼上連結");
      });

      $("btnSave").addEventListener("click", async function(){
        if(state.mode==="view"){ closeMask(); return; }
        var existing = (state.mode==="edit") ? state.selectedUid : "";
        var row = modalToRow(existing);
        if(!row.text){ toast("請輸入記事內容"); return; }
        if(!row.trade){ toast("請選擇工種"); return; }
        // record trade-sys binding if both set
        if(row.trade && row.sys){
          TRADE_SYS_MAP[row.trade] = TRADE_SYS_MAP[row.trade] || [];
          if(!TRADE_SYS_MAP[row.trade].includes(row.sys)) TRADE_SYS_MAP[row.trade].push(row.sys);
          saveMap(TRADE_SYS_MAP);
        }
        upsertRow(row);
        state.selectedUid = row.uid;
        closeMask();
        // upload if cloud ok
        await syncToCloud();
      });

      $("btnDelete").addEventListener("click", async function(){
        if(!(state.role==="admin" || state.role==="write")){ toast("目前權限不可刪除"); return; }
        if(!state.selectedUid){ toast("請先選取一筆"); return; }
        if(!confirm("確定刪除？（可在雲端同步後仍保留刪除狀態）")) return;
        deleteRow(state.selectedUid);
        closeMask();
        await syncToCloud();
      });

      // prompt
      $("pClose").addEventListener("click", closePrompt);
      $("pCancel").addEventListener("click", closePrompt);
      $("pOk").addEventListener("click", commitPrompt);
      $("pInput").addEventListener("keydown", function(e){
        if(e.key==="Enter"){ e.preventDefault(); commitPrompt(); }
      });

      // token modal
      $("btnToken").addEventListener("click", openToken);
      $("tokenClose").addEventListener("click", closeToken);
      $("tokenSave").addEventListener("click", saveToken);
      $("tokenClear").addEventListener("click", clearToken);
      $("tokenToggle").addEventListener("click", toggleTokenVis);

      // login modal
      $("loginClose").addEventListener("click", closeLogin);
      $("loginBtn").addEventListener("click", doLogin);
      $("loginPass").addEventListener("keydown", function(e){ if(e.key==="Enter") doLogin(); });
      $("loginToAuth").addEventListener("click", function(){ navTo("權限表.html"); });
    }

    // ---------------------------
    // Boot
    // ---------------------------
    function boot(){
      // load local
      var p = loadDb();
      state.db = p.db;
      state.counter = p.counter;

      // recover old storages once
      recoverLegacyLocal();

      // read mode
      state.readMode = localStorage.getItem(READ_MODE_KEY)==="1";
      applyReadMode(state.readMode);

      // auth
      ensureAuthTable();
      var cur = getCurrentUser();
      if(cur) applyUser(cur);
      else applyUser({ user:"—", role:"read", name:"—" });

      wire();
      refresh();

      // best-effort cloud status (does not block)
      cloudHealth();

      // if not logged in, show login modal
      if(!cur) openLogin();
    }

    boot();
  })();
  </script>
</body>
</html>
