<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>捷運汐東線事項記錄 · Tasun</title>

  <link rel="icon" href="data:,">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- ✅ 全站版本：要與 tasun-version.json 一致 -->
  <script>window.TASUN_APP_VER="20260127_05";</script>

  <!-- ✅ 進站必鎖定最新版 ?v=APP_VER（舊書籤也會跳轉成最新；避免無限轉） -->
  <script>
  (function(){
    try{
      var APP = (window.TASUN_APP_VER||"").toString().trim();
      if(!APP) return;
      var u = new URL(location.href);
      var cur = (u.searchParams.get("v")||"").toString().trim();
      var KEY = "tasun_force_v_once__sxdh_notes__" + (cur||"none") + "_to_" + APP;
      if(cur !== APP && !sessionStorage.getItem(KEY)){
        sessionStorage.setItem(KEY, "1");
        u.searchParams.set("v", APP);
        location.replace(u.toString());
        return;
      }
    }catch(e){}
  })();
  </script>

  <!-- ✅ 共用等待方式（全站共用）：可 push(fn) 排隊、也保留 then(fn) 相容 -->
  <script>
  (function(){
    var APP = (window.TASUN_APP_VER||"").toString().trim();
    if(!APP) return;

    var WAIT = window.__TASUN_READY__;
    if(!WAIT || typeof WAIT !== "object"){
      var _q = [];
      var _ready = false;
      var _resolve = null;
      var _p = new Promise(function(res){ _resolve = res; });

      WAIT = {
        get ready(){ return _ready; },
        push: function(fn){
          if(typeof fn !== "function") return;
          if(_ready){
            try{ fn(); }catch(e){}
          }else{
            _q.push(fn);
          }
        },
        then: function(onFulfilled, onRejected){
          return _p.then(onFulfilled, onRejected);
        },
        flush: function(){
          if(_ready) return;
          _ready = true;
          try{ _resolve(true); }catch(e){}
          var list = _q.splice(0);
          for(var i=0;i<list.length;i++){
            try{ list[i](); }catch(e){}
          }
        }
      };

      window.__TASUN_READY__ = WAIT;
    }
    window.__TASUN_WAIT__ = WAIT;

    function addV(src){
      return src + (src.indexOf("?")>=0 ? "&" : "?") + "v=" + encodeURIComponent(APP);
    }
    function hasScript(id){
      return !!document.querySelector('script[data-tasun-id="'+id+'"]');
    }
    function loadOnce(id, src){
      return new Promise(function(resolve){
        if(hasScript(id)) return resolve(true);
        var s = document.createElement("script");
        s.src = src;
        s.async = false;
        s.setAttribute("data-tasun-id", id);
        s.onload  = function(){ resolve(true); };
        s.onerror = function(){ resolve(false); };
        document.head.appendChild(s);
      });
    }

    // ✅ core → boot → cloud-kit
    (async function(){
      try{
        if(!window.TasunCore) await loadOnce("tasun-core", addV("tasun-core.js"));
        await loadOnce("tasun-boot", addV("tasun-boot.js"));
        await loadOnce("tasun-cloud-kit", addV("tasun-cloud-kit.js"));
      }catch(e){}
      try{ if(!WAIT.ready) WAIT.flush(); }catch(e){}
    })();
  })();
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700;800;900&family=Noto+Serif+TC:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#aebfb9;
      --bg1:#93aca5;
      --bg2:#cbbf9c;
      --ink:#1f2422;

      /* ✅ 去霧化：把「乳白玻璃層」變清澈（少白、少霧） */
      --glassTop: rgba(255,255,255,.86);
      --glassMid: rgba(255,255,255,.44);
      --glassBot: rgba(255,255,255,.16);

      --stageTopA: rgba(255,252,245,.86);
      --stageTopB: rgba(240,214,160,.22);

      --stageBotA: rgba(250,255,253,.78);
      --stageBotB: rgba(190,235,225,.18);

      --r:18px;
      --shadow: 0 18px 50px rgba(32,26,18,.16);
      --shadow2: 0 10px 26px rgba(32,26,18,.10);

      /* ✅ 深黃金（更銳利、更穩描邊、更細陰影） */
      --goldHi: rgba(255,254,246,.98);
      --goldText: rgba(246,214,150,.98);
      --goldDeep: rgba(206,126,26,.98);

      --edge: rgba(62,34,10,.62);
      --edgeSoft: rgba(94,56,20,.44);
      --microShadow: rgba(0,0,0,.18);

      --focusA: rgba(40,22,8,.14);
      --focusB: rgba(40,22,8,.08);

      --border: rgba(132,84,18,.40);
      --border2: rgba(246,214,150,.58);

      /* ✅ 表格去霧化：底更實、更不透 */
      --tableBg1: rgba(44,76,70,.88);
      --tableBg2: rgba(26,52,48,.86);
      --tableLine: rgba(255,255,255,.18);

      --tableText: rgba(246,214,150,.98);
      --tableMuted: rgba(246,214,150,.68);

      --tableEdge: rgba(40,22,8,.44);
      --stageSide: 1cm;

      --titleSize: clamp(28px, 2.6vw, 42px);
      --subSize:   clamp(12.5px, 1.05vw, 15.5px);
      --labelSize: clamp(13.5px, 1.00vw, 15.5px);
      --ctrlSize:  clamp(13.5px, 1.05vw, 16px);
      --thSize:    clamp(15.5px, 1.15vw, 17.5px);
      --tdSize:    clamp(14.5px, 1.08vw, 16.5px);

      --readTitle: clamp(14.5px, 1.12vw, 17px);
      --readBody:  clamp(14.5px, 1.10vw, 17.5px);

      --wTitle: 820;
      --wStrong: 720;
      --wUI: 680;
      --wTable: 650;
      --wBtn: 680;

      --modalTitleSize: clamp(18px, 1.7vw, 24px);

      /* ✅ 按鍵描邊/亮膜縮小，避免洗字 */
      --btnStroke: .30px;
      --btnEdge: rgba(255,230,180,.22);
      --btnShadow: rgba(0,0,0,.22);

      --blurStage: 0px;
      --blurBtn:   0px;
      --blurCtrl:  0px;
      --blurTable: 0px;
    }

    @media (max-width: 520px){
      :root{ --stageSide: 12px; }
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    html{
      background:
        radial-gradient(1000px 560px at 50% 120px, rgba(203,191,156,.14), transparent 64%),
        radial-gradient(1200px 900px at 32% 36%, rgba(160,198,189,.16), transparent 68%),
        radial-gradient(1100px 820px at 76% 40%, rgba(145,180,170,.14), transparent 70%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    body{
      margin:0;
      color:var(--ink);
      font-family:"Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      background: inherit;
      overflow:hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }

    /* ✅ 標題黃水晶：減少黑覆蓋、改微細陰影與穩描邊 */
    .goldCrystal{
      color: var(--goldText);
      background:
        linear-gradient(180deg,
          var(--goldHi) 0%,
          rgba(255,246,224,.98) 18%,
          var(--goldText) 46%,
          rgba(226,156,54,.98) 78%,
          var(--goldHi) 100%);
      -webkit-background-clip:text;
      background-clip:text;
      text-shadow:
        0.40px 0 0 var(--edge),
        -0.40px 0 0 var(--edge),
        0 0.40px 0 var(--edge),
        0 -0.40px 0 var(--edge),
        0.50px 0.50px 0 var(--edgeSoft),
        -0.50px 0.50px 0 var(--edgeSoft),
        0.50px -0.50px 0 var(--edgeSoft),
        -0.50px -0.50px 0 var(--edgeSoft),
        0 1.2px 1.8px var(--microShadow),
        0 0 12px rgba(255,220,150,.07);
      filter: drop-shadow(0 1px 0 rgba(255,255,255,.05));
    }
    @supports (-webkit-background-clip:text) or (background-clip:text){
      .goldCrystal{
        color:transparent;
        -webkit-text-fill-color:transparent;
        -webkit-text-stroke: .44px rgba(80,45,10,.24);
      }
    }

    .goldCrystalModal{
      color: var(--goldText);
      background:
        linear-gradient(180deg,
          rgba(255,254,246,.99) 0%,
          rgba(255,248,228,.99) 18%,
          rgba(252,228,170,.99) 46%,
          rgba(235,168,64,.99) 78%,
          rgba(255,254,246,.99) 100%);
      -webkit-background-clip:text;
      background-clip:text;
      text-shadow:
        0.42px 0 0 rgba(40,22,8,.38),
        -0.42px 0 0 rgba(40,22,8,.38),
        0 0.42px 0 rgba(40,22,8,.38),
        0 -0.42px 0 rgba(40,22,8,.38),
        0 1.8px 2.4px rgba(0,0,0,.28),
        0 0 18px rgba(255,214,140,.10);
      filter: drop-shadow(0 1px 0 rgba(255,255,255,.05)) brightness(1.10);
    }
    @supports (-webkit-background-clip:text) or (background-clip:text){
      .goldCrystalModal{
        color:transparent;
        -webkit-text-fill-color:transparent;
        -webkit-text-stroke: .52px rgba(255,230,180,.18);
      }
    }

    .wrap{
      width: min(1720px, calc(100vw - (2 * var(--stageSide))));
      margin:0 auto;
      padding: 18px 16px 18px;
      height:100vh;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .topbar{
      position:relative;
      z-index:20;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      gap:12px;
      align-items:center;
      padding:16px 16px;
      border:1px solid var(--border);
      border-radius:var(--r);
      background:
        radial-gradient(120% 180% at 24% 10%, var(--stageTopA), transparent 60%),
        radial-gradient(160% 200% at 78% 12%, var(--stageTopB), transparent 70%),
        linear-gradient(180deg, var(--glassTop), var(--glassMid) 62%, var(--glassBot));
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }

    @media (max-width:920px){
      .topbar{ grid-template-columns:1fr; }
      .nav-left{ order:0; }
      .brand{ order:1; }
      .right{ order:2; justify-content:flex-start; }
    }

    .nav-left{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:flex-start;
      min-width:220px;
    }
    .nav-desktop{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .nav-mobile{ display:none; gap:10px; align-items:center; width:100%; }
    @media (max-width:600px){
      .nav-desktop{ display:none; }
      .nav-mobile{ display:flex; }
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:center;
      justify-content:center;
      text-align:center;
    }

    .title{
      font-family:"Noto Serif TC","Noto Sans TC",serif;
      font-weight:var(--wTitle);
      letter-spacing:.10em;
      font-size: var(--titleSize);
      line-height:1.12;
    }
    .sub{
      font-size: var(--subSize);
      color: rgba(120,86,28,.80);
      letter-spacing:.12em;
      font-weight:var(--wUI);
      text-align:center;
      text-shadow: 0 1px 0 rgba(255,255,255,.10);
    }

    .right{
      display:flex; gap:10px;
      align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
      min-width:220px;
    }
    @media (max-width:920px){ .right{ justify-content:flex-start; } }

    .pill{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(132,84,18,.24);
      background:linear-gradient(180deg, rgba(255,255,255,.38), rgba(255,255,255,.14));
      font-size:14px;
      color: rgba(120,86,28,.86);
      display:flex; gap:8px; align-items:center; white-space:nowrap;
      box-shadow: var(--shadow2);
      font-weight:var(--wUI);
      letter-spacing:.04em;
    }
    .pill b{ font-weight:var(--wStrong); }

    .btn{
      appearance:none;
      border:1px solid rgba(132,84,18,.24);
      background:
        radial-gradient(120% 220% at 18% 10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(160% 240% at 74% 90%, rgba(175,220,210,.07), transparent 70%),
        radial-gradient(150% 200% at 82% 18%, rgba(210,180,120,.05), transparent 66%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      padding:12px 16px;
      border-radius:999px;
      cursor:pointer;
      font-family:inherit;
      font-weight:var(--wBtn);
      letter-spacing:.06em;
      font-size: clamp(13.5px, 1.02vw, 15.5px);
      box-shadow:
        0 14px 26px rgba(32,26,18,.12),
        inset 0 1px 0 rgba(255,255,255,.26);
      transition:transform .12s ease, filter .12s ease, border-color .12s ease, box-shadow .12s ease;
      user-select:none;
      white-space:nowrap;
      color: var(--goldDeep);
    }
    .btn:hover{
      transform:translateY(-1px);
      filter:brightness(1.02);
      border-color: rgba(246,214,150,.46);
      box-shadow:
        0 16px 30px rgba(32,26,18,.14),
        inset 0 1px 0 rgba(255,255,255,.30);
    }
    .btn:active{transform:none; filter:brightness(.99)}
    .btn.ghost{
      background:
        radial-gradient(120% 220% at 20% 16%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border:1px solid rgba(132,84,18,.20);
    }
    .btn.danger{ border-color:rgba(170,60,60,.40); }
    .small{ padding:11px 16px; font-size:14px; border-radius:999px; letter-spacing:.05em }
    .btn[disabled]{opacity:.45; cursor:not-allowed; filter:none !important; transform:none !important;}

    .btn .t{
      color: var(--goldDeep);
      text-shadow: 0 1px 1.4px rgba(0,0,0,.18);
    }
    @supports (-webkit-background-clip:text) or (background-clip:text){
      .btn .t{
        color:transparent;
        background: linear-gradient(180deg,
          rgba(255,254,246,.98) 0%,
          rgba(255,246,224,.98) 18%,
          rgba(246,214,150,.98) 46%,
          rgba(226,156,54,.98) 78%,
          rgba(255,254,246,.98) 100%);
        -webkit-background-clip:text;
        background-clip:text;
        -webkit-text-fill-color:transparent;
        -webkit-text-stroke: var(--btnStroke) var(--btnEdge);
        text-shadow:
          0 1px 1.6px var(--btnShadow),
          0 0 10px rgba(255,220,150,.05);
        filter: drop-shadow(0 1px 0 rgba(255,255,255,.04));
      }
      .btn.small .t{
        -webkit-text-stroke: calc(var(--btnStroke) + .10px) rgba(255,230,180,.24);
        text-shadow: 0 1.2px 1.8px rgba(0,0,0,.22), 0 0 12px rgba(255,214,140,.06);
      }
    }

    .panel{
      border:1px solid var(--border);
      border-radius:var(--r);
      background:
        radial-gradient(120% 170% at 22% 14%, var(--stageBotA), transparent 64%),
        radial-gradient(160% 190% at 80% 22%, var(--stageBotB), transparent 72%),
        linear-gradient(180deg, rgba(255,255,255,.50), rgba(255,255,255,.22) 60%, rgba(255,255,255,.12));
      box-shadow: var(--shadow);
      padding:16px;
      overflow:hidden;
      position:relative;
      flex:1;
      display:flex;
      flex-direction:column;
      min-height:0;
      backdrop-filter:none;
      -webkit-backdrop-filter:none;
    }

    .panelHead{
      position:relative;
      z-index:2;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:0 0 auto;
    }

    .controls{
      display:grid;
      grid-template-columns: 1.3fr .9fr .9fr auto;
      gap:10px;
      align-items:end;
    }
    @media (max-width:920px){ .controls{grid-template-columns:1fr 1fr} }
    @media (max-width:520px){ .controls{grid-template-columns:1fr} }

    .field{display:flex; flex-direction:column; gap:7px}
    .label{
      font-size: var(--labelSize);
      letter-spacing:.10em;
      font-weight:var(--wUI);
      color: rgba(150,104,34,.88);
      text-align:center;
      text-shadow: 0 1px 0 rgba(255,255,255,.10);
    }

    input,select,textarea{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(132,84,18,.28);
      background: linear-gradient(180deg, rgba(10,14,13,.80), rgba(10,14,13,.64));
      color: var(--goldText);
      padding:12px 13px;
      font-family:"Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      font-size: var(--ctrlSize);
      font-weight:var(--wUI);
      outline:none;
      transition:border-color .12s ease, filter .12s ease, box-shadow .12s ease;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.08),
        0 10px 22px rgba(0,0,0,.10);
      text-shadow: 0 1px 1.2px rgba(0,0,0,.22);
      backdrop-filter:none;
      -webkit-backdrop-filter:none;
    }
    input:focus,select:focus,textarea:focus{
      border-color: rgba(246,214,150,.52);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.10),
        0 0 0 3px rgba(246,214,150,.12),
        0 12px 26px rgba(0,0,0,.14);
    }
    textarea{min-height:92px; resize:vertical;}
    input::placeholder{ color: rgba(246,214,150,.62); }
    select{ text-align:center; text-align-last:center; font-weight:800; }
    select option{
      background: rgba(12,14,13,.98);
      color: rgba(246,214,150,.98);
    }

    .hint{
      color: rgba(106,74,24,.92);
      font-size:14px;
      line-height:1.7;
      font-weight:var(--wUI);
      text-align:center;
      text-shadow: 0 1px 0 rgba(255,255,255,.10);
    }

    .panelBody{
      position:relative;
      z-index:2;
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
    }

    .tableWrap{
      position:relative;
      margin-top:4px;
      overflow:auto;
      border-radius:16px;
      border:1px solid rgba(246,214,150,.26);
      background: linear-gradient(180deg, rgba(10,14,13,.18), rgba(10,14,13,.10));
      box-shadow: var(--shadow2);
      flex:1;
      min-height:0;
      backdrop-filter:none;
      -webkit-backdrop-filter:none;
    }

    table{
      width:100%;
      border-collapse:collapse;
      min-width:1320px;
      background: linear-gradient(180deg, var(--tableBg1), var(--tableBg2));
      font-family:"DFKai-SB","BiauKai","標楷體","KaiTi","STKaiti","Kaiti TC","Noto Serif TC",serif;
    }

    thead th{
      position:sticky; top:0; z-index:3;
      padding:14px 12px;
      border-bottom:1px solid rgba(246,214,150,.30);
      white-space:nowrap;
      text-align:center;
      letter-spacing:.10em;
      font-size: var(--thSize);
      font-weight:var(--wStrong);
      color: rgba(255,242,210,.98);
      text-shadow: 0 .6px 0 rgba(255,255,255,.08), 0 1.6px 2.2px rgba(0,0,0,.18);
      background: linear-gradient(180deg, rgba(46,78,72,.88), rgba(22,44,40,.84));
    }

    tbody td{
      padding:14px 12px;
      border-bottom:1px solid var(--tableLine);
      vertical-align:top;
      font-size: var(--tdSize);
      color: var(--tableText);
      line-height:1.70;
      font-weight:var(--wTable);
      letter-spacing:.02em;
      text-shadow:
        0.30px 0 0 var(--tableEdge),
        -0.30px 0 0 var(--tableEdge),
        0 0.30px 0 var(--tableEdge),
        0 -0.30px 0 var(--tableEdge),
        0 1px 1.8px rgba(0,0,0,.18);
    }
    tbody td:nth-child(2),
    tbody td:nth-child(6){
      text-align: justify;
      text-justify: inter-ideograph;
      word-break: break-word;
    }

    tbody tr:nth-child(even) td{ background: rgba(255,255,255,.018); }
    tbody tr:nth-child(odd)  td{ background: rgba(0,0,0,.04); }
    tbody tr:hover td{ background: rgba(255,255,255,.055); }
    tbody tr.sel td{ background: rgba(246,214,150,.14); }

    .muted{ color: var(--tableMuted); opacity:.85; }

    .attBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(246,214,150,.28);
      background:
        radial-gradient(120% 220% at 20% 12%, rgba(255,255,255,.10), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      cursor:pointer;
      white-space:nowrap;
      box-shadow: 0 12px 22px rgba(0,0,0,.16), inset 0 1px 0 rgba(255,255,255,.20);
      font-weight:var(--wBtn);
    }
    .attBtn .t{
      color: var(--goldDeep);
      text-shadow: 0 1px 1.4px rgba(0,0,0,.18);
      letter-spacing:.05em;
      font-weight:900;
    }

    /* ===============================
       ✅ 閱讀模式（卡片）樣式
       =============================== */
    .cards{
      display:none;
      padding:12px;
      gap:12px;
      flex-direction:column;
    }
    body.readMode #tbl{ display:none; }
    body.readMode .cards{ display:flex; }

    .card{
      border-radius:16px;
      border:1px solid rgba(246,214,150,.26);
      background:
        radial-gradient(120% 220% at 18% 14%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(180deg, rgba(14,18,16,.84), rgba(10,14,13,.76));
      box-shadow: 0 16px 34px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.06);
      padding:12px 12px 10px;
      cursor:pointer;
      user-select:none;
      color: rgba(246,214,150,.94);
      position:relative;
      overflow:hidden;
    }
    .card:hover{ filter:brightness(1.02); }
    .card.sel{
      outline: 2px solid rgba(246,214,150,.38);
      outline-offset: 2px;
    }

    .cardTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .cardNo{
      font-weight:900;
      letter-spacing:.06em;
      color: rgba(255,242,210,.98);
      text-shadow: 0 1px 2px rgba(0,0,0,.22);
      white-space:nowrap;
      font-size: var(--readTitle);
    }
    .cardDate{
      opacity:.86;
      font-weight:800;
      letter-spacing:.06em;
      white-space:nowrap;
      font-size: 13.5px;
      color: rgba(246,214,150,.84);
    }

    .badges{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .badge{
      border:1px solid rgba(246,214,150,.22);
      background: rgba(255,255,255,.06);
      border-radius:999px;
      padding:6px 10px;
      font-weight:900;
      letter-spacing:.06em;
      font-size: 13px;
      color: rgba(246,214,150,.96);
      text-shadow: 0 1px 1.6px rgba(0,0,0,.20);
    }
    .badge.muted{ opacity:.70; }

    .cardSummary{
      margin-top:10px;
      line-height:1.75;
      font-size: var(--readBody);
      font-weight:800;
      letter-spacing:.02em;
      color: rgba(246,214,150,.96);
      text-shadow:
        0.30px 0 0 rgba(40,22,8,.38),
        -0.30px 0 0 rgba(40,22,8,.38),
        0 0.30px 0 rgba(40,22,8,.38),
        0 -0.30px 0 rgba(40,22,8,.38),
        0 1px 2px rgba(0,0,0,.18);
      display:-webkit-box;
      -webkit-box-orient:vertical;
      -webkit-line-clamp:3;
      overflow:hidden;
      word-break:break-word;
    }
    .card.expanded .cardSummary{
      -webkit-line-clamp: unset;
      display:block;
      overflow:visible;
    }

    .cardMore{
      margin-top:10px;
      display:none;
      gap:8px;
      flex-direction:column;
      border-top:1px dashed rgba(246,214,150,.18);
      padding-top:10px;
    }
    .card.expanded .cardMore{ display:flex; }

    .cardRow{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .cardKey{
      font-size:13px;
      letter-spacing:.10em;
      font-weight:900;
      opacity:.84;
      color: rgba(246,214,150,.82);
      white-space:nowrap;
    }
    .cardVal{
      flex:1;
      min-width: 220px;
      font-size: 14.5px;
      line-height:1.7;
      font-weight:800;
      color: rgba(246,214,150,.96);
      word-break:break-word;
      text-shadow: 0 1px 1.8px rgba(0,0,0,.18);
    }

    .cardActions{
      margin-top:10px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      cursor:default;
    }

    @media (max-width:520px){
      .cards{ padding:10px; }
      .cardActions{ justify-content:flex-start; }
      .cardVal{ min-width: 0; }
    }

    /* =============================== */

    .mask{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:100;
      background: radial-gradient(900px 560px at 50% 42%, rgba(0,0,0,.42), rgba(0,0,0,.68));
    }

    .modal{
      width:min(980px, 96vw);
      border-radius:22px;
      border:1px solid rgba(246,214,150,.26);
      background: linear-gradient(180deg, rgba(14,18,16,.92), rgba(10,14,13,.84));
      box-shadow:0 32px 110px rgba(0,0,0,.50);
      overflow:hidden;
      position:relative;
    }

    .mHead{
      padding:14px 16px;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap:10px;
      border-bottom:1px solid rgba(246,214,150,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      min-height:56px;
    }
    .mTitle{
      grid-column:2;
      justify-self:center;
      letter-spacing:.14em;
      font-family:"Noto Serif TC","Noto Sans TC",serif;
      font-size: var(--modalTitleSize);
      font-weight:900;
      white-space:nowrap;
    }
    .mHead .btn{ grid-column:3; justify-self:end; }

    .mBody{ padding:14px 16px 16px; color: rgba(243,227,194,.96); }
    .modal .label{ color: rgba(246,214,150,.94); text-shadow: 0 1px 0 rgba(0,0,0,.12); }

    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .span2{grid-column:span 2}
    @media (max-width:720px){
      .grid{grid-template-columns:1fr}
      .span2{grid-column:span 1}
      table{min-width:1200px}
    }

    .inline2{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end}
    @media (max-width:520px){
      .inline2{ grid-template-columns: 1fr; }
      .mHead{ grid-template-columns: 1fr auto; }
      .mTitle{ grid-column:1; justify-self:start; }
      .mHead .btn{ grid-column:2; }
    }

    .miniHint{font-size:12px; line-height:1.6; font-weight:var(--wUI); color: rgba(243,227,194,.72); text-align:center;}

    .mFoot{
      padding:14px 16px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      border-top:1px solid rgba(246,214,150,.12);
      flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.05));
    }

    .pMask{
      position:fixed; inset:0;
      background: radial-gradient(800px 520px at 50% 42%, rgba(0,0,0,.42), rgba(0,0,0,.68));
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:160;
    }
    .pModal{
      width:min(560px, 96vw);
      border-radius:20px;
      border:1px solid rgba(246,214,150,.24);
      background: linear-gradient(180deg, rgba(14,18,16,.92), rgba(10,14,13,.84));
      box-shadow:0 30px 90px rgba(0,0,0,.42);
      overflow:hidden;
    }
    .pHead{
      padding:12px 14px;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      border-bottom:1px solid rgba(246,214,150,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      min-height:52px;
    }
    .pTitle{
      grid-column:2;
      justify-self:center;
      letter-spacing:.14em;
      font-size: clamp(16px, 1.6vw, 22px);
      font-family:"Noto Serif TC","Noto Sans TC",serif;
      font-weight:900;
      white-space:nowrap;
    }
    .pHead .btn{ grid-column:3; justify-self:end; }
    .pBody{padding:14px;}
    .pFoot{
      padding:12px 14px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      border-top:1px solid rgba(246,214,150,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.05));
    }

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(246,214,150,.22);
      background:rgba(14,18,16,.72);
      color:rgba(246,214,150,.96);
      font-size:14px;
      box-shadow:0 18px 50px rgba(0,0,0,.30);
      display:none;
      z-index:200;
      font-weight:var(--wUI);
      letter-spacing:.06em;
      text-shadow: 0 1px 1.4px rgba(0,0,0,.18);
    }

    .loginMask{
      position:fixed; inset:0;
      background: radial-gradient(900px 560px at 50% 42%, rgba(0,0,0,.42), rgba(0,0,0,.68));
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:999;
    }
    .loginMask.show{display:flex;}
    .loginModal{
      width:min(520px, 96vw);
      border-radius:22px;
      border:1px solid rgba(246,214,150,.24);
      background: linear-gradient(180deg, rgba(14,18,16,.92), rgba(10,14,13,.84));
      box-shadow:0 30px 90px rgba(0,0,0,.42);
      overflow:hidden;
      position:relative;
    }
    .loginHead{
      padding:14px 16px;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      border-bottom:1px solid rgba(246,214,150,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      min-height:56px;
    }
    .loginTitle{
      grid-column:2;
      justify-self:center;
      font-weight:900; letter-spacing:.14em;
      font-family:"Noto Serif TC","Noto Sans TC",serif;
      font-size: clamp(16px, 1.6vw, 22px);
      white-space:nowrap;
    }
    .loginHead .btn{ grid-column:3; justify-self:end; }
    .loginBody{padding:14px 16px 10px;}
    .loginFoot{
      padding:12px 16px;
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      border-top:1px solid rgba(246,214,150,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.05));
    }
    .loginErr{
      margin-top:10px;
      color:rgba(255,145,145,.95);
      font-size:14px;
      line-height:1.6;
      display:none;
      white-space:pre-wrap;
      font-weight:900;
      text-align:center;
    }
    .loginHint{
      margin-top:10px;
      color: rgba(243,227,194,.78);
      font-size:12.5px;
      line-height:1.7;
      font-weight:var(--wUI);
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="nav-left">
        <div class="nav-desktop">
          <button class="btn ghost small" id="navBack"><span class="t">返回汐東工程管理表</span></button>
        </div>

        <div class="nav-mobile">
          <button class="btn ghost small" id="mBack"><span class="t">返回</span></button>
          <div class="moreWrap" style="position:relative; display:inline-flex;">
            <button class="btn ghost small" id="mMoreBtn" type="button"><span class="t">更多 ▾</span></button>
            <div class="moreMenu" id="mMoreMenu" style="display:none; position:absolute; top:calc(100% + 8px); right:0; min-width:220px; border-radius:16px; border:1px solid rgba(246,214,150,.26); background:linear-gradient(180deg, rgba(18,22,20,.88), rgba(16,20,18,.72)); box-shadow:0 18px 50px rgba(0,0,0,.32); padding:8px; z-index:60;">
              <button class="menuItem" data-href="汐東工程管理表.html" type="button" style="width:100%; text-align:left; border:none; background:rgba(255,255,255,.06); color:rgba(246,214,150,.94); padding:10px 12px; border-radius:12px; cursor:pointer; font-family:inherit; letter-spacing:.04em; font-weight:800;">汐東工程管理表</button>
              <div class="menuSep" style="height:1px; margin:8px 6px; background:rgba(255,255,255,.10);"></div>
              <button class="menuItem" data-href="index.html" type="button" style="width:100%; text-align:left; border:none; background:rgba(255,255,255,.06); color:rgba(246,214,150,.94); padding:10px 12px; border-radius:12px; cursor:pointer; font-family:inherit; letter-spacing:.04em; font-weight:800;">返回首頁</button>
            </div>
          </div>
        </div>
      </div>

      <div class="brand">
        <div class="title goldCrystal">捷運汐東線事項記錄</div>
        <div class="sub">記事內容 · 工種 · 系統 · 附件 · 登錄日期</div>
      </div>

      <div class="right">
        <div class="pill">使用者：<b id="uName">—</b></div>
        <div class="pill">權限：<b id="uRole">—</b></div>

        <button class="btn small" id="btnView"><span class="t">顯示畫面</span></button>
        <button class="btn small" id="btnAdd" style="display:none;"><span class="t">新增</span></button>
        <button class="btn small" id="btnEdit" style="display:none;"><span class="t">編輯</span></button>

        <!-- ✅ 新增：Dropbox Token 設定（僅 admin 顯示） -->
        <button class="btn small" id="btnToken" style="display:none;"><span class="t">設定Token</span></button>
      </div>
    </div>

    <div class="panel">
      <div class="panelHead">
        <div class="controls">
          <div class="field">
            <div class="label">搜尋（記事內容）</div>
            <input id="qText" placeholder="可輸入關鍵字，例如：送審、會議、現勘..." />
          </div>

          <div class="field">
            <div class="label">工種</div>
            <select id="fTrade"><option value="">全部</option></select>
          </div>

          <div class="field">
            <div class="label">系統</div>
            <select id="fSys"><option value="">全部</option></select>
          </div>

          <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
            <button class="btn ghost" id="btnCloud" type="button"><span class="t">雲端檔案</span></button>
            <button class="btn ghost" id="btnExport" type="button"><span class="t">匯出備份</span></button>
            <button class="btn ghost" id="btnRead"><span class="t">閱讀模式：關</span></button>
            <button class="btn ghost" id="btnClear"><span class="t">清除條件</span></button>
          </div>
        </div>

        <div class="hint" id="hint"></div>
      </div>

      <div class="panelBody">
        <div class="tableWrap">
          <!-- ✅ 卡片閱讀模式容器 -->
          <div id="cards" class="cards"></div>

          <table id="tbl">
            <thead>
              <tr>
                <th style="width:90px;">項次</th>
                <th>記事內容</th>
                <th style="width:150px;">工種</th>
                <th style="width:150px;">系統</th>
                <th style="width:160px;">附件</th>
                <th style="width:220px;">備註</th>
                <th style="width:140px;">登錄日期</th>
                <th style="width:140px;">操作</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit/View Modal -->
  <div class="mask" id="mask">
    <div class="modal">
      <div class="mHead">
        <div></div>
        <div class="mTitle goldCrystalModal" id="mTitle">查看</div>
        <button class="btn ghost small" id="btnClose"><span class="t">關閉</span></button>
      </div>

      <div class="mBody">
        <div class="grid">
          <div class="field span2">
            <div class="label">記事內容</div>
            <textarea id="mText" placeholder="請輸入記事內容（可多行）..."></textarea>
          </div>

          <div class="field">
            <div class="label">工種（下拉；可新增選項）</div>
            <div class="inline2">
              <select id="mTradeSel"></select>
              <button class="btn ghost small" id="btnAddTrade" type="button"><span class="t">新增工種</span></button>
            </div>
            <div class="miniHint">選單來源：本頁資料不重複 + 工種字典（可改）。</div>
          </div>

          <div class="field">
            <div class="label">系統（下拉；可新增選項）</div>
            <div class="inline2">
              <select id="mSysSel"></select>
              <button class="btn ghost small" id="btnAddSys" type="button"><span class="t">新增系統</span></button>
            </div>
            <div class="miniHint">✅ 系統會依「工種」篩選；可輸入既有系統名稱來「綁定」到目前工種。</div>
          </div>

          <div class="field span2">
            <div class="label">附件（超連結）</div>
            <input id="mAttach" placeholder="貼上連結，例如：https://... / Dropbox 連結 / file:///..." />
            <div class="miniHint">可留空。若是相對網址（同網站檔案），會自動帶 v 並可開啟。</div>
          </div>

          <div class="field span2">
            <div class="label">備註</div>
            <textarea id="mRemark" placeholder="可輸入備註（可多行）..."></textarea>
          </div>

          <div class="field">
            <div class="label">登錄日期（可改）</div>
            <input id="mDate" type="date" />
            <div class="miniHint">預設為今日；可用日曆修改。</div>
          </div>

          <div class="field">
            <div class="label">項次（固定：由小到大排序）</div>
            <input id="mNo" disabled />
          </div>
        </div>
      </div>

      <div class="mFoot">
        <button class="btn danger" id="btnDelete" style="display:none;"><span class="t">刪除</span></button>
        <button class="btn ghost" id="btnCancel"><span class="t">取消</span></button>
        <button class="btn" id="btnSave"><span class="t">儲存</span></button>
      </div>
    </div>
  </div>

  <!-- Prompt：新增 工種/系統 -->
  <div class="pMask" id="pMask">
    <div class="pModal">
      <div class="pHead">
        <div></div>
        <div class="pTitle goldCrystalModal" id="pTitle">新增</div>
        <button class="btn ghost small" id="pClose" type="button"><span class="t">關閉</span></button>
      </div>
      <div class="pBody">
        <div class="field">
          <div class="label" id="pLabel">請輸入</div>
          <input id="pInput" placeholder="例如：機電 / 土建 / ..."/>
          <div class="miniHint" id="pHint">新增後會加入「選單字典」，且系統會綁到目前工種。</div>
        </div>
      </div>
      <div class="pFoot">
        <button class="btn ghost" id="pCancel" type="button"><span class="t">取消</span></button>
        <button class="btn" id="pOk" type="button"><span class="t">確定新增</span></button>
      </div>
    </div>
  </div>

  <!-- ✅ Token 設定（沿用 loginMask 風格） -->
  <div class="loginMask" id="tokenMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="Dropbox Token">
      <div class="loginHead">
        <div></div>
        <div class="loginTitle goldCrystalModal">Dropbox Token</div>
        <button class="btn ghost small" id="tokenClose" type="button"><span class="t">關閉</span></button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label">Access Token（貼上即可，不需含 Bearer）</div>
          <input id="tokenInput" type="password" placeholder="貼上 Dropbox Access Token" autocomplete="off" />
        </div>
        <div class="loginErr" id="tokenErr"></div>
        <div class="loginHint" id="tokenHint">目前狀態：—</div>
        <div class="loginHint">⚠️ Token 只儲存在本機瀏覽器 localStorage，不要貼到聊天視窗或公開地方。</div>
      </div>
      <div class="loginFoot">
        <button class="btn danger" id="tokenClear" type="button"><span class="t">清除</span></button>
        <button class="btn ghost" id="tokenToggle" type="button"><span class="t">顯示/隱藏</span></button>
        <button class="btn" id="tokenSave" type="button"><span class="t">儲存</span></button>
      </div>
    </div>
  </div>

  <!-- Login Modal（DOM 保留；登入邏輯由 tasun-core.js 的 TasunCore.Auth 接管） -->
  <div class="loginMask" id="loginMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="登入">
      <div class="loginHead">
        <div></div>
        <div class="loginTitle goldCrystal">登入</div>
        <button class="btn ghost small" id="loginClose" type="button"><span class="t">關閉</span></button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label">帳號</div>
          <select id="loginUser" autocomplete="username">
            <option value="">請選擇帳號</option>
          </select>
        </div>
        <div class="field" style="margin-top:10px;">
          <div class="label">密碼</div>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="請輸入密碼" />
        </div>
        <div class="loginErr" id="loginErr"></div>
        <div class="loginHint">
          登入帳密完全以「權限表.html」的權限表（localStorage: <b>tasunAuthTable_v1</b>）為準。
        </div>
      </div>
      <div class="loginFoot">
        <button class="btn ghost" id="loginToAuth" type="button"><span class="t">前往權限表</span></button>
        <button class="btn" id="loginBtn" type="button"><span class="t">登入</span></button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
  (function(){
    "use strict";

    function run(){
      var Core = window.TasunCore;
      if(!Core || !Core.Auth){
        console.error("TasunCore/Auth not ready.");
        return;
      }

      Core.init({
        pageKey: "sxdh-notes",
        forceUrlV: true,
        forceVersionSync: true,
        patchResources: true,
        networkToast: false,
        appHeightVar: false
      });

      var Auth = Core.Auth;
      var withV = Core.withV;

      // ===============================
      // ✅ Local keys
      // ===============================
      var DB_KEY      = "tasunSxdhNotes_v1";
      var COUNTER_KEY = "tasunSxdhNotes_counter_v1";

      var BACKUP_KEY  = DB_KEY + "__backup_v1";
      var BK1_KEY     = DB_KEY + "__backup_1";
      var BK2_KEY     = DB_KEY + "__backup_2";
      var BK3_KEY     = DB_KEY + "__backup_3";

      var EXPORT_LAST_KEY = DB_KEY + "__export_last_v1";
      var LEAVE_SNAP_KEY  = DB_KEY + "__leave_snapshot_v1";

      var SAFETY_SNAPSHOT_KEY = DB_KEY + "__safety_snapshot_v1";
      var PROTECT_EMPTY_REMOTE_KEY = "tasun_protect_empty_remote__" + DB_KEY;

      var LEGACY_DB_KEYS = [
        "tasunSxdhNotes_v1","tasunSxdhNotes_v0","tasunSxdhNotes",
        "tasunXidongNotes_v1","tasunXidongNotes_v0","tasunXidongNotes",
        "tasunNotes_sxdh_v1","tasunNotes_xidong_v1"
      ];
      var LEGACY_COUNTER_KEYS = [
        COUNTER_KEY,
        "tasunSxdhNotes_counter_v0",
        "tasunXidongNotes_counter_v1","tasunXidongNotes_counter_v0",
        "tasunNotes_sxdh_counter_v1","tasunNotes_xidong_counter_v1"
      ];

      var TRADE_DICT_KEY = "tasunSxdhNotes_tradeDict_v1";
      var SYS_DICT_KEY   = "tasunSxdhNotes_sysDict_v1";
      var TRADE_SYS_MAP_KEY = "tasunSxdhNotes_tradeSysMap_v1";
      var READ_MODE_KEY  = "tasunSxdhNotes_readMode_v1";

      var CLOUD_URL = "https://www.dropbox.com/scl/fo/glb4s65934h195bxuyuqm/AH5ClZ2u4MtPMvmgtfOUAa4?rlkey=tfxkpbpw8k9bctshx5xvuge8h&st=guo88r98&dl=0";

      var DROPBOX_TOKEN_KEY = "tasunDropboxToken_v1";

      // ===============================
      // ✅ Cloud resource binding
      // ===============================
      var CLOUD_RESOURCE_KEY = "sxdh-notes";
      var CLOUD_PK = "k";
      var SETTINGS_UID = "__settings__";

      var db = [];
      var editingUid = null;
      var selectedUid = null;
      var promptMode = null;

      // ✅ 閱讀模式展開狀態（只在本頁記憶）
      var expandedSet = new Set();

      var cloud = null;
      var cloudInited = false;

      var $ = function(id){ return document.getElementById(id); };
      var norm = function(s){ return (s===undefined||s===null) ? "" : String(s).trim(); };

      function uuid(){
        var a = Math.random().toString(16).slice(2);
        return "u" + Date.now().toString(16) + "_" + a;
      }

      function toast(msg){
        var t = $("toast");
        t.textContent = msg;
        t.style.display = "block";
        clearTimeout(toast._tm);
        toast._tm = setTimeout(function(){ t.style.display = "none"; }, 2600);
      }

      function escHtml(s){
        return (s ?? "").toString()
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#39;");
      }

      function fnv1a(str2){
        var h = 0x811c9dc5;
        for(var i=0;i<str2.length;i++){
          h ^= str2.charCodeAt(i);
          h = Math.imul(h, 0x01000193);
        }
        return (h >>> 0).toString(16).padStart(8, "0");
      }

      function safeParseJSON(raw){
        if(!raw) return null;
        try{ return JSON.parse(raw); }catch(e){ return null; }
      }

      function rotateBackups(snapshotArr){
        var snap = { ts: Date.now(), db: snapshotArr };
        try{
          var b1 = localStorage.getItem(BK1_KEY);
          var b2 = localStorage.getItem(BK2_KEY);
          if(b2) localStorage.setItem(BK3_KEY, b2);
          if(b1) localStorage.setItem(BK2_KEY, b1);
          localStorage.setItem(BK1_KEY, JSON.stringify(snap));
          localStorage.setItem(BACKUP_KEY, JSON.stringify(snap));
        }catch(e){}
      }

      function getSafetySnapshotDb(){
        try{
          var obj = safeParseJSON(localStorage.getItem(SAFETY_SNAPSHOT_KEY));
          if(obj && typeof obj === "object" && Array.isArray(obj.db) && obj.db.length>0) return obj.db;
        }catch(e){}
        return null;
      }

      function saveSafetySnapshot(reason){
        try{
          if(!Array.isArray(db) || db.length===0) return;
          var cur = safeParseJSON(localStorage.getItem(SAFETY_SNAPSHOT_KEY));
          var curLen = (cur && Array.isArray(cur.db)) ? cur.db.length : 0;
          if(db.length >= curLen){
            localStorage.setItem(SAFETY_SNAPSHOT_KEY, JSON.stringify({ ts: Date.now(), reason: reason||"", db: db }));
          }
        }catch(e){}
      }

      function restoreFromSafetySnapshot(quiet){
        quiet = !!quiet;
        var safeDb = getSafetySnapshotDb();
        if(!Array.isArray(safeDb) || safeDb.length===0) return false;
        db = safeDb.map(normalizeRow).filter(Boolean);
        if(db.length===0) return false;
        try{
          rotateBackups(db);
          localStorage.setItem(DB_KEY, JSON.stringify(db));
        }catch(e){}
        if(!quiet) toast("已由安全快照自動還原資料");
        return true;
      }

      function backupOnExit(reason){
        try{
          var snapDb = Array.isArray(db) ? db : [];
          if(snapDb.length===0){
            var safeDb = getSafetySnapshotDb();
            if(safeDb && safeDb.length>0){
              localStorage.setItem(LEAVE_SNAP_KEY, JSON.stringify({ ts: Date.now(), reason: reason || "exit", db: safeDb, note:"protected_empty_db" }));
              return;
            }
          }
          rotateBackups(snapDb);
          localStorage.setItem(LEAVE_SNAP_KEY, JSON.stringify({ ts: Date.now(), reason: reason || "exit", db: snapDb }));
        }catch(e){}
      }

      function go(href){
        backupOnExit("navigate");
        location.href = withV(href);
      }

      function openAttachment(href){
        var h = (href ?? "").toString().trim();
        if(!h) return;
        if(/^https?:\/\//i.test(h) || /^mailto:/i.test(h) || /^file:/i.test(h)){
          backupOnExit("open_attachment");
          window.open(h, "_blank", "noopener");
          return;
        }
        go(h);
      }

      window.addEventListener("beforeunload", function(){ backupOnExit("beforeunload"); });
      window.addEventListener("pagehide", function(){ backupOnExit("pagehide"); });
      document.addEventListener("visibilitychange", function(){
        if(document.visibilityState === "hidden") backupOnExit("visibility_hidden");
      });

      function normalizeRow(x){
        if(!x || typeof x !== "object") return null;

        if("v" in x && (x.k !== undefined || x.key !== undefined)){
          var inner = x.v;
          if(typeof inner === "string"){
            var p = safeParseJSON(inner);
            if(p && typeof p === "object") inner = p;
          }
          if(inner && typeof inner === "object"){
            x = Object.assign({}, inner, x);
            if(!x.uid) x.uid = x.k || x.key || "";
          }
        }

        var uid = norm(x.uid ?? x._uid ?? x.pk ?? x.k ?? x.key ?? "");
        var idRaw = (x.id ?? x.no ?? x.idx ?? x.key);
        var id = Number(idRaw);
        if(!Number.isFinite(id) || id <= 0) id = null;

        var text   = (x.text ?? x.content ?? x.note ?? x.memo ?? "").toString();
        var trade  = norm(x.trade ?? x.kind ?? x.type ?? x.work ?? "");
        var system = norm(x.system ?? x.sys ?? x.category ?? "");
        var attach = norm(x.attach ?? x.attachment ?? x.file ?? x.link ?? "");
        var remark = (x.remark ?? x.note2 ?? x.desc ?? "").toString();
        var date   = norm(x.date ?? x.day ?? x.created ?? x.createdAt ?? "");

        if(date){
          if(!/^\d{4}-\d{2}-\d{2}$/.test(date)){
            var d = new Date(date);
            if(!isNaN(d.getTime())) date = d.toISOString().slice(0,10);
            else date = "";
          }
        }

        if(!uid){
          if(id) uid = "legacy_" + String(id);
          else uid = uuid();
        }

        return { uid: uid, id: id, text: text, trade: trade, system: system, attach: attach, remark: remark, date: date };
      }

      function rowKey(r){
        var t = (r.text ?? "").toString().trim().replace(/\s+/g," ");
        var a = (r.attach ?? "").toString().trim();
        var rm = (r.remark ?? "").toString().trim().replace(/\s+/g," ");
        return fnv1a((r.date||"") + "|" + (r.trade||"") + "|" + (r.system||"") + "|" + t + "|" + a + "|" + rm);
      }

      function readBackupCandidates(){
        var keys = [BACKUP_KEY, BK1_KEY, BK2_KEY, BK3_KEY, SAFETY_SNAPSHOT_KEY];
        for(var i=0;i<keys.length;i++){
          var raw = localStorage.getItem(keys[i]);
          var obj = safeParseJSON(raw);
          if(obj && typeof obj === "object"){
            if(Array.isArray(obj.db)) return obj.db;
            if(Array.isArray(obj)) return obj;
          }
        }
        return null;
      }

      function mergeFromLegacyKeys(){
        var collected = [];
        for(var i=0;i<LEGACY_DB_KEYS.length;i++){
          var raw = localStorage.getItem(LEGACY_DB_KEYS[i]);
          var parsed = safeParseJSON(raw);
          if(!parsed) continue;
          var arr = Array.isArray(parsed) ? parsed : (Array.isArray(parsed.db) ? parsed.db : null);
          if(!Array.isArray(arr)) continue;
          collected.push.apply(collected, arr);
        }
        var backup = readBackupCandidates();
        if(Array.isArray(backup)) collected.push.apply(collected, backup);

        var normed = collected.map(normalizeRow).filter(Boolean);
        if(normed.length === 0) return { db: [], changed: false };

        var maxId = 0;
        for(var j=0;j<normed.length;j++){
          if(Number.isFinite(normed[j].id) && normed[j].id > maxId) maxId = normed[j].id;
        }
        for(var k=0;k<normed.length;k++){
          if(!normed[k].id){ maxId += 1; normed[k].id = maxId; }
          if(!normed[k].uid) normed[k].uid = "legacy_" + String(normed[k].id);
        }

        var seen = new Set();
        var uniq = [];
        for(var m=0;m<normed.length;m++){
          var key = rowKey(normed[m]);
          if(seen.has(key)) continue;
          seen.add(key);
          uniq.push(normed[m]);
        }
        uniq.sort(function(a,b){ return (a.id||0) - (b.id||0); });
        return { db: uniq, changed: true };
      }

      function loadCounterFromLegacy(){
        var best = 0;
        for(var i=0;i<LEGACY_COUNTER_KEYS.length;i++){
          var n = Number(localStorage.getItem(LEGACY_COUNTER_KEYS[i]) || "0");
          if(Number.isFinite(n) && n > best) best = n;
        }
        return best;
      }

      function ensureCounterAtLeast(n){
        var cur = Number(localStorage.getItem(COUNTER_KEY) || "0");
        var curOk = Number.isFinite(cur) ? cur : 0;
        var v = Math.max(curOk, n);
        localStorage.setItem(COUNTER_KEY, String(v));
      }

      function repairDBIfNeeded(){
        if(!Array.isArray(db)) db = [];
        var cleaned = [];
        var usedId = new Set();
        var maxId = 0;

        for(var i=0;i<db.length;i++){
          var r = normalizeRow(db[i]);
          if(!r) continue;
          if(!r.text || !r.text.toString().trim()) continue;
          if(Number.isFinite(r.id) && r.id > maxId) maxId = r.id;
          cleaned.push(r);
        }

        var needNewId = [];
        for(var j=0;j<cleaned.length;j++){
          if(!cleaned[j].id || usedId.has(cleaned[j].id)){
            needNewId.push(cleaned[j]);
            continue;
          }
          usedId.add(cleaned[j].id);
        }
        for(var k=0;k<needNewId.length;k++){
          maxId += 1;
          while(usedId.has(maxId)) maxId += 1;
          needNewId[k].id = maxId;
          usedId.add(maxId);
        }

        cleaned.sort(function(a,b){ return (a.id||0) - (b.id||0); });
        db = cleaned;

        try{
          if(db.length>0) saveSafetySnapshot("repair");
          if(db.length>0) rotateBackups(db);
          localStorage.setItem(DB_KEY, JSON.stringify(db));
          ensureCounterAtLeast(maxId);
        }catch(e){}
      }

      function loadDB(quiet){
        quiet = !!quiet;
        try{
          var raw = localStorage.getItem(DB_KEY);
          var parsed = safeParseJSON(raw);

          if(Array.isArray(parsed)){
            db = parsed.map(normalizeRow).filter(Boolean);
          }else if(parsed && Array.isArray(parsed.db)){
            db = parsed.db.map(normalizeRow).filter(Boolean);
          }else{
            db = [];
          }

          if(db.length === 0){
            var merged = mergeFromLegacyKeys();
            if(merged.db.length > 0){
              db = merged.db;
              if(db.length>0){
                saveSafetySnapshot("load_legacy_merge");
                rotateBackups(db);
              }
              localStorage.setItem(DB_KEY, JSON.stringify(db));
              if(!quiet) toast("已自動找回既有資料並合併到本頁");
            }else{
              var backup = readBackupCandidates();
              if(Array.isArray(backup) && backup.length>0){
                db = backup.map(normalizeRow).filter(Boolean);
                if(db.length>0){
                  saveSafetySnapshot("load_backup_restore");
                  rotateBackups(db);
                }
                localStorage.setItem(DB_KEY, JSON.stringify(db));
                if(!quiet) toast("主資料異常，已由備份自動還原");
              }else{
                restoreFromSafetySnapshot(quiet);
              }
            }
          }else{
            if(db.length>0){
              saveSafetySnapshot("load_ok");
              rotateBackups(db);
            }
          }
        }catch(e){
          db = [];
          var backup2 = readBackupCandidates();
          if(Array.isArray(backup2) && backup2.length>0){
            db = backup2.map(normalizeRow).filter(Boolean);
            if(db.length>0){
              saveSafetySnapshot("load_fail_restore");
              rotateBackups(db);
            }
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            if(!quiet) toast("主資料讀取失敗，已由備份自動還原");
          }else{
            restoreFromSafetySnapshot(quiet);
          }
        }

        var maxId = 0;
        for(var r=0;r<db.length;r++){
          if(Number.isFinite(db[r].id) && db[r].id > maxId) maxId = db[r].id;
        }
        var legacyCounter = loadCounterFromLegacy();
        ensureCounterAtLeast(Math.max(maxId, legacyCounter));

        repairDBIfNeeded();

        if(Array.isArray(db) && db.length===0){
          restoreFromSafetySnapshot(quiet);
        }
      }

      function saveDB(){
        try{
          if(Array.isArray(db) && db.length>0) saveSafetySnapshot("saveDB");
          rotateBackups(db);
          localStorage.setItem(DB_KEY, JSON.stringify(db));
        }catch(e){
          toast("儲存失敗：可能瀏覽器儲存空間不足");
        }
      }

      function getCounter(){
        var n = Number(localStorage.getItem(COUNTER_KEY) || "0");
        return Number.isFinite(n) ? n : 0;
      }
      function nextCounter(){
        var n = getCounter() + 1;
        localStorage.setItem(COUNTER_KEY, String(n));
        return n;
      }

      function loadDict(key){
        try{
          var raw = localStorage.getItem(key);
          var arr = raw ? JSON.parse(raw) : [];
          return Array.isArray(arr) ? arr.map(norm).filter(Boolean) : [];
        }catch(e){ return []; }
      }
      function saveDict(key, arr){ localStorage.setItem(key, JSON.stringify(arr)); }

      function ensureSeedDict(){
        if(!localStorage.getItem(TRADE_DICT_KEY)){
          saveDict(TRADE_DICT_KEY, ["土建","機電","水電","消防","裝修","其他"]);
        }
        if(!localStorage.getItem(SYS_DICT_KEY)){
          saveDict(SYS_DICT_KEY, ["電氣","給排水","消防","空調","弱電","土建","其他"]);
        }
        if(!localStorage.getItem(TRADE_SYS_MAP_KEY)){
          try{ localStorage.setItem(TRADE_SYS_MAP_KEY, JSON.stringify({})); }catch(e){}
        }
      }

      function loadTradeSysMap(){
        try{
          var raw = localStorage.getItem(TRADE_SYS_MAP_KEY);
          var obj = raw ? JSON.parse(raw) : {};
          return (obj && typeof obj === "object") ? obj : {};
        }catch(e){ return {}; }
      }
      function saveTradeSysMap(map){
        try{ localStorage.setItem(TRADE_SYS_MAP_KEY, JSON.stringify(map || {})); }catch(e){}
      }
      function addTradeSysLink(trade, system){
        trade = norm(trade); system = norm(system);
        if(!trade || !system) return;

        var map = loadTradeSysMap();
        if(!Array.isArray(map[trade])) map[trade] = [];
        var exists = map[trade].some(function(x){ return norm(x).toLowerCase() === system.toLowerCase(); });
        if(!exists) map[trade].push(system);
        map[trade].sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });
        saveTradeSysMap(map);
      }

      function systemsByTradeFromDB(trade){
        var t = norm(trade);
        var set = new Set();
        if(!t) return [];
        for(var i=0;i<db.length;i++){
          if(norm(db[i].trade) !== t) continue;
          var s = norm(db[i].system);
          if(s) set.add(s);
        }
        var arr = Array.from(set);
        arr.sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });
        return arr;
      }

      function systemsByTrade(trade){
        var t = norm(trade);
        if(!t) return [];
        var set = new Set();
        var map = loadTradeSysMap();
        if(Array.isArray(map[t])) map[t].forEach(function(x){
          x = norm(x); if(x) set.add(x);
        });
        systemsByTradeFromDB(t).forEach(function(x){ set.add(x); });
        var arr = Array.from(set);
        arr.sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });
        return arr;
      }

      // ===============================
      // ✅ Cloud payload helpers (略：維持原版本)
      // ===============================
      function exportDbWithSettings(){
        var rows = (Array.isArray(db)?db:[]).map(function(r){
          var uid = norm(r.uid) || (r.id ? "legacy_"+String(r.id) : uuid());
          return {
            id: Number(r.id||0),
            k: uid,
            v: {
              text: (r.text||""),
              trade: (r.trade||""),
              system: (r.system||""),
              attach: (r.attach||""),
              remark: (r.remark||""),
              date: (r.date||"")
            }
          };
        });

        rows.push({
          id: 0,
          k: SETTINGS_UID,
          v: {
            tradeDict: loadDict(TRADE_DICT_KEY),
            sysDict: loadDict(SYS_DICT_KEY),
            tradeSysMap: loadTradeSysMap()
          }
        });

        return rows;
      }

      function importPayload(payload, info){
        payload = (payload && typeof payload==="object") ? payload : {};
        var arr = Array.isArray(payload.db) ? payload.db : [];

        var beforeDb = Array.isArray(db) ? db.slice() : [];
        if(beforeDb.length>0){
          try{
            saveSafetySnapshot("before_cloud_apply");
            rotateBackups(beforeDb);
          }catch(e){}
        }

        var srow = null;
        for(var i=0;i<arr.length;i++){
          var it = arr[i];
          var kk = norm(it && (it.k ?? it.uid ?? it.key));
          if(kk === SETTINGS_UID){ srow = it; break; }
          if(norm(it && it.uid) === SETTINGS_UID){ srow = it; break; }
        }
        if(srow){
          var sv = (srow && typeof srow==="object") ? (srow.v || srow) : null;
          if(sv){
            if(Array.isArray(sv.tradeDict)) saveDict(TRADE_DICT_KEY, sv.tradeDict.map(norm).filter(Boolean));
            if(Array.isArray(sv.sysDict)) saveDict(SYS_DICT_KEY, sv.sysDict.map(norm).filter(Boolean));
            if(sv.tradeSysMap && typeof sv.tradeSysMap==="object") saveTradeSysMap(sv.tradeSysMap);
          }
        }

        var incoming = arr
          .filter(function(r){
            var kk2 = norm(r && (r.k ?? r.uid ?? r.key));
            return kk2 !== SETTINGS_UID;
          })
          .map(function(r){
            if(r && typeof r==="object" && ("v" in r) && (r.k!==undefined || r.key!==undefined)){
              var inner = r.v;
              if(typeof inner === "string"){
                var p = safeParseJSON(inner);
                if(p && typeof p==="object") inner = p;
              }
              if(inner && typeof inner==="object"){
                var obj = Object.assign({}, inner);
                obj.uid = norm(r.k ?? r.key ?? obj.uid ?? "");
                obj.id  = Number(r.id||obj.id||0);
                obj.text = obj.text ?? obj.content ?? obj.note ?? obj.memo ?? "";
                return obj;
              }
            }
            return r;
          })
          .map(normalizeRow)
          .filter(Boolean)
          .filter(function(r){ return r.text && r.text.toString().trim(); });

        var localCount = beforeDb.map(normalizeRow).filter(Boolean).filter(function(r){ return r.text && r.text.toString().trim(); }).length;
        var incomingCount = incoming.length;

        if(incomingCount === 0 && localCount > 0){
          try{
            if(!sessionStorage.getItem(PROTECT_EMPTY_REMOTE_KEY)){
              sessionStorage.setItem(PROTECT_EMPTY_REMOTE_KEY, "1");
              toast("⚠️ 雲端目前空白：已保護本機資料不覆寫，將嘗試推送合併到雲端…");
              if(cloud && Auth.canWrite()){
                setTimeout(function(){
                  if(!cloud) return;
                  cloud.ready.then(function(){ return cloud.saveMerged(); }).catch(function(){});
                }, 0);
              }
            }
          }catch(e){}
          return;
        }

        db = incoming;

        var maxId2 = 0;
        for(var j=0;j<db.length;j++){
          var n = Number(db[j].id||0);
          if(Number.isFinite(n) && n>maxId2) maxId2 = n;
        }
        var cnt = Number(payload.counter||0);
        if(!Number.isFinite(cnt)) cnt = 0;
        ensureCounterAtLeast(Math.max(cnt, maxId2));

        try{
          if(Array.isArray(db) && db.length>0) saveSafetySnapshot("after_cloud_apply");
          localStorage.setItem(DB_KEY, JSON.stringify(db));
        }catch(e){}
      }

      function cloudSave(reason){
        if(!cloud) return;
        if(!Auth.canWrite()) return;
        cloud.ready.then(function(){
          return cloud.saveMerged();
        }).catch(function(e){
          toast("雲端儲存失敗：" + (e && e.message ? e.message : String(e||"")));
        });
      }

      function hasDropboxToken(){
        try{
          var t = (localStorage.getItem(DROPBOX_TOKEN_KEY) || "").trim();
          if(!t) return false;
          t = t.replace(/^Bearer\s+/i,"").trim();
          return t.length >= 20;
        }catch(e){ return false; }
      }
      function getDropboxTokenMasked(){
        try{
          var t = (localStorage.getItem(DROPBOX_TOKEN_KEY) || "").trim();
          t = t.replace(/^Bearer\s+/i,"").trim();
          if(!t) return "未設定";
          return "已設定";
        }catch(e){ return "未設定"; }
      }

      function initCloudOnce(){
        if(cloudInited) return;
        cloudInited = true;

        if(!window.TasunCloudKit){
          toast("雲端套件未載入（僅本機模式）");
          return;
        }

        if(!hasDropboxToken()){
          toast("⚠️ 尚未設定 Dropbox Token：目前僅本機模式（不同電腦可能看到不同資料）。可按右上「設定Token」。");
        }

        try{
          window.TasunCloudKit.init({
            appVer: window.TASUN_APP_VER,
            resourcesUrl: withV("tasun-resources.json"),
            ui: { enabled:true, hideLockButtons:true }
          });

          var firstApply = true;
          var localHadData = Array.isArray(db) && db.length > 0;

          cloud = window.TasunCloudKit.mount({
            resourceKey: CLOUD_RESOURCE_KEY,
            pk: CLOUD_PK,
            idField: "id",
            counterField: "counter",
            merge: { conflictPolicy: "stash-remote" },
            watch: { intervalSec: 8 },
            getLocal: function(){
              return { db: exportDbWithSettings(), counter: getCounter() };
            },
            apply: function(payload, info){
              if(firstApply){
                firstApply = false;
                if(localHadData && Auth.canWrite()){
                  toast("雲端同步中：將自動合併本機資料…");
                  setTimeout(function(){
                    if(!cloud) return;
                    cloud.ready.then(function(){ return cloud.saveMerged(); })
                      .catch(function(){ toast("雲端合併失敗（已保留本機資料）"); });
                  }, 0);
                  return;
                }
              }

              importPayload(payload, info);
              if(info && info.conflicts){
                toast("雲端合併完成（衝突已另存快照）");
              }
              scheduleRender();
            }
          });

          if(cloud && cloud.pullNow) cloud.pullNow();

        }catch(e){
          toast("雲端初始化失敗：" + (e && e.message ? e.message : String(e||"")));
        }
      }

      function makeExportPayload(){
        return {
          meta: {
            app: "捷運汐東線事項記錄",
            dbKey: DB_KEY,
            exportedAt: new Date().toISOString(),
            ver: 1
          },
          counter: getCounter(),
          tradeDict: loadDict(TRADE_DICT_KEY),
          sysDict: loadDict(SYS_DICT_KEY),
          tradeSysMap: loadTradeSysMap(),
          db: Array.isArray(db) ? db : []
        };
      }

      function safeFileStamp(){
        var s = new Date().toISOString().slice(0,19);
        return s.replaceAll(":", "-").replace("T","_");
      }

      function downloadJSON(filename, obj){
        var blob = new Blob([JSON.stringify(obj, null, 2)], { type:"application/json" });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(function(){ URL.revokeObjectURL(url); a.remove(); }, 0);
      }

      function doExportBackup(){
        if(!Auth.ensureLoggedIn()) return;
        var payload = makeExportPayload();
        try{ localStorage.setItem(EXPORT_LAST_KEY, JSON.stringify(payload)); }catch(e){}
        downloadJSON("捷運汐東線事項記錄_備份_" + safeFileStamp() + ".json", payload);
        toast("已匯出備份（並寫入本機備份快照）");
        backupOnExit("export");
      }

      function isReadModeOn(){ return localStorage.getItem(READ_MODE_KEY) === "1"; }
      function applyReadMode(on){
        document.body.classList.toggle("readMode", !!on);
        var b = $("btnRead");
        var t = b && b.querySelector ? b.querySelector(".t") : null;
        if(t) t.textContent = on ? "閱讀模式：開" : "閱讀模式：關";
        scheduleRender();
      }
      function toggleReadMode(){
        var on = !document.body.classList.contains("readMode");
        localStorage.setItem(READ_MODE_KEY, on ? "1" : "0");
        applyReadMode(on);
        toast(on ? "已切換為閱讀模式（點摘要可展開/收合）" : "已切換為表格模式");
      }

      function uniqueFromDB(field){
        var set = new Set();
        for(var i=0;i<db.length;i++){
          var v = norm(db[i] && db[i][field]);
          if(v) set.add(v);
        }
        return set;
      }

      function unionOptions(field, dictKey){
        var set = uniqueFromDB(field);
        var dict = loadDict(dictKey);
        for(var i=0;i<dict.length;i++) set.add(dict[i]);
        var arr = Array.from(set);
        arr.sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });
        return arr;
      }

      function rebuildFilters(){
        var tSel = $("fTrade");
        var sSel = $("fSys");

        var keepT = norm(tSel.value);
        var keepS = norm(sSel.value);

        var trades = unionOptions("trade", TRADE_DICT_KEY);
        tSel.innerHTML = '<option value="">全部</option>' + trades.map(function(v){
          return '<option value="'+escHtml(v)+'">'+escHtml(v)+'</option>';
        }).join("");
        tSel.value = trades.includes(keepT) ? keepT : "";

        var pickedTrade = norm(tSel.value);

        var systems = [];
        if(pickedTrade){
          systems = systemsByTrade(pickedTrade);
        }else{
          systems = unionOptions("system", SYS_DICT_KEY);
        }

        sSel.innerHTML = '<option value="">全部</option>' + systems.map(function(v){
          return '<option value="'+escHtml(v)+'">'+escHtml(v)+'</option>';
        }).join("");

        if(pickedTrade && systems.length === 0){
          sSel.value = "";
          sSel.disabled = true;
        }else{
          sSel.disabled = false;
          sSel.value = systems.includes(keepS) ? keepS : "";
        }
      }

      function filteredRows(){
        var q = norm($("qText").value).toLowerCase();
        var t = norm($("fTrade").value);
        var s = norm($("fSys").value);

        var rows = db.slice();

        if(t) rows = rows.filter(function(r){ return norm(r.trade) === t; });
        if(s) rows = rows.filter(function(r){ return norm(r.system) === s; });

        if(q){
          rows = rows.filter(function(r){
            return (r.text ?? "").toString().toLowerCase().includes(q);
          });
        }

        rows.sort(function(a,b){ return (a.id||0) - (b.id||0); });
        return rows;
      }

      var _renderPending = false;
      function scheduleRender(){
        if(_renderPending) return;
        _renderPending = true;
        requestAnimationFrame(function(){
          _renderPending = false;
          render();
        });
      }

      function applySelectionToDOM(){
        document.querySelectorAll("tr.sel").forEach(function(el){ el.classList.remove("sel"); });
        document.querySelectorAll(".card.sel").forEach(function(el){ el.classList.remove("sel"); });

        if(!selectedUid) return;

        var tr = document.querySelector('tr[data-uid="'+selectedUid+'"]');
        if(tr) tr.classList.add("sel");

        var card = document.querySelector('.card[data-uid="'+selectedUid+'"]');
        if(card) card.classList.add("sel");
      }

      function renderHint(rowsCount){
        var pickedTrade = norm($("fTrade").value);
        var sysDisabled = $("fSys").disabled;
        var modeText = Auth.canWrite() ? "可維護模式" : "唯讀模式";

        $("btnAdd").style.display  = Auth.canWrite() ? "inline-block" : "none";
        $("btnEdit").style.display = Auth.canWrite() ? "inline-block" : "none";
        $("btnView").disabled = !selectedUid;

        $("btnToken").style.display = Auth.isAdmin() ? "inline-block" : "none";

        var selItem = selectedUid ? (db.find(function(x){ return x.uid===selectedUid; }) || null) : null;
        var selText = selItem ? ("#"+(selItem.id||"—")) : "";

        var cloudText = hasDropboxToken()
          ? '<span style="color:rgba(92,66,22,.86)">雲端：</span><b style="color:var(--goldText)">'+escHtml(getDropboxTokenMasked())+'</b>'
          : '<span style="color:rgba(92,66,22,.86)">雲端：</span><b style="color:rgba(170,60,60,.90)">未設定Token</b>' + (Auth.isAdmin() ? '（可按右上「設定Token」）' : '');

        $("hint").innerHTML =
          '目前為 <b style="color:var(--goldText)">'+modeText+'</b>（role: '+escHtml(Auth.role())+'）。' +
          ' 筆數：<b style="color:var(--goldText)">'+rowsCount+'</b>。 ' +
          cloudText +
          (pickedTrade && sysDisabled ? ' <span style="color:rgba(124,88,30,.86)">（此工種尚無系統可篩選）</span>' : '') +
          (selectedUid ? ' 已選取：<b style="color:var(--goldText)">'+escHtml(selText)+'</b>' : '（請先點選一筆，再按右上「顯示畫面 / 編輯」）');
      }

      function fillDropdown(selectId, options, placeholder){
        var sel = $(selectId);
        if(options.length === 0){
          sel.innerHTML = '<option value="" disabled selected>'+escHtml(placeholder)+'</option>';
        }else{
          sel.innerHTML = options.map(function(v){
            return '<option value="'+escHtml(v)+'">'+escHtml(v)+'</option>';
          }).join("");
        }
      }

      function rebuildModalTradeOptions(selected){
        var trades = unionOptions("trade", TRADE_DICT_KEY);
        fillDropdown("mTradeSel", trades, "（請先新增工種）");
        var v = norm(selected);
        if(v && trades.includes(v)) $("mTradeSel").value = v;
      }

      function rebuildModalSystemOptions(trade, selected){
        var t = norm(trade);
        var systems = t ? systemsByTrade(t) : [];
        fillDropdown("mSysSel", systems, t ? "（此工種尚無系統：請按「新增系統」）" : "（請先選擇工種）");
        var v = norm(selected);
        if(v && systems.includes(v)) $("mSysSel").value = v;
        else if(systems.length > 0) $("mSysSel").value = systems[0];
      }

      function isSysSelEmpty(){
        var sel = $("mSysSel");
        if(!sel) return true;
        return (sel.options.length === 1 && sel.options[0].disabled);
      }

      function setModalEditable(editable){
        $("btnSave").style.display = editable ? "inline-block" : "none";
        $("btnDelete").style.display = (editable && Auth.isAdmin() && editingUid != null) ? "inline-block" : "none";
        ["mText","mTradeSel","mSysSel","mAttach","mRemark","mDate"].forEach(function(id){
          $(id).disabled = !editable;
        });
        var allowAddOpt = editable && Auth.canWrite();
        $("btnAddTrade").style.display = allowAddOpt ? "inline-block" : "none";
        $("btnAddSys").style.display   = allowAddOpt ? "inline-block" : "none";

        if(editable && isSysSelEmpty()){
          $("mSysSel").disabled = true;
        }
      }

      function openModal(uid, editable){
        Auth.validateSession();
        if(!Auth.ensureLoggedIn()) return;

        var item = (uid == null) ? null : (db.find(function(x){ return x.uid === uid; }) || null);
        editingUid = item ? item.uid : null;

        rebuildModalTradeOptions(item ? item.trade : "");
        var tradeNow = norm($("mTradeSel").value) || (item ? item.trade : "");
        rebuildModalSystemOptions(tradeNow, item ? item.system : "");

        $("mTitle").textContent = editable ? (item ? "編輯" : "新增") : "顯示畫面";
        setModalEditable(editable);

        $("mNo").value = item ? (item.id ?? (getCounter() + 1)) : (getCounter() + 1);
        $("mText").value = item ? (item.text || "") : "";
        $("mRemark").value = item ? (item.remark || "") : "";
        $("mDate").value = item ? (item.date || new Date().toISOString().slice(0,10)) : new Date().toISOString().slice(0,10);
        $("mAttach").value = item ? (item.attach || "") : "";

        $("mask").style.display = "flex";
      }

      function closeModal(){ $("mask").style.display = "none"; }

      function saveItem(){
        Auth.validateSession();
        if(!Auth.ensureLoggedIn()) return;
        if(!Auth.canWrite()){ toast("唯讀權限不可儲存"); return; }

        var text = norm($("mText").value);
        if(!text){ toast("記事內容不可空白"); $("mText").focus(); return; }

        var trade  = norm($("mTradeSel").value);
        var system = norm($("mSysSel").value);
        if(!trade){ toast("工種尚未建立：請先按「新增工種」"); return; }
        if(!system){ toast("系統尚未建立：請先按「新增系統」"); return; }

        var attach = norm($("mAttach").value);
        var remark = norm($("mRemark").value);
        var date   = norm($("mDate").value) || new Date().toISOString().slice(0,10);

        if(editingUid != null){
          var idx = db.findIndex(function(x){ return x.uid === editingUid; });
          if(idx >= 0){
            var keep = db[idx];
            db[idx] = { uid: keep.uid, id: keep.id, text: text, trade: trade, system: system, attach: attach, remark: remark, date: date };
          }
        }else{
          var nid = nextCounter();
          var newUid = uuid();
          db.push({ uid: newUid, id: nid, text: text, trade: trade, system: system, attach: attach, remark: remark, date: date });
          selectedUid = newUid;
        }

        addTradeSysLink(trade, system);

        saveDB();
        closeModal();
        scheduleRender();
        toast("已儲存");
        backupOnExit("save");

        cloudSave("save");
      }

      function deleteItem(){
        Auth.validateSession();
        if(!Auth.ensureLoggedIn()) return;
        if(!Auth.isAdmin()){ toast("僅 admin 可刪除"); return; }
        if(editingUid == null) return;
        if(!confirm("確定刪除這筆記事？")) return;

        db = db.filter(function(x){ return x.uid !== editingUid; });
        if(selectedUid === editingUid) selectedUid = null;
        saveDB();

        closeModal();
        scheduleRender();
        toast("已刪除");
        backupOnExit("delete");

        cloudSave("delete");
      }

      function openPrompt(mode){
        Auth.validateSession();
        if(!Auth.ensureLoggedIn()) return;
        if(!Auth.canWrite()){ toast("read 權限不可新增選單"); return; }

        if(mode === "sys"){
          var curT = norm($("mTradeSel").value);
          if(!curT){
            toast("請先選擇工種，再新增系統");
            return;
          }
        }

        promptMode = mode;
        $("pInput").value = "";
        $("tokenErr") && ($("tokenErr").style.display="none");

        if(mode === "trade"){
          $("pTitle").textContent = "新增工種";
          $("pLabel").textContent = "請輸入新的工種";
          $("pInput").placeholder = "例如：土建 / 機電 / 水電...";
          $("pHint").textContent = "新增後會加入「工種字典」。";
        }else{
          $("pTitle").textContent = "新增系統";
          $("pLabel").textContent = "請輸入系統（會綁到目前工種）";
          $("pInput").placeholder = "例如：電氣 / 給排水 / 消防...";
          $("pHint").textContent = "✅ 若你輸入的系統已存在於系統字典，會改為「綁定到目前工種」（不會被擋掉）。";
        }

        $("pMask").style.display = "flex";
        setTimeout(function(){ $("pInput").focus(); }, 0);
      }

      function closePrompt(){
        $("pMask").style.display = "none";
        promptMode = null;
      }

      function addOption(){
        if(!Auth.canWrite()) return;

        var v = norm($("pInput").value);
        if(!v){ toast("不可空白"); $("pInput").focus(); return; }

        if(promptMode === "trade"){
          var existsTrade = unionOptions("trade", TRADE_DICT_KEY).map(function(x){ return x.toLowerCase(); });
          if(existsTrade.includes(v.toLowerCase())){ toast("已存在相同工種"); return; }

          var dictT = loadDict(TRADE_DICT_KEY);
          dictT.push(v);
          dictT.sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });
          saveDict(TRADE_DICT_KEY, dictT);

          rebuildModalTradeOptions(v);
          $("mTradeSel").value = v;
          rebuildModalSystemOptions(v, "");
          if(isSysSelEmpty()) $("mSysSel").disabled = true;

          scheduleRender();
          closePrompt();
          toast("已新增工種");
          backupOnExit("add_trade");
          cloudSave("dict");
          return;
        }

        var curTrade = norm($("mTradeSel").value);
        if(!curTrade){ toast("請先選擇工種"); return; }

        var sysDict = loadDict(SYS_DICT_KEY);
        var sysLower = sysDict.map(function(x){ return x.toLowerCase(); });
        var inSysDict = sysLower.includes(v.toLowerCase());

        if(!inSysDict){
          sysDict.push(v);
          sysDict.sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });
          saveDict(SYS_DICT_KEY, sysDict);
        }

        var before = systemsByTrade(curTrade).map(function(x){ return x.toLowerCase(); });
        if(before.includes(v.toLowerCase())){
          toast("此工種已有該系統");
        }else{
          addTradeSysLink(curTrade, v);
          toast(inSysDict ? "已綁定系統到目前工種" : "已新增並綁定系統");
        }

        rebuildModalSystemOptions(curTrade, v);
        $("mSysSel").disabled = false;
        $("mSysSel").value = v;

        scheduleRender();
        closePrompt();
        backupOnExit("add_sys");
        cloudSave("dict");
      }

      function syncUserUI(){
        var u = Auth.current();
        $("uName").textContent = u && u.username ? u.username : "—";
        $("uRole").textContent = Auth.role();
      }

      function setupMoreMenu(backHref){
        var backBtn = $("mBack");
        var moreBtn = $("mMoreBtn");
        var menu = $("mMoreMenu");

        function close(){ menu.style.display = "none"; }
        function toggle(e){
          e.preventDefault();
          e.stopPropagation();
          menu.style.display = (menu.style.display === "block") ? "none" : "block";
        }

        backBtn.onclick = function(){ go(backHref); };
        moreBtn.addEventListener("click", toggle);

        menu.addEventListener("click", function(e){
          e.stopPropagation();
          var item = e.target.closest("button.menuItem[data-href]");
          if(!item) return;
          var href = item.getAttribute("data-href");
          if(href) go(href);
        });

        document.addEventListener("click", close);
        window.addEventListener("keydown", function(e){ if(e.key === "Escape") close(); });
      }

      // ===============================
      // ✅ Token UI（略：維持原版本）
      // ===============================
      function openTokenMask(){
        if(!Auth.isAdmin()){
          toast("僅 admin 可設定 Token");
          return;
        }
        $("tokenErr").style.display = "none";
        $("tokenErr").textContent = "";
        $("tokenInput").value = "";
        $("tokenInput").type = "password";
        $("tokenHint").textContent = "目前狀態：" + getDropboxTokenMasked();
        $("tokenMask").classList.add("show");
        setTimeout(function(){ $("tokenInput").focus(); }, 0);
      }
      function closeTokenMask(){
        $("tokenMask").classList.remove("show");
      }
      function saveToken(){
        if(!Auth.isAdmin()){
          toast("僅 admin 可設定 Token");
          return;
        }
        var t = norm($("tokenInput").value);
        t = t.replace(/^Bearer\s+/i,"").trim();
        if(!t || t.length < 20){
          $("tokenErr").textContent = "Token 看起來不完整（長度不足），請重新貼上。";
          $("tokenErr").style.display = "block";
          return;
        }
        try{
          localStorage.setItem(DROPBOX_TOKEN_KEY, t);
        }catch(e){
          $("tokenErr").textContent = "寫入 localStorage 失敗，可能瀏覽器限制或空間不足。";
          $("tokenErr").style.display = "block";
          return;
        }

        try{
          if(window.TasunCloudKit && typeof window.TasunCloudKit.setToken === "function"){
            window.TasunCloudKit.setToken(t);
          }
          if(cloud && typeof cloud.setToken === "function"){
            cloud.setToken(t);
          }
        }catch(e){}

        closeTokenMask();
        toast("已儲存 Token，將嘗試同步雲端…");

        if(!cloudInited) initCloudOnce();
        try{
          if(cloud && cloud.pullNow) cloud.pullNow();
        }catch(e){}

        setTimeout(function(){
          scheduleRender();
          toast("如仍顯示 CloudKit error，請重新整理頁面一次。");
        }, 900);
      }
      function clearToken(){
        if(!Auth.isAdmin()){
          toast("僅 admin 可清除 Token");
          return;
        }
        try{ localStorage.removeItem(DROPBOX_TOKEN_KEY); }catch(e){}

        try{
          if(window.TasunCloudKit && typeof window.TasunCloudKit.setToken === "function"){
            window.TasunCloudKit.setToken("");
          }
          if(cloud && typeof cloud.setToken === "function"){
            cloud.setToken("");
          }
        }catch(e){}

        $("tokenHint").textContent = "目前狀態：未設定";
        toast("已清除 Token（回到本機模式）");
        scheduleRender();
      }
      function toggleTokenVisible(){
        var inp = $("tokenInput");
        inp.type = (inp.type === "password") ? "text" : "password";
      }

      // ===============================
      // ✅ Render：表格 + 閱讀模式（卡片）
      // ===============================
      function toPlainOneLine(s){
        s = (s ?? "").toString();
        s = s.replace(/\r\n/g,"\n").replace(/\r/g,"\n");
        s = s.replace(/\n+/g,"  ");
        s = s.replace(/\s+/g," ").trim();
        return s;
      }

      function renderCards(rows){
        var cards = $("cards");
        if(!cards) return;

        if(rows.length === 0){
          cards.innerHTML = '<div class="muted" style="padding:14px; color:rgba(246,214,150,.72); font-weight:900; letter-spacing:.06em;">尚無資料（write/admin 可用右上「新增」建立第一筆）</div>';
          return;
        }

        cards.innerHTML = rows.map(function(r){
          var uid = escHtml(r.uid);
          var no = (r.id ?? "");
          var date = escHtml(r.date || "");
          var trade = escHtml(r.trade || "");
          var system = escHtml(r.system || "");
          var hasAtt = !!norm(r.attach || "");
          var hasRemark = !!toPlainOneLine(r.remark || "");
          var expanded = expandedSet.has(r.uid);

          var summaryHtml = escHtml((r.text ?? "").toString()).replaceAll("\n","<br>");
          var remarkHtml = escHtml((r.remark ?? "").toString()).replaceAll("\n","<br>");

          return ''
            + '<div class="card'+(expanded?' expanded':'')+'" data-uid="'+uid+'">'
            +   '<div class="cardTop" data-act="toggle">'
            +     '<div class="cardNo">#'+escHtml(String(no||"—"))+'</div>'
            +     '<div class="cardDate">'+(date||'<span class="muted" style="opacity:.65;">—</span>')+'</div>'
            +   '</div>'
            +   '<div class="badges" data-act="toggle">'
            +     '<span class="badge">'+(trade||'—')+'</span>'
            +     '<span class="badge">'+(system||'—')+'</span>'
            +   '</div>'
            +   '<div class="cardSummary" data-act="toggle">'+(summaryHtml||'<span class="muted">—</span>')+'</div>'
            +   '<div class="cardMore">'
            +     '<div class="cardRow">'
            +       '<div class="cardKey">附件</div>'
            +       '<div class="cardVal">'+(hasAtt ? '（已設定，可按下方「開啟附件」）' : '<span class="muted">—</span>')+'</div>'
            +     '</div>'
            +     '<div class="cardRow">'
            +       '<div class="cardKey">備註</div>'
            +       '<div class="cardVal">'+(hasRemark ? remarkHtml : '<span class="muted">—</span>')+'</div>'
            +     '</div>'
            +   '</div>'
            +   '<div class="cardActions">'
            +     (hasAtt ? '<button class="attBtn" data-act="att" data-uid="'+uid+'" type="button"><span class="t">開啟附件</span></button>' : '<span class="muted" style="align-self:center;">（無附件）</span>')
            +     '<button class="btn ghost small" data-act="view" data-uid="'+uid+'" type="button"><span class="t">顯示畫面</span></button>'
            +   '</div>'
            + '</div>';
        }).join("");
      }

      function renderTable(rows){
        var tbody = $("tbody");
        tbody.innerHTML = rows.map(function(r){
          var isSel = (selectedUid === r.uid);
          var att = norm(r.attach || "");
          var attCell = att
            ? '<button class="attBtn" data-act="att" data-uid="'+escHtml(r.uid)+'"><span class="t">開啟</span></button>'
            : '<span class="muted">—</span>';

          var textHtml = escHtml((r.text ?? "").toString()).replaceAll("\n","<br>");
          var remarkHtml = escHtml((r.remark ?? "").toString()).replaceAll("\n","<br>");

          return ''
            + '<tr data-uid="'+escHtml(r.uid)+'" class="'+(isSel ? "sel" : "")+'">'
            +   '<td style="text-align:center;">'+(r.id ?? "")+'</td>'
            +   '<td>'+(textHtml ? textHtml : '<span class="muted">—</span>')+'</td>'
            +   '<td style="text-align:center;">'+(escHtml(r.trade) || '<span class="muted">—</span>')+'</td>'
            +   '<td style="text-align:center;">'+(escHtml(r.system) || '<span class="muted">—</span>')+'</td>'
            +   '<td style="text-align:center;">'+attCell+'</td>'
            +   '<td>'+(remarkHtml ? remarkHtml : '<span class="muted">—</span>')+'</td>'
            +   '<td style="text-align:center;">'+(escHtml(r.date) || '<span class="muted">—</span>')+'</td>'
            +   '<td style="text-align:center;"><button class="btn ghost small" data-act="view" data-uid="'+escHtml(r.uid)+'"><span class="t">顯示畫面</span></button></td>'
            + '</tr>';
        }).join("") || (
          '<tr><td colspan="8" class="muted" style="padding:18px;">尚無資料（write/admin 可用右上「新增」建立第一筆）</td></tr>'
        );
      }

      function render(){
        rebuildFilters();

        var rows = filteredRows();
        if(selectedUid && !rows.some(function(r){ return r.uid===selectedUid; })) selectedUid = null;

        var readMode = document.body.classList.contains("readMode");

        if(readMode){
          renderCards(rows);
        }else{
          renderTable(rows);
          // 不是閱讀模式就清空卡片（避免 DOM 太大）
          $("cards").innerHTML = "";
        }

        applySelectionToDOM();
        renderHint(rows.length);
      }

      // ===============================
      // ✅ UI bind
      // ===============================
      var _uiBound = false;
      function bindUIOnce(){
        if(_uiBound) return;
        _uiBound = true;

        $("navBack").onclick = function(){ go("汐東工程管理表.html"); };
        setupMoreMenu("汐東工程管理表.html");

        $("btnRead").onclick = toggleReadMode;
        $("btnCloud").onclick = function(){ openAttachment(CLOUD_URL); };
        $("btnExport").onclick = function(){
          Auth.validateSession();
          if(!Auth.ensureLoggedIn()) return;
          doExportBackup();
        };

        $("btnView").onclick = function(){
          if(!selectedUid){ toast("請先點選一筆，再按顯示畫面"); return; }
          openModal(selectedUid, false);
        };

        $("qText").addEventListener("input", scheduleRender);
        $("fTrade").addEventListener("change", scheduleRender);
        $("fSys").addEventListener("change", scheduleRender);

        $("btnClear").onclick = function(){
          $("qText").value = "";
          $("fTrade").value = "";
          $("fSys").value = "";
          scheduleRender();
        };

        $("btnAdd").onclick = function(){
          if(!Auth.canWrite()){ toast("唯讀不可新增"); return; }
          editingUid = null;
          openModal(null, true);
        };

        $("btnEdit").onclick = function(){
          if(!Auth.canWrite()){ toast("唯讀不可編輯"); return; }
          if(!selectedUid){ toast("請先點選項目再按編輯"); return; }
          openModal(selectedUid, true);
        };

        $("btnClose").onclick = closeModal;
        $("btnCancel").onclick = closeModal;
        $("mask").addEventListener("click", function(e){ if(e.target === $("mask")) closeModal(); });

        $("btnSave").onclick = saveItem;
        $("btnDelete").onclick = deleteItem;

        $("btnAddTrade").onclick = function(){ openPrompt("trade"); };
        $("btnAddSys").onclick   = function(){ openPrompt("sys"); };

        $("pClose").onclick = closePrompt;
        $("pCancel").onclick = closePrompt;
        $("pOk").onclick = addOption;
        $("pMask").addEventListener("click", function(e){ if(e.target === $("pMask")) closePrompt(); });

        $("mTradeSel").addEventListener("change", function(){
          var t = norm($("mTradeSel").value);
          rebuildModalSystemOptions(t, "");
          if(isSysSelEmpty()) $("mSysSel").disabled = true;
          else $("mSysSel").disabled = false;
        });

        // ✅ 表格點擊
        $("tbody").addEventListener("click", function(e){
          var viewBtn = e.target.closest("button[data-act='view']");
          if(viewBtn){
            var uid = norm(viewBtn.getAttribute("data-uid"));
            if(uid) openModal(uid, false);
            return;
          }
          var attBtn = e.target.closest("button[data-act='att']");
          if(attBtn){
            var uid2 = norm(attBtn.getAttribute("data-uid"));
            var item2 = db.find(function(x){ return x.uid === uid2; });
            var href2 = norm(item2 && item2.attach ? item2.attach : "");
            if(!href2){ toast("此筆尚未設定附件"); return; }
            openAttachment(href2);
            return;
          }
          var tr = e.target.closest("tr[data-uid]");
          if(!tr) return;
          var uid3 = norm(tr.getAttribute("data-uid"));
          if(!uid3) return;
          selectedUid = uid3;
          applySelectionToDOM();
          renderHint(filteredRows().length);
        });

        // ✅ 閱讀模式卡片點擊：選取 + 展開/收合 + 按鈕操作
        $("cards").addEventListener("click", function(e){
          var viewBtn = e.target.closest("button[data-act='view']");
          if(viewBtn){
            e.stopPropagation();
            var uidV = norm(viewBtn.getAttribute("data-uid"));
            if(uidV) openModal(uidV, false);
            return;
          }

          var attBtn = e.target.closest("button[data-act='att']");
          if(attBtn){
            e.stopPropagation();
            var uidA = norm(attBtn.getAttribute("data-uid"));
            var itemA = db.find(function(x){ return x.uid === uidA; });
            var hrefA = norm(itemA && itemA.attach ? itemA.attach : "");
            if(!hrefA){ toast("此筆尚未設定附件"); return; }
            openAttachment(hrefA);
            return;
          }

          var card = e.target.closest(".card[data-uid]");
          if(!card) return;

          var uid = norm(card.getAttribute("data-uid"));
          if(!uid) return;

          // ✅ 先選取
          selectedUid = uid;
          applySelectionToDOM();
          renderHint(filteredRows().length);

          // ✅ 若點到 data-act="toggle" 的區域 → 展開/收合
          var toggleArea = e.target.closest("[data-act='toggle']");
          if(toggleArea){
            if(expandedSet.has(uid)) expandedSet.delete(uid);
            else expandedSet.add(uid);
            card.classList.toggle("expanded");
          }
        });

        window.addEventListener("keydown", function(e){
          if(e.key === "Escape"){
            if($("tokenMask").classList.contains("show")) closeTokenMask();
            else if($("pMask").style.display === "flex") closePrompt();
            else if($("mask").style.display === "flex") closeModal();
          }
          if(e.key === "Enter" && $("pMask").style.display === "flex") addOption();
        });

        window.addEventListener("storage", function(e){
          if(e.key === DB_KEY || LEGACY_DB_KEYS.includes(e.key)){
            loadDB(true);
            scheduleRender();
          }
          if(e.key === READ_MODE_KEY){
            applyReadMode(isReadModeOn());
          }
          if(e.key === TRADE_SYS_MAP_KEY){
            scheduleRender();
          }
          if(e.key === DROPBOX_TOKEN_KEY){
            scheduleRender();
          }
        });

        $("btnToken").onclick = openTokenMask;
        $("tokenClose").onclick = closeTokenMask;
        $("tokenSave").onclick = saveToken;
        $("tokenClear").onclick = clearToken;
        $("tokenToggle").onclick = toggleTokenVisible;
        $("tokenMask").addEventListener("click", function(e){ if(e.target === $("tokenMask")) closeTokenMask(); });
      }

      function start(){
        if(!Auth.ensureLoggedIn()) return;

        ensureSeedDict();
        loadDB();
        bindUIOnce();

        syncUserUI();
        applyReadMode(isReadModeOn());

        initCloudOnce();
        scheduleRender();
      }

      Auth.init({
        onAuthed: function(){ toast("登入成功"); start(); },
        onSessionChange: function(){ syncUserUI(); scheduleRender(); },
        onForceRelogin: function(msg){
          toast(msg || "請重新登入");
          syncUserUI();
          try{ closeModal(); closePrompt(); closeTokenMask(); }catch(e){}
          scheduleRender();
        }
      });

      var toAuth = $("loginToAuth");
      if(toAuth) toAuth.onclick = function(){ go("權限表.html"); };

      start();
    }

    (function(onReady){
      onReady(run);
    })(function(fn){
      try{
        var W = window.__TASUN_WAIT__ || window.__TASUN_READY__;
        if(W){
          if(typeof W.push === "function"){ W.push(fn); return; }
          if(typeof W.then === "function"){ W.then(fn); return; }
          if(W.ready === true){ fn(); return; }
        }
      }catch(e){}
      if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", fn);
      else fn();
    });

  })();
  </script>
</body>
</html>
