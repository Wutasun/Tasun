          .replaceAll('"',"&quot;").replaceAll("'","&#39;");
      }
      function todayISO(){ return new Date().toISOString().slice(0,10); }
      function uuid(){ return "u" + Date.now().toString(16) + "_" + Math.random().toString(16).slice(2); }

      // ===== Data =====
      var db = [];
      var counter = 0;
      var selectedUid = null;
      var editingUid = null; // null => add
      var promptMode = null;
      var cloud = null;
      var lastSyncAt = 0;
      var cloudState = "offline"; // offline | ok | deny | neterr | noapi
      var apiLastStatus = 0;

      // ===== Cloud helpers (GitHub Repo JSON) =====
      function safeJSON(raw){ if(!raw) return null; try{ return JSON.parse(raw); }catch(e){ return null; } }
      function nowISO(){ return new Date().toISOString(); }

      function normOwnerRepo(s){
        s = norm(s);
        s = s.replace(/^https?:\/\/github\.com\//i, "").replace(/^https?:\/\/raw\.githubusercontent\.com\//i, "");
        s = s.replace(/^\/+|\/+$/g, "");
        // remove trailing .git
        s = s.replace(/\.git$/i, "");
        // owner/repo only
        var parts = s.split("/");
        if(parts.length>=2) return parts[0] + "/" + parts[1];
        return s;
      }

      function getRepoCfg(){
        var cfg = { ownerRepo: GH_DEFAULT_OWNER_REPO, branch: GH_DEFAULT_BRANCH, path: GH_DEFAULT_PATH, token: "" };

        // window override
        try{
          var w = window.TASUN_GH_REPO_CFG;
          if(w && typeof w==="object"){
            if(w.ownerRepo) cfg.ownerRepo = normOwnerRepo(w.ownerRepo);
            if(w.branch) cfg.branch = norm(w.branch);
            if(w.path) cfg.path = norm(w.path).replace(/^\/+/,"");
          }else if(typeof w==="string" && w.trim()){
            var partsW = w.split(/[\s|,;]+/).map(norm).filter(Boolean);
            if(partsW.length>=3){
              cfg.ownerRepo = normOwnerRepo(partsW[0]);
              cfg.branch = norm(partsW[1]);
              cfg.path = norm(partsW[2]).replace(/^\/+/,"");
            }
          }
        }catch(e){}

        // stored repo cfg: "owner/repo|branch|path"
        try{
          var raw = norm(sessionStorage.getItem(GH_CFG_KEY) || localStorage.getItem(GH_CFG_KEY) || "");
          if(raw){
            var parts = raw.split("|").map(norm).filter(Boolean);
            if(parts.length>=3){
              cfg.ownerRepo = normOwnerRepo(parts[0]);
              cfg.branch = norm(parts[1]);
              cfg.path = norm(parts[2]).replace(/^\/+/,"");
            }
          }
        }catch(e){}

        // token
        try{
          var t = window.TASUN_GH_TOKEN;
          if(typeof t==="string" && t.trim()) cfg.token = t.trim();
        }catch(e){}
        try{
          var rawT = norm(sessionStorage.getItem(GH_TOKEN_KEY) || localStorage.getItem(GH_TOKEN_KEY) || "");
          if(rawT) cfg.token = rawT;
        }catch(e){}

        return cfg;
      }

      function setRepoCfg(cfg){
        cfg = cfg || {};
        var ownerRepo = normOwnerRepo(cfg.ownerRepo || "");
        var branch = norm(cfg.branch || "");
        var path = norm(cfg.path || "").replace(/^\/+/,"");
        if(ownerRepo && branch && path){
          var s = ownerRepo + "|" + branch + "|" + path;
          try{ sessionStorage.setItem(GH_CFG_KEY, s); }catch(e){}
          try{ localStorage.setItem(GH_CFG_KEY, s); }catch(e){}
        }
        if("token" in cfg){
          var t = norm(cfg.token || "");
          try{ if(t) sessionStorage.setItem(GH_TOKEN_KEY, t); else sessionStorage.removeItem(GH_TOKEN_KEY); }catch(e){}
          try{ if(t) localStorage.setItem(GH_TOKEN_KEY, t); else localStorage.removeItem(GH_TOKEN_KEY); }catch(e){}
          try{ window.TASUN_GH_TOKEN = t || ""; }catch(e){}
        }
      }

      function rawUrlFromCfg(cfg){
        cfg = cfg || getRepoCfg();
        var ownerRepo = normOwnerRepo(cfg.ownerRepo||"");
        var branch = norm(cfg.branch||"");
        var path = norm(cfg.path||"").replace(/^\/+/,"");
        if(!ownerRepo || !branch || !path) return "";
        return "https://raw.githubusercontent.com/" + ownerRepo + "/" + encodeURIComponent(branch) + "/" + path;
      }
      function blobUrlFromCfg(cfg){
        cfg = cfg || getRepoCfg();
        var ownerRepo = normOwnerRepo(cfg.ownerRepo||"");
        var branch = norm(cfg.branch||"");
        var path = norm(cfg.path||"").replace(/^\/+/,"");
        if(!ownerRepo || !branch || !path) return "";
        return "https://github.com/" + ownerRepo + "/blob/" + encodeURIComponent(branch) + "/" + path;
      }
      function contentsApiUrlFromCfg(cfg){
        cfg = cfg || getRepoCfg();
        var ownerRepo = normOwnerRepo(cfg.ownerRepo||"");
        var path = norm(cfg.path||"").replace(/^\/+/,"");
        if(!ownerRepo || !path) return "";
        var a = ownerRepo.split("/");
        return "https://api.github.com/repos/" + a[0] + "/" + a[1] + "/contents/" + path;
      }

      function utf8ToB64(str){
        try{ return btoa(unescape(encodeURIComponent(str))); }
        catch(e){ try{ return btoa(str); }catch(e2){ return ""; } }
      }
      function b64ToUtf8(b64){
        if(!b64) return "";
        b64 = String(b64).replace(/\s+/g,"");
        try{
          var bin = atob(b64);
          var esc = "";
          for(var i=0;i<bin.length;i++){
            var c = bin.charCodeAt(i).toString(16);
            esc += "%" + ("00"+c).slice(-2);
          }
          return decodeURIComponent(esc);
        }catch(e){
          try{ return atob(b64); }catch(e2){ return ""; }
        }
      }

      async function httpJSON(url, opt){
        opt = opt || {};
        opt.mode = "cors";
        opt.cache = "no-store";
        opt.headers = Object.assign({ "Accept":"application/json" }, opt.headers||{});
        var res;
        try{ res = await fetch(url, opt); }
        catch(err){
          var e2 = new Error(err && err.message ? err.message : "Failed to fetch");
          e2.status = 0; e2.code = "FETCH_FAIL";
          throw e2;
        }
        if(!res.ok){
          var body = "";
          try{ body = await res.text(); }catch(e){}
          var err2 = new Error("HTTP "+res.status+" "+res.statusText);
          err2.status = res.status;
          err2.body = body;
          if(res.status===401 || res.status===403) err2.code = "ACCESS_DENY";
          if(res.status===404) err2.code = "NOT_FOUND";
          throw err2;
        }
        var ct = (res.headers.get("content-type")||"").toLowerCase();
        if(ct.includes("application/json")) return await res.json();
        var txt = await res.text();
        try{ return JSON.parse(txt); }catch(e){ return { ok:true, raw:txt }; }
      }

      function ghAuthHeaders(token){
        token = norm(token || "");
        if(!token) return {};
        // PAT: "token xxx" works; also support bearer
        return { "Authorization": "token " + token };
      }

      async function ghPull(){
        var cfg = getRepoCfg();
        var u = rawUrlFromCfg(cfg);
        if(!u){
          var e0 = new Error("NO_REPO_CFG"); e0.status = 0; e0.code = "NO_REPO_CFG"; throw e0;
        }
        return await httpJSON(u + "?_=" + Date.now(), { method:"GET" });
      }

      async function ghGetByApi(){
        var cfg = getRepoCfg();
        var token = norm(cfg.token||"");
        if(!token){
          var e0 = new Error("NO_TOKEN"); e0.status = 0; e0.code = "NO_TOKEN"; throw e0;
        }
        var url = contentsApiUrlFromCfg(cfg);
        if(!url){
          var e1 = new Error("NO_REPO_CFG"); e1.status=0; e1.code="NO_REPO_CFG"; throw e1;
        }
        url += "?ref=" + encodeURIComponent(cfg.branch || "main") + "&_=" + Date.now();
        var resp;
        try{
          resp = await httpJSON(url, { method:"GET", headers: Object.assign({ "Accept":"application/vnd.github+json" }, ghAuthHeaders(token)) });
        }catch(e){
          // If file missing, allow create later
          if(e && e.code==="NOT_FOUND"){
            return { payload: { db:[], counter:0 }, sha: null, missing: true, cfg: cfg };
          }
          throw e;
        }
        var content = (resp && resp.content) ? b64ToUtf8(resp.content) : "";
        var jsonObj = safeJSON(content) || { db:[], counter:0 };
        return { payload: jsonObj, sha: resp.sha || null, missing: false, cfg: cfg };
      }

      async function ghPutByApi(payload, sha){
        var cfg = getRepoCfg();
        var token = norm(cfg.token||"");
        if(!token){
          var e0 = new Error("NO_TOKEN"); e0.status = 0; e0.code = "NO_TOKEN"; throw e0;
        }
        var url = contentsApiUrlFromCfg(cfg);
        if(!url){
          var e1 = new Error("NO_REPO_CFG"); e1.status=0; e1.code="NO_REPO_CFG"; throw e1;
        }
        var body = {
          message: "tasun: merge " + PAGE_KEY + " " + nowISO(),
          content: utf8ToB64(JSON.stringify(payload, null, 2)),
          branch: cfg.branch || "main"
        };
        if(sha) body.sha = sha;

        return await httpJSON(url, {
          method:"PUT",
          headers: Object.assign({ "Accept":"application/vnd.github+json", "Content-Type":"application/json" }, ghAuthHeaders(token)),
          body: JSON.stringify(body)
        });
      }

      function unwrap(resp){
        var p = resp;
        if(p && typeof p==="object"){
          if("payload" in p) p = p.payload;
          else if("data" in p) p = p.data;
          else if("result" in p) p = p.result;
        }
        var out = (p && typeof p==="object") ? p : {};
        if(!Array.isArray(out.db)) out.db = [];
        var c = Number(out.counter||0); if(!Number.isFinite(c) || c<0) c=0;
        out.counter = c;
        return { payload: out, info: {} };
      }

      function tsOf(x){
        var s = norm(x && x.updatedAt);
        if(!s) return 0;
        var t = Date.parse(s);
        return isNaN(t) ? 0 : t;
      }
      function pickNewer(a,b){
        if(!a) return b;
        if(!b) return a;
        var ta = tsOf(a), tb = tsOf(b);
        if(tb>ta) return b;
        if(ta>tb) return a;
        // tie-breaker by rev
        var ra = norm(a.rev||""), rb = norm(b.rev||"");
        return (rb>ra) ? b : a;
      }

      function mergePayload(remotePayload, localPayload){
        var r = unwrap(remotePayload||{}).payload;
        var l = unwrap(localPayload||{}).payload;

        var map = Object.create(null);
        function putAll(arr){
          for(var i=0;i<arr.length;i++){
            var row = normalizeRow(arr[i]);
            if(!row || !row.uid) continue;
            var cur = map[row.uid];
            map[row.uid] = pickNewer(cur, row);
          }
        }
        putAll(r.db||[]);
        putAll(l.db||[]);

        var merged = [];
        for(var k in map){ if(Object.prototype.hasOwnProperty.call(map,k)){ merged.push(map[k]); } }

        // Ensure IDs unique for non-deleted
        var used = new Set();
        var max = 0;
        for(var i2=0;i2<merged.length;i2++){
          var rr = merged[i2];
          if(rr && !rr.deleted){
            var id = Number(rr.id);
            if(Number.isFinite(id) && id>0){
              if(!used.has(id)) used.add(id);
              if(id>max) max=id;
            }
          }
        }
        var counterMerged = Math.max(Number(r.counter||0)||0, Number(l.counter||0)||0, max);
        for(i2=0;i2<merged.length;i2++){
          rr = merged[i2];
          if(rr && !rr.deleted){
            var id2 = Number(rr.id);
            if(!Number.isFinite(id2) || id2<=0 || used.has(id2) && false){ /* noop */ }
          }
        }
        // assign duplicates/missing
        used = new Set();
        // sort for stable assignment
        merged.sort(function(a,b){
          var da = a && a.deleted ? 1 : 0;
          var dbb = b && b.deleted ? 1 : 0;
          if(da!==dbb) return da-dbb;
          var ia = Number(a && a.id || 0), ib = Number(b && b.id || 0);
          if(ia!==ib) return ia-ib;
          return tsOf(a)-tsOf(b);
        });
        for(i2=0;i2<merged.length;i2++){
          rr = merged[i2];
          if(!rr || rr.deleted) continue;
          var idv = Number(rr.id);
          if(!Number.isFinite(idv) || idv<=0 || used.has(idv)){
            counterMerged += 1;
            rr.id = counterMerged;
            rr.updatedAt = rr.updatedAt || nowISO();
            rr.rev = rr.rev || ("r"+Math.random().toString(16).slice(2));
          }
          used.add(Number(rr.id));
          if(Number(rr.id)>counterMerged) counterMerged = Number(rr.id);
        }

        return { db: merged, counter: counterMerged, updatedAt: nowISO() };
      }

      function portalUrl(){ return blobUrlFromCfg(getRepoCfg()); }
function CloudCtrl(){
        this._timer = 0;
        this._saving = false;
        this._pending = false;
      }
      CloudCtrl.prototype._err = function(e){
        if(!e) return;
        if(e.code==="NO_REPO_CFG"){ cloudState="noapi"; toast("⚠️ 尚未設定 GitHub 位置：請按右上「雲端設定」。"); return; }
        if(e.code==="NO_TOKEN"){ cloudState="readonly"; toast("ℹ️ 尚未設定 GH_TOKEN：目前為「僅讀」，write/admin 要寫入請到右上「雲端設定」。"); return; }
        if(e.code==="NOT_FOUND" || e.status===404){ cloudState="notfound"; toast("⚠️ 找不到 GitHub 檔案：請確認 owner/repo、branch、path。"); return; }
        if(e.code==="FETCH_FAIL" || e.status===0){ cloudState="neterr"; toast("⚠️ 雲端連線失敗：請確認網路或 GitHub 狀態。"); return; }
        if(e.code==="ACCESS_DENY" || e.status===401 || e.status===403){ cloudState="deny"; toast("⚠️ GH_TOKEN 無效或權限不足（需 Contents read/write）。"); return; }
        toast("雲端錯誤：" + (e.message ? e.message : String(e)));
      };
CloudCtrl.prototype.apply = function(payload, info){
        payload = payload || {};
        var rdb = Array.isArray(payload.db) ? payload.db : [];
        var rc = Number(payload.counter||0); if(!Number.isFinite(rc) || rc<0) rc=0;

        // ✅ protect: remote 空但 local 有 → 先保護一次
        var protectOnce = false;
        try{ protectOnce = !sessionStorage.getItem(PROTECT_EMPTY_REMOTE_KEY); }catch(e){}
        if(rdb.length===0 && db.length>0 && protectOnce){
          try{ sessionStorage.setItem(PROTECT_EMPTY_REMOTE_KEY, "1"); }catch(e){}
          toast("⚠️ 雲端回傳空資料：已先保護本機資料（避免誤覆蓋）。");
          cloudState = "ok";
          lastSyncAt = Date.now();
          renderHint();
          return;
        }

        db = rdb.map(normalizeRow).filter(Boolean);
        counter = Math.max(counter, rc);
        saveLocal();
        lastSyncAt = Date.now();
        cloudState = "ok";
        renderAll();
        if(info && info.merged) toast("雲端合併完成");
      };
      CloudCtrl.prototype.pullNow = function(){
        var self = this;
        return ghPull().then(function(resp){
          cloudState="ok";
          var u = unwrap(resp);
          self.apply(u.payload, u.info||{});
          return true;
        }).catch(function(e){ self._err(e); return false; });
      };
CloudCtrl.prototype.saveMerged = function(){
        var self = this;
        var cfg = getRepoCfg();
        if(!norm(cfg && cfg.token)){
          // no token => read-only
          self._err({ code:"NO_TOKEN", status:0, message:"NO_TOKEN" });
          return Promise.resolve(false);
        }
        if(self._saving){ self._pending = true; return Promise.resolve(false); }
        self._saving = true; self._pending = false;

        // local snapshot
        var localPayload = { db: db, counter: counter };

        var tries = 0;
        function attempt(){
          tries++;
          return ghGetByApi().then(function(remote){
            var merged = mergePayload(remote.payload, localPayload);
            return ghPutByApi(merged, remote.sha).then(function(){
              self.apply(merged, { merged:true });
              return true;
            });
          }).catch(function(e){
            // retry once on conflict-like responses
            if(tries < 3 && e && (e.status===409 || e.status===422)){
              return attempt();
            }
            self._err(e);
            return false;
          });
        }

        return attempt().finally(function(){
          self._saving = false;
          if(self._pending){ self._pending=false; setTimeout(function(){ self.saveMerged(); }, 0); }
        });
      };
CloudCtrl.prototype.startWatch = function(sec){
        var self=this;
        sec = Number(sec||0); if(!Number.isFinite(sec) || sec<=0) sec = 30;
        clearInterval(self._timer);
        self._timer = setInterval(function(){ self.pullNow(); }, sec*1000);
      };
      CloudCtrl.prototype.destroy = function(){ clearInterval(this._timer); };

      // ===== Local load/save =====
      function normalizeRow(x){
        if(!x || typeof x!=="object") return null;
        var uid = norm(x.uid ?? x._uid ?? x.pk ?? x.k ?? x.key ?? "");
        var id = Number(x.id ?? x.no ?? x.idx ?? "");
        if(!Number.isFinite(id) || id<=0) id = null;

        var text   = (x.text ?? x.content ?? x.note ?? "").toString();
        var trade  = norm(x.trade ?? x.kind ?? "");
        var system = norm(x.system ?? x.sys ?? "");
        var source = norm(x.source ?? x.origin ?? "");
        var attach = norm(x.attach ?? x.attachment ?? x.link ?? "");
        var remark = (x.remark ?? x.note2 ?? "").toString();
        var date   = norm(x.date ?? x.day ?? x.created ?? "");

        // meta for merge
        var rev = norm(x.rev ?? x._rev ?? "");
        var updatedAt = norm(x.updatedAt ?? x.updated_at ?? "");
        var deleted = !!(x.deleted ?? x._deleted ?? false);

        if(date && !/^\d{4}-\d{2}-\d{2}$/.test(date)){
          var d = new Date(date);
          date = isNaN(d.getTime()) ? "" : d.toISOString().slice(0,10);
        }

        if(!uid) uid = id ? ("legacy_"+String(id)) : uuid();

        // derive updatedAt if missing
        if(!updatedAt){
          if(date && /^\d{4}-\d{2}-\d{2}$/.test(date)){
            updatedAt = date + "T00:00:00.000Z";
          }else{
            updatedAt = new Date().toISOString();
          }
        }else{
          var dt = Date.parse(updatedAt);
          if(isNaN(dt)) updatedAt = new Date().toISOString();
        }

        if(!rev) rev = "r" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);

        return { uid:uid, id:id, text:text, trade:trade, system:system, source:source, attach:attach, remark:remark, date:date, rev:rev, updatedAt:updatedAt, deleted:deleted };
      }
function loadLocal(){
        db = [];
        counter = 0;
        try{
          var raw = localStorage.getItem(DB_KEY);
          var arr = safeJSON(raw);
          if(Array.isArray(arr)) db = arr.map(normalizeRow).filter(Boolean);
        }catch(e){}
        try{
          var c = Number(localStorage.getItem(COUNTER_KEY)||0);
          if(Number.isFinite(c) && c>0) counter = c;
        }catch(e){}
        counter = Math.max(counter, maxId(db));
        if(db.length>0){
          saveLocal(); // normalize persist
        }
      }
      function saveLocal(){
        try{ localStorage.setItem(DB_KEY, JSON.stringify(db)); }catch(e){}
        try{ localStorage.setItem(COUNTER_KEY, String(counter||0)); }catch(e){}
      }
      function maxId(arr){
        var m=0;
        for(var i=0;i<(arr?arr.length:0);i++){
          var id = Number(arr[i] && arr[i].id);
          if(Number.isFinite(id) && id>m) m=id;
        }
        return m;
      }

      // ===== Dictionaries =====
      function loadDict(key, fallback){
        try{
          var obj = safeJSON(localStorage.getItem(key));
          if(obj && typeof obj==="object") return obj;
        }catch(e){}
        return fallback || {};
      }
      function saveDict(key, obj){ try{ localStorage.setItem(key, JSON.stringify(obj||{})); }catch(e){} }
      function dictToList(obj){
        var out = [];
        for(var k in (obj||{})){
          if(Object.prototype.hasOwnProperty.call(obj,k)){
            var v = norm(obj[k]);
            if(v) out.push(v);
          }
        }
        return out;
      }
      function uniqSorted(list){
        var set = new Set();
        for(var i=0;i<list.length;i++){ var v = norm(list[i]); if(v) set.add(v); }
        return Array.from(set).sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });
      }

      var tradeDict = loadDict(TRADE_DICT_KEY, {});
      var sysDict = loadDict(SYS_DICT_KEY, {});
      var sourceDict = loadDict(SOURCE_DICT_KEY, {});
      var tradeSysMap = loadDict(TRADE_SYS_MAP_KEY, {});

      function ensureDictFromDb(){
        var trades = [], systems = [], sources = [];
        for(var i=0;i<db.length;i++){
          if(db[i].deleted) continue;
          if(db[i].trade) trades.push(db[i].trade);
          if(db[i].system) systems.push(db[i].system);
          if(db[i].source) sources.push(db[i].source);
        }
        var tU = uniqSorted(trades), sU = uniqSorted(systems), soU = uniqSorted(sources);
        for(i=0;i<tU.length;i++) tradeDict[tU[i]] = tU[i];
        for(i=0;i<sU.length;i++) sysDict[sU[i]] = sU[i];
        for(i=0;i<soU.length;i++) sourceDict[soU[i]] = soU[i];
        saveDict(TRADE_DICT_KEY, tradeDict);
        saveDict(SYS_DICT_KEY, sysDict);
        saveDict(SOURCE_DICT_KEY, sourceDict);
      }

      function bindSystemToTrade(trade, system){
        trade = norm(trade); system = norm(system);
        if(!trade || !system) return;
        var arr = Array.isArray(tradeSysMap[trade]) ? tradeSysMap[trade] : [];
        if(arr.indexOf(system)<0) arr.push(system);
        tradeSysMap[trade] = uniqSorted(arr);
        saveDict(TRADE_SYS_MAP_KEY, tradeSysMap);
      }

      // ===== UI =====
      function setReadMode(on){
        on = !!on;
        document.body.classList.toggle("readMode", on);
        try{ localStorage.setItem(READ_MODE_KEY, on ? "1" : "0"); }catch(e){}
        $("btnRead").querySelector(".t").textContent = "閱讀模式：" + (on ? "開" : "關");
      }
      function getReadMode(){
        try{ return (localStorage.getItem(READ_MODE_KEY)||"") === "1"; }catch(e){}
        return false;
      }

      function currentUser(){
        return Auth.current ? Auth.current() : null;
      }

      function updateTopbar(){
        var u = currentUser();
        $("uName").textContent = u && u.username ? u.username : "—";
        $("uRole").textContent = Auth.role ? (Auth.role() || "—") : "—";

        var canWrite = Auth.canWrite ? Auth.canWrite() : (Auth.role && /^(admin|write)$/i.test(Auth.role()||""));
        $("btnAdd").style.display = canWrite ? "inline-block" : "none";
        $("btnEdit").style.display = canWrite ? "inline-block" : "none";
        $("btnToken").style.display = (Auth.isAdmin && Auth.isAdmin()) ? "inline-block" : "none";
      }

      function rowMatches(r){
        var qt = norm($("qText").value).toLowerCase();
        var ft = norm($("fTrade").value);
        var fs = norm($("fSys").value);

        if(ft && r.trade !== ft) return false;
        if(fs && r.system !== fs) return false;

        if(qt){
          var blob = ((r.text||"") + " " + (r.remark||"") + " " + (r.source||"")).toLowerCase();
          if(blob.indexOf(qt) < 0) return false;
        }
        return true;
      }

      function filteredRows(){
        var out = [];
        for(var i=0;i<db.length;i++){
          var r = db[i];
          if(r && r.deleted) continue;
          if(rowMatches(r)) out.push(r);
        }
        out.sort(function(a,b){ return (a.id||0) - (b.id||0); });
        return out;
      }

      function renderFilters(){
        // trade options
        var trades = uniqSorted(dictToList(tradeDict).concat(db.map(function(r){return r.trade;})));
        var tradeSel = $("fTrade");
        var curT = tradeSel.value;
        tradeSel.innerHTML = '<option value="">全部</option>' + trades.map(function(t){ return '<option value="'+escHtml(t)+'">'+escHtml(t)+'</option>'; }).join("");
        tradeSel.value = trades.indexOf(curT)>=0 ? curT : "";

        // sys options (global, but if trade selected -> only those bound)
        var curTrade = norm(tradeSel.value);
        var sysList = [];
        if(curTrade && Array.isArray(tradeSysMap[curTrade]) && tradeSysMap[curTrade].length){
          sysList = tradeSysMap[curTrade].slice();
        }else{
          sysList = uniqSorted(dictToList(sysDict).concat(db.map(function(r){return r.system;})));
        }
        var sysSel = $("fSys");
        var curS = sysSel.value;
        sysSel.innerHTML = '<option value="">全部</option>' + sysList.map(function(s){ return '<option value="'+escHtml(s)+'">'+escHtml(s)+'</option>'; }).join("");
        sysSel.value = sysList.indexOf(curS)>=0 ? curS : "";
      }

      function renderTable(rows){
        var canWrite = Auth.canWrite ? Auth.canWrite() : false;
        var tbody = $("tbody");
        var html = "";
        for(var i=0;i<rows.length;i++){
          var r = rows[i];
          var sel = (r.uid === selectedUid) ? ' class="sel"' : "";
          var att = r.attach ? ('<button class="attBtn" type="button" data-att="'+escHtml(r.attach)+'"><span class="t">開啟</span></button>') : '<span class="muted">—</span>';
          var ops = '<button class="btn ghost small" type="button" data-op="view" data-uid="'+escHtml(r.uid)+'"><span class="t">查看</span></button>';
          if(canWrite){
            ops += ' <button class="btn small" type="button" data-op="edit" data-uid="'+escHtml(r.uid)+'"><span class="t">編輯</span></button>';
          }
          html += '<tr'+sel+' data-uid="'+escHtml(r.uid)+'">'
            + '<td style="text-align:center; font-weight:900;">'+escHtml(String(r.id||""))+'</td>'
            + '<td>'+escHtml(r.text||"")+'</td>'
            + '<td style="text-align:center;">'+escHtml(r.trade||"")+'</td>'
            + '<td style="text-align:center;">'+escHtml(r.system||"")+'</td>'
            + '<td style="text-align:center;">'+escHtml(r.source||"")+'</td>'
            + '<td style="text-align:center;">'+att+'</td>'
            + '<td>'+escHtml(r.remark||"")+'</td>'
            + '<td style="text-align:center;">'+escHtml(r.date||"")+'</td>'
            + '<td style="text-align:center; white-space:nowrap;">'+ops+'</td>'
            + '</tr>';
        }
        tbody.innerHTML = html || '<tr><td colspan="9" style="text-align:center; padding:18px; color:rgba(0,0,0,.55); font-weight:900;">（目前沒有資料）</td></tr>';

        // wire attachments
        var btns = tbody.querySelectorAll('button[data-att]');
        for(i=0;i<btns.length;i++){
          btns[i].addEventListener("click", function(ev){
            ev.stopPropagation();
            var href = this.getAttribute("data-att") || "";
            openAttachment(href);
          });
        }
        var opsBtn = tbody.querySelectorAll('button[data-op]');
        for(i=0;i<opsBtn.length;i++){
          opsBtn[i].addEventListener("click", function(ev){
            ev.stopPropagation();
            var uid = this.getAttribute("data-uid");
            var op = this.getAttribute("data-op");
            if(uid) selectUid(uid);
            if(op==="view") openModal("view", uid);
            if(op==="edit") openModal("edit", uid);
          });
        }
        var trs = tbody.querySelectorAll("tr[data-uid]");
        for(i=0;i<trs.length;i++){
          trs[i].addEventListener("click", function(){
            var uid = this.getAttribute("data-uid");
            if(uid) selectUid(uid);
          });
        }
      }

      function renderCards(rows){
        var canWrite = Auth.canWrite ? Auth.canWrite() : false;
        var wrap = $("cards");
        if(!rows.length){
          wrap.innerHTML = '<div class="noteCard" style="text-align:center; cursor:default;"><div class="noteBody">（目前沒有資料）</div></div>';
          return;
        }
        var html = "";
        for(var i=0;i<rows.length;i++){
          var r = rows[i];
          var sel = (r.uid === selectedUid) ? " sel" : "";
          html += '<div class="noteCard'+sel+'" data-uid="'+escHtml(r.uid)+'">'
            + '<div class="noteHead">'
              + '<div class="noteMeta">'
                + '<span class="noteTag">'+escHtml(r.trade||"")+'</span>'
                + '<span class="noteTag">'+escHtml(r.system||"")+'</span>'
                + '<span class="noteTag">'+escHtml(r.source||"")+'</span>'
              + '</div>'
              + '<div class="noteNo">#'+escHtml(String(r.id||""))+' · '+escHtml(r.date||"")+'</div>'
            + '</div>'
            + '<div class="noteBody">'+escHtml(r.text||"")+'</div>'
            + '<div class="noteMore">'
              + (r.attach ? '<div style="margin-top:10px;"><button class="attBtn" type="button" data-att="'+escHtml(r.attach)+'"><span class="t">附件</span></button></div>' : '')
              + (r.remark ? '<div class="noteBody" style="opacity:.86; margin-top:10px;"><b>備註：</b>'+escHtml(r.remark)+'</div>' : '')
              + '<div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">'
                + '<button class="btn ghost small" type="button" data-op="view" data-uid="'+escHtml(r.uid)+'"><span class="t">查看</span></button>'
                + (canWrite ? '<button class="btn small" type="button" data-op="edit" data-uid="'+escHtml(r.uid)+'"><span class="t">編輯</span></button>' : '')
              + '</div>'
            + '</div>'
          + '</div>';
        }
        wrap.innerHTML = html;

        var cards = wrap.querySelectorAll(".noteCard");
        for(i=0;i<cards.length;i++){
          cards[i].addEventListener("click", function(){
            var uid = this.getAttribute("data-uid");
            if(uid) selectUid(uid);
            this.classList.toggle("open");
          });
        }
        var btnAtt = wrap.querySelectorAll('button[data-att]');
        for(i=0;i<btnAtt.length;i++){
          btnAtt[i].addEventListener("click", function(ev){
            ev.stopPropagation();
            openAttachment(this.getAttribute("data-att")||"");
          });
        }
        var btnOp = wrap.querySelectorAll('button[data-op]');
        for(i=0;i<btnOp.length;i++){
          btnOp[i].addEventListener("click", function(ev){
            ev.stopPropagation();
            var uid = this.getAttribute("data-uid");
            var op = this.getAttribute("data-op");
            if(uid) selectUid(uid);
            if(op==="view") openModal("view", uid);
            if(op==="edit") openModal("edit", uid);
          });
        }
      }

      function renderHint(){
        var rows = filteredRows();
        var total = db.length;
        var shown = rows.length;
        var u = currentUser();
        var name = u && u.username ? u.username : "—";
        var role = Auth.role ? (Auth.role() || "—") : "—";

        var cloudTxt = "離線";
        if(cloudState==="ok") cloudTxt = "OK";
        if(cloudState==="deny") cloudTxt = "Token/權限不足";
        if(cloudState==="neterr") cloudTxt = "連線失敗";
        if(cloudState==="noapi") cloudTxt = "未設定";
        if(cloudState==="notfound") cloudTxt = "找不到檔案";
        if(cloudState==="readonly") cloudTxt = "僅讀";
        var syncTxt = lastSyncAt ? fmtClock(lastSyncAt) : "—";

        $("hint").innerHTML =
          '<span class="hb"><span class="k">使用者</span><span class="v">'+escHtml(name)+'</span></span>'
          +'<span class="hb"><span class="k">權限</span><span class="v">'+escHtml(role)+'</span></span>'
          +'<span class="hb"><span class="k">顯示</span><span class="v">'+escHtml(String(shown))+'</span></span>'
          +'<span class="hb"><span class="k">總筆數</span><span class="v">'+escHtml(String(total))+'</span></span>'
          +'<span class="hb '+((cloudState==="ok")?"":"bad")+'"><span class="k">雲端</span><span class="v">'+escHtml(cloudTxt)+'</span></span>'
          +'<span class="hb"><span class="k">同步</span><span class="v">'+escHtml(syncTxt)+'</span></span>';
      }

      function renderAll(){
        renderFilters();
        var rows = filteredRows();
        renderTable(rows);
        renderCards(rows);
        renderHint();
      }

      function selectUid(uid){
        selectedUid = uid;
        renderAll();
      }

      function openAttachment(href){
        var h = (href ?? "").toString().trim();
        if(!h) return;
        if(/^https?:\/\//i.test(h) || /^mailto:/i.test(h) || /^file:/i.test(h)){
          window.open(h, "_blank", "noopener");
          return;
        }
        location.href = withV(h);
      }

      // ===== Modal =====
      function setModalVisible(on){ $("mask").style.display = on ? "flex" : "none"; }
      function setModalEditable(editable){
        editable = !!editable;
        $("mText").disabled = !editable;
        $("mTradeSel").disabled = !editable;
        $("mSysSel").disabled = !editable;
        $("mSourceSel").disabled = !editable;
        $("mAttach").disabled = !editable;
        $("mRemark").disabled = !editable;
        $("mDate").disabled = !editable;

        $("btnAddTrade").disabled = !editable;
        $("btnAddSys").disabled = !editable;
        $("btnAddSource").disabled = !editable;
        $("btnSave").style.display = editable ? "inline-block" : "none";
        $("btnCancel").style.display = editable ? "inline-block" : "none";

        // ✅ delete：write/admin 都可刪（read 不可）
        var canWrite = Auth.canWrite ? Auth.canWrite() : false;
        $("btnDelete").style.display = (editable && canWrite && editingUid != null) ? "inline-block" : "none";
      }

      function fillModalFromRow(r){
        $("mText").value = r ? (r.text||"") : "";
        $("mAttach").value = r ? (r.attach||"") : "";
        $("mRemark").value = r ? (r.remark||"") : "";
        $("mDate").value = r ? (r.date||"") : todayISO();
        $("mNo").value = r ? String(r.id||"") : String(counter + 1);
      }

      function renderModalSelects(curTrade, curSys, curSource){
        curTrade = norm(curTrade); curSys = norm(curSys); curSource = norm(curSource);
        var trades = uniqSorted(dictToList(tradeDict).concat(db.map(function(r){return r.trade;})));
        var sources = uniqSorted(dictToList(sourceDict).concat(db.map(function(r){return r.source;})));

        var tSel = $("mTradeSel");
        tSel.innerHTML = trades.map(function(t){ return '<option value="'+escHtml(t)+'">'+escHtml(t)+'</option>'; }).join("");
        if(!tSel.innerHTML) tSel.innerHTML = '<option value=""></option>';
        if(trades.indexOf(curTrade)>=0) tSel.value = curTrade;

        // systems filtered by trade
        var sysList = [];
        if(curTrade && Array.isArray(tradeSysMap[curTrade]) && tradeSysMap[curTrade].length){
          sysList = tradeSysMap[curTrade].slice();
        }else{
          sysList = uniqSorted(dictToList(sysDict).concat(db.map(function(r){return r.system;})));
        }
        var sSel = $("mSysSel");
        sSel.innerHTML = sysList.map(function(s){ return '<option value="'+escHtml(s)+'">'+escHtml(s)+'</option>'; }).join("");
        if(!sSel.innerHTML) sSel.innerHTML = '<option value=""></option>';
        if(sysList.indexOf(curSys)>=0) sSel.value = curSys;

        var soSel = $("mSourceSel");
        soSel.innerHTML = sources.map(function(s){ return '<option value="'+escHtml(s)+'">'+escHtml(s)+'</option>'; }).join("");
        if(!soSel.innerHTML) soSel.innerHTML = '<option value=""></option>';
        if(sources.indexOf(curSource)>=0) soSel.value = curSource;
      }

      function openModal(mode, uid){
        var canWrite = Auth.canWrite ? Auth.canWrite() : false;
        mode = mode || "view";
        if((mode==="edit" || mode==="add") && !canWrite){
          toast("唯讀模式不可編輯");
          mode = "view";
        }

        var r = null;
        editingUid = null;
        if(mode==="add"){
          editingUid = null;
          counter = Math.max(counter, maxId(db));
          $("mTitle").textContent = "新增";
          renderModalSelects("", "", "");
          fillModalFromRow(null);
          setModalEditable(true);
        }else{
          r = db.find(function(x){ return x.uid === uid && !x.deleted; }) || null;
          if(!r){ toast("找不到資料"); return; }
          editingUid = r.uid;
          $("mTitle").textContent = (mode==="edit") ? "編輯" : "查看";
          renderModalSelects(r.trade, r.system, r.source);
          fillModalFromRow(r);
          setModalEditable(mode==="edit");
        }

        setModalVisible(true);
      }

      function closeModal(){ setModalVisible(false); }

      function saveModal(){
        var canWrite = Auth.canWrite ? Auth.canWrite() : false;
        if(!canWrite){ toast("唯讀模式不可儲存"); return; }

        var text = $("mText").value.trim();
        if(!text){ toast("請輸入記事內容"); return; }

        var trade = norm($("mTradeSel").value);
        var system = norm($("mSysSel").value);
        var source = norm($("mSourceSel").value);
        var attach = norm($("mAttach").value);
        var remark = $("mRemark").value || "";
        var date = norm($("mDate").value) || todayISO();

        if(trade) tradeDict[trade] = trade;
        if(system) sysDict[system] = system;
        if(source) sourceDict[source] = source;
        saveDict(TRADE_DICT_KEY, tradeDict);
        saveDict(SYS_DICT_KEY, sysDict);
        saveDict(SOURCE_DICT_KEY, sourceDict);
        if(trade && system) bindSystemToTrade(trade, system);

        if(editingUid==null){
          counter = Math.max(counter, maxId(db));
          var id = counter + 1;
          counter = id;
          var now = new Date().toISOString();
          var row = { uid: uuid(), id:id, text:text, trade:trade, system:system, source:source, attach:attach, remark:remark, date:date, rev: ("r"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16)), updatedAt: now, deleted:false };
          db.push(row);
          selectedUid = row.uid;
        }else{
          var r = db.find(function(x){ return x.uid === editingUid; });
          if(!r){ toast("找不到資料"); return; }
          var now2 = new Date().toISOString();
          r.text = text; r.trade = trade; r.system = system; r.source = source; r.attach = attach; r.remark = remark; r.date = date;
          r.deleted = false;
          r.updatedAt = now2;
          r.rev = "r"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16);
          selectedUid = r.uid;
        }

        db.sort(function(a,b){
          var da = a && a.deleted ? 1 : 0;
          var dbb = b && b.deleted ? 1 : 0;
          if(da!==dbb) return da-dbb;
          var ia = Number(a && a.id || 0); if(!Number.isFinite(ia)) ia = 0;
          var ib = Number(b && b.id || 0); if(!Number.isFinite(ib)) ib = 0;
          if(ia!==ib) return ia-ib;
          var ta = a && a.updatedAt ? String(a.updatedAt) : "";
          var tb = b && b.updatedAt ? String(b.updatedAt) : "";
          if(ta!==tb) return ta<tb?-1:1;
          return String(a && a.uid || "").localeCompare(String(b && b.uid || ""));
        });
        counter = Math.max(counter, maxId(db));
        saveLocal();
        ensureDictFromDb();
        renderAll();
        closeModal();

        if(cloud) cloud.saveMerged();
        toast("已儲存");
      }

      function deleteItem(){
        var canWrite = Auth.canWrite ? Auth.canWrite() : false;
        if(!canWrite){ toast("唯讀不可刪除"); return; }
        if(editingUid==null){ toast("這筆尚未存在"); return; }
        if(!confirm("確定要刪除這筆資料嗎？")) return;

        var r = db.find(function(x){ return x.uid === editingUid; });
        if(!r){ toast("找不到資料"); return; }

        // ✅ soft-delete (tombstone) for cross-device sync
        r.deleted = true;
        r.updatedAt = new Date().toISOString();
        r.rev = "r"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16);

        saveLocal();
        ensureDictFromDb();

        // select next non-deleted
        var rows = filteredRows();
        selectedUid = rows.length ? rows[0].uid : null;

        closeModal();
        renderAll();
        toast("已刪除");

        if(cloud) cloud.saveMerged();
      }

// ===== Prompt add dict =====
      function openPrompt(mode){
        promptMode = mode; // trade | sys | source
        $("pMask").style.display = "flex";
        $("pInput").value = "";
        $("pInput").type = "text";
        if(mode==="trade"){
          $("pTitle").textContent = "新增工種";
          $("pLabel").textContent = "請輸入工種";
          $("pHint").textContent = "新增後會加入「工種字典」。";
        }else if(mode==="sys"){
          $("pTitle").textContent = "新增系統";
          $("pLabel").textContent = "請輸入系統";
          $("pHint").textContent = "新增後會加入「系統字典」，並綁定到目前工種。";
        }else if(mode==="source"){
          $("pTitle").textContent = "新增出處";
          $("pLabel").textContent = "請輸入出處";
          $("pHint").textContent = "新增後會加入「出處字典」。";
        }
        setTimeout(function(){ $("pInput").focus(); }, 0);
      }
      function closePrompt(){ $("pMask").style.display = "none"; promptMode = null; }
      function confirmPrompt(){
        var v = norm($("pInput").value);
        if(!v){ toast("請輸入內容"); return; }
        if(promptMode==="trade"){
          tradeDict[v]=v; saveDict(TRADE_DICT_KEY, tradeDict);
          $("mTradeSel").value = v;
          renderModalSelects(v, $("mSysSel").value, $("mSourceSel").value);
        }else if(promptMode==="sys"){
          sysDict[v]=v; saveDict(SYS_DICT_KEY, sysDict);
          var trade = norm($("mTradeSel").value);
          if(trade) bindSystemToTrade(trade, v);
          renderModalSelects(trade, v, $("mSourceSel").value);
          $("mSysSel").value = v;
        }else if(promptMode==="source"){
          sourceDict[v]=v; saveDict(SOURCE_DICT_KEY, sourceDict);
          renderModalSelects($("mTradeSel").value, $("mSysSel").value, v);
          $("mSourceSel").value = v;
        }
        closePrompt();
        toast("已新增");
      }

      // ===== Export =====
      function exportBackup(){
        var payload = { ts: Date.now(), page: PAGE_KEY, db: db, counter: counter };
        var blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json;charset=utf-8" });
        var a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "sxdh-notes-backup_" + todayISO().replaceAll("-","") + ".json";
        document.body.appendChild(a);
        a.click();
        setTimeout(function(){ URL.revokeObjectURL(a.href); a.remove(); }, 0);
        toast("已匯出備份");
      }

      // ===== Cloud settings modal =====
      function parseCloudCfgInput(raw){
        raw = norm(raw);
        if(!raw) return null;

        // Allow paste: raw URL
        // https://raw.githubusercontent.com/OWNER/REPO/BRANCH/PATH
        var m1 = raw.match(/raw\.githubusercontent\.com\/([^\/]+)\/([^\/]+)\/([^\/]+)\/(.+)/i);
        if(m1){
          return { ownerRepo: (m1[1]+"/"+m1[2]), branch: m1[3], path: m1[4], token: "" };
        }

        // Allow paste: blob URL
        // https://github.com/OWNER/REPO/blob/BRANCH/PATH
        var m2 = raw.match(/github\.com\/([^\/]+)\/([^\/]+)\/blob\/([^\/]+)\/(.+)/i);
        if(m2){
          return { ownerRepo: (m2[1]+"/"+m2[2]), branch: m2[3], path: m2[4], token: "" };
        }

        // Split parts: owner/repo | branch | path | token
        var parts = raw
          .replace(/[\u2460-\u2469]/g," ")
          .replace(/[①②③④⑤⑥⑦⑧⑨]/g," ")
          .replace(/(OWNER\/REPO|BRANCH|PATH|GH_TOKEN|TOKEN)/gi," ")
          .replace(/[=：:]/g," ")
          .replace(/\s+/g," ")
          .trim()
          .split(/[\s|,;]+/).map(norm).filter(Boolean);

        // If only token pasted
        if(parts.length===1 && parts[0].length>=20 && !parts[0].includes("/")){
          return { ownerRepo:"", branch:"", path:"", token: parts[0] };
        }

        return { ownerRepo: parts[0]||"", branch: parts[1]||"", path: parts[2]||"", token: parts[3]||"" };
      }

      function openTokenMask(){
        if(!(Auth.isAdmin && Auth.isAdmin())){ toast("僅 admin 可設定雲端"); return; }
        $("tokenMask").style.display = "flex";
        var cfg = getRepoCfg();
        $("tokenHint").textContent =
          "目前狀態：OWNER/REPO=" + (cfg.ownerRepo||"未設定")
          + "，BRANCH=" + (cfg.branch||"未設定")
          + "，PATH=" + (cfg.path||"未設定")
          + "，GH_TOKEN=" + (norm(cfg.token) ? "已設定" : "未設定（公開 repo 可僅讀）");
        $("tokenErr").style.display = "none";
        $("tokenErr").textContent = "";
        $("tokenInput").value = "";
        setTimeout(function(){ $("tokenInput").focus(); }, 0);
      }
      function closeTokenMask(){ $("tokenMask").style.display = "none"; }
      function saveTokenMask(){
        var cfg0 = getRepoCfg();
        var cfg = parseCloudCfgInput($("tokenInput").value);
        if(!cfg){ toast("請貼上內容"); return; }

        var next = { ownerRepo: cfg0.ownerRepo, branch: cfg0.branch, path: cfg0.path, token: cfg0.token };

        if(cfg.ownerRepo && cfg.branch && cfg.path){
          next.ownerRepo = cfg.ownerRepo;
          next.branch = cfg.branch;
          next.path = cfg.path;
        }
        if(cfg.token){
          next.token = cfg.token;
        }
        setRepoCfg(next);

        toast("已儲存雲端設定");
        closeTokenMask();
        startCloud(true);
      }
      function clearTokenMask(){
        if(!confirm("確定要清除雲端設定（repo/path/GH_TOKEN）？")) return;
        try{ sessionStorage.removeItem(GH_CFG_KEY); }catch(e){}
        try{ localStorage.removeItem(GH_CFG_KEY); }catch(e){}
        try{ sessionStorage.removeItem(GH_TOKEN_KEY); }catch(e){}
        try{ localStorage.removeItem(GH_TOKEN_KEY); }catch(e){}
        try{ window.TASUN_GH_TOKEN = ""; }catch(e){}
        toast("已清除（回到預設 repo；GH_TOKEN 已移除）");
        closeTokenMask();
        cloudState = "offline";
        renderHint();
      }
      function toggleTokenInput(){
        var el = $("tokenInput");
        el.type = (el.type==="password") ? "text" : "password";
      }

      function openCloudPortal(){
        var u = portalUrl();
        if(!u){ toast("尚未設定 GitHub 檔案位置"); return; }
        window.open(u, "_blank", "noopener");
      }

      function startCloud(forceNow){
        if(!cloud) cloud = new CloudCtrl();
        var cfg = getRepoCfg();
        if(!cfg.ownerRepo || !cfg.branch || !cfg.path){
          cloudState = "noapi";
          renderHint();
          return;
        }
        cloud.startWatch(30);
        if(forceNow) cloud.pullNow();
      }

// ===== Auth integration =====
      function wireLoginUI(){
        $("btnView").addEventListener("click", function(){ Auth.openLogin && Auth.openLogin(); });
        $("loginClose").addEventListener("click", function(){ Auth.closeLogin && Auth.closeLogin(); });
        $("loginToAuth").addEventListener("click", function(){ location.href = withV("權限表.html"); });
        $("loginBtn").addEventListener("click", function(){
          var u = $("loginUser").value;
          var p = $("loginPass").value;
          var ok = Auth.login ? Auth.login(u,p) : false;
          if(!ok){
            $("loginErr").style.display="block";
            $("loginErr").textContent="帳號或密碼錯誤";
          }
        });
      }

      // ===== Events =====
      function wireEvents(){
        $("navBack").addEventListener("click", function(){ location.href = withV("汐東工程管理表.html"); });
        $("mBack").addEventListener("click", function(){ location.href = withV("汐東工程管理表.html"); });
        $("mMoreBtn").addEventListener("click", function(){
          var m = $("mMoreMenu");
          m.style.display = (m.style.display==="none" || !m.style.display) ? "block" : "none";
        });
        document.addEventListener("click", function(ev){
          var menu = $("mMoreMenu");
          var btn = $("mMoreBtn");
          if(!menu || menu.style.display!=="block") return;
          if(ev.target===btn || btn.contains(ev.target)) return;
          if(menu.contains(ev.target)) return;
          menu.style.display = "none";
        });
        var items = document.querySelectorAll(".menuItem[data-href]");
        for(var i=0;i<items.length;i++){
          items[i].addEventListener("click", function(){
            var href = this.getAttribute("data-href");
            if(href) location.href = withV(href);
          });
        }

        $("btnAdd").addEventListener("click", function(){ openModal("add"); });
        $("btnEdit").addEventListener("click", function(){
          if(!selectedUid){ toast("請先點選一筆資料"); return; }
          openModal("edit", selectedUid);
        });

        $("btnToken").addEventListener("click", openTokenMask);

        $("btnCloud").addEventListener("click", function(){
          openCloudPortal();
          if(cloud) cloud.pullNow();
        });

        $("btnExport").addEventListener("click", exportBackup);

        $("btnClear").addEventListener("click", function(){
          $("qText").value = "";
          $("fTrade").value = "";
          $("fSys").value = "";
          renderAll();
        });

        $("btnRead").addEventListener("click", function(){
          setReadMode(!document.body.classList.contains("readMode"));
        });

        $("qText").addEventListener("input", function(){ renderAll(); });
        $("fTrade").addEventListener("change", function(){
          renderFilters();
          renderAll();
        });
        $("fSys").addEventListener("change", function(){ renderAll(); });

        $("btnClose").addEventListener("click", closeModal);
        $("btnCancel").addEventListener("click", closeModal);
        $("btnSave").addEventListener("click", saveModal);
        $("btnDelete").addEventListener("click", deleteItem);

        $("btnAddTrade").addEventListener("click", function(){ openPrompt("trade"); });
        $("btnAddSys").addEventListener("click", function(){ openPrompt("sys"); });
        $("btnAddSource").addEventListener("click", function(){ openPrompt("source"); });

        $("pClose").addEventListener("click", closePrompt);
        $("pCancel").addEventListener("click", closePrompt);
        $("pOk").addEventListener("click", confirmPrompt);
        $("pInput").addEventListener("keydown", function(ev){ if(ev.key==="Enter"){ ev.preventDefault(); confirmPrompt(); } });

        $("btnNetDisk").addEventListener("click", function(){ window.open(NET_DISK_URL, "_blank", "noopener"); });

        $("tokenClose").addEventListener("click", closeTokenMask);
        $("tokenSave").addEventListener("click", saveTokenMask);
        $("tokenClear").addEventListener("click", clearTokenMask);
        $("tokenToggle").addEventListener("click", toggleTokenInput);
        $("tokenNetDisk").addEventListener("click", function(){ window.open(GITHUB_TOKENS_URL, "_blank", "noopener"); });

        $("mTradeSel").addEventListener("change", function(){
          var trade = norm($("mTradeSel").value);
          renderModalSelects(trade, "", $("mSourceSel").value);
        });
      }

      // ===== Boot =====
      loadLocal();
      ensureDictFromDb();

      wireLoginUI();
      wireEvents();

      setReadMode(getReadMode());

      renderAll();

      Auth.onChange && Auth.onChange(function(){
        updateTopbar();
        renderAll();
        startCloud(true);
      });
      updateTopbar();

      startCloud(true);
    }

    if(window.__TASUN_WAIT__ && typeof window.__TASUN_WAIT__.push === "function"){
      window.__TASUN_WAIT__.push(run);
    }else{
      document.addEventListener("DOMContentLoaded", run);
    }
  })();
  </script>
</body>
</html>
