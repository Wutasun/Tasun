<script>
(function(){
  "use strict";

  function run(){
    var Core = window.TasunCore;
    if(!Core || !Core.Auth){
      console.error("TasunCore/Auth not ready.");
      return;
    }

    var PAGE_KEY = "sxdh-notes";

    Core.init({
      pageKey: PAGE_KEY,
      forceUrlV: true,
      forceVersionSync: true,
      patchResources: true,
      networkToast: false,
      appHeightVar: false
    });

    var Auth = Core.Auth;
    var withV = Core.withV;

    // ===============================
    // ✅ Local keys
    // ===============================
    var DB_KEY      = "tasunSxdhNotes_v1";
    var COUNTER_KEY = "tasunSxdhNotes_counter_v1";

    // ✅ 明細 key：用來自動帶出附件連結
    var DETAIL_KEY  = "tasunSxdhDetail_v1";

    var BACKUP_KEY  = DB_KEY + "__backup_v1";
    var BK1_KEY     = DB_KEY + "__backup_1";
    var BK2_KEY     = DB_KEY + "__backup_2";
    var BK3_KEY     = DB_KEY + "__backup_3";

    var EXPORT_LAST_KEY = DB_KEY + "__export_last_v1";
    var LEAVE_SNAP_KEY  = DB_KEY + "__leave_snapshot_v1";

    var SAFETY_SNAPSHOT_KEY = DB_KEY + "__safety_snapshot_v1";
    var PROTECT_EMPTY_REMOTE_KEY = "tasun_protect_empty_remote__" + DB_KEY;

    var LEGACY_DB_KEYS = [
      "tasunSxdhNotes_v1","tasunSxdhNotes_v0","tasunSxdhNotes",
      "tasunXidongNotes_v1","tasunXidongNotes_v0","tasunXidongNotes",
      "tasunNotes_sxdh_v1","tasunNotes_xidong_v1"
    ];
    var LEGACY_COUNTER_KEYS = [
      COUNTER_KEY,
      "tasunSxdhNotes_counter_v0",
      "tasunXidongNotes_counter_v1","tasunXidongNotes_counter_v0",
      "tasunNotes_sxdh_counter_v1","tasunNotes_xidong_counter_v1"
    ];

    var TRADE_DICT_KEY = "tasunSxdhNotes_tradeDict_v1";
    var SYS_DICT_KEY   = "tasunSxdhNotes_sysDict_v1";
    var TRADE_SYS_MAP_KEY = "tasunSxdhNotes_tradeSysMap_v1";
    var SOURCE_DICT_KEY = "tasunSxdhNotes_sourceDict_v1";
    var READ_MODE_KEY  = "tasunSxdhNotes_readMode_v1";

    var CLOUD_URL = "https://www.dropbox.com/scl/fo/glb4s65934h195bxuyuqm/AH5ClZ2u4MtPMvmgtfOUAa4?rlkey=tfxkpbpw8k9bctshx5xvuge8h&st=guo88r98&dl=0";

    var DROPBOX_TOKEN_KEY = "tasunDropboxToken_v1";

    // ===============================
    // ✅ Cloud resource binding
    // ===============================
    var CLOUD_RESOURCE_KEY = "tasun-index-db";
    var CLOUD_PK = "id";
    var SETTINGS_UID = "__settings__";

    var db = [];
    var editingUid = null;
    var selectedUid = null;
    var promptMode = null;

    var cloud = null;
    var cloudInited = false;

    var lastCloudSyncAt = 0;

    var $ = function(id){ return document.getElementById(id); };
    var norm = function(s){ return (s===undefined||s===null) ? "" : String(s).trim(); };

    function pad2(n){ return String(n).padStart(2,"0"); }
    function fmtClock(ts){
      if(!ts) return "";
      var d = new Date(ts);
      return pad2(d.getHours()) + ":" + pad2(d.getMinutes()) + ":" + pad2(d.getSeconds());
    }

    function uuid(){
      var a = Math.random().toString(16).slice(2);
      return "u" + Date.now().toString(16) + "_" + a;
    }

    function toast(msg){
      var t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._tm);
      toast._tm = setTimeout(function(){ t.style.display = "none"; }, 2600);
    }

    function escHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function fnv1a(str2){
      var h = 0x811c9dc5;
      for(var i=0;i<str2.length;i++){
        h ^= str2.charCodeAt(i);
        h = Math.imul(h, 0x01000193);
      }
      return (h >>> 0).toString(16).padStart(8, "0");
    }

    function safeParseJSON(raw){
      if(!raw) return null;
      try{ return JSON.parse(raw); }catch(e){ return null; }
    }

    // ===============================
    // ✅ Backups / snapshots
    // ===============================
    function rotateBackups(snapshotArr){
      var snap = { ts: Date.now(), db: snapshotArr };
      try{
        var b1 = localStorage.getItem(BK1_KEY);
        var b2 = localStorage.getItem(BK2_KEY);
        if(b2) localStorage.setItem(BK3_KEY, b2);
        if(b1) localStorage.setItem(BK2_KEY, b1);
        localStorage.setItem(BK1_KEY, JSON.stringify(snap));
        localStorage.setItem(BACKUP_KEY, JSON.stringify(snap));
      }catch(e){}
    }

    function getSafetySnapshotDb(){
      try{
        var obj = safeParseJSON(localStorage.getItem(SAFETY_SNAPSHOT_KEY));
        if(obj && typeof obj === "object" && Array.isArray(obj.db) && obj.db.length>0) return obj.db;
      }catch(e){}
      return null;
    }

    function saveSafetySnapshot(reason){
      try{
        if(!Array.isArray(db) || db.length===0) return;
        var cur = safeParseJSON(localStorage.getItem(SAFETY_SNAPSHOT_KEY));
        var curLen = (cur && Array.isArray(cur.db)) ? cur.db.length : 0;
        if(db.length >= curLen){
          localStorage.setItem(SAFETY_SNAPSHOT_KEY, JSON.stringify({ ts: Date.now(), reason: reason||"", db: db }));
        }
      }catch(e){}
    }

    function restoreFromSafetySnapshot(quiet){
      quiet = !!quiet;
      var safeDb = getSafetySnapshotDb();
      if(!Array.isArray(safeDb) || safeDb.length===0) return false;
      db = safeDb.map(normalizeRow).filter(Boolean);
      if(db.length===0) return false;
      try{
        rotateBackups(db);
        localStorage.setItem(DB_KEY, JSON.stringify(db));
      }catch(e){}
      if(!quiet) toast("已由安全快照自動還原資料");
      return true;
    }

    function backupOnExit(reason){
      try{
        var snapDb = Array.isArray(db) ? db : [];
        if(snapDb.length===0){
          var safeDb = getSafetySnapshotDb();
          if(safeDb && safeDb.length>0){
            localStorage.setItem(LEAVE_SNAP_KEY, JSON.stringify({ ts: Date.now(), reason: reason || "exit", db: safeDb, note:"protected_empty_db" }));
            return;
          }
        }
        rotateBackups(snapDb);
        localStorage.setItem(LEAVE_SNAP_KEY, JSON.stringify({ ts: Date.now(), reason: reason || "exit", db: snapDb }));
      }catch(e){}
    }

    function go(href){
      backupOnExit("navigate");
      location.href = withV(href);
    }

    function openAttachment(href){
      var h = (href ?? "").toString().trim();
      if(!h) return;
      if(/^https?:\/\//i.test(h) || /^mailto:/i.test(h) || /^file:/i.test(h)){
        backupOnExit("open_attachment");
        window.open(h, "_blank", "noopener");
        return;
      }
      go(h);
    }

    window.addEventListener("beforeunload", function(){ backupOnExit("beforeunload"); });
    window.addEventListener("pagehide", function(){ backupOnExit("pagehide"); });
    document.addEventListener("visibilitychange", function(){
      if(document.visibilityState === "hidden") backupOnExit("visibility_hidden");
    });

    // ===============================
    // ✅ Row normalize (新增 source 相容)
    // ===============================
    function normalizeRow(x){
      if(!x || typeof x !== "object") return null;

      // ✅ 相容 v1 merge-table：{id,k,v}（真正資料在 v）
      if("v" in x && (x.k !== undefined || x.key !== undefined)){
        var inner = x.v;
        if(typeof inner === "string"){
          var p = safeParseJSON(inner);
          if(p && typeof p === "object") inner = p;
        }
        if(inner && typeof inner === "object"){
          x = Object.assign({}, inner, x);
          if(!x.uid) x.uid = x.k || x.key || "";
        }
      }

      var uid = norm(x.uid ?? x._uid ?? x.pk ?? x.k ?? x.key ?? "");
      var idRaw = (x.id ?? x.no ?? x.idx ?? x.key);
      var id = Number(idRaw);
      if(!Number.isFinite(id) || id <= 0) id = null;

      var text   = (x.text ?? x.content ?? x.note ?? x.memo ?? "").toString();
      var trade  = norm(x.trade ?? x.kind ?? x.type ?? x.work ?? "");
      var system = norm(x.system ?? x.sys ?? x.category ?? "");
      var attach = norm(x.attach ?? x.attachment ?? x.file ?? x.link ?? "");
      var source = norm(x.source ?? x.origin ?? x.from ?? x.src ?? "");
      var remark = (x.remark ?? x.note2 ?? x.desc ?? "").toString();
      var date   = norm(x.date ?? x.day ?? x.created ?? x.createdAt ?? "");

      if(date){
        if(!/^\d{4}-\d{2}-\d{2}$/.test(date)){
          var d = new Date(date);
          if(!isNaN(d.getTime())) date = d.toISOString().slice(0,10);
          else date = "";
        }
      }

      if(!uid){
        if(id) uid = "legacy_" + String(id);
        else uid = uuid();
      }

      return { uid: uid, id: id, text: text, trade: trade, system: system, attach: attach, source: source, remark: remark, date: date };
    }

    function rowKey(r){
      var t = (r.text ?? "").toString().trim().replace(/\s+/g," ");
      var a = (r.attach ?? "").toString().trim();
      var so = (r.source ?? "").toString().trim();
      var rm = (r.remark ?? "").toString().trim().replace(/\s+/g," ");
      return fnv1a((r.date||"") + "|" + (r.trade||"") + "|" + (r.system||"") + "|" + t + "|" + a + "|" + so + "|" + rm);
    }

    // ===============================
    // ✅ NEW：明細 → 主表 附件自動合併（UI 不動）
    // ===============================
    var _detailCache = { sig:"", map:null, count:0 };

    function sigOfRaw(raw){
      raw = raw || "";
      if(raw.length <= 5000) return String(raw.length) + "_" + fnv1a(raw);
      var head = raw.slice(0,2500);
      var tail = raw.slice(-2500);
      return String(raw.length) + "_" + fnv1a(head + "#"+ tail);
    }

    function pickFirstUrlLike(x){
      var s = norm(x);
      if(!s) return "";
      if(/^https?:\/\//i.test(s) || /^file:/i.test(s) || /^mailto:/i.test(s)) return s;
      // 相對連結也允許（同站檔案）
      if(/\.html?(\?|#|$)/i.test(s) || /\//.test(s)) return s;
      return s; // 保守：有些 Dropbox/自訂 schema 可能不是標準 http 開頭
    }

    function extractLinkAny(obj){
      if(!obj) return "";
      if(typeof obj === "string") return pickFirstUrlLike(obj);

      // 常見欄位（含中文）
      var keys = [
        "url","link","href","docUrl","docURL","docLink","docHref",
        "fileUrl","fileURL","downloadUrl","openUrl","openURL",
        "dropbox","dropboxUrl","path",
        "附件","連結","網址"
      ];
      for(var i=0;i<keys.length;i++){
        var k = keys[i];
        if(obj[k] != null){
          if(typeof obj[k] === "string") {
            var v = pickFirstUrlLike(obj[k]);
            if(v) return v;
          }
          if(obj[k] && typeof obj[k] === "object"){
            var v2 = pickFirstUrlLike(obj[k].url || obj[k].link || obj[k].href || obj[k].path);
            if(v2) return v2;
          }
        }
      }

      // 陣列型：files / attachments / docs
      var arrKeys = ["files","attachments","docs","items","links","附件清單"];
      for(var j=0;j<arrKeys.length;j++){
        var ak = arrKeys[j];
        if(Array.isArray(obj[ak]) && obj[ak].length){
          for(var t=0;t<Math.min(obj[ak].length, 6);t++){
            var vv = extractLinkAny(obj[ak][t]);
            if(vv) return vv;
          }
        }
      }

      // 深一層常見：file / attachment
      if(obj.file && typeof obj.file==="object"){
        var vf = extractLinkAny(obj.file);
        if(vf) return vf;
      }
      if(obj.attachment && typeof obj.attachment==="object"){
        var va = extractLinkAny(obj.attachment);
        if(va) return va;
      }
      return "";
    }

    function normalizeDetailRow(x){
      if(!x || typeof x !== "object") return null;

      // 相容 merge-table
      if("v" in x && (x.k !== undefined || x.key !== undefined)){
        var inner = x.v;
        if(typeof inner === "string"){
          var p = safeParseJSON(inner);
          if(p && typeof p === "object") inner = p;
        }
        if(inner && typeof inner === "object"){
          x = Object.assign({}, inner, x);
        }
      }

      var id = Number(x.id ?? x.noteId ?? x.masterId ?? x.parentId ?? x.pid ?? x.refId ?? x.key ?? 0);
      if(!Number.isFinite(id) || id<=0) return null;

      var docName = norm(x.docName ?? x.name ?? x.title ?? x.doc ?? x.fileName ?? "");
      var url = extractLinkAny(x);
      if(!url && x.v && typeof x.v==="object") url = extractLinkAny(x.v);

      return { id:id, docName:docName, url:norm(url) };
    }

    function detailToMap(){
      var raw = "";
      try{ raw = localStorage.getItem(DETAIL_KEY) || ""; }catch(e){}
      var sig = sigOfRaw(raw);
      if(_detailCache.map && _detailCache.sig === sig) return _detailCache;

      var parsed = safeParseJSON(raw);
      var arr = [];

      if(Array.isArray(parsed)) arr = parsed;
      else if(parsed && typeof parsed==="object"){
        if(Array.isArray(parsed.db)) arr = parsed.db;
        else if(Array.isArray(parsed.rows)) arr = parsed.rows;
        else if(Array.isArray(parsed.items)) arr = parsed.items;
        else if(Array.isArray(parsed.records)) arr = parsed.records;
      }

      var map = {};
      var cnt = 0;

      for(var i=0;i<arr.length;i++){
        var r = normalizeDetailRow(arr[i]);
        if(!r) continue;
        cnt++;
        if(!map[r.id] && r.url){
          map[r.id] = { url:r.url, docName:r.docName || "" };
        }
      }

      _detailCache = { sig:sig, map:map, count:cnt };
      return _detailCache;
    }

    // opts: { persist:boolean, quiet:boolean }
    function mergeDetailIntoMain(opts){
      opts = opts || {};
      var persist = !!opts.persist;
      var quiet = !!opts.quiet;

      if(!Array.isArray(db) || db.length===0) return { changed:false, merged:0, detailCount:0 };

      var dc = detailToMap();
      var map = dc.map || {};
      var merged = 0;
      var changed = false;

      for(var i=0;i<db.length;i++){
        var r = db[i];
        if(!r || !Number.isFinite(Number(r.id))) continue;
        var info = map[Number(r.id)];
        if(!info || !info.url) continue;

        var cur = norm(r.attach || "");
        // ✅ 只補空白，不覆蓋已有 attach
        if(!cur){
          r.attach = info.url;
          merged++;
          changed = true;
        }
      }

      if(changed){
        // 讓畫面立刻出現「開啟」
        if(!quiet) toast("已由明細自動帶入附件：" + merged + " 筆");

        // ✅ 只有 write/admin 才寫回主表 & 推雲端
        if(persist && Auth.canWrite()){
          try{
            saveDB();
          }catch(e){}
          cloudSave("detail_merge");
        }
      }

      return { changed:changed, merged:merged, detailCount:dc.count||0 };
    }

    // ===============================
    // ✅ Legacy merge / load helpers
    // ===============================
    function readBackupCandidates(){
      var keys = [BACKUP_KEY, BK1_KEY, BK2_KEY, BK3_KEY, SAFETY_SNAPSHOT_KEY];
      for(var i=0;i<keys.length;i++){
        var raw = localStorage.getItem(keys[i]);
        var obj = safeParseJSON(raw);
        if(obj && typeof obj === "object"){
          if(Array.isArray(obj.db)) return obj.db;
          if(Array.isArray(obj)) return obj;
        }
      }
      return null;
    }

    function scanUnknownLegacyKeys(){
      var keys = [];
      try{
        for(var i=0;i<localStorage.length;i++){
          var k = localStorage.key(i);
          if(!k) continue;
          var kl = k.toLowerCase();
          if(kl.includes("sxdh") || kl.includes("xidong") || k.includes("汐東")){
            keys.push(k);
          }
        }
      }catch(e){}
      var collected = [];
      for(var j=0;j<keys.length;j++){
        var raw = localStorage.getItem(keys[j]);
        var parsed = safeParseJSON(raw);
        if(!parsed) continue;
        var arr = null;
        if(Array.isArray(parsed)) arr = parsed;
        else if(parsed && Array.isArray(parsed.db)) arr = parsed.db;
        else if(parsed && Array.isArray(parsed.rows)) arr = parsed.rows;
        else if(parsed && Array.isArray(parsed.items)) arr = parsed.items;
        else if(parsed && Array.isArray(parsed.records)) arr = parsed.records;
        if(Array.isArray(arr) && arr.length>0) collected.push.apply(collected, arr);
      }
      return collected.length ? collected : null;
    }

    function mergeFromLegacyKeys(){
      var collected = [];
      for(var i=0;i<LEGACY_DB_KEYS.length;i++){
        var raw = localStorage.getItem(LEGACY_DB_KEYS[i]);
        var parsed = safeParseJSON(raw);
        if(!parsed) continue;
        var arr = Array.isArray(parsed) ? parsed : (Array.isArray(parsed.db) ? parsed.db : null);
        if(!Array.isArray(arr)) continue;
        collected.push.apply(collected, arr);
      }

      var extra = scanUnknownLegacyKeys();
      if(Array.isArray(extra)) collected.push.apply(collected, extra);

      var backup = readBackupCandidates();
      if(Array.isArray(backup)) collected.push.apply(collected, backup);

      var normed = collected.map(normalizeRow).filter(Boolean);
      if(normed.length === 0) return { db: [], changed: false };

      var maxId = 0;
      for(var j=0;j<normed.length;j++){
        if(Number.isFinite(normed[j].id) && normed[j].id > maxId) maxId = normed[j].id;
      }
      for(var k=0;k<normed.length;k++){
        if(!normed[k].id){ maxId += 1; normed[k].id = maxId; }
        if(!normed[k].uid) normed[k].uid = "legacy_" + String(normed[k].id);
      }

      var seen = new Set();
      var uniq = [];
      for(var m=0;m<normed.length;m++){
        var key = rowKey(normed[m]);
        if(seen.has(key)) continue;
        seen.add(key);
        uniq.push(normed[m]);
      }
      uniq.sort(function(a,b){ return (a.id||0) - (b.id||0); });
      return { db: uniq, changed: true };
    }

    function loadCounterFromLegacy(){
      var best = 0;
      for(var i=0;i<LEGACY_COUNTER_KEYS.length;i++){
        var n = Number(localStorage.getItem(LEGACY_COUNTER_KEYS[i]) || "0");
        if(Number.isFinite(n) && n > best) best = n;
      }
      return best;
    }

    function ensureCounterAtLeast(n){
      var cur = Number(localStorage.getItem(COUNTER_KEY) || "0");
      var curOk = Number.isFinite(cur) ? cur : 0;
      var v = Math.max(curOk, n);
      localStorage.setItem(COUNTER_KEY, String(v));
    }

    function repairDBIfNeeded(){
      if(!Array.isArray(db)) db = [];
      var cleaned = [];
      var usedId = new Set();
      var maxId = 0;

      for(var i=0;i<db.length;i++){
        var r = normalizeRow(db[i]);
        if(!r) continue;
        if(!r.text || !r.text.toString().trim()) continue;
        if(Number.isFinite(r.id) && r.id > maxId) maxId = r.id;
        cleaned.push(r);
      }

      var needNewId = [];
      for(var j=0;j<cleaned.length;j++){
        if(!cleaned[j].id || usedId.has(cleaned[j].id)){
          needNewId.push(cleaned[j]);
          continue;
        }
        usedId.add(cleaned[j].id);
      }
      for(var k=0;k<needNewId.length;k++){
        maxId += 1;
        while(usedId.has(maxId)) maxId += 1;
        needNewId[k].id = maxId;
        usedId.add(maxId);
      }

      cleaned.sort(function(a,b){ return (a.id||0) - (b.id||0); });
      db = cleaned;

      try{
        if(db.length>0) saveSafetySnapshot("repair");
        if(db.length>0) rotateBackups(db);
        localStorage.setItem(DB_KEY, JSON.stringify(db));
        ensureCounterAtLeast(maxId);
      }catch(e){}
    }

    function loadDB(quiet){
      quiet = !!quiet;
      try{
        var raw = localStorage.getItem(DB_KEY);
        var parsed = safeParseJSON(raw);

        if(Array.isArray(parsed)){
          db = parsed.map(normalizeRow).filter(Boolean);
        }else if(parsed && Array.isArray(parsed.db)){
          db = parsed.db.map(normalizeRow).filter(Boolean);
        }else{
          db = [];
        }

        if(db.length === 0){
          var merged = mergeFromLegacyKeys();
          if(merged.db.length > 0){
            db = merged.db;
            if(db.length>0){
              saveSafetySnapshot("load_legacy_merge");
              rotateBackups(db);
            }
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            if(!quiet) toast("已自動找回既有資料並合併到本頁");
          }else{
            var backup = readBackupCandidates();
            if(Array.isArray(backup) && backup.length>0){
              db = backup.map(normalizeRow).filter(Boolean);
              if(db.length>0){
                saveSafetySnapshot("load_backup_restore");
                rotateBackups(db);
              }
              localStorage.setItem(DB_KEY, JSON.stringify(db));
              if(!quiet) toast("主資料異常，已由備份自動還原");
            }else{
              restoreFromSafetySnapshot(quiet);
            }
          }
        }else{
          if(db.length>0){
            saveSafetySnapshot("load_ok");
            rotateBackups(db);
          }
        }
      }catch(e){
        db = [];
        var backup2 = readBackupCandidates();
        if(Array.isArray(backup2) && backup2.length>0){
          db = backup2.map(normalizeRow).filter(Boolean);
          if(db.length>0){
            saveSafetySnapshot("load_fail_restore");
            rotateBackups(db);
          }
          localStorage.setItem(DB_KEY, JSON.stringify(db));
          if(!quiet) toast("主資料讀取失敗，已由備份自動還原");
        }else{
          restoreFromSafetySnapshot(quiet);
        }
      }

      var maxId = 0;
      for(var r=0;r<db.length;r++){
        if(Number.isFinite(db[r].id) && db[r].id > maxId) maxId = db[r].id;
      }
      var legacyCounter = loadCounterFromLegacy();
      ensureCounterAtLeast(Math.max(maxId, legacyCounter));

      repairDBIfNeeded();

      if(Array.isArray(db) && db.length===0){
        restoreFromSafetySnapshot(quiet);
      }
    }

    function saveDB(){
      try{
        if(Array.isArray(db) && db.length>0) saveSafetySnapshot("saveDB");
        rotateBackups(db);
        localStorage.setItem(DB_KEY, JSON.stringify(db));
      }catch(e){
        toast("儲存失敗：可能瀏覽器儲存空間不足");
      }
    }

    function getCounter(){
      var n = Number(localStorage.getItem(COUNTER_KEY) || "0");
      return Number.isFinite(n) ? n : 0;
    }
    function nextCounter(){
      var n = getCounter() + 1;
      localStorage.setItem(COUNTER_KEY, String(n));
      return n;
    }

    function loadDict(key){
      try{
        var raw = localStorage.getItem(key);
        var arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr.map(norm).filter(Boolean) : [];
      }catch(e){ return []; }
    }
    function saveDict(key, arr){ localStorage.setItem(key, JSON.stringify(arr)); }

    function ensureSeedDict(){
      if(!localStorage.getItem(TRADE_DICT_KEY)){
        saveDict(TRADE_DICT_KEY, ["土建","機電","水電","消防","裝修","其他"]);
      }
      if(!localStorage.getItem(SYS_DICT_KEY)){
        saveDict(SYS_DICT_KEY, ["電氣","給排水","消防","空調","弱電","土建","其他"]);
      }
      if(!localStorage.getItem(TRADE_SYS_MAP_KEY)){
        try{ localStorage.setItem(TRADE_SYS_MAP_KEY, JSON.stringify({})); }catch(e){}
      }
      if(!localStorage.getItem(SOURCE_DICT_KEY)){
        saveDict(SOURCE_DICT_KEY, ["會議紀錄","公文","Email","現勘","口頭指示","其他"]);
      }
    }

    function loadTradeSysMap(){
      try{
        var raw = localStorage.getItem(TRADE_SYS_MAP_KEY);
        var obj = raw ? JSON.parse(raw) : {};
        return (obj && typeof obj === "object") ? obj : {};
      }catch(e){ return {}; }
    }
    function saveTradeSysMap(map){
      try{ localStorage.setItem(TRADE_SYS_MAP_KEY, JSON.stringify(map || {})); }catch(e){}
    }
    function addTradeSysLink(trade, system){
      trade = norm(trade); system = norm(system);
      if(!trade || !system) return;

      var map = loadTradeSysMap();
      if(!Array.isArray(map[trade])) map[trade] = [];
      var exists = map[trade].some(function(x){ return norm(x).toLowerCase() === system.toLowerCase(); });
      if(!exists) map[trade].push(system);
      map[trade].sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });
      saveTradeSysMap(map);
    }

    function addSourceDict(v){
      v = norm(v);
      if(!v) return;
      var dict = loadDict(SOURCE_DICT_KEY);
      var lower = dict.map(function(x){ return x.toLowerCase(); });
      if(lower.includes(v.toLowerCase())) return;
      dict.push(v);
      dict.sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });
      saveDict(SOURCE_DICT_KEY, dict);
    }

    // ===============================
    // ✅ Cloud payload helpers
    // ===============================
    function exportDbWithSettings(){
      var rows = (Array.isArray(db)?db:[]).map(function(r){
        var uid = norm(r.uid) || (r.id ? ("legacy_"+String(r.id)) : uuid());
        return {
          page: PAGE_KEY,
          id: Number(r.id||0),
          uid: uid,
          text: (r.text||""),
          trade: (r.trade||""),
          system: (r.system||""),
          attach: (r.attach||""),
          source: (r.source||""),
          remark: (r.remark||""),
          date: (r.date||"")
        };
      });

      rows.push({
        page: PAGE_KEY,
        id: 0,
        uid: SETTINGS_UID,
        tradeDict: loadDict(TRADE_DICT_KEY),
        sysDict: loadDict(SYS_DICT_KEY),
        sourceDict: loadDict(SOURCE_DICT_KEY),
        tradeSysMap: loadTradeSysMap()
      });

      return rows;
    }

    function unwrapCloudPayload(payload){
      var p = payload;

      if(p && typeof p==="object" && p.payload !== undefined) p = p.payload;
      if(p && typeof p==="object" && p.data !== undefined) {
        var d = p.data;
        if(Array.isArray(d) || (d && typeof d==="object")) p = d;
      }

      if(Array.isArray(p)){
        return { db: p, counter: 0 };
      }

      if(p && typeof p==="object"){
        if(Array.isArray(p.db)) return p;
        if(Array.isArray(p.rows)) return { db: p.rows, counter: Number(p.counter||0) };
        if(Array.isArray(p.items)) return { db: p.items, counter: Number(p.counter||0) };
        if(Array.isArray(p.records)) return { db: p.records, counter: Number(p.counter||0) };
        if(Array.isArray(p.table)) return { db: p.table, counter: Number(p.counter||0) };

        if(Array.isArray(p[PAGE_KEY])) return { db: p[PAGE_KEY], counter: Number(p.counter||0) };
        if(p[PAGE_KEY] && typeof p[PAGE_KEY]==="object"){
          if(Array.isArray(p[PAGE_KEY].db)) return { db: p[PAGE_KEY].db, counter: Number(p[PAGE_KEY].counter||p.counter||0) };
        }

        if(p.db && typeof p.db==="object"){
          if(Array.isArray(p.db[PAGE_KEY])) return { db: p.db[PAGE_KEY], counter: Number(p.counter||p.db.counter||0) };
          if(p.db[PAGE_KEY] && typeof p.db[PAGE_KEY]==="object"){
            if(Array.isArray(p.db[PAGE_KEY].db)) return { db: p.db[PAGE_KEY].db, counter: Number(p.db[PAGE_KEY].counter||p.counter||0) };
          }
        }

        if(("v" in p) && (p.k!==undefined || p.key!==undefined || p.id!==undefined)){
          return { db: [p], counter: Number(p.counter||0) };
        }
      }

      return { db: [], counter: 0 };
    }

    function importPayload(payload, info){
      payload = (payload && typeof payload==="object") ? payload : { db: [] };
      var arr = Array.isArray(payload.db) ? payload.db : [];

      var beforeDb = Array.isArray(db) ? db.slice() : [];
      if(beforeDb.length>0){
        try{
          saveSafetySnapshot("before_cloud_apply");
          rotateBackups(beforeDb);
        }catch(e){}
      }

      var hasPage = false;
      for(var h=0; h<arr.length; h++){
        var pg = norm(arr[h] && (arr[h].page || arr[h].pageKey));
        if(pg){ hasPage = true; break; }
      }
      if(hasPage){
        arr = arr.filter(function(it){
          var pg2 = norm(it && (it.page || it.pageKey));
          var uid2 = norm(it && (it.uid ?? it.k ?? it.key));
          var id0 = Number(it && it.id);
          if(uid2 === SETTINGS_UID || (Number.isFinite(id0) && id0===0)) return true;
          return (pg2 === PAGE_KEY);
        });
      }

      var srow = null;
      for(var i=0;i<arr.length;i++){
        var it = arr[i];
        if(!it) continue;
        var kk = norm(it && (it.uid ?? it.k ?? it.key));
        var id0 = Number(it.id);
        if(kk === SETTINGS_UID || (Number.isFinite(id0) && id0 === 0)){
          srow = it; break;
        }
      }
      if(srow){
        var sv = (srow && typeof srow==="object") ? (srow.v || srow) : null;
        if(sv){
          if(Array.isArray(sv.tradeDict)) saveDict(TRADE_DICT_KEY, sv.tradeDict.map(norm).filter(Boolean));
          if(Array.isArray(sv.sysDict)) saveDict(SYS_DICT_KEY, sv.sysDict.map(norm).filter(Boolean));
          if(Array.isArray(sv.sourceDict)) saveDict(SOURCE_DICT_KEY, sv.sourceDict.map(norm).filter(Boolean));
          if(sv.tradeSysMap && typeof sv.tradeSysMap==="object") saveTradeSysMap(sv.tradeSysMap);
        }
      }

      var incoming = arr
        .filter(function(r){
          if(!r) return false;
          var kk2 = norm(r && (r.uid ?? r.k ?? r.key));
          var id0 = Number(r.id);
          if(kk2 === SETTINGS_UID) return false;
          if(Number.isFinite(id0) && id0 === 0) return false;
          return true;
        })
        .map(function(r){
          if(r && typeof r==="object" && ("v" in r) && (r.k!==undefined || r.key!==undefined)){
            var inner = r.v;
            if(typeof inner === "string"){
              var p = safeParseJSON(inner);
              if(p && typeof p==="object") inner = p;
            }
            if(inner && typeof inner==="object"){
              var obj = Object.assign({}, inner);
              obj.uid = norm(r.k ?? r.key ?? obj.uid ?? "");
              obj.id  = Number(r.id||obj.id||0);
              obj.text = obj.text ?? obj.content ?? obj.note ?? obj.memo ?? "";
              return obj;
            }
          }
          return r;
        })
        .map(normalizeRow)
        .filter(Boolean)
        .filter(function(r){ return r.text && r.text.toString().trim(); });

      var localCount = beforeDb.map(normalizeRow).filter(Boolean).filter(function(r){ return r.text && r.text.toString().trim(); }).length;
      var incomingCount = incoming.length;

      if(incomingCount === 0 && localCount > 0){
        try{
          if(!sessionStorage.getItem(PROTECT_EMPTY_REMOTE_KEY)){
            sessionStorage.setItem(PROTECT_EMPTY_REMOTE_KEY, "1");
            toast("⚠️ 雲端目前空白：已保護本機資料不覆寫，將嘗試推送合併到雲端…");
            if(cloud && Auth.canWrite()){
              setTimeout(function(){
                if(!cloud) return;
                cloud.ready.then(function(){ return cloud.saveMerged(); }).catch(function(){});
              }, 0);
            }
          }
        }catch(e){}
        return;
      }

      db = incoming;

      var maxId2 = 0;
      for(var j=0;j<db.length;j++){
        var n = Number(db[j].id||0);
        if(Number.isFinite(n) && n>maxId2) maxId2 = n;
      }
      var cnt = Number(payload.counter||0);
      if(!Number.isFinite(cnt)) cnt = 0;
      ensureCounterAtLeast(Math.max(cnt, maxId2));

      try{
        if(Array.isArray(db) && db.length>0) saveSafetySnapshot("after_cloud_apply");
        localStorage.setItem(DB_KEY, JSON.stringify(db));
      }catch(e){}
    }

    function cloudSave(reason){
      if(!cloud) return;
      if(!Auth.canWrite()) return;
      cloud.ready.then(function(){
        return cloud.saveMerged();
      }).catch(function(e){
        toast("雲端儲存失敗：" + (e && e.message ? e.message : String(e||"")));
      });
    }

    function hasDropboxToken(){
      try{
        var t = (localStorage.getItem(DROPBOX_TOKEN_KEY) || "").trim();
        if(!t) return false;
        t = t.replace(/^Bearer\s+/i,"").trim();
        return t.length >= 20;
      }catch(e){ return false; }
    }
    function getDropboxTokenMasked(){
      try{
        var t = (localStorage.getItem(DROPBOX_TOKEN_KEY) || "").trim();
        t = t.replace(/^Bearer\s+/i,"").trim();
        if(!t) return "未設定";
        return "已設定";
      }catch(e){ return "未設定"; }
    }

    function initCloudOnce(){
      if(cloudInited) return;
      cloudInited = true;

      if(!window.TasunCloudKit){
        toast("雲端套件未載入（僅本機模式）");
        return;
      }

      if(!hasDropboxToken()){
        toast("⚠️ 尚未設定 Dropbox Token：目前僅本機模式（不同電腦可能看到不同資料）。可按右上「設定Token」。");
      }

      try{
        window.TasunCloudKit.init({
          appVer: window.TASUN_APP_VER,
          resourcesUrl: "tasun-resources.json",
          ui: { enabled:true, hideLockButtons:true }
        });

        cloud = window.TasunCloudKit.mount({
          resourceKey: CLOUD_RESOURCE_KEY,
          pk: CLOUD_PK,
          idField: "id",
          counterField: "counter",
          merge: { conflictPolicy: "stash-remote" },
          watch: { intervalSec: 8 },
          getLocal: function(){
            // ✅ 先把明細補進主表（顯示用）；可寫入者會落盤 + 推雲端
            mergeDetailIntoMain({ persist: true, quiet: true });
            return { db: exportDbWithSettings(), counter: getCounter() };
          },
          apply: function(payload, info){
            var p = unwrapCloudPayload(payload);
            importPayload(p, info);

            // ✅ NEW：雲端套用完，再用明細補附件（讓「附件」立刻出現）
            mergeDetailIntoMain({ persist: false, quiet: true });

            lastCloudSyncAt = Date.now();
            if(info && info.conflicts){
              toast("雲端合併完成（衝突已另存快照）");
            }
            scheduleRender();
          }
        });

        if(cloud && cloud.pullNow) cloud.pullNow();

      }catch(e){
        toast("雲端初始化失敗：" + (e && e.message ? e.message : String(e||"")));
      }
    }

    function makeExportPayload(){
      return {
        meta: {
          app: "捷運汐東線事項記錄",
          dbKey: DB_KEY,
          exportedAt: new Date().toISOString(),
          ver: 2
        },
        counter: getCounter(),
        tradeDict: loadDict(TRADE_DICT_KEY),
        sysDict: loadDict(SYS_DICT_KEY),
        sourceDict: loadDict(SOURCE_DICT_KEY),
        tradeSysMap: loadTradeSysMap(),
        db: Array.isArray(db) ? db : []
      };
    }

    function safeFileStamp(){
      var s = new Date().toISOString().slice(0,19);
      return s.replaceAll(":", "-").replace("T","_");
    }

    function downloadJSON(filename, obj){
      var blob = new Blob([JSON.stringify(obj, null, 2)], { type:"application/json" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(function(){ URL.revokeObjectURL(url); a.remove(); }, 0);
    }

    function doExportBackup(){
      if(!Auth.ensureLoggedIn()) return;
      var payload = makeExportPayload();
      try{ localStorage.setItem(EXPORT_LAST_KEY, JSON.stringify(payload)); }catch(e){}
      downloadJSON("捷運汐東線事項記錄_備份_" + safeFileStamp() + ".json", payload);
      toast("已匯出備份（並寫入本機備份快照）");
      backupOnExit("export");
    }

    function isReadModeOn(){ return localStorage.getItem(READ_MODE_KEY) === "1"; }
    function applyReadMode(on){
      document.body.classList.toggle("readMode", !!on);
      var b = $("btnRead");
      var t = b && b.querySelector ? b.querySelector(".t") : null;
      if(t) t.textContent = on ? "閱讀模式：開" : "閱讀模式：關";
      scheduleRender();
    }
    function toggleReadMode(){
      var on = !document.body.classList.contains("readMode");
      localStorage.setItem(READ_MODE_KEY, on ? "1" : "0");
      applyReadMode(on);
      toast(on ? "已切換為閱讀模式（點卡片可展開/收合）" : "已切換為表格模式");
    }

    function uniqueFromDB(field){
      var set = new Set();
      for(var i=0;i<db.length;i++){
        var v = norm(db[i] && db[i][field]);
        if(v) set.add(v);
      }
      return set;
    }

    function uniqueFieldArrFromDB(field, tradeFilter){
      var set = new Set();
      var t = norm(tradeFilter);
      for(var i=0;i<db.length;i++){
        var r = db[i];
        if(t && norm(r.trade) !== t) continue;
        var v = norm(r && r[field]);
        if(v) set.add(v);
      }
      var arr = Array.from(set);
      arr.sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });
      return arr;
    }

    function rebuildTextDatalist(){
      var dl = $("textList");
      if(!dl) return;

      var set = new Set();
      for(var i=0;i<db.length;i++){
        var txt = (db[i] && db[i].text ? String(db[i].text) : "").trim();
        if(!txt) continue;
        var firstLine = txt.split(/\r?\n/)[0].trim();
        if(!firstLine) continue;
        if(firstLine.length > 80) firstLine = firstLine.slice(0,80) + "…";
        set.add(firstLine);
        if(set.size >= 250) break;
      }
      var arr = Array.from(set);
      arr.sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });
      dl.innerHTML = arr.map(function(v){
        return '<option value="'+escHtml(v)+'"></option>';
      }).join("");
    }

    function rebuildFilters(){
      var tSel = $("fTrade");
      var sSel = $("fSys");

      var keepT = norm(tSel.value);
      var keepS = norm(sSel.value);

      var trades = uniqueFieldArrFromDB("trade", "");
      tSel.innerHTML = '<option value="">全部</option>' + trades.map(function(v){
        return '<option value="'+escHtml(v)+'">'+escHtml(v)+'</option>';
      }).join("");

      if(trades.length === 0){
        tSel.value = "";
        tSel.disabled = true;
      }else{
        tSel.disabled = false;
        tSel.value = trades.includes(keepT) ? keepT : "";
      }

      var pickedTrade = norm(tSel.value);

      var systems = pickedTrade
        ? uniqueFieldArrFromDB("system", pickedTrade)
        : uniqueFieldArrFromDB("system", "");

      sSel.innerHTML = '<option value="">全部</option>' + systems.map(function(v){
        return '<option value="'+escHtml(v)+'">'+escHtml(v)+'</option>';
      }).join("");

      if(systems.length === 0){
        sSel.value = "";
        sSel.disabled = true;
      }else{
        sSel.disabled = false;
        sSel.value = systems.includes(keepS) ? keepS : "";
      }
    }

    function filteredRows(){
      var q = norm($("qText").value).toLowerCase();
      var t = norm($("fTrade").value);
      var s = norm($("fSys").value);

      var rows = db.slice();

      if(t) rows = rows.filter(function(r){ return norm(r.trade) === t; });
      if(s) rows = rows.filter(function(r){ return norm(r.system) === s; });

      if(q){
        rows = rows.filter(function(r){
          return (r.text ?? "").toString().toLowerCase().includes(q);
        });
      }

      rows.sort(function(a,b){ return (a.id||0) - (b.id||0); });
      return rows;
    }

    var _renderPending = false;
    function scheduleRender(){
      if(_renderPending) return;
      _renderPending = true;
      requestAnimationFrame(function(){
        _renderPending = false;
        render();
      });
    }

    function applySelectionToDOM(){
      document.querySelectorAll("tr.sel").forEach(function(el){ el.classList.remove("sel"); });
      document.querySelectorAll(".noteCard.sel").forEach(function(el){ el.classList.remove("sel"); });
      if(!selectedUid) return;
      var tr = document.querySelector('tr[data-uid="'+selectedUid+'"]');
      if(tr) tr.classList.add("sel");
      var card = document.querySelector('.noteCard[data-uid="'+selectedUid+'"]');
      if(card) card.classList.add("sel");
    }

    function renderHint(rowsCount){
      var writable = Auth.canWrite();
      var modeText = writable ? "可維護模式" : "唯讀模式";

      $("btnAdd").style.display  = writable ? "inline-block" : "none";
      $("btnEdit").style.display = writable ? "inline-block" : "none";
      $("btnView").disabled = !selectedUid;

      $("btnToken").style.display = Auth.isAdmin() ? "inline-block" : "none";

      var selItem = selectedUid ? (db.find(function(x){ return x.uid===selectedUid; }) || null) : null;
      var selText = selItem ? ("#"+(selItem.id||"—")) : "";

      var cloudText = hasDropboxToken()
        ? '<span style="color:rgba(92,66,22,.86)">雲端：</span><b style="color:var(--goldText)">'+escHtml(getDropboxTokenMasked())+'</b>'
          + (lastCloudSyncAt ? '（最近同步 <b style="color:var(--goldText)">'+escHtml(fmtClock(lastCloudSyncAt))+'</b>）' : '')
        : '<span style="color:rgba(92,66,22,.86)">雲端：</span><b style="color:rgba(170,60,60,.90)">未設定Token</b>' + (Auth.isAdmin() ? '（可按右上「設定Token」）' : '');

      $("hint").innerHTML =
        '目前為 <b style="color:var(--goldText)">'+modeText+'</b>（role: '+escHtml(Auth.role())+'）。' +
        ' 筆數：<b style="color:var(--goldText)">'+rowsCount+'</b>。 ' +
        cloudText +
        (selectedUid ? ' 已選取：<b style="color:var(--goldText)">'+escHtml(selText)+'</b>' : '（可點選一列，再按右上 「顯示畫面/編輯」）');
    }

    function fillDropdown(selectId, options, placeholder){
      var sel = $(selectId);
      if(options.length === 0){
        sel.innerHTML = '<option value="" disabled selected>'+escHtml(placeholder)+'</option>';
      }else{
        sel.innerHTML = options.map(function(v){
          return '<option value="'+escHtml(v)+'">'+escHtml(v)+'</option>';
        }).join("");
      }
    }

    function rebuildModalTradeOptions(selected){
      var trades = Array.from(uniqueFromDB("trade"));
      loadDict(TRADE_DICT_KEY).forEach(function(x){ if(x) trades.push(x); });
      trades = Array.from(new Set(trades.map(norm).filter(Boolean)));
      trades.sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });

      fillDropdown("mTradeSel", trades, "（請先新增工種）");
      var v = norm(selected);
      if(v && trades.includes(v)) $("mTradeSel").value = v;
    }

    function systemsByTradeFromMapAndDB(trade){
      var t = norm(trade);
      if(!t) return [];
      var set = new Set();

      var map = loadTradeSysMap();
      if(Array.isArray(map[t])) map[t].forEach(function(x){
        x = norm(x); if(x) set.add(x);
      });

      for(var i=0;i<db.length;i++){
        if(norm(db[i].trade) !== t) continue;
        var s = norm(db[i].system);
        if(s) set.add(s);
      }

      var arr = Array.from(set);
      arr.sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });
      return arr;
    }

    function rebuildModalSystemOptions(trade, selected){
      var t = norm(trade);
      var systems = t ? systemsByTradeFromMapAndDB(t) : [];
      fillDropdown("mSysSel", systems, t ? "（此工種尚無系統：請按「新增系統」）" : "（請先選擇工種）");
      var v = norm(selected);
      if(v && systems.includes(v)) $("mSysSel").value = v;
      else if(systems.length > 0) $("mSysSel").value = systems[0];
    }

    function rebuildModalSourceOptions(selected){
      var sources = Array.from(uniqueFromDB("source"));
      loadDict(SOURCE_DICT_KEY).forEach(function(x){ if(x) sources.push(x); });
      sources = Array.from(new Set(sources.map(norm).filter(Boolean)));
      sources.sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });

      fillDropdown("mSourceSel", sources, "（可按「新增出處」）");
      var v = norm(selected);
      if(v && sources.includes(v)) $("mSourceSel").value = v;
      else if(sources.length > 0) $("mSourceSel").value = sources[0];
    }

    function isSysSelEmpty(){
      var sel = $("mSysSel");
      if(!sel) return true;
      return (sel.options.length === 1 && sel.options[0].disabled);
    }

    function setModalEditable(editable){
      $("btnSave").style.display = editable ? "inline-block" : "none";
      $("btnSaveTop").style.display = editable ? "inline-block" : "none";
      $("btnDelete").style.display = (editable && Auth.isAdmin() && editingUid != null) ? "inline-block" : "none";

      ["mText","mTradeSel","mSysSel","mAttach","mSourceSel","mRemark","mDate"].forEach(function(id){
        $(id).disabled = !editable;
      });

      var allowAddOpt = editable && Auth.canWrite();
      $("btnAddTrade").style.display = allowAddOpt ? "inline-block" : "none";
      $("btnAddSys").style.display   = allowAddOpt ? "inline-block" : "none";
      $("btnAddSource").style.display = allowAddOpt ? "inline-block" : "none";

      if(editable && isSysSelEmpty()){
        $("mSysSel").disabled = true;
      }
    }

    function openModal(uid, editable){
      Auth.validateSession();
      if(!Auth.ensureLoggedIn()) return;

      var item = (uid == null) ? null : (db.find(function(x){ return x.uid === uid; }) || null);
      editingUid = item ? item.uid : null;

      rebuildModalTradeOptions(item ? item.trade : "");
      var tradeNow = norm($("mTradeSel").value) || (item ? item.trade : "");
      rebuildModalSystemOptions(tradeNow, item ? item.system : "");
      rebuildModalSourceOptions(item ? item.source : "");

      $("mTitle").textContent = editable ? (item ? "編輯" : "新增") : "顯示畫面";
      setModalEditable(editable);

      $("mNo").value = item ? (item.id ?? (getCounter() + 1)) : (getCounter() + 1);
      $("mText").value = item ? (item.text || "") : "";
      $("mRemark").value = item ? (item.remark || "") : "";
      $("mDate").value = item ? (item.date || new Date().toISOString().slice(0,10)) : new Date().toISOString().slice(0,10);

      // ✅ 這裡直接顯示合併後的 attach（若明細有連結就會帶出）
      $("mAttach").value = item ? (item.attach || "") : "";

      if(item && item.source) $("mSourceSel").value = item.source;

      $("mask").style.display = "flex";
    }

    function closeModal(){ $("mask").style.display = "none"; }

    function saveItem(){
      Auth.validateSession();
      if(!Auth.ensureLoggedIn()) return;
      if(!Auth.canWrite()){ toast("唯讀權限不可儲存"); return; }

      var text = norm($("mText").value);
      if(!text){ toast("記事內容不可空白"); $("mText").focus(); return; }

      var trade  = norm($("mTradeSel").value);
      var system = norm($("mSysSel").value);
      if(!trade){ toast("工種尚未建立：請先按「新增工種」"); return; }
      if(!system){ toast("系統尚未建立：請先按「新增系統」"); return; }

      var attach = norm($("mAttach").value);
      var source = norm($("mSourceSel").value);
      var remark = norm($("mRemark").value);
      var date   = norm($("mDate").value) || new Date().toISOString().slice(0,10);

      if(editingUid != null){
        var idx = db.findIndex(function(x){ return x.uid === editingUid; });
        if(idx >= 0){
          var keep = db[idx];
          db[idx] = { uid: keep.uid, id: keep.id, text: text, trade: trade, system: system, attach: attach, source: source, remark: remark, date: date };
        }
      }else{
        var nid = nextCounter();
        var newUid = uuid();
        db.push({ uid: newUid, id: nid, text: text, trade: trade, system: system, attach: attach, source: source, remark: remark, date: date });
        selectedUid = newUid;
      }

      addTradeSysLink(trade, system);
      addSourceDict(source);

      saveDB();
      closeModal();
      scheduleRender();
      toast("已儲存");
      backupOnExit("save");

      cloudSave("save");
    }

    function deleteItem(){
      Auth.validateSession();
      if(!Auth.ensureLoggedIn()) return;
      if(!Auth.isAdmin()){ toast("僅 admin 可刪除"); return; }
      if(editingUid == null) return;
      if(!confirm("確定刪除這筆記事？")) return;

      db = db.filter(function(x){ return x.uid !== editingUid; });
      if(selectedUid === editingUid) selectedUid = null;
      saveDB();

      closeModal();
      scheduleRender();
      toast("已刪除");
      backupOnExit("delete");

      cloudSave("delete");
    }

    function openPrompt(mode){
      Auth.validateSession();
      if(!Auth.ensureLoggedIn()) return;
      if(!Auth.canWrite()){ toast("read 權限不可新增選單"); return; }

      if(mode === "sys"){
        var curT = norm($("mTradeSel").value);
        if(!curT){
          toast("請先選擇工種，再新增系統");
          return;
        }
      }

      promptMode = mode;
      $("pInput").value = "";

      if(mode === "trade"){
        $("pTitle").textContent = "新增工種";
        $("pLabel").textContent = "請輸入新的工種";
        $("pInput").placeholder = "例如：土建 / 機電 / 水電...";
        $("pHint").textContent = "新增後會加入「工種字典」。";
      }else if(mode === "source"){
        $("pTitle").textContent = "新增出處";
        $("pLabel").textContent = "請輸入出處（下拉選單會不重複顯示）";
        $("pInput").placeholder = "例如：會議紀錄 / 公文 / Email...";
        $("pHint").textContent = "新增後會加入「出處字典」，並立即套用。";
      }else{
        $("pTitle").textContent = "新增系統";
        $("pLabel").textContent = "請輸入系統（會綁到目前工種）";
        $("pInput").placeholder = "例如：電氣 / 給排水 / 消防...";
        $("pHint").textContent = "✅ 若你輸入的系統已存在於系統字典，會改為「綁定到目前工種」（不會被擋掉）。";
      }

      $("pMask").style.display = "flex";
      setTimeout(function(){ $("pInput").focus(); }, 0);
    }

    function closePrompt(){
      $("pMask").style.display = "none";
      promptMode = null;
    }

    function addOption(){
      if(!Auth.canWrite()) return;

      var v = norm($("pInput").value);
      if(!v){ toast("不可空白"); $("pInput").focus(); return; }

      if(promptMode === "trade"){
        var dictT = loadDict(TRADE_DICT_KEY);
        var existsTrade = dictT.map(function(x){ return x.toLowerCase(); });
        if(existsTrade.includes(v.toLowerCase())){ toast("已存在相同工種"); return; }

        dictT.push(v);
        dictT.sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });
        saveDict(TRADE_DICT_KEY, dictT);

        rebuildModalTradeOptions(v);
        $("mTradeSel").value = v;
        rebuildModalSystemOptions(v, "");
        if(isSysSelEmpty()) $("mSysSel").disabled = true;

        scheduleRender();
        closePrompt();
        toast("已新增工種");
        backupOnExit("add_trade");
        cloudSave("dict");
        return;
      }

      if(promptMode === "source"){
        addSourceDict(v);
        rebuildModalSourceOptions(v);
        $("mSourceSel").value = v;

        scheduleRender();
        closePrompt();
        toast("已新增出處");
        backupOnExit("add_source");
        cloudSave("dict");
        return;
      }

      var curTrade = norm($("mTradeSel").value);
      if(!curTrade){ toast("請先選擇工種"); return; }

      var sysDict = loadDict(SYS_DICT_KEY);
      var sysLower = sysDict.map(function(x){ return x.toLowerCase(); });
      var inSysDict = sysLower.includes(v.toLowerCase());

      if(!inSysDict){
        sysDict.push(v);
        sysDict.sort(function(a,b){ return a.localeCompare(b, "zh-Hant"); });
        saveDict(SYS_DICT_KEY, sysDict);
      }

      addTradeSysLink(curTrade, v);
      toast(inSysDict ? "已綁定系統到目前工種" : "已新增並綁定系統");

      rebuildModalSystemOptions(curTrade, v);
      $("mSysSel").disabled = false;
      $("mSysSel").value = v;

      scheduleRender();
      closePrompt();
      backupOnExit("add_sys");
      cloudSave("dict");
    }

    function renderTable(rows){
      var tbody = $("tbody");
      var writable = Auth.canWrite();

      tbody.innerHTML = rows.map(function(r){
        var isSel = (selectedUid === r.uid);
        var att = norm(r.attach || "");
        var attCell = att
          ? '<button class="attBtn" data-act="att" data-uid="'+escHtml(r.uid)+'"><span class="t">開啟</span></button>'
          : '<span class="muted">—</span>';

        var textHtml = escHtml((r.text ?? "").toString()).replaceAll("\n","<br>");
        var remarkHtml = escHtml((r.remark ?? "").toString()).replaceAll("\n","<br>");

        var viewBtn = '<button class="btn ghost small" data-act="view" data-uid="'+escHtml(r.uid)+'"><span class="t">顯示畫面</span></button>';
        var editBtn = writable ? '<button class="btn ghost small" data-act="edit" data-uid="'+escHtml(r.uid)+'"><span class="t">編輯</span></button>' : '';

        return ''
          + '<tr data-uid="'+escHtml(r.uid)+'" class="'+(isSel ? "sel" : "")+'">'
          +   '<td style="text-align:center;">'+(r.id ?? "")+'</td>'
          +   '<td>'+(textHtml ? textHtml : '<span class="muted">—</span>')+'</td>'
          +   '<td style="text-align:center;">'+(escHtml(r.trade) || '<span class="muted">—</span>')+'</td>'
          +   '<td style="text-align:center;">'+(escHtml(r.system) || '<span class="muted">—</span>')+'</td>'
          +   '<td style="text-align:center;">'+attCell+'</td>'
          +   '<td style="text-align:center;">'+(escHtml(r.source) || '<span class="muted">—</span>')+'</td>'
          +   '<td>'+(remarkHtml ? remarkHtml : '<span class="muted">—</span>')+'</td>'
          +   '<td style="text-align:center;">'+(escHtml(r.date) || '<span class="muted">—</span>')+'</td>'
          +   '<td style="text-align:center; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">'
          +     viewBtn + editBtn
          +   '</td>'
          + '</tr>';
      }).join("") || (
        '<tr><td colspan="9" class="muted" style="padding:18px;">尚無資料（write/admin 可用右上「新增」建立第一筆）</td></tr>'
      );
    }

    function renderCards(rows){
      var c = $("cards");
      var writable = Auth.canWrite();

      c.innerHTML = rows.map(function(r){
        var att = norm(r.attach||"");
        var date = norm(r.date||"") || "—";
        var t = norm(r.trade||"") || "—";
        var s = norm(r.system||"") || "—";
        var so = norm(r.source||"") || "—";
        var text = (r.text ?? "").toString();
        var remark = (r.remark ?? "").toString();

        var actions = ''
          + '<div class="noteActions">'
          +   (att ? '<button class="attBtn" data-act="att" data-uid="'+escHtml(r.uid)+'"><span class="t">附件</span></button>' : '')
          +   '<button class="btn ghost small" data-act="view" data-uid="'+escHtml(r.uid)+'"><span class="t">顯示畫面</span></button>'
          +   (writable ? '<button class="btn ghost small" data-act="edit" data-uid="'+escHtml(r.uid)+'"><span class="t">編輯</span></button>' : '')
          + '</div>';

        return ''
          + '<div class="noteCard" data-uid="'+escHtml(r.uid)+'">'
          +   '<div class="noteHead">'
          +     '<div class="noteMeta">'
          +       '<span class="noteNo">#'+escHtml(String(r.id ?? "—"))+'</span>'
          +       '<span class="noteTag">工種：'+escHtml(t)+'</span>'
          +       '<span class="noteTag">系統：'+escHtml(s)+'</span>'
          +       '<span class="noteTag">出處：'+escHtml(so)+'</span>'
          +       '<span class="noteTag">日期：'+escHtml(date)+'</span>'
          +     '</div>'
          +     actions
          +   '</div>'
          +   '<div class="noteBody">'+escHtml(text)+'</div>'
          +   '<div class="noteMore">'
          +     '<div class="noteBody"><b>備註：</b>'+(remark ? escHtml(remark) : '<span class="muted">—</span>')+'</div>'
          +   '</div>'
          + '</div>';
      }).join("") || (
        '<div class="muted" style="padding:18px;">尚無資料（write/admin 可用右上「新增」建立第一筆）</div>'
      );
    }

    function render(){
      // ✅ 保險：每次 render 前先補一次（只補空白，不覆蓋；且有 cache，不會很重）
      mergeDetailIntoMain({ persist:false, quiet:true });

      rebuildTextDatalist();
      rebuildFilters();

      var rows = filteredRows();
      if(selectedUid && !rows.some(function(r){ return r.uid===selectedUid; })) selectedUid = null;

      var isRead = document.body.classList.contains("readMode");
      $("cards").style.display = isRead ? "block" : "none";
      $("tbl").style.display = isRead ? "none" : "table";

      if(isRead){
        renderCards(rows);
      }else{
        renderTable(rows);
      }

      applySelectionToDOM();
      renderHint(rows.length);
    }

    function syncUserUI(){
      var u = Auth.current();
      $("uName").textContent = u && u.username ? u.username : "—";
      $("uRole").textContent = Auth.role();
    }

    function setupMoreMenu(backHref){
      var backBtn = $("mBack");
      var moreBtn = $("mMoreBtn");
      var menu = $("mMoreMenu");

      function close(){ menu.style.display = "none"; }
      function toggle(e){
        e.preventDefault();
        e.stopPropagation();
        menu.style.display = (menu.style.display === "block") ? "none" : "block";
      }

      backBtn.onclick = function(){ go(backHref); };
      moreBtn.addEventListener("click", toggle);

      menu.addEventListener("click", function(e){
        e.stopPropagation();
        var item = e.target.closest("button.menuItem[data-href]");
        if(!item) return;
        var href = item.getAttribute("data-href");
        if(href) go(href);
      });

      document.addEventListener("click", close);
      window.addEventListener("keydown", function(e){ if(e.key === "Escape") close(); });
    }

    // ===============================
    // ✅ Token UI（原樣）
    // ===============================
    function openTokenMask(){
      if(!Auth.isAdmin()){
        toast("僅 admin 可設定 Token");
        return;
      }
      $("tokenErr").style.display = "none";
      $("tokenErr").textContent = "";
      $("tokenInput").value = "";
      $("tokenInput").type = "password";
      $("tokenHint").textContent = "目前狀態：" + getDropboxTokenMasked();
      $("tokenMask").classList.add("show");
      setTimeout(function(){ $("tokenInput").focus(); }, 0);
    }
    function closeTokenMask(){
      $("tokenMask").classList.remove("show");
    }
    function saveToken(){
      if(!Auth.isAdmin()){
        toast("僅 admin 可設定 Token");
        return;
      }
      var t = norm($("tokenInput").value);
      t = t.replace(/^Bearer\s+/i,"").trim();
      if(!t || t.length < 20){
        $("tokenErr").textContent = "Token 看起來不完整（長度不足），請重新貼上。";
        $("tokenErr").style.display = "block";
        return;
      }
      try{
        localStorage.setItem(DROPBOX_TOKEN_KEY, t);
      }catch(e){
        $("tokenErr").textContent = "寫入 localStorage 失敗，可能瀏覽器限制或空間不足。";
        $("tokenErr").style.display = "block";
        return;
      }

      try{
        if(window.TasunCloudKit && typeof window.TasunCloudKit.setToken === "function"){
          window.TasunCloudKit.setToken(t);
        }
        if(cloud && typeof cloud.setToken === "function"){
          cloud.setToken(t);
        }
      }catch(e){}

      closeTokenMask();
      toast("已儲存 Token，將嘗試同步雲端…");

      if(!cloudInited) initCloudOnce();
      try{
        if(cloud && cloud.pullNow) cloud.pullNow();
      }catch(e){}

      setTimeout(function(){
        scheduleRender();
        toast("如仍顯示 CloudKit error，請重新整理頁面一次。");
      }, 900);
    }
    function clearToken(){
      if(!Auth.isAdmin()){
        toast("僅 admin 可清除 Token");
        return;
      }
      try{ localStorage.removeItem(DROPBOX_TOKEN_KEY); }catch(e){}

      try{
        if(window.TasunCloudKit && typeof window.TasunCloudKit.setToken === "function"){
          window.TasunCloudKit.setToken("");
        }
        if(cloud && typeof cloud.setToken === "function"){
          cloud.setToken("");
        }
      }catch(e){}

      $("tokenHint").textContent = "目前狀態：未設定";
      toast("已清除 Token（回到本機模式）");
      scheduleRender();
    }
    function toggleTokenVisible(){
      var inp = $("tokenInput");
      inp.type = (inp.type === "password") ? "text" : "password";
    }

    var _uiBound = false;
    function bindUIOnce(){
      if(_uiBound) return;
      _uiBound = true;

      $("navBack").onclick = function(){ go("汐東工程管理表.html"); };
      setupMoreMenu("汐東工程管理表.html");

      $("btnRead").onclick = toggleReadMode;
      $("btnCloud").onclick = function(){ openAttachment(CLOUD_URL); };
      $("btnExport").onclick = function(){
        Auth.validateSession();
        if(!Auth.ensureLoggedIn()) return;
        doExportBackup();
      };

      $("btnView").onclick = function(){
        if(!selectedUid){ toast("請先點選一筆，再按顯示畫面"); return; }
        openModal(selectedUid, false);
      };

      $("qText").addEventListener("input", scheduleRender);
      $("fTrade").addEventListener("change", scheduleRender);
      $("fSys").addEventListener("change", scheduleRender);

      $("btnClear").onclick = function(){
        $("qText").value = "";
        $("fTrade").value = "";
        $("fSys").value = "";
        scheduleRender();
      };

      $("btnAdd").onclick = function(){
        if(!Auth.canWrite()){ toast("唯讀不可新增"); return; }
        editingUid = null;
        openModal(null, true);
      };

      $("btnEdit").onclick = function(){
        if(!Auth.canWrite()){ toast("唯讀不可編輯"); return; }
        if(!selectedUid){ toast("請先點選項目再按編輯"); return; }
        openModal(selectedUid, true);
      };

      $("btnClose").onclick = closeModal;
      $("btnCancel").onclick = closeModal;
      $("mask").addEventListener("click", function(e){ if(e.target === $("mask")) closeModal(); });

      $("btnSave").onclick = saveItem;
      $("btnSaveTop").onclick = saveItem;

      $("btnDelete").onclick = deleteItem;

      $("btnAddTrade").onclick = function(){ openPrompt("trade"); };
      $("btnAddSys").onclick   = function(){ openPrompt("sys"); };
      $("btnAddSource").onclick = function(){ openPrompt("source"); };

      $("btnNetDisk").onclick = function(){ openAttachment(CLOUD_URL); };

      $("pClose").onclick = closePrompt;
      $("pCancel").onclick = closePrompt;
      $("pOk").onclick = addOption;
      $("pMask").addEventListener("click", function(e){ if(e.target === $("pMask")) closePrompt(); });

      $("mTradeSel").addEventListener("change", function(){
        var t = norm($("mTradeSel").value);
        rebuildModalSystemOptions(t, "");
        if(isSysSelEmpty()) $("mSysSel").disabled = true;
        else $("mSysSel").disabled = false;
      });

      $("tbody").addEventListener("click", function(e){
        var viewBtn = e.target.closest("button[data-act='view']");
        if(viewBtn){
          var uid = norm(viewBtn.getAttribute("data-uid"));
          if(uid) openModal(uid, false);
          return;
        }
        var editBtn = e.target.closest("button[data-act='edit']");
        if(editBtn){
          var uidE = norm(editBtn.getAttribute("data-uid"));
          if(!Auth.canWrite()){ toast("唯讀不可編輯"); return; }
          if(uidE) openModal(uidE, true);
          return;
        }
        var attBtn = e.target.closest("button[data-act='att']");
        if(attBtn){
          var uid2 = norm(attBtn.getAttribute("data-uid"));
          var item2 = db.find(function(x){ return x.uid === uid2; });
          var href2 = norm(item2 && item2.attach ? item2.attach : "");
          if(!href2){ toast("此筆尚未設定附件"); return; }
          openAttachment(href2);
          return;
        }
        var tr = e.target.closest("tr[data-uid]");
        if(!tr) return;
        var uid3 = norm(tr.getAttribute("data-uid"));
        if(!uid3) return;
        selectedUid = uid3;
        applySelectionToDOM();
        renderHint(filteredRows().length);
      });

      $("cards").addEventListener("click", function(e){
        var btn = e.target.closest("button[data-act]");
        if(btn){
          var act = btn.getAttribute("data-act");
          var uid = norm(btn.getAttribute("data-uid"));
          if(!uid) return;
          if(act === "view"){
            openModal(uid, false);
            return;
          }
          if(act === "edit"){
            if(!Auth.canWrite()){ toast("唯讀不可編輯"); return; }
            openModal(uid, true);
            return;
          }
          if(act === "att"){
            var item = db.find(function(x){ return x.uid === uid; });
            var href = norm(item && item.attach ? item.attach : "");
            if(!href){ toast("此筆尚未設定附件"); return; }
            openAttachment(href);
            return;
          }
        }

        var card = e.target.closest(".noteCard[data-uid]");
        if(!card) return;

        var uid2 = norm(card.getAttribute("data-uid"));
        if(!uid2) return;
        selectedUid = uid2;

        card.classList.toggle("open");

        applySelectionToDOM();
        renderHint(filteredRows().length);
      });

      window.addEventListener("keydown", function(e){
        if(e.key === "Escape"){
          if($("tokenMask").classList.contains("show")) closeTokenMask();
          else if($("pMask").style.display === "flex") closePrompt();
          else if($("mask").style.display === "flex") closeModal();
        }
        if(e.key === "Enter" && $("pMask").style.display === "flex") addOption();
      });

      window.addEventListener("storage", function(e){
        if(e.key === DB_KEY || LEGACY_DB_KEYS.includes(e.key)){
          loadDB(true);
          // ✅ NEW：其他分頁改了主表 → 也重新補一次附件
          mergeDetailIntoMain({ persist:false, quiet:true });
          scheduleRender();
        }
        // ✅ NEW：明細有更新 → 立刻合併到主表附件（UI不動）
        if(e.key === DETAIL_KEY){
          _detailCache = { sig:"", map:null, count:0 };
          mergeDetailIntoMain({ persist:true, quiet:false });
          scheduleRender();
        }
        if(e.key === READ_MODE_KEY){
          applyReadMode(isReadModeOn());
        }
        if(e.key === TRADE_SYS_MAP_KEY){
          scheduleRender();
        }
        if(e.key === DROPBOX_TOKEN_KEY){
          scheduleRender();
        }
      });

      $("btnToken").onclick = openTokenMask;
      $("tokenClose").onclick = closeTokenMask;
      $("tokenSave").onclick = saveToken;
      $("tokenClear").onclick = clearToken;
      $("tokenToggle").onclick = toggleTokenVisible;
      $("tokenMask").addEventListener("click", function(e){ if(e.target === $("tokenMask")) closeTokenMask(); });
    }

    function start(){
      if(!Auth.ensureLoggedIn()) return;

      ensureSeedDict();
      loadDB();

      // ✅ NEW：一進頁面先把明細的連結補進附件欄（立刻顯示「開啟」）
      mergeDetailIntoMain({ persist:true, quiet:true });

      bindUIOnce();

      syncUserUI();
      applyReadMode(isReadModeOn());

      initCloudOnce();
      scheduleRender();
    }

    Auth.init({
      onAuthed: function(){ toast("登入成功"); start(); },
      onSessionChange: function(){ syncUserUI(); scheduleRender(); },
      onForceRelogin: function(msg){
        toast(msg || "請重新登入");
        syncUserUI();
        try{ closeModal(); closePrompt(); closeTokenMask(); }catch(e){}
        scheduleRender();
      }
    });

    var toAuth = $("loginToAuth");
    if(toAuth) toAuth.onclick = function(){ go("權限表.html"); };

    start();
  }

  (function(onReady){
    onReady(run);
  })(function(fn){
    try{
      var W = window.__TASUN_WAIT__ || window.__TASUN_READY__;
      if(W){
        if(typeof W.push === "function"){ W.push(fn); return; }
        if(typeof W.then === "function"){ W.then(fn); return; }
        if(W.ready === true){ fn(); return; }
      }
    }catch(e){}
    if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", fn);
    else fn();
  });

})();
</script>
