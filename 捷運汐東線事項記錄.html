<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>捷運汐東線事項記錄 · Tasun</title>

  <link rel="icon" href="data:,">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- ✅ 全站版本：要與 tasun-version.json 一致 -->
  <script>window.TASUN_APP_VER="20260127_05";</script>

  <!-- ✅ 進站必鎖定最新版 ?v=APP_VER（舊書籤也會跳轉成最新；避免無限轉） -->
  <script>
  (function(){
    try{
      var APP=(window.TASUN_APP_VER||"").toString().trim(); if(!APP) return;
      var u=new URL(location.href);
      var cur=(u.searchParams.get("v")||"").toString().trim();
      var KEY="tasun_force_v_once__sxdh_notes__"+(cur||"none")+"_to_"+APP;
      if(cur!==APP && !sessionStorage.getItem(KEY)){
        sessionStorage.setItem(KEY,"1");
        u.searchParams.set("v",APP);
        location.replace(u.toString());
        return;
      }
    }catch(e){}
  })();
  </script>

  <!-- ✅ 共用等待方式（全站共用）：可 push(fn) 排隊、也保留 then(fn) 相容 -->
  <script>
  (function(){
    var APP=(window.TASUN_APP_VER||"").toString().trim(); if(!APP) return;

    var WAIT=window.__TASUN_READY__;
    if(!WAIT || typeof WAIT!=="object"){
      var _q=[], _ready=false, _resolve=null;
      var _p=new Promise(function(res){ _resolve=res; });
      WAIT={
        get ready(){ return _ready; },
        push:function(fn){
          if(typeof fn!=="function") return;
          if(_ready){ try{fn();}catch(e){} }
          else _q.push(fn);
        },
        then:function(a,b){ return _p.then(a,b); },
        flush:function(){
          if(_ready) return;
          _ready=true;
          try{_resolve(true);}catch(e){}
          var list=_q.splice(0);
          for(var i=0;i<list.length;i++){ try{list[i]();}catch(e){} }
        }
      };
      window.__TASUN_READY__=WAIT;
    }
    window.__TASUN_WAIT__=WAIT;

    function addV(src){ return src+(src.indexOf("?")>=0?"&":"?")+"v="+encodeURIComponent(APP); }
    function hasScript(id){ return !!document.querySelector('script[data-tasun-id="'+id+'"]'); }
    function loadOnce(id, src){
      return new Promise(function(resolve){
        if(hasScript(id)) return resolve(true);
        var s=document.createElement("script");
        s.src=src; s.async=false; s.setAttribute("data-tasun-id",id);
        s.onload=function(){resolve(true);};
        s.onerror=function(){resolve(false);};
        document.head.appendChild(s);
      });
    }

    (async function(){
      try{
        if(!window.TasunCore) await loadOnce("tasun-core", addV("tasun-core.js"));
        await loadOnce("tasun-boot", addV("tasun-boot.js"));
        await loadOnce("tasun-cloud-kit", addV("tasun-cloud-kit.js"));
      }catch(e){}
      try{ if(!WAIT.ready) WAIT.flush(); }catch(e){}
    })();
  })();
  </script>

  <!-- ✅ 防黑屏保險：就算 boot/重置流程把 body 隱藏，也會自動恢復顯示（避免你看到整頁只剩背景） -->
  <script>
  (function(){
    function forceShow(){
      try{
        var de=document.documentElement, b=document.body;
        if(de){
          de.style.removeProperty("visibility");
          de.style.removeProperty("opacity");
          de.style.removeProperty("filter");
          de.classList.remove("tasun-hide","tasun-hidden","tasun-prehide","tasun-wait");
        }
        if(b){
          b.style.removeProperty("visibility");
          b.style.removeProperty("opacity");
          b.style.removeProperty("filter");
          b.style.removeProperty("display");
          b.classList.remove("tasun-hide","tasun-hidden","tasun-prehide","tasun-wait");
        }
      }catch(e){}
    }
    try{
      var WAIT = window.__TASUN_WAIT__ || window.__TASUN_READY__;
      if(WAIT && typeof WAIT.push==="function") WAIT.push(forceShow);
    }catch(e){}
    setTimeout(forceShow, 1500);
  })();
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700;800;900&family=Noto+Serif+TC:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#aebfb9;--bg1:#93aca5;--bg2:#cbbf9c;--ink:#1f2422;
      --glassTop: rgba(255,255,255,.70);--glassMid: rgba(255,255,255,.22);--glassBot: rgba(255,255,255,.08);
      --stageTopA: rgba(255,252,245,.72);--stageTopB: rgba(240,214,160,.14);
      --stageBotA: rgba(250,255,253,.60);--stageBotB: rgba(190,235,225,.12);
      --r:18px;--shadow: 0 18px 50px rgba(32,26,18,.16);--shadow2: 0 10px 26px rgba(32,26,18,.10);
      --goldHi: rgba(255,254,246,.98);--goldText: rgba(246,214,150,.98);--goldDeep: rgba(206,126,26,.98);
      --edge: rgba(62,34,10,.62);--edgeSoft: rgba(94,56,20,.44);--microShadow: rgba(0,0,0,.18);
      --border: rgba(132,84,18,.40);--border2: rgba(246,214,150,.58);
      --tableBg1: rgba(44,76,70,.88);--tableBg2: rgba(26,52,48,.86);--tableLine: rgba(255,255,255,.18);
      --tableText: rgba(246,214,150,.98);--tableMuted: rgba(246,214,150,.68);
      --tableEdge: rgba(40,22,8,.44);--stageSide: 1cm;
      --titleSize: clamp(28px, 2.6vw, 42px);--subSize: clamp(12.5px, 1.05vw, 15.5px);
      --labelSize: clamp(13.5px, 1.00vw, 15.5px);--ctrlSize: clamp(13.5px, 1.05vw, 16px);
      --thSize: clamp(15.5px, 1.15vw, 17.5px);--tdSize: clamp(14.5px, 1.08vw, 16.5px);
      --readBody: clamp(14.5px, 1.10vw, 17.5px);
      --wTitle:820;--wStrong:720;--wUI:680;--wTable:650;--wBtn:680;
      --modalTitleSize: clamp(18px, 1.7vw, 24px);
      --btnStroke:.30px;--btnEdge: rgba(255,230,180,.22);--btnShadow: rgba(0,0,0,.22);
      --blurStage:0px;--blurBtn:0px;--blurCtrl:0px;--blurTable:0px;
    }
    @media (max-width: 520px){ :root{ --stageSide: 12px; } }
    *{box-sizing:border-box}
    html,body{height:100%}
    html{
      background:
        radial-gradient(1000px 560px at 50% 120px, rgba(203,191,156,.14), transparent 64%),
        radial-gradient(1200px 900px at 32% 36%, rgba(160,198,189,.16), transparent 68%),
        radial-gradient(1100px 820px at 76% 40%, rgba(145,180,170,.14), transparent 70%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    body{
      margin:0;color:var(--ink);
      font-family:"Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      background:inherit;overflow:hidden;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
      text-rendering: optimizeLegibility;
    }
    .goldCrystal{
      color:var(--goldText);
      background:linear-gradient(180deg,var(--goldHi) 0%,rgba(255,246,224,.98) 18%,var(--goldText) 46%,rgba(226,156,54,.98) 78%,var(--goldHi) 100%);
      -webkit-background-clip:text;background-clip:text;
      text-shadow:
        0.40px 0 0 var(--edge),-0.40px 0 0 var(--edge),0 0.40px 0 var(--edge),0 -0.40px 0 var(--edge),
        0.50px 0.50px 0 var(--edgeSoft),-0.50px 0.50px 0 var(--edgeSoft),0.50px -0.50px 0 var(--edgeSoft),-0.50px -0.50px 0 var(--edgeSoft),
        0 1.2px 1.8px var(--microShadow),0 0 12px rgba(255,220,150,.07);
      filter: drop-shadow(0 1px 0 rgba(255,255,255,.05));
    }
    @supports (-webkit-background-clip:text) or (background-clip:text){
      .goldCrystal{color:transparent;-webkit-text-fill-color:transparent;-webkit-text-stroke:.44px rgba(80,45,10,.24);}
    }
    .goldCrystalModal{
      color:var(--goldText);
      background:linear-gradient(180deg,rgba(255,254,246,.99) 0%,rgba(255,248,228,.99) 18%,rgba(252,228,170,.99) 46%,rgba(235,168,64,.99) 78%,rgba(255,254,246,.99) 100%);
      -webkit-background-clip:text;background-clip:text;
      text-shadow:0.42px 0 0 rgba(40,22,8,.38),-0.42px 0 0 rgba(40,22,8,.38),0 0.42px 0 rgba(40,22,8,.38),0 -0.42px 0 rgba(40,22,8,.38),
        0 1.8px 2.4px rgba(0,0,0,.28),0 0 18px rgba(255,214,140,.10);
      filter: drop-shadow(0 1px 0 rgba(255,255,255,.05)) brightness(1.10);
    }
    @supports (-webkit-background-clip:text) or (background-clip:text){
      .goldCrystalModal{color:transparent;-webkit-text-fill-color:transparent;-webkit-text-stroke:.52px rgba(255,230,180,.18);}
    }
    .wrap{
      width:min(1720px, calc(100vw - (2 * var(--stageSide)) ));
      margin:0 auto;padding:18px 16px;height:100vh;
      display:flex;flex-direction:column;gap:16px;
    }
    .topbar{
      position:relative;z-index:20;
      display:grid;grid-template-columns: 1fr auto 1fr;gap:12px;align-items:center;
      padding:16px;border:1px solid var(--border);border-radius:var(--r);
      background:
        radial-gradient(120% 180% at 24% 10%, var(--stageTopA), transparent 60%),
        radial-gradient(160% 200% at 78% 12%, var(--stageTopB), transparent 70%),
        linear-gradient(180deg, var(--glassTop), var(--glassMid) 62%, var(--glassBot));
      box-shadow:var(--shadow);overflow:hidden;
    }
    @media (max-width:920px){
      .topbar{ grid-template-columns:1fr; }
      .nav-left{ order:0; }.brand{ order:1; }.right{ order:2; justify-content:flex-start; }
    }
    .nav-left{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-start; min-width:220px;}
    .nav-desktop{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .nav-mobile{display:none; gap:10px; align-items:center; width:100%;}
    @media (max-width:600px){ .nav-desktop{display:none;} .nav-mobile{display:flex;} }
    .brand{display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:center;text-align:center;}
    .title{font-family:"Noto Serif TC","Noto Sans TC",serif;font-weight:var(--wTitle);letter-spacing:.10em;font-size:var(--titleSize);line-height:1.12;}
    .sub{font-size:var(--subSize);color:rgba(120,86,28,.80);letter-spacing:.12em;font-weight:var(--wUI);text-align:center;text-shadow:0 1px 0 rgba(255,255,255,.10);}
    .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;min-width:220px;}
    @media (max-width:920px){ .right{ justify-content:flex-start; } }
    .pill{
      padding:10px 14px;border-radius:999px;border:1px solid rgba(132,84,18,.24);
      background:linear-gradient(180deg, rgba(255,255,255,.20), rgba(255,255,255,.08));
      font-size:14px;color:rgba(120,86,28,.86);
      display:flex;gap:8px;align-items:center;white-space:nowrap;
      box-shadow:var(--shadow2);font-weight:var(--wUI);letter-spacing:.04em;
    }
    .pill b{font-weight:var(--wStrong);}
    .btn{
      appearance:none;border:1px solid rgba(132,84,18,.24);
      background:
        radial-gradient(120% 220% at 18% 10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(160% 240% at 74% 90%, rgba(175,220,210,.07), transparent 70%),
        radial-gradient(150% 200% at 82% 18%, rgba(210,180,120,.05), transparent 66%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      padding:12px 16px;border-radius:999px;cursor:pointer;font-family:inherit;
      font-weight:var(--wBtn);letter-spacing:.06em;
      font-size:clamp(13.5px, 1.02vw, 15.5px);
      box-shadow:0 14px 26px rgba(32,26,18,.12), inset 0 1px 0 rgba(255,255,255,.26);
      transition:transform .12s ease, filter .12s ease, border-color .12s ease, box-shadow .12s ease;
      user-select:none;white-space:nowrap;color:var(--goldDeep);
    }
    .btn:hover{transform:translateY(-1px);filter:brightness(1.02);border-color:rgba(246,214,150,.46);box-shadow:0 16px 30px rgba(32,26,18,.14), inset 0 1px 0 rgba(255,255,255,.30);}
    .btn:active{transform:none; filter:brightness(.99)}
    .btn.ghost{background:radial-gradient(120% 220% at 20% 16%, rgba(255,255,255,.08), transparent 60%),linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));border:1px solid rgba(132,84,18,.20);}
    .btn.danger{border-color:rgba(170,60,60,.40);}
    .small{padding:11px 16px;font-size:14px;border-radius:999px;letter-spacing:.05em}
    .btn[disabled]{opacity:.45;cursor:not-allowed;filter:none !important;transform:none !important;}
    .btn .t{color:var(--goldDeep);text-shadow:0 1px 1.4px rgba(0,0,0,.18);}
    @supports (-webkit-background-clip:text) or (background-clip:text){
      .btn .t{
        color:transparent;
        background: linear-gradient(180deg,rgba(255,254,246,.98) 0%,rgba(255,246,224,.98) 18%,rgba(246,214,150,.98) 46%,rgba(226,156,54,.98) 78%,rgba(255,254,246,.98) 100%);
        -webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;
        -webkit-text-stroke: var(--btnStroke) var(--btnEdge);
        text-shadow:0 1px 1.6px var(--btnShadow),0 0 10px rgba(255,220,150,.05);
        filter: drop-shadow(0 1px 0 rgba(255,255,255,.04));
      }
      .btn.small .t{-webkit-text-stroke: calc(var(--btnStroke) + .10px) rgba(255,230,180,.24);text-shadow:0 1.2px 1.8px rgba(0,0,0,.22), 0 0 12px rgba(255,214,140,.06);}
    }
    .panel{
      border:1px solid var(--border);border-radius:var(--r);
      background:
        radial-gradient(120% 170% at 22% 14%, var(--stageBotA), transparent 64%),
        radial-gradient(160% 190% at 80% 22%, var(--stageBotB), transparent 72%),
        linear-gradient(180deg, rgba(255,255,255,.28), rgba(255,255,255,.14) 60%, rgba(255,255,255,.08));
      box-shadow:var(--shadow);padding:16px;overflow:hidden;position:relative;flex:1;
      display:flex;flex-direction:column;min-height:0;
    }
    .panelHead{position:relative;z-index:2;display:flex;flex-direction:column;gap:10px;flex:0 0 auto;}
    .controls{display:grid;grid-template-columns: 1.3fr .9fr .9fr auto;gap:10px;align-items:end;}
    @media (max-width:920px){ .controls{grid-template-columns:1fr 1fr} }
    @media (max-width:520px){ .controls{grid-template-columns:1fr} }
    .field{display:flex; flex-direction:column; gap:7px}
    .label{font-size:var(--labelSize);letter-spacing:.10em;font-weight:var(--wUI);color:rgba(150,104,34,.88);text-align:center;text-shadow:0 1px 0 rgba(255,255,255,.10);}
    input,select,textarea{
      width:100%;border-radius:14px;border:1px solid rgba(132,84,18,.28);
      background: linear-gradient(180deg, rgba(10,14,13,.80), rgba(10,14,13,.64));
      color:var(--goldText);padding:12px 13px;
      font-family:"Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      font-size:var(--ctrlSize);font-weight:var(--wUI);outline:none;
      transition:border-color .12s ease, filter .12s ease, box-shadow .12s ease;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.08),0 10px 22px rgba(0,0,0,.10);
      text-shadow:0 1px 1.2px rgba(0,0,0,.22);
    }
    input:focus,select:focus,textarea:focus{
      border-color: rgba(246,214,150,.52);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.10),0 0 0 3px rgba(246,214,150,.12),0 12px 26px rgba(0,0,0,.14);
    }
    textarea{min-height:92px; resize:vertical;}
    input::placeholder{ color: rgba(246,214,150,.62); }
    select{ text-align:center; text-align-last:center; font-weight:800; }
    select option{ background: rgba(12,14,13,.98); color: rgba(246,214,150,.98); }
    .hint{color: rgba(106,74,24,.92);font-size:14px;line-height:1.7;font-weight:var(--wUI);text-align:center;text-shadow: 0 1px 0 rgba(255,255,255,.10);}
    .panelBody{position:relative;z-index:2;flex:1;min-height:0;display:flex;flex-direction:column;}
    .tableWrap{
      position:relative;margin-top:4px;overflow:auto;border-radius:16px;border:1px solid rgba(246,214,150,.26);
      background: linear-gradient(180deg, rgba(10,14,13,.18), rgba(10,14,13,.10));
      box-shadow: var(--shadow2);flex:1;min-height:0;
    }
    table{
      width:100%;border-collapse:collapse;min-width:1460px;
      background: linear-gradient(180deg, var(--tableBg1), var(--tableBg2));
      font-family:"DFKai-SB","BiauKai","標楷體","KaiTi","STKaiti","Kaiti TC","Noto Serif TC",serif;
    }
    thead th{
      position:sticky; top:0; z-index:3;
      padding:14px 12px;border-bottom:1px solid rgba(246,214,150,.30);
      white-space:nowrap;text-align:center;letter-spacing:.10em;
      font-size:var(--thSize);font-weight:var(--wStrong);color:rgba(255,242,210,.98);
      text-shadow:0 .6px 0 rgba(255,255,255,.08), 0 1.6px 2.2px rgba(0,0,0,.18);
      background: linear-gradient(180deg, rgba(46,78,72,.88), rgba(22,44,40,.84));
    }
    tbody td{
      padding:14px 12px;border-bottom:1px solid var(--tableLine);vertical-align:top;
      font-size:var(--tdSize);color:var(--tableText);line-height:1.70;
      font-weight:var(--wTable);letter-spacing:.02em;
      text-shadow:0.30px 0 0 var(--tableEdge),-0.30px 0 0 var(--tableEdge),0 0.30px 0 var(--tableEdge),0 -0.30px 0 var(--tableEdge),0 1px 1.8px rgba(0,0,0,.18);
    }
    tbody td:nth-child(2),tbody td:nth-child(7){text-align:justify;text-justify:inter-ideograph;word-break:break-word;}
    tbody tr:nth-child(even) td{ background: rgba(255,255,255,.018); }
    tbody tr:nth-child(odd) td{ background: rgba(0,0,0,.04); }
    tbody tr:hover td{ background: rgba(255,255,255,.055); }
    tbody tr.sel td{ background: rgba(246,214,150,.14); }
    .muted{ color: var(--tableMuted); opacity:.85; }
    .attBtn{
      display:inline-flex;align-items:center;justify-content:center;gap:6px;
      padding:10px 14px;border-radius:999px;border:1px solid rgba(246,214,150,.28);
      background:radial-gradient(120% 220% at 20% 12%, rgba(255,255,255,.10), transparent 62%),linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      cursor:pointer;white-space:nowrap;
      box-shadow:0 12px 22px rgba(0,0,0,.16), inset 0 1px 0 rgba(255,255,255,.20);
      font-weight:var(--wBtn);
    }
    .attBtn .t{color: var(--goldDeep);text-shadow:0 1px 1.4px rgba(0,0,0,.18);letter-spacing:.05em;font-weight:900;}
    .mask{
      position:fixed; inset:0;display:none;align-items:center;justify-content:center;
      padding:20px;z-index:100;
      background: radial-gradient(900px 560px at 50% 42%, rgba(0,0,0,.42), rgba(0,0,0,.68));
    }
    .modal{
      width:min(980px, 96vw);border-radius:22px;border:1px solid rgba(246,214,150,.26);
      background: linear-gradient(180deg, rgba(14,18,16,.92), rgba(10,14,13,.84));
      box-shadow:0 32px 110px rgba(0,0,0,.50);overflow:hidden;position:relative;
    }
    .mHead{
      padding:14px 16px;display:grid;grid-template-columns: 1fr auto 1fr;align-items:center;gap:10px;
      border-bottom:1px solid rgba(246,214,150,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      min-height:56px;
    }
    .mTitle{grid-column:2;justify-self:center;letter-spacing:.14em;font-family:"Noto Serif TC","Noto Sans TC",serif;font-size:var(--modalTitleSize);font-weight:900;white-space:nowrap;}
    .mHead .btn{grid-column:3;justify-self:end;}
    .mBody{padding:14px 16px 16px;color:rgba(243,227,194,.96);}
    .modal .label{ color: rgba(246,214,150,.94); text-shadow: 0 1px 0 rgba(0,0,0,.12); }
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .span2{grid-column:span 2}
    @media (max-width:720px){ .grid{grid-template-columns:1fr} .span2{grid-column:span 1} table{min-width:1320px} }
    .inline2{display:grid;grid-template-columns: 1fr auto;gap:10px;align-items:end}
    @media (max-width:520px){
      .inline2{grid-template-columns:1fr}
      .mHead{grid-template-columns: 1fr auto;}
      .mTitle{grid-column:1;justify-self:start;}
      .mHead .btn{grid-column:2;}
    }
    .miniHint{font-size:12px;line-height:1.6;font-weight:var(--wUI);color: rgba(243,227,194,.72);text-align:center;}
    .mFoot{
      padding:14px 16px;display:flex;gap:10px;justify-content:flex-end;border-top:1px solid rgba(246,214,150,.12);
      flex-wrap:wrap;background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.05));
    }
    .pMask{
      position:fixed; inset:0;background: radial-gradient(800px 520px at 50% 42%, rgba(0,0,0,.42), rgba(0,0,0,.68));
      display:none;align-items:center;justify-content:center;padding:20px;z-index:160;
    }
    .pModal{
      width:min(560px, 96vw);border-radius:20px;border:1px solid rgba(246,214,150,.24);
      background: linear-gradient(180deg, rgba(14,18,16,.92), rgba(10,14,13,.84));
      box-shadow:0 30px 90px rgba(0,0,0,.42);overflow:hidden;
    }
    .pHead{
      padding:12px 14px;display:grid;grid-template-columns: 1fr auto 1fr;align-items:center;border-bottom:1px solid rgba(246,214,150,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));min-height:52px;
    }
    .pTitle{grid-column:2;justify-self:center;letter-spacing:.14em;font-size: clamp(16px, 1.6vw, 22px);font-family:"Noto Serif TC","Noto Sans TC",serif;font-weight:900;white-space:nowrap;}
    .pHead .btn{grid-column:3;justify-self:end;}
    .pBody{padding:14px;}
    .pFoot{padding:12px 14px;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;border-top:1px solid rgba(246,214,150,.12);background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.05));}
    .toast{
      position:fixed;left:50%;transform:translateX(-50%);bottom:18px;
      padding:10px 14px;border-radius:999px;border:1px solid rgba(246,214,150,.22);
      background:rgba(14,18,16,.72);color:rgba(246,214,150,.96);
      font-size:14px;box-shadow:0 18px 50px rgba(0,0,0,.30);
      display:none;z-index:200;font-weight:var(--wUI);letter-spacing:.06em;text-shadow:0 1px 1.4px rgba(0,0,0,.18);
    }
    .loginMask{
      position:fixed; inset:0;background: radial-gradient(900px 560px at 50% 42%, rgba(0,0,0,.42), rgba(0,0,0,.68));
      display:none;align-items:center;justify-content:center;padding:20px;z-index:999;
    }
    .loginMask.show{display:flex;}
    .loginModal{
      width:min(520px, 96vw);border-radius:22px;border:1px solid rgba(246,214,150,.24);
      background: linear-gradient(180deg, rgba(14,18,16,.92), rgba(10,14,13,.84));
      box-shadow:0 30px 90px rgba(0,0,0,.42);overflow:hidden;position:relative;
    }
    .loginHead{
      padding:14px 16px;display:grid;grid-template-columns: 1fr auto 1fr;align-items:center;
      border-bottom:1px solid rgba(246,214,150,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      min-height:56px;
    }
    .loginTitle{grid-column:2;justify-self:center;font-weight:900;letter-spacing:.14em;font-family:"Noto Serif TC","Noto Sans TC",serif;font-size: clamp(16px, 1.6vw, 22px);white-space:nowrap;}
    .loginHead .btn{grid-column:3;justify-self:end;}
    .loginBody{padding:14px 16px 10px;}
    .loginFoot{padding:12px 16px;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;border-top:1px solid rgba(246,214,150,.12);background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.05));}
    .loginErr{
      margin-top:10px;color:rgba(255,145,145,.95);
      font-size:14px;line-height:1.6;display:none;white-space:pre-wrap;font-weight:900;
      text-shadow:0 1px 1.4px rgba(0,0,0,.22);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="nav-left">
        <div class="nav-desktop">
          <button class="btn ghost small" id="btnHome"><span class="t">返回首頁</span></button>
          <button class="btn ghost small" id="btnNew"><span class="t">新增</span></button>
          <button class="btn ghost small" id="btnEdit"><span class="t">修改</span></button>
          <button class="btn ghost small danger" id="btnDel"><span class="t">刪除</span></button>
          <button class="btn ghost small" id="btnExport"><span class="t">匯出</span></button>
          <button class="btn ghost small" id="btnImport"><span class="t">匯入</span></button>
          <button class="btn ghost small" id="btnPull"><span class="t">雲端同步</span></button>
          <button class="btn ghost small danger" id="btnResetAll"><span class="t">全設備重置</span></button>
        </div>
        <div class="nav-mobile">
          <button class="btn ghost small" id="btnNew_m"><span class="t">新增</span></button>
          <button class="btn ghost small" id="btnEdit_m"><span class="t">修改</span></button>
          <button class="btn ghost small danger" id="btnResetAll_m"><span class="t">全設備重置</span></button>
        </div>
      </div>

      <div class="brand">
        <div class="title goldCrystal">捷運汐東線事項記錄</div>
        <div class="sub">Tasun · Notes</div>
      </div>

      <div class="right">
        <div class="pill">
          <span>目前：</span><b id="who">未登入</b>
          <span id="roleTxt" class="muted"></span>
        </div>
        <button class="btn small" id="btnLogin"><span class="t">切換帳號</span></button>
      </div>
    </div>

    <div class="panel">
      <div class="panelHead">
        <div class="controls">
          <div class="field">
            <div class="label">記事內容（快速新增）</div>
            <textarea id="qContent" placeholder="輸入記事內容…（可先快速新增，細項再按『修改』補）"></textarea>
          </div>

          <div class="field">
            <div class="label">工種</div>
            <select id="qTrade">
              <option value="">（未分類）</option>
              <option>土建</option>
              <option>機電</option>
              <option>軌道</option>
              <option>管線</option>
              <option>綜合</option>
            </select>
          </div>

          <div class="field">
            <div class="label">系統</div>
            <select id="qSystem">
              <option value="">（未分類）</option>
              <option>通用</option>
              <option>電力</option>
              <option>弱電</option>
              <option>給排水</option>
              <option>空調</option>
              <option>消防</option>
            </select>
          </div>

          <button class="btn" id="btnQuickAdd"><span class="t">新增</span></button>
        </div>

        <div class="hint" id="hintLine">提示：點選表格列可選取；「修改/刪除」針對目前選取列。</div>
      </div>

      <div class="panelBody">
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="width:86px;">項次</th>
                <th>記事內容</th>
                <th style="width:140px;">工種</th>
                <th style="width:160px;">系統</th>
                <th style="width:180px;">附件</th>
                <th>備註</th>
                <th style="width:180px;">登錄日期</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 編輯/新增 Modal -->
  <div class="mask" id="editMask">
    <div class="modal">
      <div class="mHead">
        <div class="mTitle goldCrystalModal" id="mTitle">新增</div>
        <button class="btn ghost small" id="mClose"><span class="t">關閉</span></button>
      </div>
      <div class="mBody">
        <div class="grid">
          <div class="field span2">
            <div class="label">記事內容</div>
            <textarea id="mContent" placeholder="輸入記事內容…"></textarea>
          </div>

          <div class="field">
            <div class="label">工種</div>
            <select id="mTrade">
              <option value="">（未分類）</option>
              <option>土建</option>
              <option>機電</option>
              <option>軌道</option>
              <option>管線</option>
              <option>綜合</option>
            </select>
          </div>

          <div class="field">
            <div class="label">系統</div>
            <select id="mSystem">
              <option value="">（未分類）</option>
              <option>通用</option>
              <option>電力</option>
              <option>弱電</option>
              <option>給排水</option>
              <option>空調</option>
              <option>消防</option>
            </select>
          </div>

          <div class="field span2">
            <div class="label">附件（可貼網址；多筆用換行）</div>
            <textarea id="mAttach" placeholder="https://..."></textarea>
            <div class="miniHint">提示：附件會顯示「開啟」按鈕（預設開第一筆）。</div>
          </div>

          <div class="field span2">
            <div class="label">備註</div>
            <textarea id="mNote" placeholder="備註…"></textarea>
          </div>
        </div>
      </div>
      <div class="mFoot">
        <button class="btn ghost" id="mSave"><span class="t">儲存</span></button>
      </div>
    </div>
  </div>

  <!-- 確認 Modal -->
  <div class="pMask" id="confirmMask">
    <div class="pModal">
      <div class="pHead">
        <div class="pTitle goldCrystalModal" id="cTitle">確認</div>
        <button class="btn ghost small" id="cClose"><span class="t">關閉</span></button>
      </div>
      <div class="pBody" id="cBody" style="color:rgba(243,227,194,.96);line-height:1.8;"></div>
      <div class="pFoot">
        <button class="btn ghost" id="cCancel"><span class="t">取消</span></button>
        <button class="btn danger" id="cOK"><span class="t">確定</span></button>
      </div>
    </div>
  </div>

  <!-- Login -->
  <div class="loginMask" id="loginMask">
    <div class="loginModal">
      <div class="loginHead">
        <div class="loginTitle goldCrystalModal">登入</div>
        <button class="btn ghost small" id="loginClose"><span class="t">關閉</span></button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label">帳號</div>
          <input id="loginUser" placeholder="alex / tasun / wu" autocomplete="username">
        </div>
        <div class="field" style="margin-top:10px;">
          <div class="label">密碼</div>
          <input id="loginPass" type="password" placeholder="密碼" autocomplete="current-password">
        </div>
        <div class="loginErr" id="loginErr"></div>
      </div>
      <div class="loginFoot">
        <button class="btn" id="loginOK"><span class="t">登入</span></button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <input type="file" id="fileImport" accept="application/json" style="display:none;">

  <script>
  (function(){
    "use strict";

    // -----------------------------
    // Utilities
    // -----------------------------
    function $(sel, root){ return (root||document).querySelector(sel); }
    function escapeHtml(s){
      s = (s===undefined||s===null) ? "" : String(s);
      return s.replace(/[&<>"']/g, function(c){
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]);
      });
    }
    function pad2(n){ n = String(n); return n.length<2?("0"+n):n; }
    function fmtDate(ts){
      try{
        var d = ts ? new Date(ts) : new Date();
        if(isNaN(d.getTime())) d = new Date();
        return d.getFullYear()+"/"+pad2(d.getMonth()+1)+"/"+pad2(d.getDate())+" "+pad2(d.getHours())+":"+pad2(d.getMinutes());
      }catch(e){
        return "";
      }
    }
    function nowId(){
      return "n_"+Date.now().toString(36)+"_"+Math.random().toString(36).slice(2,8);
    }
    function toast(msg, ms){
      ms = ms || 1600;
      var el = $("#toast");
      if(!el) return;
      el.textContent = msg || "";
      el.style.display = "block";
      clearTimeout(toast._t);
      toast._t = setTimeout(function(){ el.style.display="none"; }, ms);
    }
    function onReady(fn){
      var W = window.__TASUN_WAIT__ || window.__TASUN_READY__;
      if(W && typeof W.push==="function") return W.push(fn);
      if(document.readyState!=="loading") return fn();
      document.addEventListener("DOMContentLoaded", fn);
    }

    // -----------------------------
    // Storage key (auto-detect old keys)
    // -----------------------------
    function detectKey(candidates, fallback){
      try{
        for(var i=0;i<candidates.length;i++){
          var k=candidates[i];
          if(localStorage.getItem(k)!==null) return k;
        }
        // heuristic scan
        for(var j=0;j<localStorage.length;j++){
          var kk = localStorage.key(j) || "";
          var low = kk.toLowerCase();
          if(low.indexOf("sxdh")>=0 || low.indexOf("汐東")>=0 || low.indexOf("事項")>=0){
            var v = localStorage.getItem(kk);
            if(v && v.length>2 && v.charAt(0)==="[" ) return kk;
          }
        }
      }catch(e){}
      return fallback;
    }

    var KEY_ROWS = detectKey(
      [
        "tasun_sxdh_notes_rows_v1",
        "tasun_sxdh_notes_v1",
        "tasun_sxdh_notes",
        "sxdh_notes",
        "tasun_mrt_notes"
      ],
      "tasun_sxdh_notes_rows_v1"
    );

    var KEY_USER = detectKey(
      [
        "tasun_sxdh_user_v1",
        "tasun_current_user_v1",
        "tasun_user_v1",
        "tasunCurrentUser"
      ],
      "tasun_sxdh_user_v1"
    );

    // -----------------------------
    // Users / Roles
    // -----------------------------
    var USERS = [
      {u:"alex",  p:"admin", role:"admin"},
      {u:"tasun", p:"write", role:"write"},
      {u:"wu",    p:"read",  role:"read"}
    ];

    function canWrite(){
      return state.user && (state.user.role==="admin" || state.user.role==="write");
    }

    // -----------------------------
    // State
    // -----------------------------
    var state = {
      rows: [],
      selectedId: "",
      user: null,
      cloudCtrl: null,
      cloudOk: false
    };

    // -----------------------------
    // Load / Save
    // -----------------------------
    function loadRows(){
      try{
        var raw = localStorage.getItem(KEY_ROWS);
        if(!raw) return [];
        var arr = JSON.parse(raw);
        if(!Array.isArray(arr)) return [];
        // normalize
        return arr.map(function(x){
          x = x || {};
          return {
            id: String(x.id||"").trim() || nowId(),
            content: String(x.content||x.text||"").trim(),
            trade: String(x.trade||"").trim(),
            system: String(x.system||"").trim(),
            attach: String(x.attach||x.attachment||"").trim(),
            note: String(x.note||"").trim(),
            ts: (x.ts||x.time||x.date||"") ? (new Date(x.ts||x.time||x.date)).getTime() : Date.now()
          };
        });
      }catch(e){
        return [];
      }
    }
    function saveRows(){
      try{
        localStorage.setItem(KEY_ROWS, JSON.stringify(state.rows));
      }catch(e){}
    }

    function loadUser(){
      try{
        var raw = localStorage.getItem(KEY_USER);
        if(!raw) return null;
        var u = JSON.parse(raw);
        if(u && u.u && u.role) return u;
      }catch(e){}
      return null;
    }
    function saveUser(u){
      try{
        if(!u) localStorage.removeItem(KEY_USER);
        else localStorage.setItem(KEY_USER, JSON.stringify(u));
      }catch(e){}
    }

    // -----------------------------
    // Render
    // -----------------------------
    function renderUser(){
      var who = $("#who"), roleTxt=$("#roleTxt");
      if(!who || !roleTxt) return;
      if(!state.user){
        who.textContent = "未登入";
        roleTxt.textContent = "";
      }else{
        who.textContent = state.user.u;
        roleTxt.textContent = "（"+state.user.role+"）";
      }
    }

    function setSelected(id){
      state.selectedId = id || "";
      var trs = document.querySelectorAll("#tbody tr[data-id]");
      for(var i=0;i<trs.length;i++){
        trs[i].classList.toggle("sel", trs[i].getAttribute("data-id")===state.selectedId);
      }
    }

    function firstAttach(attachStr){
      if(!attachStr) return "";
      var lines = String(attachStr).split(/\r?\n/).map(function(s){return s.trim();}).filter(Boolean);
      return lines[0] || "";
    }

    function renderTable(){
      var tb = $("#tbody");
      if(!tb) return;

      // sort by time desc
      var rows = state.rows.slice().sort(function(a,b){ return (b.ts||0) - (a.ts||0); });

      var html = "";
      for(var i=0;i<rows.length;i++){
        var r = rows[i];
        var idx = i+1;
        var att = firstAttach(r.attach);
        html += '<tr data-id="'+escapeHtml(r.id)+'">' +
          '<td style="text-align:center;white-space:nowrap;">'+idx+'</td>' +
          '<td>'+escapeHtml(r.content)+'</td>' +
          '<td style="text-align:center;white-space:nowrap;">'+escapeHtml(r.trade||"")+'</td>' +
          '<td style="text-align:center;white-space:nowrap;">'+escapeHtml(r.system||"")+'</td>' +
          '<td style="text-align:center;white-space:nowrap;">' +
            (att ? '<button class="attBtn" data-att="'+escapeHtml(att)+'"><span class="t">開啟</span></button>' : '<span class="muted">—</span>') +
          '</td>' +
          '<td>'+ (r.note ? escapeHtml(r.note) : '<span class="muted">—</span>') +'</td>' +
          '<td style="text-align:center;white-space:nowrap;">'+escapeHtml(fmtDate(r.ts))+'</td>' +
        '</tr>';
      }
      tb.innerHTML = html;

      // re-bind row click
      tb.onclick = function(ev){
        var t = ev.target;
        // attachment
        var btn = t && t.closest ? t.closest("button.attBtn") : null;
        if(btn){
          var url = btn.getAttribute("data-att") || "";
          if(url){ window.open(url, "_blank", "noopener"); }
          return;
        }
        var tr = t && t.closest ? t.closest("tr[data-id]") : null;
        if(tr){
          setSelected(tr.getAttribute("data-id")||"");
        }
      };

      // keep selection if exists
      if(state.selectedId) setSelected(state.selectedId);
    }

    // -----------------------------
    // Modal helpers
    // -----------------------------
    function openMask(id, show){
      var el = $(id);
      if(!el) return;
      el.style.display = show ? "flex" : "none";
    }

    function openEditor(mode, row){
      $("#mTitle").textContent = (mode==="edit" ? "修改" : "新增");
      $("#mContent").value = row ? (row.content||"") : ($("#qContent").value||"");
      $("#mTrade").value   = row ? (row.trade||"")   : ($("#qTrade").value||"");
      $("#mSystem").value  = row ? (row.system||"")  : ($("#qSystem").value||"");
      $("#mAttach").value  = row ? (row.attach||"")  : "";
      $("#mNote").value    = row ? (row.note||"")    : "";
      $("#mSave").setAttribute("data-mode", mode);
      $("#mSave").setAttribute("data-id", row ? row.id : "");
      openMask("#editMask", true);
      setTimeout(function(){ try{$("#mContent").focus();}catch(e){} }, 50);
    }

    function closeEditor(){
      openMask("#editMask", false);
    }

    // confirm dialog
    var confirmCb = null;
    function confirmBox(title, body, cb){
      confirmCb = cb || null;
      $("#cTitle").textContent = title || "確認";
      $("#cBody").textContent = body || "";
      openMask("#confirmMask", true);
    }
    function closeConfirm(){
      openMask("#confirmMask", false);
      confirmCb = null;
    }

    // -----------------------------
    // CRUD
    // -----------------------------
    function quickAdd(){
      if(!canWrite()){
        toast("目前帳號沒有寫入權限");
        return;
      }
      var c = ($("#qContent").value||"").trim();
      if(!c){
        toast("請先輸入記事內容");
        return;
      }
      var row = {
        id: nowId(),
        content: c,
        trade: ($("#qTrade").value||"").trim(),
        system: ($("#qSystem").value||"").trim(),
        attach: "",
        note: "",
        ts: Date.now()
      };
      state.rows.push(row);
      saveRows();
      $("#qContent").value = "";
      toast("已新增");
      renderTable();
      // auto select new row
      state.selectedId = row.id;
      setSelected(row.id);
      // optional: cloud save merged
      tryCloudSaveMerged();
    }

    function getSelectedRow(){
      var id = state.selectedId;
      if(!id) return null;
      for(var i=0;i<state.rows.length;i++){
        if(state.rows[i].id===id) return state.rows[i];
      }
      return null;
    }

    function deleteSelected(){
      if(!canWrite()){
        toast("目前帳號沒有寫入權限");
        return;
      }
      var r = getSelectedRow();
      if(!r){ toast("請先選取一列"); return; }
      confirmBox("刪除確認", "確定要刪除此筆記錄？（此動作可用匯入/雲端同步復原）", function(ok){
        if(!ok) return;
        state.rows = state.rows.filter(function(x){ return x.id!==r.id; });
        state.selectedId = "";
        saveRows();
        renderTable();
        toast("已刪除");
        tryCloudSaveMerged();
      });
    }

    function saveEditor(){
      if(!canWrite()){
        toast("目前帳號沒有寫入權限");
        return;
      }
      var mode = $("#mSave").getAttribute("data-mode") || "new";
      var id   = $("#mSave").getAttribute("data-id") || "";
      var obj = {
        content: ($("#mContent").value||"").trim(),
        trade: ($("#mTrade").value||"").trim(),
        system: ($("#mSystem").value||"").trim(),
        attach: ($("#mAttach").value||"").trim(),
        note: ($("#mNote").value||"").trim()
      };
      if(!obj.content){
        toast("記事內容不可空白");
        return;
      }
      if(mode==="edit"){
        var found=false;
        for(var i=0;i<state.rows.length;i++){
          if(state.rows[i].id===id){
            state.rows[i].content = obj.content;
            state.rows[i].trade = obj.trade;
            state.rows[i].system = obj.system;
            state.rows[i].attach = obj.attach;
            state.rows[i].note = obj.note;
            state.rows[i].ts = Date.now();
            found=true;
            break;
          }
        }
        if(!found){
          toast("找不到要修改的資料（可能剛同步變更）");
          closeEditor();
          return;
        }
        saveRows();
        renderTable();
        toast("已儲存");
        state.selectedId = id;
        setSelected(id);
      }else{
        var row = {
          id: nowId(),
          content: obj.content,
          trade: obj.trade,
          system: obj.system,
          attach: obj.attach,
          note: obj.note,
          ts: Date.now()
        };
        state.rows.push(row);
        saveRows();
        renderTable();
        toast("已新增");
        state.selectedId = row.id;
        setSelected(row.id);
      }
      closeEditor();
      tryCloudSaveMerged();
    }

    // -----------------------------
    // Export / Import
    // -----------------------------
    function exportJson(){
      try{
        var data = JSON.stringify(state.rows, null, 2);
        var blob = new Blob([data], {type:"application/json;charset=utf-8"});
        var a = document.createElement("a");
        var app = (window.TASUN_APP_VER||"").toString().trim();
        a.download = "捷運汐東線事項記錄_"+(app||"")+".json";
        a.href = URL.createObjectURL(blob);
        document.body.appendChild(a);
        a.click();
        setTimeout(function(){
          try{ URL.revokeObjectURL(a.href); }catch(e){}
          try{ a.remove(); }catch(e){}
        }, 600);
      }catch(e){
        toast("匯出失敗");
      }
    }

    function importJsonFile(file){
      if(!canWrite()){
        toast("目前帳號沒有寫入權限");
        return;
      }
      var fr = new FileReader();
      fr.onload = function(){
        try{
          var arr = JSON.parse(String(fr.result||""));
          if(!Array.isArray(arr)) throw new Error("not array");
          // merge by id
          var map = {};
          state.rows.forEach(function(r){ map[r.id]=r; });
          arr.forEach(function(x){
            x = x || {};
            var id = String(x.id||"").trim();
            if(!id) id = nowId();
            var nr = {
              id:id,
              content:String(x.content||x.text||"").trim(),
              trade:String(x.trade||"").trim(),
              system:String(x.system||"").trim(),
              attach:String(x.attach||x.attachment||"").trim(),
              note:String(x.note||"").trim(),
              ts: (x.ts||x.time||x.date) ? (new Date(x.ts||x.time||x.date)).getTime() : Date.now()
            };
            if(!map[id]) map[id]=nr;
            else{
              // prefer newer ts
              if((nr.ts||0) > (map[id].ts||0)) map[id]=nr;
            }
          });
          state.rows = Object.keys(map).map(function(k){ return map[k]; });
          saveRows();
          renderTable();
          toast("已匯入/合併");
          tryCloudSaveMerged();
        }catch(e){
          toast("匯入失敗：格式不正確");
        }
      };
      fr.readAsText(file);
    }

    // -----------------------------
    // Cloud (safe)
    // -----------------------------
    var RESOURCE_KEY = "tasun-sxdh-notes"; // ✅ 固定非空，避免 reset 後 mount 空 key 造成整頁中斷

    function getLocalForCloud(){
      // return array
      return state.rows.slice();
    }
    function applyFromCloud(remoteRows){
      // remoteRows may be {data:...} or array
      var arr = Array.isArray(remoteRows) ? remoteRows : (remoteRows && remoteRows.data && Array.isArray(remoteRows.data) ? remoteRows.data : []);
      // merge by id (prefer newer ts)
      var map = {};
      state.rows.forEach(function(r){ map[r.id]=r; });
      arr.forEach(function(x){
        x = x || {};
        var id = String(x.id||"").trim();
        if(!id) return;
        var nr = {
          id:id,
          content:String(x.content||x.text||"").trim(),
          trade:String(x.trade||"").trim(),
          system:String(x.system||"").trim(),
          attach:String(x.attach||x.attachment||"").trim(),
          note:String(x.note||"").trim(),
          ts: (x.ts||x.time||x.date) ? (new Date(x.ts||x.time||x.date)).getTime() : Date.now()
        };
        if(!map[id]) map[id]=nr;
        else if((nr.ts||0) > (map[id].ts||0)) map[id]=nr;
      });
      state.rows = Object.keys(map).map(function(k){ return map[k]; });
      saveRows();
      renderTable();
    }

    function tryCloudInit(){
      try{
        if(!window.TasunCloudKit || typeof window.TasunCloudKit.init!=="function") return;

        // init (safe)
        window.TasunCloudKit.init({
          appVer: (window.TASUN_APP_VER||"").toString().trim(),
          resourcesUrl: "tasun-resources.json",
          ui: { enabled:true, hideLockButtons:true, position:"bottom-right" },
          lock: { enabled:false, auto:false }
        });

        // ✅ mount guard：resourceKey 必須非空，mount 任何錯誤都吞掉，避免整頁壞掉
        if(!RESOURCE_KEY || !String(RESOURCE_KEY).trim()) return;

        var ctrl = null;
        try{
          ctrl = window.TasunCloudKit.mount({
            resourceKey: RESOURCE_KEY,
            pk: "id",
            getLocal: getLocalForCloud,
            apply: applyFromCloud
          });
        }catch(e){
          ctrl = null;
        }

        if(ctrl){
          state.cloudCtrl = ctrl;
          state.cloudOk = true;
        }
      }catch(e){}
    }

    function tryCloudPull(){
      try{
        if(state.cloudCtrl && state.cloudCtrl.pullNow){
          state.cloudCtrl.pullNow();
          toast("已觸發雲端同步");
        }else{
          toast("雲端未啟用（無 token 也可本機使用）");
        }
      }catch(e){
        toast("雲端同步失敗");
      }
    }

    function tryCloudSaveMerged(){
      try{
        if(state.cloudCtrl && state.cloudCtrl.saveMerged){
          state.cloudCtrl.saveMerged(getLocalForCloud, applyFromCloud);
        }else if(window.TasunCloudKit && window.TasunCloudKit.ctrl && window.TasunCloudKit.ctrl.saveMerged){
          // some kit versions expose singleton ctrl
          window.TasunCloudKit.ctrl.saveMerged(getLocalForCloud, applyFromCloud);
        }
      }catch(e){}
    }

    // -----------------------------
    // Full device reset (core fix)
    // -----------------------------
    async function fullReset(){
      // ✅ 這段就是修正重點：任何一步失敗都不會卡住；最後一定會 reload
      toast("重置中…");
      try{ if(state.cloudCtrl && state.cloudCtrl.destroy) state.cloudCtrl.destroy(); }catch(e){}
      try{ if(window.TasunCloudKit && window.TasunCloudKit.ctrl && window.TasunCloudKit.ctrl.destroy) window.TasunCloudKit.ctrl.destroy(); }catch(e){}

      try{ localStorage.clear(); }catch(e){}
      try{ sessionStorage.clear(); }catch(e){}

      // clear caches
      try{
        if(window.caches && caches.keys){
          var keys = await caches.keys();
          for(var i=0;i<keys.length;i++){
            try{ await caches.delete(keys[i]); }catch(e){}
          }
        }
      }catch(e){}

      // unregister sw
      try{
        if(navigator.serviceWorker && navigator.serviceWorker.getRegistrations){
          var regs = await navigator.serviceWorker.getRegistrations();
          for(var j=0;j<regs.length;j++){
            try{ await regs[j].unregister(); }catch(e){}
          }
        }
      }catch(e){}

      // always navigate
      try{
        var APP=(window.TASUN_APP_VER||"").toString().trim();
        var u=new URL(location.href);
        if(APP) u.searchParams.set("v", APP);
        u.searchParams.set("reset", "1"); // mark once
        location.replace(u.toString());
        return;
      }catch(e){
        try{ location.reload(); }catch(e2){}
      }
    }

    function cleanResetParam(){
      try{
        var u=new URL(location.href);
        if(u.searchParams.get("reset")==="1"){
          // avoid loop by cleaning
          u.searchParams.delete("reset");
          history.replaceState(null, "", u.toString());
        }
      }catch(e){}
    }

    // -----------------------------
    // Login
    // -----------------------------
    function openLogin(show){
      var el=$("#loginMask"); if(!el) return;
      el.classList.toggle("show", !!show);
      if(show){
        $("#loginErr").style.display="none";
        setTimeout(function(){ try{$("#loginUser").focus();}catch(e){} }, 60);
      }
    }
    function doLogin(){
      var u=($("#loginUser").value||"").trim();
      var p=($("#loginPass").value||"").trim();
      var hit=null;
      for(var i=0;i<USERS.length;i++){
        if(USERS[i].u===u && USERS[i].p===p){ hit=USERS[i]; break; }
      }
      if(!hit){
        var err=$("#loginErr");
        err.textContent="帳號或密碼錯誤";
        err.style.display="block";
        return;
      }
      state.user = {u:hit.u, role:hit.role};
      saveUser(state.user);
      renderUser();
      openLogin(false);
      toast("已登入");
    }

    // -----------------------------
    // Bind
    // -----------------------------
    function bind(){
      $("#btnHome").onclick = function(){ location.href="index.html?v="+encodeURIComponent((window.TASUN_APP_VER||"").toString().trim()); };
      $("#btnLogin").onclick = function(){ openLogin(true); };

      $("#btnNew").onclick = function(){ openEditor("new", null); };
      $("#btnNew_m").onclick = function(){ openEditor("new", null); };

      $("#btnEdit").onclick = function(){
        var r=getSelectedRow();
        if(!r){ toast("請先選取一列"); return; }
        openEditor("edit", r);
      };
      $("#btnEdit_m").onclick = function(){
        var r=getSelectedRow();
        if(!r){ toast("請先選取一列"); return; }
        openEditor("edit", r);
      };

      $("#btnDel").onclick = deleteSelected;

      $("#btnQuickAdd").onclick = quickAdd;

      $("#mClose").onclick = closeEditor;
      $("#mSave").onclick = saveEditor;

      $("#btnExport").onclick = exportJson;

      $("#btnImport").onclick = function(){ $("#fileImport").click(); };
      $("#fileImport").onchange = function(){
        var f = this.files && this.files[0];
        this.value = "";
        if(f) importJsonFile(f);
      };

      $("#btnPull").onclick = tryCloudPull;

      $("#btnResetAll").onclick = function(){
        confirmBox("全設備重置", "將清除本網站在此裝置上的 localStorage / sessionStorage / cache / service worker，並重新載入。\n\n確定要執行？", function(ok){
          if(ok) fullReset();
        });
      };
      $("#btnResetAll_m").onclick = $("#btnResetAll").onclick;

      // confirm
      $("#cClose").onclick = closeConfirm;
      $("#cCancel").onclick = function(){ closeConfirm(); };
      $("#cOK").onclick = function(){
        var cb = confirmCb; closeConfirm();
        if(cb) cb(true);
      };

      // login
      $("#loginClose").onclick = function(){ openLogin(false); };
      $("#loginOK").onclick = doLogin;
      $("#loginPass").addEventListener("keydown", function(e){
        if(e.key==="Enter") doLogin();
      });
      $("#loginUser").addEventListener("keydown", function(e){
        if(e.key==="Enter") doLogin();
      });
    }

    // -----------------------------
    // Init
    // -----------------------------
    onReady(function(){
      cleanResetParam();

      state.rows = loadRows();
      state.user = loadUser();

      renderUser();
      renderTable();
      bind();

      // if never logged in, show login (read-only users still ok)
      if(!state.user) openLogin(true);

      // init cloud safely
      tryCloudInit();
    });

  })();
  </script>
</body>
</html>
