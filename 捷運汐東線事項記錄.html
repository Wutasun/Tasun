<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>捷運汐東線事項記錄 · Tasun</title>

  <!-- ✅補 v：只在沒有 v 時補一次（避免無限轉），並提供 __withV 讓所有內部連結自動帶 v -->
  <script>
  (function(){
    const KEY = "tasun_force_refresh_once_notes_v1";
    try{
      const u = new URL(location.href);

      // 只在沒有 v 且本次 session 沒補過時補一次
      if(!u.searchParams.has("v") && !sessionStorage.getItem(KEY)){
        sessionStorage.setItem(KEY, "1");
        u.searchParams.set("v", String(Date.now()));
        location.replace(u.toString());
        return;
      }

      const v = u.searchParams.get("v") || "";
      window.__CACHE_V = v;

      window.__withV = function(href){
        try{
          if(!href) return href;
          // 外部連結不加 v
          if(/^https?:\/\//i.test(href) || /^mailto:/i.test(href) || /^file:/i.test(href)) return href;

          const x = new URL(href, location.href);
          if(window.__CACHE_V) x.searchParams.set("v", window.__CACHE_V);
          return x.pathname + x.search + x.hash;
        }catch(e){
          return href;
        }
      };
    }catch(e){}
  })();
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700;800;900&family=Noto+Serif+TC:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#aebfb9;
      --bg1:#93aca5;
      --bg2:#cbbf9c;
      --ink:#1f2422;

      /* ✅舞台更晶亮：提高玻璃不透明度、降低霧化來源 */
      --glassTop: rgba(255,255,255,.92);
      --glassMid: rgba(255,255,255,.62);
      --glassBot: rgba(255,255,255,.34);

      --stageTopA: rgba(255,252,245,.92);
      --stageTopB: rgba(240,214,160,.34);

      --stageBotA: rgba(250,255,253,.86);
      --stageBotB: rgba(190,235,225,.28);

      --r:18px;

      --shadow: 0 18px 50px rgba(32,26,18,.16);
      --shadow2: 0 10px 26px rgba(32,26,18,.10);

      /* ✅黃水晶字 */
      --goldHi: rgba(255,252,240,.98);
      --goldText: rgba(246,214,150,.98);
      --goldDeep: rgba(210,140,36,.98);
      --goldLow: rgba(160,92,18,.95);

      /* ✅描邊色 */
      --edge: rgba(26,14,6,.86);
      --edgeSoft: rgba(55,30,10,.55);

      /* ✅聚焦陰影（更細更短，避免糊） */
      --focusA: rgba(0,0,0,.20);
      --focusB: rgba(0,0,0,.12);

      /* ✅邊框更清楚（不靠 blur） */
      --border: rgba(132,84,18,.44);
      --border2: rgba(246,214,150,.62);

      --btnA: rgba(255,255,255,.32);
      --btnB: rgba(175,220,210,.12);
      --btnC: rgba(210,180,120,.10);

      /* ✅表格 */
      --tableBg1: rgba(30,52,48,.74);
      --tableBg2: rgba(22,40,38,.70);
      --tableLine: rgba(255,255,255,.12);
      --tableText: rgba(243,227,194,.98);
      --tableMuted: rgba(243,227,194,.68);
      --tableEdge: rgba(0,0,0,.52);

      --stageSide: 1cm;

      --titleSize: clamp(28px, 2.6vw, 42px);
      --subSize:   clamp(12.5px, 1.05vw, 15.5px);

      --labelSize: clamp(13.5px, 1.00vw, 15.5px);
      --ctrlSize:  clamp(13.5px, 1.05vw, 16px);

      --thSize:    clamp(15.5px, 1.15vw, 17.5px);
      --tdSize:    clamp(14.5px, 1.08vw, 16.5px);

      --readTitle: clamp(14.5px, 1.12vw, 17px);
      --readBody:  clamp(14.5px, 1.10vw, 17.5px);

      /* ✅字體粗細 */
      --wTitle: 820;
      --wStrong: 720;
      --wUI: 680;
      --wTable: 650;

      /* ✅✅✅新增：按鍵專用字重（解決「按鍵字太粗」） */
      --wBtn: 620;

      /* 霧化：全禁（不使用 blur） */
      --blurStage: 0px;
      --blurBtn:   0px;
      --blurCtrl:  0px;
      --blurTable: 0px;

      /* ✅按鍵文字：更薄的描邊/陰影參數 */
      --btnStroke: .18px;
      --btnEdge: rgba(26,14,6,.46);
      --btnFocusA: rgba(0,0,0,.16);
      --btnFocusB: rgba(0,0,0,.10);
    }

    @media (max-width: 920px){
      :root{
        --wTitle: 780;
        --wStrong: 700;
        --wUI: 660;
        --wTable: 640;
        --wBtn: 610;
      }
    }
    @media (max-width: 520px){
      :root{
        --wTitle: 740;
        --wStrong: 680;
        --wUI: 640;
        --wTable: 620;
        --wBtn: 600;
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    html{
      background:
        radial-gradient(1000px 560px at 50% 120px, rgba(203,191,156,.16), transparent 64%),
        radial-gradient(1200px 900px at 32% 36%, rgba(160,198,189,.18), transparent 68%),
        radial-gradient(1100px 820px at 76% 40%, rgba(145,180,170,.16), transparent 70%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    body{
      margin:0;
      color:var(--ink);
      font-family:"Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      background: inherit;
      overflow:hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: geometricPrecision;
    }

    body::before{
      content:"";
      position:fixed; inset:-60px;
      pointer-events:none;
      background:
        radial-gradient(circle at 18% 22%, rgba(255,255,255,.08), transparent 52%),
        radial-gradient(circle at 78% 20%, rgba(255,255,255,.06), transparent 56%),
        radial-gradient(circle at 50% 64%, rgba(255,255,255,.05), transparent 60%);
      opacity:.08;
      filter:none;
      mix-blend-mode: normal;
    }
    body::after{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background: radial-gradient(1400px 900px at 50% 52%, transparent 72%, rgba(55,50,40,.10) 98%);
      opacity:.04;
    }

    /* ✅黃水晶字（標題用，保留原效果） */
    .goldCrystal{
      color: var(--goldText);
      background:
        linear-gradient(180deg,
          var(--goldHi) 0%,
          rgba(255,245,220,.96) 12%,
          var(--goldText) 38%,
          var(--goldDeep) 68%,
          var(--goldHi) 100%);
      -webkit-background-clip:text;
      background-clip:text;

      text-shadow:
        0.55px 0 0 var(--edge),
        -0.55px 0 0 var(--edge),
        0 0.55px 0 var(--edge),
        0 -0.55px 0 var(--edge),
        0.55px 0.55px 0 var(--edgeSoft),
        -0.55px 0.55px 0 var(--edgeSoft),
        0.55px -0.55px 0 var(--edgeSoft),
        -0.55px -0.55px 0 var(--edgeSoft),
        0 1px 0 rgba(255,255,255,.14),
        0 2px 4px var(--focusA),
        0 5px 10px var(--focusB);
    }
    @supports (-webkit-background-clip:text) or (background-clip:text){
      .goldCrystal{
        color:transparent;
        -webkit-text-fill-color:transparent;
        -webkit-text-stroke: .35px rgba(26,14,6,.55);
      }
    }

    .wrap{
      width: min(1720px, calc(100vw - (2 * var(--stageSide))));
      margin:0 auto;
      padding: 18px 16px 18px;
      height:100vh;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .topbar{
      position:relative;
      z-index:20;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      gap:12px;
      align-items:center;
      padding:16px 16px;
      border:1px solid var(--border);
      border-radius:var(--r);
      background:
        radial-gradient(120% 180% at 24% 10%, var(--stageTopA), transparent 60%),
        radial-gradient(160% 200% at 78% 12%, var(--stageTopB), transparent 70%),
        linear-gradient(180deg, var(--glassTop), var(--glassMid) 62%, var(--glassBot));
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter:none;
      -webkit-backdrop-filter:none;
    }
    .topbar::before{
      content:"";
      position:absolute; inset:0;
      border-radius:var(--r);
      pointer-events:none;
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.68),
        inset 0 0 0 2px rgba(246,214,150,.18),
        inset 0 10px 22px rgba(255,255,255,.14);
      opacity:1;
    }
    .topbar::after{
      content:"";
      position:absolute;
      left: 14%;
      top: -70%;
      width: 34%;
      height: 170%;
      background: radial-gradient(circle at 30% 42%, rgba(255,255,255,.55), transparent 70%);
      transform: rotate(10deg);
      opacity:.05;
      pointer-events:none;
    }

    @media (max-width:920px){
      .topbar{ grid-template-columns:1fr; }
      .nav-left{ order:0; }
      .brand{ order:1; }
      .right{ order:2; justify-content:flex-start; }
    }

    .nav-left{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:flex-start;
      min-width:220px;
    }
    .nav-desktop{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .nav-mobile{ display:none; gap:10px; align-items:center; width:100%; }
    @media (max-width:600px){
      .nav-desktop{ display:none; }
      .nav-mobile{ display:flex; }
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:center;
      justify-content:center;
      text-align:center;
    }

    .title{
      font-family:"Noto Serif TC","Noto Sans TC",serif;
      font-weight:var(--wTitle);
      letter-spacing:.10em;
      font-size: var(--titleSize);
      line-height:1.12;
    }
    .sub{
      font-size: var(--subSize);
      color: rgba(120,86,28,.72);
      letter-spacing:.12em;
      font-weight:var(--wUI);
      text-align:center;
      text-shadow: 0 1px 0 rgba(255,255,255,.18);
    }

    .right{
      display:flex; gap:10px;
      align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
      min-width:220px;
    }
    @media (max-width:920px){ .right{ justify-content:flex-start; } }

    .pill{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(132,84,18,.26);
      background:linear-gradient(180deg, rgba(255,255,255,.52), rgba(255,255,255,.20));
      font-size:14px;
      color: rgba(120,86,28,.78);
      display:flex; gap:8px; align-items:center; white-space:nowrap;
      box-shadow: var(--shadow2);
      font-weight:var(--wUI);
      letter-spacing:.04em;
    }
    .pill b{ font-weight:var(--wStrong); }

    /* ✅按鍵：字變粗的根因在這裡（原本 var(--wStrong) + 強描邊陰影） */
    .btn{
      appearance:none;
      border:1px solid rgba(132,84,18,.28);
      background:
        radial-gradient(120% 220% at 18% 12%, rgba(255,255,255,.26), transparent 56%),
        radial-gradient(160% 220% at 62% 86%, rgba(175,220,210,.10), transparent 64%),
        radial-gradient(150% 200% at 82% 16%, rgba(210,180,120,.08), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
      padding:12px 16px;
      border-radius:999px;
      cursor:pointer;
      font-family:inherit;

      /* ✅✅✅改用按鍵專用字重，避免「粗黑」 */
      font-weight:var(--wBtn);

      letter-spacing:.06em;
      font-size: clamp(13.5px, 1.02vw, 15.5px);
      box-shadow:
        0 14px 26px rgba(32,26,18,.14),
        inset 0 1px 0 rgba(255,255,255,.56);
      transition:transform .12s ease, filter .12s ease, border-color .12s ease, box-shadow .12s ease;
      user-select:none;
      white-space:nowrap;
      color: rgba(210,140,36,.98);
    }
    .btn .t{ display:inline-block; }

    .btn:hover{
      transform:translateY(-1px);
      filter:brightness(1.03);
      border-color: rgba(246,214,150,.55);
      box-shadow:
        0 18px 34px rgba(32,26,18,.16),
        inset 0 1px 0 rgba(255,255,255,.62);
    }
    .btn:active{transform:translateY(0); filter:brightness(.99)}
    .btn.ghost{
      background:
        radial-gradient(120% 220% at 20% 16%, rgba(255,255,255,.18), transparent 56%),
        linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
      border:1px solid rgba(132,84,18,.22);
    }
    .btn.danger{
      border-color:rgba(170,60,60,.45);
      background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
    }
    .small{
      padding:11px 16px;
      font-size:14px;
      border-radius:999px;
      letter-spacing:.05em
    }
    .btn[disabled]{opacity:.45; cursor:not-allowed; filter:none !important; transform:none !important;}

    .opBtn{
      padding:11px 16px !important;
      font-size: clamp(13.5px, 1.02vw, 15.5px) !important;
      font-weight:var(--wBtn) !important; /* ✅✅✅ */
      min-width:86px;
    }

    /* ✅✅✅把「按鍵文字」從重度水晶套用群組拆開（這是關鍵） */
    .btn .t,
    .attBtn .t{
      font-weight:var(--wBtn);
      letter-spacing:.05em;
      color: var(--goldDeep); /* fallback：更深金，對比更好 */
    }

    /* ✅強調黃水晶（非按鍵：表頭/徽章/標題等） */
    .pill b,
    thead th,
    .badge,
    .chip b,
    .mTitle,
    .pTitle,
    .loginTitle{
      font-weight:var(--wStrong);
      color: var(--goldText);
    }

    /* ✅非按鍵：保留較強水晶效果 */
    @supports (-webkit-background-clip:text) or (background-clip:text){
      .pill b,
      thead th,
      .badge,
      .chip b,
      .mTitle,
      .pTitle,
      .loginTitle{
        color:transparent;
        background:
          linear-gradient(180deg,
            var(--goldHi) 0%,
            rgba(255,245,220,.96) 12%,
            var(--goldText) 38%,
            var(--goldDeep) 68%,
            var(--goldHi) 100%);
        -webkit-background-clip:text;
        background-clip:text;
        -webkit-text-fill-color:transparent;
        -webkit-text-stroke: .32px rgba(26,14,6,.52);

        text-shadow:
          0.55px 0 0 var(--edge),
          -0.55px 0 0 var(--edge),
          0 0.55px 0 var(--edge),
          0 -0.55px 0 var(--edge),
          0.55px 0.55px 0 var(--edgeSoft),
          -0.55px 0.55px 0 var(--edgeSoft),
          0.55px -0.55px 0 var(--edgeSoft),
          -0.55px -0.55px 0 var(--edgeSoft),
          0 1px 0 rgba(255,255,255,.12),
          0 2px 4px var(--focusA),
          0 5px 10px var(--focusB);
      }

      /* ✅✅✅按鍵：改用「薄描邊 + 少陰影」→字不會胖、不會糊 */
      .btn .t,
      .attBtn .t{
        color:transparent;
        background:
          linear-gradient(180deg,
            rgba(255,252,240,.98) 0%,
            rgba(255,245,220,.96) 14%,
            rgba(246,214,150,.98) 44%,
            rgba(210,140,36,.98) 74%,
            rgba(255,252,240,.98) 100%);
        -webkit-background-clip:text;
        background-clip:text;
        -webkit-text-fill-color:transparent;

        /* ✅更薄 */
        -webkit-text-stroke: var(--btnStroke) var(--btnEdge);

        /* ✅更少更短（避免變胖） */
        text-shadow:
          0.38px 0 0 var(--btnEdge),
          -0.38px 0 0 var(--btnEdge),
          0 0.38px 0 var(--btnEdge),
          0 -0.38px 0 var(--btnEdge),
          0 1px 0 rgba(255,255,255,.10),
          0 2px 4px var(--btnFocusA),
          0 4px 8px var(--btnFocusB);
      }
    }

    .moreWrap{ position:relative; display:inline-flex; }
    .moreMenu{
      position:absolute;
      top:calc(100% + 8px);
      right:0;
      min-width: 220px;
      border-radius:16px;
      border:1px solid rgba(246,214,150,.30);
      background:linear-gradient(180deg, rgba(18,22,20,.92), rgba(16,20,18,.78));
      box-shadow:0 18px 50px rgba(0,0,0,.35);
      padding:8px;
      display:none;
      z-index:60;
    }
    .moreMenu.open{ display:block; }
    .menuItem{
      width:100%;
      text-align:left;
      border:none;
      background:rgba(255,255,255,.06);
      color:rgba(235,215,178,.94);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-family:inherit;
      letter-spacing:.04em;
      font-weight:var(--wUI);
    }
    .menuItem:hover{ background:rgba(202,162,90,.14); color:rgba(246,214,150,.98); }
    .menuSep{ height:1px; margin:8px 6px; background:rgba(255,255,255,.10); }

    .panel{
      border:1px solid var(--border);
      border-radius:var(--r);
      background:
        radial-gradient(120% 170% at 22% 14%, var(--stageBotA), transparent 64%),
        radial-gradient(160% 190% at 80% 22%, var(--stageBotB), transparent 72%),
        linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,.34) 60%, rgba(255,255,255,.20));
      box-shadow: var(--shadow);
      padding:16px;
      overflow:hidden;
      position:relative;
      flex:1;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .panel::before{
      content:"";
      position:absolute; inset:0;
      border-radius:var(--r);
      pointer-events:none;
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.70),
        inset 0 0 0 2px rgba(246,214,150,.16),
        inset 0 12px 24px rgba(255,255,255,.14);
      opacity:1;
    }

    .panelHead{
      position:relative;
      z-index:2;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:0 0 auto;
    }

    .controls{
      display:grid;
      grid-template-columns: 1.3fr .9fr .9fr auto;
      gap:10px;
      align-items:end;
    }
    @media (max-width:920px){ .controls{grid-template-columns:1fr 1fr} }
    @media (max-width:520px){ .controls{grid-template-columns:1fr} }

    .field{display:flex; flex-direction:column; gap:7px}
    .label{
      font-size: var(--labelSize);
      letter-spacing:.10em;
      font-weight:var(--wUI);
      color: rgba(164,116,40,.78);
      text-align:center;
      text-shadow: 0 1px 0 rgba(255,255,255,.18);
    }

    input,select,textarea{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(132,84,18,.28);
      background: linear-gradient(180deg, rgba(14,18,16,.66), rgba(14,18,16,.48));
      color: rgba(246,214,150,.98);
      padding:12px 13px;
      font-family:"Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      font-size: var(--ctrlSize);
      font-weight:var(--wUI);
      outline:none;
      transition:border-color .12s ease, filter .12s ease;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
    }
    textarea{min-height:92px; resize:vertical;}
    input::placeholder{ color: rgba(246,214,150,.60); }
    select{ text-align:center; text-align-last:center; }

    input:focus,select:focus,textarea:focus{
      border-color:rgba(246,214,150,.70);
      filter:brightness(1.06);
    }
    input:disabled,select:disabled,textarea:disabled{
      opacity:.55; cursor:not-allowed; filter:saturate(.85);
    }

    select option{
      background-color: rgba(14,18,16,.98);
      color: rgba(246,214,150,.98);
      font-weight:var(--wUI);
      font-size: var(--ctrlSize);
      text-align:center;
    }

    .hint{
      color: rgba(124,88,30,.80);
      font-size:14px;
      line-height:1.7;
      font-weight:var(--wUI);
      text-align:center;
      text-shadow: 0 1px 0 rgba(255,255,255,.18);
    }

    .panelBody{
      position:relative;
      z-index:2;
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
    }

    .tableWrap{
      position:relative;
      margin-top:4px;
      overflow:auto;
      border-radius:16px;
      border:1px solid rgba(246,214,150,.24);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      box-shadow: var(--shadow2);
      flex:1;
      min-height:0;
    }
    .tableWrap::before{
      content:"";
      position:absolute; inset:0;
      border-radius:16px;
      pointer-events:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.20);
      opacity:.95;
    }

    table{
      width:100%;
      border-collapse:collapse;
      min-width:1320px;
      background:
        radial-gradient(140% 120% at 18% 0%, rgba(255,255,255,.08), transparent 55%),
        radial-gradient(140% 120% at 86% 18%, rgba(246,214,150,.06), transparent 62%),
        linear-gradient(180deg, var(--tableBg1), var(--tableBg2));
      font-family:"DFKai-SB","BiauKai","標楷體","KaiTi","Noto Serif TC",serif;
      position:relative;
      z-index:1;
    }

    thead th{
      position:sticky; top:0; z-index:3;
      background: linear-gradient(180deg, rgba(26,38,36,.84), rgba(20,30,28,.76));
      padding:14px 12px;
      border-bottom:1px solid rgba(246,214,150,.28);
      white-space:nowrap;
      text-align:center;
      letter-spacing:.10em;
      font-size: var(--thSize);
      font-weight:var(--wStrong);
    }

    tbody td{
      padding:14px 12px;
      border-bottom:1px solid var(--tableLine);
      vertical-align:top;
      font-size: var(--tdSize);
      color: var(--tableText);
      line-height:1.65;
      font-weight:var(--wTable);
      text-shadow:
        0.6px 0 0 var(--tableEdge),
        -0.6px 0 0 var(--tableEdge),
        0 0.6px 0 var(--tableEdge),
        0 -0.6px 0 var(--tableEdge),
        0 2px 3px rgba(0,0,0,.24);
    }
    tbody tr:hover td{ background: rgba(255,255,255,.05); }
    tbody tr.sel td{ background: rgba(246,214,150,.11); }

    .muted{ color: var(--tableMuted); }

    .attBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(246,214,150,.30);
      background: rgba(255,255,255,.09);
      cursor:pointer;
      white-space:nowrap;
      box-shadow: 0 12px 22px rgba(0,0,0,.18);

      /* ✅✅✅按鍵字重同步變輕 */
      font-weight:var(--wBtn);
    }
    .attBtn:hover{ filter:brightness(1.06); transform: translateY(-1px); }
    .attBtn:active{ transform:none; filter:brightness(.99); }

    /* =========================
       ✅閱讀模式：卡片
       ========================= */
    #cards{ display:none; position:relative; z-index:2; }
    body.readMode #tbl{ display:none; }
    body.readMode #cards{ display:block; padding: 10px; }

    .card{
      margin: 12px 0;
      border-radius: 18px;
      border: 1px solid rgba(246,214,150,.22);
      background:
        radial-gradient(140% 120% at 18% 0%, rgba(255,255,255,.08), transparent 55%),
        radial-gradient(140% 120% at 86% 18%, rgba(246,214,150,.06), transparent 62%),
        linear-gradient(180deg, rgba(26,44,40,.86), rgba(16,30,28,.80));
      box-shadow: 0 14px 34px rgba(0,0,0,.18);
      overflow:hidden;
      cursor:default;
    }
    .card.sel{
      border-color: rgba(246,214,150,.46);
      box-shadow: 0 16px 40px rgba(0,0,0,.22);
    }

    .cardTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      letter-spacing:.08em;
      font-size: var(--readTitle);
      white-space:nowrap;
      font-weight:var(--wStrong);
    }
    .badge .no{
      width:42px;
      height:30px;
      border-radius:10px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border:1px solid rgba(246,214,150,.26);
      background: rgba(255,255,255,.06);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
      color: rgba(246,214,150,.96);
      font-weight:var(--wStrong);
    }

    .cardNote{
      padding: 12px 14px 10px;
      color: rgba(243,227,194,.98);
      font-size: clamp(15.5px, 1.18vw, 18px);
      line-height: 1.95;
      letter-spacing:.02em;
      white-space: pre-wrap;
      word-break: break-word;
      text-align:left;
      text-shadow:
        0.6px 0 0 rgba(0,0,0,.45),
        -0.6px 0 0 rgba(0,0,0,.45),
        0 0.6px 0 rgba(0,0,0,.45),
        0 -0.6px 0 rgba(0,0,0,.45),
        0 2px 3px rgba(0,0,0,.22);
    }

    .cardSummary{
      padding: 10px 14px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-top: 1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.05);
      color: rgba(243,227,194,.88);
      font-weight:var(--wUI);
      letter-spacing:.06em;
      cursor:pointer;
      user-select:none;
    }
    .sumLeft{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      min-width:0;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius:999px;
      border:1px solid rgba(246,214,150,.18);
      background: rgba(0,0,0,.08);
      white-space:nowrap;
      font-weight:var(--wUI);
    }

    .sumRight{
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
      color: rgba(246,214,150,.94);
      font-weight:var(--wStrong);
    }
    .chev{
      display:inline-block;
      width: 10px;
      height: 10px;
      border-right: 2px solid rgba(246,214,150,.90);
      border-bottom:2px solid rgba(246,214,150,.90);
      transform: rotate(45deg);
      transition: transform .12s ease;
      margin-left:2px;
    }
    .card.expanded .chev{ transform: rotate(-135deg); }

    .cardDetails{
      display:none;
      padding: 12px 14px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.05);
    }
    .card.expanded .cardDetails{ display:block; }

    .dRow{
      display:flex;
      gap:12px;
      padding: 10px 0;
      border-bottom:1px solid rgba(255,255,255,.06);
      align-items:flex-start;
    }
    .dRow:last-child{ border-bottom:none; }

    .dLab{
      flex:0 0 92px;
      padding-top:2px;
      white-space:nowrap;
      text-align:center;
      font-size: var(--readTitle);
      letter-spacing:.12em;
      color: rgba(246,214,150,.94);
      font-weight:var(--wUI);
      text-shadow: 0 1px 0 rgba(0,0,0,.16);
    }
    .dVal{
      flex:1 1 auto;
      color: rgba(243,227,194,.98);
      font-weight:var(--wTable);
      font-size: var(--readBody);
      line-height:1.8;
      white-space: pre-wrap;
      word-break: break-word;
      text-shadow:
        0.6px 0 0 rgba(0,0,0,.42),
        -0.6px 0 0 rgba(0,0,0,.42),
        0 0.6px 0 rgba(0,0,0,.42),
        0 -0.6px 0 rgba(0,0,0,.42),
        0 2px 3px rgba(0,0,0,.22);
    }

    .mask{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:100;
      background:
        radial-gradient(900px 560px at 50% 42%, rgba(0,0,0,.48), rgba(0,0,0,.74)),
        rgba(0,0,0,.60);
      backdrop-filter:none;
      -webkit-backdrop-filter:none;
    }

    .modal{
      width:min(980px, 96vw);
      border-radius:22px;
      border:1px solid rgba(246,214,150,.30);
      background:
        radial-gradient(120% 160% at 18% 10%, rgba(255,255,255,.08), transparent 60%),
        radial-gradient(120% 160% at 82% 0%, rgba(246,214,150,.06), transparent 62%),
        linear-gradient(180deg, rgba(14,18,16,.94), rgba(10,14,13,.88));
      box-shadow:0 32px 110px rgba(0,0,0,.55);
      overflow:hidden;
      position:relative;
      filter:none;
      transform: translateZ(0);
      -webkit-font-smoothing: antialiased;
      text-rendering: geometricPrecision;
      backdrop-filter:none;
      -webkit-backdrop-filter:none;
    }
    .modal *{ filter:none; }

    .modal::before{
      content:"";
      position:absolute; inset:0;
      border-radius:22px;
      pointer-events:none;
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.14),
        inset 0 0 0 2px rgba(246,214,150,.08),
        inset 0 18px 34px rgba(255,255,255,.06);
      opacity:1;
    }

    .mHead{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      border-bottom:1px solid rgba(246,214,150,.14);
      position:relative; z-index:2;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      min-height:56px;
    }
    .mTitle{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      letter-spacing:.12em;
      font-family:"Noto Serif TC","Noto Sans TC",serif;
      font-size:20px;
      text-align:center;
      pointer-events:none;
      white-space:nowrap;
      font-weight:var(--wStrong);
    }

    .mBody{
      padding:14px 16px 16px;
      position:relative; z-index:2;
      color: rgba(243,227,194,.96);
    }

    .modal .label{
      color: rgba(246,214,150,.94);
      text-shadow: 0 1px 0 rgba(0,0,0,.16);
      text-align:center;
      font-weight:var(--wUI);
    }
    .modal .miniHint{
      color: rgba(243,227,194,.72);
      text-align:center;
    }

    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .span2{grid-column:span 2}
    @media (max-width:720px){
      .grid{grid-template-columns:1fr}
      .span2{grid-column:span 1}
      table{min-width:1200px}
    }
    .inline2{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end}
    .miniHint{font-size:12px; line-height:1.6; font-weight:var(--wUI);}

    .mFoot{
      padding:14px 16px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      border-top:1px solid rgba(246,214,150,.14);
      flex-wrap:wrap;
      position:relative; z-index:2;
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.05));
    }

    .pMask{
      position:fixed; inset:0;
      background:
        radial-gradient(800px 520px at 50% 42%, rgba(0,0,0,.46), rgba(0,0,0,.74)),
        rgba(0,0,0,.58);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:160;
    }
    .pModal{
      width:min(560px, 96vw);
      border-radius:20px;
      border:1px solid rgba(246,214,150,.28);
      background: linear-gradient(180deg, rgba(14,18,16,.94), rgba(10,14,13,.88));
      box-shadow:0 30px 90px rgba(0,0,0,.45);
      overflow:hidden;
      position:relative;
      transform: translateZ(0);
    }
    .pModal::before{
      content:"";
      position:absolute; inset:0;
      border-radius:20px;
      pointer-events:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.12);
      opacity:.95;
    }
    .pHead{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      border-bottom:1px solid rgba(246,214,150,.14);
      position:relative; z-index:2;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      min-height:52px;
    }
    .pTitle{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      letter-spacing:.12em;
      font-size:18px;
      font-family:"Noto Serif TC","Noto Sans TC",serif;
      text-align:center;
      pointer-events:none;
      white-space:nowrap;
      font-weight:var(--wStrong);
    }
    .pBody{padding:14px; position:relative; z-index:2;}
    .pFoot{
      padding:12px 14px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      border-top:1px solid rgba(246,214,150,.14);
      position:relative; z-index:2;
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.05));
    }

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(246,214,150,.26);
      background:rgba(14,18,16,.78);
      color:rgba(246,214,150,.96);
      font-size:14px;
      box-shadow:0 18px 50px rgba(0,0,0,.35);
      display:none;
      z-index:200;
      font-weight:var(--wUI);
      letter-spacing:.06em;
    }

    .loginMask{
      position:fixed; inset:0;
      background:
        radial-gradient(900px 560px at 50% 42%, rgba(0,0,0,.46), rgba(0,0,0,.74)),
        rgba(0,0,0,.60);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:999;
    }
    .loginMask.show{display:flex;}
    .loginModal{
      width:min(520px, 96vw);
      border-radius:22px;
      border:1px solid rgba(246,214,150,.28);
      background: linear-gradient(180deg, rgba(14,18,16,.94), rgba(10,14,13,.88));
      box-shadow:0 30px 90px rgba(0,0,0,.45);
      overflow:hidden;
      position:relative;
      transform: translateZ(0);
    }
    .loginModal::before{
      content:"";
      position:absolute; inset:0;
      border-radius:22px;
      pointer-events:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.12);
      opacity:.95;
    }
    .loginHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:flex-end; gap:10px;
      border-bottom:1px solid rgba(246,214,150,.14);
      position:relative; z-index:2;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      min-height:56px;
    }
    .loginTitle{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      font-weight:var(--wStrong); letter-spacing:.12em;
      font-family:"Noto Serif TC","Noto Sans TC",serif;
      font-size:18px;
      text-align:center;
      pointer-events:none;
      white-space:nowrap;
    }
    .loginBody{padding:14px 16px 10px; position:relative; z-index:2;}
    .loginFoot{
      padding:12px 16px;
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      border-top:1px solid rgba(246,214,150,.14);
      position:relative; z-index:2;
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.05));
    }
    .loginErr{
      margin-top:10px;
      color:rgba(255,145,145,.95);
      font-size:14px;
      line-height:1.6;
      display:none;
      white-space:pre-wrap;
      font-weight:var(--wStrong);
      text-align:center;
    }
    .loginHint{
      margin-top:10px;
      color: rgba(243,227,194,.78);
      font-size:12.5px;
      line-height:1.7;
      font-weight:var(--wUI);
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="nav-left">
        <div class="nav-desktop">
          <button class="btn ghost small" id="navBack"><span class="t">返回汐東工程管理表</span></button>
        </div>

        <div class="nav-mobile">
          <button class="btn ghost small" id="mBack"><span class="t">返回</span></button>
          <div class="moreWrap">
            <button class="btn ghost small" id="mMoreBtn" type="button"><span class="t">更多 ▾</span></button>
            <div class="moreMenu" id="mMoreMenu" role="menu" aria-label="更多選單">
              <button class="menuItem" data-href="汐東工程管理表.html" type="button">汐東工程管理表</button>
              <div class="menuSep"></div>
              <button class="menuItem" data-href="index.html" type="button">返回首頁</button>
            </div>
          </div>
        </div>
      </div>

      <div class="brand">
        <div class="title goldCrystal">捷運汐東線事項記錄</div>
        <div class="sub">記事內容 · 工種 · 系統 · 附件 · 登錄日期</div>
      </div>

      <div class="right">
        <div class="pill">使用者：<b id="uName">—</b></div>
        <div class="pill">權限：<b id="uRole">—</b></div>

        <!-- ✅顯示畫面（所有權限可用；會開啟所選筆的查看畫面） -->
        <button class="btn small" id="btnView"><span class="t">顯示畫面</span></button>

        <button class="btn small" id="btnAdd" style="display:none;"><span class="t">新增</span></button>
        <button class="btn small" id="btnEdit" style="display:none;"><span class="t">編輯</span></button>
      </div>
    </div>

    <div class="panel">
      <div class="panelHead">
        <div class="controls">
          <div class="field">
            <div class="label">搜尋（記事內容）</div>
            <input id="qText" placeholder="可輸入關鍵字，例如：送審、會議、現勘..." />
          </div>

          <div class="field">
            <div class="label">工種</div>
            <select id="fTrade"><option value="">全部</option></select>
          </div>

          <div class="field">
            <div class="label">系統</div>
            <select id="fSys"><option value="">全部</option></select>
          </div>

          <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
            <button class="btn ghost" id="btnCloud" type="button"><span class="t">雲端檔案</span></button>
            <button class="btn ghost" id="btnRead"><span class="t">閱讀模式：關</span></button>
            <button class="btn ghost" id="btnClear"><span class="t">清除條件</span></button>
          </div>
        </div>

        <div class="hint" id="hint"></div>
      </div>

      <div class="panelBody">
        <div class="tableWrap">
          <div id="cards"></div>

          <table id="tbl">
            <thead>
              <tr>
                <th style="width:90px;">項次</th>
                <th>記事內容</th>
                <th style="width:150px;">工種</th>
                <th style="width:150px;">系統</th>
                <th style="width:160px;">附件</th>
                <th style="width:220px;">備註</th>
                <th style="width:140px;">登錄日期</th>
                <th style="width:140px;">操作</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit/View Modal -->
  <div class="mask" id="mask">
    <div class="modal">
      <div class="mHead">
        <div class="mTitle" id="mTitle">查看</div>
        <button class="btn ghost small" id="btnClose"><span class="t">關閉</span></button>
      </div>

      <div class="mBody">
        <div class="grid">
          <div class="field span2">
            <div class="label">記事內容</div>
            <textarea id="mText" placeholder="請輸入記事內容（可多行）..."></textarea>
          </div>

          <div class="field">
            <div class="label">工種（下拉；可新增選項）</div>
            <div class="inline2">
              <select id="mTradeSel"></select>
              <button class="btn ghost small" id="btnAddTrade" type="button"><span class="t">新增工種</span></button>
            </div>
            <div class="miniHint">選單來源：本頁資料不重複 + 工種字典（可改）。</div>
          </div>

          <div class="field">
            <div class="label">系統（下拉；可新增選項）</div>
            <div class="inline2">
              <select id="mSysSel"></select>
              <button class="btn ghost small" id="btnAddSys" type="button"><span class="t">新增系統</span></button>
            </div>
            <div class="miniHint">系統會依「工種」優先帶入本頁資料不重複項；若無資料則回退字典。</div>
          </div>

          <div class="field span2">
            <div class="label">附件（超連結）</div>
            <input id="mAttach" placeholder="貼上連結，例如：https://... / Dropbox 連結 / file:///..." />
            <div class="miniHint">可留空。若是相對網址（同網站檔案），會自動帶 v 並可開啟。</div>
          </div>

          <div class="field span2">
            <div class="label">備註</div>
            <textarea id="mRemark" placeholder="可輸入備註（可多行）..."></textarea>
          </div>

          <div class="field">
            <div class="label">登錄日期（可改）</div>
            <input id="mDate" type="date" />
            <div class="miniHint">預設為今日；可用日曆修改。</div>
          </div>

          <div class="field">
            <div class="label">項次（固定：由小到大排序）</div>
            <input id="mNo" disabled />
          </div>
        </div>
      </div>

      <div class="mFoot">
        <button class="btn danger" id="btnDelete" style="display:none;"><span class="t">刪除</span></button>
        <button class="btn ghost" id="btnCancel"><span class="t">取消</span></button>
        <button class="btn" id="btnSave"><span class="t">儲存</span></button>
      </div>
    </div>
  </div>

  <!-- Prompt：新增 工種/系統 -->
  <div class="pMask" id="pMask">
    <div class="pModal">
      <div class="pHead">
        <div class="pTitle" id="pTitle">新增</div>
        <button class="btn ghost small" id="pClose" type="button"><span class="t">關閉</span></button>
      </div>
      <div class="pBody">
        <div class="field">
          <div class="label" id="pLabel">請輸入</div>
          <input id="pInput" placeholder="例如：機電 / 土建 / ..."/>
          <div class="miniHint">新增後會加入「選單字典」，維持選單一致。</div>
        </div>
      </div>
      <div class="pFoot">
        <button class="btn ghost" id="pCancel" type="button"><span class="t">取消</span></button>
        <button class="btn" id="pOk" type="button"><span class="t">確定新增</span></button>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="loginMask" id="loginMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="登入">
      <div class="loginHead">
        <div class="loginTitle">登入</div>
        <button class="btn ghost small" id="loginClose" type="button"><span class="t">關閉</span></button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label">帳號</div>
          <select id="loginUser" autocomplete="username">
            <option value="">請選擇帳號</option>
          </select>
        </div>
        <div class="field" style="margin-top:10px;">
          <div class="label">密碼</div>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="請輸入密碼" />
        </div>
        <div class="loginErr" id="loginErr"></div>
        <div class="loginHint">
          登入帳密完全以「權限表.html」的權限表（localStorage: <b>tasunAuthTable_v1</b>）為準。
        </div>
      </div>
      <div class="loginFoot">
        <button class="btn ghost" id="loginToAuth" type="button"><span class="t">前往權限表</span></button>
        <button class="btn" id="loginBtn" type="button"><span class="t">登入</span></button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    function go(href){
      location.href = (typeof window.__withV === "function") ? window.__withV(href) : href;
    }

    function openAttachment(href){
      const h = (href ?? "").toString().trim();
      if(!h) return;
      if(/^https?:\/\//i.test(h) || /^mailto:/i.test(h) || /^file:/i.test(h)){
        window.open(h, "_blank", "noopener");
        return;
      }
      go(h);
    }

    const CURRENT_KEY = "tasunCurrentUser_v1";
    const AUTH_KEY    = "tasunAuthTable_v1";

    const DB_KEY      = "tasunSxdhNotes_v1";
    const COUNTER_KEY = "tasunSxdhNotes_counter_v1";

    const TRADE_DICT_KEY = "tasunSxdhNotes_tradeDict_v1";
    const SYS_DICT_KEY   = "tasunSxdhNotes_sysDict_v1";

    const READ_MODE_KEY  = "tasunSxdhNotes_readMode_v1";

    const CLOUD_URL = "https://www.dropbox.com/scl/fo/glb4s65934h195bxuyuqm/AH5ClZ2u4MtPMvmgtfOUAa4?rlkey=tfxkpbpw8k9bctshx5xvuge8h&st=guo88r98&dl=0";

    let currentUser = null;
    let db = [];
    let editingId = null;
    let selectedId = null;
    let promptMode = null;

    const $ = (id) => document.getElementById(id);
    const norm = (s) => (s ?? "").toString().trim();

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.style.display = "none", 2600);
    }

    function escHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function mapRole(v){
      const s=(v??"").toString().trim().toLowerCase();
      if(!s) return "read";
      if(s==="admin") return "admin";
      if(s==="write"||s==="edit") return "write";
      if(s==="read"||s==="view") return "read";
      if(s==="0") return "admin";
      if(s==="1") return "write";
      if(s==="2") return "read";
      return s;
    }

    function loadAuthTable(){
      try{
        const raw = localStorage.getItem(AUTH_KEY);
        if(!raw) return [];
        const parsed = JSON.parse(raw);
        if(Array.isArray(parsed)) return parsed;
        if(parsed && Array.isArray(parsed.users)) return parsed.users;
        return [];
      }catch(e){ return []; }
    }

    function pickUsername(row){ return norm(row?.username ?? row?.user ?? row?.account ?? row?.name); }
    function pickPassword(row){ return (row?.password ?? row?.pass ?? row?.pwd ?? "").toString(); }
    function pickRole(row){ return mapRole(row?.role ?? row?.level ?? row?.perm ?? row?.permission); }

    function findAuthUser(username){
      const u = norm(username).toLowerCase();
      if(!u) return null;
      const rows = loadAuthTable();
      for(const r of rows){
        const ru = pickUsername(r).toLowerCase();
        if(ru && ru===u){
          return { user: pickUsername(r), pass: pickPassword(r), role: pickRole(r) || "read" };
        }
      }
      return null;
    }

    function loadCurrentUser(){
      try{ currentUser = JSON.parse(localStorage.getItem(CURRENT_KEY) || "null"); }
      catch(e){ currentUser = null; }

      if(currentUser && typeof currentUser==="object"){
        const uname = norm(currentUser.user ?? currentUser.username ?? currentUser.account ?? currentUser.name);
        if(uname){
          currentUser.user = uname;
          currentUser.username = uname;
        }
        currentUser.role = mapRole(currentUser.role ?? currentUser.level ?? "read");
        currentUser.level = currentUser.role;
        currentUser.authStamp = (currentUser.authStamp ?? "").toString();
      }
    }

    function setCurrentUser(user, role, authStamp){
      const obj = {
        user,
        username: user,
        role: mapRole(role),
        level: mapRole(role),
        authStamp: (authStamp || "").toString()
      };
      localStorage.setItem(CURRENT_KEY, JSON.stringify(obj));
      currentUser = obj;
    }

    function role(){ return mapRole(currentUser?.role ?? currentUser?.level ?? "read"); }
    function canWrite(){ const r=role(); return r==="admin" || r==="write"; }
    function isAdmin(){ return role()==="admin"; }

    function isReadModeOn(){ return localStorage.getItem(READ_MODE_KEY) === "1"; }
    function applyReadMode(on){
      document.body.classList.toggle("readMode", !!on);
      const b = $("btnRead");
      if(b) b.textContent = on ? "閱讀模式：開" : "閱讀模式：關";
      const t = b?.querySelector?.(".t");
      if(t) t.textContent = on ? "閱讀模式：開" : "閱讀模式：關";
      render();
    }
    function toggleReadMode(){
      const on = !document.body.classList.contains("readMode");
      localStorage.setItem(READ_MODE_KEY, on ? "1" : "0");
      applyReadMode(on);
      toast(on ? "已切換為閱讀模式（摘要點一下展開）" : "已切換為表格模式");
    }

    const SESSION_WATCH_MS = 3000;
    let _watchStarted = false;

    function fnv1a(str){
      let h = 0x811c9dc5;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 0x01000193);
      }
      return (h >>> 0).toString(16).padStart(8, "0");
    }
    function authStampFromAuth(auth){
      return fnv1a(`${auth.user}|${auth.pass ?? ""}`);
    }

    function rebuildUserDropdown(preselectUser){
      const sel = $("loginUser");
      const rows = loadAuthTable();
      const users = rows.map(r => pickUsername(r)).filter(Boolean);

      const seen = new Set();
      const uniq = [];
      for(const u of users){
        const k = u.toLowerCase();
        if(seen.has(k)) continue;
        seen.add(k);
        uniq.push(u);
      }

      sel.innerHTML = `<option value="">請選擇帳號</option>` + uniq.map(u=>{
        const s = (preselectUser && u.toLowerCase() === preselectUser.toLowerCase()) ? "selected" : "";
        return `<option value="${escHtml(u)}" ${s}>${escHtml(u)}</option>`;
      }).join("");
    }

    function openLoginModal(msg){
      $("loginErr").style.display="none";
      if(msg){
        $("loginErr").textContent = msg;
        $("loginErr").style.display="block";
      }
      loadCurrentUser();
      rebuildUserDropdown(currentUser?.user || "");

      $("loginPass").value="";
      $("loginMask").classList.add("show");
      $("loginMask").setAttribute("aria-hidden","false");
      setTimeout(()=>{
        if($("loginUser").value) $("loginPass").focus();
        else $("loginUser").focus();
      },0);
    }
    function closeLoginModal(){
      $("loginMask").classList.remove("show");
      $("loginMask").setAttribute("aria-hidden","true");
    }

    function forceReLogin(msg){
      try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}
      currentUser = null;
      toast(msg || "權限表已更新，請重新登入");
      openLoginModal(msg || "權限表已更新，請重新登入");
      $("uName").textContent="—";
      $("uRole").textContent="—";
      render();
    }

    function validateSession(){
      const lm = $("loginMask");
      if(lm && lm.classList.contains("show")) return;

      loadCurrentUser();
      if(!currentUser || !currentUser.user) return;

      const auth = findAuthUser(currentUser.user);
      if(!auth){ forceReLogin("帳號已被移除，請重新登入"); return; }

      const stampNow = authStampFromAuth(auth);

      if(!currentUser.authStamp){
        setCurrentUser(auth.user, auth.role || "read", stampNow);
        $("uName").textContent = auth.user;
        $("uRole").textContent = role();
        return;
      }

      if(currentUser.authStamp !== stampNow){
        forceReLogin("密碼已更新，請重新登入");
        return;
      }

      const r = auth.role || "read";
      if(mapRole(currentUser.role) !== r){
        setCurrentUser(auth.user, r, stampNow);
        $("uRole").textContent = r;
        render();
      }
    }

    function startSessionWatch(){
      if(_watchStarted) return;
      _watchStarted = true;

      window.addEventListener("storage", (e)=>{
        if(e.key === AUTH_KEY || e.key === CURRENT_KEY){
          validateSession();
        }
        if(e.key === DB_KEY){
          loadDB();
          render();
        }
        if(e.key === READ_MODE_KEY){
          applyReadMode(isReadModeOn());
        }
      });

      setInterval(validateSession, SESSION_WATCH_MS);
    }

    function ensureLoggedIn(){
      loadCurrentUser();
      const rows = loadAuthTable();
      if(!Array.isArray(rows) || rows.length === 0){
        openLoginModal("尚未建立權限表：請先到「權限表.html」建立帳號。");
        return false;
      }

      if(!currentUser || !currentUser.user){
        openLoginModal();
        return false;
      }

      const auth = findAuthUser(currentUser.user);
      if(!auth){ forceReLogin("帳號已被移除，請重新登入"); return false; }

      const stampNow = authStampFromAuth(auth);
      if(currentUser.authStamp && currentUser.authStamp !== stampNow){
        forceReLogin("密碼已更新，請重新登入");
        return false;
      }

      setCurrentUser(auth.user, auth.role || "read", stampNow);
      $("uName").textContent = auth.user;
      $("uRole").textContent = role();
      return true;
    }

    function doLogin(){
      const u = norm($("loginUser").value);
      const p = ($("loginPass").value ?? "").toString();
      const rows = loadAuthTable();

      if(!Array.isArray(rows) || rows.length === 0){
        $("loginErr").textContent = "尚未建立權限表：請先到「權限表.html」建立帳號。";
        $("loginErr").style.display = "block";
        return;
      }
      if(!u){
        $("loginErr").textContent = "請先選擇帳號。";
        $("loginErr").style.display = "block";
        return;
      }
      if(!p){
        $("loginErr").textContent = "請輸入密碼。";
        $("loginErr").style.display = "block";
        return;
      }

      const auth = findAuthUser(u);
      if(!auth){
        $("loginErr").textContent = "帳號不存在（以權限表為準）。";
        $("loginErr").style.display = "block";
        return;
      }
      if((auth.pass ?? "") !== p){
        $("loginErr").textContent = "密碼錯誤（以權限表為準）。";
        $("loginErr").style.display = "block";
        return;
      }

      const stampNow = authStampFromAuth(auth);
      setCurrentUser(auth.user, auth.role || "read", stampNow);

      closeLoginModal();
      toast("登入成功");
      start();
    }

    function loadDB(){
      try{
        const raw = localStorage.getItem(DB_KEY);
        db = raw ? JSON.parse(raw) : [];
        if(!Array.isArray(db)) db = [];
      }catch(e){ db = []; }
    }
    function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }

    function getCounter(){
      const n = Number(localStorage.getItem(COUNTER_KEY) || "0");
      return Number.isFinite(n) ? n : 0;
    }
    function nextCounter(){
      const n = getCounter() + 1;
      localStorage.setItem(COUNTER_KEY, String(n));
      return n;
    }

    function loadDict(key){
      try{
        const raw = localStorage.getItem(key);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr.map(norm).filter(Boolean) : [];
      }catch(e){ return []; }
    }
    function saveDict(key, arr){ localStorage.setItem(key, JSON.stringify(arr)); }

    function ensureSeedDict(){
      if(!localStorage.getItem(TRADE_DICT_KEY)){
        saveDict(TRADE_DICT_KEY, ["土建","機電","水電","消防","裝修","其他"]);
      }
      if(!localStorage.getItem(SYS_DICT_KEY)){
        saveDict(SYS_DICT_KEY, ["電氣","給排水","消防","空調","弱電","土建","其他"]);
      }
    }

    function uniqueFromDB(field){
      const set = new Set();
      for(const r of db){
        const v = norm(r[field]);
        if(v) set.add(v);
      }
      return set;
    }

    function unionOptions(field, dictKey){
      const set = uniqueFromDB(field);
      for(const v of loadDict(dictKey)) set.add(v);
      const arr = Array.from(set);
      arr.sort((a,b)=> a.localeCompare(b, "zh-Hant"));
      return arr;
    }

    function systemsByTradeFromDB(trade){
      const t = norm(trade);
      const set = new Set();
      if(!t) return [];
      for(const r of db){
        if(norm(r.trade) !== t) continue;
        const s = norm(r.system);
        if(s) set.add(s);
      }
      const arr = Array.from(set);
      arr.sort((a,b)=> a.localeCompare(b, "zh-Hant"));
      return arr;
    }

    function rebuildFilters(){
      const tSel = $("fTrade");
      const sSel = $("fSys");

      const keepT = norm(tSel.value);
      const keepS = norm(sSel.value);

      const trades = unionOptions("trade", TRADE_DICT_KEY);
      tSel.innerHTML = `<option value="">全部</option>` + trades.map(v=>`<option value="${escHtml(v)}">${escHtml(v)}</option>`).join("");
      tSel.value = trades.includes(keepT) ? keepT : "";

      const pickedTrade = norm(tSel.value);

      let systems = [];
      if(pickedTrade){
        systems = systemsByTradeFromDB(pickedTrade);
      }else{
        systems = unionOptions("system", SYS_DICT_KEY);
      }

      sSel.innerHTML = `<option value="">全部</option>` + systems.map(v=>`<option value="${escHtml(v)}">${escHtml(v)}</option>`).join("");

      if(pickedTrade && systems.length === 0){
        sSel.value = "";
        sSel.disabled = true;
      }else{
        sSel.disabled = false;
        sSel.value = systems.includes(keepS) ? keepS : "";
      }
    }

    function filteredRows(){
      const q = norm($("qText").value).toLowerCase();
      const t = norm($("fTrade").value);
      const s = norm($("fSys").value);

      let rows = db.slice();

      if(t) rows = rows.filter(r => norm(r.trade) === t);
      if(s) rows = rows.filter(r => norm(r.system) === s);

      if(q){
        rows = rows.filter(r => (r.text ?? "").toString().toLowerCase().includes(q));
      }

      rows.sort((a,b)=> (a.id||0) - (b.id||0));
      return rows;
    }

    function fillDropdown(selectId, options, placeholder){
      const sel = $(selectId);
      if(options.length === 0){
        sel.innerHTML = `<option value="" disabled selected>${escHtml(placeholder)}</option>`;
      }else{
        sel.innerHTML = options.map(v=>`<option value="${escHtml(v)}">${escHtml(v)}</option>`).join("");
      }
    }

    function modalSystemsForTrade(trade){
      const t = norm(trade);
      const byDB = t ? systemsByTradeFromDB(t) : [];
      if(byDB.length > 0) return byDB;

      const set = new Set();
      for(const v of loadDict(SYS_DICT_KEY)) set.add(norm(v));
      const arr = Array.from(set).filter(Boolean);
      arr.sort((a,b)=> a.localeCompare(b, "zh-Hant"));
      return arr;
    }

    function rebuildModalTradeOptions(selected){
      const trades = unionOptions("trade", TRADE_DICT_KEY);
      fillDropdown("mTradeSel", trades, "（請先新增工種）");
      const v = norm(selected);
      if(v && trades.includes(v)) $("mTradeSel").value = v;
    }

    function rebuildModalSystemOptions(trade, selected){
      const systems = modalSystemsForTrade(trade);
      fillDropdown("mSysSel", systems, "（請先新增系統）");
      const v = norm(selected);
      if(v && systems.includes(v)) $("mSysSel").value = v;
    }

    function setModalEditable(editable){
      $("btnSave").style.display = editable ? "inline-block" : "none";
      $("btnDelete").style.display = (editable && isAdmin() && editingId != null) ? "inline-block" : "none";

      ["mText","mTradeSel","mSysSel","mAttach","mRemark","mDate"].forEach(id=> $(id).disabled = !editable);

      const allowAddOpt = editable && canWrite();
      $("btnAddTrade").style.display = allowAddOpt ? "inline-block" : "none";
      $("btnAddSys").style.display   = allowAddOpt ? "inline-block" : "none";
      $("btnAddTrade").disabled = !allowAddOpt;
      $("btnAddSys").disabled   = !allowAddOpt;
    }

    function openModal(id, editable){
      validateSession();
      if(!currentUser || !currentUser.user){
        openLoginModal();
        return;
      }

      const item = (id == null) ? null : (db.find(x => x.id === id) || null);
      editingId = item ? item.id : null;

      rebuildModalTradeOptions(item?.trade || "");
      rebuildModalSystemOptions(norm($("mTradeSel").value) || item?.trade || "", item?.system || "");

      $("mTitle").textContent = editable ? (item ? "編輯" : "新增") : "顯示畫面";
      setModalEditable(editable);

      $("mNo").value = item?.id ?? (getCounter() + 1);
      $("mText").value = item?.text || "";
      $("mRemark").value = item?.remark || "";
      $("mDate").value = (item?.date || new Date().toISOString().slice(0,10));
      $("mAttach").value = item?.attach || item?.attachment || item?.file || "";

      if(!item){
        const t = norm($("mTradeSel").value);
        rebuildModalSystemOptions(t, norm($("mSysSel").value));
      }

      $("mask").style.display = "flex";
    }

    function closeModal(){ $("mask").style.display = "none"; }

    function saveItem(){
      validateSession();
      if(!currentUser || !currentUser.user){
        openLoginModal();
        return;
      }
      if(!canWrite()){ toast("唯讀權限不可儲存"); return; }

      const text = norm($("mText").value);
      if(!text){ toast("記事內容不可空白"); $("mText").focus(); return; }

      const trade  = norm($("mTradeSel").value);
      const system = norm($("mSysSel").value);
      if(!trade){ toast("工種尚未建立：請先按「新增工種」"); return; }
      if(!system){ toast("系統尚未建立：請先按「新增系統」"); return; }

      const attach = norm($("mAttach").value);
      const remark = norm($("mRemark").value);
      const date   = norm($("mDate").value) || new Date().toISOString().slice(0,10);

      if(editingId != null){
        const idx = db.findIndex(x => x.id === editingId);
        if(idx >= 0) db[idx] = { id: editingId, text, trade, system, attach, remark, date };
      }else{
        const id = nextCounter();
        db.push({ id, text, trade, system, attach, remark, date });
        selectedId = id;
      }

      saveDB();
      closeModal();
      render();
      toast("已儲存");
    }

    function deleteItem(){
      validateSession();
      if(!currentUser || !currentUser.user){
        openLoginModal();
        return;
      }
      if(!isAdmin()){ toast("僅 admin 可刪除"); return; }
      if(editingId == null) return;
      if(!confirm("確定刪除這筆記事？")) return;

      db = db.filter(x => x.id !== editingId);
      if(selectedId === editingId) selectedId = null;
      saveDB();

      closeModal();
      render();
      toast("已刪除");
    }

    function openPrompt(mode){
      validateSession();
      if(!currentUser || !currentUser.user){
        openLoginModal();
        return;
      }
      if(!canWrite()){ toast("read 權限不可新增選單"); return; }

      promptMode = mode;
      $("pInput").value = "";

      if(mode === "trade"){
        $("pTitle").textContent = "新增工種";
        $("pLabel").textContent = "請輸入新的工種";
        $("pInput").placeholder = "例如：土建 / 機電 / 水電...";
      }else{
        $("pTitle").textContent = "新增系統";
        $("pLabel").textContent = "請輸入新的系統";
        $("pInput").placeholder = "例如：電氣 / 給排水 / 消防...";
      }

      $("pMask").style.display = "flex";
      setTimeout(()=> $("pInput").focus(), 0);
    }

    function closePrompt(){
      $("pMask").style.display = "none";
      promptMode = null;
    }

    function addOption(){
      if(!canWrite()) return;

      const v = norm($("pInput").value);
      if(!v){ toast("不可空白"); $("pInput").focus(); return; }

      const key   = (promptMode === "trade") ? TRADE_DICT_KEY : SYS_DICT_KEY;
      const field = (promptMode === "trade") ? "trade" : "system";

      const exists = unionOptions(field, key).map(x=>x.toLowerCase());
      if(exists.includes(v.toLowerCase())){ toast("已存在相同選項"); return; }

      const dict = loadDict(key);
      dict.push(v);
      dict.sort((a,b)=> a.localeCompare(b, "zh-Hant"));
      saveDict(key, dict);

      if(promptMode === "trade"){
        rebuildModalTradeOptions(v);
        rebuildModalSystemOptions(norm($("mTradeSel").value), norm($("mSysSel").value));
        $("mTradeSel").value = v;
      }else{
        rebuildModalSystemOptions(norm($("mTradeSel").value), v);
        $("mSysSel").value = v;
      }

      render();

      closePrompt();
      toast("已新增選項");
    }

    function setupMoreMenu(backHref){
      const backBtn = $("mBack");
      const moreBtn = $("mMoreBtn");
      const menu = $("mMoreMenu");

      const close = ()=> menu.classList.remove("open");
      const toggle = (e)=>{
        e.preventDefault();
        e.stopPropagation();
        menu.classList.toggle("open");
      };

      backBtn.onclick = ()=> go(backHref);
      moreBtn.addEventListener("click", toggle);

      menu.addEventListener("click", (e)=>{
        e.stopPropagation();
        const item = e.target.closest("button.menuItem[data-href]");
        if(!item) return;
        const href = item.getAttribute("data-href");
        if(href) go(href);
      });

      document.addEventListener("click", close);
      window.addEventListener("keydown", (e)=>{ if(e.key === "Escape") close(); });
    }

    function render(){
      rebuildFilters();

      const rows = filteredRows();
      const writable = canWrite();

      $("btnAdd").style.display  = writable ? "inline-block" : "none";
      $("btnEdit").style.display = writable ? "inline-block" : "none";

      $("btnView").disabled = !selectedId;

      const rm = document.body.classList.contains("readMode");
      const tbody = $("tbody");
      const cards = $("cards");

      if(rm){
        tbody.innerHTML = "";
        cards.innerHTML = rows.map(r=>{
          const isSel = (selectedId === r.id);
          const att = norm(r.attach || r.attachment || r.file || "");
          const remark = (r.remark ?? "").toString().trim();
          const remarkShort = remark.length > 28 ? remark.slice(0, 28) + "…" : remark;

          const hasAtt = !!att;
          const trade = norm(r.trade) || "—";
          const system = norm(r.system) || "—";
          const date = norm(r.date) || "—";

          return `
            <div class="card ${isSel ? "sel" : ""}" data-id="${r.id}">
              <div class="cardTop">
                <div class="badge">
                  <span class="no">#${r.id ?? ""}</span>
                  <span>${escHtml(trade)} · ${escHtml(system)}</span>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                  ${hasAtt ? `<button class="attBtn" data-act="att" data-id="${r.id}"><span class="t">開啟附件</span></button>` : ``}
                  <button class="btn ghost opBtn" data-act="view" data-id="${r.id}"><span class="t">顯示畫面</span></button>
                </div>
              </div>

              <div class="cardNote">${escHtml((r.text ?? "").toString()).replaceAll("\n","<br>")}</div>

              <div class="cardSummary" data-act="toggle" data-id="${r.id}">
                <div class="sumLeft">
                  <span class="chip">登錄：<b>${escHtml(date)}</b></span>
                  <span class="chip">工種：<b>${escHtml(trade)}</b></span>
                  <span class="chip">系統：<b>${escHtml(system)}</b></span>
                  <span class="chip">附件：<b>${hasAtt ? "有" : "無"}</b></span>
                  <span class="chip">備註：<b>${remarkShort ? escHtml(remarkShort) : "—"}</b></span>
                </div>
                <div class="sumRight">展開 <span class="chev"></span></div>
              </div>

              <div class="cardDetails">
                <div class="dRow">
                  <div class="dLab">工種</div>
                  <div class="dVal">${escHtml(trade)}</div>
                </div>
                <div class="dRow">
                  <div class="dLab">系統</div>
                  <div class="dVal">${escHtml(system)}</div>
                </div>
                <div class="dRow">
                  <div class="dLab">登錄日</div>
                  <div class="dVal">${escHtml(date)}</div>
                </div>
                <div class="dRow">
                  <div class="dLab">附件</div>
                  <div class="dVal">${hasAtt ? escHtml(att) : "—"}</div>
                </div>
                <div class="dRow">
                  <div class="dLab">備註</div>
                  <div class="dVal">${remark ? escHtml(remark) : "—"}</div>
                </div>
                <div class="dRow">
                  <div class="dLab">操作</div>
                  <div class="dVal">
                    <button class="btn ghost opBtn" data-act="view" data-id="${r.id}"><span class="t">顯示畫面</span></button>
                    ${hasAtt ? `<button class="attBtn" data-act="att" data-id="${r.id}"><span class="t">開啟附件</span></button>` : ``}
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join("") || `<div class="muted" style="padding:18px;">尚無資料（write/admin 可用右上「新增」建立第一筆）</div>`;
      }else{
        cards.innerHTML = "";
        tbody.innerHTML = rows.map(r=>{
          const isSel = (selectedId === r.id);
          const att = norm(r.attach || r.attachment || r.file || "");
          const attCell = att
            ? `<button class="attBtn" data-act="att" data-id="${r.id}"><span class="t">開啟</span></button>`
            : `<span class="muted">—</span>`;

          const textHtml = escHtml((r.text ?? "").toString()).replaceAll("\n","<br>");
          const remarkHtml = escHtml((r.remark ?? "").toString()).replaceAll("\n","<br>");

          return `
            <tr data-id="${r.id}" class="${isSel ? "sel" : ""}">
              <td style="text-align:center;">${r.id ?? ""}</td>
              <td>${textHtml ? textHtml : `<span class="muted">—</span>`}</td>
              <td style="text-align:center;">${escHtml(r.trade) || `<span class="muted">—</span>`}</td>
              <td style="text-align:center;">${escHtml(r.system) || `<span class="muted">—</span>`}</td>
              <td style="text-align:center;">${attCell}</td>
              <td>${remarkHtml ? remarkHtml : `<span class="muted">—</span>`}</td>
              <td style="text-align:center;">${escHtml(r.date) || `<span class="muted">—</span>`}</td>
              <td style="text-align:center;">
                <button class="btn ghost opBtn" data-act="view" data-id="${r.id}"><span class="t">顯示畫面</span></button>
              </td>
            </tr>
          `;
        }).join("") || `
          <tr>
            <td colspan="8" class="muted" style="padding:18px;">尚無資料（write/admin 可用右上「新增」建立第一筆）</td>
          </tr>
        `;
      }

      const pickedTrade = norm($("fTrade").value);
      const sysDisabled = $("fSys").disabled;

      const modeText = canWrite() ? "可維護模式" : "唯讀模式";

      $("hint").innerHTML =
        `目前為 <b style="color:var(--goldText)">${modeText}</b>（role: ${escHtml(role())}）。` +
        ` 模式：<b style="color:var(--goldText)">${rm ? "閱讀模式（摘要點一下展開/收合）" : "表格模式"}</b>。` +
        ` 筆數：<b style="color:var(--goldText)">${rows.length}</b>。` +
        (pickedTrade && sysDisabled ? ` <span style="color:rgba(124,88,30,.82)">（此工種尚無系統可篩選）</span>` : ``) +
        (selectedId ? ` 已選取：<b style="color:var(--goldText)">#${selectedId}</b>` : `（請先點選一筆，再按右上「顯示畫面 / 編輯」）`);
    }

    function start(){
      if(!ensureLoggedIn()) return;

      ensureSeedDict();
      loadDB();

      $("navBack").onclick = () => go("汐東工程管理表.html");
      setupMoreMenu("汐東工程管理表.html");

      applyReadMode(isReadModeOn());
      $("btnRead").onclick = toggleReadMode;

      $("btnCloud").onclick = ()=> openAttachment(CLOUD_URL);

      $("btnView").onclick = ()=>{
        if(!selectedId){ toast("請先點選一筆，再按顯示畫面"); return; }
        openModal(selectedId, false);
      };

      $("qText").addEventListener("input", render);

      $("fTrade").addEventListener("change", () => { render(); });
      $("fSys").addEventListener("change", render);

      $("btnClear").onclick = () => {
        $("qText").value = "";
        $("fTrade").value = "";
        $("fSys").value = "";
        render();
      };

      $("btnAdd").onclick = ()=>{
        if(!canWrite()){ toast("唯讀不可新增"); return; }
        editingId = null;
        openModal(null, true);
      };

      $("btnEdit").onclick = ()=>{
        if(!canWrite()){ toast("唯讀不可編輯"); return; }
        if(!selectedId){ toast("請先點選項目再按編輯"); return; }
        openModal(selectedId, true);
      };

      $("btnClose").onclick = closeModal;
      $("btnCancel").onclick = closeModal;
      $("mask").addEventListener("click", (e)=>{ if(e.target === $("mask")) closeModal(); });

      $("btnSave").onclick = saveItem;
      $("btnDelete").onclick = deleteItem;

      $("btnAddTrade").onclick = () => openPrompt("trade");
      $("btnAddSys").onclick   = () => openPrompt("sys");

      $("pClose").onclick = closePrompt;
      $("pCancel").onclick = closePrompt;
      $("pOk").onclick = addOption;
      $("pMask").addEventListener("click", (e)=>{ if(e.target === $("pMask")) closePrompt(); });

      $("mTradeSel").addEventListener("change", ()=>{
        const t = norm($("mTradeSel").value);
        const keepSys = norm($("mSysSel").value);
        rebuildModalSystemOptions(t, keepSys);
      });

      $("tbody").addEventListener("click", (e)=>{
        const viewBtn = e.target.closest("button[data-act='view']");
        if(viewBtn){
          const id = Number(viewBtn.getAttribute("data-id"));
          if(Number.isFinite(id)) openModal(id, false);
          return;
        }

        const attBtn = e.target.closest("button[data-act='att']");
        if(attBtn){
          const id = Number(attBtn.getAttribute("data-id"));
          const item = db.find(x => x.id === id);
          const href = norm(item?.attach || item?.attachment || item?.file || "");
          if(!href){ toast("此筆尚未設定附件"); return; }
          openAttachment(href);
          return;
        }

        const tr = e.target.closest("tr[data-id]");
        if(!tr) return;
        const id = Number(tr.getAttribute("data-id"));
        if(!Number.isFinite(id)) return;
        selectedId = id;
        render();
      });

      $("cards").addEventListener("click", (e)=>{
        const viewBtn = e.target.closest("button[data-act='view']");
        if(viewBtn){
          const id = Number(viewBtn.getAttribute("data-id"));
          if(Number.isFinite(id)) openModal(id, false);
          return;
        }

        const attBtn = e.target.closest("button[data-act='att']");
        if(attBtn){
          const id = Number(attBtn.getAttribute("data-id"));
          const item = db.find(x => x.id === id);
          const href = norm(item?.attach || item?.attachment || item?.file || "");
          if(!href){ toast("此筆尚未設定附件"); return; }
          openAttachment(href);
          return;
        }

        const toggle = e.target.closest("[data-act='toggle']");
        if(toggle){
          const card = toggle.closest(".card");
          if(!card) return;
          card.classList.toggle("expanded");
          const sr = card.querySelector(".sumRight");
          if(sr) sr.firstChild && (sr.firstChild.textContent = card.classList.contains("expanded") ? "收合 " : "展開 ");
          const id = Number(card.getAttribute("data-id"));
          if(Number.isFinite(id)) selectedId = id;
          document.querySelectorAll(".card.sel").forEach(x=>x.classList.remove("sel"));
          card.classList.add("sel");
          render();
          return;
        }

        const card = e.target.closest(".card[data-id]");
        if(!card) return;
        const id = Number(card.getAttribute("data-id"));
        if(!Number.isFinite(id)) return;
        selectedId = id;
        render();
      });

      window.addEventListener("keydown", (e)=>{
        if(e.key === "Escape"){
          if($("pMask").style.display === "flex") closePrompt();
          else if($("mask").style.display === "flex") closeModal();
        }
        if(e.key === "Enter" && $("pMask").style.display === "flex") addOption();
      });

      render();
    }

    (function bindLogin(){
      $("loginClose").onclick = closeLoginModal;
      $("loginToAuth").onclick = ()=> go("權限表.html");
      $("loginBtn").onclick = doLogin;

      $("loginMask").addEventListener("click",(e)=>{
        if(e.target === $("loginMask")) closeLoginModal();
      });

      window.addEventListener("keydown",(e)=>{
        if(e.key === "Escape" && $("loginMask").classList.contains("show")) closeLoginModal();
        if(e.key === "Enter" && $("loginMask").classList.contains("show")) doLogin();
      });

      $("loginUser").addEventListener("change", ()=>{
        if($("loginUser").value) $("loginPass").focus();
      });
    })();

    startSessionWatch();
    start();
  </script>
</body>
</html>
