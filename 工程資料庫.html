<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>工程資料庫 · Tasun</title>

  <!-- ✅消掉 favicon 404 -->
  <link rel="icon" href="data:,">

  <!-- ✅✅✅ 防止 HTML 被快取（仍建議搭配 ?v 鎖版） -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- =====================================================
       ✅✅✅ 通用 Head 範本（全站一致）
       - tasun-boot.js：抓 tasun-version.json 的 ver，寫入 window.TASUN_APP_VER
       - 進站必鎖到 ?v=APP_VER（舊書籤也會跳到最新）
       - 載入 tasun-core.js?v=APP_VER，並做資源補 v、網路提示、appHeightVar
       ===================================================== -->

  <!-- ✅全站 Boot（請放在同資料夾） -->
  <script src="tasun-boot.js"></script>
  <script>
  (function(){
    // ✅fallback：如果 tasun-boot.js / tasun-version.json 尚未部署，先用固定值避免頁面掛掉
    window.TASUN_APP_VER = window.TASUN_APP_VER || "20260127_05";

    function fallbackLoadCore(){
      try{
        var v = String(window.TASUN_APP_VER || "").trim() || String(Date.now());
        var s = document.createElement("script");
        s.src = "tasun-core.js?v=" + encodeURIComponent(v);
        s.onload = function(){
          try{
            if(window.TasunCore){
              TasunCore.init({
                pageKey: "工程資料庫",
                forceVersionSync: true,
                networkToast: true,
                patchResources: true,
                appHeightVar: true
              });
              window.dispatchEvent(new CustomEvent("tasun:core-ready"));
            }
          }catch(e){}
        };
        document.head.appendChild(s);
      }catch(e){}
    }

    try{
      if(window.TasunBoot && typeof TasunBoot.start === "function"){
        TasunBoot.start({
          pageKey: "工程資料庫",
          verUrl: "tasun-version.json",
          corePath: "tasun-core.js",

          // ✅要求：強制 URL v 必須等於 APP_VER
          forceUrlV: true,

          // ✅跨頁同步（不同裝置/不同快取也一致）
          forceVersionSync: true,

          // ✅站內資源自動補 v
          patchResources: true,

          // ✅離線提示
          networkToast: true,

          // ✅穩定高度（手機地址列收合）
          appHeightVar: true
        });
      }else{
        fallbackLoadCore();
      }
    }catch(e){
      fallbackLoadCore();
    }
  })();
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* ✅中深暖褐禪意（不黑、不刺眼） */
      --bg0:#6f5b46;
      --bg1:#514031;
      --bg2:#3a2e24;

      --gold:#f6d37a;
      --gold2:rgba(246,211,122,.55);

      --border:rgba(246,211,122,.26);
      --border2:rgba(246,211,122,.42);

      --text:#f2f2f2;
      --muted:rgba(242,242,242,.72);

      --shadow:0 18px 50px rgba(0,0,0,.38);
      --r:18px;

      /* ✅降低霧字：blur 變小 */
      --glass-blur: 7px;
      --glass-blur-card: 8px;

      /* ✅卡片最小寬：讓它自動換行，不會擠壓 */
      --card-min: 260px;
      --wrap-max: 1100px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      color:var(--text);
      font-family:"標楷體","Noto Serif TC","Microsoft JhengHei",serif;

      /* ✅背景：暖褐禪意 + 微光（對比更清楚） */
      background:
        radial-gradient(1000px 560px at 18% 14%, rgba(255,255,255,.16), rgba(0,0,0,0) 62%),
        radial-gradient(900px 520px at 84% 22%, rgba(246,211,122,.11), rgba(0,0,0,0) 64%),
        radial-gradient(1100px 700px at 55% 88%, rgba(246,211,122,.09), rgba(0,0,0,0) 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 52%, var(--bg2));
      overflow-x:hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: geometricPrecision;
    }

    /* ✅容器：留出舒適邊界（視覺接近 1cm） */
    .wrap{
      max-width:var(--wrap-max);
      margin:0 auto;
      padding:clamp(18px, 2.0vw, 46px) clamp(16px, 2.0vw, 28px) 34px;
    }

    .topbar{
      position:relative;
      z-index:20;
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:12px;
      align-items:center;
      padding:14px 16px;
      border:1px solid var(--border);
      border-radius:var(--r);

      background:
        radial-gradient(700px 260px at 22% 18%, rgba(255,255,255,.12), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow:var(--shadow);

      /* ✅不支援時不做 blur（快顯） */
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
    }

    @supports not ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))){
      .topbar{ backdrop-filter:none; -webkit-backdrop-filter:none; }
      .card{ backdrop-filter:none; -webkit-backdrop-filter:none; }
    }

    @media (max-width:920px){
      .topbar{grid-template-columns:1fr}
      .nav-left{order:0}
      .brand{order:1}
      .right{order:2; justify-content:flex-start}
    }

    .nav-left{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-start;}
    .brand{
      display:flex; flex-direction:column; gap:4px;
      align-items:center; justify-content:center; text-align:center;
      min-width: 220px;
    }
    .title{
      font-weight:900;
      letter-spacing:.18em;
      font-size:clamp(22px, 2.1vw, 28px);
      color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.18);
      font-family:"標楷體","Noto Serif TC",serif;
    }
    .sub{
      font-size:12px;
      color:var(--muted);
      letter-spacing:.12em;
    }

    .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    @media (max-width:920px){ .right{justify-content:flex-start;} }

    .pill{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      font-size:13px;
      color:rgba(242,242,242,.88);
      display:flex; gap:8px; align-items:center; white-space:nowrap;
      box-shadow:0 10px 22px rgba(0,0,0,.24);
    }
    .pill b{color:var(--gold)}

    .btn{
      appearance:none;
      border:1px solid var(--border2);
      background:
        radial-gradient(220px 80px at 28% 18%, rgba(255,255,255,.14), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, rgba(246,211,122,.20), rgba(246,211,122,.08));
      color:var(--gold);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-family:inherit;
      font-weight:900;
      letter-spacing:.06em;
      box-shadow:0 10px 22px rgba(0,0,0,.30);
      transition:transform .12s ease, filter .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.06)}
    .btn:active{transform:translateY(0); filter:brightness(.99)}
    .btn.ghost{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.18);
      color:rgba(242,242,242,.88);
      font-weight:700;
    }
    .small{padding:8px 10px; font-size:12px; border-radius:999px; letter-spacing:.05em}

    .panel{
      margin-top:16px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:18px;
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
    }

    /* ✅卡片：用 grid 自動排版（更快、更穩；天然避免重疊） */
    .cards{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(var(--card-min), 1fr));
      gap:14px;
      align-items:stretch;
    }

    .card{
      border-radius:999px;
      border:1px solid rgba(246,211,122,.28);
      background:
        radial-gradient(280px 120px at 24% 22%, rgba(255,255,255,.10), rgba(0,0,0,0) 62%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow:0 18px 50px rgba(0,0,0,.34);
      backdrop-filter: blur(var(--glass-blur-card));
      -webkit-backdrop-filter: blur(var(--glass-blur-card));

      padding:16px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      cursor:pointer;

      transition: transform .12s ease, filter .12s ease;
      user-select:none;

      /* ✅快顯優化：隔離重排 */
      contain: layout paint;
    }
    .card:hover{ transform: translateY(-2px); filter: brightness(1.06); }
    .card:active{ transform: translateY(0); filter: brightness(.99); }

    .card .name{
      font-weight:900;
      letter-spacing:.10em;
      color:rgba(246,211,122,.98);
      font-size:16px;
      text-shadow:0 0 16px rgba(246,211,122,.14);
      white-space:nowrap;
      font-family:"標楷體","Noto Serif TC",serif;
    }
    .card .desc{
      font-size:12px;
      color:rgba(242,242,242,.72);
      letter-spacing:.07em;
      margin-top:4px;
      line-height:1.45;
    }
    .card .rightTag{
      border-radius:999px;
      padding:7px 10px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(58,44,33,.28);
      color:rgba(242,242,242,.84);
      font-size:12px;
      white-space:nowrap;
    }

    /* ===== Toast ===== */
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.50);
      color:rgba(242,242,242,.94);
      font-size:13px;
      box-shadow:var(--shadow);
      display:none;
      z-index:200;
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
    }

    /* ===== Login Modal ===== */
    .loginMask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.64);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:999;
    }
    .loginMask.show{display:flex;}
    .loginModal{
      width:min(520px, 96vw);
      border-radius:22px;
      border:1px solid rgba(246,211,122,.40);
      background:
        radial-gradient(900px 520px at 28% 18%, rgba(255,255,255,.10), rgba(0,0,0,0) 62%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow:0 30px 90px rgba(0,0,0,.72);
      overflow:hidden;
      backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px);
    }
    .loginHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .loginTitle{
      font-weight:900; letter-spacing:.10em;
      color:#f6d37a;
      text-shadow:0 0 18px rgba(246,211,122,.18);
      font-family:"標楷體","Noto Serif TC",serif;
    }
    .loginBody{padding:14px 16px 10px;}
    .loginFoot{
      padding:12px 16px;
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .loginErr{
      margin-top:10px;
      color:rgba(255,190,190,.95);
      font-size:13px;
      line-height:1.5;
      display:none;
      white-space: pre-wrap;
    }
    .loginHint{
      margin-top:10px;
      color:rgba(242,242,242,.70);
      font-size:12px;
      line-height:1.6;
    }
    .field{display:flex; flex-direction:column; gap:6px}
    .label{font-size:12px; letter-spacing:.10em; color:rgba(242,242,242,.72)}
    input,select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.20);
      color:rgba(242,242,242,.94);
      padding:10px 12px;
      font-family:inherit;
      outline:none;
      transition:border-color .12s ease, filter .12s ease;
    }
    input:focus,select:focus{border-color:rgba(246,211,122,.55); filter:brightness(1.05)}
    .loginBody select{
      appearance:none; -webkit-appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(242,242,242,.85) 50%),
        linear-gradient(135deg, rgba(242,242,242,.85) 50%, transparent 50%);
      background-position:
        calc(100% - 18px) 50%,
        calc(100% - 12px) 50%;
      background-size: 6px 6px, 6px 6px;
      background-repeat:no-repeat;
      padding-right:34px;
    }
  </style>
</head>

<body class="booting">
  <div class="wrap">
    <div class="topbar">
      <div class="nav-left">
        <button class="btn ghost small" id="btnHome" type="button">返回首頁</button>
      </div>

      <div class="brand">
        <div class="title">工 程 資 料</div>
        <div class="sub">登錄 / 查詢 / 明細表（權限表控管）</div>
      </div>

      <div class="right">
        <div class="pill">使用者：<b id="uName">—</b></div>
        <div class="pill">權限：<b id="uRole">—</b></div>
        <button class="btn" id="btnReLogin" type="button">切換帳號</button>
      </div>
    </div>

    <div class="panel">
      <div class="cards" id="cards">
        <div class="card" data-href="工程資料登錄.html" role="button" tabindex="0">
          <div>
            <div class="name">工程資料登錄</div>
            <div class="desc">新增文件資料（系統/類別受控）</div>
          </div>
          <div class="rightTag">REG</div>
        </div>

        <div class="card" data-href="工程資料查詢.html" role="button" tabindex="0">
          <div>
            <div class="name">工程資料查詢</div>
            <div class="desc">純查詢 / 篩選 / 點連結開啟</div>
          </div>
          <div class="rightTag">QUERY</div>
        </div>

        <div class="card" data-href="工程資料明細表.html" role="button" tabindex="0">
          <div>
            <div class="name">工程資料明細表</div>
            <div class="desc">查看 /（write 可編輯）/（admin 可刪除）</div>
          </div>
          <div class="rightTag">LIST</div>
        </div>

        <!-- ✅外部連結：維持原網址，不加 v -->
        <div class="card" data-external="1" data-href="https://www.dropbox.com/" role="button" tabindex="0">
          <div>
            <div class="name">雲端資料庫入口</div>
            <div class="desc">保持原網址（可自行改成你專案入口）</div>
          </div>
          <div class="rightTag">CLOUD</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Modal（保留既有結構） -->
  <div class="loginMask" id="loginMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="登入">
      <div class="loginHead">
        <div class="loginTitle">登入</div>
        <button class="btn ghost small" id="loginClose" type="button">關閉</button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label">帳號</div>
          <select id="loginUser" autocomplete="username">
            <option value="">請選擇帳號</option>
          </select>
        </div>
        <div class="field" style="margin-top:10px;">
          <div class="label">密碼</div>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="請輸入密碼" />
        </div>
        <div class="loginErr" id="loginErr"></div>
        <div class="loginHint">
          登入帳密以「權限表.html」權限表（localStorage: <b>tasunAuthTable_v1</b>）為準。
        </div>
      </div>
      <div class="loginFoot">
        <button class="btn ghost" id="loginToAuth" type="button">前往權限表</button>
        <button class="btn" id="loginBtn" type="button">登入</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- ✅✅✅ 單一程式方塊：等 TasunCore 就緒後再啟動（Boot 非同步也不會亂） -->
  <script>
  (function(){
    "use strict";

    const pageKey = "工程資料庫";

    function coreReady(){
      return !!(window.TasunCore && typeof window.TasunCore.withV === "function");
    }

    function forceUrlVStrict(){
      try{
        const app = String(window.__CACHE_V || window.TASUN_APP_VER || "").trim();
        if(!app) return;

        const u = new URL(location.href);
        const cur = String(u.searchParams.get("v") || "").trim();

        const KEY = "tasun_force_url_guard_" + pageKey + "_" + (cur||"none") + "_to_" + app;
        if(cur !== app && !sessionStorage.getItem(KEY)){
          sessionStorage.setItem(KEY, "1");
          u.searchParams.set("v", app);
          location.replace(u.toString());
        }
      }catch(e){}
    }

    function toast(msg){
      const t = document.getElementById("toast");
      if(!t) return;
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._tm);
      toast._tm = setTimeout(() => { t.style.display = "none"; }, 2200);
    }

    function run(){
      // ✅保底：強制 URL v=APP_VER（就算 boot 已做，再保險一次）
      forceUrlVStrict();

      const Core = window.TasunCore;
      const withV = Core.withV || (window.__withV || (u=>u));

      const $ = (id)=>document.getElementById(id);

      // ====== Auth：優先用 TasunCore.Auth（建議放到 tasun-core.js 共用）
      const Auth = (Core.Auth && typeof Core.Auth.init === "function")
        ? Core.Auth
        : null;

      // 若你尚未把 Auth 搬到 core：這裡用最小 fallback（不改結構與功能）
      const FallbackAuth = (function(){
        const CURRENT_KEY = "tasunCurrentUser_v1";
        const AUTH_KEY    = "tasunAuthTable_v1";
        const SESSION_WATCH_MS = 3000;

        let currentUser = null;
        let _watchStarted = false;
        let _onAuthed = null;
        let _onSessionChange = null;
        let _onForceRelogin = null;

        const norm = (s)=>(s??"").toString().trim();
        function mapRole(v){
          const s=(v??"").toString().trim().toLowerCase();
          if(!s) return "read";
          if(s==="admin") return "admin";
          if(s==="write"||s==="edit") return "write";
          if(s==="read"||s==="view") return "read";
          if(s==="0") return "admin";
          if(s==="1") return "write";
          if(s==="2") return "read";
          return s;
        }
        function jsonParse(s, f){ try{return JSON.parse(s);}catch(e){return f;} }
        function loadAuthTable(){
          const raw = localStorage.getItem(AUTH_KEY);
          const parsed = jsonParse(raw, null);
          if(Array.isArray(parsed)) return parsed;
          if(parsed && Array.isArray(parsed.users)) return parsed.users;
          return [];
        }
        function pickUsername(row){ return norm(row?.user ?? row?.username ?? row?.account ?? row?.name); }
        function pickPassword(row){ return (row?.pass ?? row?.password ?? row?.pwd ?? "").toString(); }
        function pickRole(row){ return mapRole(row?.role ?? row?.level ?? row?.perm ?? row?.permission); }
        function findAuthUser(username){
          const u=norm(username).toLowerCase();
          if(!u) return null;
          const rows=loadAuthTable();
          for(const r of rows){
            const ru=pickUsername(r).toLowerCase();
            if(ru && ru===u) return { username: pickUsername(r), password: pickPassword(r), role: pickRole(r) || "read" };
          }
          return null;
        }
        function fnv1a(str){
          let h = 0x811c9dc5;
          for(let i=0;i<str.length;i++){
            h ^= str.charCodeAt(i);
            h = Math.imul(h, 0x01000193);
          }
          return (h >>> 0).toString(16).padStart(8, "0");
        }
        function authStampFromAuth(auth){ return fnv1a(`${auth.username}|${auth.password ?? ""}`); }

        function loadCurrentUser(){
          currentUser = jsonParse(localStorage.getItem(CURRENT_KEY) || "null", null);
          if(currentUser && typeof currentUser==="object"){
            const uname = norm(currentUser.username ?? currentUser.user ?? currentUser.name ?? currentUser.account);
            if(uname) currentUser.username = uname;
            currentUser.role = mapRole(currentUser.role ?? currentUser.level ?? "read");
            currentUser.authStamp = (currentUser.authStamp ?? "").toString();
          }
        }
        function setCurrentUser(username, role, authStamp){
          const u = { username, user: username, role: mapRole(role), level: mapRole(role), authStamp: authStamp || "" };
          localStorage.setItem(CURRENT_KEY, JSON.stringify(u));
          currentUser = u;
        }
        function role(){ return mapRole(currentUser?.role ?? "read"); }

        function rebuildUserDropdown(preselectUser){
          const sel = $("loginUser");
          if(!sel) return;

          const rows = loadAuthTable();
          const users = rows.map(r => pickUsername(r)).filter(x => !!norm(x));

          const seen = new Set();
          const uniq = [];
          for(const u of users){
            const k = u.toLowerCase();
            if(seen.has(k)) continue;
            seen.add(k);
            uniq.push(u);
          }

          sel.innerHTML =
            `<option value="">請選擇帳號</option>` +
            uniq.map(u=>{
              const s = (preselectUser && u.toLowerCase() === preselectUser.toLowerCase()) ? "selected" : "";
              const vv = u.replace(/"/g,"&quot;");
              return `<option value="${vv}" ${s}>${u}</option>`;
            }).join("");
        }

        function openLoginModal(msg){
          const mask=$("loginMask");
          const err=$("loginErr");
          if(!mask) return;

          if(err){
            err.style.display="none";
            if(msg){
              err.textContent = msg;
              err.style.display="block";
            }
          }

          loadCurrentUser();
          rebuildUserDropdown(currentUser?.username || "");
          const pass=$("loginPass");
          if(pass) pass.value="";

          mask.classList.add("show");
          mask.setAttribute("aria-hidden","false");

          setTimeout(()=>{
            const userSel=$("loginUser");
            const passEl=$("loginPass");
            if(userSel && userSel.value && passEl) passEl.focus();
            else if(userSel) userSel.focus();
          },0);
        }

        function closeLoginModal(){
          const mask=$("loginMask");
          if(!mask) return;
          mask.classList.remove("show");
          mask.setAttribute("aria-hidden","true");
        }

        function fireSessionChange(){
          if(typeof _onSessionChange === "function") _onSessionChange(current());
        }

        function forceReLogin(msg){
          try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}
          currentUser = null;
          if(typeof _onForceRelogin === "function") _onForceRelogin(msg || "");
          openLoginModal(msg || "權限表已更新，請重新登入");
          fireSessionChange();
        }

        function validateSession(){
          const mask=$("loginMask");
          if(mask && mask.classList.contains("show")) return;

          loadCurrentUser();
          if(!currentUser || !currentUser.username) return;

          const auth = findAuthUser(currentUser.username);
          if(!auth){ forceReLogin("帳號已被移除，請重新登入"); return; }

          const stampNow = authStampFromAuth(auth);
          if(!currentUser.authStamp){
            setCurrentUser(auth.username, auth.role || "read", stampNow);
            fireSessionChange();
            return;
          }
          if(currentUser.authStamp !== stampNow){
            forceReLogin("密碼已更新，請重新登入");
            return;
          }
          const r = auth.role || "read";
          if(mapRole(currentUser.role) !== r){
            setCurrentUser(auth.username, r, stampNow);
            fireSessionChange();
          }
        }

        function ensureLoggedIn(){
          loadCurrentUser();
          const rows = loadAuthTable();
          if(!Array.isArray(rows) || rows.length === 0){
            openLoginModal("尚未建立權限表：請先到「權限表.html」建立帳號。");
            return false;
          }
          if(!currentUser || !currentUser.username){
            openLoginModal();
            return false;
          }
          const auth = findAuthUser(currentUser.username);
          if(!auth){ forceReLogin("帳號已被移除，請重新登入"); return false; }

          const stampNow = authStampFromAuth(auth);
          if(currentUser.authStamp && currentUser.authStamp !== stampNow){
            forceReLogin("密碼已更新，請重新登入");
            return false;
          }
          setCurrentUser(auth.username, auth.role || "read", stampNow);
          fireSessionChange();
          return true;
        }

        function doLogin(){
          const userSel=$("loginUser");
          const passEl=$("loginPass");
          const err=$("loginErr");

          const u = norm(userSel ? userSel.value : "");
          const p = (passEl ? passEl.value : "").toString();
          const rows = loadAuthTable();

          function showErr(m){
            if(!err) return;
            err.textContent = m;
            err.style.display="block";
          }

          if(!Array.isArray(rows) || rows.length === 0) return showErr("尚未建立權限表：請先到「權限表.html」建立帳號。");
          if(!u) return showErr("請先選擇帳號。");
          if(!p) return showErr("請輸入密碼。");

          const auth = findAuthUser(u);
          if(!auth) return showErr("帳號不存在（以權限表為準）。");
          if((auth.password ?? "") !== p) return showErr("密碼錯誤（以權限表為準）。");

          const stampNow = authStampFromAuth(auth);
          setCurrentUser(auth.username, auth.role || "read", stampNow);

          closeLoginModal();
          fireSessionChange();
          if(typeof _onAuthed === "function") _onAuthed(current());
        }

        function bindUI(){
          const closeBtn=$("loginClose");
          const toAuth=$("loginToAuth");
          const loginBtn=$("loginBtn");
          const mask=$("loginMask");
          const userSel=$("loginUser");

          if(closeBtn) closeBtn.onclick = closeLoginModal;
          if(toAuth) toAuth.onclick = ()=> location.href = withV("權限表.html");
          if(loginBtn) loginBtn.onclick = doLogin;

          if(userSel){
            userSel.addEventListener("change", ()=>{
              const pass=$("loginPass");
              if(userSel.value && pass) pass.focus();
            });
          }

          if(mask){
            mask.addEventListener("click",(e)=>{ if(e.target === mask) closeLoginModal(); });
          }

          window.addEventListener("keydown",(e)=>{
            const m=$("loginMask");
            if(!m) return;
            if(e.key === "Escape" && m.classList.contains("show")) closeLoginModal();
            if(e.key === "Enter" && m.classList.contains("show")) doLogin();
          });
        }

        function startWatch(){
          if(_watchStarted) return;
          _watchStarted = true;

          window.addEventListener("storage", (e)=>{
            if(e.key === AUTH_KEY || e.key === CURRENT_KEY) validateSession();
          });
          setInterval(validateSession, SESSION_WATCH_MS);
        }

        function init(opts){
          _onAuthed = opts?.onAuthed || null;
          _onSessionChange = opts?.onSessionChange || null;
          _onForceRelogin = opts?.onForceRelogin || null;
          bindUI();
          startWatch();
        }

        function current(){ loadCurrentUser(); return currentUser; }

        return { init, ensureLoggedIn, validateSession, open: openLoginModal, close: closeLoginModal, current, role: ()=>{ loadCurrentUser(); return role(); } };
      })();

      const UseAuth = Auth || FallbackAuth;

      function syncUserUI(){
        const u = UseAuth.current();
        $("uName").textContent = u?.username || "—";
        $("uRole").textContent = (Auth ? Auth.role() : UseAuth.role());
      }

      function bindCards(){
        const box = document.getElementById("cards");
        if(!box) return;

        function openHref(el){
          const href = String(el.getAttribute("data-href") || "").trim();
          if(!href) return;

          const external = el.getAttribute("data-external") === "1" || /^https?:\/\//i.test(href);
          if(external){
            window.open(href, "_blank", "noopener");
          }else{
            location.href = withV(href);
          }
        }

        box.querySelectorAll(".card[data-href]").forEach(el=>{
          el.addEventListener("click", ()=>openHref(el));
          el.addEventListener("keydown", (e)=>{
            if(e.key === "Enter" || e.key === " "){
              e.preventDefault();
              openHref(el);
            }
          });
        });
      }

      function start(){
        if(!UseAuth.ensureLoggedIn()) return;

        syncUserUI();
        bindCards();

        $("btnHome").onclick = ()=> location.href = withV("index.html");
        $("btnReLogin").onclick = ()=> UseAuth.open("請重新登入或切換帳號");
      }

      UseAuth.init({
        onAuthed: ()=>{ toast("登入成功"); start(); },
        onSessionChange: ()=>{ syncUserUI(); },
        onForceRelogin: (msg)=>{ toast(msg || "請重新登入"); syncUserUI(); }
      });

      // ✅解除 booting（避免第一次顯示閃動）
      document.body.classList.remove("booting");

      start();
    }

    // ✅等 Core 就緒再啟動（Boot 可能非同步載入 core）
    if(coreReady()){
      run();
      return;
    }

    let started = false;
    function startOnce(){
      if(started) return;
      started = true;
      run();
    }

    window.addEventListener("tasun:core-ready", startOnce, { once:true });

    const t0 = Date.now();
    const timer = setInterval(() => {
      if(coreReady()){
        clearInterval(timer);
        startOnce();
        return;
      }
      if(Date.now() - t0 > 8000){
        clearInterval(timer);
        startOnce();
      }
    }, 50);
  })();
  </script>
</body>
</html>
