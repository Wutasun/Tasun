<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>工程資料</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      background:
        radial-gradient(circle at 10% 0%, rgba(252, 211, 77, 0.16) 0, transparent 45%),
        radial-gradient(circle at 90% 90%, rgba(251, 191, 36, 0.28) 0, transparent 55%),
        linear-gradient(145deg, #020617 0%, #0b1220 40%, #111827 75%, #1f2937 100%);
      color: #e5e7eb;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(circle at 25% 20%, rgba(251, 191, 36, 0.22) 0, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(234, 179, 8, 0.25) 0, transparent 55%);
      mix-blend-mode: screen;
      opacity: 0.85;
      z-index: -1;
    }

    /* ===== 左上角：返回首頁（不 fixed / 不遮擋）===== */
    .top-left{
      width:100%;
      padding: 14px 24px 0;
      display:flex;
      justify-content:flex-start;
      align-items:center;
    }
    @media (max-width:600px){
      .top-left{ padding: 12px 16px 0; }
    }
    .btn-home{
      appearance:none;
      border:1px solid rgba(251,191,36,.42);
      background: linear-gradient(180deg, rgba(251,191,36,.22), rgba(251,191,36,.08));
      color:#fcd34d;
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      letter-spacing:.06em;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 12px 26px rgba(0,0,0,.55);
      transition: transform .12s ease, filter .12s ease, border-color .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn-home:hover{ transform: translateY(-1px); filter: brightness(1.06); border-color: rgba(251,191,36,.70); }
    .btn-home:active{ transform: translateY(0); filter: brightness(.98); }

    /* 上方標題 */
    header {
      width: 100%;
      padding: 24px 24px 0;
    }
    .title-wrap {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      justify-content: center;
    }
    .main-title {
      font-size: clamp(28px, 4vw, 36px);
      letter-spacing: 0.28em;
      text-indent: 0.28em;
      font-weight: 600;
      color: #fbbf24;
      text-shadow: 0 0 12px rgba(251, 191, 36, 0.9), 0 0 28px rgba(234, 179, 8, 0.85);
    }

    /* 主內容：按鍵從標題下約兩行距離開始，橫向排版 */
    main {
      flex: 1;
      width: 100%;
      padding: 0 24px 32px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    .grid-wrapper {
      width: 100%;
      max-width: 1100px;
      margin-top: 32px;
    }
    .grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
    }

    /* 玻璃浮在水面的按鍵卡片 */
    .card-button {
      position: relative;
      border-radius: 999px;
      padding: 16px 20px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(15, 23, 42, 0.36));
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border: 1px solid rgba(248, 250, 252, 0.35);
      box-shadow: 0 24px 40px rgba(0, 0, 0, 0.75), 0 0 0 1px rgba(15, 23, 42, 0.8);
      text-decoration: none;
      color: #e5e7eb;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-width: 260px;
      max-width: 360px;
      flex: 1 1 260px;
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, background 0.2s ease;
    }
    .card-button:hover {
      transform: translateY(-4px);
      box-shadow: 0 28px 55px rgba(0, 0, 0, 0.9), 0 0 0 1px rgba(251, 191, 36, 0.7);
      border-color: rgba(251, 191, 36, 0.9);
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.16), rgba(15, 23, 42, 0.5));
    }
    .card-title {
      font-size: 15px;
      font-weight: 500;
      color: #fcd34d;
    }
    .card-tag {
      font-size: 11px;
      padding: 4px 12px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0%, rgba(251, 191, 36, 0.9), rgba(180, 83, 9, 0.9));
      border: 1px solid rgba(254, 249, 195, 0.9);
      color: #111827;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.6);
      white-space: nowrap;
    }

    @media (max-width: 600px) {
      header { padding: 18px 16px 0; }
      main { padding: 0 16px 24px; }
      .grid-wrapper { margin-top: 24px; }
      .card-button {
        padding: 14px 18px;
        min-width: 100%;
        max-width: 100%;
      }
    }

    /* ===== Login Modal（同款體驗）===== */
    .loginMask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.68);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:999;
    }
    .loginMask.show{display:flex;}
    .loginModal{
      width:min(520px, 96vw);
      border-radius:22px;
      border:1px solid rgba(251,191,36,.42);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow:0 30px 90px rgba(0,0,0,.78);
      overflow:hidden;
      backdrop-filter:blur(12px);
    }
    .loginHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .loginTitle{
      font-weight:900; letter-spacing:.08em;
      color:#fcd34d;
      text-shadow:0 0 18px rgba(251, 191, 36, .22);
    }
    .loginBody{padding:14px 16px 10px;}
    .loginFoot{
      padding:12px 16px;
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .field{display:flex; flex-direction:column; gap:6px}
    .label{font-size:12px; letter-spacing:.08em; color:rgba(229,231,235,.75)}
    .loginBody input{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);
      color:#e5e7eb;
      padding:10px 12px;
      outline:none;
      transition:border-color .12s ease, filter .12s ease;
    }
    .loginBody input:focus{border-color:rgba(251,191,36,.70); filter:brightness(1.05)}
    .loginErr{
      margin-top:10px;
      color:rgba(255,190,190,.95);
      font-size:13px;
      line-height:1.5;
      display:none;
    }
    .loginHint{
      margin-top:10px;
      color:rgba(229,231,235,.65);
      font-size:12px;
      line-height:1.6;
    }
    .btn{
      appearance:none;
      border:1px solid rgba(251,191,36,.42);
      background: linear-gradient(180deg, rgba(251,191,36,.22), rgba(251,191,36,.08));
      color:#fcd34d;
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      letter-spacing:.06em;
      box-shadow: 0 12px 26px rgba(0,0,0,.55);
      transition: transform .12s ease, filter .12s ease, border-color .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.06); border-color: rgba(251,191,36,.70); }
    .btn:active{ transform: translateY(0); filter: brightness(.98); }
    .btn.ghost{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.18);
      color:rgba(229,231,235,.90);
      font-weight:600;
    }
    .small{padding:8px 12px; font-size:12px;}

    /* ===== toast ===== */
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.55);
      color:rgba(229,231,235,.92);
      font-size:13px;
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      display:none;
      z-index:1200;
      backdrop-filter:blur(10px);
    }
  </style>
</head>

<body>
  <!-- 左上角返回首頁（不 fixed，不遮擋） -->
  <div class="top-left">
    <a class="btn-home" href="index.html">← 返回首頁</a>
  </div>

  <!-- 上端標題 -->
  <header>
    <div class="title-wrap">
      <div class="main-title">工 程 資 料</div>
    </div>
  </header>

  <!-- 按鍵：橫向排版，從標題下方約兩行距離開始 -->
  <main>
    <div class="grid-wrapper">
      <div class="grid">
        <!-- ✅ 工程資料登錄：改成用 JS gate -->
        <a class="card-button" href="工程資料登錄.html" data-gate="1">
          <div class="card-title">工程資料登錄</div>
          <span class="card-tag">輸入</span>
        </a>

        <!-- ✅ 工程資料查詢：改成用 JS gate -->
        <a class="card-button" href="工程資料查詢.html" data-gate="1">
          <div class="card-title">工程資料查詢</div>
          <span class="card-tag">查詢</span>
        </a>

        <!-- ✅ 工程資料明細表：改成用 JS gate -->
        <a class="card-button" href="工程資料明細表.html" data-gate="1">
          <div class="card-title">工程資料明細表</div>
          <span class="card-tag">明細</span>
        </a>
      </div>
    </div>
  </main>

  <!-- Login Modal（同款體驗） -->
  <div class="loginMask" id="loginMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="登入">
      <div class="loginHead">
        <div class="loginTitle">登入</div>
        <button class="btn ghost small" id="loginClose" type="button">關閉</button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label">帳號</div>
          <input id="loginUser" autocomplete="username" placeholder="例如：alex / tasun / wu" />
        </div>
        <div class="field" style="margin-top:10px;">
          <div class="label">密碼</div>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="請輸入密碼" />
        </div>
        <div class="loginErr" id="loginErr"></div>
        <div class="loginHint">
          登入帳密完全以「權限表.html」的權限表（localStorage: <b>tasunAuthTable_v1</b>）為準。
        </div>
      </div>
      <div class="loginFoot">
        <button class="btn ghost" id="loginToAuth" type="button">前往權限表</button>
        <button class="btn" id="loginBtn" type="button">登入</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ===== Keys（與三頁一致）=====
    const CURRENT_KEY = "tasunCurrentUser_v1";
    const AUTH_KEY = "tasunAuthTable_v1";

    // ===== State =====
    let currentUser = null;
    let pendingHref = null;

    // ===== Utils =====
    const $ = (id) => document.getElementById(id);
    const norm = (s) => (s ?? "").toString().trim();

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.style.display = "none", 2200);
    }

    // ===== Auth Table（唯一真相來源）=====
    function mapRole(v){
      const s=(v??"").toString().trim().toLowerCase();
      if(!s) return "read";
      if(s==="admin") return "admin";
      if(s==="write"||s==="edit") return "write";
      if(s==="read"||s==="view") return "read";
      if(s==="0") return "admin";
      if(s==="1") return "write";
      if(s==="2") return "read";
      return s;
    }

    function loadAuthTable(){
      try{
        const raw = localStorage.getItem(AUTH_KEY);
        if(!raw) return [];
        const parsed = JSON.parse(raw);
        if(Array.isArray(parsed)) return parsed;
        if(parsed && Array.isArray(parsed.users)) return parsed.users;
        return [];
      }catch(e){ return []; }
    }

    function findAuthUser(username){
      const u = norm(username).toLowerCase();
      if(!u) return null;
      const rows = loadAuthTable();
      for(const r of rows){
        const ru = norm(r?.username).toLowerCase();
        if(ru && ru === u){
          return {
            username: norm(r?.username),
            password: (r?.password ?? "").toString(),
            role: mapRole(r?.role ?? r?.level ?? r?.perm ?? r?.permission)
          };
        }
      }
      return null;
    }

    function loadCurrentUser(){
      try{ currentUser = JSON.parse(localStorage.getItem(CURRENT_KEY) || "null"); }
      catch(e){ currentUser = null; }
      if(currentUser && typeof currentUser === "object"){
        const uname = norm(currentUser.username ?? currentUser.user ?? currentUser.name ?? currentUser.account);
        if(uname) currentUser.username = uname;
        if(currentUser.role) currentUser.role = mapRole(currentUser.role);
      }
    }

    function setCurrentUser(username, role, authStamp){
      const u = { username, role, level: role, authStamp: authStamp || "" };
      localStorage.setItem(CURRENT_KEY, JSON.stringify(u));
      currentUser = u;
    }

    // ===== Session Watch Patch（權限表變動 → 自動重登）=====
    const SESSION_WATCH_MS = 3000;
    let _watchStarted = false;

    function fnv1a(str){
      let h = 0x811c9dc5;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 0x01000193);
      }
      return (h >>> 0).toString(16).padStart(8, "0");
    }
    function authStampFromAuth(auth){
      return fnv1a(`${auth.username}|${auth.password ?? ""}`);
    }

    function openLoginModal(msg){
      $("loginErr").style.display="none";
      if(msg){
        $("loginErr").textContent = msg;
        $("loginErr").style.display="block";
      }
      $("loginUser").value="";
      $("loginPass").value="";
      $("loginMask").classList.add("show");
      $("loginMask").setAttribute("aria-hidden","false");
      setTimeout(()=> $("loginUser").focus(), 0);
    }
    function closeLoginModal(){
      $("loginMask").classList.remove("show");
      $("loginMask").setAttribute("aria-hidden","true");
    }

    function forceReLogin(msg){
      try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}
      currentUser = null;
      pendingHref = null;
      toast(msg || "權限表已更新，請重新登入");
      openLoginModal(msg || "權限表已更新，請重新登入");
    }

    function validateSession(){
      const lm = $("loginMask");
      if(lm && lm.classList.contains("show")) return;

      loadCurrentUser();
      if(!currentUser || !currentUser.username) return;

      const auth = findAuthUser(currentUser.username);
      if(!auth){
        forceReLogin("帳號已被移除，請重新登入");
        return;
      }

      const stampNow = authStampFromAuth(auth);

      if(!currentUser.authStamp){
        setCurrentUser(auth.username, auth.role || "read", stampNow);
        return;
      }

      if(currentUser.authStamp !== stampNow){
        forceReLogin("密碼已更新，請重新登入");
        return;
      }

      // role 變更：不強制重登，只同步
      const r = auth.role || "read";
      if(mapRole(currentUser.role) !== r){
        setCurrentUser(auth.username, r, stampNow);
      }
    }

    function startSessionWatch(){
      if(_watchStarted) return;
      _watchStarted = true;

      window.addEventListener("storage", (e)=>{
        if(e.key === AUTH_KEY || e.key === CURRENT_KEY){
          validateSession();
        }
      });

      setInterval(validateSession, SESSION_WATCH_MS);
    }

    function ensureLoggedIn(){
      loadCurrentUser();
      const rows = loadAuthTable();
      if(!Array.isArray(rows) || rows.length === 0){
        openLoginModal("尚未建立權限表：請先到「權限表.html」建立帳號。");
        return false;
      }

      if(!currentUser || !currentUser.username){
        openLoginModal();
        return false;
      }

      const auth = findAuthUser(currentUser.username);
      if(!auth){
        forceReLogin("帳號已被移除，請重新登入");
        return false;
      }

      const stampNow = authStampFromAuth(auth);
      if(currentUser.authStamp && currentUser.authStamp !== stampNow){
        forceReLogin("密碼已更新，請重新登入");
        return false;
      }

      // 同步 role + stamp
      setCurrentUser(auth.username, auth.role || "read", stampNow);
      return true;
    }

    function doLogin(){
      const u = norm($("loginUser").value);
      const p = ($("loginPass").value ?? "").toString();
      const rows = loadAuthTable();

      if(!Array.isArray(rows) || rows.length === 0){
        $("loginErr").textContent = "尚未建立權限表：請先到「權限表.html」建立帳號。";
        $("loginErr").style.display = "block";
        return;
      }
      if(!u || !p){
        $("loginErr").textContent = "請輸入帳號與密碼。";
        $("loginErr").style.display = "block";
        return;
      }

      const auth = findAuthUser(u);
      if(!auth){
        $("loginErr").textContent = "帳號不存在（以權限表為準）。";
        $("loginErr").style.display = "block";
        return;
      }
      if((auth.password ?? "") !== p){
        $("loginErr").textContent = "密碼錯誤（以權限表為準）。";
        $("loginErr").style.display = "block";
        return;
      }

      const stampNow = authStampFromAuth(auth);
      setCurrentUser(auth.username, auth.role || "read", stampNow);

      closeLoginModal();
      toast("登入成功");

      // ✅ 若是點按鈕被攔截：登入後導向原本想去的頁面
      if(pendingHref){
        const go = pendingHref;
        pendingHref = null;
        location.href = go;
      }
    }

    // ===== Gate navigation：未登入則彈登入 =====
    function bindGateLinks(){
      document.addEventListener("click", (e)=>{
        const a = e.target.closest("a[data-gate='1']");
        if(!a) return;

        const href = a.getAttribute("href");
        if(!href) return;

        // 先做 session 驗證（含權限表變更重登）
        validateSession();

        if(!ensureLoggedIn()){
          e.preventDefault();
          pendingHref = href;
          // ensureLoggedIn 會自動 openLoginModal
          return;
        }
        // 已登入：放行（正常連結）
      });
    }

    // ===== Login bindings =====
    (function bindLogin(){
      $("loginClose").onclick = closeLoginModal;
      $("loginToAuth").onclick = ()=> location.href="權限表.html";
      $("loginBtn").onclick = doLogin;

      $("loginMask").addEventListener("click",(e)=>{
        if(e.target === $("loginMask")) closeLoginModal();
      });

      window.addEventListener("keydown",(e)=>{
        if(e.key === "Escape" && $("loginMask").classList.contains("show")) closeLoginModal();
        if(e.key === "Enter" && $("loginMask").classList.contains("show")) doLogin();
      });
    })();

    // ===== Boot =====
    startSessionWatch();
    bindGateLinks();
    // 若一進頁就已登入，也會持續監測權限表變動
    validateSession();
  </script>
</body>
</html>
