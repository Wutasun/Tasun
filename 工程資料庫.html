<script>
(function(){
  const Core = window.TasunCore;
  const withV = Core.withV;

  const $ = (id)=>document.getElementById(id);

  function toast(msg){
    const t=$("toast");
    t.textContent=msg;
    t.style.display="block";
    clearTimeout(toast._tm);
    toast._tm=setTimeout(()=>t.style.display="none",2200);
  }

  function syncUserUI(){
    const u = Core.Auth.current();
    $("uName").textContent = u?.username || "—";
    $("uRole").textContent = Core.Auth.role();
  }

  function start(){
    if(!Core.Auth.ensureLoggedIn()) return;

    syncUserUI();

    $("btnHome").onclick = ()=> location.href = withV("index.html");
    $("btnReLogin").onclick = ()=> Core.Auth.open("請重新登入或切換帳號");

    document.querySelectorAll(".card[data-href]").forEach(el=>{
      el.addEventListener("click", ()=>{
        const href = el.getAttribute("data-href");
        if(!href) return;

        const external = el.getAttribute("data-external")==="1" || /^https?:\/\//i.test(href);
        if(external) window.open(href, "_blank", "noopener");
        else location.href = withV(href);
      });
    });
  }

  Core.Auth.init({
    onAuthed: ()=>{ toast("登入成功"); start(); },
    onSessionChange: ()=>{ syncUserUI(); },
    onForceRelogin: (msg)=>{ toast(msg || "請重新登入"); syncUserUI(); }
  });

  start();
})();
</script>
