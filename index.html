<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Tasun Ë≥áÊñôÈ¶ñÈ†Å ¬∑ Á©∫ÁÑ°Êòé</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --gold: #f6d37a;
      --gold-soft: rgba(246, 211, 122, 0.75);
      --panel-border: rgba(246, 211, 122, 0.35);

      --side-btn-offset: clamp(5%, 8vw, 10%);
      --side-text-offset: clamp(26%, 30vw, 34%);

      --btn-w: clamp(240px, 22vw, 420px);

      --stage-gap: clamp(12px, 1.8vw, 26px);
      --stage-inset-x: calc(var(--side-btn-offset) + var(--btn-w) + var(--stage-gap));

      --frame-inset: clamp(0.6rem, 1.2vw, 1.2rem);
      --frame-radius: clamp(22px, 2vw, 34px);

      --stage-top: clamp(4.0rem, 7vh, 5.4rem);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      font-family: "Noto Serif TC","Ê®ôÊ•∑È´î","Microsoft JhengHei",serif;
      background: #050302;
      color: var(--gold);
      overflow-x: hidden;
    }

    body.locked { overflow: hidden; }

    /* Token overlay */
    .token-overlay{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 1200;
      background: radial-gradient(circle at 50% 18%, rgba(255, 228, 170, 0.32), rgba(0, 0, 0, 0.98));
    }
    .token-box{
      width: min(560px, 92vw);
      padding: 1.6rem 1.6rem 1.2rem;
      border-radius: 18px;
      background: radial-gradient(circle at 0% 0%, rgba(246, 211, 122, 0.22), rgba(0, 0, 0, 0.95));
      border: 1px solid rgba(246, 211, 122, 0.35);
      box-shadow: 0 0 28px rgba(0,0,0,0.92), 0 0 26px rgba(246,211,122,0.18);
      color: var(--gold-soft);
    }
    .token-title{
      text-align:center;
      font-size: 1.15rem;
      letter-spacing: 0.18em;
      text-indent: 0.18em;
      margin-bottom: 0.8rem;
      text-shadow: 0 0 14px rgba(246,211,122,0.55);
      color: rgba(246,211,122,0.92);
    }
    .token-hint{
      font-size: 0.9rem;
      line-height: 1.7;
      color: rgba(246,211,122,0.78);
      margin-bottom: 0.9rem;
    }
    .token-row{
      display:flex;
      align-items:center;
      gap: 0.5rem;
      margin-bottom: 0.55rem;
    }
    .token-input{
      flex: 1 1 auto;
      width: 100%;
      padding: 0.55rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.5);
      background: rgba(0, 0, 0, 0.82);
      color: var(--gold);
      outline: none;
    }
    .token-input:focus{
      border-color: rgba(255, 238, 190, 0.9);
      box-shadow: 0 0 12px rgba(246, 211, 122, 0.65);
    }
    .token-eye{
      padding: 0.26rem 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.8);
      background: rgba(0,0,0,0.86);
      color: var(--gold);
      cursor: pointer;
      box-shadow: 0 0 8px rgba(0,0,0,0.65);
      white-space: nowrap;
    }
    .token-actions{
      margin-top: 0.95rem;
      display:flex;
      justify-content: flex-end;
      gap: 0.55rem;
      flex-wrap: wrap;
    }
    .token-btn{
      border: 1px solid rgba(246,211,122,0.72);
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,0.22), rgba(0,0,0,0.92));
      color: var(--gold);
      border-radius: 999px;
      padding: 0.42rem 1.05rem;
      cursor: pointer;
      letter-spacing: 0.12em;
      text-indent: 0.12em;
      box-shadow: 0 8px 16px rgba(0,0,0,0.75);
      transition: transform .15s ease, box-shadow .2s ease, background .2s ease, opacity .2s ease;
      white-space: nowrap;
    }
    .token-btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(0,0,0,0.85);
      background: radial-gradient(circle at 0% 0%, rgba(255,244,208,0.28), rgba(0,0,0,0.92));
    }
    .token-btn:disabled{ opacity:.45; cursor:not-allowed; transform:none; }
    .token-btn.ghost{
      opacity: 0.85;
      border-color: rgba(246,211,122,0.45);
    }
    .token-msg{
      margin-top: 0.7rem;
      min-height: 1.2rem;
      font-size: 0.85rem;
      white-space: pre-line;
      text-align: left;
      color: rgba(255, 220, 190, 0.95);
    }

    /* login */
    .login-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 50% 18%, rgba(255, 228, 170, 0.35), rgba(0, 0, 0, 0.98));
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .login-box {
      width: min(380px, 90vw);
      padding: 2.4rem 2.6rem 2.2rem;
      border-radius: 18px;
      background: radial-gradient(circle at 0% 0%, rgba(246, 211, 122, 0.28), rgba(0, 0, 0, 0.94));
      border: 1px solid var(--panel-border);
      box-shadow: 0 0 24px rgba(0, 0, 0, 0.9), 0 0 32px rgba(246, 211, 122, 0.25);
      color: var(--gold-soft);
    }
    .login-title {
      text-align: center;
      font-size: 1.4rem;
      letter-spacing: 0.2em;
      text-indent: 0.2em;
      margin-bottom: 1.6rem;
      text-shadow: 0 0 8px rgba(246, 211, 122, 0.8), 0 0 18px rgba(246, 211, 122, 0.5);
    }
    .login-field { margin-bottom: 1rem; }
    .login-field label {
      display: block;
      font-size: 0.85rem;
      letter-spacing: 0.18em;
      text-indent: 0.18em;
      margin-bottom: 0.3rem;
      color: var(--gold-soft);
    }
    .login-field input,
    .login-field select {
      width: 100%;
      padding: 0.55rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.5);
      background: rgba(0, 0, 0, 0.8);
      color: var(--gold);
      outline: none;
    }
    .login-field input:focus,
    .login-field select:focus {
      border-color: rgba(255, 238, 190, 0.9);
      box-shadow: 0 0 12px rgba(246, 211, 122, 0.7);
    }
    .login-user-wrapper{
      position: relative;
      display: flex;
      align-items: center;
      gap: 0.45rem;
    }
    .login-user-input{ flex: 1 1 auto; padding-right: 2.6rem; }
    .btn-user-drop{
      position: absolute;
      right: 0.25rem;
      top: 50%;
      transform: translateY(-50%);
      padding: 0.15rem 0.65rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.75);
      background: rgba(0,0,0,0.85);
      color: var(--gold);
      cursor: pointer;
      box-shadow: 0 0 8px rgba(0,0,0,0.6);
      font-size: 0.9rem;
      line-height: 1.6;
    }
    .btn-user-drop:hover{ background: rgba(246, 211, 122, 0.18); }

    .user-drop{
      position: absolute;
      left: 0;
      right: 0;
      top: calc(100% + 8px);
      border-radius: 16px;
      border: 1px solid rgba(246, 211, 122, 0.35);
      background: rgba(0,0,0,0.92);
      box-shadow: 0 14px 28px rgba(0,0,0,0.85), 0 0 18px rgba(246,211,122,0.18);
      max-height: 240px;
      overflow: auto;
      display: none;
      z-index: 20;
    }
    .user-drop button{
      width: 100%;
      text-align: left;
      padding: 0.65rem 0.9rem;
      background: transparent;
      border: none;
      color: var(--gold);
      cursor: pointer;
      letter-spacing: 0.08em;
    }
    .user-drop button:hover{ background: rgba(246, 211, 122, 0.10); }

    .login-pwd-wrapper { display: flex; align-items: center; gap: 0.45rem; }
    .login-pwd-input { flex: 1 1 auto; }
    .btn-eye-login {
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.8);
      background: rgba(0, 0, 0, 0.85);
      color: var(--gold);
      font-size: 0.8rem;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.6);
    }
    .btn-eye-login:hover { background: rgba(246, 211, 122, 0.2); }

    .login-error {
      min-height: 1.1rem;
      margin-bottom: 0.4rem;
      font-size: 0.8rem;
      color: #ffb3b3;
      text-align: center;
      white-space: pre-line;
    }

    .login-actions { margin-top: 0.8rem; display: flex; justify-content: center; }
    .btn-login {
      padding: 0.55rem 2.8rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.9);
      background: radial-gradient(circle at 0% 0%, rgba(246, 211, 122, 0.36), rgba(0, 0, 0, 0.98));
      color: var(--gold);
      font-size: 0.95rem;
      letter-spacing: 0.22em;
      text-indent: 0.22em;
      cursor: pointer;
      box-shadow: 0 10px 18px rgba(0, 0, 0, 0.95), 0 0 18px rgba(246, 211, 122, 0.5);
      transition: transform 0.15s ease-out, box-shadow 0.2s ease-out, background 0.2s ease-out, border-color 0.2s ease-out;
    }
    .btn-login:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 22px rgba(0, 0, 0, 0.98), 0 0 22px rgba(246, 211, 122, 0.8);
      border-color: #fff4cf;
      background: radial-gradient(circle at 0% 0%, rgba(255, 244, 208, 0.45), rgba(0, 0, 0, 0.97));
    }

    /* hero background (Áï•Ôºå‰øùÊåÅ‰Ω†ÁèæÊúâÁâàÊú¨) */
    .hero { position: relative; min-height: 100vh; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .hero::before { content:""; position:absolute; inset:0; background: radial-gradient(circle at 50% 12%, rgba(255,237,180,0.92) 0, rgba(255,237,180,0.42) 18%, rgba(255,237,180,0.10) 40%, rgba(255,237,180,0.00) 60%), linear-gradient(to bottom, rgba(0,0,0,0.84), rgba(0,0,0,0.55)); z-index:-6; }
    .hero-inner{ position:relative; width:100%; max-width:1400px; height:100vh; margin:0 auto; padding: clamp(1.2rem, 2vw, 1.8rem); }

    .user-bar { position: fixed; top: 0.8rem; left: 0.9rem; display:flex; gap: .75rem; z-index:10; }
    .user-pill { padding: .30rem 1.05rem; border-radius:999px; border:1px solid rgba(246,211,122,.55); background: rgba(0,0,0,.70); font-size:.82rem; opacity:.9; }
    .btn-switch { padding: .26rem 1.0rem; border-radius:999px; border:1px solid rgba(246,211,122,.62); background: rgba(0,0,0,.78); color:var(--gold); cursor:pointer; }

    .site-title-wrapper { position: fixed; top: 0.70rem; left:50%; transform: translateX(-50%); z-index:9; pointer-events:none; }
    .site-title { font-size: clamp(2.4rem, 4.2vw, 3.8rem); font-weight:700; text-shadow: 0 0 18px rgba(246,211,122,.9); }

    .nav-area { position:absolute; inset:0; }
    .nav-btn{ position:absolute; width: var(--btn-w); height: clamp(78px, 9.5vh, 112px); border-radius:999px; border:1px solid rgba(246,211,122,.92); background: rgba(0,0,0,.72); color:var(--gold); text-decoration:none; display:flex; align-items:center; justify-content:center; padding: 0 2rem; }
    .nav-btn span{ text-align:center; }

    @media (max-width: 900px) {
      .hero-inner{ height:auto; min-height:100vh; }
      .nav-area{ position:static; display:flex; flex-wrap:wrap; gap:.9rem; justify-content:center; margin-top: 45vh; padding: 0 .6rem; }
      .nav-btn{ position:relative; flex: 0 1 calc(50% - .9rem); width:auto; height:78px; }
    }
  </style>
</head>

<body class="locked">
  <!-- Token overlay -->
  <div class="token-overlay" id="tokenOverlay" aria-hidden="true">
    <div class="token-box">
      <div class="token-title">Dropbox Token Ë®≠ÂÆöÔºàApp folderÔºâ</div>
      <div class="token-hint">
        ‚úÖ ÊµÅÁ®ãÔºö<b>Ë≤º‰∏ä Token ‚Üí Â°´ÂØ´ App ÂêçÁ®± ‚Üí È©óË≠âÔºàÈ°ØÁ§∫Â∞çÊáâ emailÔºâ‚Üí ÂÑ≤Â≠ò</b><br>
        ‚ö† Dropbox API ÁÑ°Ê≥ïËá™ÂãïËÆÄÂá∫„Äå/Apps/APP_NAME/„ÄçÁöÑ APP_NAMEÔºåÊâÄ‰ª• App ÂêçÁ®±Ë´ãÂ°´‰∏ÄÊ¨°Âç≥ÂèØ„ÄÇ
      </div>

      <div class="token-row">
        <input class="token-input" id="tokenInput" type="password" placeholder="Ë≤º‰∏ä Access TokenÔºàsl. ÈñãÈ†≠Ôºâ" />
        <button class="token-eye" id="tokenEyeBtn" type="button">üëÅ</button>
      </div>

      <div class="token-row">
        <input class="token-input" id="appNameInput" type="text" placeholder="App ÂêçÁ®±ÔºàDropbox ÁöÑ /Apps/ ÂÖßÁúãÂà∞ÁöÑÂêçÁ®±Ôºâ" />
      </div>

      <div class="token-msg" id="tokenMsg"></div>

      <div class="token-actions">
        <button class="token-btn ghost" id="tokenSkipBtn" type="button">Á®çÂæåÔºàÂè™Áî®Êú¨Ê©üÔºâ</button>
        <button class="token-btn" id="tokenVerifyBtn" type="button">È©óË≠â Token</button>
        <button class="token-btn" id="tokenSaveBtn" type="button" disabled>ÂÑ≤Â≠ò</button>
      </div>
    </div>
  </div>

  <!-- Login overlay -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <div class="login-title">Tasun Ë≥áÊñô ¬∑ ÁôªÂÖ•</div>
      <form id="loginForm">
        <div class="login-field">
          <label for="usernameInput">‰ΩøÁî®ËÄÖÂêçÁ®±ÔºàÂèØËº∏ÂÖ• / ÂèØÈÅ∏ÊìáÔºâ</label>
          <div class="login-user-wrapper">
            <input id="usernameInput" name="username" class="login-user-input"
              type="text" list="usernameList" autocomplete="username"
              placeholder="Ëº∏ÂÖ•ÊàñÊåâ ‚ñº ÈÅ∏Êìá" />
            <button type="button" class="btn-user-drop" id="btnUserDrop">‚ñº</button>
            <datalist id="usernameList"></datalist>
            <div class="user-drop" id="userDrop" aria-hidden="true"></div>
          </div>
        </div>

        <div class="login-field">
          <label for="password">ÂØÜÁ¢º</label>
          <div class="login-pwd-wrapper">
            <input id="password" name="password" type="password" autocomplete="current-password" class="login-pwd-input" />
            <button type="button" class="btn-eye-login" id="btnTogglePwd">üëÅ</button>
          </div>
        </div>

        <div class="login-error" id="loginError"></div>
        <div class="login-actions">
          <button type="submit" class="btn-login">ÁôªÂÖ•</button>
        </div>
      </form>
    </div>
  </div>

  <main class="hero">
    <div class="hero-inner">
      <div class="user-bar">
        <div class="user-pill" id="userInfo">ÁõÆÂâç‰ΩøÁî®ËÄÖÔºöÊú™ÁôªÂÖ•</div>
        <button class="btn-switch" id="btnSwitchUser">ÂàáÊèõÂ∏≥Ëôü</button>
      </div>

      <div class="site-title-wrapper">
        <div class="site-title">Tasun Ë≥áÊñô</div>
      </div>

      <div class="nav-area" id="navArea"></div>

      <a class="nav-btn nav-right bottom" id="systemBtn" href="Ê¨äÈôêË°®.html">
        <span>Á≥ªÁµ± / Ê¨äÈôê</span>
      </a>
    </div>
  </main>

  <script>
    const AUTH_KEY    = "tasunAuthTable_v1";
    const NAV_KEY     = "tasunNavButtons_v1";
    const CURRENT_KEY = "tasunCurrentUser_v1"; // sessionStorage

    const DBX_TOKEN_KEY   = "tasunDbxToken_v1";
    const DBX_APPNAME_KEY = "tasunDbxAppName_v1";
    const DBX_FOLDER_KEY  = "tasunDbxFolder_v1";
    const DEFAULT_DBX_FOLDER = "/Tasun/Ê¨äÈôê";

    const DBX_ACCOUNT_EMAIL_KEY = "tasunDbxAccountEmail_v1";
    const DBX_ACCOUNT_ID_KEY    = "tasunDbxAccountId_v1";

    async function fetchWithTimeout(url, options={}, timeoutMs=15000){
      const ctrl = new AbortController();
      const id = setTimeout(()=> ctrl.abort(), timeoutMs);
      try { return await fetch(url, { ...options, signal: ctrl.signal }); }
      finally { clearTimeout(id); }
    }

    function mapRole(v){
      const s = String(v ?? "").trim().toLowerCase();
      if(!s) return "";
      if(s==="admin") return "admin";
      if(s==="write" || s==="edit") return "write";
      if(s==="read"  || s==="view") return "read";
      if(s==="0") return "admin";
      if(s==="1") return "write";
      if(s==="2") return "read";
      return s;
    }

    function setCurrentUser(user){
      const username = String(user?.username || "").trim();
      const role = mapRole(user?.role ?? user?.level) || "read";
      const payload = { username, role, level: role };
      try{ sessionStorage.setItem(CURRENT_KEY, JSON.stringify(payload)); }catch(e){}
      try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}
      return payload;
    }
    function getCurrentUser(){
      let cu=null;
      try{ cu = JSON.parse(sessionStorage.getItem(CURRENT_KEY) || "null"); }catch(e){ cu=null; }
      if(!cu || !cu.username) return null;
      const role = mapRole(cu.role ?? cu.level) || "read";
      return { username: String(cu.username).trim(), role, level: role };
    }
    function clearCurrentUser(){
      try{ sessionStorage.removeItem(CURRENT_KEY); }catch(e){}
      try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}
    }
    function isAdminSession(){
      const cu = getCurrentUser();
      return !!(cu && mapRole(cu.role) === "admin");
    }

    function getDbxToken(){ return String(localStorage.getItem(DBX_TOKEN_KEY) || "").trim(); }
    function setDbxToken(t){ localStorage.setItem(DBX_TOKEN_KEY, String(t || "").trim()); }
    function dbxEnabled(){ const t=getDbxToken(); return !!(t && t.length > 20); }
    function dbxAuthHeader(){ return "Bearer " + getDbxToken(); }

    function getDbxFolder(){
      return String(localStorage.getItem(DBX_FOLDER_KEY) || DEFAULT_DBX_FOLDER).trim() || DEFAULT_DBX_FOLDER;
    }
    function getDbxAppName(){
      return String(localStorage.getItem(DBX_APPNAME_KEY) || "").trim();
    }
    function setDbxAppName(v){
      localStorage.setItem(DBX_APPNAME_KEY, String(v||"").trim());
    }

    async function dbxGetCurrentAccount(){
      if(!dbxEnabled()) return { ok:false, msg:"‚ùå Token Êú™Ë®≠ÂÆö" };

      let res;
      try{
        res = await fetchWithTimeout("https://api.dropboxapi.com/2/users/get_current_account", {
          method: "POST",
          cache: "no-store",
          headers: {
            "Authorization": dbxAuthHeader(),
            "Content-Type": "application/json"
          },
          body: "null"
        }, 15000);
      }catch(e){
        return { ok:false, msg:"‚ùå Token È©óË≠âÈÄæÊôÇÊàñÁ∂≤Ë∑Ø‰∏≠Êñ∑Ôºà15 ÁßíÔºâ" };
      }

      const text = await res.text();
      let json=null; try{ json = JSON.parse(text); }catch(e){}

      if(!res.ok){
        if(res.status === 401){
          return { ok:false, msg:"‚ùå Token ÁÑ°ÊïàÊàñÈÅéÊúüÔºàHTTP 401Ôºâ\nË´ãÈáçÊñ∞Áî¢Áîü TokenÔºàÈÄöÂ∏∏ sl. ÈñãÈ†≠Ôºâ„ÄÇ" };
        }
        return { ok:false, msg:`‚ùå Token È©óË≠âÂ§±ÊïóÔºàHTTP ${res.status}Ôºâ\n${text}` };
      }

      const email = json?.email || "";
      const accountId = json?.account_id || "";
      const display = json?.name?.display_name || "";

      try{
        localStorage.setItem(DBX_ACCOUNT_EMAIL_KEY, email);
        localStorage.setItem(DBX_ACCOUNT_ID_KEY, accountId);
      }catch(e){}

      const appName = getDbxAppName() || "ÔºàÂ∞öÊú™Â°´ App ÂêçÁ®±Ôºâ";
      const uiPath = `/Apps/${appName}${getDbxFolder()}`;

      return {
        ok:true, email, accountId, display,
        msg:
`‚úÖ Token OK
Â∞çÊáâÂ∏≥ËôüÔºö${email}${display ? `Ôºà${display}Ôºâ` : ""}
App folder ‰ªãÈù¢Ë∑ØÂæëÔºö${uiPath}
ÔºàAPI ÂØ¶ÈöõÂèØË¶ãË∑ØÂæëÔºö${getDbxFolder()}Ôºâ`
      };
    }

    function safeJsonParse(s, fallback){ try{ return JSON.parse(s); }catch(e){ return fallback; } }

    const DEFAULT_NAV = [
      { id: "btn1", label: "ËáªÈºéÊôÇ‰ª£Â§ßÂªàÁÆ°ÁêÜË°®", href: "ËáªÈºéÁÆ°ÁêÜË°®.html", target: "", roles: ["admin","write","read"] },
      { id: "btn2", label: "Áº∫Â§± / ÂìÅË≥™",       href: "ÁîÑÈºéquality.html", target: "", roles: ["admin","write","read"] },
      { id: "btn3", label: "Èõ≤Á´ØÊ™îÊ°à",          href: "https://www.dropbox.com/", target: "_blank", roles: ["admin","write","read"] },
      { id: "btn4", label: "Â∑•Á®ãË≥áÊñôÂ∫´",        href: "Â∑•Á®ãË≥áÊñôÂ∫´.html", target: "", roles: ["admin","write"] },
      { id: "btn5", label: "Ë≥áÊñôÂ∫´",            href: "#", target: "", roles: ["admin","write","read"] }
    ];
    const LEGACY_BUTTON_KEYS = ["btn1", "btn2", "btn3", "btn4", "btn5"];

    const loginOverlay = document.getElementById("loginOverlay");
    const loginForm    = document.getElementById("loginForm");
    const loginError   = document.getElementById("loginError");
    const userInfo     = document.getElementById("userInfo");
    const btnSwitch    = document.getElementById("btnSwitchUser");
    const btnTogglePwd = document.getElementById("btnTogglePwd");
    const navArea      = document.getElementById("navArea");
    const systemBtn    = document.getElementById("systemBtn");

    const usernameInput = document.getElementById("usernameInput");
    const usernameList  = document.getElementById("usernameList");
    const btnUserDrop   = document.getElementById("btnUserDrop");
    const userDrop      = document.getElementById("userDrop");

    const tokenOverlay = document.getElementById("tokenOverlay");
    const tokenInput   = document.getElementById("tokenInput");
    const appNameInput = document.getElementById("appNameInput");
    const tokenSaveBtn = document.getElementById("tokenSaveBtn");
    const tokenVerifyBtn = document.getElementById("tokenVerifyBtn");
    const tokenSkipBtn = document.getElementById("tokenSkipBtn");
    const tokenEyeBtn  = document.getElementById("tokenEyeBtn");
    const tokenMsg     = document.getElementById("tokenMsg");

    let NAV_CONFIG = [];
    let AUTH_TABLE = [];
    let mainNavBtns = [];
    let currentVisibleBtns = [];

    function showTokenOverlay(){
      tokenOverlay.style.display = "flex";
      tokenOverlay.setAttribute("aria-hidden","false");
      tokenInput.value = getDbxToken();
      appNameInput.value = getDbxAppName();
      tokenSaveBtn.disabled = true;
      tokenMsg.textContent =
        "Ê≠•È©ü 1/4ÔºöË≤º‰∏ä Token\n" +
        "Ê≠•È©ü 2/4ÔºöÂ°´ÂØ´ App ÂêçÁ®±ÔºàDropbox /Apps/ ÂÖßÁúãÂà∞ÁöÑÂêçÁ®±Ôºâ\n" +
        "Ê≠•È©ü 3/4ÔºöÊåâ„ÄåÈ©óË≠â Token„Äç‚Üí È°ØÁ§∫Â∞çÊáâ email + Apps Ë∑ØÂæë\n" +
        "Ê≠•È©ü 4/4ÔºöÊåâ„ÄåÂÑ≤Â≠ò„Äç";
      setTimeout(()=> tokenInput.focus(), 40);
    }
    function hideTokenOverlay(){
      tokenOverlay.style.display = "none";
      tokenOverlay.setAttribute("aria-hidden","true");
    }

    tokenEyeBtn.addEventListener("click", ()=>{
      tokenInput.type = (tokenInput.type === "password") ? "text" : "password";
    });
    tokenSkipBtn.addEventListener("click", ()=> hideTokenOverlay());

    let lastVerifyOk = false;

    tokenVerifyBtn.addEventListener("click", async ()=>{
      const t = String(tokenInput.value || "").trim();
      const appName = String(appNameInput.value || "").trim();
      if(!t){
        tokenMsg.textContent = "Ê≠•È©ü 1/4ÔºöË´ãÂÖàË≤º‰∏ä Token„ÄÇ";
        lastVerifyOk = false;
        tokenSaveBtn.disabled = true;
        return;
      }
      if(!appName){
        tokenMsg.textContent = "Ê≠•È©ü 2/4ÔºöË´ãÂ°´ App ÂêçÁ®±ÔºàDropbox ÁöÑ /Apps/ ÂÖßÁúãÂà∞ÁöÑÂêçÁ®±Ôºâ„ÄÇ";
        lastVerifyOk = false;
        tokenSaveBtn.disabled = true;
        return;
      }

      setDbxToken(t);
      setDbxAppName(appName);

      tokenMsg.textContent = "Ê≠•È©ü 3/4ÔºöÊ≠£Âú®È©óË≠â Token ‰∏¶ÂèñÂæóÂ∞çÊáâ email‚Ä¶";
      const chk = await dbxGetCurrentAccount();
      if(!chk.ok){
        lastVerifyOk = false;
        tokenSaveBtn.disabled = true;
        tokenMsg.textContent = chk.msg;
        return;
      }

      lastVerifyOk = true;
      tokenSaveBtn.disabled = false;
      tokenMsg.textContent = chk.msg + "\n\n‚úÖ Ë´ãÁ¢∫Ë™ç email Ëàá Apps Ë∑ØÂæëÊ≠£Á¢∫ÔºåÂÜçÊåâ„ÄåÂÑ≤Â≠ò„Äç„ÄÇ";
    });

    tokenSaveBtn.addEventListener("click", async ()=>{
      const t = String(tokenInput.value || "").trim();
      const appName = String(appNameInput.value || "").trim();
      if(!t){ tokenMsg.textContent = "Ë´ãÂÖàË≤º‰∏ä Token„ÄÇ"; return; }
      if(!appName){ tokenMsg.textContent = "Ë´ãÂÖàÂ°´ App ÂêçÁ®±„ÄÇ"; return; }
      if(!lastVerifyOk){
        tokenMsg.textContent = "Ë´ãÂÖàÊåâ„ÄåÈ©óË≠â Token„ÄçÁ¢∫Ë™çÂ∞çÊáâ email Ê≠£Á¢∫ÔºåÂÜçÂÑ≤Â≠ò„ÄÇ";
        return;
      }
      setDbxToken(t);
      setDbxAppName(appName);
      hideTokenOverlay();
      populateUserSelect();
    });

    function normalizeNavEntry(entry, index) {
      const base = DEFAULT_NAV[index] || {};
      const label = (entry && entry.label ? String(entry.label).trim() : "") || base.label || `ÊåâÈàï${index + 1}`;
      const href  = (entry && entry.href  ? String(entry.href).trim()  : "") || base.href  || "#";
      const target= (entry && entry.target? String(entry.target).trim(): "") || base.target|| "";
      const roles = Array.isArray(entry && entry.roles)
        ? entry.roles.slice()
        : (Array.isArray(base.roles) ? base.roles.slice() : ["admin","write","read"]);
      return { id: `btn${index + 1}`, label, href, target, roles };
    }

    function loadNavConfig() {
      const raw = localStorage.getItem(NAV_KEY);
      if (!raw) {
        const defaults = DEFAULT_NAV.slice();
        localStorage.setItem(NAV_KEY, JSON.stringify(defaults));
        return defaults;
      }
      try {
        const arr = JSON.parse(raw);
        if (Array.isArray(arr) && arr.length) return arr.map((item, idx) => normalizeNavEntry(item, idx));
      } catch (e) {}
      const defaults = DEFAULT_NAV.slice();
      localStorage.setItem(NAV_KEY, JSON.stringify(defaults));
      return defaults;
    }

    function makeButtonsAll(count) { return Array(count).fill(true); }
    function makeButtonsOnlyLast(count) {
      const arr = Array(count).fill(false);
      if (count > 0) arr[count - 1] = true;
      return arr;
    }

    function getDefaultAuthTable(btnCount) {
      return [
        { username: "alex",  password: "Tasun08040224", level: "admin", role:"admin", buttons: makeButtonsAll(btnCount) },
        { username: "tasun", password: "tasun08040224", level: "write", role:"write", buttons: makeButtonsAll(btnCount) },
        { username: "wu",    password: "123456",        level: "read",  role:"read",  buttons: makeButtonsOnlyLast(btnCount) }
      ];
    }

    function normalizeRowFromStorage(row, btnCount) {
      const username = String(row.username || "").trim();
      const password = String(row.password || "");
      const level = mapRole(row.level ?? row.role) || "read";

      let buttons = [];
      if (Array.isArray(row.buttons)) {
        buttons = row.buttons.slice();
      } else {
        const legacy = [];
        LEGACY_BUTTON_KEYS.forEach(k => {
          if (Object.prototype.hasOwnProperty.call(row, k)) legacy.push(!!row[k]);
        });
        buttons = legacy;
      }

      const resultButtons = [];
      for (let i = 0; i < btnCount; i++) resultButtons[i] = !!buttons[i];

      return { username, password, level, role: level, buttons: resultButtons };
    }

    function loadAuthTable(btnCount) {
      const raw = localStorage.getItem(AUTH_KEY);
      if (!raw) {
        const defaults = getDefaultAuthTable(btnCount);
        localStorage.setItem(AUTH_KEY, JSON.stringify(defaults));
        return defaults.map(r=> normalizeRowFromStorage(r, btnCount));
      }
      try {
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) {
          const fixed = arr.map(r => normalizeRowFromStorage(r, btnCount));
          localStorage.setItem(AUTH_KEY, JSON.stringify(fixed));
          return fixed;
        }
      } catch (e) {}
      const defaults = getDefaultAuthTable(btnCount);
      localStorage.setItem(AUTH_KEY, JSON.stringify(defaults));
      return defaults.map(r=> normalizeRowFromStorage(r, btnCount));
    }

    function buildMainButtons() {
      NAV_CONFIG = loadNavConfig();
      AUTH_TABLE = loadAuthTable(NAV_CONFIG.length);

      mainNavBtns = [];
      navArea.innerHTML = "";

      NAV_CONFIG.forEach((cfg, index) => {
        const a = document.createElement("a");
        a.className = "nav-btn";
        a.dataset.index = String(index);

        const span = document.createElement("span");
        span.textContent = cfg.label;
        a.appendChild(span);

        a.href = cfg.href || "#";
        if (cfg.target) {
          a.target = cfg.target;
          if (cfg.target === "_blank") a.rel = "noopener noreferrer";
        }

        a.style.display = "none";
        navArea.appendChild(a);
        mainNavBtns.push(a);
      });

      if (systemBtn) systemBtn.style.display = "none";
    }

    function isRoleAllowedForIndex(index, level) {
      const cfg = NAV_CONFIG[index];
      if (!cfg || !Array.isArray(cfg.roles)) return true;
      const r = mapRole(level) || "read";
      return cfg.roles.includes(r);
    }

    function applyUser(user) {
      document.body.classList.remove("locked");
      loginOverlay.style.display = "none";

      const lvl = mapRole(user.level ?? user.role) || "read";
      setCurrentUser({ username: user.username, role: lvl, level: lvl });

      userInfo.textContent = `ÁõÆÂâç‰ΩøÁî®ËÄÖÔºö${user.username} (${lvl})`;

      const visibleMain = [];

      mainNavBtns.forEach((btn, index) => {
        const allowedByRole = isRoleAllowedForIndex(index, lvl);
        const btnFlags = Array.isArray(user.buttons) ? user.buttons : [];
        const allowedByAuth = index < btnFlags.length ? !!btnFlags[index] : true;

        if (allowedByRole && allowedByAuth) {
          btn.style.display = "flex";
          visibleMain.push(btn);
        } else {
          btn.style.display = "none";
        }
      });

      currentVisibleBtns = visibleMain;
      if (systemBtn) systemBtn.style.display = (lvl === "admin") ? "flex" : "none";
    }

    function resetButtonsForLogout() {
      currentVisibleBtns = [];
      mainNavBtns.forEach(btn => btn.style.display = "none");
      if (systemBtn) systemBtn.style.display = "none";
    }

    function closeUserDrop(){
      userDrop.style.display = "none";
      userDrop.setAttribute("aria-hidden", "true");
    }
    function openUserDrop(){
      userDrop.style.display = "block";
      userDrop.setAttribute("aria-hidden", "false");
    }
    function toggleUserDrop(){
      const opened = userDrop.style.display === "block";
      if(opened) closeUserDrop();
      else openUserDrop();
    }

    function populateUserSelect(){
      usernameList.innerHTML = "";
      userDrop.innerHTML = "";

      (AUTH_TABLE || []).forEach(row => {
        const u = String(row.username || "").trim();
        if(!u) return;

        const opt = document.createElement("option");
        opt.value = u;
        usernameList.appendChild(opt);

        const b = document.createElement("button");
        b.type = "button";
        b.textContent = u;
        b.addEventListener("click", ()=> {
          usernameInput.value = u;
          closeUserDrop();
          usernameInput.focus();
        });
        userDrop.appendChild(b);
      });

      if(usernameInput && !String(usernameInput.value || "").trim()){
        const first = (AUTH_TABLE || []).find(r => String(r.username||"").trim());
        if(first) usernameInput.value = String(first.username || "").trim();
      }
    }

    function findUser(username, password) {
      const trimmedName = (username || "").trim();
      return (AUTH_TABLE || []).find(row => row.username === trimmedName && row.password === password);
    }

    (function boot(){
      try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}

      buildMainButtons();
      populateUserSelect();

      if(!dbxEnabled()) showTokenOverlay();

      const cu = getCurrentUser();
      if(cu && cu.username){
        const row = (AUTH_TABLE || []).find(r => r.username === cu.username);
        if(row){
          applyUser(row);
        }else{
          clearCurrentUser();
          document.body.classList.add("locked");
          loginOverlay.style.display = "flex";
          resetButtonsForLogout();
          userInfo.textContent = "ÁõÆÂâç‰ΩøÁî®ËÄÖÔºöÊú™ÁôªÂÖ•";
        }
      }else{
        document.body.classList.add("locked");
        loginOverlay.style.display = "flex";
        resetButtonsForLogout();
        userInfo.textContent = "ÁõÆÂâç‰ΩøÁî®ËÄÖÔºöÊú™ÁôªÂÖ•";
      }
    })();

    loginForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const username = (usernameInput.value || "").trim();
      const password = document.getElementById("password").value;

      const user = findUser(username, password);
      if (!user) {
        loginError.textContent = "Â∏≥ËôüÊàñÂØÜÁ¢ºÈåØË™§ÔºåË´ãÂÜçË©¶‰∏ÄÊ¨°„ÄÇ";
        return;
      }
      loginError.textContent = "";
      applyUser(user);
    });

    btnSwitch.addEventListener("click", function () {
      clearCurrentUser();
      document.body.classList.add("locked");
      loginOverlay.style.display = "flex";
      loginError.textContent = "";
      loginForm.reset();
      resetButtonsForLogout();
      userInfo.textContent = "ÁõÆÂâç‰ΩøÁî®ËÄÖÔºöÊú™ÁôªÂÖ•";
      if(usernameInput) usernameInput.focus();
    });

    btnTogglePwd.addEventListener("click", function () {
      const pwdInput = document.getElementById("password");
      if (!pwdInput) return;
      pwdInput.type = pwdInput.type === "password" ? "text" : "password";
    });

    btnUserDrop.addEventListener("click", function(){
      toggleUserDrop();
    });

    document.addEventListener("click", (e)=>{
      const inside = e.target === userDrop || userDrop.contains(e.target) ||
                     e.target === btnUserDrop || e.target === usernameInput;
      if(!inside) closeUserDrop();
    });

    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        if(tokenOverlay && tokenOverlay.style.display === "flex") hideTokenOverlay();
        closeUserDrop();
      }
    });
  </script>
</body>
</html>
