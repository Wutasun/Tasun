<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tasun 資料首頁 · 空無明</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --gold:#f6d37a;
      --gold-soft: rgba(246, 211, 122, 0.78);
      --panel-border: rgba(246, 211, 122, 0.26);
      --bg0:#050302;
      --bg1:#0a0b0c;
      --shadow: 0 18px 40px rgba(0,0,0,.65);
    }
    *{ box-sizing:border-box; margin:0; padding:0; }
    body{
      min-height:100vh;
      font-family:"Noto Serif TC","Microsoft JhengHei",serif;
      color:var(--gold);
      background:
        radial-gradient(circle at 50% 18%, rgba(255, 228, 170, 0.18), rgba(0,0,0,0.98)),
        radial-gradient(circle at 15% 90%, rgba(246,211,122,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .shell{
      width:min(1320px, 96vw);
      margin: 16px auto 22px;
      padding: 14px 14px 22px;
      border-radius: 26px;
      border: 1px solid rgba(246,211,122,.20);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.78));
      box-shadow: var(--shadow);
      position:relative;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .brand{
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
    }
    .brand .title{
      font-size: 1.12rem;
      letter-spacing:.22em;
      text-indent:.22em;
      text-shadow: 0 0 18px rgba(246,211,122,.45);
      white-space:nowrap;
    }
    .pill{
      padding: .30rem .85rem;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.50);
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,.18), rgba(0,0,0,.90));
      color: var(--gold-soft);
      font-size: .85rem;
      white-space:nowrap;
      opacity:.95;
    }

    .actions{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .btn{
      border: 1px solid rgba(246,211,122,.72);
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,.22), rgba(0,0,0,.92));
      color: var(--gold);
      border-radius: 999px;
      padding: 0.42rem 1.05rem;
      cursor: pointer;
      letter-spacing: .10em;
      text-indent: .10em;
      box-shadow: 0 8px 16px rgba(0,0,0,.72);
      white-space:nowrap;
      user-select:none;
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .btn.ghost{
      background: transparent;
      border-color: rgba(246,211,122,.35);
      box-shadow:none;
    }

    .hero{
      margin-top: 10px;
      border-radius: 22px;
      border: 1px solid rgba(246,211,122,.18);
      background:
        radial-gradient(circle at 50% 32%, rgba(246,211,122,.13), rgba(0,0,0,.80)),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.72));
      padding: 18px 14px 18px;
      position:relative;
      overflow:hidden;
    }
    .hero::before{
      content:"";
      position:absolute; inset:-60px -40px auto -40px;
      height: 260px;
      background: radial-gradient(circle at 50% 60%, rgba(246,211,122,.22), transparent 68%);
      filter: blur(2px);
      pointer-events:none;
    }
    .hero-grid{
      display:grid;
      grid-template-columns: 1fr min(420px, 72vw) 1fr;
      gap: 12px;
      align-items:center;
    }

    .center{
      text-align:center;
      padding: 10px 8px;
    }
    .center .big{
      font-size: clamp(32px, 4.2vw, 56px);
      letter-spacing:.28em;
      text-indent:.28em;
      text-shadow: 0 0 26px rgba(246,211,122,.52);
      margin-bottom: 10px;
      opacity:.95;
    }
    .lotus{
      width:min(360px, 62vw);
      aspect-ratio: 1 / 1;
      margin: 0 auto;
      border-radius: 999px;
      background:
        radial-gradient(circle at 50% 40%, rgba(255,220,150,.45), rgba(0,0,0,.02) 48%),
        radial-gradient(circle at 50% 64%, rgba(246,211,122,.26), rgba(0,0,0,.90) 72%);
      border: 1px solid rgba(246,211,122,.18);
      box-shadow: 0 0 42px rgba(0,0,0,.55), 0 0 30px rgba(246,211,122,.14);
      position:relative;
    }
    .lotus::after{
      content:"";
      position:absolute; inset:18%;
      border-radius: 999px;
      background:
        radial-gradient(circle at 50% 45%, rgba(246,211,122,.42), transparent 62%),
        radial-gradient(circle at 50% 70%, rgba(255,160,70,.22), rgba(0,0,0,.0) 55%);
      filter: blur(0.4px);
      opacity:.95;
    }

    .side{
      display:flex;
      flex-direction:column;
      gap: 16px;
      padding: 12px 6px;
    }

    .navbtn{
      width: 100%;
      min-height: 66px;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.40);
      background:
        radial-gradient(circle at 15% 10%, rgba(246,211,122,.18), rgba(0,0,0,.82));
      box-shadow: 0 14px 26px rgba(0,0,0,.55);
      color: var(--gold);
      font-size: 1.05rem;
      letter-spacing:.14em;
      text-indent:.14em;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      padding: 12px 14px;
      user-select:none;
    }
    .navbtn:disabled{
      opacity:.35;
      cursor:not-allowed;
      filter: grayscale(60%);
    }

    .foot{
      margin-top: 10px;
      font-size:.86rem;
      color: rgba(246,211,122,.70);
      letter-spacing:.05em;
      padding: 10px 6px 0;
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      justify-content: space-between;
    }

    /* login overlay */
    .overlay{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 5000;
      background: radial-gradient(circle at 50% 18%, rgba(255, 228, 170, 0.32), rgba(0, 0, 0, 0.98));
    }
    .login-box{
      width: min(560px, 94vw);
      border-radius: 18px;
      padding: 1.35rem 1.35rem 1.1rem;
      background: radial-gradient(circle at 0% 0%, rgba(246, 211, 122, 0.22), rgba(0, 0, 0, 0.95));
      border: 1px solid rgba(246, 211, 122, 0.35);
      box-shadow: 0 0 34px rgba(0,0,0,0.92), 0 0 24px rgba(246,211,122,0.18);
      color: var(--gold-soft);
    }
    .login-title{
      text-align:center;
      font-size: 1.12rem;
      letter-spacing:.20em;
      text-indent:.20em;
      margin-bottom: .65rem;
    }
    .login-row{ display:flex; gap:10px; flex-wrap:wrap; margin-top: .65rem; }
    .in{
      width:100%;
      padding: .55rem .78rem;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.45);
      background: rgba(0,0,0,.86);
      color: var(--gold);
      outline:none;
    }
    .in:focus{ border-color: rgba(255,238,190,.9); box-shadow: 0 0 12px rgba(246,211,122,.65); }
    .login-msg{
      margin-top: .75rem;
      min-height: 1.2rem;
      font-size: .9rem;
      white-space: pre-line;
      color: rgba(255, 220, 190, 0.95);
    }
    .login-actions{
      display:flex; justify-content:flex-end; gap:10px; margin-top: .9rem; flex-wrap:wrap;
    }

    @media (max-width: 980px){
      .hero-grid{ grid-template-columns: 1fr; }
      .side{ flex-direction: row; flex-wrap: wrap; justify-content:center; }
      .navbtn{ width: min(420px, 92vw); }
    }
  </style>
</head>

<body>
  <div class="shell" id="appShell" style="display:none;">
    <div class="topbar">
      <div class="brand">
        <div class="title">Tasun 資料</div>
        <div class="pill" id="whoPill">目前使用者：—</div>
      </div>

      <div class="actions">
        <button class="btn ghost" id="btnDropbox" type="button">Dropbox</button>
        <button class="btn" id="btnSwitch" type="button">切換帳號</button>
      </div>
    </div>

    <div class="hero">
      <div class="hero-grid">
        <div class="side" id="leftCol"></div>

        <div class="center">
          <div class="big">空 無 明</div>
          <div class="lotus" aria-hidden="true"></div>
        </div>

        <div class="side" id="rightCol"></div>
      </div>

      <div class="foot">
        <div>登入狀態會記到「關閉瀏覽器」為止（不會永久記住）。</div>
        <div style="opacity:.92;">Dropbox 帳號提示：<b>tasun_8@hotmail.com</b></div>
      </div>
    </div>
  </div>

  <!-- Login overlay -->
  <div class="overlay" id="loginOverlay" aria-hidden="true">
    <div class="login-box">
      <div class="login-title">登入 Tasun（必須先登入才能進入首頁）</div>

      <div style="font-size:.9rem; line-height:1.7; color:rgba(246,211,122,0.80);">
        帳號從「權限表」載入（預設：alex / tasun / wu）。<br>
        ✅ 登入狀態只會保留到關閉瀏覽器為止（sessionStorage）。
      </div>

      <div class="login-row">
        <select class="in" id="loginUser"></select>
      </div>
      <div class="login-row">
        <input class="in" id="loginPass" type="password" placeholder="輸入密碼" />
      </div>

      <div class="login-msg" id="loginMsg"></div>

      <div class="login-actions">
        <button class="btn ghost" id="btnGoPerm" type="button">開啟權限表</button>
        <button class="btn" id="btnLogin" type="button">登入</button>
      </div>
    </div>
  </div>

<script>
  // ==========================
  // Keys（與權限表一致）
  // ==========================
  const AUTH_KEY    = "tasunAuthTable_v1";
  const NAV_KEY     = "tasunNavButtons_v1";

  // ✅ 只記到關閉瀏覽器（sessionStorage）
  const CURRENT_KEY = "tasunCurrentUser_v1";

  const DBX_HINT_EMAIL = "tasun_8@hotmail.com";

  // ==========================
  // Utils
  // ==========================
  function safeJsonParse(s, fallback){
    try{ return JSON.parse(s); }catch(e){ return fallback; }
  }
  function getCurrentUser(){
    const raw = sessionStorage.getItem(CURRENT_KEY);
    const cu = safeJsonParse(raw || "null", null);
    return (cu && cu.username) ? cu : null;
  }
  function setCurrentUser(obj){
    sessionStorage.setItem(CURRENT_KEY, JSON.stringify(obj || null));
  }
  function clearCurrentUser(){
    sessionStorage.removeItem(CURRENT_KEY);
  }
  function normLevel(x){
    return String(x || "").toLowerCase().trim();
  }

  // ==========================
  // Data bootstrap
  // ==========================
  function loadNav(){
    const raw = localStorage.getItem(NAV_KEY);
    const arr = safeJsonParse(raw || "[]", []);
    if(Array.isArray(arr) && arr.length) return arr;

    const defaults = [
      { id:"btn1", label:"臻鼎時代大廈管理表", href:"臻鼎管理表.html", target:"", roles:["admin","write","read"] },
      { id:"btn2", label:"缺失 / 品質", href:"甄鼎quality.html", target:"", roles:["admin","write","read"] },
      { id:"btn3", label:"雲端檔案", href:"https://www.dropbox.com/", target:"_blank", roles:["admin","write","read"] },
      { id:"btn4", label:"工程資料庫", href:"工程資料庫.html", target:"", roles:["admin","write"] },
      { id:"btn5", label:"資料庫", href:"#", target:"", roles:["admin","write","read"] }
    ];
    localStorage.setItem(NAV_KEY, JSON.stringify(defaults));
    return defaults;
  }

  function loadAuth(btnCount){
    const raw = localStorage.getItem(AUTH_KEY);
    let arr = safeJsonParse(raw || "null", null);

    if(!Array.isArray(arr)){
      arr = [
        { username:"alex",  password:"Tasun08040224", level:"admin", buttons: Array(btnCount).fill(true) },
        { username:"tasun", password:"tasun08040224", level:"write", buttons: Array(btnCount).fill(true) },
        { username:"wu",    password:"123456",        level:"read",  buttons: (()=>{ const a=Array(btnCount).fill(false); if(btnCount) a[btnCount-1]=true; return a; })() }
      ];
      localStorage.setItem(AUTH_KEY, JSON.stringify(arr));
    }

    // normalize to btnCount
    return arr.map(r=>{
      const b = Array.isArray(r.buttons) ? r.buttons.slice() : [];
      const out = [];
      for(let i=0;i<btnCount;i++) out[i] = !!b[i];
      return {
        username: String(r.username||"").trim(),
        password: String(r.password||""),
        level: normLevel(r.level||"read") || "read",
        buttons: out
      };
    }).filter(x=>x.username);
  }

  // ==========================
  // UI
  // ==========================
  const appShell = document.getElementById("appShell");
  const whoPill = document.getElementById("whoPill");

  const leftCol  = document.getElementById("leftCol");
  const rightCol = document.getElementById("rightCol");

  const btnSwitch = document.getElementById("btnSwitch");
  const btnDropbox = document.getElementById("btnDropbox");

  // login overlay
  const loginOverlay = document.getElementById("loginOverlay");
  const loginUser = document.getElementById("loginUser");
  const loginPass = document.getElementById("loginPass");
  const loginMsg  = document.getElementById("loginMsg");
  const btnLogin  = document.getElementById("btnLogin");
  const btnGoPerm = document.getElementById("btnGoPerm");

  function showLogin(msg){
    loginOverlay.style.display = "flex";
    loginOverlay.setAttribute("aria-hidden","false");
    appShell.style.display = "none";

    // fill users
    const nav = loadNav();
    const auth = loadAuth(nav.length);
    loginUser.innerHTML = "";
    auth.forEach(a=>{
      const opt = document.createElement("option");
      opt.value = a.username;
      opt.textContent = `${a.username} (${a.level})`;
      loginUser.appendChild(opt);
    });

    loginMsg.textContent = msg || "";
    setTimeout(()=> loginPass.focus(), 50);
  }

  function hideLogin(){
    loginOverlay.style.display = "none";
    loginOverlay.setAttribute("aria-hidden","true");
    appShell.style.display = "";
  }

  function openLink(href, target){
    if(target === "_blank") window.open(href, "_blank", "noopener");
    else location.href = href;
  }

  function renderHome(){
    const cu = getCurrentUser();
    if(!cu){
      showLogin("請先登入後才可進入首頁。");
      return;
    }

    const level = normLevel(cu.level || cu.role);
    whoPill.textContent = `目前使用者：${cu.username} (${level || "read"})`;

    const nav = loadNav();
    const auth = loadAuth(nav.length);
    const me = auth.find(a=>a.username === cu.username);

    leftCol.innerHTML = "";
    rightCol.innerHTML = "";

    // 依序分配到左右欄（桌面版兩欄、手機版會自動換行）
    // 這裡保持你一直用的「左上→右上→左中→右中→左下→右下」邏輯
    const visible = [];

    nav.forEach((n, idx)=>{
      let ok = true;

      // 1) role gate
      const roles = Array.isArray(n.roles) ? n.roles.map(normLevel) : ["admin","write","read"];
      if(roles.length && !roles.includes(level)) ok = false;

      // 2) buttons gate (per user)
      if(me && Array.isArray(me.buttons)){
        if(!me.buttons[idx]) ok = false;
      }

      if(ok){
        visible.push({
          label: n.label || n.id || `btn${idx+1}`,
          href: n.href || "#",
          target: n.target || ""
        });
      }
    });

    // 固定第 6 顆：權限表（僅 admin）
    if(level === "admin"){
      visible.push({
        label: "系統 / 權限",
        href: "權限表.html",
        target: ""
      });
    }

    // 若沒有任何按鈕
    if(!visible.length){
      visible.push({ label: "（沒有可用按鈕）", href:"#", target:"" });
    }

    visible.forEach((it, i)=>{
      const btn = document.createElement("button");
      btn.className = "navbtn";
      btn.textContent = it.label;
      btn.disabled = (it.href === "#");
      btn.addEventListener("click", ()=> openLink(it.href, it.target));

      // i=0 left, i=1 right, i=2 left, i=3 right ...
      if(i % 2 === 0) leftCol.appendChild(btn);
      else rightCol.appendChild(btn);
    });

    hideLogin();
  }

  // ==========================
  // Login actions
  // ==========================
  function doLogin(){
    const uname = String(loginUser.value || "").trim();
    const pass  = String(loginPass.value || "");

    const nav = loadNav();
    const auth = loadAuth(nav.length);

    const u = auth.find(a=>a.username === uname);
    if(!u){
      loginMsg.textContent = "❌ 找不到此帳號（請先到「權限表」建立）。";
      return;
    }
    if(u.password !== pass){
      loginMsg.textContent = "❌ 密碼錯誤。";
      return;
    }

    setCurrentUser({ username: u.username, level: u.level, loginAt: Date.now() });
    loginPass.value = "";
    loginMsg.textContent = "✅ 登入成功，正在進入首頁…";
    setTimeout(renderHome, 120);
  }

  btnLogin.addEventListener("click", doLogin);
  loginPass.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });

  btnGoPerm.addEventListener("click", ()=> openLink("權限表.html", ""));

  btnSwitch.addEventListener("click", ()=>{
    clearCurrentUser();
    showLogin("已登出，請重新登入。");
  });

  btnDropbox.addEventListener("click", ()=>{
    // 無法替你自動登入指定 email，只能提示並開啟 Dropbox
    const ok = confirm(
      "將開啟 Dropbox 網站。\n\n提醒：請使用此帳號登入：\n" + DBX_HINT_EMAIL + "\n\n是否開啟？"
    );
    if(ok) window.open("https://www.dropbox.com/", "_blank", "noopener");
  });

  // ==========================
  // Boot
  // ==========================
  (function boot(){
    // 確保有 nav / auth 初始資料
    const nav = loadNav();
    loadAuth(nav.length);

    // 必須先登入
    const cu = getCurrentUser();
    if(!cu){
      showLogin("請先登入後才可進入首頁。");
      return;
    }
    appShell.style.display = "";
    renderHome();
  })();
</script>
</body>
</html>
