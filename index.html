<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Tasun è³‡æ–™é¦–é  Â· ç©ºç„¡æ˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --gold: #f6d37a;
      --gold-soft: rgba(246, 211, 122, 0.75);
      --panel-border: rgba(246, 211, 122, 0.35);

      --side-btn-offset: clamp(5%, 8vw, 10%);
      --side-text-offset: clamp(26%, 30vw, 34%);
      --btn-w: clamp(240px, 22vw, 420px);

      --stage-gap: clamp(12px, 1.8vw, 26px);
      --stage-inset-x: calc(var(--side-btn-offset) + var(--btn-w) + var(--stage-gap));

      --frame-inset: clamp(0.6rem, 1.2vw, 1.2rem);
      --frame-radius: clamp(22px, 2vw, 34px);
      --stage-top: clamp(4.0rem, 7vh, 5.4rem);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      font-family: "Noto Serif TC","æ¨™æ¥·é«”","Microsoft JhengHei",serif;
      background: #050302;
      color: var(--gold);
      overflow-x: hidden;
    }

    body.locked { overflow: hidden; }
    body.locked main.hero { pointer-events: none; filter: blur(2px) brightness(0.92); }
    body.locked .user-bar, body.locked #systemBtn { pointer-events: none; opacity: 0.65; }

    /* ==========================
       Token Overlay
       ========================== */
    .token-overlay{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 1200;
      background: radial-gradient(circle at 50% 18%, rgba(255, 228, 170, 0.32), rgba(0, 0, 0, 0.98));
    }
    .token-box{
      width: min(620px, 94vw);
      padding: 1.6rem 1.6rem 1.2rem;
      border-radius: 18px;
      background: radial-gradient(circle at 0% 0%, rgba(246, 211, 122, 0.22), rgba(0, 0, 0, 0.95));
      border: 1px solid rgba(246, 211, 122, 0.35);
      box-shadow: 0 0 28px rgba(0,0,0,0.92), 0 0 26px rgba(246,211,122,0.18);
      color: var(--gold-soft);
    }
    .token-title{
      text-align:center;
      font-size: 1.15rem;
      letter-spacing: 0.18em;
      text-indent: 0.18em;
      margin-bottom: 0.6rem;
      text-shadow: 0 0 14px rgba(246,211,122,0.55);
      color: rgba(246,211,122,0.92);
    }
    .token-hint{
      font-size: 0.9rem;
      line-height: 1.75;
      color: rgba(246,211,122,0.78);
      margin-bottom: 0.8rem;
      white-space: pre-line;
    }
    .token-row{ display:flex; align-items:center; gap: 0.5rem; margin-top: .5rem; flex-wrap: wrap; }
    .token-input{
      flex: 1 1 auto;
      width: 100%;
      padding: 0.55rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.5);
      background: rgba(0, 0, 0, 0.82);
      color: var(--gold);
      outline: none;
    }
    .token-input:focus{
      border-color: rgba(255, 238, 190, 0.9);
      box-shadow: 0 0 12px rgba(246, 211, 122, 0.65);
    }
    .token-eye{
      padding: 0.26rem 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.8);
      background: rgba(0,0,0,0.86);
      color: var(--gold);
      cursor: pointer;
      box-shadow: 0 0 8px rgba(0,0,0,0.65);
      white-space: nowrap;
    }
    .token-actions{
      margin-top: 0.95rem;
      display:flex;
      justify-content: flex-end;
      gap: 0.55rem;
      flex-wrap: wrap;
    }
    .token-btn{
      border: 1px solid rgba(246,211,122,0.72);
      background: radial-gradient(circle at 0% 0%, rgba(246,211,122,0.22), rgba(0,0,0,0.92));
      color: var(--gold);
      border-radius: 999px;
      padding: 0.42rem 1.05rem;
      cursor: pointer;
      letter-spacing: 0.12em;
      text-indent: 0.12em;
      box-shadow: 0 8px 16px rgba(0,0,0,0.75);
      transition: transform .15s ease, box-shadow .2s ease, background .2s ease;
      white-space: nowrap;
    }
    .token-btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(0,0,0,0.85);
      background: radial-gradient(circle at 0% 0%, rgba(255,244,208,0.28), rgba(0,0,0,0.92));
    }
    .token-btn.ghost{
      opacity: 0.85;
      border-color: rgba(246,211,122,0.45);
    }
    .token-msg{
      margin-top: 0.65rem;
      min-height: 1.2rem;
      font-size: 0.85rem;
      color: rgba(255, 200, 200, 0.95);
      text-align: left;
      white-space: pre-line;
    }
    .mini-pill{
      display:inline-block;
      padding: .2rem .6rem;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,0.35);
      background: rgba(0,0,0,0.55);
      color: rgba(246,211,122,0.85);
      font-size: .82rem;
      margin-left: .35rem;
      letter-spacing: .06em;
      text-indent: .06em;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      color: rgba(255, 240, 200, 0.96);
    }

    /* ==========================
       Login Overlay
       ========================== */
    .login-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 50% 18%, rgba(255, 228, 170, 0.35), rgba(0, 0, 0, 0.98));
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .login-box {
      width: min(380px, 90vw);
      padding: 2.4rem 2.6rem 2.2rem;
      border-radius: 18px;
      background: radial-gradient(circle at 0% 0%, rgba(246, 211, 122, 0.28), rgba(0, 0, 0, 0.94));
      border: 1px solid var(--panel-border);
      box-shadow: 0 0 24px rgba(0, 0, 0, 0.9), 0 0 32px rgba(246, 211, 122, 0.25);
      color: var(--gold-soft);
    }

    .login-title {
      text-align: center;
      font-size: 1.4rem;
      letter-spacing: 0.2em;
      text-indent: 0.2em;
      margin-bottom: 1.6rem;
      text-shadow: 0 0 8px rgba(246, 211, 122, 0.8), 0 0 18px rgba(246, 211, 122, 0.5);
    }

    .login-field { margin-bottom: 1rem; }

    .login-field label {
      display: block;
      font-size: 0.85rem;
      letter-spacing: 0.18em;
      text-indent: 0.18em;
      margin-bottom: 0.3rem;
      color: var(--gold-soft);
    }

    .login-field input {
      width: 100%;
      padding: 0.55rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.5);
      background: rgba(0, 0, 0, 0.8);
      color: var(--gold);
      outline: none;
    }

    .login-field input:focus {
      border-color: rgba(255, 238, 190, 0.9);
      box-shadow: 0 0 12px rgba(246, 211, 122, 0.7);
    }

    .login-user-wrapper{
      position: relative;
      display: flex;
      align-items: center;
      gap: 0.45rem;
    }
    .login-user-input{ flex: 1 1 auto; padding-right: 2.6rem; }
    .btn-user-drop{
      position: absolute;
      right: 0.25rem;
      top: 50%;
      transform: translateY(-50%);
      padding: 0.15rem 0.65rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.75);
      background: rgba(0,0,0,0.85);
      color: var(--gold);
      cursor: pointer;
      box-shadow: 0 0 8px rgba(0,0,0,0.6);
      font-size: 0.9rem;
      line-height: 1.6;
    }
    .btn-user-drop:hover{ background: rgba(246, 211, 122, 0.18); }

    .user-drop{
      position: absolute;
      left: 0;
      right: 0;
      top: calc(100% + 8px);
      border-radius: 16px;
      border: 1px solid rgba(246, 211, 122, 0.35);
      background: rgba(0,0,0,0.92);
      box-shadow: 0 14px 28px rgba(0,0,0,0.85), 0 0 18px rgba(246,211,122,0.18);
      max-height: 240px;
      overflow: auto;
      display: none;
      z-index: 20;
    }
    .user-drop button{
      width: 100%;
      text-align: left;
      padding: 0.65rem 0.9rem;
      background: transparent;
      border: none;
      color: var(--gold);
      cursor: pointer;
      letter-spacing: 0.08em;
    }
    .user-drop button:hover{ background: rgba(246, 211, 122, 0.10); }

    .login-pwd-wrapper {
      display: flex;
      align-items: center;
      gap: 0.45rem;
    }
    .login-pwd-input { flex: 1 1 auto; }
    .btn-eye-login {
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.8);
      background: rgba(0, 0, 0, 0.85);
      color: var(--gold);
      font-size: 0.8rem;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.6);
    }
    .btn-eye-login:hover { background: rgba(246, 211, 122, 0.2); }

    .login-error {
      min-height: 1.1rem;
      margin-bottom: 0.4rem;
      font-size: 0.8rem;
      color: #ffb3b3;
      text-align: center;
      white-space: pre-line;
    }

    .login-actions {
      margin-top: 0.8rem;
      display: flex;
      justify-content: center;
    }

    .btn-login {
      padding: 0.55rem 2.8rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.9);
      background: radial-gradient(circle at 0% 0%, rgba(246, 211, 122, 0.36), rgba(0, 0, 0, 0.98));
      color: var(--gold);
      font-size: 0.95rem;
      letter-spacing: 0.22em;
      text-indent: 0.22em;
      cursor: pointer;
      box-shadow: 0 10px 18px rgba(0, 0, 0, 0.95), 0 0 18px rgba(246, 211, 122, 0.5);
      transition: transform 0.15s ease-out, box-shadow 0.2s ease-out, background 0.2s ease-out, border-color 0.2s ease-out;
    }

    .btn-login:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 22px rgba(0, 0, 0, 0.98), 0 0 22px rgba(246, 211, 122, 0.8);
      border-color: #fff4cf;
      background: radial-gradient(circle at 0% 0%, rgba(255, 244, 208, 0.45), rgba(0, 0, 0, 0.97));
    }

    /* ==========================
       Hero
       ========================== */
    .hero {
      position: relative;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      color: var(--gold);
    }

    .hero::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 50% 12%,
          rgba(255, 237, 180, 0.92) 0,
          rgba(255, 237, 180, 0.42) 18%,
          rgba(255, 237, 180, 0.10) 40%,
          rgba(255, 237, 180, 0.00) 60%),
        radial-gradient(ellipse at 50% 76%,
          rgba(255, 250, 240, 0.22) 0,
          rgba(255, 250, 240, 0.10) 28%,
          rgba(255, 250, 240, 0.00) 62%),
        radial-gradient(ellipse at 50% 86%,
          rgba(255, 220, 170, 0.28) 0,
          rgba(255, 220, 170, 0.10) 26%,
          rgba(255, 220, 170, 0.00) 60%),
        linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0.84) 0%,
          rgba(0, 0, 0, 0.58) 30%,
          rgba(0, 0, 0, 0.42) 56%,
          rgba(0, 0, 0, 0.55) 100%);
      z-index: -6;
    }

    .hero::after {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 50% 44%,
          rgba(246, 211, 122, 0.12) 0,
          rgba(246, 211, 122, 0.06) 26%,
          rgba(0,0,0,0.00) 52%),
        radial-gradient(circle at 34% 60%,
          rgba(246, 211, 122, 0.10) 0,
          rgba(0,0,0,0.00) 50%),
        radial-gradient(circle at 66% 60%,
          rgba(246, 211, 122, 0.10) 0,
          rgba(0,0,0,0.00) 50%),
        radial-gradient(circle at 50% 60%,
          rgba(0,0,0,0.00) 0,
          rgba(0,0,0,0.22) 52%,
          rgba(0,0,0,0.58) 100%);
      z-index: -5;
      pointer-events: none;
    }

    .hero-inner {
      position: relative;
      width: 100%;
      max-width: 1400px;
      height: 100vh;
      margin: 0 auto;
      padding: clamp(1.2rem, 2vw, 1.8rem);
      isolation: isolate;
    }

    /* âœ… ä½ è¦æ±‚ï¼šä¸­é–“ä¸è¦æœ‰ã€Œé‚Šæ¡†æ¡†ä½æ•´å¡Šã€ => ç§»é™¤å¤–æ¡† borderï¼Œæ”¹æˆæ•´é«”èåˆçš„æŸ”å…‰ */
    .hero-inner::after {
      content: "";
      position: absolute;
      inset: var(--frame-inset);
      border-radius: var(--frame-radius);
      background:
        radial-gradient(circle at 50% 18%, rgba(255, 244, 210, 0.06), rgba(255, 244, 210, 0.00) 58%),
        radial-gradient(ellipse at 50% 82%, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.00) 62%);
      border: none; /* âœ… ä¸è¦é‚Šæ¡† */
      box-shadow:
        0 0 26px rgba(0,0,0,0.50),
        0 0 22px rgba(246, 211, 122, 0.08);
      z-index: -4;
      pointer-events: none;
    }

    .lotus-stage{
      position: absolute;
      top: var(--stage-top);
      bottom: var(--frame-inset);
      left: var(--stage-inset-x);
      right: var(--stage-inset-x);
      border-radius: calc(var(--frame-radius) - 6px);
      z-index: -3;
      pointer-events: none;
    }

    /* âœ… ä¸­é–“åœ–å¡Šè¦ã€Œæœ‰å€å¡Šæ„Ÿã€ä½†ä¸è¦ç¡¬é‚Šæ¡†ï¼šç”¨æŸ”å…‰ç»ç’ƒåº• */
    .center-panel{
      position: absolute;
      left: 50%;
      top: 63%;
      transform: translate(-50%, -50%);
      width: min(760px, 74vw);
      height: min(520px, 54vh);
      border-radius: 26px;
      background:
        radial-gradient(circle at 50% 35%, rgba(246,211,122,0.12), rgba(0,0,0,0.00) 60%),
        linear-gradient(180deg, rgba(255,255,255,0.05), rgba(0,0,0,0.00));
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,0.04),
        0 18px 42px rgba(0,0,0,0.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: -2;
      pointer-events: none;
    }

    .lotus-sprite{
      position: absolute;
      left: 50%;
      top: 63%;
      transform: translate(-50%, -50%);
      width: min(560px, 52vw);
      height: min(380px, 34vw);
      background: url("é¦–é åœ–ç‰‡.png") center 82% / auto 240% no-repeat;
      opacity: 0.98;
      filter: saturate(0.88) contrast(1.05) brightness(1.06) drop-shadow(0 22px 34px rgba(0,0,0,0.55));
      -webkit-mask-image: radial-gradient(ellipse at 50% 62%,
        rgba(0,0,0,1) 0%,
        rgba(0,0,0,1) 42%,
        rgba(0,0,0,0.0) 78%);
      mask-image: radial-gradient(ellipse at 50% 62%,
        rgba(0,0,0,1) 0%,
        rgba(0,0,0,1) 42%,
        rgba(0,0,0,0.0) 78%);
      z-index: -1;
      pointer-events: none;
    }

    /* user bar */
    .user-bar {
      position: fixed;
      top: 0.8rem;
      left: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      z-index: 10;
    }
    .user-pill {
      padding: 0.30rem 1.05rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.55);
      background: radial-gradient(circle at 0% 0%, rgba(246, 211, 122, 0.18), rgba(0, 0, 0, 0.88));
      font-size: 0.82rem;
      letter-spacing: 0.10em;
      text-indent: 0.10em;
      opacity: 0.88;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.75), 0 0 10px rgba(246, 211, 122, 0.18);
    }
    .btn-switch {
      padding: 0.26rem 1.00rem;
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.62);
      background: radial-gradient(circle at 0% 0%, rgba(246, 211, 122, 0.22), rgba(0, 0, 0, 0.92));
      color: var(--gold);
      font-size: 0.80rem;
      letter-spacing: 0.10em;
      text-indent: 0.10em;
      cursor: pointer;
      opacity: 0.86;
      box-shadow: 0 4px 9px rgba(0,0,0,0.82), 0 0 10px rgba(246, 211, 122, 0.20);
      transition: transform 0.15s ease-out, box-shadow 0.2s ease-out, background 0.2s ease-out, opacity 0.2s ease-out;
    }
    .btn-switch:hover {
      transform: translateY(-1px);
      opacity: 0.96;
      background: radial-gradient(circle at 0% 0%, rgba(255, 244, 208, 0.30), rgba(0, 0, 0, 0.93));
      box-shadow: 0 7px 14px rgba(0, 0, 0, 0.90), 0 0 14px rgba(246, 211, 122, 0.30);
    }

    .site-title-wrapper {
      position: fixed;
      top: 0.70rem;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      letter-spacing: 0.38em;
      text-indent: 0.38em;
      z-index: 9;
      pointer-events: none;
    }
    .site-title {
      font-family: "DFKai-SB","æ¨™æ¥·é«”","BiauKai","KaiTi","STKaiti","Kaiti TC","Noto Serif TC",serif;
      font-size: clamp(2.4rem, 4.2vw, 3.8rem);
      font-weight: 700;
      -webkit-text-stroke: 0.7px rgba(255, 244, 208, 0.40);
      text-shadow:
        0 1px 0 rgba(0,0,0,0.65),
        0 2px 0 rgba(0,0,0,0.55),
        0 10px 22px rgba(0,0,0,0.88),
        0 0 18px rgba(246, 211, 122, 0.92),
        0 0 36px rgba(246, 211, 122, 0.72),
        0 0 58px rgba(246, 211, 122, 0.46);
      filter: drop-shadow(0 10px 18px rgba(0,0,0,0.85));
    }

    .hero-text {
      position: absolute;
      color: var(--gold);
      text-shadow: 0 0 10px rgba(246, 211, 122, 0.9), 0 0 24px rgba(246, 211, 122, 0.7), 0 0 40px rgba(246, 211, 122, 0.45);
      white-space: nowrap;
      z-index: 0;
    }

    .hero-title {
      left: 50%;
      top: 41.0%;
      transform: translate(-50%, -50%);
      width: min(820px, 78vw);
      height: clamp(160px, 20vh, 220px);
      position: absolute;
      z-index: 2;
      pointer-events: none;
    }
    .hero-title span{
      position: absolute;
      font-size: clamp(2.0rem, 3.0vw, 2.6rem);
      line-height: 1;
      letter-spacing: 0.06em;
      text-indent: 0.06em;
      transform-origin: center;
    }
    .hero-title span:nth-child(1){ left: 50%; top: 8%;  transform: translate(-50%, -50%) rotate(0deg); }
    .hero-title span:nth-child(2){ left: 28%; top: 52%; transform: translate(-50%, -50%) rotate(-6deg); }
    .hero-title span:nth-child(3){ left: 72%; top: 52%; transform: translate(-50%, -50%) rotate(6deg); }

    .hero-left,
    .hero-right {
      top: 63%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: clamp(1.7rem, 2.4vw, 2.1rem);
    }
    .hero-left  { left:  var(--side-text-offset); }
    .hero-right { right: var(--side-text-offset); }
    .hero-left span,
    .hero-right span { line-height: 1.3; letter-spacing: 0.12em; }
    .char-space { margin-top: 0.8em; margin-bottom: 0.3em; }

    .hero-bottom {
      bottom: 10%;
      left: 50%;
      transform: translateX(-50%);
      font-size: clamp(1.6rem, 2.2vw, 2rem);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.9em;
    }
    .hero-bottom span { letter-spacing: 0.16em; }

    .nav-area { position: absolute; inset: 0; }

    .nav-btn {
      position: absolute;
      width: var(--btn-w);
      height: clamp(78px, 9.5vh, 112px);
      border-radius: 999px;
      border: 1px solid rgba(246, 211, 122, 0.92);
      background:
        linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.04)),
        radial-gradient(circle at 0% 0%, rgba(246, 211, 122, 0.28), rgba(0,0,0,0.82));
      color: var(--gold);
      text-decoration: none;
      cursor: pointer;
      box-shadow: 0 14px 26px rgba(0,0,0,0.95), 0 0 26px rgba(246, 211, 122, 0.40);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 clamp(1.6rem, 2.6vw, 3.0rem);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, border-color 0.2s ease-out, background 0.25s ease-out, opacity 0.2s ease-out;
      z-index: 1;
    }

    .nav-btn span{
      position: relative;
      z-index: 1;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      overflow: hidden;
      text-align: center;
      line-height: 1.22;
      font-size: clamp(1.02rem, 1.15vw, 1.22rem);
      letter-spacing: clamp(0.10em, 0.20vw, 0.18em);
      text-indent: 0.12em;
      word-break: keep-all;
    }

    .nav-btn::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 15% 0%, rgba(255,255,255,0.50), transparent 55%);
      opacity: 0;
      transition: opacity 0.25s ease-out;
      z-index: 0;
    }

    .nav-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 18px 34px rgba(0,0,0,0.95), 0 0 34px rgba(246, 211, 122, 0.75);
      border-color: rgba(255, 235, 180, 0.98);
      background:
        linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.06)),
        radial-gradient(circle at 0% 0%, rgba(255, 240, 200, 0.32), rgba(0,0,0,0.86));
    }
    .nav-btn:hover::before { opacity: 1; }

    .nav-btn:active {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.9), 0 0 22px rgba(246, 211, 122, 0.7);
    }

    #systemBtn.nav-right.bottom { top: auto; }

    @media (max-width: 900px) {
      :root{ --stage-top: clamp(4.6rem, 12vh, 6.4rem); }

      .hero-inner {
        width: 100vw;
        height: auto;
        min-height: 100vh;
        max-width: none;
        padding: 1.2rem 0.75rem 2.2rem;
      }

      .hero-title{
        top: 40.2%;
        width: min(900px, 92vw);
        height: 170px;
      }
      .hero-title span{ font-size: 2.0rem; }
      .hero-title span:nth-child(1){ left: 50%; top: 10%; transform: translate(-50%,-50%) rotate(0deg); }
      .hero-title span:nth-child(2){ left: 28%; top: 54%; transform: translate(-50%,-50%) rotate(-6deg); }
      .hero-title span:nth-child(3){ left: 72%; top: 54%; transform: translate(-50%,-50%) rotate(6deg); }

      .hero-left { left: 24%; font-size: 1.5rem; }
      .hero-right { right: 24%; font-size: 1.5rem; }
      .hero-bottom { bottom: 8%; font-size: 1.5rem; }

      .lotus-stage{ left: clamp(0.8rem, 3vw, 1.1rem); right: clamp(0.8rem, 3vw, 1.1rem); }

      .center-panel{
        width: min(860px, 92vw);
        height: min(560px, 54vh);
        top: 62%;
        border-radius: 22px;
      }

      .lotus-sprite{
        width: min(520px, 86vw);
        height: min(360px, 58vw);
        top: 62%;
        background-position: center 84%;
        background-size: auto 260%;
      }

      .nav-area {
        position: static;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.9rem;
        width: 100%;
        margin: min(56vh, 430px) auto 0.8rem;
        padding: 0 0.6rem 0;
      }

      .nav-btn {
        position: relative;
        flex: 0 1 calc(50% - 0.9rem);
        max-width: 360px;
        width: auto;
        height: 78px;
        padding: 0 1.2rem;
      }

      #systemBtn { position: relative; right: auto; bottom: auto; top: auto; left: auto; }
    }

    @media (min-width: 901px) {
      .nav-btn { max-width: calc(var(--side-text-offset) - var(--side-btn-offset) - 3vw); }
    }
  </style>
</head>

<body class="locked">
  <!-- Token overlay -->
  <div class="token-overlay" id="tokenOverlay" aria-hidden="true">
    <div class="token-box">
      <div class="token-title">Dropbox Token è¨­å®šï¼ˆApp folderï¼‰</div>
      <div class="token-hint" id="tokenHint">
â‘  ä½ çš„ Dropbox å¸³è™Ÿï¼š<b>tasun_8@hotmail.com</b>
â‘¡ ç”¢ç”Ÿ Tokenï¼šConsole â†’ Permissions å‹¾ scopes â†’ Submit â†’ Settings é‡æ–°ç”¢ç”Ÿ Access Token
â‘¢ æœ¬ç³»çµ±æœƒå¯«å…¥ï¼š<b class="mono">/Tasun/æ¬Šé™</b>ï¼ˆApp folder å…§ï¼‰ï¼Œç¶²ç«™çœ‹åˆ°ç‚ºï¼š/Apps/&lt;Appå&gt;/Tasun/æ¬Šé™
      </div>

      <div style="margin-top:.2rem;">
        <div style="font-size:.86rem; color:rgba(246,211,122,0.8); margin-bottom:.35rem;">
          Apps å…§ã€ŒApp è³‡æ–™å¤¾åã€<span class="mini-pill">ä¾‹å¦‚ï¼šwutasun</span>
        </div>
        <input class="token-input" id="appNameInput" type="text" placeholder="ä¾‹å¦‚ï¼šwutasun" />
      </div>

      <div style="margin-top:.65rem;">
        <div style="font-size:.86rem; color:rgba(246,211,122,0.8); margin-bottom:.35rem;">
          App keyï¼ˆç”¨ä¾†ç›´æ¥é–‹ Permissions / Settingsï¼‰<span class="mini-pill">ä¾‹å¦‚ï¼ša5pm08kyb0bybdt</span>
        </div>
        <div class="token-row">
          <input class="token-input" id="appKeyInput" type="text" placeholder="è²¼ä¸Š App keyï¼ˆinfo/&lt;é€™ä¸²&gt;#settingsï¼‰" />
          <button class="token-btn ghost" id="btnOpenPerm" type="button">é–‹ Permissions</button>
          <button class="token-btn ghost" id="btnOpenSet" type="button">é–‹ Settings</button>
        </div>
      </div>

      <div style="margin-top:.7rem; font-size:.86rem; color:rgba(246,211,122,0.8); margin-bottom:.35rem;">
        Access Tokenï¼ˆä»¥ sl. é–‹é ­ï¼‰
      </div>
      <div class="token-row">
        <input class="token-input" id="tokenInput" type="password" placeholder="è²¼ä¸Š Access Tokenï¼ˆsl. é–‹é ­ï¼‰" />
        <button class="token-eye" id="tokenEyeBtn" type="button">ğŸ‘</button>
      </div>

      <div class="token-msg" id="tokenMsg"></div>

      <div class="token-actions">
        <button class="token-btn ghost" id="tokenGuideBtn" type="button">ä¸€æ­¥ä¸€æ­¥å°è¦½ï¼ˆè‡ªå‹•é–‹é€£çµï¼‰</button>
        <button class="token-btn ghost" id="tokenSkipBtn" type="button">ç¨å¾Œï¼ˆåªç”¨æœ¬æ©Ÿï¼‰</button>
        <button class="token-btn" id="tokenSaveBtn" type="button">å„²å­˜ä¸¦æ¸¬è©¦</button>
      </div>
    </div>
  </div>

  <!-- Login overlay -->
  <div class="login-overlay" id="loginOverlay" aria-hidden="false">
    <div class="login-box">
      <div class="login-title">Tasun è³‡æ–™ Â· ç™»å…¥</div>
      <form id="loginForm">
        <div class="login-field">
          <label for="usernameInput">ä½¿ç”¨è€…åç¨±ï¼ˆå¯è¼¸å…¥ / å¯é¸æ“‡ï¼‰</label>

          <div class="login-user-wrapper">
            <input id="usernameInput" name="username" class="login-user-input"
              type="text" list="usernameList" autocomplete="username"
              placeholder="è¼¸å…¥æˆ–æŒ‰ â–¼ é¸æ“‡" />
            <button type="button" class="btn-user-drop" id="btnUserDrop">â–¼</button>
            <datalist id="usernameList"></datalist>
            <div class="user-drop" id="userDrop" aria-hidden="true"></div>
          </div>
        </div>

        <div class="login-field">
          <label for="password">å¯†ç¢¼</label>
          <div class="login-pwd-wrapper">
            <input id="password" name="password" type="password" autocomplete="current-password" class="login-pwd-input" />
            <button type="button" class="btn-eye-login" id="btnTogglePwd">ğŸ‘</button>
          </div>
        </div>

        <div class="login-error" id="loginError"></div>
        <div class="login-actions">
          <button type="submit" class="btn-login">ç™»å…¥</button>
        </div>
      </form>
    </div>
  </div>

  <main class="hero">
    <div class="hero-inner">
      <div class="lotus-stage" aria-hidden="true"></div>
      <div class="center-panel" aria-hidden="true"></div>
      <div class="lotus-sprite" aria-hidden="true"></div>

      <div class="user-bar">
        <div class="user-pill" id="userInfo">ç›®å‰ä½¿ç”¨è€…ï¼šæœªç™»å…¥</div>
        <button class="btn-switch" id="btnSwitchUser">åˆ‡æ›å¸³è™Ÿ</button>
      </div>

      <div class="site-title-wrapper">
        <div class="site-title">Tasun è³‡æ–™</div>
      </div>

      <div class="hero-text hero-title">
        <span>ç©º</span><span>ç„¡</span><span>æ˜</span>
      </div>

      <div class="hero-text hero-left">
        <span>ç©º</span><span>éˆ</span><span class="char-space"></span><span>ç„¡</span><span>æˆ‘</span>
      </div>

      <div class="hero-text hero-right">
        <span>æ¸…</span><span>æ˜</span><span class="char-space"></span><span>å¯§</span><span>éœ</span>
      </div>

      <div class="hero-text hero-bottom">
        <span>ç©º</span><span>ç„¡</span><span>æ˜</span><span>éœ</span>
      </div>

      <div class="nav-area" id="navArea"></div>

      <a class="nav-btn nav-right bottom" id="systemBtn" href="æ¬Šé™è¡¨.html">
        <span>ç³»çµ± / æ¬Šé™</span>
      </a>
    </div>
  </main>

  <script>
    // ==========================
    // keys
    // ==========================
    const AUTH_KEY    = "tasunAuthTable_v1";
    const NAV_KEY     = "tasunNavButtons_v1";
    const CURRENT_KEY = "tasunCurrentUser_v1"; // âœ… session only

    const DBX_TOKEN_KEY   = "tasunDbxToken_v1";
    const DBX_FOLDER_KEY  = "tasunDbxFolder_v1";
    const DBX_APPNAME_KEY = "tasunDbxAppName_v1";
    const DBX_APPKEY_KEY  = "tasunDbxAppKey_v1";

    const DEFAULT_DBX_FOLDER = "/Tasun/æ¬Šé™";
    const DEFAULT_APP_NAME = "wutasun";
    const EXPECT_EMAIL = "tasun_8@hotmail.com";

    // âœ… ä¸æ”¹ session è¦å‰‡ï¼Œä½†å…¼å®¹æ–°åˆ†é ï¼šBroadcastChannel
    const AUTH_BRIDGE_CH = "tasunAuthBridge_v1";
    const TAB_ID_KEY = "tasunTabId_v1";
    const TAB_ID = (() => {
      let v = sessionStorage.getItem(TAB_ID_KEY);
      if(!v){
        v = "tab_" + Date.now() + "_" + Math.random().toString(16).slice(2);
        sessionStorage.setItem(TAB_ID_KEY, v);
      }
      return v;
    })();
    let bc = null;
    let bcReady = false;

    // ==========================
    // UI refs
    // ==========================
    const tokenOverlay = document.getElementById("tokenOverlay");
    const tokenInput   = document.getElementById("tokenInput");
    const tokenSaveBtn = document.getElementById("tokenSaveBtn");
    const tokenSkipBtn = document.getElementById("tokenSkipBtn");
    const tokenEyeBtn  = document.getElementById("tokenEyeBtn");
    const tokenGuideBtn= document.getElementById("tokenGuideBtn");
    const tokenMsg     = document.getElementById("tokenMsg");
    const appNameInput = document.getElementById("appNameInput");

    const appKeyInput  = document.getElementById("appKeyInput");
    const btnOpenPerm  = document.getElementById("btnOpenPerm");
    const btnOpenSet   = document.getElementById("btnOpenSet");

    const loginOverlay = document.getElementById("loginOverlay");
    const loginForm    = document.getElementById("loginForm");
    const loginError   = document.getElementById("loginError");
    const userInfo     = document.getElementById("userInfo");
    const btnSwitch    = document.getElementById("btnSwitchUser");
    const btnTogglePwd = document.getElementById("btnTogglePwd");
    const navArea      = document.getElementById("navArea");
    const systemBtn    = document.getElementById("systemBtn");

    const usernameInput = document.getElementById("usernameInput");
    const usernameList  = document.getElementById("usernameList");
    const btnUserDrop   = document.getElementById("btnUserDrop");
    const userDrop      = document.getElementById("userDrop");

    // ==========================
    // helpers
    // ==========================
    function mapRole(v){
      const s = String(v ?? "").trim().toLowerCase();
      if(!s) return "";
      if(s==="admin") return "admin";
      if(s==="write" || s==="edit") return "write";
      if(s==="read"  || s==="view") return "read";
      if(s==="0") return "admin";
      if(s==="1") return "write";
      if(s==="2") return "read";
      return s;
    }
    function safeJsonParse(s, fallback){
      try{ return JSON.parse(s); }catch(e){ return fallback; }
    }

    // âœ… session current user
    function getCurrentUser(){
      const cu = safeJsonParse(sessionStorage.getItem(CURRENT_KEY) || "null", null);
      if(!cu || typeof cu !== "object") return null;
      const username = String(cu.username ?? "").trim();
      if(!username) return null;
      const role = mapRole(cu.role ?? cu.level) || "read";
      const out = { username, role, level: role };
      sessionStorage.setItem(CURRENT_KEY, JSON.stringify(out));
      return out;
    }

    function bcPost(msg){
      if(!bcReady || !bc) return;
      try{ bc.postMessage({ ...msg, _from: TAB_ID, _ts: Date.now() }); }catch(e){}
    }

    function setCurrentUser(u, { broadcast=true } = {}){
      const username = String(u.username||"").trim();
      const role = mapRole(u.level ?? u.role) || "read";
      const obj = { username, role, level: role };
      sessionStorage.setItem(CURRENT_KEY, JSON.stringify(obj));
      if(broadcast) bcPost({ type:"login", user: obj });
    }

    function clearCurrentUser({ broadcast=true } = {}){
      sessionStorage.removeItem(CURRENT_KEY);
      try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}
      if(broadcast) bcPost({ type:"logout" });
    }

    // Dropbox token
    function getDbxToken(){ return String(localStorage.getItem(DBX_TOKEN_KEY) || "").trim(); }
    function setDbxToken(t){ localStorage.setItem(DBX_TOKEN_KEY, String(t || "").trim()); }
    function dbxEnabled(){ const t = getDbxToken(); return !!(t && t.length > 20); }
    function dbxAuthHeader(){ return "Bearer " + getDbxToken(); }

    function getDbxFolder(){
      return String(localStorage.getItem(DBX_FOLDER_KEY) || DEFAULT_DBX_FOLDER).trim() || DEFAULT_DBX_FOLDER;
    }
    function getDbxAppName(){
      return String(localStorage.getItem(DBX_APPNAME_KEY) || DEFAULT_APP_NAME).trim() || DEFAULT_APP_NAME;
    }
    function setDbxAppName(n){
      const v = String(n||"").trim() || DEFAULT_APP_NAME;
      localStorage.setItem(DBX_APPNAME_KEY, v);
    }

    function getDbxAppKey(){
      return String(localStorage.getItem(DBX_APPKEY_KEY) || "").trim();
    }
    function setDbxAppKey(k){
      localStorage.setItem(DBX_APPKEY_KEY, String(k||"").trim());
    }

    // âœ… FIXï¼šä»»ä½•éœ€è¦ç”¨ App key å‰ï¼Œéƒ½å…ˆ sync input â†’ localStorage
    function syncAppKeyFromInput(){
      const v = String(appKeyInput?.value || "").trim();
      if(v) setDbxAppKey(v);
      return v || getDbxAppKey();
    }

    function dbxPathAuth(){ return `${getDbxFolder()}/tasunAuthTable_v1.json`; }
    function dbxPathNav(){  return `${getDbxFolder()}/tasunNavButtons_v1.json`; }
    function dbxPathMeta(){ return `${getDbxFolder()}/tasunCloudMeta_v1.json`; }

    function dropboxWebFolderUrl(){
      const appName = encodeURIComponent(getDbxAppName());
      return `https://www.dropbox.com/home/Apps/${appName}${getDbxFolder()}`;
    }

    function getConsoleBaseUrl(){
      const k = syncAppKeyFromInput();
      return k ? `https://www.dropbox.com/developers/apps/info/${encodeURIComponent(k)}` : "";
    }
    function getConsolePermUrl(){ const b = getConsoleBaseUrl(); return b ? (b + "#permissions") : ""; }
    function getConsoleSetUrl(){  const b = getConsoleBaseUrl(); return b ? (b + "#settings") : ""; }

    function openConsoleTab(url, label){
      syncAppKeyFromInput();
      if(!url){
        alert(`å°šæœªå¡« App keyï¼Œç„¡æ³•ç›´æ¥é–‹ ${label}ã€‚\n\nè«‹åœ¨æœ¬è¦–çª—ã€ŒApp keyã€è²¼ä¸Šï¼šç¶²å€ info/<App key>#settings é‚£ä¸²ã€‚`);
        return false;
      }
      const w = window.open(url, "_blank", "noopener");
      if(!w){
        alert("ç€è¦½å™¨å°é–å½ˆå‡ºè¦–çª—ã€‚\nè«‹å…è¨±æ­¤ç¶²ç«™é–‹æ–°åˆ†é å¾Œå†è©¦ä¸€æ¬¡ã€‚");
        return false;
      }
      return true;
    }

    function jsonAscii(obj){
      return JSON.stringify(obj).replace(/[^\x00-\x7F]/g, (c)=>{
        const code = c.charCodeAt(0).toString(16).padStart(4,"0");
        return "\\u" + code;
      });
    }

    async function fetchWithTimeout(url, options={}, timeoutMs=15000){
      const ctrl = new AbortController();
      const id = setTimeout(()=> ctrl.abort(), timeoutMs);
      try{
        const res = await fetch(url, { ...options, signal: ctrl.signal });
        return res;
      } finally {
        clearTimeout(id);
      }
    }

    // ==========================
    // Token overlay
    // ==========================
    function showTokenOverlay(){
      tokenOverlay.style.display = "flex";
      tokenOverlay.setAttribute("aria-hidden","false");
      appNameInput.value = getDbxAppName();
      appKeyInput.value = getDbxAppKey();
      tokenInput.value = getDbxToken();
      tokenMsg.textContent = `Dropbox ç¶²ç«™ä½ç½®ï¼ˆApp folderï¼‰ï¼š\n${dropboxWebFolderUrl()}`;
      setTimeout(()=> (appNameInput || tokenInput).focus(), 60);
    }
    function hideTokenOverlay(){
      tokenOverlay.style.display = "none";
      tokenOverlay.setAttribute("aria-hidden","true");
      tokenMsg.textContent = "";
    }

    tokenEyeBtn?.addEventListener("click", ()=>{
      tokenInput.type = (tokenInput.type === "password") ? "text" : "password";
    });

    tokenSkipBtn?.addEventListener("click", ()=> hideTokenOverlay());

    btnOpenPerm?.addEventListener("click", ()=>{
      syncAppKeyFromInput();
      openConsoleTab(getConsolePermUrl(), "Permissions");
    });
    btnOpenSet?.addEventListener("click", ()=>{
      syncAppKeyFromInput();
      openConsoleTab(getConsoleSetUrl(), "Settings");
    });

    function guideToConsoleStrong(){
      const kNow = syncAppKeyFromInput();
      alert("æ¥ä¸‹ä¾†é€²å…¥ã€Œä¸€æ­¥ä¸€æ­¥å°è¦½ã€ã€‚\næœƒå˜—è©¦è‡ªå‹•é–‹ Permissions / Settingsã€‚\næŒ‰ã€Œç¢ºå®šã€é–‹å§‹ã€‚");

      if(!kNow){
        alert("ä½ ç›®å‰é‚„æ²’å¡« App keyï¼Œå› æ­¤ç„¡æ³•ç›´é” Permissions/Settingsã€‚\næˆ‘å…ˆå¹«ä½ é–‹ Apps åˆ—è¡¨ï¼Œä½ é»é€² App å¾Œï¼Œçœ‹ç¶²å€ info/<é€™ä¸²>#settingsï¼ŒæŠŠ <é€™ä¸²> è²¼å›ä¾†ã€‚");
        window.open("https://www.dropbox.com/developers/apps", "_blank", "noopener");
        alert("æ­¥é©Ÿï¼š\n1) Apps åˆ—è¡¨ â†’ é»ä½ çš„ App\n2) ç¶²å€åƒï¼š.../apps/info/ã€a5pm08...ã€#settings\n3) è¤‡è£½ã€a5pm08...ã€è²¼å›æœ¬è¦–çª— App key\n4) å†æŒ‰ä¸€æ¬¡ã€Œä¸€æ­¥ä¸€æ­¥å°è¦½ï¼ˆè‡ªå‹•é–‹é€£çµï¼‰ã€");
        return;
      }

      const okPerm = openConsoleTab(getConsolePermUrl(), "Permissions");
      if(okPerm){
        alert("æ­¥é©Ÿ 1ï¼ˆPermissionsï¼‰ï¼šè«‹å‹¾ scopesï¼ˆè‡³å°‘ï¼‰ï¼š\n- files.content.write\n- files.content.read\n- files.metadata.read\nï¼ˆå»ºè­°ä¹Ÿå‹¾ï¼šaccount_info.readï¼‰\nå‹¾å¥½å¾ŒæŒ‰ Submitã€‚");
      }

      const okSet = openConsoleTab(getConsoleSetUrl(), "Settings");
      if(okSet){
        alert("æ­¥é©Ÿ 2ï¼ˆSettingsï¼‰ï¼šè«‹é‡æ–°ç”¢ç”Ÿ Access Tokenï¼ˆGenerateï¼‰ã€‚\nâš ï¸ å‹¾å®Œ scope ä¸€å®šè¦æ–° token æ‰æœƒç”Ÿæ•ˆã€‚\nè¤‡è£½æ–° token â†’ å›æœ¬é  â†’ æŒ‰ã€Œå„²å­˜ä¸¦æ¸¬è©¦ã€ã€‚");
      }
    }
    tokenGuideBtn?.addEventListener("click", guideToConsoleStrong);

    async function testTokenAndGetEmail(){
      if(!dbxEnabled()) return { ok:false, status:0, msg:"âŒ Token æœªè¨­å®š", email:"" };
      try{
        const res = await fetchWithTimeout("https://api.dropboxapi.com/2/users/get_current_account", {
          method:"POST",
          cache:"no-store",
          headers:{ "Authorization": dbxAuthHeader(), "Content-Type":"application/json" },
          body: "null"
        }, 15000);

        const txt = await res.text();
        const json = safeJsonParse(txt, null);

        if(!res.ok){
          return { ok:false, status:res.status, msg:`âŒ Token ç„¡æ•ˆæˆ–éæœŸï¼ˆHTTP ${res.status}ï¼‰\n${txt}`, email:"" };
        }
        const email = String(json && json.email ? json.email : "");
        return { ok:true, status:200, msg:`âœ… Token OK\nå°æ‡‰å¸³è™Ÿï¼š${email || "(æœªå›å‚³ email)"}`, email };
      }catch(e){
        return { ok:false, status:0, msg:"âŒ Token æ¸¬è©¦å¤±æ•—ï¼ˆå¯èƒ½ç¶²è·¯æˆ–è¢«é˜»æ“‹/é€¾æ™‚ï¼‰", email:"" };
      }
    }

    // âœ… æ›´ç©©å¥çš„ ensureFolderï¼šè§£æ JSON / å¸¸è¦‹ already-exists è¦–ç‚ºæˆåŠŸ
    async function ensureFolder(){
      try{
        const res = await fetchWithTimeout("https://api.dropboxapi.com/2/files/create_folder_v2", {
          method:"POST",
          cache:"no-store",
          headers:{ "Authorization": dbxAuthHeader(), "Content-Type":"application/json" },
          body: JSON.stringify({ path: getDbxFolder(), autorename:false })
        }, 15000);

        const txt = await res.text();
        if(res.ok) return { ok:true, msg:"âœ… è³‡æ–™å¤¾å·²å»ºç«‹/ç¢ºèª" };

        const j = safeJsonParse(txt, null);
        const summary = String((j && (j.error_summary || j.error && j.error['.tag'])) || "").toLowerCase();

        if(res.status === 409){
          // å¸¸è¦‹ï¼šå·²å­˜åœ¨ / conflict
          if(summary.includes("path/conflict") || summary.includes("conflict") || (txt||"").toLowerCase().includes("conflict")){
            return { ok:true, msg:"âœ… è³‡æ–™å¤¾å·²å­˜åœ¨" };
          }
        }

        // missing_scope
        if((txt||"").toLowerCase().includes("missing_scope") || (txt||"").toLowerCase().includes("files.content.write")){
          return { ok:false, msg:`âŒ scopes ä¸è¶³ï¼ˆéœ€è¦ files.content.writeï¼‰\n${txt}` };
        }

        return { ok:false, msg:`âŒ å»ºç«‹è³‡æ–™å¤¾å¤±æ•—ï¼ˆHTTP ${res.status}ï¼‰\n${txt}` };
      }catch(e){
        return { ok:false, msg:"âŒ å»ºç«‹è³‡æ–™å¤¾å¤±æ•—ï¼ˆé€¾æ™‚/ç¶²è·¯ï¼‰" };
      }
    }

    tokenSaveBtn?.addEventListener("click", async ()=>{
      const appName = String(appNameInput.value||"").trim() || DEFAULT_APP_NAME;
      setDbxAppName(appName);
      syncAppKeyFromInput();

      const t = String(tokenInput.value || "").trim();
      if(!t){
        tokenMsg.textContent = "è«‹å…ˆè²¼ä¸Š Access Tokenã€‚";
        return;
      }
      setDbxToken(t);

      tokenMsg.textContent = "æ­£åœ¨æ¸¬è©¦ Tokenâ€¦";
      const chk = await testTokenAndGetEmail();
      if(!chk.ok){
        tokenMsg.textContent = chk.msg + "\n\nè‹¥æ˜¯ scopes ä¸è¶³ï¼ŒæŒ‰ã€Œä¸€æ­¥ä¸€æ­¥å°è¦½ï¼ˆè‡ªå‹•é–‹é€£çµï¼‰ã€ã€‚";
        return;
      }

      let emailHint = "";
      if(chk.email && chk.email.toLowerCase() !== EXPECT_EMAIL.toLowerCase()){
        emailHint = `\nâš ï¸ é€™å€‹ token å°æ‡‰ emailï¼š${chk.email}\nä½ æœŸæœ›ï¼š${EXPECT_EMAIL}\nï¼ˆå¯èƒ½åœ¨ä¸åŒ Dropbox å¸³è™Ÿç”¢ç”Ÿ tokenï¼‰`;
      }else if(chk.email){
        emailHint = `\nâœ… token å°æ‡‰ emailï¼š${chk.email}`;
      }

      tokenMsg.textContent = chk.msg + emailHint + "\n\næ­£åœ¨æ¸¬è©¦å»ºç«‹è³‡æ–™å¤¾â€¦";
      const folderChk = await ensureFolder();
      if(!folderChk.ok){
        tokenMsg.textContent =
          chk.msg + emailHint +
          "\n\n" + folderChk.msg +
          "\n\nâœ… è‹¥åŒ…å« missing_scope/files.content.writeï¼šè«‹åˆ° Console å‹¾æ¬Šé™ä¸¦é‡æ–°ç”¢ç”Ÿæ–° tokenã€‚";
        const go = confirm("å¯èƒ½æ˜¯ scopes ä¸è¶³ï¼ˆfiles.content.writeï¼‰ã€‚\n\nè¦ç¾åœ¨é–‹å§‹å°è¦½å» Console å—ï¼Ÿ");
        if(go) guideToConsoleStrong();
        return;
      }

      tokenMsg.textContent =
`${chk.msg}${emailHint}
${folderChk.msg}

Dropbox ç¶²ç«™ä½ç½®ï¼ˆApp folderï¼‰ï¼š
${dropboxWebFolderUrl()}

âœ… Token OKï¼Œå·²å¯åŒæ­¥ã€‚`;

      setTimeout(()=> hideTokenOverlay(), 650);
    });

    // ==========================
    // Default NAV + AUTH
    // ==========================
    const DEFAULT_NAV = [
      { id: "btn1", label: "è‡»é¼æ™‚ä»£å¤§å»ˆç®¡ç†è¡¨", href: "è‡»é¼ç®¡ç†è¡¨.html", target: "", roles: ["admin","write","read"] },
      { id: "btn2", label: "ç¼ºå¤± / å“è³ª",       href: "ç”„é¼quality.html", target: "", roles: ["admin","write","read"] },
      { id: "btn3", label: "é›²ç«¯æª”æ¡ˆ",          href: "https://www.dropbox.com/", target: "_blank", roles: ["admin","write","read"] },
      { id: "btn4", label: "å·¥ç¨‹è³‡æ–™åº«",        href: "å·¥ç¨‹è³‡æ–™åº«.html", target: "", roles: ["admin","write"] },
      { id: "btn5", label: "è³‡æ–™åº«",            href: "#", target: "", roles: ["admin","write","read"] }
    ];
    const LEGACY_BUTTON_KEYS = ["btn1","btn2","btn3","btn4","btn5"];

    function normalizeNavEntry(entry, index) {
      const base = DEFAULT_NAV[index] || {};
      const label = (entry && entry.label ? String(entry.label).trim() : "") || base.label || `æŒ‰éˆ•${index + 1}`;
      const href  = (entry && entry.href  ? String(entry.href).trim()  : "") || base.href  || "#";
      const target= (entry && entry.target? String(entry.target).trim(): "") || base.target|| "";
      const roles = Array.isArray(entry && entry.roles) ? entry.roles.slice()
        : (Array.isArray(base.roles) ? base.roles.slice() : ["admin","write","read"]);
      return { id: `btn${index + 1}`, label, href, target, roles };
    }

    function loadNavConfig() {
      const raw = localStorage.getItem(NAV_KEY);
      if (!raw) {
        localStorage.setItem(NAV_KEY, JSON.stringify(DEFAULT_NAV.slice()));
        return DEFAULT_NAV.slice();
      }
      const arr = safeJsonParse(raw, null);
      if (!Array.isArray(arr) || arr.length === 0) {
        localStorage.setItem(NAV_KEY, JSON.stringify(DEFAULT_NAV.slice()));
        return DEFAULT_NAV.slice();
      }
      const fixed = arr.map((it, idx)=> normalizeNavEntry(it, idx));
      localStorage.setItem(NAV_KEY, JSON.stringify(fixed));
      return fixed;
    }

    function makeButtonsAll(count) { return Array(count).fill(true); }
    function makeButtonsOnlyLast(count) {
      const arr = Array(count).fill(false);
      if (count > 0) arr[count - 1] = true;
      return arr;
    }
    function getDefaultAuthTable(btnCount) {
      return [
        { username: "alex",  password: "Tasun08040224", level: "admin", role:"admin", buttons: makeButtonsAll(btnCount) },
        { username: "tasun", password: "tasun08040224", level: "write", role:"write", buttons: makeButtonsAll(btnCount) },
        { username: "wu",    password: "123456",        level: "read",  role:"read",  buttons: makeButtonsOnlyLast(btnCount) }
      ];
    }

    function normalizeRowFromStorage(row, btnCount) {
      const username = String(row.username || "").trim();
      const password = String(row.password || "");
      const level = mapRole(row.level ?? row.role) || "read";

      let buttons = [];
      if (Array.isArray(row.buttons)) buttons = row.buttons.slice();
      else {
        const legacy = [];
        LEGACY_BUTTON_KEYS.forEach(k => {
          if (Object.prototype.hasOwnProperty.call(row, k)) legacy.push(!!row[k]);
        });
        buttons = legacy;
      }

      const resultButtons = [];
      for (let i = 0; i < btnCount; i++) resultButtons[i] = !!buttons[i];
      return { username, password, level, role: level, buttons: resultButtons };
    }

    function loadAuthTable(btnCount) {
      const raw = localStorage.getItem(AUTH_KEY);
      if (!raw) {
        const defaults = getDefaultAuthTable(btnCount);
        localStorage.setItem(AUTH_KEY, JSON.stringify(defaults));
        return defaults.map(r=> normalizeRowFromStorage(r, btnCount));
      }
      const arr = safeJsonParse(raw, null);
      if (Array.isArray(arr) && arr.length) {
        const fixed = arr.map(r => normalizeRowFromStorage(r, btnCount));
        localStorage.setItem(AUTH_KEY, JSON.stringify(fixed));
        return fixed;
      }
      const defaults = getDefaultAuthTable(btnCount);
      localStorage.setItem(AUTH_KEY, JSON.stringify(defaults));
      return defaults.map(r=> normalizeRowFromStorage(r, btnCount));
    }

    // ==========================
    // Dropbox pull (optional)
    // ==========================
    async function dbxDownloadJson(path){
      if(!dbxEnabled()) return null;
      try{
        const res = await fetchWithTimeout("https://content.dropboxapi.com/2/files/download", {
          method: "POST",
          cache: "no-store",
          headers: {
            "Authorization": dbxAuthHeader(),
            "Dropbox-API-Arg": jsonAscii({ path })
          }
        }, 15000);
        if(!res.ok) return null;
        const text = await res.text();
        return safeJsonParse(text, null);
      }catch(e){
        return null;
      }
    }

    function getLocalUpdatedAt(){
      const v = Number(localStorage.getItem("tasunCloudUpdatedAt_v1") || "0");
      return isFinite(v) ? v : 0;
    }
    function setLocalUpdatedAt(ts){
      localStorage.setItem("tasunCloudUpdatedAt_v1", String(ts || 0));
    }

    async function cloudPullToLocalStorage({ force=false } = {}){
      if(!dbxEnabled()) return false;

      const meta = await dbxDownloadJson(dbxPathMeta());
      const cloudTs = Number(meta && meta.updatedAt ? meta.updatedAt : 0);
      const localTs = getLocalUpdatedAt();
      if(!force && cloudTs && localTs && cloudTs <= localTs) return false;

      const auth = await dbxDownloadJson(dbxPathAuth());
      const nav  = await dbxDownloadJson(dbxPathNav());

      let changed = false;

      if(auth && Array.isArray(auth) && auth.length){
        const fixed = auth.map(r=>{
          const level = mapRole(r?.level ?? r?.role) || "read";
          return { ...r, level, role: level };
        });
        localStorage.setItem(AUTH_KEY, JSON.stringify(fixed));
        changed = true;
      }
      if(nav && Array.isArray(nav) && nav.length){
        localStorage.setItem(NAV_KEY, JSON.stringify(nav));
        changed = true;
      }

      if(cloudTs) setLocalUpdatedAt(cloudTs);
      return changed;
    }

    // ==========================
    // UI build + layout
    // ==========================
    let NAV_CONFIG = [];
    let AUTH_TABLE = [];
    let mainNavBtns = [];
    let currentVisibleBtns = [];

    function buildMainButtons() {
      NAV_CONFIG = loadNavConfig();
      AUTH_TABLE = loadAuthTable(NAV_CONFIG.length);

      mainNavBtns = [];
      navArea.innerHTML = "";

      NAV_CONFIG.forEach((cfg, index) => {
        const a = document.createElement("a");
        a.className = "nav-btn";
        a.dataset.index = String(index);

        const span = document.createElement("span");
        span.textContent = cfg.label;
        a.appendChild(span);

        a.href = cfg.href || "#";
        if (cfg.target) {
          a.target = cfg.target;
          if (cfg.target === "_blank") a.rel = "noopener noreferrer";
        }

        a.style.display = "none";
        navArea.appendChild(a);
        mainNavBtns.push(a);
      });

      if (systemBtn) systemBtn.style.display = "none";
    }

    function fitBtnText(btn){
      const span = btn && btn.querySelector("span");
      if(!span) return;

      span.style.fontSize = "";
      span.style.letterSpacing = "";
      span.style.textIndent = "";

      const cs = getComputedStyle(span);
      let fs = parseFloat(cs.fontSize) || 16;

      const minPx = 12;
      const maxTry = 14;
      let i = 0;

      while(i < maxTry && fs > minPx && (span.scrollHeight > span.clientHeight + 1 || span.scrollWidth > span.clientWidth + 1)){
        fs -= 1;
        span.style.fontSize = fs + "px";
        i++;
      }

      if(span.scrollHeight > span.clientHeight + 1 && fs <= 13){
        span.style.letterSpacing = "0.10em";
        span.style.textIndent = "0.10em";
      }
    }

    function fitAllVisibleTexts(){
      (currentVisibleBtns || []).forEach(fitBtnText);
      if(systemBtn && systemBtn.style.display !== "none") fitBtnText(systemBtn);
    }

    function layoutMainButtonsResponsive() {
      const width  = window.innerWidth || document.documentElement.clientWidth || 1024;

      if (width <= 900) {
        (currentVisibleBtns || []).forEach(btn => {
          btn.style.top = "";
          btn.style.left = "";
          btn.style.right = "";
        });
        if (systemBtn) {
          systemBtn.style.top = "";
          systemBtn.style.left = "";
          systemBtn.style.right = "";
        }
        requestAnimationFrame(fitAllVisibleTexts);
        return;
      }

      const btns = (currentVisibleBtns || []).slice();
      if (systemBtn && systemBtn.style.display !== "none") btns.push(systemBtn);

      const count = btns.length;
      if (!count) return;

      const rowCount = Math.ceil(count / 2);
      const topStart = 26;
      const topEnd   = 74;
      const step = rowCount > 1 ? (topEnd - topStart) / (rowCount - 1) : 0;

      btns.forEach((btn, index) => {
        const row = Math.floor(index / 2);
        const col = index % 2;
        const top = topStart + step * row;

        btn.style.top = top + "%";
        btn.style.left = "";
        btn.style.right = "";

        if (col === 0) btn.style.left = "var(--side-btn-offset)";
        else btn.style.right = "var(--side-btn-offset)";
      });

      requestAnimationFrame(fitAllVisibleTexts);
    }

    window.addEventListener("resize", () => layoutMainButtonsResponsive());

    function isRoleAllowedForIndex(index, level) {
      const cfg = NAV_CONFIG[index];
      if (!cfg || !Array.isArray(cfg.roles)) return true;
      const r = mapRole(level) || "read";
      return cfg.roles.includes(r);
    }

    // âœ… ä¿®æ­£ï¼šapplyUser å¯é¸æ“‡ä¸å»£æ’­ï¼ˆé¿å… watch é‡åˆ·é€ æˆ loopï¼‰
    function applyUser(userRow, { broadcast=true } = {}) {
      document.body.classList.remove("locked");
      loginOverlay.style.display = "none";
      loginOverlay.setAttribute("aria-hidden","true");

      const lvl = mapRole(userRow.level ?? userRow.role) || "read";
      setCurrentUser({ username: userRow.username, level: lvl }, { broadcast });

      userInfo.textContent = `ç›®å‰ä½¿ç”¨è€…ï¼š${userRow.username} (${lvl})`;

      const visibleMain = [];

      mainNavBtns.forEach((btn, index) => {
        const allowedByRole = isRoleAllowedForIndex(index, lvl);
        const btnFlags = Array.isArray(userRow.buttons) ? userRow.buttons : [];
        const allowedByAuth = index < btnFlags.length ? !!btnFlags[index] : true;

        if (allowedByRole && allowedByAuth) {
          btn.style.display = "flex";
          visibleMain.push(btn);
        } else {
          btn.style.display = "none";
        }
      });

      currentVisibleBtns = visibleMain;

      if (systemBtn) systemBtn.style.display = (lvl === "admin") ? "flex" : "none";
      layoutMainButtonsResponsive();
    }

    function resetButtonsForLogout() {
      currentVisibleBtns = [];
      mainNavBtns.forEach(btn => {
        btn.style.display = "none";
        btn.style.top = "";
        btn.style.left = "";
        btn.style.right = "";
      });
      if (systemBtn) {
        systemBtn.style.display = "none";
        systemBtn.style.top = "";
        systemBtn.style.left = "";
        systemBtn.style.right = "";
      }
    }

    function showLoginOverlay(){
      document.body.classList.add("locked");
      loginOverlay.style.display = "flex";
      loginOverlay.setAttribute("aria-hidden","false");
      resetButtonsForLogout();
      userInfo.textContent = "ç›®å‰ä½¿ç”¨è€…ï¼šæœªç™»å…¥";
      loginError.textContent = "";
      setTimeout(()=> usernameInput?.focus(), 60);
    }

    // user dropdown
    function closeUserDrop(){
      userDrop.style.display = "none";
      userDrop.setAttribute("aria-hidden", "true");
    }
    function openUserDrop(){
      userDrop.style.display = "block";
      userDrop.setAttribute("aria-hidden", "false");
    }
    function toggleUserDrop(){
      const opened = userDrop.style.display === "block";
      if(opened) closeUserDrop();
      else openUserDrop();
    }

    function populateUserSelect(){
      usernameList.innerHTML = "";
      userDrop.innerHTML = "";

      (AUTH_TABLE || []).forEach(row => {
        const u = String(row.username || "").trim();
        if(!u) return;

        const opt = document.createElement("option");
        opt.value = u;
        usernameList.appendChild(opt);

        const b = document.createElement("button");
        b.type = "button";
        b.textContent = u;
        b.addEventListener("click", ()=> {
          usernameInput.value = u;
          closeUserDrop();
          usernameInput.focus();
        });
        userDrop.appendChild(b);
      });

      if(usernameInput && !String(usernameInput.value || "").trim()){
        const first = (AUTH_TABLE || []).find(r => String(r.username||"").trim());
        if(first) usernameInput.value = String(first.username || "").trim();
      }
    }

    function findUser(username, password) {
      const trimmedName = (username || "").trim();
      return (AUTH_TABLE || []).find(row => row.username === trimmedName && row.password === password);
    }

    // ==========================
    // âœ… æœ¬æ©Ÿ/é›²ç«¯ Watchï¼šä¸ç®¡æœ‰æ²’æœ‰ Token éƒ½å•Ÿå‹•
    // ==========================
    const CLOUD_WATCH_MS = 4000;
    const LOCAL_WATCH_MS = 1200;

    let watchTimerCloud = null;
    let watchTimerLocal = null;
    let watchBusy = false;

    let lastAuthRaw = "";
    let lastNavRaw  = "";

    function readRaw(){
      return {
        auth: localStorage.getItem(AUTH_KEY) || "",
        nav:  localStorage.getItem(NAV_KEY)  || ""
      };
    }

    async function syncNowIfNew({ force=false, from="watch" } = {}){
      if(watchBusy) return false;
      watchBusy = true;
      try{
        // 1) è‹¥æœ‰ token æ‰ pull cloudï¼ˆé¿å…æ²’ token äº‚æ‰“ APIï¼‰
        if(dbxEnabled()){
          await cloudPullToLocalStorage({ force });
        }

        // 2) æ¯”å°æœ¬æ©Ÿ raw æ˜¯å¦è®Šæ›´
        const raw = readRaw();
        const changed = force || raw.auth !== lastAuthRaw || raw.nav !== lastNavRaw;

        if(!changed) return false;

        lastAuthRaw = raw.auth;
        lastNavRaw  = raw.nav;

        // 3) é‡å»º UI
        buildMainButtons();
        populateUserSelect();

        // âœ… é—œéµä¿®æ­£ï¼šè‹¥å·²ç™»å…¥ï¼Œé‡å»ºå¾Œè¦é‡æ–°å¥—ç”¨ï¼Œé¿å…ã€Œå¹¾ç§’å¾ŒæŒ‰éµä¸è¦‹ã€
        const cu = getCurrentUser();
        if(cu && cu.username){
          const row = (AUTH_TABLE||[]).find(r => r.username === cu.username);
          if(row){
            applyUser(row, { broadcast:false });
          }else{
            clearCurrentUser({ broadcast:false });
            showLoginOverlay();
          }
        }

        return true;
      } finally {
        watchBusy = false;
      }
    }

    function startWatchers(){
      if(watchTimerCloud) clearInterval(watchTimerCloud);
      if(watchTimerLocal) clearInterval(watchTimerLocal);

      // cloud watchï¼ˆæœ‰ token æ‰æœƒçœŸçš„ pullï¼›æ²’ token ä¹Ÿæœƒåšæœ¬æ©Ÿè®Šæ›´æ¯”å°ï¼‰
      watchTimerCloud = setInterval(()=> syncNowIfNew({ force:false, from:"cloud" }), CLOUD_WATCH_MS);

      // local watchï¼ˆç¢ºä¿ã€Œæ²’ tokenã€ä¹Ÿæœƒæ›´æ–°ï¼‰
      watchTimerLocal = setInterval(()=> syncNowIfNew({ force:false, from:"local" }), LOCAL_WATCH_MS);

      // åŒæ­¥ï¼šå›åˆ°å‰æ™¯æ™‚ä¹Ÿåˆ·æ–°
      document.addEventListener("visibilitychange", ()=> {
        if(!document.hidden) syncNowIfNew({ force:false, from:"visible" });
      });

      // storage eventï¼šè·¨åˆ†é  localStorage æ›´æ–°å³åˆ»åˆ·æ–°
      window.addEventListener("storage", (ev)=>{
        if(!ev) return;
        if(ev.key === AUTH_KEY || ev.key === NAV_KEY){
          syncNowIfNew({ force:false, from:"storage" });
        }
      });
    }

    // ==========================
    // âœ… BroadcastChannelï¼ˆè·¨åˆ†é ç™»å…¥ + è¨­å®šè®Šæ›´é€šçŸ¥ï¼‰
    // ==========================
    function initAuthBridge(){
      if(typeof BroadcastChannel === "undefined") return;
      try{
        bc = new BroadcastChannel(AUTH_BRIDGE_CH);
        bcReady = true;

        bc.onmessage = async (ev)=>{
          const m = ev && ev.data ? ev.data : null;
          if(!m || m._from === TAB_ID) return;

          if(m.type === "who"){
            const cu = getCurrentUser();
            if(cu && cu.username){
              bcPost({ type:"login", user: cu, _replyTo: m._from });
            }
            return;
          }

          if(m.type === "login" && m.user && m.user.username){
            const u = m.user;
            sessionStorage.setItem(CURRENT_KEY, JSON.stringify({
              username: String(u.username||"").trim(),
              role: mapRole(u.role ?? u.level) || "read",
              level: mapRole(u.role ?? u.level) || "read"
            }));

            await syncNowIfNew({ force:false, from:"bc-login" });
            const row = (AUTH_TABLE||[]).find(r=> r.username === String(u.username||"").trim());
            if(row) applyUser(row, { broadcast:false });
            return;
          }

          if(m.type === "logout"){
            sessionStorage.removeItem(CURRENT_KEY);
            showLoginOverlay();
            return;
          }

          // âœ… æ¬Šé™è¡¨å„²å­˜/ä¸Šå‚³å¾Œï¼Œé€šçŸ¥é¦–é ç«‹å³æ›´æ–°
          if(m.type === "configChanged"){
            await syncNowIfNew({ force:true, from:"bc-config" });
            return;
          }
        };
      }catch(e){
        bcReady = false;
        bc = null;
      }
    }

    // ==========================
    // boot
    // ==========================
    (async function boot(){
      try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}

      initAuthBridge();

      if(!dbxEnabled()){
        showTokenOverlay();
      }

      // åˆå§‹åŒ–å¿«ç…§
      const raw = readRaw();
      lastAuthRaw = raw.auth;
      lastNavRaw  = raw.nav;

      // åˆæ¬¡å»º UI
      buildMainButtons();
      populateUserSelect();

      // å•Ÿå‹• watchersï¼ˆç„¡æ¢ä»¶ï¼‰
      startWatchers();

      // åˆæ¬¡ä¹Ÿè·‘ä¸€æ¬¡åŒæ­¥ï¼ˆæœ‰ token å°± pullï¼‰
      await syncNowIfNew({ force:true, from:"boot" });

      const cu = getCurrentUser();
      if(cu && cu.username){
        const row = (AUTH_TABLE||[]).find(r=> r.username === cu.username);
        if(row){
          applyUser(row, { broadcast:false });
        }else{
          clearCurrentUser({ broadcast:false });
          showLoginOverlay();
        }
      }else{
        showLoginOverlay();
        bcPost({ type:"who" });
      }
    })();

    // ==========================
    // events
    // ==========================
    loginForm.addEventListener("submit", async function (e) {
      e.preventDefault();

      await syncNowIfNew({ force:false, from:"login" });

      const username = (usernameInput.value || "").trim();
      const password = document.getElementById("password").value;

      const user = findUser(username, password);
      if (!user) {
        loginError.textContent = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚";
        return;
      }

      loginError.textContent = "";
      applyUser(user, { broadcast:true });
    });

    btnSwitch.addEventListener("click", async function () {
      clearCurrentUser({ broadcast:true });
      showLoginOverlay();
      loginForm.reset();
      await syncNowIfNew({ force:false, from:"switch" });
      populateUserSelect();
    });

    btnTogglePwd.addEventListener("click", function () {
      const pwdInput = document.getElementById("password");
      if (!pwdInput) return;
      pwdInput.type = pwdInput.type === "password" ? "text" : "password";
    });

    btnUserDrop.addEventListener("click", async function(){
      await syncNowIfNew({ force:false, from:"drop" });
      toggleUserDrop();
    });

    document.addEventListener("click", (e)=>{
      const inside = e.target === userDrop || userDrop.contains(e.target) ||
                     e.target === btnUserDrop || e.target === usernameInput;
      if(!inside) closeUserDrop();
    });

    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        if(tokenOverlay && tokenOverlay.style.display === "flex") hideTokenOverlay();
        closeUserDrop();
      }
    });
  </script>
</body>
</html>
