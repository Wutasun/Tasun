<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Tasun 資料 · 空無明</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --gold: #f6d37a;
      --gold-soft: rgba(246, 211, 122, 0.75);
      --panel-border: rgba(246, 211, 122, 0.28);

      --side-gap: clamp(18px, 3vw, 34px);
      --btn-w: clamp(240px, 26vw, 360px);
      --btn-h: clamp(56px, 6.6vh, 70px);

      --bg0: #050302;
      --bg1: #0b0a07;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: "Noto Serif TC", system-ui, -apple-system, "Microsoft JhengHei", sans-serif;
      color: rgba(246,211,122,.92);
      background:
        radial-gradient(circle at 18% 0%, rgba(246,211,122,.12) 0, transparent 42%),
        radial-gradient(circle at 82% 18%, rgba(246,211,122,.08) 0, transparent 48%),
        radial-gradient(circle at 50% 92%, rgba(246,211,122,.10) 0, transparent 52%),
        linear-gradient(180deg, var(--bg1), var(--bg0) 55%, #000);
      overflow-x: hidden;
    }

    /* ===== Top Left user bar ===== */
    .top-left {
      position: fixed;
      top: 14px;
      left: 14px;
      z-index: 50;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .pill, .btn {
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.25);
      background: linear-gradient(180deg, rgba(246,211,122,.10), rgba(0,0,0,.50));
      box-shadow: 0 10px 24px rgba(0,0,0,.45);
      color: rgba(246,211,122,.95);
      height: 40px;
      display: inline-flex;
      align-items: center;
      padding: 0 14px;
      font-size: 13px;
      white-space: nowrap;
      letter-spacing: .10em;
      user-select: none;
    }
    .pill b { color: var(--gold); font-weight: 700; }

    .btn {
      cursor: pointer;
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
    }
    .btn:hover { transform: translateY(-1px); filter: brightness(1.04); box-shadow: 0 12px 28px rgba(0,0,0,.55); }
    .btn:active { transform: translateY(0px); filter: brightness(.98); }
    .btn[disabled] { opacity: .45; cursor: not-allowed; transform:none; }

    /* ===== Main stage ===== */
    .stage {
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 80px 14px 36px;
      position: relative;
    }

    /* 背景柔霧 */
    .stage::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 50% 30%, rgba(246,211,122,.16), transparent 55%),
        radial-gradient(circle at 50% 65%, rgba(246,211,122,.08), transparent 60%);
      pointer-events: none;
      opacity: .9;
    }

    /* 中央聚光（舞台燈感：硬邊 + 柔霧） */
    .spot {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      background:
        /* 圓形亮區（中心亮，外圈硬邊） */
        radial-gradient(circle at 50% 52%,
          rgba(246,211,122,.55) 0%,
          rgba(246,211,122,.32) 24%,
          rgba(246,211,122,.18) 40%,
          rgba(246,211,122,.12) 52%,
          rgba(246,211,122,.00) 62%),
        /* 硬邊外圈（淡淡邊界，不要太「畫出一個圈」） */
        radial-gradient(circle at 50% 56%,
          rgba(246,211,122,.00) 52%,
          rgba(246,211,122,.18) 56%,
          rgba(246,211,122,.00) 62%),
        /* 上方煙霧光束（非三角，避免幾何感） */
        radial-gradient(ellipse 45% 28% at 50% 18%,
          rgba(246,211,122,.18) 0%,
          rgba(246,211,122,.10) 40%,
          rgba(246,211,122,.00) 70%);
      filter: blur(0px);
      opacity: .95;
      mix-blend-mode: screen;
    }

    .frame {
      width: min(1320px, calc(100% - 26px));
      height: min(720px, calc(100vh - 150px));
      border-radius: 34px;
      background: rgba(0,0,0,.16);
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      position: relative;
      overflow: hidden;
      z-index: 1;
    }

    /* 不要邊框：用內陰影做出整體感（不會像框） */
    .frame::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius:34px;
      box-shadow:
        inset 0 0 0 1px rgba(246,211,122,.08),
        inset 0 0 70px rgba(0,0,0,.55);
      pointer-events:none;
    }

    .title {
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: clamp(34px, 4.4vw, 58px);
      letter-spacing: .22em;
      color: rgba(246,211,122,.95);
      text-shadow: 0 2px 14px rgba(0,0,0,.75);
      z-index: 3;
    }

    /* 中央蓮花區（不要方塊感：用柔霧與陰影融合） */
    .center {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      z-index: 2;
    }
    .lotus-wrap{
      width: min(560px, 64vw);
      aspect-ratio: 1 / 1;
      border-radius: 999px;
      position: relative;
      display: grid;
      place-items: center;
      isolation: isolate;
    }
    .lotus-wrap::before{
      content:"";
      position:absolute;
      inset:-12%;
      border-radius:999px;
      background:
        radial-gradient(circle at 50% 50%,
          rgba(246,211,122,.18) 0%,
          rgba(246,211,122,.10) 38%,
          rgba(246,211,122,.00) 70%);
      filter: blur(2px);
      opacity: .95;
      z-index: -2;
    }
    .lotus-wrap::after{
      content:"";
      position:absolute;
      inset:-24%;
      border-radius:999px;
      background:
        radial-gradient(circle at 50% 56%,
          rgba(0,0,0,.0) 52%,
          rgba(246,211,122,.12) 56%,
          rgba(0,0,0,.0) 64%);
      opacity:.6;
      z-index:-1;
    }

    .lotus-img{
      width: 78%;
      max-width: 420px;
      filter: drop-shadow(0 18px 30px rgba(0,0,0,.55));
      opacity: .98;
    }

    .zen-words{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      pointer-events:none;
      color: rgba(246,211,122,.65);
      text-shadow: 0 2px 10px rgba(0,0,0,.7);
      font-size: clamp(18px, 2.2vw, 30px);
      letter-spacing: .25em;
    }
    .zen-words .top{ position:absolute; top: 14%; }
    .zen-words .left{ position:absolute; left: 14%; }
    .zen-words .right{ position:absolute; right: 14%; }
    .zen-words .bottom{ position:absolute; bottom: 10%; letter-spacing: .4em; }

    /* ===== Buttons grid ===== */
    .btn-grid{
      position:absolute;
      inset: 0;
      display:grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr;
      gap: 26px var(--side-gap);
      padding: 120px 90px 90px;
      align-items:center;
      justify-items:center;
      z-index: 4;
    }

    .nav-btn{
      width: var(--btn-w);
      height: var(--btn-h);
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.28);
      background: linear-gradient(180deg, rgba(246,211,122,.18), rgba(0,0,0,.56));
      color: rgba(246,211,122,.92);
      box-shadow: 0 16px 34px rgba(0,0,0,.55);
      cursor:pointer;
      letter-spacing: .16em;
      font-size: clamp(14px, 1.5vw, 18px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0 20px;
      text-align:center;
      user-select:none;
      transition: transform .12s ease, filter .12s ease;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .nav-btn:hover{ transform: translateY(-2px); filter: brightness(1.05); }
    .nav-btn:active{ transform: translateY(0px); filter: brightness(.98); }
    .nav-btn.hidden{ display:none !important; }

    /* 避免按鈕蓋到中央文字：縮小中央區域影響 */
    @media (max-width: 1080px){
      .btn-grid{ padding: 120px 56px 90px; }
      .lotus-wrap{ width: min(520px, 70vw); }
    }
    @media (max-width: 820px){
      .frame{ height: auto; min-height: 82vh; }
      .btn-grid{
        grid-template-columns: 1fr;
        grid-template-rows: repeat(6, auto);
        gap: 14px;
        padding: 110px 28px 26px;
        align-content: start;
      }
      .nav-btn{ width: min(520px, 92%); height: 56px; }
      .lotus-wrap{ width: min(520px, 92vw); margin-top: 66px; }
      .zen-words{ font-size: 18px; }
    }

    /* ===== Login Overlay ===== */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 999;
      padding: 18px;
    }
    .overlay.open{ display:flex; }
    .modal{
      width: min(520px, 100%);
      border-radius: 22px;
      border: 1px solid rgba(246,211,122,.22);
      background:
        linear-gradient(90deg, rgba(246,211,122,.16), rgba(0,0,0,.62) 70%),
        radial-gradient(circle at 30% 22%, rgba(246,211,122,.12), transparent 55%);
      box-shadow: 0 18px 44px rgba(0,0,0,.62);
      overflow:hidden;
    }
    .modal-head{
      padding: 16px 18px;
      border-bottom: 1px solid rgba(246,211,122,.14);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .modal-head h3{
      margin:0;
      font-size: 18px;
      letter-spacing:.18em;
    }
    .modal-body{ padding: 16px 18px 10px; display:flex; flex-direction:column; gap:12px; }
    .field label{
      display:block;
      font-size: 12px;
      opacity:.85;
      margin: 0 0 6px 6px;
      letter-spacing:.10em;
    }
    .input, .select{
      width:100%;
      height: 40px;
      border-radius: 999px;
      border: 1px solid rgba(246,211,122,.22);
      background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
      color: rgba(246,211,122,.95);
      padding: 0 12px;
      outline:none;
      font-size: 13px;
    }
    .msg{
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(246,211,122,.14);
      background: rgba(0,0,0,.30);
      font-size: 13px;
      line-height: 1.6;
      color: rgba(246,211,122,.92);
      white-space: pre-wrap;
    }
    .modal-actions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      padding: 0 18px 18px;
    }
  </style>
</head>

<body>
  <div class="top-left">
    <div class="pill">目前使用者：<b id="curUser">—</b> (<span id="curRole">read</span>)</div>
    <button class="btn" id="btnSwitch">切換帳號</button>
  </div>

  <div class="stage">
    <div class="spot" aria-hidden="true"></div>

    <div class="frame">
      <div class="title">Tasun 資料</div>

      <div class="center">
        <div class="lotus-wrap">
          <!-- 你原本的蓮花圖片檔名若不同，改這裡 -->
          <img class="lotus-img" src="lotus-gold.png" alt="lotus" onerror="this.style.display='none'">

          <div class="zen-words">
            <div class="top">空</div>
            <div class="left">無</div>
            <div class="right">明</div>
            <div class="bottom">空 無 明 靜</div>
          </div>
        </div>
      </div>

      <div class="btn-grid" id="btnGrid">
        <button class="nav-btn" id="nav-btn1" data-id="btn1">btn1</button>
        <button class="nav-btn" id="nav-btn2" data-id="btn2">btn2</button>
        <button class="nav-btn" id="nav-btn3" data-id="btn3">btn3</button>
        <button class="nav-btn" id="nav-btn4" data-id="btn4">btn4</button>
        <button class="nav-btn" id="nav-btn5" data-id="btn5">btn5</button>
        <button class="nav-btn" id="nav-btn6" data-id="btn6">系統 / 權限</button>
      </div>
    </div>
  </div>

  <!-- Login -->
  <div class="overlay" id="ovLogin">
    <div class="modal">
      <div class="modal-head">
        <h3>登入</h3>
        <button class="btn" id="btnCloseLogin">關閉</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <label>帳號（下拉選單）</label>
          <select class="select" id="loginUser"></select>
        </div>
        <div class="field">
          <label>密碼</label>
          <input class="input" id="loginPass" type="password" placeholder="輸入密碼">
        </div>
        <div class="msg" id="loginMsg">請選擇帳號並輸入密碼。</div>
      </div>
      <div class="modal-actions">
        <button class="btn" id="btnDoLogin">登入</button>
      </div>
    </div>
  </div>

  <script>
    // ====== Storage Keys（與權限表一致） ======
    const AUTH_KEY = "tasunAuthTable_v1";
    const AUTH_KEY_ALIASES = ["tasunAuthTable", "tasunAuthTable_v0", "AUTH_TABLE"];

    const CURRENT_KEY = "tasunCurrentUser_v1";
    const CURRENT_KEY_ALIASES = ["tasunCurrentUser", "currentUser", "tasun_current_user"];

    const HOME_BTN_KEY = "tasunHomeButtons_v1";
    const HOME_BTN_KEY_ALIASES = ["tasunIndexButtons_v1", "tasunHomeBtns", "tasunNavButtons_v1"];

    // ====== Default Data ======
    const DEFAULT_AUTH = [
      { username:"alex",  password:"Tasun08040224", role:"admin", btn:{btn1:true, btn2:true, btn3:true, btn4:true, btn5:true} },
      { username:"tasun", password:"tasun08040224", role:"write", btn:{btn1:true, btn2:true, btn3:true, btn4:true, btn5:true} },
      { username:"wu",    password:"123456",       role:"read",  btn:{btn1:true, btn2:false,btn3:false,btn4:false,btn5:true} },
      { username:"JOYCE", password:"09220224",     role:"read",  btn:{btn1:true, btn2:true, btn3:true, btn4:true, btn5:false} },
    ];

    // 預設按鈕名稱 + 連結（若 homeButtons 只有 label 也沒關係，href 會用這裡）
    const DEFAULT_BTNS = [
      { id:"btn1", label:"臻鼎時代大廈管理表", href:"臻鼎管理表.html" },
      { id:"btn2", label:"缺失 / 品質", href:"甄鼎quality.html" },
      { id:"btn3", label:"雲端檔案", href:"https://www.dropbox.com/", target:"_blank" },
      { id:"btn4", label:"工程資料庫", href:"工程資料庫.html" },
      { id:"btn5", label:"資料庫", href:"資料庫.html" },
    ];

    // ====== DOM ======
    const curUserEl = document.getElementById("curUser");
    const curRoleEl = document.getElementById("curRole");
    const btnSwitch = document.getElementById("btnSwitch");

    const nav = {
      btn1: document.getElementById("nav-btn1"),
      btn2: document.getElementById("nav-btn2"),
      btn3: document.getElementById("nav-btn3"),
      btn4: document.getElementById("nav-btn4"),
      btn5: document.getElementById("nav-btn5"),
      btn6: document.getElementById("nav-btn6"),
    };

    const ovLogin = document.getElementById("ovLogin");
    const btnCloseLogin = document.getElementById("btnCloseLogin");
    const loginUser = document.getElementById("loginUser");
    const loginPass = document.getElementById("loginPass");
    const loginMsg = document.getElementById("loginMsg");
    const btnDoLogin = document.getElementById("btnDoLogin");

    // ====== State ======
    let auth = [];
    let current = { username:"", role:"read" };
    let homeButtons = [];

    function safeParseJSON(s){ try { return JSON.parse(s); } catch(_) { return null; } }
    function clampRole(role){ return (role==="admin"||role==="write"||role==="read") ? role : "read"; }

    function readFirstKey(keys){
      for(const k of keys){
        const v = localStorage.getItem(k);
        if(v !== null && v !== undefined && String(v).trim() !== "") return { key:k, value:v };
      }
      return { key:null, value:null };
    }

    // 相容舊資料：btn 在 btn 物件內 or 扁平
    function normalizeAuth(list){
      const out = Array.isArray(list) ? list : [];
      return out
        .filter(x => x && typeof x === "object")
        .map(x => {
          const btnObj = (x.btn && typeof x.btn === "object") ? x.btn : null;
          return {
            username: String(x.username ?? x.user ?? "").trim(),
            password: String(x.password ?? x.pass ?? "").trim(),
            role: clampRole(x.role ?? x.permission ?? x.perm),
            btn: {
              btn1: !!(btnObj ? btnObj.btn1 : (x.btn1)),
              btn2: !!(btnObj ? btnObj.btn2 : (x.btn2)),
              btn3: !!(btnObj ? btnObj.btn3 : (x.btn3)),
              btn4: !!(btnObj ? btnObj.btn4 : (x.btn4)),
              btn5: !!(btnObj ? btnObj.btn5 : (x.btn5)),
            }
          };
        })
        .filter(x => x.username.length > 0);
    }

    function loadAuth(){
      const got = readFirstKey([AUTH_KEY, ...AUTH_KEY_ALIASES]);
      const parsed = got.value ? safeParseJSON(got.value) : null;
      const normalized = normalizeAuth(parsed);

      if(normalized.length){
        auth = normalized;
        localStorage.setItem(AUTH_KEY, JSON.stringify(auth));
        return;
      }

      auth = normalizeAuth(DEFAULT_AUTH);
      localStorage.setItem(AUTH_KEY, JSON.stringify(auth));
    }

    function loadCurrent(){
      const got = readFirstKey([CURRENT_KEY, ...CURRENT_KEY_ALIASES]);
      const parsed = got.value ? safeParseJSON(got.value) : null;

      const u = String(parsed?.username ?? parsed?.user ?? "").trim();
      const r = clampRole(parsed?.role ?? parsed?.perm ?? parsed?.permission ?? "read");

      current = { username: u, role: r };

      // 以權限表為準（避免 current role 舊資料）
      const found = auth.find(x => x.username === current.username);
      if(found){
        current.role = clampRole(found.role);
        localStorage.setItem(CURRENT_KEY, JSON.stringify(current));
      }else{
        current = { username:"", role:"read" };
        localStorage.setItem(CURRENT_KEY, JSON.stringify(current));
      }
    }

    function normalizeHomeButtons(list){
      const arr = Array.isArray(list) ? list : [];
      const map = new Map();

      for(const it of arr){
        if(!it) continue;
        const id = String(it.id || it.key || "").trim();
        const label = String(it.label || it.name || it.text || "").trim();
        if(id && label) map.set(id, { id, label });
      }

      // 讓 label 可被同步，但 href 仍用 DEFAULT_BTNS
      return ["btn1","btn2","btn3","btn4","btn5"].map((id) => {
        const base = DEFAULT_BTNS.find(b => b.id === id);
        const m = map.get(id);
        return {
          id,
          label: m?.label || base?.label || id,
          href: base?.href || "#",
          target: base?.target || ""
        };
      });
    }

    function loadHomeButtons(){
      const got = readFirstKey([HOME_BTN_KEY, ...HOME_BTN_KEY_ALIASES]);
      const parsed = got.value ? safeParseJSON(got.value) : null;
      homeButtons = normalizeHomeButtons(parsed || DEFAULT_BTNS);
    }

    function getUserRow(){
      if(!current.username) return null;
      return auth.find(x => x.username === current.username) || null;
    }

    function isAdmin(){ return current.role === "admin"; }

    function refreshUserUI(){
      curUserEl.textContent = current.username || "—";
      curRoleEl.textContent = current.role || "read";
    }

    function renderButtons(){
      loadHomeButtons(); // 每次 render 都讀一次，確保改名可同步
      const row = getUserRow();

      // ✅ 核心修正：若 admin 權限欄位讀不到，預設全部 true（避免只剩 btn6）
      const fallbackAll = isAdmin();

      const perm = {
        btn1: row ? !!row.btn?.btn1 : fallbackAll,
        btn2: row ? !!row.btn?.btn2 : fallbackAll,
        btn3: row ? !!row.btn?.btn3 : fallbackAll,
        btn4: row ? !!row.btn?.btn4 : fallbackAll,
        btn5: row ? !!row.btn?.btn5 : fallbackAll,
      };

      // 套用 label + href + 顯示/隱藏
      for(const b of homeButtons){
        const el = nav[b.id];
        if(!el) continue;
        el.textContent = b.label;

        el.onclick = () => {
          if(!b.href || b.href === "#") return;
          if(b.target === "_blank") window.open(b.href, "_blank");
          else location.href = b.href;
        };

        const show = !!perm[b.id];
        el.classList.toggle("hidden", !show);
      }

      // btn6：系統/權限 只給 admin
      nav.btn6.classList.toggle("hidden", !isAdmin());
      nav.btn6.onclick = () => { location.href = "權限表.html"; };

      // 保障：如果因資料異常全部被隱藏，至少讓 admin 看見 1~5
      const visibleCount = ["btn1","btn2","btn3","btn4","btn5"].filter(id => !nav[id].classList.contains("hidden")).length;
      if(visibleCount === 0 && isAdmin()){
        ["btn1","btn2","btn3","btn4","btn5"].forEach(id => nav[id].classList.remove("hidden"));
      }
    }

    function openLogin(){
      loginUser.innerHTML = auth.map(u => `<option value="${escapeHtml(u.username)}">${escapeHtml(u.username)}</option>`).join("");
      loginPass.value = "";
      loginMsg.textContent = "請選擇帳號並輸入密碼。";
      ovLogin.classList.add("open");
    }
    function closeLogin(){ ovLogin.classList.remove("open"); }

    function doLogin(){
      const u = String(loginUser.value || "").trim();
      const p = String(loginPass.value || "").trim();
      const row = auth.find(x => x.username === u);
      if(!row){ loginMsg.textContent = "❌ 找不到此帳號。"; return; }
      if(row.password !== p){ loginMsg.textContent = "❌ 密碼錯誤。"; return; }

      current = { username: row.username, role: row.role };
      localStorage.setItem(CURRENT_KEY, JSON.stringify(current));
      refreshUserUI();
      renderButtons();
      closeLogin();
    }

    // 支援跨分頁同步（權限表修改後，首頁自動更新）
    function startSyncWatch(){
      window.addEventListener("storage", (ev) => {
        const k = ev.key || "";
        if(k === AUTH_KEY || AUTH_KEY_ALIASES.includes(k)){
          loadAuth(); loadCurrent();
          refreshUserUI();
          renderButtons();
        }
        if(k === CURRENT_KEY || CURRENT_KEY_ALIASES.includes(k)){
          loadCurrent();
          refreshUserUI();
          renderButtons();
        }
        if(k === HOME_BTN_KEY || HOME_BTN_KEY_ALIASES.includes(k)){
          renderButtons();
        }
      });

      // 同頁也定時檢查（避免某些環境 storage 事件不觸發）
      setInterval(() => {
        renderButtons();
      }, 1200);
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function init(){
      loadAuth();
      loadHomeButtons();
      loadCurrent();

      refreshUserUI();
      renderButtons();
      startSyncWatch();

      btnSwitch.addEventListener("click", openLogin);
      btnCloseLogin.addEventListener("click", closeLogin);
      ovLogin.addEventListener("click", (e) => { if(e.target === ovLogin) closeLogin(); });
      btnDoLogin.addEventListener("click", doLogin);
      loginPass.addEventListener("keydown", (e) => { if(e.key === "Enter") doLogin(); });

      // 尚未登入就先彈出登入
      if(!current.username){
        openLogin();
      }
    }

    init();
  </script>
</body>
</html>
