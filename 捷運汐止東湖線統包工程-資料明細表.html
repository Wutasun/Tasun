<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>捷運汐止東湖線統包工程-資料明細表 · Tasun</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- ✅✅✅ APP_VER 強制同步（全站同一版號 / URL 自動帶 ?v=APP_VER / 跨頁連結自動附加 v） -->
  <script>
  (function(){
    /* 你只要改這個版號即可（建議：YYYYMMDD_HHMM 或 2026.01.26.1） */
    const APP_VER = "20260126_01";
    const KEY = "tasun_app_ver_v1";

    try{
      const u = new URL(location.href);
      const cur = (u.searchParams.get("v") || "").trim();
      const saved = (sessionStorage.getItem(KEY) || localStorage.getItem(KEY) || "").trim();

      // ✅ 目標版號優先序：APP_VER(固定) > URL v > 已存的 v
      const target = (APP_VER || cur || saved || "").trim();
      if(!target) return;

      // ✅ 存起來（跨頁一致）
      sessionStorage.setItem(KEY, target);
      localStorage.setItem(KEY, target);

      // ✅ 若當前網址 v 不一致，強制同步（避免多人不同頁面版本不同步）
      if(cur !== target){
        u.searchParams.set("v", target);
        location.replace(u.toString());
        return;
      }

      // ✅ 供全站使用：自動附加 v（僅同源檔案）
      window.__APP_VER = target;
      window.__CACHE_V = target;
      window.__withV = function(url){
        const vv = (window.__CACHE_V || "").trim();
        if(!vv) return url;
        try{
          const uu = new URL(url, document.baseURI);
          if(uu.origin === location.origin){
            uu.searchParams.set("v", vv);
            return uu.toString();
          }
          return url;
        }catch(e){
          return url;
        }
      };
    }catch(e){}
  })();
  </script>

  <style>
    :root{
      --bg0:#070809;
      --bg1:#0b0d10;
      --gold:#f6d37a;
      --gold2:rgba(246,211,122,.55);
      --border:rgba(246,211,122,.28);
      --border2:rgba(246,211,122,.40);
      --text:#ececec;
      --muted:rgba(236,236,236,.70);
      --shadow:0 18px 50px rgba(0,0,0,.55);
      --r:18px;
      --stageSide: clamp(14px, 3.2vw, 80px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}

    /* ✅ 關鍵：整頁不讓 body 捲動，改由下方 tableWrap 捲動 */
    body{
      margin:0;
      color:var(--text);
      font-family:"Noto Serif TC", serif;
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(246,211,122,.10), transparent 60%),
        radial-gradient(900px 520px at 85% 25%, rgba(246,211,122,.08), transparent 62%),
        radial-gradient(1100px 700px at 55% 85%, rgba(246,211,122,.06), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden; /* ✅ 只下半部可捲動 */
    }

    /* ✅ 關鍵：wrap 變成全高的 flex 容器，上方固定、下方吃滿高度 */
    .wrap{
      width: min(1720px, calc(100vw - (2 * var(--stageSide))));
      max-width: none;
      margin: 0 auto;
      padding: 20px 16px 18px;

      height: 100vh;
      height: 100dvh;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .topbar{
      position:relative;
      z-index:20;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      gap:12px;
      align-items:center;
      padding:14px;
      border:1px solid var(--border);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
      flex:0 0 auto; /* ✅ 固定區塊 */
    }
    @media (max-width:920px){
      .topbar{ grid-template-columns: 1fr; }
      .nav-left{ order:0; }
      .brand{ order:1; }
      .right{ order:2; justify-content:flex-start; }
    }

    .nav-left{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:flex-start;
      min-width: 220px;
    }
    .nav-desktop{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .nav-mobile{ display:none; gap:10px; align-items:center; width:100%; }
    @media (max-width:600px){
      .nav-desktop{ display:none; }
      .nav-mobile{ display:flex; }
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:center;
      justify-content:center;
      text-align:center;
    }
    .title{
      font-weight:900;
      letter-spacing:.06em;
      font-size: clamp(16px, 1.4vw, 20px);
      color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.22);
      line-height:1.25;
    }
    .sub{
      font-size:12px;
      color:rgba(236,236,236,.65);
      letter-spacing:.06em;
    }

    .right{
      display:flex; gap:10px;
      align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
      min-width: 220px;
    }
    @media (max-width:920px){ .right{ justify-content:flex-start; } }

    .pill{
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.05);
      font-size:13px; color:rgba(236,236,236,.85);
      display:flex; gap:8px; align-items:center; white-space:nowrap;
    }
    .pill b{color:var(--gold)}

    .btn{
      appearance:none;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(246,211,122,.18), rgba(246,211,122,.07));
      color:var(--gold);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-family:inherit;
      font-weight:800;
      letter-spacing:.05em;
      box-shadow:0 10px 22px rgba(0,0,0,.35);
      transition:transform .12s ease, filter .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.06)}
    .btn:active{transform:translateY(0); filter:brightness(.98)}
    .btn.ghost{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.18);
      color:rgba(236,236,236,.85);
      font-weight:600;
    }
    .btn.danger{
      border-color:rgba(255,120,120,.45);
      color:rgba(255,160,160,.95);
      background:rgba(255,120,120,.10);
    }
    .small{padding:8px 10px; font-size:12px; border-radius:999px; letter-spacing:.04em}

    .moreWrap{ position:relative; display:inline-flex; }
    .moreMenu{
      position:absolute;
      top:calc(100% + 8px);
      right:0;
      min-width: 230px;
      border-radius:16px;
      border:1px solid rgba(246,211,122,.30);
      background:linear-gradient(180deg, rgba(0,0,0,.72), rgba(0,0,0,.45));
      box-shadow:0 18px 50px rgba(0,0,0,.65);
      backdrop-filter:blur(10px);
      padding:8px;
      display:none;
      z-index:60;
    }
    .moreMenu.open{ display:block; }
    .menuItem{
      width:100%;
      text-align:left;
      border:none;
      background:rgba(255,255,255,.04);
      color:rgba(236,236,236,.92);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-family:inherit;
      letter-spacing:.04em;
    }
    .menuItem:hover{ background:rgba(246,211,122,.12); color:var(--gold); }
    .menuSep{ height:1px; margin:8px 6px; background:rgba(255,255,255,.10); }

    /* ✅ 關鍵：panel 吃滿剩餘高度，且自身不捲動 */
    .panel{
      margin-top:16px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;

      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      min-height:0;
      overflow:hidden;
    }

    .controls{
      display:grid;
      grid-template-columns: 1.2fr .9fr .9fr auto;
      gap:10px;
      align-items:end;
      flex:0 0 auto;
    }
    @media (max-width:920px){ .controls{grid-template-columns:1fr 1fr} }
    @media (max-width:520px){ .controls{grid-template-columns:1fr} }

    .field{display:flex; flex-direction:column; gap:6px}
    .label{font-size:12px; letter-spacing:.08em; color:var(--muted)}
    input,select,textarea{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);
      color:var(--text);
      padding:10px 12px;
      font-family:inherit;
      outline:none;
      transition:border-color .12s ease, filter .12s ease;
    }
    textarea{min-height:92px; resize:vertical;}
    input:focus,select:focus,textarea:focus{border-color:rgba(246,211,122,.55); filter:brightness(1.05)}

    /* ✅ 關鍵：只有 tableWrap 捲動 */
    .tableWrap{
      margin-top:14px;
      overflow:auto;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);

      flex:1 1 auto;
      min-height:0;
      -webkit-overflow-scrolling: touch;
    }

    table{width:100%; border-collapse:collapse; min-width:1320px; background:rgba(0,0,0,.18)}
    thead th{
      position:sticky; top:0; z-index:2;
      background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
      color:rgba(246,211,122,.95);
      font-size:13px; letter-spacing:.06em;
      text-align:left;
      padding:12px 12px;
      border-bottom:1px solid rgba(246,211,122,.25);
      white-space:nowrap;
    }
    tbody td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
      font-size:14px;
      color:rgba(236,236,236,.92);
    }
    tbody tr:hover td{background:rgba(255,255,255,.04)}
    .link{ color:var(--gold); text-decoration:none; border-bottom:1px dashed rgba(246,211,122,.45); white-space:nowrap; }
    .link:hover{filter:brightness(1.1)}
    .muted{color:rgba(236,236,236,.55)}
    .rowBtns{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}

    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
      line-height:1.6;
      flex:0 0 auto;
    }

    /* ===== Modal ===== */
    .mask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:100;
    }
    .modal{
      width:min(900px, 96vw);
      border-radius:22px;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      box-shadow:0 30px 90px rgba(0,0,0,.75);
      overflow:hidden;
      backdrop-filter:blur(10px);
    }
    .mHead{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .mTitle{
      font-weight:900;
      letter-spacing:.08em;
      color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.22);
    }
    .mBody{padding:14px 16px 16px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .span2{grid-column:span 2}
    @media (max-width:720px){
      .grid{grid-template-columns:1fr}
      .span2{grid-column:span 1}
      table{min-width:1200px}
    }
    .mFoot{
      padding:14px 16px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      border-top:1px solid rgba(255,255,255,.10);
      flex-wrap:wrap;
    }

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.55);
      color:rgba(236,236,236,.92);
      font-size:13px;
      box-shadow:var(--shadow);
      display:none;
      z-index:200;
      backdrop-filter:blur(10px);
    }

    /* ✅ Modal 內「新增…」小輸入框（玻璃金邊） */
    .addBox{
      display:none;
      margin-top:8px;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(246,211,122,.32);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:0 14px 35px rgba(0,0,0,.45);
      backdrop-filter:blur(10px);
    }
    .addRow{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .addRow input{
      flex:1;
      padding:9px 10px;
      border-radius:12px;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.18);
    }

    /* ✅ 旁邊加「＋」按鈕（不破壞 UI、同玻璃金邊） */
    .selPlus{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .selPlus select{flex:1}
    .plusBtn{
      appearance:none;
      width:44px;
      height:44px;
      border-radius:14px;
      border:1px solid rgba(246,211,122,.40);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:0 10px 22px rgba(0,0,0,.35);
      color:var(--gold);
      cursor:pointer;
      font-family:inherit;
      font-weight:900;
      font-size:18px;
      line-height:1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition:transform .12s ease, filter .12s ease;
      user-select:none;
    }
    .plusBtn:hover{transform:translateY(-1px); filter:brightness(1.06)}
    .plusBtn:active{transform:translateY(0); filter:brightness(.98)}
    .plusBtn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
      filter:none;
    }

    /* ===== Login Modal（共用）===== */
    .loginMask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.68);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:999;
    }
    .loginMask.show{display:flex;}
    .loginModal{
      width:min(520px, 96vw);
      border-radius:22px;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow:0 30px 90px rgba(0,0,0,.78);
      overflow:hidden;
      backdrop-filter:blur(12px);
    }
    .loginHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .loginTitle{
      font-weight:900; letter-spacing:.08em;
      color:var(--gold);
      text-shadow:0 0 18px rgba(246,211,122,.22);
    }
    .loginBody{padding:14px 16px 10px;}
    .loginFoot{
      padding:12px 16px;
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .loginErr{
      margin-top:10px;
      color:rgba(255,190,190,.95);
      font-size:13px;
      line-height:1.5;
      display:none;
      white-space:pre-wrap;
    }
    .loginHint{
      margin-top:10px;
      color:rgba(236,236,236,.65);
      font-size:12px;
      line-height:1.6;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="nav-left">
        <div class="nav-desktop">
          <button class="btn ghost small" id="navHome">返回首頁</button>
          <button class="btn ghost small" id="navReg">資料明細表登錄</button>
          <button class="btn ghost small" id="navQuery">資料明細表查詢</button>
          <button class="btn ghost small" id="navBackXidong">返回汐東工程管理表</button>
        </div>

        <div class="nav-mobile">
          <button class="btn ghost small" id="mBack">返回</button>
          <div class="moreWrap">
            <button class="btn ghost small" id="mMoreBtn" type="button">更多 ▾</button>
            <div class="moreMenu" id="mMoreMenu" role="menu" aria-label="更多選單">
              <button class="menuItem" data-href="index.html" type="button">返回首頁</button>
              <button class="menuItem" data-href="汐東工程管理表.html" type="button">返回汐東工程管理表</button>

              <div class="menuSep"></div>
              <button class="menuItem" data-href="捷運汐止東湖線統包工程-資料明細表登錄.html" type="button">資料明細表登錄</button>
              <button class="menuItem" data-href="捷運汐止東湖線統包工程-資料明細表查詢.html" type="button">資料明細表查詢</button>
            </div>
          </div>
        </div>
      </div>

      <div class="brand">
        <div class="title">捷運汐止東湖線統包工程-資料明細表</div>
        <div class="sub">項次 · 文件名稱 · 工種 · 系統 · 登錄日期 · 電子檔 · 備註</div>
      </div>

      <div class="right">
        <div class="pill">使用者：<b id="uName">—</b></div>
        <div class="pill">權限：<b id="uRole">—</b></div>
      </div>
    </div>

    <div class="panel">
      <div class="controls">
        <div class="field">
          <div class="label">搜尋（文件名稱 / 工種 / 系統 / 備註 / 連結）</div>
          <input id="q" placeholder="例如：施工圖、材料、機電、電氣、混凝土..." />
        </div>

        <div class="field">
          <div class="label">工種</div>
          <select id="fTrade"><option value="">全部</option></select>
        </div>
        <div class="field">
          <div class="label">系統</div>
          <select id="fSys"><option value="">全部</option></select>
        </div>

        <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
          <button class="btn ghost" id="btnClear">清除條件</button>
        </div>
      </div>

      <!-- ✅ 只有這裡可捲動 -->
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:90px;">項次</th>
              <th style="width:320px;">文件名稱</th>
              <th style="width:170px;">工種</th>
              <th style="width:170px;">系統</th>
              <th style="width:140px;">登錄日期</th>
              <th style="width:110px;">電子檔</th>
              <th style="min-width:260px;">備註</th>
              <th style="width:180px;">操作</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="hint" id="hint"></div>
    </div>
  </div>

  <!-- View/Edit Modal -->
  <div class="mask" id="mask">
    <div class="modal">
      <div class="mHead">
        <div class="mTitle" id="mTitle">查看資料</div>
        <button class="btn ghost small" id="btnClose" type="button">關閉</button>
      </div>
      <div class="mBody">
        <div class="grid">
          <div class="field">
            <div class="label">項次（自動）</div>
            <input id="mNo" disabled />
          </div>
          <div class="field">
            <div class="label">登錄日期</div>
            <input id="mDate" type="date" />
          </div>

          <div class="field span2">
            <div class="label">文件名稱</div>
            <input id="mName" placeholder="例如：電氣系統施工圖（核准版）" />
          </div>

          <div class="field">
            <div class="label">工種</div>
            <div class="selPlus">
              <select id="mTrade"></select>
              <button class="plusBtn" id="mTradePlus" type="button" title="新增工種">＋</button>
            </div>

            <div class="addBox" id="addTradeBox" aria-hidden="true">
              <div class="addRow">
                <input id="addTradeInput" placeholder="輸入新工種…" />
                <button class="btn ghost small" id="addTradeCancel" type="button">取消</button>
                <button class="btn small" id="addTradeOk" type="button">加入</button>
              </div>
            </div>
          </div>

          <div class="field">
            <div class="label">系統</div>
            <div class="selPlus">
              <select id="mSys"></select>
              <button class="plusBtn" id="mSysPlus" type="button" title="新增系統">＋</button>
            </div>

            <div class="addBox" id="addSysBox" aria-hidden="true">
              <div class="addRow">
                <input id="addSysInput" placeholder="輸入新系統…" />
                <button class="btn ghost small" id="addSysCancel" type="button">取消</button>
                <button class="btn small" id="addSysOk" type="button">加入</button>
              </div>
            </div>
          </div>

          <div class="field span2">
            <div class="label">電子檔（網址）</div>
            <input id="mUrl" type="url" placeholder="https://..." />
          </div>

          <div class="field span2">
            <div class="label">備註</div>
            <textarea id="mNote" placeholder="可輸入文字備註..."></textarea>
          </div>
        </div>
      </div>
      <div class="mFoot">
        <button class="btn danger" id="btnDelete" style="display:none;" type="button">刪除</button>
        <button class="btn ghost" id="btnCancel" type="button">取消</button>
        <button class="btn" id="btnSave" type="button">儲存</button>
      </div>
    </div>
  </div>

  <!-- Login Modal（共用） -->
  <div class="loginMask" id="loginMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="登入">
      <div class="loginHead">
        <div class="loginTitle">登入</div>
        <button class="btn ghost small" id="loginClose" type="button">關閉</button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label">帳號</div>
          <select id="loginUser" autocomplete="username">
            <option value="">請選擇帳號</option>
          </select>
        </div>
        <div class="field" style="margin-top:10px;">
          <div class="label">密碼</div>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="請輸入密碼" />
        </div>
        <div class="loginErr" id="loginErr"></div>
        <div class="loginHint">
          登入帳密完全以「權限表.html」的權限表（localStorage: <b>tasunAuthTable_v1</b>）為準。
        </div>
      </div>
      <div class="loginFoot">
        <button class="btn ghost" id="loginToAuth" type="button">前往權限表</button>
        <button class="btn" id="loginBtn" type="button">登入</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const CURRENT_KEY = "tasunCurrentUser_v1";
    const AUTH_KEY = "tasunAuthTable_v1";

    // ✅ 本頁資料庫 Keys（獨立於工程資料明細表）
    const DB_KEY = "tasunSxdhDetail_v1";

    // ✅「新增…」選項固定值
    const ADD_VALUE = "__add__";

    let currentUser = null;
    let db = [];
    let editingId = null;
    let _watchStarted = false;

    const $ = (id) => document.getElementById(id);
    const norm = (s) => (s ?? "").toString().trim();

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.style.display = "none", 2200);
    }

    function escHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // ✅ 站內導頁：自動附加 ?v=APP_VER（配合 head 的 APP_VER 強制同步）
    function go(href){
      const h = (typeof window.__withV === "function") ? window.__withV(href) : href;
      location.href = h;
    }

    // ===== Auth Table (唯一真相來源) =====
    function mapRole(v){
      const s=(v??"").toString().trim().toLowerCase();
      if(!s) return "read";
      if(s==="admin") return "admin";
      if(s==="write"||s==="edit") return "write";
      if(s==="read"||s==="view") return "read";
      if(s==="0") return "admin";
      if(s==="1") return "write";
      if(s==="2") return "read";
      return s;
    }

    function loadAuthTable(){
      try{
        const raw = localStorage.getItem(AUTH_KEY);
        if(!raw) return [];
        const parsed = JSON.parse(raw);
        if(Array.isArray(parsed)) return parsed;
        if(parsed && Array.isArray(parsed.users)) return parsed.users;
        return [];
      }catch(e){ return []; }
    }

    function pickUsername(row){ return norm(row?.username ?? row?.user ?? row?.account ?? row?.name); }
    function pickPassword(row){ return (row?.password ?? row?.pass ?? row?.pwd ?? "").toString(); }
    function pickRole(row){ return mapRole(row?.role ?? row?.level ?? row?.perm ?? row?.permission); }

    function findAuthUser(username){
      const u = norm(username).toLowerCase();
      if(!u) return null;
      const rows = loadAuthTable();
      for(const r of rows){
        const ru = pickUsername(r).toLowerCase();
        if(ru && ru===u){
          return { user: pickUsername(r), pass: pickPassword(r), role: pickRole(r) || "read" };
        }
      }
      return null;
    }

    function loadCurrentUser(){
      try{ currentUser = JSON.parse(localStorage.getItem(CURRENT_KEY) || "null"); }
      catch(e){ currentUser = null; }

      if(currentUser && typeof currentUser==="object"){
        const uname = norm(currentUser.user ?? currentUser.username ?? currentUser.account ?? currentUser.name);
        if(uname){
          currentUser.user = uname;
          currentUser.username = uname;
        }
        currentUser.role = mapRole(currentUser.role ?? currentUser.level ?? "read");
        currentUser.level = currentUser.role;
        currentUser.authStamp = (currentUser.authStamp ?? "").toString();
      }
    }

    function setCurrentUser(user, role, authStamp){
      const obj = {
        user,
        username: user,
        role: mapRole(role),
        level: mapRole(role),
        authStamp: (authStamp || "").toString()
      };
      localStorage.setItem(CURRENT_KEY, JSON.stringify(obj));
      currentUser = obj;
    }

    function role(){ return mapRole(currentUser?.role ?? currentUser?.level ?? "read"); }
    function canWrite(){ const r=role(); return r==="admin" || r==="write"; }
    function isAdmin(){ return role()==="admin"; }

    // ===== Session Watch Patch =====
    const SESSION_WATCH_MS = 3000;

    function fnv1a(str){
      let h = 0x811c9dc5;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 0x01000193);
      }
      return (h >>> 0).toString(16).padStart(8, "0");
    }
    function authStampFromAuth(auth){
      return fnv1a(`${auth.user}|${auth.pass ?? ""}`);
    }

    function rebuildUserDropdown(preselectUser){
      const sel = $("loginUser");
      const rows = loadAuthTable();
      const users = rows.map(r => pickUsername(r)).filter(Boolean);

      const seen = new Set();
      const uniq = [];
      for(const u of users){
        const k = u.toLowerCase();
        if(seen.has(k)) continue;
        seen.add(k);
        uniq.push(u);
      }

      sel.innerHTML = `<option value="">請選擇帳號</option>` + uniq.map(u=>{
        const s = (preselectUser && u.toLowerCase() === preselectUser.toLowerCase()) ? "selected" : "";
        return `<option value="${escHtml(u)}" ${s}>${escHtml(u)}</option>`;
      }).join("");
    }

    function openLoginModal(msg){
      $("loginErr").style.display="none";
      if(msg){
        $("loginErr").textContent = msg;
        $("loginErr").style.display="block";
      }
      loadCurrentUser();
      rebuildUserDropdown(currentUser?.user || "");

      $("loginPass").value="";
      $("loginMask").classList.add("show");
      $("loginMask").setAttribute("aria-hidden","false");
      setTimeout(()=>{
        if($("loginUser").value) $("loginPass").focus();
        else $("loginUser").focus();
      },0);
    }
    function closeLoginModal(){
      $("loginMask").classList.remove("show");
      $("loginMask").setAttribute("aria-hidden","true");
    }

    function forceReLogin(msg){
      try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}
      currentUser = null;
      toast(msg || "權限表已更新，請重新登入");
      openLoginModal(msg || "權限表已更新，請重新登入");
      $("uName").textContent="—";
      $("uRole").textContent="—";
    }

    function validateSession(){
      const lm = $("loginMask");
      if(lm && lm.classList.contains("show")) return;

      loadCurrentUser();
      if(!currentUser || !currentUser.user) return;

      const auth = findAuthUser(currentUser.user);
      if(!auth){ forceReLogin("帳號已被移除，請重新登入"); return; }

      const stampNow = authStampFromAuth(auth);

      if(!currentUser.authStamp){
        setCurrentUser(auth.user, auth.role || "read", stampNow);
        $("uName").textContent = auth.user;
        $("uRole").textContent = role();
        return;
      }

      if(currentUser.authStamp !== stampNow){
        forceReLogin("密碼已更新，請重新登入");
        return;
      }

      const r = auth.role || "read";
      if(mapRole(currentUser.role) !== r){
        setCurrentUser(auth.user, r, stampNow);
        $("uRole").textContent = r;
      }
    }

    function startSessionWatch(){
      if(_watchStarted) return;
      _watchStarted = true;

      window.addEventListener("storage", (e)=>{
        if(e.key === AUTH_KEY || e.key === CURRENT_KEY) validateSession();
        if(e.key === DB_KEY){
          loadDB();
          render();
        }
      });

      setInterval(validateSession, SESSION_WATCH_MS);
    }

    function ensureLoggedIn(){
      loadCurrentUser();
      const rows = loadAuthTable();
      if(!Array.isArray(rows) || rows.length === 0){
        openLoginModal("尚未建立權限表：請先到「權限表.html」建立帳號。");
        return false;
      }

      if(!currentUser || !currentUser.user){
        openLoginModal();
        return false;
      }

      const auth = findAuthUser(currentUser.user);
      if(!auth){ forceReLogin("帳號已被移除，請重新登入"); return false; }

      const stampNow = authStampFromAuth(auth);
      if(currentUser.authStamp && currentUser.authStamp !== stampNow){
        forceReLogin("密碼已更新，請重新登入");
        return false;
      }

      setCurrentUser(auth.user, auth.role || "read", stampNow);
      $("uName").textContent = auth.user;
      $("uRole").textContent = role();
      return true;
    }

    function doLogin(){
      const u = norm($("loginUser").value);
      const p = ($("loginPass").value ?? "").toString();
      const rows = loadAuthTable();

      if(!Array.isArray(rows) || rows.length === 0){
        $("loginErr").textContent = "尚未建立權限表：請先到「權限表.html」建立帳號。";
        $("loginErr").style.display = "block";
        return;
      }
      if(!u){
        $("loginErr").textContent = "請先選擇帳號。";
        $("loginErr").style.display = "block";
        return;
      }
      if(!p){
        $("loginErr").textContent = "請輸入密碼。";
        $("loginErr").style.display = "block";
        return;
      }

      const auth = findAuthUser(u);
      if(!auth){
        $("loginErr").textContent = "帳號不存在（以權限表為準）。";
        $("loginErr").style.display = "block";
        return;
      }
      if((auth.pass ?? "") !== p){
        $("loginErr").textContent = "密碼錯誤（以權限表為準）。";
        $("loginErr").style.display = "block";
        return;
      }

      const stampNow = authStampFromAuth(auth);
      setCurrentUser(auth.user, auth.role || "read", stampNow);

      closeLoginModal();
      toast("登入成功");
      start();
    }

    // ===== Data =====
    function loadDB(){
      try{
        const raw = localStorage.getItem(DB_KEY);
        db = raw ? JSON.parse(raw) : [];
        if(!Array.isArray(db)) db = [];
      }catch(e){ db = []; }
    }
    function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }

    function uniqueOptions(field){
      const set = new Set();
      for(const r of db){
        const v = norm(r?.[field]);
        if(v) set.add(v);
      }
      const arr = Array.from(set);
      arr.sort((a,b)=> a.localeCompare(b,"zh-Hant"));
      return arr;
    }

    function fillSelect(sel, opts, keep, firstLabel, withAdd){
      if(!sel) return;

      const first = `<option value="">${escHtml(firstLabel || "全部")}</option>`;
      const addOpt = withAdd ? `<option value="${ADD_VALUE}">新增…</option>` : "";

      sel.innerHTML =
        first +
        opts.map(v=>`<option value="${escHtml(v)}">${escHtml(v)}</option>`).join("") +
        addOpt;

      if(keep && opts.includes(keep)){
        sel.value = keep;
      }else if(keep && !opts.includes(keep) && keep !== ADD_VALUE){
        const op = document.createElement("option");
        op.value = keep;
        op.textContent = keep;

        const addNode = Array.from(sel.options).find(op => op.value === ADD_VALUE);
        if(addNode) sel.insertBefore(op, addNode);
        else sel.appendChild(op);

        sel.value = keep;
      }else{
        sel.value = "";
      }
    }

    function rebuildFilters(){
      const sys = uniqueOptions("system");
      const tr  = uniqueOptions("trade");

      const sSel = $("fSys");
      const tSel = $("fTrade");

      const keepS = norm(sSel.value);
      const keepT = norm(tSel.value);

      fillSelect(tSel, tr,  keepT, "全部", false);
      fillSelect(sSel, sys, keepS, "全部", false);

      const mTrade = $("mTrade");
      const mSys   = $("mSys");
      const keepMT = norm(mTrade?.value);
      const keepMS = norm(mSys?.value);

      fillSelect(mTrade, tr,  keepMT, "請選擇工種", true);
      fillSelect(mSys,   sys, keepMS, "請選擇系統", true);
    }

    function filteredRows(){
      const q = norm($("q").value).toLowerCase();
      const sys = norm($("fSys").value);
      const tr  = norm($("fTrade").value);

      let rows = db.slice();
      if(sys) rows = rows.filter(r => norm(r.system) === sys);
      if(tr)  rows = rows.filter(r => norm(r.trade) === tr);

      if(q){
        rows = rows.filter(r => {
          const hay = [r.id, r.docName, r.trade, r.system, r.regDate, r.fileUrl, r.note]
            .map(x => (x ?? "").toString().toLowerCase()).join(" | ");
          return hay.includes(q);
        });
      }

      rows.sort((a,b)=>{
        const ai = Number(a?.id);
        const bi = Number(b?.id);
        const aOk = Number.isFinite(ai);
        const bOk = Number.isFinite(bi);

        if(aOk && bOk) return ai - bi;
        if(aOk && !bOk) return -1;
        if(!aOk && bOk) return 1;
        return norm(a?.id).localeCompare(norm(b?.id), "zh-Hant", { numeric:true, sensitivity:"base" });
      });

      return rows;
    }

    function shortNote(s){
      const t = norm(s);
      if(!t) return "";
      return t.length > 80 ? (t.slice(0,80) + "…") : t;
    }

    function render(){
      rebuildFilters();

      const rows = filteredRows();
      const writable = canWrite();

      $("tbody").innerHTML = rows.map(r=>{
        const url = norm(r.fileUrl);
        const linkCell = url
          ? `<a class="link" href="${escHtml(url)}" target="_blank" rel="noopener">開啟</a>`
          : `<span class="muted">—</span>`;

        const noteCell = norm(r.note) ? escHtml(shortNote(r.note)) : `<span class="muted">—</span>`;

        return `
          <tr>
            <td>${escHtml(r.id)}</td>
            <td>${escHtml(r.docName)}</td>
            <td>${escHtml(r.trade) || `<span class="muted">—</span>`}</td>
            <td>${escHtml(r.system) || `<span class="muted">—</span>`}</td>
            <td>${escHtml(r.regDate || "") || `<span class="muted">—</span>`}</td>
            <td>${linkCell}</td>
            <td>${noteCell}</td>
            <td>
              <div class="rowBtns">
                <button class="btn ghost small" data-act="view" data-id="${r.id}">查看</button>
                ${writable ? `<button class="btn small" data-act="edit" data-id="${r.id}">編輯</button>` : ``}
              </div>
            </td>
          </tr>
        `;
      }).join("") || `
        <tr>
          <td colspan="8" class="muted" style="padding:18px;">尚無資料（可用「資料明細表登錄」建立第一筆）</td>
        </tr>
      `;

      $("hint").innerHTML =
        `目前為 <b style="color:var(--gold)">${writable ? "可維護模式" : "唯讀模式"}</b>（role: ${escHtml(role())}）。` +
        ` 筆數：<b style="color:var(--gold)">${rows.length}</b>。`;
    }

    function setModalEditable(editable){
      $("btnSave").style.display = editable ? "inline-block" : "none";
      $("btnDelete").style.display = (editable && isAdmin() && editingId != null) ? "inline-block" : "none";

      ["mDate","mName","mTrade","mSys","mUrl","mNote"].forEach(id=>{
        if($(id)) $(id).disabled = !editable;
      });

      ["mTradePlus","mSysPlus"].forEach(id=>{
        if($(id)) $(id).disabled = !editable;
      });

      ["addTradeInput","addSysInput","addTradeOk","addSysOk","addTradeCancel","addSysCancel"].forEach(id=>{
        if($(id)) $(id).disabled = !editable;
      });
    }

    function hideAddBox(kind){
      if(kind==="trade"){
        $("addTradeBox").style.display = "none";
        $("addTradeBox").setAttribute("aria-hidden","true");
        $("addTradeInput").value = "";
      }else{
        $("addSysBox").style.display = "none";
        $("addSysBox").setAttribute("aria-hidden","true");
        $("addSysInput").value = "";
      }
    }

    function showAddBox(kind){
      if(kind==="trade"){
        $("addTradeBox").style.display = "block";
        $("addTradeBox").setAttribute("aria-hidden","false");
        $("addTradeInput").value = "";
        setTimeout(()=> $("addTradeInput").focus(), 0);
      }else{
        $("addSysBox").style.display = "block";
        $("addSysBox").setAttribute("aria-hidden","false");
        $("addSysInput").value = "";
        setTimeout(()=> $("addSysInput").focus(), 0);
      }
    }

    function addOptionToSelect(sel, value){
      const v = norm(value);
      if(!v) return false;

      const exists = Array.from(sel.options).some(op => norm(op.value) === v);
      if(!exists){
        const op = document.createElement("option");
        op.value = v;
        op.textContent = v;

        const addNode = Array.from(sel.options).find(op => op.value === ADD_VALUE);
        if(addNode) sel.insertBefore(op, addNode);
        else sel.appendChild(op);
      }
      sel.value = v;
      sel.dataset.prev = v;
      return true;
    }

    function bindModalAddUI(){
      const mTrade = $("mTrade");
      const mSys   = $("mSys");

      $("mTradePlus").onclick = ()=>{
        if(mTrade.disabled) return;
        mTrade.dataset.prev = (mTrade.value ?? "").toString();
        showAddBox("trade");
      };
      $("mSysPlus").onclick = ()=>{
        if(mSys.disabled) return;
        mSys.dataset.prev = (mSys.value ?? "").toString();
        showAddBox("sys");
      };

      mTrade.addEventListener("change", ()=>{
        if(mTrade.value === ADD_VALUE){
          showAddBox("trade");
        }else{
          hideAddBox("trade");
          mTrade.dataset.prev = (mTrade.value ?? "").toString();
        }
      });

      mSys.addEventListener("change", ()=>{
        if(mSys.value === ADD_VALUE){
          showAddBox("sys");
        }else{
          hideAddBox("sys");
          mSys.dataset.prev = (mSys.value ?? "").toString();
        }
      });

      $("addTradeCancel").onclick = ()=>{
        const prev = (mTrade.dataset.prev ?? "").toString();
        hideAddBox("trade");
        mTrade.value = prev;
      };
      $("addSysCancel").onclick = ()=>{
        const prev = (mSys.dataset.prev ?? "").toString();
        hideAddBox("sys");
        mSys.value = prev;
      };

      $("addTradeOk").onclick = ()=>{
        const v = norm($("addTradeInput").value);
        if(!v){ toast("工種不可空白"); $("addTradeInput").focus(); return; }
        if(addOptionToSelect(mTrade, v)){
          hideAddBox("trade");
          toast("已加入工種");
        }
      };
      $("addSysOk").onclick = ()=>{
        const v = norm($("addSysInput").value);
        if(!v){ toast("系統不可空白"); $("addSysInput").focus(); return; }
        if(addOptionToSelect(mSys, v)){
          hideAddBox("sys");
          toast("已加入系統");
        }
      };

      $("addTradeInput").addEventListener("keydown",(e)=>{
        if(e.key==="Enter"){ e.preventDefault(); $("addTradeOk").click(); }
        if(e.key==="Escape"){ e.preventDefault(); $("addTradeCancel").click(); }
      });
      $("addSysInput").addEventListener("keydown",(e)=>{
        if(e.key==="Enter"){ e.preventDefault(); $("addSysOk").click(); }
        if(e.key==="Escape"){ e.preventDefault(); $("addSysCancel").click(); }
      });
    }

    function openModal(id, editable){
      validateSession();
      if(!currentUser || !currentUser.user){
        openLoginModal();
        return;
      }

      // ✅ 修正：先載入最新 db，再找資料（避免偶發找不到）
      loadDB();
      rebuildFilters();

      const item = db.find(x => Number(x.id) === Number(id)) || null;
      if(!item){ toast("找不到資料"); return; }

      editingId = Number(item.id);

      $("mTitle").textContent = editable ? "編輯資料" : "查看資料";
      setModalEditable(editable);

      $("mNo").value = String(item.id);
      $("mDate").value = item?.regDate || new Date().toISOString().slice(0,10);
      $("mName").value = item?.docName || "";

      $("mTrade").value = norm(item?.trade) || "";
      $("mSys").value   = norm(item?.system) || "";

      $("mTrade").dataset.prev = ($("mTrade").value ?? "").toString();
      $("mSys").dataset.prev   = ($("mSys").value ?? "").toString();

      hideAddBox("trade");
      hideAddBox("sys");

      $("mUrl").value = item?.fileUrl || "";
      $("mNote").value = item?.note || "";

      $("mask").style.display = "flex";
    }

    function closeModal(){
      $("mask").style.display = "none";
      editingId = null;
      hideAddBox("trade");
      hideAddBox("sys");
    }

    function saveItem(){
      validateSession();
      if(!currentUser || !currentUser.user){
        openLoginModal();
        return;
      }
      if(!canWrite()){ toast("唯讀權限不可儲存"); return; }
      if(editingId == null){ toast("未指定編輯項次"); return; }

      const docName = norm($("mName").value);
      if(!docName){ toast("文件名稱不可空白"); $("mName").focus(); return; }

      const trade  = norm($("mTrade").value);
      const system = norm($("mSys").value);

      if(trade === ADD_VALUE){ toast("請先完成新增工種或改選其他工種"); $("mTrade").focus(); return; }
      if(system === ADD_VALUE){ toast("請先完成新增系統或改選其他系統"); $("mSys").focus(); return; }

      if(!trade){ toast("工種不可空白"); $("mTrade").focus(); return; }
      if(!system){ toast("系統不可空白"); $("mSys").focus(); return; }

      const fileUrl = norm($("mUrl").value);
      const regDate = norm($("mDate").value) || new Date().toISOString().slice(0,10);
      const note    = norm($("mNote").value);

      const idx = db.findIndex(x => Number(x.id) === Number(editingId));
      if(idx < 0){ toast("找不到資料"); return; }

      db[idx] = { id: editingId, docName, system, trade, regDate, fileUrl, note };
      saveDB();

      closeModal();
      render();
      toast("已儲存");
    }

    function deleteItem(){
      validateSession();
      if(!currentUser || !currentUser.user){
        openLoginModal();
        return;
      }
      if(!isAdmin()){ toast("僅 admin 可刪除"); return; }
      if(editingId == null) return;

      if(!confirm("確定刪除這筆資料？")) return;

      db = db.filter(x => Number(x.id) !== Number(editingId));
      saveDB();

      closeModal();
      render();
      toast("已刪除");
    }

    function setupMoreMenu(backHref){
      const backBtn = $("mBack");
      const moreBtn = $("mMoreBtn");
      const menu = $("mMoreMenu");

      const close = ()=> menu.classList.remove("open");
      const toggle = (e)=>{
        e.preventDefault();
        e.stopPropagation();
        menu.classList.toggle("open");
      };

      backBtn.onclick = ()=> go(backHref);
      moreBtn.addEventListener("click", toggle);

      menu.addEventListener("click", (e)=>{
        e.stopPropagation();
        const item = e.target.closest("button.menuItem[data-href]");
        if(!item) return;
        const href = item.getAttribute("data-href");
        if(href) go(href);
      });

      document.addEventListener("click", close);
      window.addEventListener("keydown", (e)=>{ if(e.key === "Escape") close(); });
    }

    function refreshOptionsNow(){
      loadDB();
      rebuildFilters();
    }

    function bindSelectAutoRefresh(){
      const ids = ["fTrade","fSys","mTrade","mSys"];
      const evs = ["pointerdown","mousedown","focus"];
      ids.forEach(id=>{
        const el = $(id);
        if(!el) return;
        evs.forEach(ev=>{
          el.addEventListener(ev, ()=>{
            el.dataset.prev = (el.value ?? "").toString();
            try{ refreshOptionsNow(); }catch(e){}
          }, { passive:true });
        });
      });
    }

    const DB_WATCH_MS = 1500;
    function startDBWatch(){
      let lastRaw = null;
      setInterval(()=>{
        const raw = localStorage.getItem(DB_KEY) || "";
        if(raw !== lastRaw){
          lastRaw = raw;
          loadDB();
          render();
        }
      }, DB_WATCH_MS);
    }

    function start(){
      if(!ensureLoggedIn()) return;

      loadDB();

      $("navHome").onclick = () => go("index.html");
      $("navReg").onclick  = () => go("捷運汐止東湖線統包工程-資料明細表登錄.html");
      $("navQuery").onclick= () => go("捷運汐止東湖線統包工程-資料明細表查詢.html");
      $("navBackXidong").onclick = () => go("汐東工程管理表.html");

      setupMoreMenu("index.html");

      bindSelectAutoRefresh();
      bindModalAddUI();
      startDBWatch();

      $("q").addEventListener("input", render);
      $("fSys").addEventListener("change", render);
      $("fTrade").addEventListener("change", render);
      $("btnClear").onclick = () => {
        $("q").value = "";
        $("fSys").value = "";
        $("fTrade").value = "";
        render();
      };

      $("btnClose").onclick = closeModal;
      $("btnCancel").onclick = closeModal;
      $("mask").addEventListener("click", (e)=>{ if(e.target === $("mask")) closeModal(); });

      $("btnSave").onclick = saveItem;
      $("btnDelete").onclick = deleteItem;

      $("tbody").addEventListener("click", (e)=>{
        const btn = e.target.closest("button[data-act]");
        if(!btn) return;
        const act = btn.getAttribute("data-act");
        const id = Number(btn.getAttribute("data-id"));
        if(!Number.isFinite(id)) return;

        if(act === "view") openModal(id, false);
        if(act === "edit"){
          if(!canWrite()){ toast("唯讀權限不可編輯"); return; }
          openModal(id, true);
        }
      });

      window.addEventListener("keydown", (e)=>{
        if(e.key === "Escape" && $("mask").style.display === "flex") closeModal();
      });

      render();
    }

    (function bindLogin(){
      $("loginClose").onclick = closeLoginModal;
      $("loginToAuth").onclick = ()=> go("權限表.html");
      $("loginBtn").onclick = doLogin;

      $("loginMask").addEventListener("click",(e)=>{
        if(e.target === $("loginMask")) closeLoginModal();
      });

      window.addEventListener("keydown",(e)=>{
        if(e.key === "Escape" && $("loginMask").classList.contains("show")) closeLoginModal();
        if(e.key === "Enter" && $("loginMask").classList.contains("show")) doLogin();
      });

      $("loginUser").addEventListener("change", ()=>{
        if($("loginUser").value) $("loginPass").focus();
      });
    })();

    startSessionWatch();
    start();
  </script>
</body>
</html>
