<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>捷運汐東線事項記錄 · Tasun</title>

  <!-- ✅ 合併新增：自動轉址到「汐東工程管理表.html」
       - 預設會轉址（保留 v 參數與 hash）
       - 如需查看本頁原內容：在網址加 ?legacy=1 -->
  <script>
    (function(){
      try{
        const u = new URL(location.href);
        if (u.searchParams.get("legacy") === "1") return;

        const target = new URL("汐東工程管理表.html", document.baseURI);
        const v = u.searchParams.get("v");
        if (v) target.searchParams.set("v", v);
        target.hash = u.hash || "";

        location.replace(target.toString());
      }catch(e){
        location.replace("汐東工程管理表.html");
      }
    })();
  </script>

  <noscript>
    <meta http-equiv="refresh" content="0;url=汐東工程管理表.html">
  </noscript>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#070809;
      --bg1:#0b0d10;

      --gold:#f6d37a;
      --goldDeep:#e2ad44;                 /* ✅ 深金（更銳） */
      --gold2:rgba(246,211,122,.55);

      --border:rgba(246,211,122,.30);
      --border2:rgba(246,211,122,.46);

      --text:#ececec;
      --muted:rgba(236,236,236,.70);

      --shadow:0 18px 50px rgba(0,0,0,.55);
      --r:18px;

      --stageSide: clamp(8px, 1.6vw, 34px);

      --ctrl-bg: rgba(0,0,0,.42);
      --ctrl-bd: rgba(255,255,255,.18);
      --ctrl-bd-focus: rgba(246,211,122,.68);

      /* ===================== ✅ 黃水晶 3D（穩、不洗字） ===================== */
      --gold-crystal: linear-gradient(180deg,
        rgba(255,255,255,0.96) 0%,
        rgba(255,248,220,0.93) 12%,
        rgba(255,228,160,0.93) 28%,
        rgba(246,211,122,1.00) 52%,
        rgba(232,162,62,0.96) 72%,
        rgba(255,232,186,0.92) 100%);

      --crystal-stroke: rgba(96, 52, 16, 0.82); /* ✅ 描邊更穩 */
      --crystal-deep: rgba(0,0,0,0.66);         /* ✅ 陰影更聚焦 */
      --crystal-deep2: rgba(0,0,0,0.36);
      --crystal-glow1: rgba(246,211,122,0.20);  /* ✅ glow 再收斂：不洗字 */
      --crystal-glow2: rgba(246,211,122,0.10);
      --crystal-hi: rgba(255,255,255,0.16);

      /* ✅ 表頭背景 */
      --th-bg1: rgba(0,0,0,.64);
      --th-bg2: rgba(0,0,0,.40);

      /* ✅ 字體 */
      --uiFont: "Noto Serif TC", serif;
      --contentFont: "Noto Sans TC", "Noto Serif TC", serif;

      /* ===================== ✅ 兩支亮度滑桿變數（桌機預設） ===================== */
      --crystalPower: .62;   /* 一般欄位 */
      --notePower: .78;      /* 記事內容 */

      /* 上下限（不用改） */
      --crystalPowMin: .30;
      --crystalPowMax: .90;
      --notePowMin: .40;
      --notePowMax: .94;

      /* ✅ 柔亮保護（避免刺眼/洗字） */
      --softWhite: rgba(255,255,255,0.12);
      --softGold1: rgba(246,211,122,0.11);
      --softGold2: rgba(246,211,122,0.07);
    }

    /* ✅ 手機：稍柔一點（仍亮但不刺） */
    @media (max-width: 640px){
      :root{
        --crystalPower: .58;
        --notePower: .72;
        --softWhite: rgba(255,255,255,0.11);
        --softGold1: rgba(246,211,122,0.10);
        --softGold2: rgba(246,211,122,0.06);
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      color:var(--text);
      font-family:var(--uiFont);
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(246,211,122,.10), transparent 60%),
        radial-gradient(900px 520px at 85% 25%, rgba(246,211,122,.08), transparent 62%),
        radial-gradient(1100px 700px at 55% 85%, rgba(246,211,122,.06), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
      -webkit-font-smoothing: antialiased;
      text-rendering: geometricPrecision;
    }

    /* ==========================================================
       ✅ 水晶字：修正「兩層不重疊」(重點)
       - ::after 必須繼承 padding / font / line-height / letter-spacing / text-align
       - 否則在 th、button 這類有 padding 的元素會整段偏移
    ========================================================== */
    .crystalText{
      position:relative;
      line-height:1;                /* 表頭/按鍵層：乾淨俐落 */
      font-kerning: normal;
      letter-spacing:.06em;

      color: var(--goldDeep) !important;
      -webkit-text-fill-color: var(--goldDeep) !important;

      -webkit-text-stroke: 1.10px var(--crystal-stroke);

      text-shadow:
        0  1px 0   rgba(255,255,255,0.04),
        0  2px 3px var(--crystal-deep),
        0  8px 14px var(--crystal-deep2),
        0  0 10px var(--crystal-glow1),
        0  0 18px var(--crystal-glow2);

      -webkit-font-smoothing: antialiased;
      text-rendering: geometricPrecision;
      transform: translateZ(0);
    }
    /* ✅ span/b 等行內才需要 inline-block（避免 th/td 被破壞） */
    .crystalText:is(span,b,strong,a,em,i){
      display:inline-block;
    }

    @supports ((-webkit-background-clip: text) or (background-clip: text)) {
      .crystalText::after{
        content: attr(data-text);
        position:absolute;
        inset:0;
        pointer-events:none;
        z-index:2;

        /* ✅✅✅ 關鍵：繼承 padding / 字體 / 行高 / 字距 / 對齊 → 完全重疊 */
        padding: inherit;
        font: inherit;
        line-height: inherit;
        letter-spacing: inherit;
        text-align: inherit;
        white-space: inherit;
        box-sizing: border-box;
        border-radius: inherit;

        background-image: var(--gold-crystal);
        background-size: 100% 100%;
        background-repeat: no-repeat;

        -webkit-background-clip: text;
        background-clip: text;

        color: transparent;
        -webkit-text-fill-color: transparent;

        -webkit-text-stroke: 0;

        mix-blend-mode: normal;    /* ✅ 不用 screen：避免洗字 */
        opacity: .70;
        filter: saturate(1.08) brightness(1.03);

        text-shadow:
          0 0 4px var(--crystal-hi),
          0 0 10px rgba(246,211,122,0.14);
        transform: translateZ(0);
      }
    }

    /* ===================== ✅ 玻璃按鈕：更淡更透明，但字更深金更銳 ===================== */
    .btn{
      position:relative;
      overflow:hidden;
      appearance:none;
      border:1px solid rgba(246,211,122,.34);
      background:
        radial-gradient(120% 160% at 16% 18%, rgba(255,255,255,.075), rgba(255,255,255,0) 55%),
        radial-gradient(120% 160% at 80% 70%, rgba(246,211,122,.040), rgba(0,0,0,0) 72%),
        linear-gradient(180deg, rgba(255,255,255,.040), rgba(0,0,0,.14));  /* ✅ 更淡玻璃 */
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-family:inherit;
      font-weight:900;
      letter-spacing:.06em;
      box-shadow:
        0 14px 28px rgba(0,0,0,.38),
        0 0 18px rgba(246,211,122,.08),
        inset 0 0 0 1px rgba(255,255,255,.05);
      transition:transform .12s ease, filter .12s ease, border-color .12s ease;
      user-select:none;
      white-space:nowrap;
      backdrop-filter: blur(7px) saturate(1.08);
      -webkit-backdrop-filter: blur(7px) saturate(1.08);
      -webkit-tap-highlight-color: transparent;
    }
    .btn::before{
      content:"";
      position:absolute; inset:-35%;
      pointer-events:none;
      opacity:.08;                 /* ✅ 亮膜更小更弱：不洗字 */
      background:
        conic-gradient(from 110deg at 50% 50%,
          rgba(255,255,255,0.00) 0deg,
          rgba(255,255,255,0.08) 80deg,
          rgba(246,211,122,0.06) 150deg,
          rgba(255,255,255,0.00) 240deg,
          rgba(255,255,255,0.06) 320deg,
          rgba(255,255,255,0.00) 360deg);
      filter: blur(9px);
      mix-blend-mode: screen;
      transform: translateZ(0);
    }
    .btn::after{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      opacity:.22;
      background:
        radial-gradient(ellipse at 50% 0%,
          rgba(255,255,255,0.10) 0%,
          rgba(255,255,255,0.00) 58%),
        radial-gradient(ellipse at 50% 70%,
          rgba(0,0,0,0.26) 0%,
          rgba(0,0,0,0.00) 74%);
      mix-blend-mode: normal;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.04); border-color:rgba(255,235,180,.72)}
    .btn:active{transform:translateY(0); filter:brightness(.99)}

    .btn.ghost{
      background:
        radial-gradient(120% 160% at 16% 18%, rgba(255,255,255,.060), rgba(255,255,255,0) 55%),
        linear-gradient(180deg, rgba(255,255,255,.028), rgba(0,0,0,.12));
      border:1px solid rgba(255,255,255,.16);
    }
    .btn.danger{
      border-color:rgba(255,120,120,.45);
      background:
        radial-gradient(120% 160% at 16% 18%, rgba(255,255,255,.06), rgba(255,255,255,0) 55%),
        linear-gradient(180deg, rgba(255,120,120,.14), rgba(0,0,0,.16));
      color:rgba(255,170,170,.95);
      text-shadow:0 10px 18px rgba(0,0,0,0.60);
      -webkit-text-stroke: 0;
    }
    .small{padding:8px 10px; font-size:12px; border-radius:999px; letter-spacing:.04em}
    .btn[disabled]{opacity:.45; cursor:not-allowed; filter:none !important; transform:none !important;}

    /* ✅ 按鈕文字更深金更銳利（固定策略：深金 + 穩描邊 + 聚焦陰影） */
    button.crystalText{
      color: var(--goldDeep) !important;
      -webkit-text-fill-color: var(--goldDeep) !important;
      -webkit-text-stroke: 1.16px rgba(90,45,10,.88);
      text-shadow:
        0 1px 0 rgba(255,255,255,0.035),
        0 2px 2px rgba(0,0,0,0.82),
        0 9px 16px rgba(0,0,0,0.48),
        0 0 12px rgba(246,211,122,0.12);
    }
    @supports ((-webkit-background-clip: text) or (background-clip: text)) {
      button.crystalText::after{
        opacity:.60;                 /* ✅ 亮膜更小，避免洗字 */
        filter:saturate(1.06) brightness(1.02);
        mix-blend-mode: normal;
      }
    }

    /* ===================== ✅ 一般欄位水晶（滑桿1） ===================== */
    .crystalSoft{
      -webkit-text-stroke:
        calc(.80px - (var(--crystalPower) * .16px))
        rgba(96, 52, 16, calc(.56 - var(--crystalPower) * .16));

      text-shadow:
        0 1px 0 rgba(255,255,255,0.05),
        0 2px 4px rgba(0,0,0,0.48),
        0 12px 22px rgba(0,0,0,0.20),
        0 0 calc(12px + (var(--crystalPower) * 12px)) rgba(246,211,122, calc(.10 + var(--crystalPower) * .09)),
        0 0 calc(22px + (var(--crystalPower) * 16px)) rgba(246,211,122, calc(.06 + var(--crystalPower) * .06));
    }
    @supports ((-webkit-background-clip: text) or (background-clip: text)) {
      .crystalSoft::after{
        opacity: clamp(var(--crystalPowMin), var(--crystalPower), var(--crystalPowMax));
        filter:
          saturate(calc(1.05 + var(--crystalPower) * 0.08))
          brightness(calc(1.03 + var(--crystalPower) * 0.055));
        mix-blend-mode: normal;
        text-shadow:
          0 0 calc(3px + var(--crystalPower) * 3px) var(--softWhite),
          0 0 calc(9px + var(--crystalPower) * 9px) var(--softGold1);
      }
    }

    /* ===================== ✅ 記事內容水晶（滑桿2） ===================== */
    .noteCrystal{
      font-family: var(--contentFont);
      font-weight:850;
      letter-spacing:.01em;
      line-height:1.75;

      /* ✅ 更深金但不刺眼：底色不推到純白 */
      color: rgba(255,236,195,.94) !important;
      -webkit-text-fill-color: rgba(255,236,195,.94) !important;

      -webkit-text-stroke:
        calc(.78px - (var(--notePower) * .16px))
        rgba(96, 52, 16, calc(.52 - var(--notePower) * .14));

      /* ✅ 陰影更聚焦（閱讀舒服）+ glow 收斂 */
      text-shadow:
        0 1px 0 rgba(255,255,255,0.05),
        0 3px 7px rgba(0,0,0,0.56),
        0 14px 26px rgba(0,0,0,0.22),
        0 0 calc(12px + (var(--notePower) * 10px)) rgba(246,211,122, calc(.10 + var(--notePower) * .09)),
        0 0 calc(22px + (var(--notePower) * 12px)) rgba(246,211,122, calc(.06 + var(--notePower) * .05));
    }
    @supports ((-webkit-background-clip: text) or (background-clip: text)) {
      .noteCrystal::after{
        opacity: clamp(var(--notePowMin), var(--notePower), var(--notePowMax));
        filter:
          saturate(calc(1.06 + var(--notePower) * 0.10))
          brightness(calc(1.04 + var(--notePower) * 0.06));
        mix-blend-mode: normal;
        text-shadow:
          0 0 calc(4px + var(--notePower) * 3px) var(--softWhite),
          0 0 calc(10px + var(--notePower) * 8px) var(--softGold2);
      }
    }

    /* ===================== Layout ===================== */
    .wrap{
      width: min(1920px, calc(100vw - (2 * var(--stageSide))));
      max-width:none;
      margin:0 auto;
      padding:20px 16px 34px;
    }

    .topbar{
      position:relative;
      z-index:20;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      gap:12px;
      align-items:center;
      padding:14px;
      border:1px solid rgba(246,211,122,.32);
      border-radius:var(--r);

      background:
        radial-gradient(120% 160% at 18% 18%, rgba(255,255,255,.075), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.12));
      box-shadow:var(--shadow);
      backdrop-filter:blur(9px) saturate(1.05);
      -webkit-backdrop-filter:blur(9px) saturate(1.05);
    }
    @media (max-width:920px){
      .topbar{ grid-template-columns:1fr; }
      .nav-left{ order:0; }
      .brand{ order:1; }
      .right{ order:2; justify-content:flex-start; }
    }

    .nav-left{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:flex-start;
      min-width:220px;
    }
    .nav-desktop{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .nav-mobile{ display:none; gap:10px; align-items:center; width:100%; }
    @media (max-width:600px){
      .nav-desktop{ display:none; }
      .nav-mobile{ display:flex; }
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:center;
      justify-content:center;
      text-align:center;
    }
    .title{
      font-weight:900;
      letter-spacing:.10em;
      font-size:21px;
      white-space:nowrap;
    }
    .sub{
      font-size:12px;
      letter-spacing:.10em;
      color:rgba(236,236,236,.70);
      text-shadow:0 1px 0 rgba(0,0,0,0.55);
    }

    .right{
      display:flex; gap:10px;
      align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
      min-width:220px;
    }
    @media (max-width:920px){ .right{ justify-content:flex-start; } }

    .pill{
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(120% 160% at 16% 18%, rgba(255,255,255,.06), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.14));
      font-size:13px;
      color:rgba(236,236,236,.92);
      display:flex; gap:8px; align-items:center; white-space:nowrap;
      backdrop-filter: blur(7px) saturate(1.05);
      -webkit-backdrop-filter: blur(7px) saturate(1.05);
      box-shadow:0 12px 24px rgba(0,0,0,.25);
    }
    .pill b{font-weight:900}

    .panel{
      margin-top:16px;
      border:1px solid rgba(246,211,122,.28);
      background:
        radial-gradient(120% 160% at 16% 18%, rgba(255,255,255,.06), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.14));
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
      backdrop-filter: blur(9px) saturate(1.05);
      -webkit-backdrop-filter: blur(9px) saturate(1.05);
    }

    .controls{
      display:grid;
      grid-template-columns: 1.3fr .9fr .9fr auto;
      gap:10px;
      align-items:end;
    }
    @media (max-width:920px){ .controls{grid-template-columns:1fr 1fr} }
    @media (max-width:520px){ .controls{grid-template-columns:1fr} }

    .field{display:flex; flex-direction:column; gap:6px}
    .label{
      font-size:12px;
      letter-spacing:.10em;
      font-weight:900;
      color:rgba(236,236,236,.82);
      text-shadow:0 1px 0 rgba(0,0,0,0.60);
    }

    input,select,textarea{
      width:100%;
      border-radius:14px;
      border:1px solid var(--ctrl-bd);
      background:var(--ctrl-bg);
      color:rgba(255,244,208,.95);
      padding:11px 12px;
      font-family:var(--contentFont);
      outline:none;
      transition:border-color .12s ease, filter .12s ease, background .12s ease;
      font-weight:700;
      letter-spacing:.02em;
      -webkit-font-smoothing: antialiased;
      text-rendering: geometricPrecision;
      text-shadow:
        0 1px 0 rgba(0,0,0,0.60),
        0 8px 16px rgba(0,0,0,0.28);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    textarea{min-height:92px; resize:vertical;}

    input:focus,select:focus,textarea:focus{
      border-color:var(--ctrl-bd-focus);
      filter:brightness(1.06);
      background: rgba(0,0,0,.50);
    }

    /* ✅✅ 下拉「顯示文字置中」（你圈的 3） */
    select{
      text-align:center;
      text-align-last:center; /* Chrome/Edge */
    }
    select option{
      background:#0b0d10;
      color:#f6d37a;
      font-weight:800;
      letter-spacing:.02em;
      text-shadow:none;
      text-align:center;
    }

    /* ===================== ✅ 亮度滑桿 UI ===================== */
    .sliderPanel{
      margin-top:12px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.10);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width:720px){
      .sliderPanel{ grid-template-columns:1fr; }
    }

    .sliderRow{
      display:grid;
      grid-template-columns: auto 1fr auto;
      gap:10px;
      align-items:center;
    }
    .sliderTag{
      font-size:12px;
      letter-spacing:.08em;
      font-weight:900;
      white-space:nowrap;
    }
    .sliderVal{
      font-size:12px;
      font-weight:900;
      letter-spacing:.06em;
      opacity:.92;
      white-space:nowrap;
    }
    input[type="range"].slider{
      width:100%;
      accent-color: #f6d37a;
      height: 18px;
      background: transparent;
    }

    /* ===================== ✅ 表格 ===================== */
    .tableWrap{
      margin-top:14px;
      overflow:auto;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.12);
    }

    table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      min-width: 1200px;
      background:rgba(0,0,0,.18);
    }

    thead th{
      position:sticky; top:0; z-index:2;
      background:linear-gradient(180deg, var(--th-bg1), var(--th-bg2));
      font-size:13px;
      letter-spacing:.08em;
      padding:12px 12px;
      border-bottom:1px solid rgba(246,211,122,.24);
      white-space:nowrap;
      font-weight:900;
      text-align:center;          /* ✅ 表頭置中 */
      vertical-align:middle;      /* ✅ 表頭置中 */
    }

    tbody td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
      font-size:14px;
      font-family:var(--contentFont);
      color:rgba(236,236,236,.94);
      font-weight:600;
      letter-spacing:.01em;
      text-shadow: 0 1px 0 rgba(0,0,0,0.60);
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* ✅ 直欄置中 */
    td.colNo, td.colTrade, td.colSys, td.colDate, td.colAct{
      white-space:nowrap;
      text-align:center;
      vertical-align:middle;
    }

    /* ✅ 記事內容/備註可換行 */
    td.colText{
      white-space:normal;
      overflow:visible;
      text-overflow:clip;
    }
    td.colRemark{
      white-space:normal;
      overflow:visible;
      text-overflow:clip;
      line-height:1.65;
    }

    tbody tr:hover td{background:rgba(255,255,255,.05)}
    tbody tr.sel td{ background: rgba(246,211,122,.10); }

    .muted{color:rgba(236,236,236,.55)}
    .hint{margin-top:10px; color:var(--muted); font-size:13px; line-height:1.6}

    /* ===== modal/login（原樣） ===== */
    .mask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:100;
    }
    .modal{
      width:min(980px, 96vw);
      border-radius:22px;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      box-shadow:0 30px 90px rgba(0,0,0,.75);
      overflow:hidden;
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
    }
    .mHead{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .mTitle{ font-weight:900; letter-spacing:.10em; }
    .mBody{padding:14px 16px 16px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .span2{grid-column:span 2}
    @media (max-width:720px){
      .grid{grid-template-columns:1fr}
      .span2{grid-column:span 1}
      table{min-width:1040px}
    }
    .inline2{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end}
    .miniHint{font-size:12px; color:rgba(236,236,236,.68); line-height:1.5}
    .mFoot{
      padding:14px 16px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      border-top:1px solid rgba(255,255,255,.10);
      flex-wrap:wrap;
    }

    .pMask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.65);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:160;
    }
    .pModal{
      width:min(560px, 96vw);
      border-radius:20px;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      box-shadow:0 30px 90px rgba(0,0,0,.75);
      overflow:hidden;
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
    }
    .pHead{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .pTitle{ font-weight:900; letter-spacing:.10em; font-size:16px; }
    .pBody{padding:14px}
    .pFoot{
      padding:12px 14px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.10);
    }

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.55);
      color:rgba(236,236,236,.92);
      font-size:13px;
      box-shadow:var(--shadow);
      display:none;
      z-index:200;
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
    }

    .loginMask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.68);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:999;
    }
    .loginMask.show{display:flex;}
    .loginModal{
      width:min(520px, 96vw);
      border-radius:22px;
      border:1px solid var(--border2);
      background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      box-shadow:0 30px 90px rgba(0,0,0,.78);
      overflow:hidden;
      backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px);
    }
    .loginHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .loginTitle{ font-weight:900; letter-spacing:.10em; }
    .loginBody{padding:14px 16px 10px;}
    .loginFoot{
      padding:12px 16px;
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .loginErr{
      margin-top:10px;
      color:rgba(255,190,190,.95);
      font-size:13px;
      line-height:1.5;
      display:none;
      white-space:pre-wrap;
    }
    .loginHint{
      margin-top:10px;
      color:rgba(236,236,236,.70);
      font-size:12px;
      line-height:1.6;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="nav-left">
        <div class="nav-desktop">
          <button class="btn ghost small crystalText" id="navBack" type="button">返回汐東工程管理表</button>
        </div>

        <div class="nav-mobile">
          <button class="btn ghost small crystalText" id="mBack" type="button">返回</button>
          <div class="moreWrap">
            <button class="btn ghost small crystalText" id="mMoreBtn" type="button">更多 ▾</button>
            <div class="moreMenu" id="mMoreMenu" role="menu" aria-label="更多選單">
              <button class="menuItem crystalText" data-href="汐東工程管理表.html" type="button">汐東工程管理表</button>
              <div class="menuSep"></div>
              <button class="menuItem crystalText" data-href="index.html" type="button">返回首頁</button>
            </div>
          </div>
        </div>
      </div>

      <div class="brand">
        <div class="title crystalText">捷運汐東線事項記錄</div>
        <div class="sub">記事內容 · 工種 · 系統 · 登錄日期</div>
      </div>

      <div class="right">
        <div class="pill">使用者：<b class="crystalText" id="uName">—</b></div>
        <div class="pill">權限：<b class="crystalText" id="uRole">—</b></div>

        <button class="btn small crystalText" id="btnAdd" style="display:none;" type="button">新增</button>
        <button class="btn small crystalText" id="btnEdit" style="display:none;" type="button">編輯</button>
      </div>
    </div>

    <div class="panel">
      <div class="controls">
        <div class="field">
          <div class="label crystalText">搜尋（記事內容）</div>
          <input id="qText" placeholder="可輸入關鍵字，例如：送審、會議、現勘..." />
        </div>

        <div class="field">
          <div class="label crystalText">工種</div>
          <select id="fTrade"><option value="">全部</option></select>
        </div>

        <div class="field">
          <div class="label crystalText">系統</div>
          <select id="fSys"><option value="">全部</option></select>
        </div>

        <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
          <button class="btn ghost crystalText" id="btnClear" type="button">清除條件</button>
        </div>
      </div>

      <!-- ✅✅ 亮度滑桿 -->
      <div class="sliderPanel" id="sliderPanel">
        <div class="sliderRow">
          <div class="sliderTag crystalText">一般欄位亮度</div>
          <input class="slider" id="rngCrystal" type="range" min="0.30" max="0.90" step="0.01" value="0.62" />
          <div class="sliderVal crystalText" id="valCrystal">0.62</div>
        </div>

        <div class="sliderRow">
          <div class="sliderTag crystalText">記事內容亮度</div>
          <input class="slider" id="rngNote" type="range" min="0.40" max="0.94" step="0.01" value="0.78" />
          <div class="sliderVal crystalText" id="valNote">0.78</div>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <colgroup>
            <col style="width:100px">
            <col style="width:auto">
            <col style="width:180px">
            <col style="width:180px">
            <col style="width:260px">
            <col style="width:160px">
            <col style="width:140px">
          </colgroup>

          <thead>
            <tr>
              <th class="crystalText colNo">項次</th>
              <th class="crystalText">記事內容</th>
              <th class="crystalText colTrade">工種</th>
              <th class="crystalText colSys">系統</th>
              <th class="crystalText">備註</th>
              <th class="crystalText colDate">登錄日期</th>
              <th class="crystalText colAct">操作</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="hint" id="hint"></div>
    </div>
  </div>

  <!-- Edit/View Modal -->
  <div class="mask" id="mask">
    <div class="modal">
      <div class="mHead">
        <div class="mTitle crystalText" id="mTitle">查看</div>
        <button class="btn ghost small crystalText" id="btnClose" type="button">關閉</button>
      </div>

      <div class="mBody">
        <div class="grid">
          <div class="field span2">
            <div class="label crystalText">記事內容</div>
            <textarea id="mText" placeholder="請輸入記事內容（可多行）..."></textarea>
          </div>

          <div class="field">
            <div class="label crystalText">工種（下拉；可新增選項）</div>
            <div class="inline2">
              <select id="mTradeSel"></select>
              <button class="btn ghost small crystalText" id="btnAddTrade" type="button">新增工種</button>
            </div>
            <div class="miniHint">選單來源：本頁資料不重複 + 工種字典（可改）。</div>
          </div>

          <div class="field">
            <div class="label crystalText">系統（下拉；可新增選項）</div>
            <div class="inline2">
              <select id="mSysSel"></select>
              <button class="btn ghost small crystalText" id="btnAddSys" type="button">新增系統</button>
            </div>
            <div class="miniHint">選單來源：本頁資料不重複 + 系統字典（可改）。</div>
          </div>

          <div class="field span2">
            <div class="label crystalText">備註</div>
            <textarea id="mRemark" placeholder="可輸入備註（可多行）..."></textarea>
          </div>

          <div class="field">
            <div class="label crystalText">登錄日期（可改）</div>
            <input id="mDate" type="date" />
            <div class="miniHint">預設為今日；可用日曆修改。</div>
          </div>

          <div class="field">
            <div class="label crystalText">項次（固定：由小到大排序）</div>
            <input id="mNo" disabled />
          </div>
        </div>
      </div>

      <div class="mFoot">
        <button class="btn danger" id="btnDelete" style="display:none;" type="button">刪除</button>
        <button class="btn ghost crystalText" id="btnCancel" type="button">取消</button>
        <button class="btn crystalText" id="btnSave" type="button">儲存</button>
      </div>
    </div>
  </div>

  <!-- Prompt：新增 工種/系統 -->
  <div class="pMask" id="pMask">
    <div class="pModal">
      <div class="pHead">
        <div class="pTitle crystalText" id="pTitle">新增</div>
        <button class="btn ghost small crystalText" id="pClose" type="button">關閉</button>
      </div>
      <div class="pBody">
        <div class="field">
          <div class="label crystalText" id="pLabel">請輸入</div>
          <input id="pInput" placeholder="例如：機電 / 土建 / ..."/>
          <div class="miniHint">新增後會加入「選單字典」，維持選單一致。</div>
        </div>
      </div>
      <div class="pFoot">
        <button class="btn ghost crystalText" id="pCancel" type="button">取消</button>
        <button class="btn crystalText" id="pOk" type="button">確定新增</button>
      </div>
    </div>
  </div>

  <!-- Login Modal（共用） -->
  <div class="loginMask" id="loginMask" aria-hidden="true">
    <div class="loginModal" role="dialog" aria-modal="true" aria-label="登入">
      <div class="loginHead">
        <div class="loginTitle crystalText">登入</div>
        <button class="btn ghost small crystalText" id="loginClose" type="button">關閉</button>
      </div>
      <div class="loginBody">
        <div class="field">
          <div class="label crystalText">帳號</div>
          <select id="loginUser" autocomplete="username">
            <option value="">請選擇帳號</option>
          </select>
        </div>
        <div class="field" style="margin-top:10px;">
          <div class="label crystalText">密碼</div>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="請輸入密碼" />
        </div>
        <div class="loginErr" id="loginErr"></div>
        <div class="loginHint">
          登入帳密完全以「權限表.html」的權限表（localStorage: <b>tasunAuthTable_v1</b>）為準。
        </div>
      </div>
      <div class="loginFoot">
        <button class="btn ghost crystalText" id="loginToAuth" type="button">前往權限表</button>
        <button class="btn crystalText" id="loginBtn" type="button">登入</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const CURRENT_KEY = "tasunCurrentUser_v1";
    const AUTH_KEY    = "tasunAuthTable_v1";

    const DB_KEY      = "tasunSxdhNotes_v1";
    const COUNTER_KEY = "tasunSxdhNotes_counter_v1";

    const TRADE_DICT_KEY = "tasunSxdhNotes_tradeDict_v1";
    const SYS_DICT_KEY   = "tasunSxdhNotes_sysDict_v1";

    /* ✅✅ 亮度滑桿記憶鍵 */
    const UI_CRYS_KEY = "tasunSxdhNotes_ui_crystalPower_v1";
    const UI_NOTE_KEY = "tasunSxdhNotes_ui_notePower_v1";

    let currentUser = null;
    let db = [];
    let editingId = null;
    let selectedId = null;
    let promptMode = null;

    const $ = (id) => document.getElementById(id);
    const norm = (s) => (s ?? "").toString().trim();

    function setRootVar(name, val){
      document.documentElement.style.setProperty(name, val);
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    /* ✅✅ 初始化：滑桿顯示 + 即時套用 + 存 localStorage */
    function initSliders(){
      const rngCrystal = $("rngCrystal");
      const rngNote = $("rngNote");
      const valCrystal = $("valCrystal");
      const valNote = $("valNote");

      if(!rngCrystal || !rngNote) return;

      const storedC = Number(localStorage.getItem(UI_CRYS_KEY));
      const storedN = Number(localStorage.getItem(UI_NOTE_KEY));

      const c0 = Number.isFinite(storedC) ? clamp(storedC, 0.30, 0.90) : parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--crystalPower")) || 0.62;
      const n0 = Number.isFinite(storedN) ? clamp(storedN, 0.40, 0.94) : parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--notePower")) || 0.78;

      rngCrystal.value = c0.toFixed(2);
      rngNote.value = n0.toFixed(2);

      setRootVar("--crystalPower", rngCrystal.value);
      setRootVar("--notePower", rngNote.value);

      valCrystal.textContent = rngCrystal.value;
      valNote.textContent = rngNote.value;

      const onC = ()=>{
        const v = clamp(parseFloat(rngCrystal.value), 0.30, 0.90).toFixed(2);
        rngCrystal.value = v;
        setRootVar("--crystalPower", v);
        valCrystal.textContent = v;
        localStorage.setItem(UI_CRYS_KEY, v);
      };
      const onN = ()=>{
        const v = clamp(parseFloat(rngNote.value), 0.40, 0.94).toFixed(2);
        rngNote.value = v;
        setRootVar("--notePower", v);
        valNote.textContent = v;
        localStorage.setItem(UI_NOTE_KEY, v);
      };

      rngCrystal.addEventListener("input", onC);
      rngNote.addEventListener("input", onN);

      crystalizeAll(document);
    }

    function crystalizeEl(el){
      if(!el) return;
      const t = (el.textContent || "").trim();
      if(t) el.setAttribute("data-text", t);
    }
    function crystalizeAll(root=document){
      root.querySelectorAll(".crystalText").forEach(crystalizeEl);
    }

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.style.display = "none", 2600);
    }

    function escHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    /* ✅ 一般欄位：柔亮平衡（滑桿1） */
    function softCrystalSpan(val){
      const t = norm(val);
      if(!t) return `<span class="muted">—</span>`;
      return `<span class="crystalText crystalSoft">${escHtml(t)}</span>`;
    }

    /* ✅ 記事內容：更深金水晶（滑桿2） */
    function noteCrystalSpan(val){
      const t = norm(val);
      if(!t) return `<span class="crystalText noteCrystal">—</span>`;
      return `<span class="crystalText noteCrystal">${escHtml(t)}</span>`;
    }

    function mapRole(v){
      const s=(v??"").toString().trim().toLowerCase();
      if(!s) return "read";
      if(s==="admin") return "admin";
      if(s==="write"||s==="edit") return "write";
      if(s==="read"||s==="view") return "read";
      if(s==="0") return "admin";
      if(s==="1") return "write";
      if(s==="2") return "read";
      return s;
    }

    function loadAuthTable(){
      try{
        const raw = localStorage.getItem(AUTH_KEY);
        if(!raw) return [];
        const parsed = JSON.parse(raw);
        if(Array.isArray(parsed)) return parsed;
        if(parsed && Array.isArray(parsed.users)) return parsed.users;
        return [];
      }catch(e){ return []; }
    }

    function pickUsername(row){ return norm(row?.username ?? row?.user ?? row?.account ?? row?.name); }
    function pickPassword(row){ return (row?.password ?? row?.pass ?? row?.pwd ?? "").toString(); }
    function pickRole(row){ return mapRole(row?.role ?? row?.level ?? row?.perm ?? row?.permission); }

    function findAuthUser(username){
      const u = norm(username).toLowerCase();
      if(!u) return null;
      const rows = loadAuthTable();
      for(const r of rows){
        const ru = pickUsername(r).toLowerCase();
        if(ru && ru===u){
          return { user: pickUsername(r), pass: pickPassword(r), role: pickRole(r) || "read" };
        }
      }
      return null;
    }

    function loadCurrentUser(){
      try{ currentUser = JSON.parse(localStorage.getItem(CURRENT_KEY) || "null"); }
      catch(e){ currentUser = null; }

      if(currentUser && typeof currentUser==="object"){
        const uname = norm(currentUser.user ?? currentUser.username ?? currentUser.account ?? currentUser.name);
        if(uname){
          currentUser.user = uname;
          currentUser.username = uname;
        }
        currentUser.role = mapRole(currentUser.role ?? currentUser.level ?? "read");
        currentUser.level = currentUser.role;
        currentUser.authStamp = (currentUser.authStamp ?? "").toString();
      }
    }

    function setCurrentUser(user, role, authStamp){
      const obj = {
        user,
        username: user,
        role: mapRole(role),
        level: mapRole(role),
        authStamp: (authStamp || "").toString()
      };
      localStorage.setItem(CURRENT_KEY, JSON.stringify(obj));
      currentUser = obj;
    }

    function role(){ return mapRole(currentUser?.role ?? currentUser?.level ?? "read"); }
    function canWrite(){ const r=role(); return r==="admin" || r==="write"; }
    function isAdmin(){ return role()==="admin"; }

    const SESSION_WATCH_MS = 3000;
    let _watchStarted = false;

    function fnv1a(str){
      let h = 0x811c9dc5;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 0x01000193);
      }
      return (h >>> 0).toString(16).padStart(8, "0");
    }
    function authStampFromAuth(auth){
      return fnv1a(`${auth.user}|${auth.pass ?? ""}`);
    }

    function rebuildUserDropdown(preselectUser){
      const sel = $("loginUser");
      const rows = loadAuthTable();
      const users = rows.map(r => pickUsername(r)).filter(Boolean);

      const seen = new Set();
      const uniq = [];
      for(const u of users){
        const k = u.toLowerCase();
        if(seen.has(k)) continue;
        seen.add(k);
        uniq.push(u);
      }

      sel.innerHTML = `<option value="">請選擇帳號</option>` + uniq.map(u=>{
        const s = (preselectUser && u.toLowerCase() === preselectUser.toLowerCase()) ? "selected" : "";
        return `<option value="${escHtml(u)}" ${s}>${escHtml(u)}</option>`;
      }).join("");
    }

    function openLoginModal(msg){
      $("loginErr").style.display="none";
      if(msg){
        $("loginErr").textContent = msg;
        $("loginErr").style.display="block";
      }
      loadCurrentUser();
      rebuildUserDropdown(currentUser?.user || "");

      $("loginPass").value="";
      $("loginMask").classList.add("show");
      $("loginMask").setAttribute("aria-hidden","false");
      setTimeout(()=>{
        if($("loginUser").value) $("loginPass").focus();
        else $("loginUser").focus();
      },0);

      crystalizeAll(document);
    }
    function closeLoginModal(){
      $("loginMask").classList.remove("show");
      $("loginMask").setAttribute("aria-hidden","true");
    }

    function forceReLogin(msg){
      try{ localStorage.removeItem(CURRENT_KEY); }catch(e){}
      currentUser = null;
      toast(msg || "權限表已更新，請重新登入");
      openLoginModal(msg || "權限表已更新，請重新登入");
      $("uName").textContent="—";
      $("uRole").textContent="—";
      crystalizeEl($("uName"));
      crystalizeEl($("uRole"));
      render();
    }

    function validateSession(){
      const lm = $("loginMask");
      if(lm && lm.classList.contains("show")) return;

      loadCurrentUser();
      if(!currentUser || !currentUser.user) return;

      const auth = findAuthUser(currentUser.user);
      if(!auth){ forceReLogin("帳號已被移除，請重新登入"); return; }

      const stampNow = authStampFromAuth(auth);

      if(!currentUser.authStamp){
        setCurrentUser(auth.user, auth.role || "read", stampNow);
        $("uName").textContent = auth.user;
        $("uRole").textContent = role();
        crystalizeEl($("uName"));
        crystalizeEl($("uRole"));
        return;
      }

      if(currentUser.authStamp !== stampNow){
        forceReLogin("密碼已更新，請重新登入");
        return;
      }

      const r = auth.role || "read";
      if(mapRole(currentUser.role) !== r){
        setCurrentUser(auth.user, r, stampNow);
        $("uRole").textContent = r;
        crystalizeEl($("uRole"));
        render();
      }
    }

    function startSessionWatch(){
      if(_watchStarted) return;
      _watchStarted = true;

      window.addEventListener("storage", (e)=>{
        if(e.key === AUTH_KEY || e.key === CURRENT_KEY){
          validateSession();
        }
        if(e.key === DB_KEY){
          loadDB();
          render();
        }
      });

      setInterval(validateSession, SESSION_WATCH_MS);
    }

    function ensureLoggedIn(){
      loadCurrentUser();
      const rows = loadAuthTable();
      if(!Array.isArray(rows) || rows.length === 0){
        openLoginModal("尚未建立權限表：請先到「權限表.html」建立帳號。");
        return false;
      }

      if(!currentUser || !currentUser.user){
        openLoginModal();
        return false;
      }

      const auth = findAuthUser(currentUser.user);
      if(!auth){ forceReLogin("帳號已被移除，請重新登入"); return false; }

      const stampNow = authStampFromAuth(auth);
      if(currentUser.authStamp && currentUser.authStamp !== stampNow){
        forceReLogin("密碼已更新，請重新登入");
        return false;
      }

      setCurrentUser(auth.user, auth.role || "read", stampNow);
      $("uName").textContent = auth.user;
      $("uRole").textContent = role();
      crystalizeEl($("uName"));
      crystalizeEl($("uRole"));
      return true;
    }

    function doLogin(){
      const u = norm($("loginUser").value);
      const p = ($("loginPass").value ?? "").toString();
      const rows = loadAuthTable();

      if(!Array.isArray(rows) || rows.length === 0){
        $("loginErr").textContent = "尚未建立權限表：請先到「權限表.html」建立帳號。";
        $("loginErr").style.display = "block";
        return;
      }
      if(!u){
        $("loginErr").textContent = "請先選擇帳號。";
        $("loginErr").style.display = "block";
        return;
      }
      if(!p){
        $("loginErr").textContent = "請輸入密碼。";
        $("loginErr").style.display = "block";
        return;
      }

      const auth = findAuthUser(u);
      if(!auth){
        $("loginErr").textContent = "帳號不存在（以權限表為準）。";
        $("loginErr").style.display = "block";
        return;
      }
      if((auth.pass ?? "") !== p){
        $("loginErr").textContent = "密碼錯誤（以權限表為準）。";
        $("loginErr").style.display = "block";
        return;
      }

      const stampNow = authStampFromAuth(auth);
      setCurrentUser(auth.user, auth.role || "read", stampNow);

      closeLoginModal();
      toast("登入成功");
      start();
    }

    function loadDB(){
      try{
        const raw = localStorage.getItem(DB_KEY);
        db = raw ? JSON.parse(raw) : [];
        if(!Array.isArray(db)) db = [];
      }catch(e){ db = []; }
    }
    function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }

    function getCounter(){
      const n = Number(localStorage.getItem(COUNTER_KEY) || "0");
      return Number.isFinite(n) ? n : 0;
    }
    function nextCounter(){
      const n = getCounter() + 1;
      localStorage.setItem(COUNTER_KEY, String(n));
      return n;
    }

    function loadDict(key){
      try{
        const raw = localStorage.getItem(key);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr.map(norm).filter(Boolean) : [];
      }catch(e){ return []; }
    }
    function saveDict(key, arr){ localStorage.setItem(key, JSON.stringify(arr)); }

    function ensureSeedDict(){
      if(!localStorage.getItem(TRADE_DICT_KEY)){
        saveDict(TRADE_DICT_KEY, ["土建","機電","水電","消防","裝修","其他"]);
      }
      if(!localStorage.getItem(SYS_DICT_KEY)){
        saveDict(SYS_DICT_KEY, ["電氣","給排水","消防","空調","弱電","土建","其他"]);
      }
    }

    function uniqueFromDB(field){
      const set = new Set();
      for(const r of db){
        const v = norm(r[field]);
        if(v) set.add(v);
      }
      return set;
    }

    function unionOptions(field, dictKey){
      const set = uniqueFromDB(field);
      for(const v of loadDict(dictKey)) set.add(v);
      const arr = Array.from(set);
      arr.sort((a,b)=> a.localeCompare(b, "zh-Hant"));
      return arr;
    }

    function rebuildFilters(){
      const trades = unionOptions("trade", TRADE_DICT_KEY);
      const systems= unionOptions("system", SYS_DICT_KEY);

      const tSel = $("fTrade");
      const sSel = $("fSys");

      const keepT = norm(tSel.value);
      const keepS = norm(sSel.value);

      tSel.innerHTML = `<option value="">全部</option>` + trades.map(v=>`<option value="${escHtml(v)}">${escHtml(v)}</option>`).join("");
      sSel.innerHTML = `<option value="">全部</option>` + systems.map(v=>`<option value="${escHtml(v)}">${escHtml(v)}</option>`).join("");

      if(trades.includes(keepT)) tSel.value = keepT; else tSel.value = "";
      if(systems.includes(keepS)) sSel.value = keepS; else sSel.value = "";
    }

    function filteredRows(){
      const q = norm($("qText").value).toLowerCase();
      const t = norm($("fTrade").value);
      const s = norm($("fSys").value);

      let rows = db.slice();

      if(t) rows = rows.filter(r => norm(r.trade) === t);
      if(s) rows = rows.filter(r => norm(r.system) === s);

      if(q){
        rows = rows.filter(r => (r.text ?? "").toString().toLowerCase().includes(q));
      }

      rows.sort((a,b)=> (a.id||0) - (b.id||0));
      return rows;
    }

    function render(){
      rebuildFilters();

      const rows = filteredRows();
      const writable = canWrite();

      $("btnAdd").style.display  = writable ? "inline-block" : "none";
      $("btnEdit").style.display = writable ? "inline-block" : "none";

      $("tbody").innerHTML = rows.map(r=>{
        const isSel = (selectedId === r.id);

        return `
          <tr data-id="${r.id}" class="${isSel ? "sel" : ""}">
            <td class="colNo">${softCrystalSpan(r.id ?? "")}</td>
            <td class="colText">${noteCrystalSpan(r.text)}</td>
            <td class="colTrade">${softCrystalSpan(r.trade)}</td>
            <td class="colSys">${softCrystalSpan(r.system)}</td>
            <td class="colRemark">${softCrystalSpan(r.remark)}</td>
            <td class="colDate">${softCrystalSpan(r.date)}</td>
            <td class="colAct"><button class="btn ghost small crystalText" data-act="view" data-id="${r.id}" type="button">查看</button></td>
          </tr>
        `;
      }).join("") || `
        <tr>
          <td colspan="7" class="muted" style="padding:18px;">尚無資料（write/admin 可用右上「新增」建立第一筆）</td>
        </tr>
      `;

      $("hint").innerHTML =
        `目前為 <b style="color:var(--gold)">${writable ? "可維護模式" : "唯讀模式"}</b>（role: ${escHtml(role())}）。` +
        ` 筆數：<b style="color:var(--gold)">${rows.length}</b>。` +
        (selectedId ? ` 已選取：<b style="color:var(--gold)">#${selectedId}</b>` : `（可點選列再按「編輯」）`);

      crystalizeAll($("tbody"));
      crystalizeAll(document);
    }

    function fillDropdown(selectId, options, placeholder){
      const sel = $(selectId);
      if(options.length === 0){
        sel.innerHTML = `<option value="" disabled selected>${escHtml(placeholder)}</option>`;
      }else{
        sel.innerHTML = options.map(v=>`<option value="${escHtml(v)}">${escHtml(v)}</option>`).join("");
      }
    }

    function refreshModalDropdowns(){
      fillDropdown("mTradeSel", unionOptions("trade", TRADE_DICT_KEY), "（請先新增工種）");
      fillDropdown("mSysSel",   unionOptions("system", SYS_DICT_KEY), "（請先新增系統）");
    }

    function setModalEditable(editable){
      $("btnSave").style.display = editable ? "inline-block" : "none";
      $("btnDelete").style.display = (editable && isAdmin() && editingId != null) ? "inline-block" : "none";

      ["mText","mTradeSel","mSysSel","mRemark","mDate"].forEach(id=> $(id).disabled = !editable);

      const allowAddOpt = editable && canWrite();
      $("btnAddTrade").style.display = allowAddOpt ? "inline-block" : "none";
      $("btnAddSys").style.display   = allowAddOpt ? "inline-block" : "none";
      $("btnAddTrade").disabled = !allowAddOpt;
      $("btnAddSys").disabled   = !allowAddOpt;

      crystalizeAll(document);
    }

    function openModal(id, editable){
      validateSession();
      if(!currentUser || !currentUser.user){
        openLoginModal();
        return;
      }

      const item = (id == null) ? null : (db.find(x => x.id === id) || null);
      editingId = item ? item.id : null;

      refreshModalDropdowns();

      $("mTitle").textContent = editable ? (item ? "編輯" : "新增") : "查看";
      crystalizeEl($("mTitle"));
      setModalEditable(editable);

      $("mNo").value = item?.id ?? (getCounter() + 1);
      $("mText").value = item?.text || "";
      $("mRemark").value = item?.remark || "";
      $("mDate").value = (item?.date || new Date().toISOString().slice(0,10));

      if(item?.trade){
        const ok = Array.from($("mTradeSel").options).some(o => o.value === item.trade);
        if(ok) $("mTradeSel").value = item.trade;
      }
      if(item?.system){
        const ok = Array.from($("mSysSel").options).some(o => o.value === item.system);
        if(ok) $("mSysSel").value = item.system;
      }

      $("mask").style.display = "flex";
      crystalizeAll(document);
    }

    function closeModal(){ $("mask").style.display = "none"; }

    function saveItem(){
      validateSession();
      if(!currentUser || !currentUser.user){
        openLoginModal();
        return;
      }
      if(!canWrite()){ toast("唯讀權限不可儲存"); return; }

      const text = norm($("mText").value);
      if(!text){ toast("記事內容不可空白"); $("mText").focus(); return; }

      const trade  = norm($("mTradeSel").value);
      const system = norm($("mSysSel").value);
      if(!trade){ toast("工種尚未建立：請先按「新增工種」"); return; }
      if(!system){ toast("系統尚未建立：請先按「新增系統」"); return; }

      const remark = norm($("mRemark").value);
      const date   = norm($("mDate").value) || new Date().toISOString().slice(0,10);

      if(editingId != null){
        const idx = db.findIndex(x => x.id === editingId);
        if(idx >= 0) db[idx] = { id: editingId, text, trade, system, remark, date };
      }else{
        const id = nextCounter();
        db.push({ id, text, trade, system, remark, date });
        selectedId = id;
      }

      saveDB();
      closeModal();
      render();
      toast("已儲存");
    }

    function deleteItem(){
      validateSession();
      if(!currentUser || !currentUser.user){
        openLoginModal();
        return;
      }
      if(!isAdmin()){ toast("僅 admin 可刪除"); return; }
      if(editingId == null) return;
      if(!confirm("確定刪除這筆記事？")) return;

      db = db.filter(x => x.id !== editingId);
      if(selectedId === editingId) selectedId = null;
      saveDB();

      closeModal();
      render();
      toast("已刪除");
    }

    function openPrompt(mode){
      validateSession();
      if(!currentUser || !currentUser.user){
        openLoginModal();
        return;
      }
      if(!canWrite()){ toast("read 權限不可新增選單"); return; }

      promptMode = mode;
      $("pInput").value = "";

      if(mode === "trade"){
        $("pTitle").textContent = "新增工種";
        $("pLabel").textContent = "請輸入新的工種";
        $("pInput").placeholder = "例如：土建 / 機電 / 水電...";
      }else{
        $("pTitle").textContent = "新增系統";
        $("pLabel").textContent = "請輸入新的系統";
        $("pInput").placeholder = "例如：電氣 / 給排水 / 消防...";
      }
      crystalizeEl($("pTitle"));
      crystalizeEl($("pLabel"));

      $("pMask").style.display = "flex";
      setTimeout(()=> $("pInput").focus(), 0);
      crystalizeAll(document);
    }

    function closePrompt(){
      $("pMask").style.display = "none";
      promptMode = null;
    }

    function addOption(){
      if(!canWrite()) return;

      const v = norm($("pInput").value);
      if(!v){ toast("不可空白"); $("pInput").focus(); return; }

      const key   = (promptMode === "trade") ? TRADE_DICT_KEY : SYS_DICT_KEY;
      const field = (promptMode === "trade") ? "trade" : "system";

      const exists = unionOptions(field, key).map(x=>x.toLowerCase());
      if(exists.includes(v.toLowerCase())){ toast("已存在相同選項"); return; }

      const dict = loadDict(key);
      dict.push(v);
      dict.sort((a,b)=> a.localeCompare(b, "zh-Hant"));
      saveDict(key, dict);

      refreshModalDropdowns();
      rebuildFilters();

      if(promptMode === "trade") $("mTradeSel").value = v;
      else $("mSysSel").value = v;

      closePrompt();
      render();
      toast("已新增選項");
    }

    function setupMoreMenu(backHref){
      const backBtn = $("mBack");
      const moreBtn = $("mMoreBtn");
      const menu = $("mMoreMenu");

      const close = ()=> menu.classList.remove("open");
      const toggle = (e)=>{
        e.preventDefault();
        e.stopPropagation();
        menu.classList.toggle("open");
      };

      backBtn.onclick = ()=> location.href = backHref;
      moreBtn.addEventListener("click", toggle);

      menu.addEventListener("click", (e)=>{
        e.stopPropagation();
        const item = e.target.closest("button.menuItem[data-href]");
        if(!item) return;
        const href = item.getAttribute("data-href");
        if(href) location.href = href;
      });

      document.addEventListener("click", close);
      window.addEventListener("keydown", (e)=>{ if(e.key === "Escape") close(); });
    }

    function start(){
      if(!ensureLoggedIn()) return;

      ensureSeedDict();
      loadDB();

      $("navBack").onclick = () => location.href = "汐東工程管理表.html";
      setupMoreMenu("汐東工程管理表.html");

      $("qText").addEventListener("input", render);
      $("fTrade").addEventListener("change", render);
      $("fSys").addEventListener("change", render);

      $("btnClear").onclick = () => {
        $("qText").value = "";
        $("fTrade").value = "";
        $("fSys").value = "";
        render();
      };

      $("btnAdd").onclick = ()=>{
        if(!canWrite()){ toast("唯讀不可新增"); return; }
        editingId = null;
        openModal(null, true);
      };

      $("btnEdit").onclick = ()=>{
        if(!canWrite()){ toast("唯讀不可編輯"); return; }
        if(!selectedId){ toast("請先點選一列再按編輯"); return; }
        openModal(selectedId, true);
      };

      $("btnClose").onclick = closeModal;
      $("btnCancel").onclick = closeModal;
      $("mask").addEventListener("click", (e)=>{ if(e.target === $("mask")) closeModal(); });

      $("btnSave").onclick = saveItem;
      $("btnDelete").onclick = deleteItem;

      $("btnAddTrade").onclick = () => openPrompt("trade");
      $("btnAddSys").onclick   = () => openPrompt("sys");

      $("pClose").onclick = closePrompt;
      $("pCancel").onclick = closePrompt;
      $("pOk").P=addOption;
      $("pOk").onclick = addOption;
      $("pMask").addEventListener("click", (e)=>{ if(e.target === $("pMask")) closePrompt(); });

      $("tbody").addEventListener("click", (e)=>{
        const viewBtn = e.target.closest("button[data-act='view']");
        if(viewBtn){
          const id = Number(viewBtn.getAttribute("data-id"));
          if(Number.isFinite(id)) openModal(id, false);
          return;
        }
        const tr = e.target.closest("tr[data-id]");
        if(!tr) return;
        const id = Number(tr.getAttribute("data-id"));
        if(!Number.isFinite(id)) return;
        selectedId = id;
        render();
      });

      window.addEventListener("keydown", (e)=>{
        if(e.key === "Escape"){
          if($("pMask").style.display === "flex") closePrompt();
          else if($("mask").style.display === "flex") closeModal();
        }
        if(e.key === "Enter" && $("pMask").style.display === "flex") addOption();
      });

      crystalizeAll(document);
      initSliders();          /* ✅✅ 讓滑桿出現並生效 */
      render();
    }

    (function bindLogin(){
      $("loginClose").onclick = closeLoginModal;
      $("loginToAuth").onclick = ()=> location.href="權限表.html";
      $("loginBtn").onclick = doLogin;

      $("loginMask").addEventListener("click",(e)=>{
        if(e.target === $("loginMask")) closeLoginModal();
      });

      window.addEventListener("keydown",(e)=>{
        if(e.key === "Escape" && $("loginMask").classList.contains("show")) closeLoginModal();
        if(e.key === "Enter" && $("loginMask").classList.contains("show")) doLogin();
      });

      $("loginUser").addEventListener("change", ()=>{
        if($("loginUser").value) $("loginPass").focus();
      });
    })();

    startSessionWatch();
    start();
  </script>
</body>
</html>
